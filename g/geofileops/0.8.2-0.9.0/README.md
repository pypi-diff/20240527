# Comparing `tmp/geofileops-0.8.2.tar.gz` & `tmp/geofileops-0.9.0.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "geofileops-0.8.2.tar", last modified: Sat May 25 21:26:23 2024, max compression
+gzip compressed data, was "geofileops-0.9.0.tar", last modified: Sun May 26 21:21:57 2024, max compression
```

## Comparing `geofileops-0.8.2.tar` & `geofileops-0.9.0.tar`

### file list

```diff
@@ -1,78 +1,80 @@
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-25 21:26:23.001103 geofileops-0.8.2/
--rw-r--r--   0 runner    (1001) docker     (127)     1529 2024-05-25 21:26:18.000000 geofileops-0.8.2/LICENSE.txt
--rw-r--r--   0 runner    (1001) docker     (127)      280 2024-05-25 21:26:18.000000 geofileops-0.8.2/MANIFEST.in
--rw-r--r--   0 runner    (1001) docker     (127)     3264 2024-05-25 21:26:23.001103 geofileops-0.8.2/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)     2464 2024-05-25 21:26:18.000000 geofileops-0.8.2/README.md
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-25 21:26:22.989103 geofileops-0.8.2/benchmark/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-25 21:26:18.000000 geofileops-0.8.2/benchmark/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)       95 2024-05-25 21:26:18.000000 geofileops-0.8.2/benchmark/benchmark_all.py
--rw-r--r--   0 runner    (1001) docker     (127)      485 2024-05-25 21:26:18.000000 geofileops-0.8.2/benchmark/benchmark_geofileops.py
--rw-r--r--   0 runner    (1001) docker     (127)     5034 2024-05-25 21:26:18.000000 geofileops-0.8.2/benchmark/benchmarker.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-25 21:26:22.989103 geofileops-0.8.2/benchmark/benchmarks/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-25 21:26:18.000000 geofileops-0.8.2/benchmark/benchmarks/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    15726 2024-05-25 21:26:18.000000 geofileops-0.8.2/benchmark/benchmarks/benchmarks_geofileops.py
--rw-r--r--   0 runner    (1001) docker     (127)     7546 2024-05-25 21:26:18.000000 geofileops-0.8.2/benchmark/benchmarks/testdata.py
--rw-r--r--   0 runner    (1001) docker     (127)     9685 2024-05-25 21:26:18.000000 geofileops-0.8.2/benchmark/reporter.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-25 21:26:22.993103 geofileops-0.8.2/geofileops/
--rw-r--r--   0 runner    (1001) docker     (127)      788 2024-05-25 21:26:18.000000 geofileops-0.8.2/geofileops/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      523 2024-05-25 21:26:18.000000 geofileops-0.8.2/geofileops/_compat.py
--rw-r--r--   0 runner    (1001) docker     (127)    98835 2024-05-25 21:26:18.000000 geofileops-0.8.2/geofileops/fileops.py
--rw-r--r--   0 runner    (1001) docker     (127)   134324 2024-05-25 21:26:18.000000 geofileops-0.8.2/geofileops/geoops.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-25 21:26:22.993103 geofileops-0.8.2/geofileops/helpers/
--rw-r--r--   0 runner    (1001) docker     (127)       86 2024-05-25 21:26:18.000000 geofileops-0.8.2/geofileops/helpers/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     3842 2024-05-25 21:26:18.000000 geofileops-0.8.2/geofileops/helpers/_parameter_helper.py
--rw-r--r--   0 runner    (1001) docker     (127)     7816 2024-05-25 21:26:18.000000 geofileops-0.8.2/geofileops/helpers/layerstyles.py
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-25 21:26:18.000000 geofileops-0.8.2/geofileops/py.typed
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-25 21:26:22.997104 geofileops-0.8.2/geofileops/util/
--rw-r--r--   0 runner    (1001) docker     (127)       95 2024-05-25 21:26:18.000000 geofileops-0.8.2/geofileops/util/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     6049 2024-05-25 21:26:18.000000 geofileops-0.8.2/geofileops/util/_general_util.py
--rw-r--r--   0 runner    (1001) docker     (127)     9169 2024-05-25 21:26:18.000000 geofileops-0.8.2/geofileops/util/_geofileinfo.py
--rw-r--r--   0 runner    (1001) docker     (127)      823 2024-05-25 21:26:18.000000 geofileops-0.8.2/geofileops/util/_geometry_util.py
--rw-r--r--   0 runner    (1001) docker     (127)    90180 2024-05-25 21:26:18.000000 geofileops-0.8.2/geofileops/util/_geoops_gpd.py
--rw-r--r--   0 runner    (1001) docker     (127)     4912 2024-05-25 21:26:18.000000 geofileops-0.8.2/geofileops/util/_geoops_ogr.py
--rw-r--r--   0 runner    (1001) docker     (127)   137266 2024-05-25 21:26:18.000000 geofileops-0.8.2/geofileops/util/_geoops_sql.py
--rw-r--r--   0 runner    (1001) docker     (127)    11039 2024-05-25 21:26:18.000000 geofileops-0.8.2/geofileops/util/_geoseries_util.py
--rw-r--r--   0 runner    (1001) docker     (127)     4489 2024-05-25 21:26:18.000000 geofileops-0.8.2/geofileops/util/_io_util.py
--rw-r--r--   0 runner    (1001) docker     (127)     7774 2024-05-25 21:26:18.000000 geofileops-0.8.2/geofileops/util/_ogr_sql_util.py
--rw-r--r--   0 runner    (1001) docker     (127)    27269 2024-05-25 21:26:18.000000 geofileops-0.8.2/geofileops/util/_ogr_util.py
--rw-r--r--   0 runner    (1001) docker     (127)     4929 2024-05-25 21:26:18.000000 geofileops-0.8.2/geofileops/util/_processing_util.py
--rw-r--r--   0 runner    (1001) docker     (127)    13736 2024-05-25 21:26:18.000000 geofileops-0.8.2/geofileops/util/_sqlite_userdefined.py
--rw-r--r--   0 runner    (1001) docker     (127)    27462 2024-05-25 21:26:18.000000 geofileops-0.8.2/geofileops/util/_sqlite_util.py
--rw-r--r--   0 runner    (1001) docker     (127)     1317 2024-05-25 21:26:18.000000 geofileops-0.8.2/geofileops/util/geodataframe_util.py
--rw-r--r--   0 runner    (1001) docker     (127)      670 2024-05-25 21:26:18.000000 geofileops-0.8.2/geofileops/util/geofiletypes.csv
--rw-r--r--   0 runner    (1001) docker     (127)    98304 2024-05-25 21:26:18.000000 geofileops-0.8.2/geofileops/util/test.gpkg
--rw-r--r--   0 runner    (1001) docker     (127)        5 2024-05-25 21:26:18.000000 geofileops-0.8.2/geofileops/version.txt
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-25 21:26:23.001103 geofileops-0.8.2/geofileops.egg-info/
--rw-r--r--   0 runner    (1001) docker     (127)     3264 2024-05-25 21:26:22.000000 geofileops-0.8.2/geofileops.egg-info/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)     1926 2024-05-25 21:26:22.000000 geofileops-0.8.2/geofileops.egg-info/SOURCES.txt
--rw-r--r--   0 runner    (1001) docker     (127)        1 2024-05-25 21:26:22.000000 geofileops-0.8.2/geofileops.egg-info/dependency_links.txt
--rw-r--r--   0 runner    (1001) docker     (127)      156 2024-05-25 21:26:22.000000 geofileops-0.8.2/geofileops.egg-info/requires.txt
--rw-r--r--   0 runner    (1001) docker     (127)       27 2024-05-25 21:26:22.000000 geofileops-0.8.2/geofileops.egg-info/top_level.txt
--rw-r--r--   0 runner    (1001) docker     (127)     3655 2024-05-25 21:26:18.000000 geofileops-0.8.2/pyproject.toml
--rw-r--r--   0 runner    (1001) docker     (127)       38 2024-05-25 21:26:23.001103 geofileops-0.8.2/setup.cfg
--rw-r--r--   0 runner    (1001) docker     (127)     1121 2024-05-25 21:26:18.000000 geofileops-0.8.2/setup.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-25 21:26:23.001103 geofileops-0.8.2/tests/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-25 21:26:18.000000 geofileops-0.8.2/tests/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     1087 2024-05-25 21:26:19.000000 geofileops-0.8.2/tests/test_general_util.py
--rw-r--r--   0 runner    (1001) docker     (127)    64248 2024-05-25 21:26:19.000000 geofileops-0.8.2/tests/test_geofile.py
--rw-r--r--   0 runner    (1001) docker     (127)     4093 2024-05-25 21:26:19.000000 geofileops-0.8.2/tests/test_geofileinfo.py
--rw-r--r--   0 runner    (1001) docker     (127)    38036 2024-05-25 21:26:19.000000 geofileops-0.8.2/tests/test_geofileops_singlelayer.py
--rw-r--r--   0 runner    (1001) docker     (127)    46309 2024-05-25 21:26:19.000000 geofileops-0.8.2/tests/test_geofileops_singlelayer_gpd.py
--rw-r--r--   0 runner    (1001) docker     (127)     4923 2024-05-25 21:26:19.000000 geofileops-0.8.2/tests/test_geofileops_singlelayer_ogr.py
--rw-r--r--   0 runner    (1001) docker     (127)    18497 2024-05-25 21:26:19.000000 geofileops-0.8.2/tests/test_geofileops_singlelayer_sql.py
--rw-r--r--   0 runner    (1001) docker     (127)    67660 2024-05-25 21:26:19.000000 geofileops-0.8.2/tests/test_geofileops_twolayers.py
--rw-r--r--   0 runner    (1001) docker     (127)     1660 2024-05-25 21:26:19.000000 geofileops-0.8.2/tests/test_geoops.py
--rw-r--r--   0 runner    (1001) docker     (127)     2417 2024-05-25 21:26:19.000000 geofileops-0.8.2/tests/test_geoops_gpd.py
--rw-r--r--   0 runner    (1001) docker     (127)     2140 2024-05-25 21:26:19.000000 geofileops-0.8.2/tests/test_geoops_sql.py
--rw-r--r--   0 runner    (1001) docker     (127)    10264 2024-05-25 21:26:19.000000 geofileops-0.8.2/tests/test_geoseries_util.py
--rw-r--r--   0 runner    (1001) docker     (127)    13513 2024-05-25 21:26:19.000000 geofileops-0.8.2/tests/test_helper.py
--rw-r--r--   0 runner    (1001) docker     (127)     1540 2024-05-25 21:26:19.000000 geofileops-0.8.2/tests/test_io_util.py
--rw-r--r--   0 runner    (1001) docker     (127)     1924 2024-05-25 21:26:19.000000 geofileops-0.8.2/tests/test_layerstyles.py
--rw-r--r--   0 runner    (1001) docker     (127)     4088 2024-05-25 21:26:19.000000 geofileops-0.8.2/tests/test_ogr_sql_util.py
--rw-r--r--   0 runner    (1001) docker     (127)    10145 2024-05-25 21:26:19.000000 geofileops-0.8.2/tests/test_ogr_util.py
--rw-r--r--   0 runner    (1001) docker     (127)     2519 2024-05-25 21:26:19.000000 geofileops-0.8.2/tests/test_parameter_helper.py
--rw-r--r--   0 runner    (1001) docker     (127)     1415 2024-05-25 21:26:19.000000 geofileops-0.8.2/tests/test_processing_util.py
--rw-r--r--   0 runner    (1001) docker     (127)     3746 2024-05-25 21:26:19.000000 geofileops-0.8.2/tests/test_spatialite.py
--rw-r--r--   0 runner    (1001) docker     (127)     7582 2024-05-25 21:26:19.000000 geofileops-0.8.2/tests/test_sqlite_userdefined.py
--rw-r--r--   0 runner    (1001) docker     (127)     7199 2024-05-25 21:26:19.000000 geofileops-0.8.2/tests/test_sqlite_util.py
--rw-r--r--   0 runner    (1001) docker     (127)      152 2024-05-25 21:26:19.000000 geofileops-0.8.2/tests/test_version.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-26 21:21:57.801408 geofileops-0.9.0/
+-rw-r--r--   0 runner    (1001) docker     (127)     1529 2024-05-26 21:21:53.000000 geofileops-0.9.0/LICENSE.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      280 2024-05-26 21:21:53.000000 geofileops-0.9.0/MANIFEST.in
+-rw-r--r--   0 runner    (1001) docker     (127)     3243 2024-05-26 21:21:57.801408 geofileops-0.9.0/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)     2464 2024-05-26 21:21:53.000000 geofileops-0.9.0/README.md
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-26 21:21:57.789408 geofileops-0.9.0/benchmark/
+-rw-r--r--   0 runner    (1001) docker     (127)       27 2024-05-26 21:21:53.000000 geofileops-0.9.0/benchmark/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      124 2024-05-26 21:21:53.000000 geofileops-0.9.0/benchmark/benchmark_all.py
+-rw-r--r--   0 runner    (1001) docker     (127)      678 2024-05-26 21:21:53.000000 geofileops-0.9.0/benchmark/benchmark_geofileops.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5498 2024-05-26 21:21:53.000000 geofileops-0.9.0/benchmark/benchmarker.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-26 21:21:57.789408 geofileops-0.9.0/benchmark/benchmarks/
+-rw-r--r--   0 runner    (1001) docker     (127)       68 2024-05-26 21:21:53.000000 geofileops-0.9.0/benchmark/benchmarks/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18284 2024-05-26 21:21:53.000000 geofileops-0.9.0/benchmark/benchmarks/benchmarks_geofileops.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12574 2024-05-26 21:21:53.000000 geofileops-0.9.0/benchmark/benchmarks/testdata.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9672 2024-05-26 21:21:53.000000 geofileops-0.9.0/benchmark/reporter.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-26 21:21:57.789408 geofileops-0.9.0/geofileops/
+-rw-r--r--   0 runner    (1001) docker     (127)      906 2024-05-26 21:21:53.000000 geofileops-0.9.0/geofileops/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      613 2024-05-26 21:21:53.000000 geofileops-0.9.0/geofileops/_compat.py
+-rw-r--r--   0 runner    (1001) docker     (127)    99739 2024-05-26 21:21:53.000000 geofileops-0.9.0/geofileops/fileops.py
+-rw-r--r--   0 runner    (1001) docker     (127)   143535 2024-05-26 21:21:53.000000 geofileops-0.9.0/geofileops/geoops.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-26 21:21:57.793408 geofileops-0.9.0/geofileops/helpers/
+-rw-r--r--   0 runner    (1001) docker     (127)       86 2024-05-26 21:21:53.000000 geofileops-0.9.0/geofileops/helpers/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1769 2024-05-26 21:21:53.000000 geofileops-0.9.0/geofileops/helpers/_configoptions_helper.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3842 2024-05-26 21:21:53.000000 geofileops-0.9.0/geofileops/helpers/_parameter_helper.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7799 2024-05-26 21:21:53.000000 geofileops-0.9.0/geofileops/helpers/layerstyles.py
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-26 21:21:53.000000 geofileops-0.9.0/geofileops/py.typed
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-26 21:21:57.797408 geofileops-0.9.0/geofileops/util/
+-rw-r--r--   0 runner    (1001) docker     (127)       95 2024-05-26 21:21:53.000000 geofileops-0.9.0/geofileops/util/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7364 2024-05-26 21:21:53.000000 geofileops-0.9.0/geofileops/util/_general_util.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9446 2024-05-26 21:21:53.000000 geofileops-0.9.0/geofileops/util/_geofileinfo.py
+-rw-r--r--   0 runner    (1001) docker     (127)      823 2024-05-26 21:21:53.000000 geofileops-0.9.0/geofileops/util/_geometry_util.py
+-rw-r--r--   0 runner    (1001) docker     (127)    89942 2024-05-26 21:21:53.000000 geofileops-0.9.0/geofileops/util/_geoops_gpd.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4654 2024-05-26 21:21:53.000000 geofileops-0.9.0/geofileops/util/_geoops_ogr.py
+-rw-r--r--   0 runner    (1001) docker     (127)   149339 2024-05-26 21:21:53.000000 geofileops-0.9.0/geofileops/util/_geoops_sql.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11109 2024-05-26 21:21:53.000000 geofileops-0.9.0/geofileops/util/_geoseries_util.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5487 2024-05-26 21:21:53.000000 geofileops-0.9.0/geofileops/util/_io_util.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7795 2024-05-26 21:21:53.000000 geofileops-0.9.0/geofileops/util/_ogr_sql_util.py
+-rw-r--r--   0 runner    (1001) docker     (127)    27258 2024-05-26 21:21:53.000000 geofileops-0.9.0/geofileops/util/_ogr_util.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4931 2024-05-26 21:21:53.000000 geofileops-0.9.0/geofileops/util/_processing_util.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13711 2024-05-26 21:21:53.000000 geofileops-0.9.0/geofileops/util/_sqlite_userdefined.py
+-rw-r--r--   0 runner    (1001) docker     (127)    27682 2024-05-26 21:21:53.000000 geofileops-0.9.0/geofileops/util/_sqlite_util.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1317 2024-05-26 21:21:53.000000 geofileops-0.9.0/geofileops/util/geodataframe_util.py
+-rw-r--r--   0 runner    (1001) docker     (127)      808 2024-05-26 21:21:53.000000 geofileops-0.9.0/geofileops/util/geofiletypes.csv
+-rw-r--r--   0 runner    (1001) docker     (127)    98304 2024-05-26 21:21:53.000000 geofileops-0.9.0/geofileops/util/test.gpkg
+-rw-r--r--   0 runner    (1001) docker     (127)        5 2024-05-26 21:21:53.000000 geofileops-0.9.0/geofileops/version.txt
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-26 21:21:57.801408 geofileops-0.9.0/geofileops.egg-info/
+-rw-r--r--   0 runner    (1001) docker     (127)     3243 2024-05-26 21:21:57.000000 geofileops-0.9.0/geofileops.egg-info/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)     2030 2024-05-26 21:21:57.000000 geofileops-0.9.0/geofileops.egg-info/SOURCES.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        1 2024-05-26 21:21:57.000000 geofileops-0.9.0/geofileops.egg-info/dependency_links.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      150 2024-05-26 21:21:57.000000 geofileops-0.9.0/geofileops.egg-info/requires.txt
+-rw-r--r--   0 runner    (1001) docker     (127)       27 2024-05-26 21:21:57.000000 geofileops-0.9.0/geofileops.egg-info/top_level.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     3672 2024-05-26 21:21:53.000000 geofileops-0.9.0/pyproject.toml
+-rw-r--r--   0 runner    (1001) docker     (127)       38 2024-05-26 21:21:57.801408 geofileops-0.9.0/setup.cfg
+-rw-r--r--   0 runner    (1001) docker     (127)     1104 2024-05-26 21:21:53.000000 geofileops-0.9.0/setup.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-26 21:21:57.801408 geofileops-0.9.0/tests/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-26 21:21:53.000000 geofileops-0.9.0/tests/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1720 2024-05-26 21:21:53.000000 geofileops-0.9.0/tests/test_configoptions_helper.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1820 2024-05-26 21:21:53.000000 geofileops-0.9.0/tests/test_general_util.py
+-rw-r--r--   0 runner    (1001) docker     (127)    65667 2024-05-26 21:21:53.000000 geofileops-0.9.0/tests/test_geofile.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4093 2024-05-26 21:21:53.000000 geofileops-0.9.0/tests/test_geofileinfo.py
+-rw-r--r--   0 runner    (1001) docker     (127)    39967 2024-05-26 21:21:53.000000 geofileops-0.9.0/tests/test_geofileops_singlelayer.py
+-rw-r--r--   0 runner    (1001) docker     (127)    46887 2024-05-26 21:21:53.000000 geofileops-0.9.0/tests/test_geofileops_singlelayer_gpd.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5253 2024-05-26 21:21:53.000000 geofileops-0.9.0/tests/test_geofileops_singlelayer_ogr.py
+-rw-r--r--   0 runner    (1001) docker     (127)    19814 2024-05-26 21:21:53.000000 geofileops-0.9.0/tests/test_geofileops_singlelayer_sql.py
+-rw-r--r--   0 runner    (1001) docker     (127)    81890 2024-05-26 21:21:53.000000 geofileops-0.9.0/tests/test_geofileops_twolayers.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3569 2024-05-26 21:21:53.000000 geofileops-0.9.0/tests/test_geoops_dissolve_within_distance.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2416 2024-05-26 21:21:53.000000 geofileops-0.9.0/tests/test_geoops_gpd.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5285 2024-05-26 21:21:53.000000 geofileops-0.9.0/tests/test_geoops_sql.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10264 2024-05-26 21:21:53.000000 geofileops-0.9.0/tests/test_geoseries_util.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13472 2024-05-26 21:21:53.000000 geofileops-0.9.0/tests/test_helper.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1540 2024-05-26 21:21:53.000000 geofileops-0.9.0/tests/test_io_util.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1924 2024-05-26 21:21:53.000000 geofileops-0.9.0/tests/test_layerstyles.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4109 2024-05-26 21:21:53.000000 geofileops-0.9.0/tests/test_ogr_sql_util.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10145 2024-05-26 21:21:53.000000 geofileops-0.9.0/tests/test_ogr_util.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2519 2024-05-26 21:21:53.000000 geofileops-0.9.0/tests/test_parameter_helper.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1415 2024-05-26 21:21:53.000000 geofileops-0.9.0/tests/test_processing_util.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3746 2024-05-26 21:21:53.000000 geofileops-0.9.0/tests/test_spatialite.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7582 2024-05-26 21:21:53.000000 geofileops-0.9.0/tests/test_sqlite_userdefined.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7342 2024-05-26 21:21:53.000000 geofileops-0.9.0/tests/test_sqlite_util.py
+-rw-r--r--   0 runner    (1001) docker     (127)      152 2024-05-26 21:21:53.000000 geofileops-0.9.0/tests/test_version.py
```

### Comparing `geofileops-0.8.2/LICENSE.txt` & `geofileops-0.9.0/LICENSE.txt`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.2/PKG-INFO` & `geofileops-0.9.0/PKG-INFO`

 * *Files 2% similar despite different names*

```diff
@@ -1,22 +1,21 @@
 Metadata-Version: 2.1
 Name: geofileops
-Version: 0.8.2
+Version: 0.9.0
 Summary: Python toolbox to process large vector files faster.
 Home-page: https://github.com/geofileops/geofileops
 Author: Pieter Roggemans
 Author-email: pieter.roggemans@gmail.com
 Classifier: Programming Language :: Python :: 3
 Classifier: Operating System :: OS Independent
-Requires-Python: >=3.8
+Requires-Python: >=3.9
 Description-Content-Type: text/markdown
 License-File: LICENSE.txt
 Requires-Dist: cloudpickle
-Requires-Dist: fiona
-Requires-Dist: gdal<=3.9,>=3.6
+Requires-Dist: gdal<3.10,>=3.6
 Requires-Dist: geopandas<1,>=0.12
 Requires-Dist: numpy
 Requires-Dist: packaging
 Requires-Dist: pandas
 Requires-Dist: psutil
 Requires-Dist: pygeoops<0.5,>=0.4
 Requires-Dist: pyogrio
```

### Comparing `geofileops-0.8.2/README.md` & `geofileops-0.9.0/README.md`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.2/benchmark/benchmarker.py` & `geofileops-0.9.0/benchmark/benchmarker.py`

 * *Files 5% similar despite different names*

```diff
@@ -2,17 +2,17 @@
 Module for benchmarking.
 """
 
 import datetime
 import importlib
 import inspect
 import logging
-from pathlib import Path
 import tempfile
-from typing import List, Optional
+from pathlib import Path
+from typing import Optional
 
 import pandas as pd
 
 from benchmark import reporter
 
 ################################################################################
 # Some init
@@ -54,21 +54,34 @@
         self.package_version = package_version
         self.operation = operation
         self.operation_descr = operation_descr
         self.secs_taken = secs_taken
         self.run_details = run_details
 
     def __repr__(self):
+        """
+        Format the result.
+        """
         return f"{self.__class__}({self.__dict__})"
 
 
 def run_benchmarks(
-    modules_to_run: Optional[List[str]] = None,
-    functions_to_run: Optional[List[str]] = None,
+    modules_to_run: Optional[list[str]] = None,
+    functions_to_run: Optional[list[str]] = None,
 ):
+    """
+    Run all benchmarks specified.
+
+    Args:
+        modules_to_run (Optional[List[str]], optional): List of modules to run
+            the benchmarks from. If None, all benchmark modules found are used.
+            Defaults to None.
+        functions_to_run (Optional[List[str]], optional): List of benchmark functions to
+            be ran. If None, all benchmark functions are ran. Defaults to None.
+    """
     # Init logging
     logging.basicConfig(
         format="%(asctime)s.%(msecs)03d|%(levelname)s|%(name)s|%(message)s",
         datefmt="%H:%M:%S",
         level=logging.INFO,
     )
```

### Comparing `geofileops-0.8.2/benchmark/benchmarks/benchmarks_geofileops.py` & `geofileops-0.9.0/benchmark/benchmarks/benchmarks_geofileops.py`

 * *Files 7% similar despite different names*

```diff
@@ -1,22 +1,22 @@
 """
 Module to benchmark geofileops operations.
 """
+# ruff: noqa: D103
 
-from datetime import datetime
+import inspect
 import logging
 import multiprocessing
-import inspect
+from datetime import datetime
 from pathlib import Path
 
+import geofileops as gfo
 from benchmark.benchmarker import RunResult
 from benchmark.benchmarks import testdata
-import geofileops as gfo
-from geofileops.util import _geoops_sql
-from geofileops.util import _geoops_gpd
+from geofileops.util import _geoops_gpd, _geoops_sql
 
 logger = logging.getLogger(__name__)
 nb_parallel = min(multiprocessing.cpu_count(), 12)
 
 
 def _get_package() -> str:
     return "geofileops"
@@ -211,14 +211,93 @@
     )
 
     # Cleanup and return
     # output_path.unlink()
     return result
 
 
+def export_by_location_intersects(tmp_dir: Path) -> RunResult:
+    # Init
+    function_name = inspect.currentframe().f_code.co_name  # type: ignore[union-attr]
+
+    input1_path, _ = testdata.TestFile.AGRIPRC_2018.get_file(tmp_dir)
+    input2_path, _ = testdata.TestFile.AGRIPRC_2019.get_file(tmp_dir)
+
+    # Go!
+    start_time = datetime.now()
+    output_path = (
+        tmp_dir
+        / f"{input1_path.stem}_export_inters_{input2_path.stem}_{_get_package()}.gpkg"
+    )
+    gfo.export_by_location(
+        input_to_select_from_path=input1_path,
+        input_to_compare_with_path=input2_path,
+        output_path=output_path,
+        # spatial_relations_query="intersects is True",
+        nb_parallel=nb_parallel,
+        force=True,
+    )
+    result = RunResult(
+        package=_get_package(),
+        package_version=_get_version(),
+        operation=function_name,
+        secs_taken=(datetime.now() - start_time).total_seconds(),
+        operation_descr=(
+            "export_by_location_intersects between 2 agri parcel layers BEFL "
+            "(2*~500.000 polygons)"
+        ),
+        run_details={"nb_cpu": nb_parallel},
+    )
+
+    # Cleanup and return
+    logger.info(f"nb features in result: {gfo.get_layerinfo(output_path).featurecount}")
+    output_path.unlink()
+    return result
+
+
+def export_by_location_intersects_complexpoly(tmp_dir: Path) -> RunResult:
+    # Init
+    function_name = inspect.currentframe().f_code.co_name  # type: ignore[union-attr]
+
+    input1_path, _ = testdata.TestFile.AGRIPRC_2018.get_file(tmp_dir)
+    input2_path, input1_descr = testdata.TestFile.COMPLEX_POLYS.get_file(
+        tmp_dir, nb_points=300_000
+    )
+
+    # Go!
+    start_time = datetime.now()
+    output_path = (
+        tmp_dir
+        / f"{input1_path.stem}_export_inters_{input2_path.stem}_{_get_package()}.gpkg"
+    )
+    gfo.export_by_location(
+        input_to_select_from_path=input1_path,
+        input_to_compare_with_path=input2_path,
+        output_path=output_path,
+        nb_parallel=nb_parallel,
+        # subdivide_coords=0,
+        force=True,
+    )
+    result = RunResult(
+        package=_get_package(),
+        package_version=_get_version(),
+        operation=function_name,
+        secs_taken=(datetime.now() - start_time).total_seconds(),
+        operation_descr=(
+            f"{function_name} between agri parcels (~500k poly) and {input1_descr}"
+        ),
+        run_details={"nb_cpu": nb_parallel},
+    )
+
+    # Cleanup and return
+    logger.info(f"nb features in result: {gfo.get_layerinfo(output_path).featurecount}")
+    output_path.unlink()
+    return result
+
+
 def intersection(tmp_dir: Path) -> RunResult:
     # Init
     input1_path, _ = testdata.TestFile.AGRIPRC_2018.get_file(tmp_dir)
     input2_path, _ = testdata.TestFile.AGRIPRC_2019.get_file(tmp_dir)
 
     # Go!
     start_time = datetime.now()
@@ -231,17 +310,15 @@
         force=True,
     )
     result = RunResult(
         package=_get_package(),
         package_version=_get_version(),
         operation="intersection",
         secs_taken=(datetime.now() - start_time).total_seconds(),
-        operation_descr=(
-            "intersection between 2 agri parcel layers BEFL (2*~500.000 polygons)"
-        ),
+        operation_descr=("intersection between 2 agri parcel layers (2*~500k poly)"),
         run_details={"nb_cpu": nb_parallel},
     )
 
     # Cleanup and return
     output_path.unlink()
     return result
 
@@ -265,15 +342,15 @@
     )
     result = RunResult(
         package=_get_package(),
         package_version=_get_version(),
         operation=function_name,
         secs_taken=(datetime.now() - start_time).total_seconds(),
         operation_descr=(
-            f"{function_name} between {input1_descr} and agriparcels BEFL (~500k poly)"
+            f"{function_name} between {input1_descr} and agri parcels (~500k poly)"
         ),
         run_details={"nb_cpu": nb_parallel},
     )
 
     # Cleanup and return
     output_path.unlink()
     return result
```

### Comparing `geofileops-0.8.2/benchmark/reporter.py` & `geofileops-0.9.0/benchmark/reporter.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,30 +1,36 @@
 """
 Module to generate reports for benchmarks.
 """
 
 import ast
 import math
-import os
-from pathlib import Path
 import shutil
 import tempfile
-from typing import Literal, Optional, Tuple
+from pathlib import Path
+from typing import Literal, Optional
 
 import matplotlib.pyplot as plt
 import numpy as np
 import pandas as pd
 import pandas.api
 from PIL import Image
 
 A4_LONG_SIDE = 11.69
 A4_SHORT_SIDE = 8.27
 
 
 def generate_reports(results_path: Path, output_dir: Path):
+    """
+    Generate the benchmarking reports.
+
+    Args:
+        results_path (Path): the result path to find the results to report on.
+        output_dir (Path): directory to write the reports to.
+    """
     benchmark_df = pd.read_csv(results_path)
 
     def format_run_details(input: dict) -> str:
         if input is None or input == np.nan:
             return ""
         if isinstance(input, str):
             input = ast.literal_eval(input)
@@ -105,16 +111,15 @@
 def save_chart(
     df: pd.DataFrame,
     title: str,
     output_path: Path,
     yscale: Optional[Literal["linear", "log", "symlog", "logit"]] = None,
     y_value_formatter: Optional[str] = None,
     print_labels_on_points: bool = False,
-    open_output_file: bool = False,
-    size: Tuple[float, float] = (8, 4),
+    size: tuple[float, float] = (8, 4),
     plot_kind: Literal[
         "line",
         "bar",
         "barh",
         "hist",
         "box",
         "kde",
@@ -137,29 +142,27 @@
         yscale (Literal["linear", "log", "symlog", "logit"], optional): y scale to use.
         y_value_formatter (str, optional): a formatter for the y axes and
             labels. Examples:
               - {0:.2%} for a percentage.
               - {0:.2f} for a float with two decimals.
             Defaults to None.
         print_labels_on_points (bool, optional): _description_. Defaults to False.
-        open_output_file (bool, optional): _description_. Defaults to False.
         size (Tuple[float, float], optional): _description_. Defaults to (8, 4).
         plot_kind (str, optional): _description_. Defaults to "line".
         gridlines (str, optional): where to draw grid lines:
 
                 - 'x': draw grid lines on the x axis
                 - 'y': draw grid lines on the x axis
                 - 'both': draw grid lines on both axes
             If None, the default for the style used is used. Defaults to None.
         linestyle (Optional[str], optional): _description_. Defaults to None.
 
     Raises:
         Exception: _description_
     """
-
     # Init
     # Check input
     non_numeric_columns = [
         column
         for column in df.columns
         if not pandas.api.types.is_numeric_dtype(df[column])
     ]
@@ -252,16 +255,12 @@
             tmp_output_path = Path(tmp_dir) / output_path.name
             fig.savefig(tmp_output_path)
             img_new = np.asarray(Image.open(tmp_output_path))
             img_old = np.asarray(Image.open(output_path))
             if not np.array_equal(img_new, img_old):
                 shutil.move(tmp_output_path, output_path)
 
-    # Open if wanted
-    if open_output_file is True:
-        os.startfile(output_path)
-
 
 if __name__ == "__main__":
     results_path = Path(__file__).resolve().parent / "results/benchmark_results.csv"
     output_dir = Path(__file__).resolve().parent / "results"
     generate_reports(results_path, output_dir)
```

### Comparing `geofileops-0.8.2/geofileops/__init__.py` & `geofileops-0.9.0/geofileops/__init__.py`

 * *Files 11% similar despite different names*

```diff
@@ -1,26 +1,28 @@
 """
 Library to make spatial operations on large geo files fast(er) and easy.
 """
 
-from pathlib import Path
 import os
+from pathlib import Path
 
 # Import geopandas here so the warning about pygeos <> shapely2 is given, but set
 # USE_PYGEOS to avoid further warnings
 import geopandas._compat as gpd_compat
 
-if gpd_compat.USE_PYGEOS:
-    os.environ["USE_PYGEOS"] = "1"
-else:
-    os.environ["USE_PYGEOS"] = "0"
+if hasattr(gpd_compat, "USE_PYGEOS"):
+    if gpd_compat.USE_PYGEOS:
+        os.environ["USE_PYGEOS"] = "1"
+    else:
+        os.environ["USE_PYGEOS"] = "0"
 
 from geofileops.fileops import *  # noqa: F403
 from geofileops.geoops import *  # noqa: F403
 from geofileops.helpers.layerstyles import *  # noqa: F403
+from geofileops.util._general_util import TempEnv  # noqa: F401
 from geofileops.util._geofileinfo import get_driver  # noqa: F401
 
 
 def _get_version():
     version_path = Path(__file__).resolve().parent / "version.txt"
     with open(version_path) as file:
         return file.readline()
```

### Comparing `geofileops-0.8.2/geofileops/_compat.py` & `geofileops-0.9.0/geofileops/_compat.py`

 * *Files 26% similar despite different names*

```diff
@@ -1,14 +1,15 @@
-from packaging import version
-
-from osgeo import gdal
+import pyogrio
 import shapely
+from osgeo import gdal
+from packaging import version
 
 from geofileops.util import _sqlite_util
 
+PYOGRIO_GTE_07 = version.parse(pyogrio.__version__) >= version.parse("0.7")
 SHAPELY_GTE_20 = version.parse(shapely.__version__) >= version.parse("2")
 
 # Check what version of spatialite we are dealing with
 spatialite_version_info = _sqlite_util.spatialite_version_info()
 spatialite_version = spatialite_version_info["spatialite_version"]
 SPATIALITE_GTE_51 = version.parse(spatialite_version) >= version.parse("5.1")
```

### Comparing `geofileops-0.8.2/geofileops/fileops.py` & `geofileops-0.9.0/geofileops/fileops.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,6178 +1,6234 @@
 00000000: 2222 220a 4d6f 6475 6c65 2077 6974 6820  """.Module with 
 00000010: 6865 6c70 6572 2066 756e 6374 696f 6e73  helper functions
 00000020: 2066 6f72 2067 656f 2066 696c 6573 2e0a   for geo files..
 00000030: 2222 220a 0a69 6d70 6f72 7420 656e 756d  """..import enum
-00000040: 0a69 6d70 6f72 7420 6461 7465 7469 6d65  .import datetime
-00000050: 0a69 6d70 6f72 7420 6669 6c65 636d 700a  .import filecmp.
-00000060: 696d 706f 7274 206c 6f67 6769 6e67 0a69  import logging.i
-00000070: 6d70 6f72 7420 6f73 0a66 726f 6d20 7061  mport os.from pa
-00000080: 7468 6c69 6220 696d 706f 7274 2050 6174  thlib import Pat
-00000090: 680a 696d 706f 7274 2070 7072 696e 740a  h.import pprint.
-000000a0: 696d 706f 7274 2073 6875 7469 6c0a 696d  import shutil.im
-000000b0: 706f 7274 2073 7472 696e 670a 696d 706f  port string.impo
-000000c0: 7274 2074 656d 7066 696c 650a 696d 706f  rt tempfile.impo
-000000d0: 7274 2074 696d 650a 6672 6f6d 2074 7970  rt time.from typ
-000000e0: 696e 6720 696d 706f 7274 2041 6e79 2c20  ing import Any, 
-000000f0: 4469 6374 2c20 4974 6572 6162 6c65 2c20  Dict, Iterable, 
-00000100: 4c69 7374 2c20 4c69 7465 7261 6c2c 204f  List, Literal, O
-00000110: 7074 696f 6e61 6c2c 2054 7570 6c65 2c20  ptional, Tuple, 
-00000120: 556e 696f 6e0a 696d 706f 7274 2077 6172  Union.import war
-00000130: 6e69 6e67 730a 0a69 6d70 6f72 7420 6669  nings..import fi
-00000140: 6f6e 610a 696d 706f 7274 2067 656f 7061  ona.import geopa
-00000150: 6e64 6173 2061 7320 6770 640a 6672 6f6d  ndas as gpd.from
-00000160: 2067 656f 7061 6e64 6173 2e69 6f20 696d   geopandas.io im
-00000170: 706f 7274 2066 696c 6520 6173 2067 7064  port file as gpd
-00000180: 5f69 6f5f 6669 6c65 0a69 6d70 6f72 7420  _io_file.import 
-00000190: 6e75 6d70 7920 6173 206e 700a 6672 6f6d  numpy as np.from
-000001a0: 206f 7367 656f 2069 6d70 6f72 7420 6764   osgeo import gd
-000001b0: 616c 0a69 6d70 6f72 7420 7061 6e64 6173  al.import pandas
-000001c0: 2061 7320 7064 0a66 726f 6d20 7061 6e64   as pd.from pand
-000001d0: 6173 2e61 7069 2e74 7970 6573 2069 6d70  as.api.types imp
-000001e0: 6f72 7420 6973 5f69 6e74 6567 6572 5f64  ort is_integer_d
-000001f0: 7479 7065 0a66 726f 6d20 7079 6765 6f6f  type.from pygeoo
-00000200: 7073 2069 6d70 6f72 7420 4765 6f6d 6574  ps import Geomet
-00000210: 7279 5479 7065 2c20 5072 696d 6974 6976  ryType, Primitiv
-00000220: 6554 7970 6520 2023 206e 6f71 613a 2046  eType  # noqa: F
-00000230: 3430 310a 696d 706f 7274 2070 796f 6772  401.import pyogr
-00000240: 696f 0a69 6d70 6f72 7420 7079 7072 6f6a  io.import pyproj
-00000250: 0a0a 6672 6f6d 2067 656f 6669 6c65 6f70  ..from geofileop
-00000260: 732e 7574 696c 2069 6d70 6f72 7420 5f67  s.util import _g
-00000270: 656f 6669 6c65 696e 666f 0a66 726f 6d20  eofileinfo.from 
-00000280: 6765 6f66 696c 656f 7073 2e75 7469 6c20  geofileops.util 
-00000290: 696d 706f 7274 205f 6765 6f73 6572 6965  import _geoserie
-000002a0: 735f 7574 696c 0a66 726f 6d20 6765 6f66  s_util.from geof
-000002b0: 696c 656f 7073 2e75 7469 6c20 696d 706f  ileops.util impo
-000002c0: 7274 205f 696f 5f75 7469 6c0a 6672 6f6d  rt _io_util.from
-000002d0: 2067 656f 6669 6c65 6f70 732e 7574 696c   geofileops.util
-000002e0: 2069 6d70 6f72 7420 5f6f 6772 5f75 7469   import _ogr_uti
-000002f0: 6c0a 6672 6f6d 2067 656f 6669 6c65 6f70  l.from geofileop
-00000300: 732e 7574 696c 2069 6d70 6f72 7420 5f6f  s.util import _o
-00000310: 6772 5f73 716c 5f75 7469 6c0a 0a23 2323  gr_sql_util..###
-00000320: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00000330: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00000340: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00000350: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00000360: 2323 0a23 2046 6972 7374 2064 6566 696e  ##.# First defin
-00000370: 652f 696e 6974 2073 6f6d 6520 6765 6e65  e/init some gene
-00000380: 7261 6c20 7661 7269 6162 6c65 732f 636f  ral variables/co
-00000390: 6e73 7461 6e74 730a 2323 2323 2323 2323  nstants.########
+00000040: 0a69 6d70 6f72 7420 6669 6c65 636d 700a  .import filecmp.
+00000050: 696d 706f 7274 206c 6f67 6769 6e67 0a69  import logging.i
+00000060: 6d70 6f72 7420 7070 7269 6e74 0a69 6d70  mport pprint.imp
+00000070: 6f72 7420 7368 7574 696c 0a69 6d70 6f72  ort shutil.impor
+00000080: 7420 7374 7269 6e67 0a69 6d70 6f72 7420  t string.import 
+00000090: 7465 6d70 6669 6c65 0a69 6d70 6f72 7420  tempfile.import 
+000000a0: 7469 6d65 0a69 6d70 6f72 7420 7761 726e  time.import warn
+000000b0: 696e 6773 0a66 726f 6d20 636f 6c6c 6563  ings.from collec
+000000c0: 7469 6f6e 732e 6162 6320 696d 706f 7274  tions.abc import
+000000d0: 2049 7465 7261 626c 650a 6672 6f6d 2064   Iterable.from d
+000000e0: 6174 6574 696d 6520 696d 706f 7274 2064  atetime import d
+000000f0: 6174 652c 2064 6174 6574 696d 650a 6672  ate, datetime.fr
+00000100: 6f6d 2070 6174 686c 6962 2069 6d70 6f72  om pathlib impor
+00000110: 7420 5061 7468 0a66 726f 6d20 7479 7069  t Path.from typi
+00000120: 6e67 2069 6d70 6f72 7420 280a 2020 2020  ng import (.    
+00000130: 5459 5045 5f43 4845 434b 494e 472c 0a20  TYPE_CHECKING,. 
+00000140: 2020 2041 6e79 2c0a 2020 2020 4c69 7465     Any,.    Lite
+00000150: 7261 6c2c 0a20 2020 204f 7074 696f 6e61  ral,.    Optiona
+00000160: 6c2c 0a20 2020 2055 6e69 6f6e 2c0a 290a  l,.    Union,.).
+00000170: 0a69 6d70 6f72 7420 6765 6f70 616e 6461  .import geopanda
+00000180: 7320 6173 2067 7064 0a69 6d70 6f72 7420  s as gpd.import 
+00000190: 6e75 6d70 7920 6173 206e 700a 696d 706f  numpy as np.impo
+000001a0: 7274 2070 616e 6461 7320 6173 2070 640a  rt pandas as pd.
+000001b0: 696d 706f 7274 2070 796f 6772 696f 0a69  import pyogrio.i
+000001c0: 6d70 6f72 7420 7079 7072 6f6a 0a66 726f  mport pyproj.fro
+000001d0: 6d20 6765 6f70 616e 6461 732e 696f 2069  m geopandas.io i
+000001e0: 6d70 6f72 7420 6669 6c65 2061 7320 6770  mport file as gp
+000001f0: 645f 696f 5f66 696c 650a 6672 6f6d 206f  d_io_file.from o
+00000200: 7367 656f 2069 6d70 6f72 7420 6764 616c  sgeo import gdal
+00000210: 0a66 726f 6d20 7061 6e64 6173 2e61 7069  .from pandas.api
+00000220: 2e74 7970 6573 2069 6d70 6f72 7420 6973  .types import is
+00000230: 5f69 6e74 6567 6572 5f64 7479 7065 0a66  _integer_dtype.f
+00000240: 726f 6d20 7079 6765 6f6f 7073 2069 6d70  rom pygeoops imp
+00000250: 6f72 7420 4765 6f6d 6574 7279 5479 7065  ort GeometryType
+00000260: 2c20 5072 696d 6974 6976 6554 7970 6520  , PrimitiveType 
+00000270: 2023 206e 6f71 613a 2046 3430 310a 0a66   # noqa: F401..f
+00000280: 726f 6d20 6765 6f66 696c 656f 7073 2e5f  rom geofileops._
+00000290: 636f 6d70 6174 2069 6d70 6f72 7420 5059  compat import PY
+000002a0: 4f47 5249 4f5f 4754 455f 3037 0a66 726f  OGRIO_GTE_07.fro
+000002b0: 6d20 6765 6f66 696c 656f 7073 2e68 656c  m geofileops.hel
+000002c0: 7065 7273 2e5f 636f 6e66 6967 6f70 7469  pers._configopti
+000002d0: 6f6e 735f 6865 6c70 6572 2069 6d70 6f72  ons_helper impor
+000002e0: 7420 436f 6e66 6967 4f70 7469 6f6e 730a  t ConfigOptions.
+000002f0: 6672 6f6d 2067 656f 6669 6c65 6f70 732e  from geofileops.
+00000300: 7574 696c 2069 6d70 6f72 7420 280a 2020  util import (.  
+00000310: 2020 5f67 656f 6669 6c65 696e 666f 2c0a    _geofileinfo,.
+00000320: 2020 2020 5f67 656f 7365 7269 6573 5f75      _geoseries_u
+00000330: 7469 6c2c 0a20 2020 205f 696f 5f75 7469  til,.    _io_uti
+00000340: 6c2c 0a20 2020 205f 6f67 725f 7371 6c5f  l,.    _ogr_sql_
+00000350: 7574 696c 2c0a 2020 2020 5f6f 6772 5f75  util,.    _ogr_u
+00000360: 7469 6c2c 0a29 0a0a 6966 2054 5950 455f  til,.)..if TYPE_
+00000370: 4348 4543 4b49 4e47 3a0a 2020 2020 696d  CHECKING:.    im
+00000380: 706f 7274 206f 730a 0a23 2323 2323 2323  port os..#######
+00000390: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 000003a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 000003b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000003c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000003d0: 2323 2323 2323 2323 2323 2323 230a 0a23  #############..#
-000003e0: 2047 6574 2061 206c 6f67 6765 722e 2e2e   Get a logger...
-000003f0: 0a6c 6f67 6765 7220 3d20 6c6f 6767 696e  .logger = loggin
-00000400: 672e 6765 744c 6f67 6765 7228 5f5f 6e61  g.getLogger(__na
-00000410: 6d65 5f5f 290a 2320 6c6f 6767 6572 2e73  me__).# logger.s
-00000420: 6574 4c65 7665 6c28 6c6f 6767 696e 672e  etLevel(logging.
-00000430: 4445 4255 4729 0a0a 2320 456e 6162 6c65  DEBUG)..# Enable
-00000440: 2065 7863 6570 7469 6f6e 7320 666f 7220   exceptions for 
-00000450: 4744 414c 0a67 6461 6c2e 5573 6545 7863  GDAL.gdal.UseExc
-00000460: 6570 7469 6f6e 7328 290a 6764 616c 2e6f  eptions().gdal.o
-00000470: 6772 2e55 7365 4578 6365 7074 696f 6e73  gr.UseExceptions
-00000480: 2829 0a0a 2320 4469 7361 626c 6520 7468  ()..# Disable th
-00000490: 6973 2077 6172 6e69 6e67 2069 6e20 6669  is warning in fi
-000004a0: 6f6e 610a 7761 726e 696e 6773 2e66 696c  ona.warnings.fil
-000004b0: 7465 7277 6172 6e69 6e67 7328 0a20 2020  terwarnings(.   
-000004c0: 2061 6374 696f 6e3d 2269 676e 6f72 6522   action="ignore"
-000004d0: 2c0a 2020 2020 6361 7465 676f 7279 3d52  ,.    category=R
-000004e0: 756e 7469 6d65 5761 726e 696e 672c 0a20  untimeWarning,. 
-000004f0: 2020 206d 6573 7361 6765 3d28 0a20 2020     message=(.   
-00000500: 2020 2020 2022 5e53 6571 7565 6e74 6961       "^Sequentia
-00000510: 6c20 7265 6164 206f 6620 6974 6572 6174  l read of iterat
-00000520: 6f72 2077 6173 2069 6e74 6572 7275 7074  or was interrupt
-00000530: 6564 2e20 5265 7365 7474 696e 6720 6974  ed. Resetting it
-00000540: 6572 6174 6f72 2e20 220a 2020 2020 2020  erator. ".      
-00000550: 2020 2254 6869 7320 6361 6e20 6e65 6761    "This can nega
-00000560: 7469 7665 6c79 2069 6d70 6163 7420 7468  tively impact th
-00000570: 6520 7065 7266 6f72 6d61 6e63 652e 2422  e performance.$"
-00000580: 0a20 2020 2029 2c0a 290a 0a23 2044 6973  .    ),.)..# Dis
-00000590: 6162 6c65 2074 6869 7320 7761 726e 696e  able this warnin
-000005a0: 6720 696e 2070 796f 6772 696f 0a77 6172  g in pyogrio.war
-000005b0: 6e69 6e67 732e 6669 6c74 6572 7761 726e  nings.filterwarn
-000005c0: 696e 6773 280a 2020 2020 6163 7469 6f6e  ings(.    action
-000005d0: 3d22 6967 6e6f 7265 222c 0a20 2020 2063  ="ignore",.    c
-000005e0: 6174 6567 6f72 793d 5573 6572 5761 726e  ategory=UserWarn
-000005f0: 696e 672c 0a20 2020 206d 6573 7361 6765  ing,.    message
-00000600: 3d22 5e4c 6179 6572 202e 2a20 646f 6573  ="^Layer .* does
-00000610: 206e 6f74 2068 6176 6520 616e 7920 6665   not have any fe
-00000620: 6174 7572 6573 2074 6f20 7265 6164 2422  atures to read$"
-00000630: 2c0a 290a 2320 5365 7420 6c6f 6767 696e  ,.).# Set loggin
-00000640: 6720 6c65 7665 6c20 666f 7220 7079 6f67  g level for pyog
-00000650: 7269 6f20 746f 2077 6172 6e69 6e67 0a70  rio to warning.p
-00000660: 796f 6772 696f 5f6c 6f67 6765 7220 3d20  yogrio_logger = 
-00000670: 6c6f 6767 696e 672e 6765 744c 6f67 6765  logging.getLogge
-00000680: 7228 2270 796f 6772 696f 2229 0a70 796f  r("pyogrio").pyo
-00000690: 6772 696f 5f6c 6f67 6765 722e 7365 744c  grio_logger.setL
-000006a0: 6576 656c 286c 6f67 6769 6e67 2e57 4152  evel(logging.WAR
-000006b0: 4e49 4e47 290a 0a23 2048 6172 6463 6f64  NING)..# Hardcod
-000006c0: 6564 2033 3133 3730 2070 726a 2073 7472  ed 31370 prj str
-000006d0: 696e 6720 746f 2072 6570 6c61 6365 2066  ing to replace f
-000006e0: 6175 6c74 7920 6f6e 6573 0a50 524a 5f45  aulty ones.PRJ_E
-000006f0: 5053 475f 3331 3337 3020 3d20 280a 2020  PSG_31370 = (.  
-00000700: 2020 2750 524f 4a43 535b 2242 656c 6765    'PROJCS["Belge
-00000710: 5f31 3937 325f 4265 6c67 6961 6e5f 4c61  _1972_Belgian_La
-00000720: 6d62 6572 745f 3732 222c 270a 2020 2020  mbert_72",'.    
-00000730: 2747 454f 4743 535b 2242 656c 6765 2031  'GEOGCS["Belge 1
-00000740: 3937 3222 2c27 0a20 2020 2027 4441 5455  972",'.    'DATU
-00000750: 4d5b 2244 5f42 656c 6765 5f31 3937 3222  M["D_Belge_1972"
-00000760: 2c53 5048 4552 4f49 445b 2249 6e74 6572  ,SPHEROID["Inter
-00000770: 6e61 7469 6f6e 616c 5f31 3932 3422 2c36  national_1924",6
-00000780: 3337 3833 3838 2c32 3937 5d5d 2c27 0a20  378388,297]],'. 
-00000790: 2020 2027 5052 494d 454d 5b22 4772 6565     'PRIMEM["Gree
-000007a0: 6e77 6963 6822 2c30 5d2c 270a 2020 2020  nwich",0],'.    
-000007b0: 2755 4e49 545b 2244 6567 7265 6522 2c30  'UNIT["Degree",0
-000007c0: 2e30 3137 3435 3332 3932 3531 3939 3433  .017453292519943
-000007d0: 3239 355d 270a 2020 2020 225d 2c22 0a20  295]'.    "],". 
-000007e0: 2020 2027 5052 4f4a 4543 5449 4f4e 5b22     'PROJECTION["
-000007f0: 4c61 6d62 6572 745f 436f 6e66 6f72 6d61  Lambert_Conforma
-00000800: 6c5f 436f 6e69 6322 5d2c 270a 2020 2020  l_Conic"],'.    
-00000810: 2750 4152 414d 4554 4552 5b22 7374 616e  'PARAMETER["stan
-00000820: 6461 7264 5f70 6172 616c 6c65 6c5f 3122  dard_parallel_1"
-00000830: 2c35 312e 3136 3636 3637 3233 3333 3333  ,51.166667233333
-00000840: 3333 5d2c 270a 2020 2020 2750 4152 414d  33],'.    'PARAM
-00000850: 4554 4552 5b22 7374 616e 6461 7264 5f70  ETER["standard_p
-00000860: 6172 616c 6c65 6c5f 3222 2c34 392e 3833  arallel_2",49.83
-00000870: 3333 3333 395d 2c27 0a20 2020 2027 5041  33339],'.    'PA
-00000880: 5241 4d45 5445 525b 226c 6174 6974 7564  RAMETER["latitud
-00000890: 655f 6f66 5f6f 7269 6769 6e22 2c39 305d  e_of_origin",90]
-000008a0: 2c27 0a20 2020 2027 5041 5241 4d45 5445  ,'.    'PARAMETE
-000008b0: 525b 2263 656e 7472 616c 5f6d 6572 6964  R["central_merid
-000008c0: 6961 6e22 2c34 2e33 3637 3438 3636 3636  ian",4.367486666
-000008d0: 3636 3636 3636 5d2c 270a 2020 2020 2750  666666],'.    'P
-000008e0: 4152 414d 4554 4552 5b22 6661 6c73 655f  ARAMETER["false_
-000008f0: 6561 7374 696e 6722 2c31 3530 3030 302e  easting",150000.
-00000900: 3031 335d 2c27 0a20 2020 2027 5041 5241  013],'.    'PARA
-00000910: 4d45 5445 525b 2266 616c 7365 5f6e 6f72  METER["false_nor
-00000920: 7468 696e 6722 2c35 3430 3030 3838 2e34  thing",5400088.4
-00000930: 3338 5d2c 270a 2020 2020 2755 4e49 545b  38],'.    'UNIT[
-00000940: 224d 6574 6572 222c 315d 2c27 0a20 2020  "Meter",1],'.   
-00000950: 2027 4155 5448 4f52 4954 595b 2245 5053   'AUTHORITY["EPS
-00000960: 4722 2c33 3133 3730 5d27 0a20 2020 2022  G",31370]'.    "
-00000970: 5d22 0a29 0a0a 2323 2323 2323 2323 2323  ]".)..##########
-00000980: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00000990: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000009a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000009b0: 2323 2323 2323 2323 2323 230a 2320 5468  ###########.# Th
-000009c0: 6520 7265 616c 2077 6f72 6b0a 2323 2323  e real work.####
-000009d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000009e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000003c0: 2323 2323 2323 2323 2323 2323 2323 0a23  ##############.#
+000003d0: 2046 6972 7374 2064 6566 696e 652f 696e   First define/in
+000003e0: 6974 2073 6f6d 6520 6765 6e65 7261 6c20  it some general 
+000003f0: 7661 7269 6162 6c65 732f 636f 6e73 7461  variables/consta
+00000400: 6e74 730a 2323 2323 2323 2323 2323 2323  nts.############
+00000410: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00000420: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00000430: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00000440: 2323 2323 2323 2323 230a 0a23 2047 6574  #########..# Get
+00000450: 2061 206c 6f67 6765 722e 2e2e 0a6c 6f67   a logger....log
+00000460: 6765 7220 3d20 6c6f 6767 696e 672e 6765  ger = logging.ge
+00000470: 744c 6f67 6765 7228 5f5f 6e61 6d65 5f5f  tLogger(__name__
+00000480: 290a 2320 6c6f 6767 6572 2e73 6574 4c65  ).# logger.setLe
+00000490: 7665 6c28 6c6f 6767 696e 672e 4445 4255  vel(logging.DEBU
+000004a0: 4729 0a0a 2320 456e 6162 6c65 2065 7863  G)..# Enable exc
+000004b0: 6570 7469 6f6e 7320 666f 7220 4744 414c  eptions for GDAL
+000004c0: 0a67 6461 6c2e 5573 6545 7863 6570 7469  .gdal.UseExcepti
+000004d0: 6f6e 7328 290a 6764 616c 2e6f 6772 2e55  ons().gdal.ogr.U
+000004e0: 7365 4578 6365 7074 696f 6e73 2829 0a0a  seExceptions()..
+000004f0: 2320 4469 7361 626c 6520 7468 6973 2077  # Disable this w
+00000500: 6172 6e69 6e67 2069 6e20 6669 6f6e 610a  arning in fiona.
+00000510: 7761 726e 696e 6773 2e66 696c 7465 7277  warnings.filterw
+00000520: 6172 6e69 6e67 7328 0a20 2020 2061 6374  arnings(.    act
+00000530: 696f 6e3d 2269 676e 6f72 6522 2c0a 2020  ion="ignore",.  
+00000540: 2020 6361 7465 676f 7279 3d52 756e 7469    category=Runti
+00000550: 6d65 5761 726e 696e 672c 0a20 2020 206d  meWarning,.    m
+00000560: 6573 7361 6765 3d28 0a20 2020 2020 2020  essage=(.       
+00000570: 2022 5e53 6571 7565 6e74 6961 6c20 7265   "^Sequential re
+00000580: 6164 206f 6620 6974 6572 6174 6f72 2077  ad of iterator w
+00000590: 6173 2069 6e74 6572 7275 7074 6564 2e20  as interrupted. 
+000005a0: 5265 7365 7474 696e 6720 6974 6572 6174  Resetting iterat
+000005b0: 6f72 2e20 220a 2020 2020 2020 2020 2254  or. ".        "T
+000005c0: 6869 7320 6361 6e20 6e65 6761 7469 7665  his can negative
+000005d0: 6c79 2069 6d70 6163 7420 7468 6520 7065  ly impact the pe
+000005e0: 7266 6f72 6d61 6e63 652e 2422 0a20 2020  rformance.$".   
+000005f0: 2029 2c0a 290a 0a23 2044 6973 6162 6c65   ),.)..# Disable
+00000600: 2074 6869 7320 7761 726e 696e 6720 696e   this warning in
+00000610: 2070 796f 6772 696f 0a77 6172 6e69 6e67   pyogrio.warning
+00000620: 732e 6669 6c74 6572 7761 726e 696e 6773  s.filterwarnings
+00000630: 280a 2020 2020 6163 7469 6f6e 3d22 6967  (.    action="ig
+00000640: 6e6f 7265 222c 0a20 2020 2063 6174 6567  nore",.    categ
+00000650: 6f72 793d 5573 6572 5761 726e 696e 672c  ory=UserWarning,
+00000660: 0a20 2020 206d 6573 7361 6765 3d22 5e4c  .    message="^L
+00000670: 6179 6572 202e 2a20 646f 6573 206e 6f74  ayer .* does not
+00000680: 2068 6176 6520 616e 7920 6665 6174 7572   have any featur
+00000690: 6573 2074 6f20 7265 6164 2422 2c0a 290a  es to read$",.).
+000006a0: 2320 5365 7420 6c6f 6767 696e 6720 6c65  # Set logging le
+000006b0: 7665 6c20 666f 7220 7079 6f67 7269 6f20  vel for pyogrio 
+000006c0: 746f 2077 6172 6e69 6e67 0a70 796f 6772  to warning.pyogr
+000006d0: 696f 5f6c 6f67 6765 7220 3d20 6c6f 6767  io_logger = logg
+000006e0: 696e 672e 6765 744c 6f67 6765 7228 2270  ing.getLogger("p
+000006f0: 796f 6772 696f 2229 0a70 796f 6772 696f  yogrio").pyogrio
+00000700: 5f6c 6f67 6765 722e 7365 744c 6576 656c  _logger.setLevel
+00000710: 286c 6f67 6769 6e67 2e57 4152 4e49 4e47  (logging.WARNING
+00000720: 290a 0a23 2048 6172 6463 6f64 6564 2033  )..# Hardcoded 3
+00000730: 3133 3730 2070 726a 2073 7472 696e 6720  1370 prj string 
+00000740: 746f 2072 6570 6c61 6365 2066 6175 6c74  to replace fault
+00000750: 7920 6f6e 6573 0a50 524a 5f45 5053 475f  y ones.PRJ_EPSG_
+00000760: 3331 3337 3020 3d20 280a 2020 2020 2750  31370 = (.    'P
+00000770: 524f 4a43 535b 2242 656c 6765 5f31 3937  ROJCS["Belge_197
+00000780: 325f 4265 6c67 6961 6e5f 4c61 6d62 6572  2_Belgian_Lamber
+00000790: 745f 3732 222c 270a 2020 2020 2747 454f  t_72",'.    'GEO
+000007a0: 4743 535b 2242 656c 6765 2031 3937 3222  GCS["Belge 1972"
+000007b0: 2c27 0a20 2020 2027 4441 5455 4d5b 2244  ,'.    'DATUM["D
+000007c0: 5f42 656c 6765 5f31 3937 3222 2c53 5048  _Belge_1972",SPH
+000007d0: 4552 4f49 445b 2249 6e74 6572 6e61 7469  EROID["Internati
+000007e0: 6f6e 616c 5f31 3932 3422 2c36 3337 3833  onal_1924",63783
+000007f0: 3838 2c32 3937 5d5d 2c27 0a20 2020 2027  88,297]],'.    '
+00000800: 5052 494d 454d 5b22 4772 6565 6e77 6963  PRIMEM["Greenwic
+00000810: 6822 2c30 5d2c 270a 2020 2020 2755 4e49  h",0],'.    'UNI
+00000820: 545b 2244 6567 7265 6522 2c30 2e30 3137  T["Degree",0.017
+00000830: 3435 3332 3932 3531 3939 3433 3239 355d  453292519943295]
+00000840: 270a 2020 2020 225d 2c22 0a20 2020 2027  '.    "],".    '
+00000850: 5052 4f4a 4543 5449 4f4e 5b22 4c61 6d62  PROJECTION["Lamb
+00000860: 6572 745f 436f 6e66 6f72 6d61 6c5f 436f  ert_Conformal_Co
+00000870: 6e69 6322 5d2c 270a 2020 2020 2750 4152  nic"],'.    'PAR
+00000880: 414d 4554 4552 5b22 7374 616e 6461 7264  AMETER["standard
+00000890: 5f70 6172 616c 6c65 6c5f 3122 2c35 312e  _parallel_1",51.
+000008a0: 3136 3636 3637 3233 3333 3333 3333 5d2c  16666723333333],
+000008b0: 270a 2020 2020 2750 4152 414d 4554 4552  '.    'PARAMETER
+000008c0: 5b22 7374 616e 6461 7264 5f70 6172 616c  ["standard_paral
+000008d0: 6c65 6c5f 3222 2c34 392e 3833 3333 3333  lel_2",49.833333
+000008e0: 395d 2c27 0a20 2020 2027 5041 5241 4d45  9],'.    'PARAME
+000008f0: 5445 525b 226c 6174 6974 7564 655f 6f66  TER["latitude_of
+00000900: 5f6f 7269 6769 6e22 2c39 305d 2c27 0a20  _origin",90],'. 
+00000910: 2020 2027 5041 5241 4d45 5445 525b 2263     'PARAMETER["c
+00000920: 656e 7472 616c 5f6d 6572 6964 6961 6e22  entral_meridian"
+00000930: 2c34 2e33 3637 3438 3636 3636 3636 3636  ,4.3674866666666
+00000940: 3636 5d2c 270a 2020 2020 2750 4152 414d  66],'.    'PARAM
+00000950: 4554 4552 5b22 6661 6c73 655f 6561 7374  ETER["false_east
+00000960: 696e 6722 2c31 3530 3030 302e 3031 335d  ing",150000.013]
+00000970: 2c27 0a20 2020 2027 5041 5241 4d45 5445  ,'.    'PARAMETE
+00000980: 525b 2266 616c 7365 5f6e 6f72 7468 696e  R["false_northin
+00000990: 6722 2c35 3430 3030 3838 2e34 3338 5d2c  g",5400088.438],
+000009a0: 270a 2020 2020 2755 4e49 545b 224d 6574  '.    'UNIT["Met
+000009b0: 6572 222c 315d 2c27 0a20 2020 2027 4155  er",1],'.    'AU
+000009c0: 5448 4f52 4954 595b 2245 5053 4722 2c33  THORITY["EPSG",3
+000009d0: 3133 3730 5d27 0a20 2020 2022 5d22 0a29  1370]'.    "]".)
+000009e0: 0a0a 2323 2323 2323 2323 2323 2323 2323  ..##############
 000009f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00000a00: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00000a10: 230a 0a0a 6465 6620 6c69 7374 6c61 7965  #...def listlaye
-00000a20: 7273 280a 2020 2020 7061 7468 3a20 556e  rs(.    path: Un
-00000a30: 696f 6e5b 7374 722c 2022 6f73 2e50 6174  ion[str, "os.Pat
-00000a40: 684c 696b 655b 416e 795d 225d 2c0a 2020  hLike[Any]"],.  
-00000a50: 2020 6f6e 6c79 5f73 7061 7469 616c 5f6c    only_spatial_l
-00000a60: 6179 6572 733a 2062 6f6f 6c20 3d20 5472  ayers: bool = Tr
-00000a70: 7565 2c0a 2920 2d3e 204c 6973 745b 7374  ue,.) -> List[st
-00000a80: 725d 3a0a 2020 2020 2222 220a 2020 2020  r]:.    """.    
-00000a90: 4765 7420 7468 6520 6c69 7374 206f 6620  Get the list of 
-00000aa0: 6c61 7965 7273 2069 6e20 6120 6765 6f66  layers in a geof
-00000ab0: 696c 652e 0a0a 2020 2020 4172 6773 3a0a  ile...    Args:.
-00000ac0: 2020 2020 2020 2020 7061 7468 2028 5061          path (Pa
-00000ad0: 7468 4c69 6b65 293a 2070 6174 6820 746f  thLike): path to
-00000ae0: 2074 6865 2066 696c 6520 746f 2067 6574   the file to get
-00000af0: 2069 6e66 6f20 6162 6f75 740a 2020 2020   info about.    
-00000b00: 2020 2020 6f6e 6c79 5f73 7061 7469 616c      only_spatial
-00000b10: 5f6c 6179 6572 7320 2862 6f6f 6c2c 206f  _layers (bool, o
-00000b20: 7074 696f 6e61 6c29 3a20 5472 7565 2074  ptional): True t
-00000b30: 6f20 6f6e 6c79 206c 6973 7420 7370 6174  o only list spat
-00000b40: 6961 6c20 6c61 7965 7273 2e0a 2020 2020  ial layers..    
-00000b50: 2020 2020 2020 2020 4661 6c73 6520 746f          False to
-00000b60: 206c 6973 7420 616c 6c20 7461 626c 6573   list all tables
-00000b70: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
-00000b80: 2020 2020 2020 2020 4c69 7374 5b73 7472          List[str
-00000b90: 5d3a 2074 6865 206c 6973 7420 6f66 206c  ]: the list of l
-00000ba0: 6179 6572 730a 2020 2020 2222 220a 2020  ayers.    """.  
-00000bb0: 2020 7061 7468 203d 2050 6174 6828 7061    path = Path(pa
-00000bc0: 7468 290a 2020 2020 6966 2070 6174 682e  th).    if path.
-00000bd0: 7375 6666 6978 2e6c 6f77 6572 2829 203d  suffix.lower() =
-00000be0: 3d20 222e 7368 7022 3a0a 2020 2020 2020  = ".shp":.      
-00000bf0: 2020 7265 7475 726e 205b 7061 7468 2e73    return [path.s
-00000c00: 7465 6d5d 0a0a 2020 2020 6461 7461 736f  tem]..    dataso
-00000c10: 7572 6365 203d 204e 6f6e 650a 2020 2020  urce = None.    
-00000c20: 6c61 7965 7273 203d 205b 5d0a 2020 2020  layers = [].    
-00000c30: 7472 793a 0a20 2020 2020 2020 2064 6174  try:.        dat
-00000c40: 6173 6f75 7263 6520 3d20 6764 616c 2e4f  asource = gdal.O
-00000c50: 7065 6e45 7828 0a20 2020 2020 2020 2020  penEx(.         
-00000c60: 2020 2073 7472 2870 6174 6829 2c20 6e4f     str(path), nO
-00000c70: 7065 6e46 6c61 6773 3d67 6461 6c2e 4f46  penFlags=gdal.OF
-00000c80: 5f56 4543 544f 5220 7c20 6764 616c 2e4f  _VECTOR | gdal.O
-00000c90: 465f 5245 4144 4f4e 4c59 207c 2067 6461  F_READONLY | gda
-00000ca0: 6c2e 4f46 5f53 4841 5245 440a 2020 2020  l.OF_SHARED.    
-00000cb0: 2020 2020 290a 2020 2020 2020 2020 6e62      ).        nb
-00000cc0: 5f6c 6179 6572 7320 3d20 6461 7461 736f  _layers = dataso
-00000cd0: 7572 6365 2e47 6574 4c61 7965 7243 6f75  urce.GetLayerCou
-00000ce0: 6e74 2829 0a20 2020 2020 2020 2066 6f72  nt().        for
-00000cf0: 206c 6179 6572 5f69 6420 696e 2072 616e   layer_id in ran
-00000d00: 6765 286e 625f 6c61 7965 7273 293a 0a20  ge(nb_layers):. 
-00000d10: 2020 2020 2020 2020 2020 2064 6174 6173             datas
-00000d20: 6f75 7263 655f 6c61 7965 7220 3d20 6461  ource_layer = da
-00000d30: 7461 736f 7572 6365 2e47 6574 4c61 7965  tasource.GetLaye
-00000d40: 7242 7949 6e64 6578 286c 6179 6572 5f69  rByIndex(layer_i
-00000d50: 6429 0a20 2020 2020 2020 2020 2020 2069  d).            i
-00000d60: 6620 280a 2020 2020 2020 2020 2020 2020  f (.            
-00000d70: 2020 2020 6f6e 6c79 5f73 7061 7469 616c      only_spatial
-00000d80: 5f6c 6179 6572 7320 6973 2046 616c 7365  _layers is False
-00000d90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00000da0: 206f 7220 6461 7461 736f 7572 6365 5f6c   or datasource_l
-00000db0: 6179 6572 2e47 6574 4765 6f6d 6574 7279  ayer.GetGeometry
-00000dc0: 436f 6c75 6d6e 2829 2021 3d20 2222 0a20  Column() != "". 
-00000dd0: 2020 2020 2020 2020 2020 2029 3a0a 2020             ):.  
-00000de0: 2020 2020 2020 2020 2020 2020 2020 6c61                la
-00000df0: 7965 7273 2e61 7070 656e 6428 6461 7461  yers.append(data
-00000e00: 736f 7572 6365 5f6c 6179 6572 2e47 6574  source_layer.Get
-00000e10: 4e61 6d65 2829 290a 0a20 2020 2065 7863  Name())..    exc
-00000e20: 6570 7420 4578 6365 7074 696f 6e20 6173  ept Exception as
-00000e30: 2065 783a 0a20 2020 2020 2020 2065 782e   ex:.        ex.
-00000e40: 6172 6773 203d 2028 6622 6c69 7374 6c61  args = (f"listla
-00000e50: 7965 7273 2065 7272 6f72 2066 6f72 207b  yers error for {
-00000e60: 7061 7468 7d3a 5c6e 2020 7b65 787d 222c  path}:\n  {ex}",
-00000e70: 290a 2020 2020 2020 2020 7261 6973 650a  ).        raise.
-00000e80: 2020 2020 6669 6e61 6c6c 793a 0a20 2020      finally:.   
-00000e90: 2020 2020 2064 6174 6173 6f75 7263 6520       datasource 
-00000ea0: 3d20 4e6f 6e65 0a0a 2020 2020 7265 7475  = None..    retu
-00000eb0: 726e 206c 6179 6572 730a 0a0a 636c 6173  rn layers...clas
-00000ec0: 7320 436f 6c75 6d6e 496e 666f 3a0a 2020  s ColumnInfo:.  
-00000ed0: 2020 2222 220a 2020 2020 4120 6461 7461    """.    A data
-00000ee0: 206f 626a 6563 7420 636f 6e74 6169 6e69   object containi
-00000ef0: 6e67 206d 6574 612d 696e 666f 726d 6174  ng meta-informat
-00000f00: 696f 6e20 6162 6f75 7420 6120 636f 6c75  ion about a colu
-00000f10: 6d6e 2e0a 0a20 2020 2041 7474 7269 6275  mn...    Attribu
-00000f20: 7465 733a 0a20 2020 2020 2020 206e 616d  tes:.        nam
-00000f30: 6520 2873 7472 293a 2074 6865 206e 616d  e (str): the nam
-00000f40: 6520 6f66 2074 6865 2063 6f6c 756d 6e2e  e of the column.
-00000f50: 0a20 2020 2020 2020 2067 6461 6c5f 7479  .        gdal_ty
-00000f60: 7065 2028 7374 7229 3a20 7468 6520 7479  pe (str): the ty
-00000f70: 7065 206f 6620 7468 6520 636f 6c75 6d6e  pe of the column
-00000f80: 2061 6363 6f72 6469 6e67 2074 6f20 6764   according to gd
-00000f90: 616c 2e0a 2020 2020 2020 2020 7769 6474  al..        widt
-00000fa0: 6820 2869 6e74 293a 2074 6865 2077 6964  h (int): the wid
-00000fb0: 7468 206f 6620 7468 6520 636f 6c75 6d6e  th of the column
-00000fc0: 2c20 6966 2073 7065 6369 6669 6564 2e0a  , if specified..
-00000fd0: 2020 2020 2222 220a 0a20 2020 2064 6566      """..    def
-00000fe0: 205f 5f69 6e69 745f 5f28 0a20 2020 2020   __init__(.     
-00000ff0: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-00001000: 206e 616d 653a 2073 7472 2c0a 2020 2020   name: str,.    
-00001010: 2020 2020 6764 616c 5f74 7970 653a 2073      gdal_type: s
-00001020: 7472 2c0a 2020 2020 2020 2020 7769 6474  tr,.        widt
-00001030: 683a 204f 7074 696f 6e61 6c5b 696e 745d  h: Optional[int]
-00001040: 2c0a 2020 2020 2020 2020 7072 6563 6973  ,.        precis
-00001050: 696f 6e3a 204f 7074 696f 6e61 6c5b 696e  ion: Optional[in
-00001060: 745d 2c0a 2020 2020 293a 0a20 2020 2020  t],.    ):.     
-00001070: 2020 2022 2222 0a20 2020 2020 2020 2043     """.        C
-00001080: 6f6e 7374 7275 6374 6f72 206f 6620 436f  onstructor of Co
-00001090: 6c75 6d6e 496e 666f 2e0a 0a20 2020 2020  lumnInfo...     
-000010a0: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-000010b0: 2020 2020 206e 616d 6520 2873 7472 293a       name (str):
-000010c0: 2074 6865 2063 6f6c 756d 6e20 6e61 6d65   the column name
-000010d0: 2e0a 2020 2020 2020 2020 2020 2020 6764  ..            gd
-000010e0: 616c 5f74 7970 6520 2873 7472 293a 2074  al_type (str): t
-000010f0: 6865 2067 6461 6c20 7479 7065 206f 6620  he gdal type of 
-00001100: 7468 6520 636f 6c75 6d6e 2e0a 2020 2020  the column..    
-00001110: 2020 2020 2020 2020 7769 6474 6820 284f          width (O
-00001120: 7074 696f 6e61 6c5b 696e 745d 293a 2074  ptional[int]): t
-00001130: 6865 2077 6964 7468 206f 6620 7468 6520  he width of the 
-00001140: 636f 6c75 6d6e 2c20 6966 2061 7070 6c69  column, if appli
-00001150: 6361 626c 652e 0a20 2020 2020 2020 2020  cable..         
-00001160: 2020 2070 7265 6369 7369 6f6e 2028 4f70     precision (Op
-00001170: 7469 6f6e 616c 5b69 6e74 5d29 3a20 7468  tional[int]): th
-00001180: 6520 7072 6563 6973 696f 6e20 6f66 2074  e precision of t
-00001190: 6865 2063 6f6c 756d 6e2c 2069 6620 6170  he column, if ap
-000011a0: 706c 6963 6162 6c65 2e0a 2020 2020 2020  plicable..      
-000011b0: 2020 2222 220a 2020 2020 2020 2020 7365    """.        se
-000011c0: 6c66 2e6e 616d 6520 3d20 6e61 6d65 0a20  lf.name = name. 
-000011d0: 2020 2020 2020 2073 656c 662e 6764 616c         self.gdal
-000011e0: 5f74 7970 6520 3d20 6764 616c 5f74 7970  _type = gdal_typ
-000011f0: 650a 2020 2020 2020 2020 7365 6c66 2e77  e.        self.w
-00001200: 6964 7468 203d 2077 6964 7468 0a20 2020  idth = width.   
-00001210: 2020 2020 2073 656c 662e 7072 6563 6973       self.precis
-00001220: 696f 6e20 3d20 7072 6563 6973 696f 6e0a  ion = precision.
-00001230: 0a20 2020 2064 6566 205f 5f72 6570 725f  .    def __repr_
-00001240: 5f28 7365 6c66 293a 0a20 2020 2020 2020  _(self):.       
-00001250: 2022 2222 4f76 6572 7269 6465 7320 7468   """Overrides th
-00001260: 6520 7265 7072 6573 656e 7461 7469 6f6e  e representation
-00001270: 2070 726f 7065 7274 7920 6f66 2043 6f6c   property of Col
-00001280: 756d 6e49 6e66 6f2e 2222 220a 2020 2020  umnInfo.""".    
-00001290: 2020 2020 7265 7475 726e 2066 227b 7365      return f"{se
-000012a0: 6c66 2e5f 5f63 6c61 7373 5f5f 7d28 7b73  lf.__class__}({s
-000012b0: 656c 662e 5f5f 6469 6374 5f5f 7d29 220a  elf.__dict__})".
-000012c0: 0a0a 636c 6173 7320 4c61 7965 7249 6e66  ..class LayerInf
-000012d0: 6f3a 0a20 2020 2022 2222 0a20 2020 2041  o:.    """.    A
-000012e0: 2064 6174 6120 6f62 6a65 6374 2063 6f6e   data object con
-000012f0: 7461 696e 696e 6720 6d65 7461 2d69 6e66  taining meta-inf
-00001300: 6f72 6d61 7469 6f6e 2061 626f 7574 2061  ormation about a
-00001310: 206c 6179 6572 2e0a 0a20 2020 2041 7474   layer...    Att
-00001320: 7269 6275 7465 733a 0a20 2020 2020 2020  ributes:.       
-00001330: 206e 616d 6520 2873 7472 293a 2074 6865   name (str): the
-00001340: 206e 616d 6520 6f66 2074 6865 206c 6179   name of the lay
-00001350: 6572 2e0a 2020 2020 2020 2020 6665 6174  er..        feat
-00001360: 7572 6563 6f75 6e74 2028 696e 7429 3a20  urecount (int): 
-00001370: 7468 6520 6e75 6d62 6572 206f 6620 6665  the number of fe
-00001380: 6174 7572 6573 2028 726f 7773 2920 696e  atures (rows) in
-00001390: 2074 6865 206c 6179 6572 2e0a 2020 2020   the layer..    
-000013a0: 2020 2020 746f 7461 6c5f 626f 756e 6473      total_bounds
-000013b0: 2028 5475 706c 655b 666c 6f61 742c 2066   (Tuple[float, f
-000013c0: 6c6f 6174 2c20 666c 6f61 742c 2066 6c6f  loat, float, flo
-000013d0: 6174 5d29 3a20 7468 6520 626f 756e 6469  at]): the boundi
-000013e0: 6e67 2062 6f78 206f 660a 2020 2020 2020  ng box of.      
-000013f0: 2020 2020 2020 7468 6520 6c61 7965 723a        the layer:
-00001400: 2028 6d69 6e78 2c20 6d69 6e79 2c20 6d61   (minx, miny, ma
-00001410: 7878 2c20 6d61 7879 292e 0a20 2020 2020  xx, maxy)..     
-00001420: 2020 2067 656f 6d65 7472 7963 6f6c 756d     geometrycolum
-00001430: 6e20 2873 7472 293a 206e 616d 6520 6f66  n (str): name of
-00001440: 2074 6865 2063 6f6c 756d 6e20 7468 6174   the column that
-00001450: 2063 6f6e 7461 696e 7320 7468 650a 2020   contains the.  
-00001460: 2020 2020 2020 2020 2020 7072 696d 6172            primar
-00001470: 7920 6765 6f6d 6574 7279 2e0a 2020 2020  y geometry..    
-00001480: 2020 2020 6765 6f6d 6574 7279 7479 7065      geometrytype
-00001490: 6e61 6d65 2028 7374 7229 3a20 7468 6520  name (str): the 
-000014a0: 6765 6f6d 6574 7279 2074 7970 6520 6e61  geometry type na
-000014b0: 6d65 206f 6620 7468 6520 6765 6f6d 6574  me of the geomet
-000014c0: 7279 636f 6c75 6d6e 2e0a 2020 2020 2020  rycolumn..      
-000014d0: 2020 2020 2020 5468 6520 7479 7065 206e        The type n
-000014e0: 616d 6520 7265 7475 726e 6564 2069 7320  ame returned is 
-000014f0: 6f6e 6520 6f66 2074 6865 2066 6f6c 6c6f  one of the follo
-00001500: 7769 6e67 3a20 504f 494e 542c 204d 554c  wing: POINT, MUL
-00001510: 5449 504f 494e 542c 0a20 2020 2020 2020  TIPOINT,.       
-00001520: 2020 2020 204c 494e 4553 5452 494e 472c       LINESTRING,
-00001530: 204d 554c 5449 4c49 4e45 5354 5249 4e47   MULTILINESTRING
-00001540: 2c20 504f 4c59 474f 4e2c 204d 554c 5449  , POLYGON, MULTI
-00001550: 504f 4c59 474f 4e2c 2043 4f4c 4c45 4354  POLYGON, COLLECT
-00001560: 494f 4e2e 0a20 2020 2020 2020 2067 656f  ION..        geo
-00001570: 6d65 7472 7974 7970 6520 2847 656f 6d65  metrytype (Geome
-00001580: 7472 7954 7970 6529 3a20 7468 6520 6765  tryType): the ge
-00001590: 6f6d 6574 7279 2074 7970 6520 6f66 2074  ometry type of t
-000015a0: 6865 2067 656f 6d65 7472 7963 6f6c 756d  he geometrycolum
-000015b0: 6e2e 0a20 2020 2020 2020 2063 6f6c 756d  n..        colum
-000015c0: 6e73 2028 6469 6374 293a 2074 6865 2063  ns (dict): the c
-000015d0: 6f6c 756d 6e73 2028 6f74 6865 7220 7468  olumns (other th
-000015e0: 616e 2074 6865 2067 656f 6d65 7472 7920  an the geometry 
-000015f0: 636f 6c75 6d6e 2920 7468 6174 0a20 2020  column) that.   
-00001600: 2020 2020 2020 2020 2061 7265 2061 7661           are ava
-00001610: 696c 6162 6c65 206f 6e20 7468 6520 6c61  ilable on the la
-00001620: 7965 7220 7769 7468 2074 6865 6972 2070  yer with their p
-00001630: 726f 7065 7274 6965 7320 6173 2061 2064  roperties as a d
-00001640: 6963 742e 0a20 2020 2020 2020 2066 6964  ict..        fid
-00001650: 5f63 6f6c 756d 6e20 2873 7472 293a 2063  _column (str): c
-00001660: 6f6c 756d 6e20 6e61 6d65 206f 6620 7468  olumn name of th
-00001670: 6520 4649 4420 636f 6c75 6d6e 2e20 4973  e FID column. Is
-00001680: 2022 2220 666f 7220 6669 6c65 2074 7970   "" for file typ
-00001690: 6573 2074 6861 7420 646f 6e27 740a 2020  es that don't.  
-000016a0: 2020 2020 2020 2020 2020 6578 706c 6963            explic
-000016b0: 6974 6c79 2073 746f 7265 2061 6e20 4649  itly store an FI
-000016c0: 442c 206c 696b 6520 7368 6170 6566 696c  D, like shapefil
-000016d0: 652e 0a20 2020 2020 2020 2063 7273 2028  e..        crs (
-000016e0: 7079 7072 6f6a 2e43 5253 293a 2074 6865  pyproj.CRS): the
-000016f0: 2073 7061 7469 616c 2072 6566 6572 656e   spatial referen
-00001700: 6365 206f 6620 7468 6520 6c61 7965 722e  ce of the layer.
-00001710: 0a20 2020 2020 2020 2065 7272 6f72 7320  .        errors 
-00001720: 284c 6973 745b 7374 725d 293a 206c 6973  (List[str]): lis
-00001730: 7420 6f66 2065 7272 6f72 7320 696e 2074  t of errors in t
-00001740: 6865 206c 6179 6572 2c20 6567 2e20 696e  he layer, eg. in
-00001750: 7661 6c69 6420 636f 6c75 6d6e 0a20 2020  valid column.   
-00001760: 2020 2020 2020 2020 206e 616d 6573 2c2e           names,.
-00001770: 2e2e 0a20 2020 2022 2222 0a0a 2020 2020  ...    """..    
-00001780: 6465 6620 5f5f 696e 6974 5f5f 280a 2020  def __init__(.  
-00001790: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-000017a0: 2020 2020 6e61 6d65 3a20 7374 722c 0a20      name: str,. 
-000017b0: 2020 2020 2020 2066 6561 7475 7265 636f         featureco
-000017c0: 756e 743a 2069 6e74 2c0a 2020 2020 2020  unt: int,.      
-000017d0: 2020 746f 7461 6c5f 626f 756e 6473 3a20    total_bounds: 
-000017e0: 5475 706c 655b 666c 6f61 742c 2066 6c6f  Tuple[float, flo
-000017f0: 6174 2c20 666c 6f61 742c 2066 6c6f 6174  at, float, float
-00001800: 5d2c 0a20 2020 2020 2020 2067 656f 6d65  ],.        geome
-00001810: 7472 7963 6f6c 756d 6e3a 2073 7472 2c0a  trycolumn: str,.
-00001820: 2020 2020 2020 2020 6765 6f6d 6574 7279          geometry
-00001830: 7479 7065 6e61 6d65 3a20 7374 722c 0a20  typename: str,. 
-00001840: 2020 2020 2020 2067 656f 6d65 7472 7974         geometryt
-00001850: 7970 653a 2047 656f 6d65 7472 7954 7970  ype: GeometryTyp
-00001860: 652c 0a20 2020 2020 2020 2063 6f6c 756d  e,.        colum
-00001870: 6e73 3a20 4469 6374 5b73 7472 2c20 436f  ns: Dict[str, Co
-00001880: 6c75 6d6e 496e 666f 5d2c 0a20 2020 2020  lumnInfo],.     
-00001890: 2020 2066 6964 5f63 6f6c 756d 6e3a 2073     fid_column: s
-000018a0: 7472 2c0a 2020 2020 2020 2020 6372 733a  tr,.        crs:
-000018b0: 204f 7074 696f 6e61 6c5b 7079 7072 6f6a   Optional[pyproj
-000018c0: 2e43 5253 5d2c 0a20 2020 2020 2020 2065  .CRS],.        e
-000018d0: 7272 6f72 733a 204c 6973 745b 7374 725d  rrors: List[str]
-000018e0: 2c0a 2020 2020 293a 0a20 2020 2020 2020  ,.    ):.       
-000018f0: 2022 2222 0a20 2020 2020 2020 2043 6f6e   """.        Con
-00001900: 7374 7275 6374 6f72 206f 6620 4c61 7965  structor of Laye
-00001910: 7269 6e66 6f2e 0a0a 2020 2020 2020 2020  rinfo...        
-00001920: 4172 6773 3a0a 2020 2020 2020 2020 2020  Args:.          
-00001930: 2020 6e61 6d65 2028 7374 7229 3a20 6e61    name (str): na
-00001940: 6d65 206f 6620 7468 6520 6c61 7965 722e  me of the layer.
-00001950: 0a20 2020 2020 2020 2020 2020 2066 6561  .            fea
-00001960: 7475 7265 636f 756e 7420 2869 6e74 293a  turecount (int):
-00001970: 206e 756d 6265 7220 6f66 2066 6561 7475   number of featu
-00001980: 7265 7320 696e 2074 6865 206c 6179 6572  res in the layer
-00001990: 2e0a 2020 2020 2020 2020 2020 2020 746f  ..            to
-000019a0: 7461 6c5f 626f 756e 6473 2028 5475 706c  tal_bounds (Tupl
-000019b0: 655b 666c 6f61 742c 2066 6c6f 6174 2c20  e[float, float, 
-000019c0: 666c 6f61 742c 2066 6c6f 6174 5d29 3a20  float, float]): 
-000019d0: 7468 6520 626f 756e 6473 206f 6620 7468  the bounds of th
-000019e0: 6520 6c61 7965 722e 0a20 2020 2020 2020  e layer..       
-000019f0: 2020 2020 2067 656f 6d65 7472 7963 6f6c       geometrycol
-00001a00: 756d 6e20 2873 7472 293a 2074 6865 206e  umn (str): the n
-00001a10: 616d 6520 6f66 2074 6865 2067 656f 6d65  ame of the geome
-00001a20: 7472 7920 636f 6c75 6d6e 2e0a 2020 2020  try column..    
-00001a30: 2020 2020 2020 2020 6765 6f6d 6574 7279          geometry
-00001a40: 7479 7065 6e61 6d65 2028 7374 7229 3a20  typename (str): 
-00001a50: 7468 6520 6e61 6d65 206f 6620 7468 6520  the name of the 
-00001a60: 6765 6f6d 6574 7279 2063 6f6c 756d 6e20  geometry column 
-00001a70: 7479 7065 2e0a 2020 2020 2020 2020 2020  type..          
-00001a80: 2020 6765 6f6d 6574 7279 7479 7065 2028    geometrytype (
-00001a90: 4765 6f6d 6574 7279 5479 7065 293a 2074  GeometryType): t
-00001aa0: 6865 2074 7970 6520 6f66 2074 6865 2067  he type of the g
-00001ab0: 656f 6d65 7472 7920 636f 6c75 6d6e 2e0a  eometry column..
-00001ac0: 2020 2020 2020 2020 2020 2020 636f 6c75              colu
-00001ad0: 6d6e 7320 2844 6963 745b 7374 722c 2043  mns (Dict[str, C
-00001ae0: 6f6c 756d 6e49 6e66 6f5d 293a 2074 6865  olumnInfo]): the
-00001af0: 2061 7474 7269 6275 7465 2063 6f6c 756d   attribute colum
-00001b00: 6e73 206f 6620 7468 6520 6c61 7965 722e  ns of the layer.
-00001b10: 0a20 2020 2020 2020 2020 2020 2066 6964  .            fid
-00001b20: 5f63 6f6c 756d 6e20 2873 7472 293a 2074  _column (str): t
-00001b30: 6865 206e 616d 6520 6f66 2074 6865 2066  he name of the f
-00001b40: 6964 2063 6f6c 756d 6e2e 0a20 2020 2020  id column..     
-00001b50: 2020 2020 2020 2063 7273 2028 4f70 7469         crs (Opti
-00001b60: 6f6e 616c 5b70 7970 726f 6a2e 4352 535d  onal[pyproj.CRS]
-00001b70: 293a 2074 6865 2063 7273 206f 6620 7468  ): the crs of th
-00001b80: 6520 6c61 7965 722e 0a20 2020 2020 2020  e layer..       
-00001b90: 2020 2020 2065 7272 6f72 7320 284c 6973       errors (Lis
-00001ba0: 745b 7374 725d 293a 2065 7272 6f72 7320  t[str]): errors 
-00001bb0: 656e 636f 756e 7465 7265 6420 7265 6164  encountered read
-00001bc0: 696e 6720 7468 6520 6c61 7965 7220 696e  ing the layer in
-00001bd0: 666f 2e0a 2020 2020 2020 2020 2222 220a  fo..        """.
-00001be0: 2020 2020 2020 2020 7365 6c66 2e6e 616d          self.nam
-00001bf0: 6520 3d20 6e61 6d65 0a20 2020 2020 2020  e = name.       
-00001c00: 2073 656c 662e 6665 6174 7572 6563 6f75   self.featurecou
-00001c10: 6e74 203d 2066 6561 7475 7265 636f 756e  nt = featurecoun
-00001c20: 740a 2020 2020 2020 2020 7365 6c66 2e74  t.        self.t
-00001c30: 6f74 616c 5f62 6f75 6e64 7320 3d20 746f  otal_bounds = to
-00001c40: 7461 6c5f 626f 756e 6473 0a20 2020 2020  tal_bounds.     
-00001c50: 2020 2073 656c 662e 6765 6f6d 6574 7279     self.geometry
-00001c60: 636f 6c75 6d6e 203d 2067 656f 6d65 7472  column = geometr
-00001c70: 7963 6f6c 756d 6e0a 2020 2020 2020 2020  ycolumn.        
-00001c80: 7365 6c66 2e67 656f 6d65 7472 7974 7970  self.geometrytyp
-00001c90: 656e 616d 6520 3d20 6765 6f6d 6574 7279  ename = geometry
-00001ca0: 7479 7065 6e61 6d65 0a20 2020 2020 2020  typename.       
-00001cb0: 2073 656c 662e 6765 6f6d 6574 7279 7479   self.geometryty
-00001cc0: 7065 203d 2067 656f 6d65 7472 7974 7970  pe = geometrytyp
-00001cd0: 650a 2020 2020 2020 2020 7365 6c66 2e63  e.        self.c
-00001ce0: 6f6c 756d 6e73 203d 2063 6f6c 756d 6e73  olumns = columns
-00001cf0: 0a20 2020 2020 2020 2073 656c 662e 6669  .        self.fi
-00001d00: 645f 636f 6c75 6d6e 203d 2066 6964 5f63  d_column = fid_c
-00001d10: 6f6c 756d 6e0a 2020 2020 2020 2020 7365  olumn.        se
-00001d20: 6c66 2e63 7273 203d 2063 7273 0a20 2020  lf.crs = crs.   
-00001d30: 2020 2020 2073 656c 662e 6572 726f 7273       self.errors
-00001d40: 203d 2065 7272 6f72 730a 0a20 2020 2064   = errors..    d
-00001d50: 6566 205f 5f72 6570 725f 5f28 7365 6c66  ef __repr__(self
-00001d60: 293a 0a20 2020 2020 2020 2022 2222 4f76  ):.        """Ov
-00001d70: 6572 7269 6465 7320 7468 6520 7265 7072  errides the repr
-00001d80: 6573 656e 7461 7469 6f6e 2070 726f 7065  esentation prope
-00001d90: 7274 7920 6f66 204c 6179 6572 496e 666f  rty of LayerInfo
-00001da0: 2e22 2222 0a20 2020 2020 2020 2072 6574  .""".        ret
-00001db0: 7572 6e20 6622 7b73 656c 662e 5f5f 636c  urn f"{self.__cl
-00001dc0: 6173 735f 5f7d 287b 7365 6c66 2e5f 5f64  ass__}({self.__d
-00001dd0: 6963 745f 5f7d 2922 0a0a 0a64 6566 2067  ict__})"...def g
-00001de0: 6574 5f6c 6179 6572 5f67 656f 6d65 7472  et_layer_geometr
-00001df0: 7974 7970 6573 280a 2020 2020 7061 7468  ytypes(.    path
-00001e00: 3a20 556e 696f 6e5b 7374 722c 2022 6f73  : Union[str, "os
-00001e10: 2e50 6174 684c 696b 655b 416e 795d 225d  .PathLike[Any]"]
-00001e20: 2c20 6c61 7965 723a 204f 7074 696f 6e61  , layer: Optiona
-00001e30: 6c5b 7374 725d 203d 204e 6f6e 650a 2920  l[str] = None.) 
-00001e40: 2d3e 204c 6973 745b 7374 725d 3a0a 2020  -> List[str]:.  
-00001e50: 2020 2222 220a 2020 2020 4765 7420 7468    """.    Get th
-00001e60: 6520 6765 6f6d 6574 7279 2074 7970 6573  e geometry types
-00001e70: 2069 6e20 7468 6520 6c61 7965 7220 6279   in the layer by
-00001e80: 2065 7861 6d69 6e69 6e67 2065 6163 6820   examining each 
-00001e90: 6765 6f6d 6574 7279 2069 6e20 7468 6520  geometry in the 
-00001ea0: 6c61 7965 722e 0a0a 2020 2020 5468 6520  layer...    The 
-00001eb0: 6765 6e65 7261 6c20 6765 6f6d 6574 7279  general geometry
-00001ec0: 2074 7970 6520 6f66 2074 6865 206c 6179   type of the lay
-00001ed0: 6572 2063 616e 2062 6520 6465 7465 726d  er can be determ
-00001ee0: 696e 6564 2075 7369 6e67 0a20 2020 203a  ined using.    :
-00001ef0: 6d65 7468 3a60 7e67 6574 5f6c 6179 6572  meth:`~get_layer
-00001f00: 696e 666f 602e 0a0a 2020 2020 4172 6773  info`...    Args
-00001f10: 3a0a 2020 2020 2020 2020 7061 7468 2028  :.        path (
-00001f20: 5061 7468 4c69 6b65 293a 2070 6174 6820  PathLike): path 
-00001f30: 746f 2074 6865 2066 696c 6520 746f 2067  to the file to g
-00001f40: 6574 2069 6e66 6f20 6162 6f75 740a 2020  et info about.  
-00001f50: 2020 2020 2020 6c61 7965 7220 2873 7472        layer (str
-00001f60: 293a 2074 6865 206c 6179 6572 2079 6f75  ): the layer you
-00001f70: 2077 616e 7420 696e 666f 2061 626f 7574   want info about
-00001f80: 2e20 446f 6573 6e27 7420 6e65 6564 2074  . Doesn't need t
-00001f90: 6f20 6265 0a20 2020 2020 2020 2020 2020  o be.           
-00001fa0: 2073 7065 6369 6669 6564 2069 6620 7468   specified if th
-00001fb0: 6572 6520 6973 206f 6e6c 7920 6f6e 6520  ere is only one 
-00001fc0: 6c61 7965 7220 696e 2074 6865 2067 656f  layer in the geo
-00001fd0: 6669 6c65 2e0a 0a20 2020 2052 6574 7572  file...    Retur
-00001fe0: 6e73 3a0a 2020 2020 2020 2020 4c69 7374  ns:.        List
-00001ff0: 5b73 7472 5d3a 2074 6865 2067 656f 6d65  [str]: the geome
-00002000: 7472 7920 7479 7065 7320 696e 2074 6865  try types in the
-00002010: 206c 6179 6572 2e0a 2020 2020 2222 220a   layer..    """.
-00002020: 2020 2020 7371 6c5f 7374 6d74 203d 2022      sql_stmt = "
-00002030: 2222 0a20 2020 2020 2020 2053 454c 4543  "".        SELEC
-00002040: 5420 4449 5354 494e 4354 0a20 2020 2020  T DISTINCT.     
-00002050: 2020 2020 2020 2020 2020 4341 5345 0a20            CASE. 
-00002060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002070: 5748 454e 2043 6173 7454 6f53 696e 676c  WHEN CastToSingl
-00002080: 6528 7b67 656f 6d65 7472 7963 6f6c 756d  e({geometrycolum
-00002090: 6e7d 2920 4953 204e 4f54 204e 554c 4c20  n}) IS NOT NULL 
-000020a0: 5448 454e 0a20 2020 2020 2020 2020 2020  THEN.           
-000020b0: 2020 2020 2020 2020 2020 5354 5f47 656f            ST_Geo
-000020c0: 6d65 7472 7954 7970 6528 4361 7374 546f  metryType(CastTo
-000020d0: 5369 6e67 6c65 287b 6765 6f6d 6574 7279  Single({geometry
-000020e0: 636f 6c75 6d6e 7d29 290a 2020 2020 2020  column})).      
-000020f0: 2020 2020 2020 2020 2020 2045 4c53 4520             ELSE 
-00002100: 5354 5f47 656f 6d65 7472 7954 7970 6528  ST_GeometryType(
-00002110: 7b67 656f 6d65 7472 7963 6f6c 756d 6e7d  {geometrycolumn}
-00002120: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00002130: 2045 4e44 2041 5320 6765 6f6d 5f74 7970   END AS geom_typ
-00002140: 650a 2020 2020 2020 2020 2020 4652 4f4d  e.          FROM
-00002150: 2022 7b69 6e70 7574 5f6c 6179 6572 7d22   "{input_layer}"
-00002160: 206c 6179 6572 0a20 2020 2022 2222 0a20   layer.    """. 
-00002170: 2020 2072 6573 756c 745f 6466 203d 2072     result_df = r
-00002180: 6561 645f 6669 6c65 2870 6174 682c 2073  ead_file(path, s
-00002190: 716c 5f73 746d 743d 7371 6c5f 7374 6d74  ql_stmt=sql_stmt
-000021a0: 2c20 7371 6c5f 6469 616c 6563 743d 2253  , sql_dialect="S
-000021b0: 514c 4954 4522 290a 2020 2020 7265 7475  QLITE").    retu
-000021c0: 726e 2072 6573 756c 745f 6466 5b22 6765  rn result_df["ge
-000021d0: 6f6d 5f74 7970 6522 5d2e 746f 5f6c 6973  om_type"].to_lis
-000021e0: 7428 290a 0a0a 6465 6620 6765 745f 6c61  t()...def get_la
-000021f0: 7965 7269 6e66 6f28 0a20 2020 2070 6174  yerinfo(.    pat
-00002200: 683a 2055 6e69 6f6e 5b73 7472 2c20 226f  h: Union[str, "o
-00002210: 732e 5061 7468 4c69 6b65 5b41 6e79 5d22  s.PathLike[Any]"
-00002220: 5d2c 0a20 2020 206c 6179 6572 3a20 4f70  ],.    layer: Op
-00002230: 7469 6f6e 616c 5b73 7472 5d20 3d20 4e6f  tional[str] = No
-00002240: 6e65 2c0a 2020 2020 7261 6973 655f 6f6e  ne,.    raise_on
-00002250: 5f6e 6f67 656f 6d3a 2062 6f6f 6c20 3d20  _nogeom: bool = 
-00002260: 5472 7565 2c0a 2920 2d3e 204c 6179 6572  True,.) -> Layer
-00002270: 496e 666f 3a0a 2020 2020 2222 220a 2020  Info:.    """.  
-00002280: 2020 4765 7420 696e 666f 726d 6174 696f    Get informatio
-00002290: 6e20 6162 6f75 7420 6120 6c61 7965 7220  n about a layer 
-000022a0: 696e 2074 6865 2067 656f 6669 6c65 2e0a  in the geofile..
-000022b0: 0a20 2020 2052 6169 7365 7320 5661 6c75  .    Raises Valu
-000022c0: 6545 7272 6f72 2069 6620 7468 6520 6c61  eError if the la
-000022d0: 7965 7220 6465 6669 6e69 7469 6f6e 2068  yer definition h
-000022e0: 6173 2065 7272 6f72 7320 6c69 6b65 2069  as errors like i
-000022f0: 6e76 616c 6964 2063 6f6c 756d 6e20 6e61  nvalid column na
-00002300: 6d65 732c 2e2e 2e0a 0a20 2020 2041 7267  mes,.....    Arg
-00002310: 733a 0a20 2020 2020 2020 2070 6174 6820  s:.        path 
-00002320: 2850 6174 684c 696b 6529 3a20 7061 7468  (PathLike): path
-00002330: 2074 6f20 7468 6520 6669 6c65 2074 6f20   to the file to 
-00002340: 6765 7420 696e 666f 2061 626f 7574 0a20  get info about. 
-00002350: 2020 2020 2020 206c 6179 6572 2028 7374         layer (st
-00002360: 722c 206f 7074 696f 6e61 6c29 3a20 7468  r, optional): th
-00002370: 6520 6c61 7965 7220 796f 7520 7761 6e74  e layer you want
-00002380: 2069 6e66 6f20 6162 6f75 742e 2044 6f65   info about. Doe
-00002390: 736e 2774 206e 6565 6420 746f 2062 650a  sn't need to be.
-000023a0: 2020 2020 2020 2020 2020 2020 7370 6563              spec
-000023b0: 6966 6965 6420 6966 2074 6865 7265 2069  ified if there i
-000023c0: 7320 6f6e 6c79 206f 6e65 206c 6179 6572  s only one layer
-000023d0: 2069 6e20 7468 6520 6765 6f66 696c 652e   in the geofile.
-000023e0: 0a20 2020 2020 2020 2072 6169 7365 5f6f  .        raise_o
-000023f0: 6e5f 6e6f 6765 6f6d 2028 626f 6f6c 2c20  n_nogeom (bool, 
-00002400: 6f70 7469 6f6e 616c 293a 2054 7275 6520  optional): True 
-00002410: 746f 2072 6169 7365 2069 6620 7468 6520  to raise if the 
-00002420: 6c61 7965 7220 646f 6573 6e27 7420 6861  layer doesn't ha
-00002430: 7665 2061 0a20 2020 2020 2020 2020 2020  ve a.           
-00002440: 2067 656f 6d65 7472 7920 636f 6c75 6d6e   geometry column
-00002450: 2e20 4966 2046 616c 7365 2c20 7468 6520  . If False, the 
-00002460: 7265 7475 726e 6564 204c 6179 6572 496e  returned LayerIn
-00002470: 666f 2e67 656f 6d65 7472 7963 6f6c 756d  fo.geometrycolum
-00002480: 6e20 7769 6c6c 2062 650a 2020 2020 2020  n will be.      
-00002490: 2020 2020 2020 4e6f 6e65 2e20 4465 6661        None. Defa
-000024a0: 756c 7473 2074 6f20 5472 7565 2e0a 0a20  ults to True... 
-000024b0: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
-000024c0: 2020 2020 4c61 7965 7249 6e66 6f3a 2074      LayerInfo: t
-000024d0: 6865 2069 6e66 6f72 6d61 7469 6f6e 2061  he information a
-000024e0: 626f 7574 2074 6865 206c 6179 6572 2e0a  bout the layer..
-000024f0: 2020 2020 2222 220a 2020 2020 2320 496e      """.    # In
-00002500: 6974 0a20 2020 2070 6174 6820 3d20 5061  it.    path = Pa
-00002510: 7468 2870 6174 6829 0a20 2020 2069 6620  th(path).    if 
-00002520: 6e6f 7420 7061 7468 2e65 7869 7374 7328  not path.exists(
-00002530: 293a 0a20 2020 2020 2020 2072 6169 7365  ):.        raise
-00002540: 2056 616c 7565 4572 726f 7228 6622 696e   ValueError(f"in
-00002550: 7075 745f 7061 7468 2064 6f65 736e 2774  put_path doesn't
-00002560: 2065 7869 7374 3a20 7b70 6174 687d 2229   exist: {path}")
-00002570: 0a0a 2020 2020 6966 206c 6179 6572 2069  ..    if layer i
-00002580: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-00002590: 6c61 7965 7220 3d20 6765 745f 6f6e 6c79  layer = get_only
-000025a0: 5f6c 6179 6572 2870 6174 6829 0a0a 2020  _layer(path)..  
-000025b0: 2020 6461 7461 736f 7572 6365 203d 204e    datasource = N
-000025c0: 6f6e 650a 2020 2020 7472 793a 0a20 2020  one.    try:.   
-000025d0: 2020 2020 2064 6174 6173 6f75 7263 6520       datasource 
-000025e0: 3d20 6764 616c 2e4f 7065 6e45 7828 0a20  = gdal.OpenEx(. 
-000025f0: 2020 2020 2020 2020 2020 2073 7472 2870             str(p
-00002600: 6174 6829 2c20 6e4f 7065 6e46 6c61 6773  ath), nOpenFlags
-00002610: 3d67 6461 6c2e 4f46 5f56 4543 544f 5220  =gdal.OF_VECTOR 
-00002620: 7c20 6764 616c 2e4f 465f 5245 4144 4f4e  | gdal.OF_READON
-00002630: 4c59 207c 2067 6461 6c2e 4f46 5f53 4841  LY | gdal.OF_SHA
-00002640: 5245 440a 2020 2020 2020 2020 290a 2020  RED.        ).  
-00002650: 2020 2020 2020 6461 7461 736f 7572 6365        datasource
-00002660: 5f6c 6179 6572 203d 2064 6174 6173 6f75  _layer = datasou
-00002670: 7263 652e 4765 744c 6179 6572 286c 6179  rce.GetLayer(lay
-00002680: 6572 290a 0a20 2020 2020 2020 2023 2049  er)..        # I
-00002690: 6620 7468 6520 6c61 7965 7220 646f 6573  f the layer does
-000026a0: 6e27 7420 6578 6973 742c 2072 6574 7572  n't exist, retur
-000026b0: 6e0a 2020 2020 2020 2020 6966 2064 6174  n.        if dat
-000026c0: 6173 6f75 7263 655f 6c61 7965 7220 6973  asource_layer is
-000026d0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-000026e0: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-000026f0: 726f 7228 6622 4c61 7965 7220 7b6c 6179  ror(f"Layer {lay
-00002700: 6572 7d20 6e6f 7420 666f 756e 6420 696e  er} not found in
-00002710: 2066 696c 653a 207b 7061 7468 7d22 290a   file: {path}").
-00002720: 0a20 2020 2020 2020 2023 2047 6574 2063  .        # Get c
-00002730: 6f6c 756d 6e20 696e 666f 0a20 2020 2020  olumn info.     
-00002740: 2020 2063 6f6c 756d 6e73 203d 207b 7d0a     columns = {}.
-00002750: 2020 2020 2020 2020 6572 726f 7273 203d          errors =
-00002760: 205b 5d0a 2020 2020 2020 2020 6472 6976   [].        driv
-00002770: 6572 203d 2064 6174 6173 6f75 7263 652e  er = datasource.
-00002780: 4765 7444 7269 7665 7228 292e 5368 6f72  GetDriver().Shor
-00002790: 744e 616d 650a 2020 2020 2020 2020 6c61  tName.        la
-000027a0: 7965 725f 6465 666e 203d 2064 6174 6173  yer_defn = datas
-000027b0: 6f75 7263 655f 6c61 7965 722e 4765 744c  ource_layer.GetL
-000027c0: 6179 6572 4465 666e 2829 0a20 2020 2020  ayerDefn().     
-000027d0: 2020 2066 6f72 2069 2069 6e20 7261 6e67     for i in rang
-000027e0: 6528 6c61 7965 725f 6465 666e 2e47 6574  e(layer_defn.Get
-000027f0: 4669 656c 6443 6f75 6e74 2829 293a 0a20  FieldCount()):. 
-00002800: 2020 2020 2020 2020 2020 206e 616d 6520             name 
-00002810: 3d20 6c61 7965 725f 6465 666e 2e47 6574  = layer_defn.Get
-00002820: 4669 656c 6444 6566 6e28 6929 2e47 6574  FieldDefn(i).Get
-00002830: 4e61 6d65 2829 0a20 2020 2020 2020 2020  Name().         
-00002840: 2020 2023 2054 4f44 4f3a 2074 6869 6e6b     # TODO: think
-00002850: 2077 6865 7468 6572 2074 6865 2074 7970   whether the typ
-00002860: 6520 6e61 6d65 2073 686f 756c 6420 6265  e name should be
-00002870: 2063 6f6e 7665 7274 6564 2074 6f20 6f74   converted to ot
-00002880: 6865 7220 6e61 6d65 730a 2020 2020 2020  her names.      
-00002890: 2020 2020 2020 6764 616c 5f74 7970 6520        gdal_type 
-000028a0: 3d20 6c61 7965 725f 6465 666e 2e47 6574  = layer_defn.Get
-000028b0: 4669 656c 6444 6566 6e28 6929 2e47 6574  FieldDefn(i).Get
-000028c0: 5479 7065 4e61 6d65 2829 0a20 2020 2020  TypeName().     
-000028d0: 2020 2020 2020 2077 6964 7468 203d 206c         width = l
-000028e0: 6179 6572 5f64 6566 6e2e 4765 7446 6965  ayer_defn.GetFie
-000028f0: 6c64 4465 666e 2869 292e 4765 7457 6964  ldDefn(i).GetWid
-00002900: 7468 2829 0a20 2020 2020 2020 2020 2020  th().           
-00002910: 2077 6964 7468 203d 2077 6964 7468 2069   width = width i
-00002920: 6620 7769 6474 6820 3e20 3020 656c 7365  f width > 0 else
-00002930: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
-00002940: 2020 7072 6563 6973 696f 6e20 3d20 6c61    precision = la
-00002950: 7965 725f 6465 666e 2e47 6574 4669 656c  yer_defn.GetFiel
-00002960: 6444 6566 6e28 6929 2e47 6574 5072 6563  dDefn(i).GetPrec
-00002970: 6973 696f 6e28 290a 2020 2020 2020 2020  ision().        
-00002980: 2020 2020 7072 6563 6973 696f 6e20 3d20      precision = 
-00002990: 7072 6563 6973 696f 6e20 6966 2070 7265  precision if pre
-000029a0: 6369 7369 6f6e 203e 2030 2065 6c73 6520  cision > 0 else 
-000029b0: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-000029c0: 2069 6c6c 6567 616c 5f63 6f6c 756d 6e5f   illegal_column_
-000029d0: 6368 6172 7320 3d20 5b27 2227 5d0a 2020  chars = ['"'].  
-000029e0: 2020 2020 2020 2020 2020 666f 7220 696c            for il
-000029f0: 6c65 6761 6c5f 6368 6172 2069 6e20 696c  legal_char in il
-00002a00: 6c65 6761 6c5f 636f 6c75 6d6e 5f63 6861  legal_column_cha
-00002a10: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
-00002a20: 2020 2020 6966 2069 6c6c 6567 616c 5f63      if illegal_c
-00002a30: 6861 7220 696e 206e 616d 653a 0a20 2020  har in name:.   
-00002a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002a50: 2065 7272 6f72 732e 6170 7065 6e64 280a   errors.append(.
-00002a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002a70: 2020 2020 2020 2020 6622 436f 6c75 6d6e          f"Column
-00002a80: 206e 616d 6520 7b6e 616d 657d 2063 6f6e   name {name} con
-00002a90: 7461 696e 7320 696c 6c65 6761 6c20 6368  tains illegal ch
-00002aa0: 6172 3a20 7b69 6c6c 6567 616c 5f63 6861  ar: {illegal_cha
-00002ab0: 727d 2022 0a20 2020 2020 2020 2020 2020  r} ".           
-00002ac0: 2020 2020 2020 2020 2020 2020 2066 2269               f"i
-00002ad0: 6e20 6669 6c65 207b 7061 7468 7d2c 206c  n file {path}, l
-00002ae0: 6179 6572 207b 6c61 7965 727d 220a 2020  ayer {layer}".  
-00002af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002b00: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00002b10: 636f 6c75 6d6e 5f69 6e66 6f20 3d20 436f  column_info = Co
-00002b20: 6c75 6d6e 496e 666f 280a 2020 2020 2020  lumnInfo(.      
-00002b30: 2020 2020 2020 2020 2020 6e61 6d65 3d6e            name=n
-00002b40: 616d 652c 2067 6461 6c5f 7479 7065 3d67  ame, gdal_type=g
-00002b50: 6461 6c5f 7479 7065 2c20 7769 6474 683d  dal_type, width=
-00002b60: 7769 6474 682c 2070 7265 6369 7369 6f6e  width, precision
-00002b70: 3d70 7265 6369 7369 6f6e 0a20 2020 2020  =precision.     
-00002b80: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00002b90: 2020 2020 2063 6f6c 756d 6e73 5b6e 616d       columns[nam
-00002ba0: 655d 203d 2063 6f6c 756d 6e5f 696e 666f  e] = column_info
-00002bb0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00002bc0: 6472 6976 6572 203d 3d20 2245 5352 4920  driver == "ESRI 
-00002bd0: 5368 6170 6566 696c 6522 3a0a 2020 2020  Shapefile":.    
-00002be0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-00002bf0: 616d 652e 6361 7365 666f 6c64 2829 203d  ame.casefold() =
-00002c00: 3d20 2267 656f 6d65 7472 7922 3a0a 2020  = "geometry":.  
-00002c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002c20: 2020 6572 726f 7273 2e61 7070 656e 6428    errors.append(
-00002c30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002c40: 2020 2020 2020 2020 2022 416e 2061 7474           "An att
-00002c50: 7269 6275 7465 2063 6f6c 756d 6e20 2767  ribute column 'g
-00002c60: 656f 6d65 7472 7927 2069 7320 6e6f 7420  eometry' is not 
-00002c70: 7375 7070 6f72 7465 6420 696e 2061 2073  supported in a s
-00002c80: 6861 7065 6669 6c65 220a 2020 2020 2020  hapefile".      
-00002c90: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00002ca0: 0a20 2020 2020 2020 2023 2047 6574 2067  .        # Get g
-00002cb0: 656f 6d65 7472 7920 636f 6c75 6d6e 2069  eometry column i
-00002cc0: 6e66 6f2e 2e2e 0a20 2020 2020 2020 2067  nfo....        g
-00002cd0: 656f 6d65 7472 7974 7970 6520 3d20 5f6f  eometrytype = _o
-00002ce0: 6772 5f75 7469 6c2e 6f67 7274 7970 655f  gr_util.ogrtype_
-00002cf0: 746f 5f67 656f 6d65 7472 7974 7970 655b  to_geometrytype[
-00002d00: 6461 7461 736f 7572 6365 5f6c 6179 6572  datasource_layer
-00002d10: 2e47 6574 4765 6f6d 5479 7065 2829 5d0a  .GetGeomType()].
-00002d20: 2020 2020 2020 2020 6966 2067 656f 6d65          if geome
-00002d30: 7472 7974 7970 6520 6973 204e 6f6e 653a  trytype is None:
-00002d40: 0a20 2020 2020 2020 2020 2020 2067 656f  .            geo
-00002d50: 6d65 7472 7974 7970 656e 616d 6520 3d20  metrytypename = 
-00002d60: 224e 4f4e 4522 0a20 2020 2020 2020 2065  "NONE".        e
-00002d70: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00002d80: 2023 2046 6f72 2073 6861 7065 2066 696c   # For shape fil
-00002d90: 6573 2c20 7468 6520 6469 6666 6572 656e  es, the differen
-00002da0: 6365 2062 6574 7765 656e 2074 6865 2027  ce between the '
-00002db0: 4d55 4c54 4927 2076 6172 6961 6e74 2061  MULTI' variant a
-00002dc0: 6e64 2074 6865 0a20 2020 2020 2020 2020  nd the.         
-00002dd0: 2020 2023 2073 696e 676c 6520 6f6e 6520     # single one 
-00002de0: 646f 6573 6e27 7420 6578 6973 7473 2e2e  doesn't exists..
-00002df0: 2e20 736f 2061 6c77 6179 7320 7265 706f  . so always repo
-00002e00: 7274 204d 554c 5449 2076 6172 6961 6e74  rt MULTI variant
-00002e10: 2062 7920 636f 6e76 656e 7469 6f6e 2e0a   by convention..
-00002e20: 2020 2020 2020 2020 2020 2020 6966 2064              if d
-00002e30: 7269 7665 7220 3d3d 2022 4553 5249 2053  river == "ESRI S
-00002e40: 6861 7065 6669 6c65 223a 0a20 2020 2020  hapefile":.     
-00002e50: 2020 2020 2020 2020 2020 2067 656f 6d65             geome
-00002e60: 7472 7974 7970 6520 3d20 6765 6f6d 6574  trytype = geomet
-00002e70: 7279 7479 7065 2e74 6f5f 6d75 6c74 6974  rytype.to_multit
-00002e80: 7970 650a 0a20 2020 2020 2020 2020 2020  ype..           
-00002e90: 2067 656f 6d65 7472 7974 7970 656e 616d   geometrytypenam
-00002ea0: 6520 3d20 6765 6f6d 6574 7279 7479 7065  e = geometrytype
-00002eb0: 2e6e 616d 650a 0a20 2020 2020 2020 2023  .name..        #
-00002ec0: 2049 6620 7468 6520 6765 6f6d 6574 7279   If the geometry
-00002ed0: 2074 7970 6520 6973 206e 6f74 204e 6f6e   type is not Non
-00002ee0: 652c 2066 696c 6c20 6f75 7420 7468 6520  e, fill out the 
-00002ef0: 6578 7472 6120 7072 6f70 6572 7469 6573  extra properties
-00002f00: 0a20 2020 2020 2020 2067 656f 6d65 7472  .        geometr
-00002f10: 7963 6f6c 756d 6e20 3d20 4e6f 6e65 0a20  ycolumn = None. 
-00002f20: 2020 2020 2020 2065 7874 656e 7420 3d20         extent = 
-00002f30: 4e6f 6e65 0a20 2020 2020 2020 2063 7273  None.        crs
-00002f40: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-00002f50: 746f 7461 6c5f 626f 756e 6473 203d 204e  total_bounds = N
-00002f60: 6f6e 650a 2020 2020 2020 2020 6966 2067  one.        if g
-00002f70: 656f 6d65 7472 7974 7970 6520 6973 206e  eometrytype is n
-00002f80: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-00002f90: 2020 2020 2023 2047 656f 6d65 7472 7920       # Geometry 
-00002fa0: 636f 6c75 6d6e 206e 616d 650a 2020 2020  column name.    
-00002fb0: 2020 2020 2020 2020 6765 6f6d 6574 7279          geometry
-00002fc0: 636f 6c75 6d6e 203d 2064 6174 6173 6f75  column = datasou
-00002fd0: 7263 655f 6c61 7965 722e 4765 7447 656f  rce_layer.GetGeo
-00002fe0: 6d65 7472 7943 6f6c 756d 6e28 290a 2020  metryColumn().  
-00002ff0: 2020 2020 2020 2020 2020 6966 2067 656f            if geo
-00003000: 6d65 7472 7963 6f6c 756d 6e20 3d3d 2022  metrycolumn == "
-00003010: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
-00003020: 2020 2067 656f 6d65 7472 7963 6f6c 756d     geometrycolum
-00003030: 6e20 3d20 2267 656f 6d65 7472 7922 0a20  n = "geometry". 
-00003040: 2020 2020 2020 2020 2020 2023 2043 6f6e             # Con
-00003050: 7665 7274 2065 7874 656e 7420 2878 6d69  vert extent (xmi
-00003060: 6e2c 2078 6d61 782c 2079 6d69 6e2c 2079  n, xmax, ymin, y
-00003070: 6d61 7829 2074 6f20 626f 756e 6473 2028  max) to bounds (
-00003080: 786d 696e 2c20 796d 696e 2c20 786d 6178  xmin, ymin, xmax
-00003090: 2c20 796d 6178 290a 2020 2020 2020 2020  , ymax).        
-000030a0: 2020 2020 6578 7465 6e74 203d 2064 6174      extent = dat
-000030b0: 6173 6f75 7263 655f 6c61 7965 722e 4765  asource_layer.Ge
-000030c0: 7445 7874 656e 7428 290a 2020 2020 2020  tExtent().      
-000030d0: 2020 2020 2020 746f 7461 6c5f 626f 756e        total_boun
-000030e0: 6473 203d 2028 6578 7465 6e74 5b30 5d2c  ds = (extent[0],
-000030f0: 2065 7874 656e 745b 325d 2c20 6578 7465   extent[2], exte
-00003100: 6e74 5b31 5d2c 2065 7874 656e 745b 335d  nt[1], extent[3]
-00003110: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
-00003120: 4352 530a 2020 2020 2020 2020 2020 2020  CRS.            
-00003130: 7370 6174 6961 6c72 6566 203d 2064 6174  spatialref = dat
-00003140: 6173 6f75 7263 655f 6c61 7965 722e 4765  asource_layer.Ge
-00003150: 7453 7061 7469 616c 5265 6628 290a 2020  tSpatialRef().  
-00003160: 2020 2020 2020 2020 2020 6966 2073 7061            if spa
-00003170: 7469 616c 7265 6620 6973 206e 6f74 204e  tialref is not N
-00003180: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00003190: 2020 2020 2063 7273 203d 2070 7970 726f       crs = pypro
-000031a0: 6a2e 4352 5328 7370 6174 6961 6c72 6566  j.CRS(spatialref
-000031b0: 2e45 7870 6f72 7454 6f57 6b74 2829 290a  .ExportToWkt()).
-000031c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000031d0: 2023 2049 6620 7370 6174 6961 6c20 7265   # If spatial re
-000031e0: 6620 6861 7320 6e6f 2065 7073 672c 2074  f has no epsg, t
-000031f0: 7279 2074 6f20 6669 6e64 2063 6f72 7265  ry to find corre
-00003200: 7370 6f6e 6469 6e67 206f 6e65 0a20 2020  sponding one.   
-00003210: 2020 2020 2020 2020 2020 2020 2063 7273               crs
-00003220: 5f65 7073 6720 3d20 6372 732e 746f 5f65  _epsg = crs.to_e
-00003230: 7073 6728 290a 2020 2020 2020 2020 2020  psg().          
-00003240: 2020 2020 2020 6966 2063 7273 5f65 7073        if crs_eps
-00003250: 6720 6973 204e 6f6e 653a 0a20 2020 2020  g is None:.     
-00003260: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00003270: 6620 6372 732e 6e61 6d65 2069 6e20 5b0a  f crs.name in [.
-00003280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003290: 2020 2020 2020 2020 2242 656c 6765 2031          "Belge 1
-000032a0: 3937 3220 2f20 4265 6c67 6961 6e20 4c61  972 / Belgian La
-000032b0: 6d62 6572 7420 3732 222c 0a20 2020 2020  mbert 72",.     
-000032c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000032d0: 2020 2022 4265 6c67 655f 3139 3732 5f42     "Belge_1972_B
-000032e0: 656c 6769 616e 5f4c 616d 6265 7274 5f37  elgian_Lambert_7
-000032f0: 3222 2c0a 2020 2020 2020 2020 2020 2020  2",.            
-00003300: 2020 2020 2020 2020 2020 2020 2242 656c              "Bel
-00003310: 6765 5f4c 616d 6265 7274 5f31 3937 3222  ge_Lambert_1972"
-00003320: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00003330: 2020 2020 2020 2020 2020 2242 4437 3220            "BD72 
-00003340: 2f20 4265 6c67 6961 6e20 4c61 6d62 6572  / Belgian Lamber
-00003350: 7420 3732 222c 0a20 2020 2020 2020 2020  t 72",.         
-00003360: 2020 2020 2020 2020 2020 205d 3a0a 2020             ]:.  
-00003370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003380: 2020 2020 2020 2320 4265 6c67 6961 6e20        # Belgian 
-00003390: 4c61 6d62 6572 7420 696e 206e 616d 652c  Lambert in name,
-000033a0: 2073 6f20 6173 7375 6d65 2033 3133 3730   so assume 31370
-000033b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000033c0: 2020 2020 2020 2020 2063 7273 203d 2070           crs = p
-000033d0: 7970 726f 6a2e 4352 532e 6672 6f6d 5f65  yproj.CRS.from_e
-000033e0: 7073 6728 3331 3337 3029 0a0a 2020 2020  psg(31370)..    
-000033f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003400: 2020 2020 2320 4966 2073 6861 7065 6669      # If shapefi
-00003410: 6c65 2c20 6164 6420 636f 7272 6563 7420  le, add correct 
-00003420: 3331 3337 3020 2e70 726a 2066 696c 650a  31370 .prj file.
-00003430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003440: 2020 2020 2020 2020 6966 2064 7269 7665          if drive
-00003450: 7220 3d3d 2022 4553 5249 2053 6861 7065  r == "ESRI Shape
-00003460: 6669 6c65 223a 0a20 2020 2020 2020 2020  file":.         
-00003470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003480: 2020 2070 726a 5f70 6174 6820 3d20 7061     prj_path = pa
-00003490: 7468 2e70 6172 656e 7420 2f20 6622 7b70  th.parent / f"{p
-000034a0: 6174 682e 7374 656d 7d2e 7072 6a22 0a20  ath.stem}.prj". 
-000034b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000034c0: 2020 2020 2020 2020 2020 2069 6620 7072             if pr
-000034d0: 6a5f 7061 7468 2e65 7869 7374 7328 293a  j_path.exists():
-000034e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000034f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003500: 2070 726a 5f72 656e 616d 655f 7061 7468   prj_rename_path
-00003510: 203d 2070 6174 682e 7061 7265 6e74 202f   = path.parent /
-00003520: 2066 227b 7061 7468 2e73 7465 6d7d 5f6f   f"{path.stem}_o
-00003530: 7269 672e 7072 6a22 0a20 2020 2020 2020  rig.prj".       
-00003540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003550: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-00003560: 7072 6a5f 7265 6e61 6d65 5f70 6174 682e  prj_rename_path.
-00003570: 6578 6973 7473 2829 3a0a 2020 2020 2020  exists():.      
-00003580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003590: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-000035a0: 6a5f 7061 7468 2e72 656e 616d 6528 7072  j_path.rename(pr
-000035b0: 6a5f 7265 6e61 6d65 5f70 6174 6829 0a20  j_rename_path). 
-000035c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000035d0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-000035e0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-000035f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003600: 2020 2020 2020 2020 2070 726a 5f70 6174           prj_pat
-00003610: 682e 756e 6c69 6e6b 2829 0a20 2020 2020  h.unlink().     
-00003620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003630: 2020 2020 2020 2020 2020 2070 726a 5f70             prj_p
-00003640: 6174 682e 7772 6974 655f 7465 7874 2850  ath.write_text(P
-00003650: 524a 5f45 5053 475f 3331 3337 3029 0a20  RJ_EPSG_31370). 
-00003660: 2020 2020 2020 2065 6c69 6620 7261 6973         elif rais
-00003670: 655f 6f6e 5f6e 6f67 656f 6d3a 0a20 2020  e_on_nogeom:.   
-00003680: 2020 2020 2020 2020 2065 7272 6f72 732e           errors.
-00003690: 6170 7065 6e64 2822 4c61 7965 7220 646f  append("Layer do
-000036a0: 6573 6e27 7420 6861 7665 2061 2067 656f  esn't have a geo
-000036b0: 6d65 7472 7920 636f 6c75 6d6e 2122 290a  metry column!").
-000036c0: 0a20 2020 2020 2020 2023 2049 6620 7468  .        # If th
-000036d0: 6572 6520 7765 7265 206e 6f20 6572 726f  ere were no erro
-000036e0: 7273 2c20 6576 6572 7974 6869 6e67 2077  rs, everything w
-000036f0: 6173 204f 4b20 736f 2077 6520 6361 6e20  as OK so we can 
-00003700: 7265 7475 726e 2e0a 2020 2020 2020 2020  return..        
-00003710: 6966 206c 656e 2865 7272 6f72 7329 203d  if len(errors) =
-00003720: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
-00003730: 2072 6574 7572 6e20 4c61 7965 7249 6e66   return LayerInf
-00003740: 6f28 0a20 2020 2020 2020 2020 2020 2020  o(.             
-00003750: 2020 206e 616d 653d 6461 7461 736f 7572     name=datasour
-00003760: 6365 5f6c 6179 6572 2e47 6574 4e61 6d65  ce_layer.GetName
-00003770: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
-00003780: 2020 2020 6665 6174 7572 6563 6f75 6e74      featurecount
-00003790: 3d64 6174 6173 6f75 7263 655f 6c61 7965  =datasource_laye
-000037a0: 722e 4765 7446 6561 7475 7265 436f 756e  r.GetFeatureCoun
-000037b0: 7428 292c 0a20 2020 2020 2020 2020 2020  t(),.           
-000037c0: 2020 2020 2074 6f74 616c 5f62 6f75 6e64       total_bound
-000037d0: 733d 746f 7461 6c5f 626f 756e 6473 2c20  s=total_bounds, 
-000037e0: 2023 2074 7970 653a 2069 676e 6f72 655b   # type: ignore[
-000037f0: 6172 672d 7479 7065 5d0a 2020 2020 2020  arg-type].      
-00003800: 2020 2020 2020 2020 2020 6765 6f6d 6574            geomet
-00003810: 7279 636f 6c75 6d6e 3d67 656f 6d65 7472  rycolumn=geometr
-00003820: 7963 6f6c 756d 6e2c 2020 2320 7479 7065  ycolumn,  # type
-00003830: 3a20 6967 6e6f 7265 5b61 7267 2d74 7970  : ignore[arg-typ
-00003840: 655d 0a20 2020 2020 2020 2020 2020 2020  e].             
-00003850: 2020 2067 656f 6d65 7472 7974 7970 656e     geometrytypen
-00003860: 616d 653d 6765 6f6d 6574 7279 7479 7065  ame=geometrytype
-00003870: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
-00003880: 2020 2020 2020 6765 6f6d 6574 7279 7479        geometryty
-00003890: 7065 3d67 656f 6d65 7472 7974 7970 652c  pe=geometrytype,
-000038a0: 2020 2320 7479 7065 3a20 6967 6e6f 7265    # type: ignore
-000038b0: 5b61 7267 2d74 7970 655d 0a20 2020 2020  [arg-type].     
-000038c0: 2020 2020 2020 2020 2020 2063 6f6c 756d             colum
-000038d0: 6e73 3d63 6f6c 756d 6e73 2c0a 2020 2020  ns=columns,.    
-000038e0: 2020 2020 2020 2020 2020 2020 6669 645f              fid_
-000038f0: 636f 6c75 6d6e 3d64 6174 6173 6f75 7263  column=datasourc
-00003900: 655f 6c61 7965 722e 4765 7446 4944 436f  e_layer.GetFIDCo
-00003910: 6c75 6d6e 2829 2c0a 2020 2020 2020 2020  lumn(),.        
-00003920: 2020 2020 2020 2020 6372 733d 6372 732c          crs=crs,
-00003930: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003940: 2065 7272 6f72 733d 6572 726f 7273 2c0a   errors=errors,.
-00003950: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-00003960: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
-00003970: 696f 6e20 6173 2065 783a 0a20 2020 2020  ion as ex:.     
-00003980: 2020 2065 782e 6172 6773 203d 2028 6622     ex.args = (f"
-00003990: 6765 745f 6c61 7965 7269 6e66 6f20 6572  get_layerinfo er
-000039a0: 726f 7220 666f 7220 7b70 6174 687d 2e7b  ror for {path}.{
-000039b0: 6c61 7965 727d 3a5c 6e20 207b 6578 7d22  layer}:\n  {ex}"
-000039c0: 2c29 0a20 2020 2020 2020 2072 6169 7365  ,).        raise
-000039d0: 0a20 2020 2066 696e 616c 6c79 3a0a 2020  .    finally:.  
-000039e0: 2020 2020 2020 6461 7461 736f 7572 6365        datasource
-000039f0: 203d 204e 6f6e 650a 0a20 2020 2023 2049   = None..    # I
-00003a00: 6620 7765 2064 6964 6e27 7420 7265 7475  f we didn't retu
-00003a10: 726e 206f 7220 7261 6973 6520 7965 7420  rn or raise yet 
-00003a20: 6865 7265 2c20 7468 6572 6520 6d75 7374  here, there must
-00003a30: 2068 6176 6520 6265 656e 2065 7272 6f72   have been error
-00003a40: 730a 2020 2020 6572 726f 7273 5f73 7472  s.    errors_str
-00003a50: 203d 2070 7072 696e 742e 7066 6f72 6d61   = pprint.pforma
-00003a60: 7428 6572 726f 7273 290a 2020 2020 7261  t(errors).    ra
-00003a70: 6973 6520 5661 6c75 6545 7272 6f72 280a  ise ValueError(.
-00003a80: 2020 2020 2020 2020 6622 4572 726f 7273          f"Errors
-00003a90: 2069 6e20 6c61 7965 7220 6465 6669 6e69   in layer defini
-00003aa0: 7469 6f6e 206f 6620 6669 6c65 207b 7061  tion of file {pa
-00003ab0: 7468 7d2c 206c 6179 6572 207b 6c61 7965  th}, layer {laye
-00003ac0: 727d 3a20 5c6e 7b65 7272 6f72 735f 7374  r}: \n{errors_st
-00003ad0: 727d 220a 2020 2020 290a 0a0a 6465 6620  r}".    )...def 
-00003ae0: 6765 745f 6f6e 6c79 5f6c 6179 6572 2870  get_only_layer(p
-00003af0: 6174 683a 2055 6e69 6f6e 5b73 7472 2c20  ath: Union[str, 
-00003b00: 226f 732e 5061 7468 4c69 6b65 5b41 6e79  "os.PathLike[Any
-00003b10: 5d22 5d29 202d 3e20 7374 723a 0a20 2020  ]"]) -> str:.   
-00003b20: 2022 2222 0a20 2020 2047 6574 2074 6865   """.    Get the
-00003b30: 206c 6179 6572 6e61 6d65 2066 6f72 2061   layername for a
-00003b40: 2066 696c 6520 7468 6174 206f 6e6c 7920   file that only 
-00003b50: 636f 6e74 6169 6e73 206f 6e65 206c 6179  contains one lay
-00003b60: 6572 2e0a 0a20 2020 2049 6620 7468 6520  er...    If the 
-00003b70: 6669 6c65 2063 6f6e 7461 696e 7320 6d75  file contains mu
-00003b80: 6c74 6970 6c65 206c 6179 6572 732c 2061  ltiple layers, a
-00003b90: 6e20 6578 6365 7074 696f 6e20 6973 2074  n exception is t
-00003ba0: 6872 6f77 6e2e 0a0a 2020 2020 4172 6773  hrown...    Args
-00003bb0: 3a0a 2020 2020 2020 2020 7061 7468 2028  :.        path (
-00003bc0: 5061 7468 4c69 6b65 293a 2074 6865 2066  PathLike): the f
-00003bd0: 696c 652e 0a0a 2020 2020 5261 6973 6573  ile...    Raises
-00003be0: 3a0a 2020 2020 2020 2020 5661 6c75 6545  :.        ValueE
-00003bf0: 7272 6f72 3a20 616e 2069 6e76 616c 6964  rror: an invalid
-00003c00: 2070 6172 616d 6574 6572 2076 616c 7565   parameter value
-00003c10: 2077 6173 2070 6173 7365 642e 0a0a 2020   was passed...  
-00003c20: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
-00003c30: 2020 2073 7472 3a20 7468 6520 6c61 7965     str: the laye
-00003c40: 7220 6e61 6d65 0a20 2020 2022 2222 0a20  r name.    """. 
-00003c50: 2020 2064 6174 6173 6f75 7263 6520 3d20     datasource = 
-00003c60: 4e6f 6e65 0a20 2020 2074 7279 3a0a 2020  None.    try:.  
-00003c70: 2020 2020 2020 6461 7461 736f 7572 6365        datasource
-00003c80: 5f6c 6179 6572 203d 204e 6f6e 650a 2020  _layer = None.  
-00003c90: 2020 2020 2020 6461 7461 736f 7572 6365        datasource
-00003ca0: 203d 2067 6461 6c2e 4f70 656e 4578 280a   = gdal.OpenEx(.
-00003cb0: 2020 2020 2020 2020 2020 2020 7374 7228              str(
-00003cc0: 7061 7468 292c 206e 4f70 656e 466c 6167  path), nOpenFlag
-00003cd0: 733d 6764 616c 2e4f 465f 5645 4354 4f52  s=gdal.OF_VECTOR
-00003ce0: 207c 2067 6461 6c2e 4f46 5f52 4541 444f   | gdal.OF_READO
-00003cf0: 4e4c 5920 7c20 6764 616c 2e4f 465f 5348  NLY | gdal.OF_SH
-00003d00: 4152 4544 0a20 2020 2020 2020 2029 0a20  ARED.        ). 
-00003d10: 2020 2020 2020 206e 625f 6c61 7965 7273         nb_layers
-00003d20: 203d 2064 6174 6173 6f75 7263 652e 4765   = datasource.Ge
-00003d30: 744c 6179 6572 436f 756e 7428 290a 2020  tLayerCount().  
-00003d40: 2020 2020 2020 6966 206e 625f 6c61 7965        if nb_laye
-00003d50: 7273 203d 3d20 313a 0a20 2020 2020 2020  rs == 1:.       
-00003d60: 2020 2020 2064 6174 6173 6f75 7263 655f       datasource_
-00003d70: 6c61 7965 7220 3d20 6461 7461 736f 7572  layer = datasour
-00003d80: 6365 2e47 6574 4c61 7965 7242 7949 6e64  ce.GetLayerByInd
-00003d90: 6578 2830 290a 2020 2020 2020 2020 656c  ex(0).        el
-00003da0: 6966 206e 625f 6c61 7965 7273 203d 3d20  if nb_layers == 
-00003db0: 303a 0a20 2020 2020 2020 2020 2020 2072  0:.            r
-00003dc0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-00003dd0: 6622 4572 726f 723a 204e 6f20 6c61 7965  f"Error: No laye
-00003de0: 7273 2066 6f75 6e64 2069 6e20 7b70 6174  rs found in {pat
-00003df0: 687d 2229 0a20 2020 2020 2020 2065 6c73  h}").        els
-00003e00: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
-00003e10: 2043 6865 636b 2069 6620 7468 6572 6520   Check if there 
-00003e20: 6973 206f 6e6c 7920 6f6e 6520 7370 6174  is only one spat
-00003e30: 6961 6c20 6c61 7965 720a 2020 2020 2020  ial layer.      
-00003e40: 2020 2020 2020 6c61 7965 7273 203d 206c        layers = l
-00003e50: 6973 746c 6179 6572 7328 7061 7468 2c20  istlayers(path, 
-00003e60: 6f6e 6c79 5f73 7061 7469 616c 5f6c 6179  only_spatial_lay
-00003e70: 6572 733d 5472 7565 290a 2020 2020 2020  ers=True).      
-00003e80: 2020 2020 2020 6966 206c 656e 286c 6179        if len(lay
-00003e90: 6572 7329 203d 3d20 313a 0a20 2020 2020  ers) == 1:.     
-00003ea0: 2020 2020 2020 2020 2020 2064 6174 6173             datas
-00003eb0: 6f75 7263 655f 6c61 7965 7220 3d20 6461  ource_layer = da
-00003ec0: 7461 736f 7572 6365 2e47 6574 4c61 7965  tasource.GetLaye
-00003ed0: 7228 6c61 7965 7273 5b30 5d29 0a20 2020  r(layers[0]).   
-00003ee0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00003ef0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00003f00: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-00003f10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003f20: 2020 2020 2066 2269 6e70 7574 2068 6173       f"input has
-00003f30: 203e 2031 206c 6179 6572 2c20 6275 7420   > 1 layer, but 
-00003f40: 6e6f 206c 6179 6572 2073 7065 6369 6669  no layer specifi
-00003f50: 6564 3a20 7b70 6174 687d 3a20 7b6c 6179  ed: {path}: {lay
-00003f60: 6572 737d 220a 2020 2020 2020 2020 2020  ers}".          
-00003f70: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-00003f80: 2072 6574 7572 6e20 6461 7461 736f 7572   return datasour
-00003f90: 6365 5f6c 6179 6572 2e47 6574 4e61 6d65  ce_layer.GetName
-00003fa0: 2829 0a0a 2020 2020 6578 6365 7074 2045  ()..    except E
-00003fb0: 7863 6570 7469 6f6e 2061 7320 6578 3a0a  xception as ex:.
-00003fc0: 2020 2020 2020 2020 6578 2e61 7267 7320          ex.args 
-00003fd0: 3d20 2866 2267 6574 5f6f 6e6c 795f 6c61  = (f"get_only_la
-00003fe0: 7965 7220 6572 726f 7220 666f 7220 7b70  yer error for {p
-00003ff0: 6174 687d 3a5c 6e20 207b 6578 7d22 2c29  ath}:\n  {ex}",)
-00004000: 0a20 2020 2020 2020 2072 6169 7365 0a20  .        raise. 
-00004010: 2020 2066 696e 616c 6c79 3a0a 2020 2020     finally:.    
-00004020: 2020 2020 6461 7461 736f 7572 6365 203d      datasource =
-00004030: 204e 6f6e 650a 0a0a 6465 6620 6765 745f   None...def get_
-00004040: 6465 6661 756c 745f 6c61 7965 7228 7061  default_layer(pa
-00004050: 7468 3a20 556e 696f 6e5b 7374 722c 2022  th: Union[str, "
-00004060: 6f73 2e50 6174 684c 696b 655b 416e 795d  os.PathLike[Any]
-00004070: 225d 2920 2d3e 2073 7472 3a0a 2020 2020  "]) -> str:.    
-00004080: 2222 220a 2020 2020 4765 7420 7468 6520  """.    Get the 
-00004090: 6465 6661 756c 7420 6c61 7965 7220 6e61  default layer na
-000040a0: 6d65 2074 6f20 6265 2075 7365 6420 666f  me to be used fo
-000040b0: 7220 6120 6c61 7965 7220 696e 2074 6869  r a layer in thi
-000040c0: 7320 6669 6c65 2e0a 0a20 2020 2054 6869  s file...    Thi
-000040d0: 7320 6973 2074 6865 2073 7465 6d20 6f66  s is the stem of
-000040e0: 2074 6865 2066 696c 6570 6174 682e 0a0a   the filepath...
-000040f0: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
-00004100: 2020 7061 7468 2028 556e 696f 6e5b 7374    path (Union[st
-00004110: 722c 293a 2054 6865 2070 6174 6820 746f  r,): The path to
-00004120: 2074 6865 2066 696c 652e 0a0a 2020 2020   the file...    
-00004130: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
-00004140: 2073 7472 3a20 5468 6520 6465 6661 756c   str: The defaul
-00004150: 7420 6c61 7965 7220 6e61 6d65 2e0a 2020  t layer name..  
-00004160: 2020 2222 220a 2020 2020 7265 7475 726e    """.    return
-00004170: 2050 6174 6828 7061 7468 292e 7374 656d   Path(path).stem
-00004180: 0a0a 0a64 6566 2065 7865 6375 7465 5f73  ...def execute_s
-00004190: 716c 280a 2020 2020 7061 7468 3a20 556e  ql(.    path: Un
-000041a0: 696f 6e5b 7374 722c 2022 6f73 2e50 6174  ion[str, "os.Pat
-000041b0: 684c 696b 655b 416e 795d 225d 2c0a 2020  hLike[Any]"],.  
-000041c0: 2020 7371 6c5f 7374 6d74 3a20 7374 722c    sql_stmt: str,
-000041d0: 0a20 2020 2073 716c 5f64 6961 6c65 6374  .    sql_dialect
-000041e0: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
-000041f0: 3d20 4e6f 6e65 2c0a 293a 0a20 2020 2022  = None,.):.    "
-00004200: 2222 0a20 2020 2045 7865 6375 7465 2061  "".    Execute a
-00004210: 2053 514c 2073 7461 7465 6d65 6e74 2028   SQL statement (
-00004220: 444d 4c20 6f72 2044 444c 2920 6f6e 2074  DML or DDL) on t
-00004230: 6865 2066 696c 652e 0a0a 2020 2020 546f  he file...    To
-00004240: 2072 756e 2053 454c 4543 5420 5351 4c20   run SELECT SQL 
-00004250: 7374 6174 656d 656e 7473 206f 6e20 6120  statements on a 
-00004260: 6669 6c65 2c20 7573 6520 3a6d 6574 683a  file, use :meth:
-00004270: 607e 7265 6164 5f66 696c 6560 2e0a 0a20  `~read_file`... 
-00004280: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-00004290: 2070 6174 6820 2850 6174 684c 696b 6529   path (PathLike)
-000042a0: 3a20 5468 6520 7061 7468 2074 6f20 7468  : The path to th
-000042b0: 6520 6669 6c65 2e0a 2020 2020 2020 2020  e file..        
-000042c0: 7371 6c5f 7374 6d74 2028 7374 7229 3a20  sql_stmt (str): 
-000042d0: 5468 6520 5351 4c20 7374 6174 656d 656e  The SQL statemen
-000042e0: 7420 746f 2065 7865 6375 7465 2e0a 2020  t to execute..  
-000042f0: 2020 2020 2020 7371 6c5f 6469 616c 6563        sql_dialec
-00004300: 7420 2873 7472 293a 2054 6865 2053 514c  t (str): The SQL
-00004310: 2064 6961 6c65 6374 2074 6f20 7573 653a   dialect to use:
-00004320: 0a20 2020 2020 2020 2020 2020 202a 204e  .            * N
-00004330: 6f6e 653a 2075 7365 2074 6865 206e 6174  one: use the nat
-00004340: 6976 6520 5351 4c20 6469 616c 6563 7420  ive SQL dialect 
-00004350: 6f66 2074 6865 2067 656f 6669 6c65 2e0a  of the geofile..
-00004360: 2020 2020 2020 2020 2020 2020 2a20 274f              * 'O
-00004370: 4752 5351 4c27 3a20 666f 7263 6520 7468  GRSQL': force th
-00004380: 6520 7573 6520 6f66 2074 6865 204f 4752  e use of the OGR
-00004390: 2053 514c 2064 6961 6c65 6374 2e0a 2020   SQL dialect..  
-000043a0: 2020 2020 2020 2020 2020 2a20 2753 514c            * 'SQL
-000043b0: 4954 4527 3a20 666f 7263 6520 7468 6520  ITE': force the 
-000043c0: 7573 6520 6f66 2074 6865 2053 514c 4954  use of the SQLIT
-000043d0: 4520 6469 616c 6563 742e 0a20 2020 2020  E dialect..     
-000043e0: 2020 2020 2020 2044 6566 6175 6c74 7320         Defaults 
-000043f0: 746f 204e 6f6e 652e 0a20 2020 2022 2222  to None..    """
-00004400: 0a20 2020 2064 6174 6173 6f75 7263 6520  .    datasource 
-00004410: 3d20 4e6f 6e65 0a20 2020 2074 7279 3a0a  = None.    try:.
-00004420: 2020 2020 2020 2020 6461 7461 736f 7572          datasour
-00004430: 6365 203d 2067 6461 6c2e 4f70 656e 4578  ce = gdal.OpenEx
-00004440: 2873 7472 2870 6174 6829 2c20 6e4f 7065  (str(path), nOpe
-00004450: 6e46 6c61 6773 3d67 6461 6c2e 4f46 5f55  nFlags=gdal.OF_U
-00004460: 5044 4154 4529 0a20 2020 2020 2020 2072  PDATE).        r
-00004470: 6573 756c 7420 3d20 6461 7461 736f 7572  esult = datasour
-00004480: 6365 2e45 7865 6375 7465 5351 4c28 7371  ce.ExecuteSQL(sq
-00004490: 6c5f 7374 6d74 2c20 6469 616c 6563 743d  l_stmt, dialect=
-000044a0: 7371 6c5f 6469 616c 6563 7429 0a20 2020  sql_dialect).   
-000044b0: 2020 2020 2064 6174 6173 6f75 7263 652e       datasource.
-000044c0: 5265 6c65 6173 6552 6573 756c 7453 6574  ReleaseResultSet
-000044d0: 2872 6573 756c 7429 0a0a 2020 2020 6578  (result)..    ex
-000044e0: 6365 7074 2045 7863 6570 7469 6f6e 2061  cept Exception a
-000044f0: 7320 6578 3a0a 2020 2020 2020 2020 6578  s ex:.        ex
-00004500: 2e61 7267 7320 3d20 2866 2265 7865 6375  .args = (f"execu
-00004510: 7465 5f73 716c 2065 7272 6f72 2066 6f72  te_sql error for
-00004520: 207b 7061 7468 7d5c 6e20 207b 6578 7d22   {path}\n  {ex}"
-00004530: 2c29 0a20 2020 2020 2020 2072 6169 7365  ,).        raise
-00004540: 0a20 2020 2066 696e 616c 6c79 3a0a 2020  .    finally:.  
-00004550: 2020 2020 2020 6461 7461 736f 7572 6365        datasource
-00004560: 203d 204e 6f6e 650a 0a0a 6465 6620 6372   = None...def cr
-00004570: 6561 7465 5f73 7061 7469 616c 5f69 6e64  eate_spatial_ind
-00004580: 6578 280a 2020 2020 7061 7468 3a20 556e  ex(.    path: Un
-00004590: 696f 6e5b 7374 722c 2022 6f73 2e50 6174  ion[str, "os.Pat
-000045a0: 684c 696b 655b 416e 795d 225d 2c0a 2020  hLike[Any]"],.  
-000045b0: 2020 6c61 7965 723a 204f 7074 696f 6e61    layer: Optiona
-000045c0: 6c5b 7374 725d 203d 204e 6f6e 652c 0a20  l[str] = None,. 
-000045d0: 2020 2063 6163 6865 5f73 697a 655f 6d62     cache_size_mb
-000045e0: 3a20 4f70 7469 6f6e 616c 5b69 6e74 5d20  : Optional[int] 
-000045f0: 3d20 3132 382c 0a20 2020 2065 7869 7374  = 128,.    exist
-00004600: 5f6f 6b3a 2062 6f6f 6c20 3d20 4661 6c73  _ok: bool = Fals
-00004610: 652c 0a20 2020 2066 6f72 6365 5f72 6562  e,.    force_reb
-00004620: 7569 6c64 3a20 626f 6f6c 203d 2046 616c  uild: bool = Fal
-00004630: 7365 2c0a 2020 2020 6e6f 5f67 656f 6d5f  se,.    no_geom_
-00004640: 6f6b 3a20 626f 6f6c 203d 2046 616c 7365  ok: bool = False
-00004650: 2c0a 293a 0a20 2020 2022 2222 0a20 2020  ,.):.    """.   
-00004660: 2043 7265 6174 6520 6120 7370 6174 6961   Create a spatia
-00004670: 6c20 696e 6465 7820 6f6e 2074 6865 206c  l index on the l
-00004680: 6179 6572 2073 7065 6369 6669 6564 2e0a  ayer specified..
-00004690: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
-000046a0: 2020 2070 6174 6820 2850 6174 684c 696b     path (PathLik
-000046b0: 6529 3a20 5468 6520 6669 6c65 2070 6174  e): The file pat
-000046c0: 682e 0a20 2020 2020 2020 206c 6179 6572  h..        layer
-000046d0: 2028 7374 722c 206f 7074 696f 6e61 6c29   (str, optional)
-000046e0: 3a20 5468 6520 6c61 7965 722e 2049 6620  : The layer. If 
-000046f0: 6e6f 7420 7370 6563 6966 6965 642c 2061  not specified, a
-00004700: 6e64 2074 6865 7265 2069 7320 6f6e 6c79  nd there is only
-00004710: 0a20 2020 2020 2020 2020 2020 206f 6e65  .            one
-00004720: 206c 6179 6572 2069 6e20 7468 6520 6669   layer in the fi
-00004730: 6c65 2c20 7468 6973 206c 6179 6572 2069  le, this layer i
-00004740: 7320 7573 6564 2e20 4f74 6865 7277 6973  s used. Otherwis
-00004750: 6520 6578 6365 7074 696f 6e2e 0a20 2020  e exception..   
-00004760: 2020 2020 2063 6163 6865 5f73 697a 655f       cache_size_
-00004770: 6d62 2028 696e 742c 206f 7074 696f 6e61  mb (int, optiona
-00004780: 6c29 3a20 6361 6368 6520 6d65 6d6f 7279  l): cache memory
-00004790: 2069 6e20 4d42 2074 6861 7420 6361 6e20   in MB that can 
-000047a0: 6265 2075 7365 6420 7768 696c 650a 2020  be used while.  
-000047b0: 2020 2020 2020 2020 2020 6372 6561 7469            creati
-000047c0: 6e67 2073 7061 7469 616c 2069 6e64 6578  ng spatial index
-000047d0: 2066 6f72 2073 7061 7469 616c 6974 6520   for spatialite 
-000047e0: 6669 6c65 7320 282e 6770 6b67 206f 7220  files (.gpkg or 
-000047f0: 2e73 716c 6974 6529 2e20 4966 204e 6f6e  .sqlite). If Non
-00004800: 652c 0a20 2020 2020 2020 2020 2020 2074  e,.            t
-00004810: 6865 2064 6566 6175 6c74 2063 6163 6865  he default cache
-00004820: 5f73 697a 6520 6672 6f6d 2073 716c 6974  _size from sqlit
-00004830: 6520 6973 2075 7365 642e 2044 6566 6175  e is used. Defau
-00004840: 6c74 7320 746f 2031 3238 2e0a 2020 2020  lts to 128..    
-00004850: 2020 2020 6578 6973 745f 6f6b 2028 626f      exist_ok (bo
-00004860: 6f6c 2c20 6f70 7469 6f6e 616c 293a 2049  ol, optional): I
-00004870: 6620 5472 7565 2061 6e64 2074 6865 2069  f True and the i
-00004880: 6e64 6578 2065 7869 7374 7320 616c 7265  ndex exists alre
-00004890: 6164 792c 2064 6f6e 2774 0a20 2020 2020  ady, don't.     
-000048a0: 2020 2020 2020 2074 6872 6f77 2061 6e20         throw an 
-000048b0: 6572 726f 722e 2044 6566 6175 6c74 7320  error. Defaults 
-000048c0: 746f 2046 616c 7365 2e0a 2020 2020 2020  to False..      
-000048d0: 2020 666f 7263 655f 7265 6275 696c 6420    force_rebuild 
-000048e0: 2862 6f6f 6c2c 206f 7074 696f 6e73 293a  (bool, options):
-000048f0: 2054 7275 6520 746f 2066 6f72 6365 2072   True to force r
-00004900: 6562 7569 6c64 2065 7665 6e20 6966 2069  ebuild even if i
-00004910: 6e64 6578 0a20 2020 2020 2020 2020 2020  ndex.           
-00004920: 2065 7869 7374 7320 616c 7265 6164 792e   exists already.
-00004930: 2044 6566 6175 6c74 7320 746f 2046 616c   Defaults to Fal
-00004940: 7365 2e0a 2020 2020 2020 2020 6e6f 5f67  se..        no_g
-00004950: 656f 6d5f 6f6b 2028 626f 6f6c 2c20 6f70  eom_ok (bool, op
-00004960: 7469 6f6e 7329 3a20 4966 2054 7275 6520  tions): If True 
-00004970: 616e 6420 7468 6520 6669 6c65 2064 6f65  and the file doe
-00004980: 736e 2774 2068 6176 6520 6120 6765 6f6d  sn't have a geom
-00004990: 6574 7279 2063 6f6c 756d 6e2c 0a20 2020  etry column,.   
-000049a0: 2020 2020 2020 2020 2064 6f6e 2774 2074           don't t
-000049b0: 6872 6f77 2061 6e20 6572 726f 722e 2044  hrow an error. D
-000049c0: 6566 6175 6c74 7320 746f 2046 616c 7365  efaults to False
-000049d0: 2e0a 2020 2020 2222 220a 2020 2020 2320  ..    """.    # 
-000049e0: 496e 6974 0a20 2020 2070 6174 6820 3d20  Init.    path = 
-000049f0: 5061 7468 2870 6174 6829 0a20 2020 2069  Path(path).    i
-00004a00: 6620 6c61 7965 7220 6973 204e 6f6e 653a  f layer is None:
-00004a10: 0a20 2020 2020 2020 206c 6179 6572 203d  .        layer =
-00004a20: 2067 6574 5f6f 6e6c 795f 6c61 7965 7228   get_only_layer(
-00004a30: 7061 7468 290a 0a20 2020 2023 2041 6464  path)..    # Add
-00004a40: 2069 6e64 6578 0a20 2020 2064 6174 6173   index.    datas
-00004a50: 6f75 7263 6520 3d20 4e6f 6e65 0a20 2020  ource = None.   
-00004a60: 2074 7279 3a0a 2020 2020 2020 2020 7061   try:.        pa
-00004a70: 7468 5f69 6e66 6f20 3d20 5f67 656f 6669  th_info = _geofi
-00004a80: 6c65 696e 666f 2e67 6574 5f67 656f 6669  leinfo.get_geofi
-00004a90: 6c65 696e 666f 2870 6174 6829 0a0a 2020  leinfo(path)..  
-00004aa0: 2020 2020 2020 6c61 7965 7269 6e66 6f20        layerinfo 
-00004ab0: 3d20 6765 745f 6c61 7965 7269 6e66 6f28  = get_layerinfo(
-00004ac0: 7061 7468 2c20 6c61 7965 722c 2072 6169  path, layer, rai
-00004ad0: 7365 5f6f 6e5f 6e6f 6765 6f6d 3d6e 6f74  se_on_nogeom=not
-00004ae0: 206e 6f5f 6765 6f6d 5f6f 6b29 0a20 2020   no_geom_ok).   
-00004af0: 2020 2020 2069 6620 6e6f 5f67 656f 6d5f       if no_geom_
-00004b00: 6f6b 2061 6e64 206c 6179 6572 696e 666f  ok and layerinfo
-00004b10: 2e67 656f 6d65 7472 7963 6f6c 756d 6e20  .geometrycolumn 
-00004b20: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-00004b30: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
-00004b40: 2020 2020 2023 2049 6620 696e 6465 7820       # If index 
-00004b50: 616c 7265 6164 7920 6578 6973 7473 2c20  already exists, 
-00004b60: 7265 6d6f 7665 2069 6e64 6578 206f 7220  remove index or 
-00004b70: 7265 7475 726e 0a20 2020 2020 2020 2069  return.        i
-00004b80: 6620 6861 735f 7370 6174 6961 6c5f 696e  f has_spatial_in
-00004b90: 6465 7828 7061 7468 2c20 6c61 7965 7229  dex(path, layer)
-00004ba0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00004bb0: 2066 6f72 6365 5f72 6562 7569 6c64 3a0a   force_rebuild:.
-00004bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004bd0: 7265 6d6f 7665 5f73 7061 7469 616c 5f69  remove_spatial_i
-00004be0: 6e64 6578 2870 6174 682c 206c 6179 6572  ndex(path, layer
-00004bf0: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
-00004c00: 6966 2065 7869 7374 5f6f 6b3a 0a20 2020  if exist_ok:.   
-00004c10: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-00004c20: 7572 6e0a 2020 2020 2020 2020 2020 2020  urn.            
-00004c30: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00004c40: 2020 2020 2020 7261 6973 6520 5275 6e74        raise Runt
-00004c50: 696d 6545 7272 6f72 2866 2273 7061 7469  imeError(f"spati
-00004c60: 616c 2069 6e64 6578 2065 7869 7374 7320  al index exists 
-00004c70: 616c 7265 6164 7920 6f6e 207b 7061 7468  already on {path
-00004c80: 7d2e 7b6c 6179 6572 7d22 290a 0a20 2020  }.{layer}")..   
-00004c90: 2020 2020 2069 6620 7061 7468 5f69 6e66       if path_inf
-00004ca0: 6f2e 6973 5f73 7061 7469 616c 6974 655f  o.is_spatialite_
-00004cb0: 6261 7365 643a 0a20 2020 2020 2020 2020  based:.         
-00004cc0: 2020 2023 2054 6865 2063 6f6e 6669 6720     # The config 
-00004cd0: 6f70 7469 6f6e 7320 6e65 6564 2074 6f20  options need to 
-00004ce0: 6265 2073 6574 2062 6566 6f72 6520 6f70  be set before op
-00004cf0: 656e 696e 6720 7468 6520 6669 6c65 210a  ening the file!.
-00004d00: 2020 2020 2020 2020 2020 2020 7769 7468              with
-00004d10: 205f 6f67 725f 7574 696c 2e73 6574 5f63   _ogr_util.set_c
-00004d20: 6f6e 6669 675f 6f70 7469 6f6e 7328 7b22  onfig_options({"
-00004d30: 4f47 525f 5351 4c49 5445 5f43 4143 4845  OGR_SQLITE_CACHE
-00004d40: 223a 2063 6163 6865 5f73 697a 655f 6d62  ": cache_size_mb
-00004d50: 7d29 3a0a 2020 2020 2020 2020 2020 2020  }):.            
-00004d60: 2020 2020 6461 7461 736f 7572 6365 203d      datasource =
-00004d70: 2067 6461 6c2e 4f70 656e 4578 2873 7472   gdal.OpenEx(str
-00004d80: 2870 6174 6829 2c20 6e4f 7065 6e46 6c61  (path), nOpenFla
-00004d90: 6773 3d67 6461 6c2e 4f46 5f55 5044 4154  gs=gdal.OF_UPDAT
-00004da0: 4529 0a20 2020 2020 2020 2020 2020 2020  E).             
-00004db0: 2020 2067 656f 6d65 7472 7963 6f6c 756d     geometrycolum
-00004dc0: 6e20 3d20 6c61 7965 7269 6e66 6f2e 6765  n = layerinfo.ge
-00004dd0: 6f6d 6574 7279 636f 6c75 6d6e 0a20 2020  ometrycolumn.   
-00004de0: 2020 2020 2020 2020 2020 2020 2073 716c               sql
-00004df0: 203d 2066 2253 454c 4543 5420 4372 6561   = f"SELECT Crea
-00004e00: 7465 5370 6174 6961 6c49 6e64 6578 2827  teSpatialIndex('
-00004e10: 7b6c 6179 6572 7d27 2c20 277b 6765 6f6d  {layer}', '{geom
-00004e20: 6574 7279 636f 6c75 6d6e 7d27 2922 0a20  etrycolumn}')". 
-00004e30: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00004e40: 6573 756c 7420 3d20 6461 7461 736f 7572  esult = datasour
-00004e50: 6365 2e45 7865 6375 7465 5351 4c28 7371  ce.ExecuteSQL(sq
-00004e60: 6c2c 2064 6961 6c65 6374 3d22 5351 4c49  l, dialect="SQLI
-00004e70: 5445 2229 0a20 2020 2020 2020 2020 2020  TE").           
-00004e80: 2020 2020 2064 6174 6173 6f75 7263 652e       datasource.
-00004e90: 5265 6c65 6173 6552 6573 756c 7453 6574  ReleaseResultSet
-00004ea0: 2872 6573 756c 7429 0a20 2020 2020 2020  (result).       
-00004eb0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00004ec0: 2020 2064 6174 6173 6f75 7263 6520 3d20     datasource = 
-00004ed0: 6764 616c 2e4f 7065 6e45 7828 7374 7228  gdal.OpenEx(str(
-00004ee0: 7061 7468 292c 206e 4f70 656e 466c 6167  path), nOpenFlag
-00004ef0: 733d 6764 616c 2e4f 465f 5550 4441 5445  s=gdal.OF_UPDATE
-00004f00: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-00004f10: 7375 6c74 203d 2064 6174 6173 6f75 7263  sult = datasourc
-00004f20: 652e 4578 6563 7574 6553 514c 2866 2743  e.ExecuteSQL(f'C
-00004f30: 5245 4154 4520 5350 4154 4941 4c20 494e  REATE SPATIAL IN
-00004f40: 4445 5820 4f4e 2022 7b6c 6179 6572 7d22  DEX ON "{layer}"
-00004f50: 2729 0a20 2020 2020 2020 2020 2020 2064  ').            d
-00004f60: 6174 6173 6f75 7263 652e 5265 6c65 6173  atasource.Releas
-00004f70: 6552 6573 756c 7453 6574 2872 6573 756c  eResultSet(resul
-00004f80: 7429 0a0a 2020 2020 6578 6365 7074 2045  t)..    except E
-00004f90: 7863 6570 7469 6f6e 2061 7320 6578 3a0a  xception as ex:.
-00004fa0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-00004fb0: 7461 6e63 6528 6578 2c20 5661 6c75 6545  tance(ex, ValueE
-00004fc0: 7272 6f72 2920 616e 6420 7374 7228 6578  rror) and str(ex
-00004fd0: 292e 7374 6172 7473 7769 7468 280a 2020  ).startswith(.  
-00004fe0: 2020 2020 2020 2020 2020 2268 6173 5f73            "has_s
-00004ff0: 7061 7469 616c 5f69 6e64 6578 206e 6f74  patial_index not
-00005000: 2073 7570 706f 7274 6564 2066 6f72 220a   supported for".
-00005010: 2020 2020 2020 2020 293a 0a20 2020 2020          ):.     
-00005020: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-00005030: 7565 4572 726f 7228 0a20 2020 2020 2020  ueError(.       
-00005040: 2020 2020 2020 2020 2066 2263 7265 6174           f"creat
-00005050: 655f 7370 6174 6961 6c5f 696e 6465 7820  e_spatial_index 
-00005060: 6e6f 7420 7375 7070 6f72 7465 6420 666f  not supported fo
-00005070: 7220 7b70 6174 685f 696e 666f 2e64 7269  r {path_info.dri
-00005080: 7665 727d 3a20 7b70 6174 687d 220a 2020  ver}: {path}".  
-00005090: 2020 2020 2020 2020 2020 2920 6672 6f6d            ) from
-000050a0: 2065 780a 2020 2020 2020 2020 656c 7365   ex.        else
-000050b0: 3a0a 2020 2020 2020 2020 2020 2020 6578  :.            ex
-000050c0: 2e61 7267 7320 3d20 2866 2263 7265 6174  .args = (f"creat
-000050d0: 655f 7370 6174 6961 6c5f 696e 6465 7820  e_spatial_index 
-000050e0: 6572 726f 723a 207b 6578 7d2c 2066 6f72  error: {ex}, for
-000050f0: 207b 7061 7468 7d2e 7b6c 6179 6572 7d22   {path}.{layer}"
-00005100: 2c29 0a20 2020 2020 2020 2072 6169 7365  ,).        raise
-00005110: 0a20 2020 2066 696e 616c 6c79 3a0a 2020  .    finally:.  
-00005120: 2020 2020 2020 6461 7461 736f 7572 6365        datasource
-00005130: 203d 204e 6f6e 650a 0a20 2020 2069 6620   = None..    if 
-00005140: 6e6f 7420 6861 735f 7370 6174 6961 6c5f  not has_spatial_
-00005150: 696e 6465 7828 7061 7468 2c20 6c61 7965  index(path, laye
-00005160: 7229 3a0a 2020 2020 2020 2020 7261 6973  r):.        rais
-00005170: 6520 5275 6e74 696d 6545 7272 6f72 2866  e RuntimeError(f
-00005180: 2263 7265 6174 655f 7370 6174 6961 6c5f  "create_spatial_
-00005190: 696e 6465 7820 6661 696c 6564 206f 6e20  index failed on 
-000051a0: 7b70 6174 687d 2c20 6c61 7965 723a 207b  {path}, layer: {
-000051b0: 6c61 7965 727d 2229 0a0a 0a64 6566 2068  layer}")...def h
-000051c0: 6173 5f73 7061 7469 616c 5f69 6e64 6578  as_spatial_index
-000051d0: 280a 2020 2020 7061 7468 3a20 556e 696f  (.    path: Unio
-000051e0: 6e5b 7374 722c 2022 6f73 2e50 6174 684c  n[str, "os.PathL
-000051f0: 696b 655b 416e 795d 225d 2c0a 2020 2020  ike[Any]"],.    
-00005200: 6c61 7965 723a 204f 7074 696f 6e61 6c5b  layer: Optional[
-00005210: 7374 725d 203d 204e 6f6e 652c 0a20 2020  str] = None,.   
-00005220: 206e 6f5f 6765 6f6d 5f6f 6b3a 2062 6f6f   no_geom_ok: boo
-00005230: 6c20 3d20 4661 6c73 652c 0a29 202d 3e20  l = False,.) -> 
-00005240: 626f 6f6c 3a0a 2020 2020 2222 220a 2020  bool:.    """.  
-00005250: 2020 4368 6563 6b20 6966 2074 6865 206c    Check if the l
-00005260: 6179 6572 2f63 6f6c 756d 6e20 6861 7320  ayer/column has 
-00005270: 6120 7370 6174 6961 6c20 696e 6465 782e  a spatial index.
-00005280: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
-00005290: 2020 2020 7061 7468 2028 5061 7468 4c69      path (PathLi
-000052a0: 6b65 293a 2054 6865 2066 696c 6520 7061  ke): The file pa
-000052b0: 7468 2e0a 2020 2020 2020 2020 6c61 7965  th..        laye
-000052c0: 7220 2873 7472 2c20 6f70 7469 6f6e 616c  r (str, optional
-000052d0: 293a 2054 6865 206c 6179 6572 2e20 4465  ): The layer. De
-000052e0: 6661 756c 7473 2074 6f20 4e6f 6e65 2e0a  faults to None..
-000052f0: 2020 2020 2020 2020 6e6f 5f67 656f 6d5f          no_geom_
-00005300: 6f6b 2028 626f 6f6c 2c20 6f70 7469 6f6e  ok (bool, option
-00005310: 7329 3a20 4966 2054 7275 6520 616e 6420  s): If True and 
-00005320: 7468 6520 6669 6c65 2064 6f65 736e 2774  the file doesn't
-00005330: 2068 6176 6520 6120 6765 6f6d 6574 7279   have a geometry
-00005340: 2063 6f6c 756d 6e2c 0a20 2020 2020 2020   column,.       
-00005350: 2020 2020 2064 6f6e 2774 2074 6872 6f77       don't throw
-00005360: 2061 6e20 6572 726f 722e 2044 6566 6175   an error. Defau
-00005370: 6c74 7320 746f 2046 616c 7365 2e0a 0a20  lts to False... 
-00005380: 2020 2052 6169 7365 733a 0a20 2020 2020     Raises:.     
-00005390: 2020 2056 616c 7565 4572 726f 723a 2061     ValueError: a
-000053a0: 6e20 696e 7661 6c69 6420 7061 7261 6d65  n invalid parame
-000053b0: 7465 7220 7661 6c75 6520 7761 7320 7061  ter value was pa
-000053c0: 7373 6564 2e0a 0a20 2020 2052 6574 7572  ssed...    Retur
-000053d0: 6e73 3a0a 2020 2020 2020 2020 626f 6f6c  ns:.        bool
-000053e0: 3a20 5472 7565 2069 6620 6120 7370 6174  : True if a spat
-000053f0: 6961 6c20 696e 6465 7820 6578 6973 7473  ial index exists
-00005400: 2c20 4661 6c73 6520 6966 2069 7420 646f  , False if it do
-00005410: 6573 6e27 7420 6578 6973 742e 0a20 2020  esn't exist..   
-00005420: 2022 2222 0a20 2020 2023 2049 6e69 740a   """.    # Init.
-00005430: 2020 2020 7061 7468 203d 2050 6174 6828      path = Path(
-00005440: 7061 7468 290a 0a20 2020 2023 204e 6f77  path)..    # Now
-00005450: 2063 6865 636b 2074 6865 2069 6e64 6578   check the index
-00005460: 0a20 2020 2064 6174 6173 6f75 7263 6520  .    datasource 
-00005470: 3d20 4e6f 6e65 0a20 2020 2070 6174 685f  = None.    path_
-00005480: 696e 666f 203d 205f 6765 6f66 696c 6569  info = _geofilei
-00005490: 6e66 6f2e 6765 745f 6765 6f66 696c 6569  nfo.get_geofilei
-000054a0: 6e66 6f28 7061 7468 290a 2020 2020 7472  nfo(path).    tr
-000054b0: 793a 0a20 2020 2020 2020 2069 6620 7061  y:.        if pa
-000054c0: 7468 5f69 6e66 6f2e 6973 5f73 7061 7469  th_info.is_spati
-000054d0: 616c 6974 655f 6261 7365 643a 0a20 2020  alite_based:.   
-000054e0: 2020 2020 2020 2020 206c 6179 6572 696e           layerin
-000054f0: 666f 203d 2067 6574 5f6c 6179 6572 696e  fo = get_layerin
-00005500: 666f 2870 6174 682c 206c 6179 6572 2c20  fo(path, layer, 
-00005510: 7261 6973 655f 6f6e 5f6e 6f67 656f 6d3d  raise_on_nogeom=
-00005520: 6e6f 7420 6e6f 5f67 656f 6d5f 6f6b 290a  not no_geom_ok).
-00005530: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-00005540: 6f5f 6765 6f6d 5f6f 6b20 616e 6420 6c61  o_geom_ok and la
-00005550: 7965 7269 6e66 6f2e 6765 6f6d 6574 7279  yerinfo.geometry
-00005560: 636f 6c75 6d6e 2069 7320 4e6f 6e65 3a0a  column is None:.
-00005570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005580: 7265 7475 726e 2046 616c 7365 0a20 2020  return False.   
-00005590: 2020 2020 2020 2020 2064 6174 6173 6f75           datasou
-000055a0: 7263 6520 3d20 6764 616c 2e4f 7065 6e45  rce = gdal.OpenE
-000055b0: 7828 7374 7228 7061 7468 292c 206e 4f70  x(str(path), nOp
-000055c0: 656e 466c 6167 733d 6764 616c 2e4f 465f  enFlags=gdal.OF_
-000055d0: 5245 4144 4f4e 4c59 290a 2020 2020 2020  READONLY).      
-000055e0: 2020 2020 2020 7371 6c20 3d20 6622 2222        sql = f"""
-000055f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005600: 2053 454c 4543 5420 4861 7353 7061 7469   SELECT HasSpati
-00005610: 616c 496e 6465 7828 277b 6c61 7965 7269  alIndex('{layeri
-00005620: 6e66 6f2e 6e61 6d65 7d27 2c0a 2020 2020  nfo.name}',.    
-00005630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005650: 2020 2027 7b6c 6179 6572 696e 666f 2e67     '{layerinfo.g
-00005660: 656f 6d65 7472 7963 6f6c 756d 6e7d 2729  eometrycolumn}')
-00005670: 0a20 2020 2020 2020 2020 2020 2022 2222  .            """
-00005680: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
-00005690: 756c 7420 3d20 6461 7461 736f 7572 6365  ult = datasource
-000056a0: 2e45 7865 6375 7465 5351 4c28 7371 6c2c  .ExecuteSQL(sql,
-000056b0: 2064 6961 6c65 6374 3d22 5351 4c49 5445   dialect="SQLITE
-000056c0: 2229 0a20 2020 2020 2020 2020 2020 2068  ").            h
-000056d0: 6173 5f73 7061 7469 616c 5f69 6e64 6578  as_spatial_index
-000056e0: 203d 2072 6573 756c 742e 4765 744e 6578   = result.GetNex
-000056f0: 7446 6561 7475 7265 2829 2e47 6574 4669  tFeature().GetFi
-00005700: 656c 6428 3029 203d 3d20 310a 2020 2020  eld(0) == 1.    
-00005710: 2020 2020 2020 2020 6461 7461 736f 7572          datasour
-00005720: 6365 2e52 656c 6561 7365 5265 7375 6c74  ce.ReleaseResult
-00005730: 5365 7428 7265 7375 6c74 290a 2020 2020  Set(result).    
-00005740: 2020 2020 2020 2020 7265 7475 726e 2068          return h
-00005750: 6173 5f73 7061 7469 616c 5f69 6e64 6578  as_spatial_index
-00005760: 0a20 2020 2020 2020 2065 6c69 6620 7061  .        elif pa
-00005770: 7468 5f69 6e66 6f2e 6472 6976 6572 203d  th_info.driver =
-00005780: 3d20 2245 5352 4920 5368 6170 6566 696c  = "ESRI Shapefil
-00005790: 6522 3a0a 2020 2020 2020 2020 2020 2020  e":.            
-000057a0: 696e 6465 785f 7061 7468 203d 2070 6174  index_path = pat
-000057b0: 682e 7061 7265 6e74 202f 2066 227b 7061  h.parent / f"{pa
-000057c0: 7468 2e73 7465 6d7d 2e71 6978 220a 2020  th.stem}.qix".  
-000057d0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-000057e0: 2069 6e64 6578 5f70 6174 682e 6578 6973   index_path.exis
-000057f0: 7473 2829 0a20 2020 2020 2020 2065 6c73  ts().        els
-00005800: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-00005810: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-00005820: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005830: 2066 2268 6173 5f73 7061 7469 616c 5f69   f"has_spatial_i
-00005840: 6e64 6578 206e 6f74 2073 7570 706f 7274  ndex not support
-00005850: 6564 2066 6f72 207b 7061 7468 5f69 6e66  ed for {path_inf
-00005860: 6f2e 6472 6976 6572 7d3a 207b 7061 7468  o.driver}: {path
-00005870: 7d22 0a20 2020 2020 2020 2020 2020 2029  }".            )
-00005880: 0a0a 2020 2020 6578 6365 7074 2056 616c  ..    except Val
-00005890: 7565 4572 726f 723a 0a20 2020 2020 2020  ueError:.       
-000058a0: 2072 6169 7365 0a20 2020 2065 7863 6570   raise.    excep
-000058b0: 7420 4578 6365 7074 696f 6e20 6173 2065  t Exception as e
-000058c0: 783a 0a20 2020 2020 2020 2065 782e 6172  x:.        ex.ar
-000058d0: 6773 203d 2028 6622 6861 735f 7370 6174  gs = (f"has_spat
-000058e0: 6961 6c5f 696e 6465 7820 6572 726f 723a  ial_index error:
-000058f0: 207b 6578 7d2c 2066 6f72 207b 7061 7468   {ex}, for {path
-00005900: 7d2e 7b6c 6179 6572 7d22 2c29 0a20 2020  }.{layer}",).   
-00005910: 2020 2020 2072 6169 7365 0a20 2020 2066       raise.    f
-00005920: 696e 616c 6c79 3a0a 2020 2020 2020 2020  inally:.        
-00005930: 6461 7461 736f 7572 6365 203d 204e 6f6e  datasource = Non
-00005940: 650a 0a0a 6465 6620 7265 6d6f 7665 5f73  e...def remove_s
-00005950: 7061 7469 616c 5f69 6e64 6578 280a 2020  patial_index(.  
-00005960: 2020 7061 7468 3a20 556e 696f 6e5b 7374    path: Union[st
-00005970: 722c 2022 6f73 2e50 6174 684c 696b 655b  r, "os.PathLike[
-00005980: 416e 795d 225d 2c20 6c61 7965 723a 204f  Any]"], layer: O
-00005990: 7074 696f 6e61 6c5b 7374 725d 203d 204e  ptional[str] = N
-000059a0: 6f6e 650a 293a 0a20 2020 2022 2222 0a20  one.):.    """. 
-000059b0: 2020 2052 656d 6f76 6520 7468 6520 7370     Remove the sp
-000059c0: 6174 6961 6c20 696e 6465 7820 6672 6f6d  atial index from
-000059d0: 2074 6865 206c 6179 6572 2073 7065 6369   the layer speci
-000059e0: 6669 6564 2e0a 0a20 2020 2041 7267 733a  fied...    Args:
-000059f0: 0a20 2020 2020 2020 2070 6174 6820 2850  .        path (P
-00005a00: 6174 684c 696b 6529 3a20 5468 6520 6669  athLike): The fi
-00005a10: 6c65 2070 6174 682e 0a20 2020 2020 2020  le path..       
-00005a20: 206c 6179 6572 2028 7374 722c 206f 7074   layer (str, opt
-00005a30: 696f 6e61 6c29 3a20 5468 6520 6c61 7965  ional): The laye
-00005a40: 722e 2049 6620 6e6f 7420 7370 6563 6966  r. If not specif
-00005a50: 6965 642c 2061 6e64 2074 6865 7265 2069  ied, and there i
-00005a60: 7320 6f6e 6c79 0a20 2020 2020 2020 2020  s only.         
-00005a70: 2020 206f 6e65 206c 6179 6572 2069 6e20     one layer in 
-00005a80: 7468 6520 6669 6c65 2c20 7468 6973 206c  the file, this l
-00005a90: 6179 6572 2069 7320 7573 6564 2e20 4f74  ayer is used. Ot
-00005aa0: 6865 7277 6973 6520 6578 6365 7074 696f  herwise exceptio
-00005ab0: 6e2e 0a20 2020 2022 2222 0a20 2020 2023  n..    """.    #
-00005ac0: 2049 6e69 740a 2020 2020 7061 7468 203d   Init.    path =
-00005ad0: 2050 6174 6828 7061 7468 290a 0a20 2020   Path(path)..   
-00005ae0: 2023 204e 6f77 2072 6561 6c6c 7920 7265   # Now really re
-00005af0: 6d6f 7665 2069 6e64 6578 0a20 2020 2064  move index.    d
-00005b00: 6174 6173 6f75 7263 6520 3d20 4e6f 6e65  atasource = None
-00005b10: 0a20 2020 2070 6174 685f 696e 666f 203d  .    path_info =
-00005b20: 205f 6765 6f66 696c 6569 6e66 6f2e 6765   _geofileinfo.ge
-00005b30: 745f 6765 6f66 696c 6569 6e66 6f28 7061  t_geofileinfo(pa
-00005b40: 7468 290a 2020 2020 7061 7468 5f6c 6179  th).    path_lay
-00005b50: 6572 696e 666f 203d 2067 6574 5f6c 6179  erinfo = get_lay
-00005b60: 6572 696e 666f 2870 6174 682c 206c 6179  erinfo(path, lay
-00005b70: 6572 290a 2020 2020 7472 793a 0a20 2020  er).    try:.   
-00005b80: 2020 2020 2069 6620 7061 7468 5f69 6e66       if path_inf
-00005b90: 6f2e 6973 5f73 7061 7469 616c 6974 655f  o.is_spatialite_
-00005ba0: 6261 7365 643a 0a20 2020 2020 2020 2020  based:.         
-00005bb0: 2020 2064 6174 6173 6f75 7263 6520 3d20     datasource = 
-00005bc0: 6764 616c 2e4f 7065 6e45 7828 7374 7228  gdal.OpenEx(str(
-00005bd0: 7061 7468 292c 206e 4f70 656e 466c 6167  path), nOpenFlag
-00005be0: 733d 6764 616c 2e4f 465f 5550 4441 5445  s=gdal.OF_UPDATE
-00005bf0: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-00005c00: 7375 6c74 203d 2064 6174 6173 6f75 7263  sult = datasourc
-00005c10: 652e 4578 6563 7574 6553 514c 280a 2020  e.ExecuteSQL(.  
-00005c20: 2020 2020 2020 2020 2020 2020 2020 2253                "S
-00005c30: 454c 4543 5420 4469 7361 626c 6553 7061  ELECT DisableSpa
-00005c40: 7469 616c 496e 6465 7828 220a 2020 2020  tialIndex(".    
-00005c50: 2020 2020 2020 2020 2020 2020 6622 2020              f"  
-00005c60: 2020 2020 277b 7061 7468 5f6c 6179 6572      '{path_layer
-00005c70: 696e 666f 2e6e 616d 657d 272c 2027 7b70  info.name}', '{p
-00005c80: 6174 685f 6c61 7965 7269 6e66 6f2e 6765  ath_layerinfo.ge
-00005c90: 6f6d 6574 7279 636f 6c75 6d6e 7d27 2922  ometrycolumn}')"
-00005ca0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00005cb0: 2020 6469 616c 6563 743d 2253 514c 4954    dialect="SQLIT
-00005cc0: 4522 2c0a 2020 2020 2020 2020 2020 2020  E",.            
-00005cd0: 290a 2020 2020 2020 2020 2020 2020 6461  ).            da
-00005ce0: 7461 736f 7572 6365 2e52 656c 6561 7365  tasource.Release
-00005cf0: 5265 7375 6c74 5365 7428 7265 7375 6c74  ResultSet(result
-00005d00: 290a 2020 2020 2020 2020 656c 6966 2070  ).        elif p
-00005d10: 6174 685f 696e 666f 2e64 7269 7665 7220  ath_info.driver 
-00005d20: 3d3d 2022 4553 5249 2053 6861 7065 6669  == "ESRI Shapefi
-00005d30: 6c65 223a 0a20 2020 2020 2020 2020 2020  le":.           
-00005d40: 2023 2044 524f 5020 5350 4154 4941 4c20   # DROP SPATIAL 
-00005d50: 494e 4445 5820 4f4e 202e 2e2e 2063 6f6d  INDEX ON ... com
-00005d60: 6d61 6e64 2067 6976 6573 2061 6e20 6572  mand gives an er
-00005d70: 726f 722c 2073 6f20 6a75 7374 2072 656d  ror, so just rem
-00005d80: 6f76 6520 2e71 6978 0a20 2020 2020 2020  ove .qix.       
-00005d90: 2020 2020 2069 6e64 6578 5f70 6174 6820       index_path 
-00005da0: 3d20 7061 7468 2e70 6172 656e 7420 2f20  = path.parent / 
-00005db0: 6622 7b70 6174 682e 7374 656d 7d2e 7169  f"{path.stem}.qi
-00005dc0: 7822 0a20 2020 2020 2020 2020 2020 2069  x".            i
-00005dd0: 6e64 6578 5f70 6174 682e 756e 6c69 6e6b  ndex_path.unlink
-00005de0: 2829 0a20 2020 2020 2020 2065 6c73 653a  ().        else:
-00005df0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-00005e00: 7365 2056 616c 7565 4572 726f 7228 0a20  se ValueError(. 
-00005e10: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00005e20: 2272 656d 6f76 655f 7370 6174 6961 6c5f  "remove_spatial_
-00005e30: 696e 6465 7820 6e6f 7420 7375 7070 6f72  index not suppor
-00005e40: 7465 6420 666f 7220 7b70 6174 685f 696e  ted for {path_in
-00005e50: 666f 2e64 7269 7665 727d 3a20 7b70 6174  fo.driver}: {pat
-00005e60: 687d 220a 2020 2020 2020 2020 2020 2020  h}".            
-00005e70: 290a 0a20 2020 2065 7863 6570 7420 5661  )..    except Va
-00005e80: 6c75 6545 7272 6f72 3a0a 2020 2020 2020  lueError:.      
-00005e90: 2020 7261 6973 650a 2020 2020 6578 6365    raise.    exce
-00005ea0: 7074 2045 7863 6570 7469 6f6e 2061 7320  pt Exception as 
-00005eb0: 6578 3a0a 2020 2020 2020 2020 6578 2e61  ex:.        ex.a
-00005ec0: 7267 7320 3d20 2866 2272 656d 6f76 655f  rgs = (f"remove_
-00005ed0: 7370 6174 6961 6c5f 696e 6465 7820 6572  spatial_index er
-00005ee0: 726f 723a 207b 6578 7d2c 2066 6f72 207b  ror: {ex}, for {
-00005ef0: 7061 7468 7d2e 7b6c 6179 6572 7d22 2c29  path}.{layer}",)
-00005f00: 0a20 2020 2020 2020 2072 6169 7365 0a20  .        raise. 
-00005f10: 2020 2066 696e 616c 6c79 3a0a 2020 2020     finally:.    
-00005f20: 2020 2020 6461 7461 736f 7572 6365 203d      datasource =
-00005f30: 204e 6f6e 650a 0a0a 6465 6620 7265 6e61   None...def rena
-00005f40: 6d65 5f6c 6179 6572 280a 2020 2020 7061  me_layer(.    pa
-00005f50: 7468 3a20 556e 696f 6e5b 7374 722c 2022  th: Union[str, "
-00005f60: 6f73 2e50 6174 684c 696b 655b 416e 795d  os.PathLike[Any]
-00005f70: 225d 2c20 6e65 775f 6c61 7965 723a 2073  "], new_layer: s
-00005f80: 7472 2c20 6c61 7965 723a 204f 7074 696f  tr, layer: Optio
-00005f90: 6e61 6c5b 7374 725d 203d 204e 6f6e 650a  nal[str] = None.
-00005fa0: 293a 0a20 2020 2022 2222 0a20 2020 2052  ):.    """.    R
-00005fb0: 656e 616d 6520 7468 6520 6c61 7965 7220  ename the layer 
-00005fc0: 7370 6563 6966 6965 642e 0a0a 2020 2020  specified...    
-00005fd0: 4172 6773 3a0a 2020 2020 2020 2020 7061  Args:.        pa
-00005fe0: 7468 2028 5061 7468 4c69 6b65 293a 2054  th (PathLike): T
-00005ff0: 6865 2066 696c 6520 7061 7468 2e0a 2020  he file path..  
-00006000: 2020 2020 2020 6c61 7965 7220 284f 7074        layer (Opt
-00006010: 696f 6e61 6c5b 7374 725d 293a 2054 6865  ional[str]): The
-00006020: 206c 6179 6572 206e 616d 652e 2049 6620   layer name. If 
-00006030: 6e6f 7420 7370 6563 6966 6965 642c 2061  not specified, a
-00006040: 6e64 2074 6865 7265 2069 7320 6f6e 6c79  nd there is only
-00006050: 0a20 2020 2020 2020 2020 2020 206f 6e65  .            one
-00006060: 206c 6179 6572 2069 6e20 7468 6520 6669   layer in the fi
-00006070: 6c65 2c20 7468 6973 206c 6179 6572 2069  le, this layer i
-00006080: 7320 7573 6564 2e20 4f74 6865 7277 6973  s used. Otherwis
-00006090: 6520 6578 6365 7074 696f 6e2e 0a20 2020  e exception..   
-000060a0: 2020 2020 206e 6577 5f6c 6179 6572 2028       new_layer (
-000060b0: 7374 7229 3a20 5468 6520 6e65 7720 6c61  str): The new la
-000060c0: 7965 7220 6e61 6d65 2e20 4966 206e 6f74  yer name. If not
-000060d0: 2073 7065 6369 6669 6564 2c20 616e 6420   specified, and 
-000060e0: 7468 6572 6520 6973 206f 6e6c 790a 2020  there is only.  
-000060f0: 2020 2020 2020 2020 2020 6f6e 6520 6c61            one la
-00006100: 7965 7220 696e 2074 6865 2066 696c 652c  yer in the file,
-00006110: 2074 6869 7320 6c61 7965 7220 6973 2075   this layer is u
-00006120: 7365 642e 204f 7468 6572 7769 7365 2065  sed. Otherwise e
-00006130: 7863 6570 7469 6f6e 2e0a 2020 2020 2222  xception..    ""
-00006140: 220a 2020 2020 2320 4368 6563 6b20 696e  ".    # Check in
-00006150: 7075 7420 7061 7261 6d65 7465 7273 0a20  put parameters. 
-00006160: 2020 2070 6174 6820 3d20 5061 7468 2870     path = Path(p
-00006170: 6174 6829 0a20 2020 2069 6620 6c61 7965  ath).    if laye
-00006180: 7220 6973 204e 6f6e 653a 0a20 2020 2020  r is None:.     
-00006190: 2020 206c 6179 6572 203d 2067 6574 5f6f     layer = get_o
-000061a0: 6e6c 795f 6c61 7965 7228 7061 7468 290a  nly_layer(path).
-000061b0: 0a20 2020 2023 2052 656e 616d 696e 6720  .    # Renaming 
-000061c0: 7468 6520 6c61 7965 7220 6e61 6d65 2069  the layer name i
-000061d0: 7320 6e6f 7420 706f 7373 6962 6c65 2066  s not possible f
-000061e0: 6f72 2073 696e 676c 6520 6c61 7965 7220  or single layer 
-000061f0: 6669 6c65 2066 6f72 6d61 7473 2e0a 2020  file formats..  
-00006200: 2020 7061 7468 5f69 6e66 6f20 3d20 5f67    path_info = _g
-00006210: 656f 6669 6c65 696e 666f 2e67 6574 5f67  eofileinfo.get_g
-00006220: 656f 6669 6c65 696e 666f 2870 6174 6829  eofileinfo(path)
-00006230: 0a20 2020 2069 6620 7061 7468 5f69 6e66  .    if path_inf
-00006240: 6f2e 6973 5f73 696e 676c 656c 6179 6572  o.is_singlelayer
-00006250: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
-00006260: 5661 6c75 6545 7272 6f72 2866 2272 656e  ValueError(f"ren
-00006270: 616d 655f 6c61 7965 7220 6e6f 7420 706f  ame_layer not po
-00006280: 7373 6962 6c65 2066 6f72 207b 7061 7468  ssible for {path
-00006290: 5f69 6e66 6f2e 6472 6976 6572 7d20 6669  _info.driver} fi
-000062a0: 6c65 2229 0a0a 2020 2020 2320 4e6f 7720  le")..    # Now 
-000062b0: 7265 616c 6c79 2072 656e 616d 650a 2020  really rename.  
-000062c0: 2020 6461 7461 736f 7572 6365 203d 204e    datasource = N
-000062d0: 6f6e 650a 2020 2020 7472 793a 0a20 2020  one.    try:.   
-000062e0: 2020 2020 2064 6174 6173 6f75 7263 6520       datasource 
-000062f0: 3d20 6764 616c 2e4f 7065 6e45 7828 7374  = gdal.OpenEx(st
-00006300: 7228 7061 7468 292c 206e 4f70 656e 466c  r(path), nOpenFl
-00006310: 6167 733d 6764 616c 2e4f 465f 5550 4441  ags=gdal.OF_UPDA
-00006320: 5445 290a 2020 2020 2020 2020 7371 6c5f  TE).        sql_
-00006330: 7374 6d74 203d 2066 2741 4c54 4552 2054  stmt = f'ALTER T
-00006340: 4142 4c45 2022 7b6c 6179 6572 7d22 2052  ABLE "{layer}" R
-00006350: 454e 414d 4520 544f 2022 7b6e 6577 5f6c  ENAME TO "{new_l
-00006360: 6179 6572 7d22 270a 2020 2020 2020 2020  ayer}"'.        
-00006370: 7265 7375 6c74 203d 2064 6174 6173 6f75  result = datasou
-00006380: 7263 652e 4578 6563 7574 6553 514c 2873  rce.ExecuteSQL(s
-00006390: 716c 5f73 746d 7429 0a20 2020 2020 2020  ql_stmt).       
-000063a0: 2064 6174 6173 6f75 7263 652e 5265 6c65   datasource.Rele
-000063b0: 6173 6552 6573 756c 7453 6574 2872 6573  aseResultSet(res
-000063c0: 756c 7429 0a20 2020 2065 7863 6570 7420  ult).    except 
-000063d0: 4578 6365 7074 696f 6e20 6173 2065 783a  Exception as ex:
-000063e0: 0a20 2020 2020 2020 2065 782e 6172 6773  .        ex.args
-000063f0: 203d 2028 6622 7265 6e61 6d65 5f6c 6179   = (f"rename_lay
-00006400: 6572 2065 7272 6f72 3a20 7b65 787d 2c20  er error: {ex}, 
-00006410: 666f 7220 7b70 6174 687d 2e7b 6c61 7965  for {path}.{laye
-00006420: 727d 222c 290a 2020 2020 2020 2020 7261  r}",).        ra
-00006430: 6973 650a 2020 2020 6669 6e61 6c6c 793a  ise.    finally:
-00006440: 0a20 2020 2020 2020 2064 6174 6173 6f75  .        datasou
-00006450: 7263 6520 3d20 4e6f 6e65 0a0a 0a64 6566  rce = None...def
-00006460: 2072 656e 616d 655f 636f 6c75 6d6e 280a   rename_column(.
-00006470: 2020 2020 7061 7468 3a20 556e 696f 6e5b      path: Union[
-00006480: 7374 722c 2022 6f73 2e50 6174 684c 696b  str, "os.PathLik
-00006490: 655b 416e 795d 225d 2c0a 2020 2020 636f  e[Any]"],.    co
-000064a0: 6c75 6d6e 5f6e 616d 653a 2073 7472 2c0a  lumn_name: str,.
-000064b0: 2020 2020 6e65 775f 636f 6c75 6d6e 5f6e      new_column_n
-000064c0: 616d 653a 2073 7472 2c0a 2020 2020 6c61  ame: str,.    la
-000064d0: 7965 723a 204f 7074 696f 6e61 6c5b 7374  yer: Optional[st
-000064e0: 725d 203d 204e 6f6e 652c 0a29 3a0a 2020  r] = None,.):.  
-000064f0: 2020 2222 220a 2020 2020 5265 6e61 6d65    """.    Rename
-00006500: 2074 6865 2063 6f6c 756d 6e20 7370 6563   the column spec
-00006510: 6966 6965 642e 0a0a 2020 2020 4172 6773  ified...    Args
-00006520: 3a0a 2020 2020 2020 2020 7061 7468 2028  :.        path (
-00006530: 5061 7468 4c69 6b65 293a 2074 6865 2066  PathLike): the f
-00006540: 696c 6520 7061 7468 2e0a 2020 2020 2020  ile path..      
-00006550: 2020 636f 6c75 6d6e 5f6e 616d 6520 2873    column_name (s
-00006560: 7472 293a 2063 7572 7265 6e74 2063 6f6c  tr): current col
-00006570: 756d 6e20 6e61 6d65 2e0a 2020 2020 2020  umn name..      
-00006580: 2020 6e65 775f 636f 6c75 6d6e 5f6e 616d    new_column_nam
-00006590: 6520 2873 7472 293a 206e 6577 2063 6f6c  e (str): new col
-000065a0: 756d 6e20 6e61 6d65 2e0a 2020 2020 2020  umn name..      
-000065b0: 2020 6c61 7965 7220 284f 7074 696f 6e61    layer (Optiona
-000065c0: 6c5b 7374 725d 293a 206c 6179 6572 206e  l[str]): layer n
-000065d0: 616d 652e 2049 6620 6e6f 7420 7370 6563  ame. If not spec
-000065e0: 6966 6965 642c 2061 6e64 2074 6865 7265  ified, and there
-000065f0: 2069 7320 6f6e 6c79 0a20 2020 2020 2020   is only.       
-00006600: 2020 2020 206f 6e65 206c 6179 6572 2069       one layer i
-00006610: 6e20 7468 6520 6669 6c65 2c20 7468 6973  n the file, this
-00006620: 206c 6179 6572 2069 7320 7573 6564 2e20   layer is used. 
-00006630: 4f74 6865 7277 6973 6520 6578 6365 7074  Otherwise except
-00006640: 696f 6e2e 0a20 2020 2022 2222 0a20 2020  ion..    """.   
-00006650: 2023 2043 6865 636b 2069 6e70 7574 2070   # Check input p
-00006660: 6172 616d 6574 6572 730a 2020 2020 7061  arameters.    pa
-00006670: 7468 203d 2050 6174 6828 7061 7468 290a  th = Path(path).
-00006680: 2020 2020 6966 206c 6179 6572 2069 7320      if layer is 
-00006690: 4e6f 6e65 3a0a 2020 2020 2020 2020 6c61  None:.        la
-000066a0: 7965 7220 3d20 6765 745f 6f6e 6c79 5f6c  yer = get_only_l
-000066b0: 6179 6572 2870 6174 6829 0a20 2020 2069  ayer(path).    i
-000066c0: 6e66 6f20 3d20 6765 745f 6c61 7965 7269  nfo = get_layeri
-000066d0: 6e66 6f28 7061 7468 2c20 6c61 7965 722c  nfo(path, layer,
-000066e0: 2072 6169 7365 5f6f 6e5f 6e6f 6765 6f6d   raise_on_nogeom
-000066f0: 3d46 616c 7365 290a 2020 2020 6966 2063  =False).    if c
-00006700: 6f6c 756d 6e5f 6e61 6d65 206e 6f74 2069  olumn_name not i
-00006710: 6e20 696e 666f 2e63 6f6c 756d 6e73 2061  n info.columns a
-00006720: 6e64 206e 6577 5f63 6f6c 756d 6e5f 6e61  nd new_column_na
-00006730: 6d65 2069 6e20 696e 666f 2e63 6f6c 756d  me in info.colum
-00006740: 6e73 3a0a 2020 2020 2020 2020 6c6f 6767  ns:.        logg
-00006750: 6572 2e69 6e66 6f28 0a20 2020 2020 2020  er.info(.       
-00006760: 2020 2020 2066 2243 6f6c 756d 6e20 7b63       f"Column {c
-00006770: 6f6c 756d 6e5f 6e61 6d65 7d20 7365 656d  olumn_name} seem
-00006780: 7320 746f 2062 6520 7265 6e61 6d65 6420  s to be renamed 
-00006790: 616c 7265 6164 7920 746f 207b 6e65 775f  already to {new_
-000067a0: 636f 6c75 6d6e 5f6e 616d 657d 220a 2020  column_name}".  
-000067b0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-000067c0: 7265 7475 726e 0a0a 2020 2020 2320 4e6f  return..    # No
-000067d0: 7720 7265 616c 6c79 2072 656e 616d 650a  w really rename.
-000067e0: 2020 2020 6461 7461 736f 7572 6365 203d      datasource =
-000067f0: 204e 6f6e 650a 2020 2020 7472 793a 0a20   None.    try:. 
-00006800: 2020 2020 2020 2064 6174 6173 6f75 7263         datasourc
-00006810: 6520 3d20 6764 616c 2e4f 7065 6e45 7828  e = gdal.OpenEx(
-00006820: 7374 7228 7061 7468 292c 206e 4f70 656e  str(path), nOpen
-00006830: 466c 6167 733d 6764 616c 2e4f 465f 5550  Flags=gdal.OF_UP
-00006840: 4441 5445 290a 2020 2020 2020 2020 6461  DATE).        da
-00006850: 7461 736f 7572 6365 5f6c 6179 6572 203d  tasource_layer =
-00006860: 2064 6174 6173 6f75 7263 652e 4765 744c   datasource.GetL
-00006870: 6179 6572 286c 6179 6572 290a 2020 2020  ayer(layer).    
-00006880: 2020 2020 6966 206e 6f74 2064 6174 6173      if not datas
-00006890: 6f75 7263 655f 6c61 7965 722e 5465 7374  ource_layer.Test
-000068a0: 4361 7061 6269 6c69 7479 2867 6461 6c2e  Capability(gdal.
-000068b0: 6f67 722e 4f4c 4341 6c74 6572 4669 656c  ogr.OLCAlterFiel
-000068c0: 6444 6566 6e29 3a0a 2020 2020 2020 2020  dDefn):.        
-000068d0: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
-000068e0: 7272 6f72 2866 2272 656e 616d 655f 636f  rror(f"rename_co
-000068f0: 6c75 6d6e 206e 6f74 2073 7570 706f 7274  lumn not support
-00006900: 6564 2066 6f72 207b 7061 7468 7d22 290a  ed for {path}").
-00006910: 0a20 2020 2020 2020 2023 2052 656e 616d  .        # Renam
-00006920: 6520 636f 6c75 6d6e 0a20 2020 2020 2020  e column.       
-00006930: 2073 716c 5f73 746d 7420 3d20 280a 2020   sql_stmt = (.  
-00006940: 2020 2020 2020 2020 2020 6627 414c 5445            f'ALTE
-00006950: 5220 5441 424c 4520 227b 6c61 7965 727d  R TABLE "{layer}
-00006960: 2220 270a 2020 2020 2020 2020 2020 2020  " '.            
-00006970: 6627 5245 4e41 4d45 2043 4f4c 554d 4e20  f'RENAME COLUMN 
-00006980: 227b 636f 6c75 6d6e 5f6e 616d 657d 2220  "{column_name}" 
-00006990: 544f 2022 7b6e 6577 5f63 6f6c 756d 6e5f  TO "{new_column_
-000069a0: 6e61 6d65 7d22 270a 2020 2020 2020 2020  name}"'.        
-000069b0: 290a 2020 2020 2020 2020 7265 7375 6c74  ).        result
-000069c0: 203d 2064 6174 6173 6f75 7263 652e 4578   = datasource.Ex
-000069d0: 6563 7574 6553 514c 2873 716c 5f73 746d  ecuteSQL(sql_stm
-000069e0: 7429 0a20 2020 2020 2020 2064 6174 6173  t).        datas
-000069f0: 6f75 7263 652e 5265 6c65 6173 6552 6573  ource.ReleaseRes
-00006a00: 756c 7453 6574 2872 6573 756c 7429 0a0a  ultSet(result)..
-00006a10: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
-00006a20: 7469 6f6e 2061 7320 6578 3a0a 2020 2020  tion as ex:.    
-00006a30: 2020 2020 2320 4966 2069 7420 6973 2074      # If it is t
-00006a40: 6865 2056 616c 7565 4572 726f 7220 7468  he ValueError th
-00006a50: 726f 776e 2061 626f 7665 2c20 6a75 7374  rown above, just
-00006a60: 2072 6169 7365 0a20 2020 2020 2020 2069   raise.        i
-00006a70: 6620 6973 696e 7374 616e 6365 2865 782c  f isinstance(ex,
-00006a80: 2056 616c 7565 4572 726f 7229 2061 6e64   ValueError) and
-00006a90: 2073 7472 2865 7829 2e73 7461 7274 7377   str(ex).startsw
-00006aa0: 6974 6828 0a20 2020 2020 2020 2020 2020  ith(.           
-00006ab0: 2022 7265 6e61 6d65 5f63 6f6c 756d 6e20   "rename_column 
-00006ac0: 6e6f 7420 7375 7070 6f72 7465 6420 666f  not supported fo
-00006ad0: 7222 0a20 2020 2020 2020 2029 3a0a 2020  r".        ):.  
-00006ae0: 2020 2020 2020 2020 2020 7261 6973 650a            raise.
-00006af0: 0a20 2020 2020 2020 2023 2049 7420 6973  .        # It is
-00006b00: 2061 6e6f 7468 6572 2065 7272 6f72 2e2e   another error..
-00006b10: 2e20 6164 6420 736f 6d65 206d 6f72 6520  . add some more 
-00006b20: 636f 6e74 6578 740a 2020 2020 2020 2020  context.        
-00006b30: 6578 2e61 7267 7320 3d20 2866 2272 656e  ex.args = (f"ren
-00006b40: 616d 655f 636f 6c75 6d6e 2065 7272 6f72  ame_column error
-00006b50: 3a20 7b65 787d 2066 6f72 207b 7061 7468  : {ex} for {path
-00006b60: 7d2e 7b6c 6179 6572 7d22 2c29 0a20 2020  }.{layer}",).   
-00006b70: 2020 2020 2072 6169 7365 0a20 2020 2066       raise.    f
-00006b80: 696e 616c 6c79 3a0a 2020 2020 2020 2020  inally:.        
-00006b90: 6461 7461 736f 7572 6365 203d 204e 6f6e  datasource = Non
-00006ba0: 650a 0a0a 636c 6173 7320 4461 7461 5479  e...class DataTy
-00006bb0: 7065 2865 6e75 6d2e 456e 756d 293a 0a20  pe(enum.Enum):. 
-00006bc0: 2020 2022 2222 0a20 2020 2054 6869 7320     """.    This 
-00006bd0: 656e 756d 2064 6566 696e 6573 2074 6865  enum defines the
-00006be0: 2073 7461 6e64 6172 6420 6461 7461 2074   standard data t
-00006bf0: 7970 6573 2074 6861 7420 6361 6e20 6265  ypes that can be
-00006c00: 2075 7365 6420 666f 7220 636f 6c75 6d6e   used for column
-00006c10: 732e 0a20 2020 2022 2222 0a0a 2020 2020  s..    """..    
-00006c20: 5445 5854 203d 2022 5445 5854 220a 2020  TEXT = "TEXT".  
-00006c30: 2020 2222 2243 6f6c 756d 6e20 7769 7468    """Column with
-00006c40: 2074 6578 7420 6461 7461 3a20 7e20 7374   text data: ~ st
-00006c50: 7269 6e67 2c20 6368 6172 2c20 7661 7263  ring, char, varc
-00006c60: 6861 722c 2063 6c6f 622e 2222 220a 2020  har, clob.""".  
-00006c70: 2020 494e 5445 4745 5220 3d20 2249 4e54    INTEGER = "INT
-00006c80: 4547 4552 220a 2020 2020 2222 2243 6f6c  EGER".    """Col
-00006c90: 756d 6e20 7769 7468 2069 6e74 6567 6572  umn with integer
-00006ca0: 2064 6174 612e 2222 220a 2020 2020 5245   data.""".    RE
-00006cb0: 414c 203d 2022 5245 414c 220a 2020 2020  AL = "REAL".    
-00006cc0: 2222 2243 6f6c 756d 6e20 7769 7468 2066  """Column with f
-00006cd0: 6c6f 6174 696e 6720 706f 696e 7420 6461  loating point da
-00006ce0: 7461 3a20 7e20 666c 6f61 742c 2064 6f75  ta: ~ float, dou
-00006cf0: 626c 652e 2222 220a 2020 2020 4441 5445  ble.""".    DATE
-00006d00: 203d 2022 4441 5445 220a 2020 2020 2222   = "DATE".    ""
-00006d10: 2243 6f6c 756d 6e20 7769 7468 2064 6174  "Column with dat
-00006d20: 6520 6461 7461 2e22 2222 0a20 2020 2054  e data.""".    T
-00006d30: 494d 4553 5441 4d50 203d 2022 5449 4d45  IMESTAMP = "TIME
-00006d40: 5354 414d 5022 0a20 2020 2022 2222 436f  STAMP".    """Co
-00006d50: 6c75 6d6e 2077 6974 6820 7469 6d65 7374  lumn with timest
-00006d60: 616d 7020 6461 7461 3a20 7e20 6461 7465  amp data: ~ date
-00006d70: 7469 6d65 2e22 2222 0a20 2020 2042 4f4f  time.""".    BOO
-00006d80: 4c45 414e 203d 2022 424f 4f4c 4541 4e22  LEAN = "BOOLEAN"
-00006d90: 0a20 2020 2022 2222 436f 6c75 6d6e 2077  .    """Column w
-00006da0: 6974 6820 626f 6f6c 6561 6e20 6461 7461  ith boolean data
-00006db0: 2e22 2222 0a20 2020 2042 4c4f 4220 3d20  .""".    BLOB = 
-00006dc0: 2242 4c4f 4222 0a20 2020 2022 2222 436f  "BLOB".    """Co
-00006dd0: 6c75 6d6e 2077 6974 6820 6269 6e61 7279  lumn with binary
-00006de0: 2064 6174 612e 2222 220a 2020 2020 4e55   data.""".    NU
-00006df0: 4d45 5249 4320 3d20 224e 554d 4552 4943  MERIC = "NUMERIC
-00006e00: 220a 2020 2020 2222 2243 6f6c 756d 6e20  ".    """Column 
-00006e10: 7769 7468 206e 756d 6572 6963 2064 6174  with numeric dat
-00006e20: 613a 2065 7861 6374 2064 6563 696d 616c  a: exact decimal
-00006e30: 2064 6174 612e 2222 220a 0a0a 6465 6620   data."""...def 
-00006e40: 6164 645f 636f 6c75 6d6e 280a 2020 2020  add_column(.    
-00006e50: 7061 7468 3a20 556e 696f 6e5b 7374 722c  path: Union[str,
-00006e60: 2022 6f73 2e50 6174 684c 696b 655b 416e   "os.PathLike[An
-00006e70: 795d 225d 2c0a 2020 2020 6e61 6d65 3a20  y]"],.    name: 
-00006e80: 7374 722c 0a20 2020 2074 7970 653a 2055  str,.    type: U
-00006e90: 6e69 6f6e 5b44 6174 6154 7970 652c 2073  nion[DataType, s
-00006ea0: 7472 5d2c 0a20 2020 2065 7870 7265 7373  tr],.    express
-00006eb0: 696f 6e3a 2055 6e69 6f6e 5b73 7472 2c20  ion: Union[str, 
-00006ec0: 666c 6f61 742c 204e 6f6e 655d 203d 204e  float, None] = N
-00006ed0: 6f6e 652c 0a20 2020 2065 7870 7265 7373  one,.    express
-00006ee0: 696f 6e5f 6469 616c 6563 743a 204f 7074  ion_dialect: Opt
-00006ef0: 696f 6e61 6c5b 7374 725d 203d 204e 6f6e  ional[str] = Non
-00006f00: 652c 0a20 2020 206c 6179 6572 3a20 4f70  e,.    layer: Op
-00006f10: 7469 6f6e 616c 5b73 7472 5d20 3d20 4e6f  tional[str] = No
-00006f20: 6e65 2c0a 2020 2020 666f 7263 655f 7570  ne,.    force_up
-00006f30: 6461 7465 3a20 626f 6f6c 203d 2046 616c  date: bool = Fal
-00006f40: 7365 2c0a 2020 2020 7769 6474 683a 204f  se,.    width: O
-00006f50: 7074 696f 6e61 6c5b 696e 745d 203d 204e  ptional[int] = N
-00006f60: 6f6e 652c 0a29 3a0a 2020 2020 2222 220a  one,.):.    """.
-00006f70: 2020 2020 4164 6420 6120 636f 6c75 6d6e      Add a column
-00006f80: 2074 6f20 6120 6c61 7965 7220 6f66 2074   to a layer of t
-00006f90: 6865 2067 656f 6669 6c65 2e0a 0a20 2020  he geofile...   
-00006fa0: 2041 7267 733a 0a20 2020 2020 2020 2070   Args:.        p
-00006fb0: 6174 6820 2850 6174 684c 696b 6529 3a20  ath (PathLike): 
-00006fc0: 5061 7468 2074 6f20 7468 6520 6765 6f66  Path to the geof
-00006fd0: 696c 652e 0a20 2020 2020 2020 206e 616d  ile..        nam
-00006fe0: 6520 2873 7472 293a 204e 616d 6520 666f  e (str): Name fo
-00006ff0: 7220 7468 6520 6e65 7720 636f 6c75 6d6e  r the new column
-00007000: 2e0a 2020 2020 2020 2020 7479 7065 2028  ..        type (
-00007010: 7374 7229 3a20 436f 6c75 6d6e 2074 7970  str): Column typ
-00007020: 6520 6f66 2074 6865 206e 6577 2063 6f6c  e of the new col
-00007030: 756d 6e2e 0a20 2020 2020 2020 2065 7870  umn..        exp
-00007040: 7265 7373 696f 6e20 2873 7472 2c20 6f70  ression (str, op
-00007050: 7469 6f6e 616c 293a 2053 514c 6974 6520  tional): SQLite 
-00007060: 6578 7072 6573 7369 6f6e 2074 6f20 7573  expression to us
-00007070: 6520 746f 2075 7064 6174 650a 2020 2020  e to update.    
-00007080: 2020 2020 2020 2020 7468 6520 7661 6c75          the valu
-00007090: 652e 2044 6566 6175 6c74 7320 746f 204e  e. Defaults to N
-000070a0: 6f6e 652e 0a20 2020 2020 2020 2065 7870  one..        exp
-000070b0: 7265 7373 696f 6e5f 6469 616c 6563 7420  ression_dialect 
-000070c0: 2873 7472 2c20 6f70 7469 6f6e 616c 293a  (str, optional):
-000070d0: 2053 514c 2064 6961 6c65 6374 2075 7365   SQL dialect use
-000070e0: 6420 666f 7220 7468 6520 6578 7072 6573  d for the expres
-000070f0: 7369 6f6e 2e0a 2020 2020 2020 2020 6c61  sion..        la
-00007100: 7965 7220 2873 7472 2c20 6f70 7469 6f6e  yer (str, option
-00007110: 616c 293a 2054 6865 206c 6179 6572 206e  al): The layer n
-00007120: 616d 652e 2049 6620 4e6f 6e65 2061 6e64  ame. If None and
-00007130: 2074 6865 2067 656f 6669 6c65 0a20 2020   the geofile.   
-00007140: 2020 2020 2020 2020 2068 6173 206f 6e6c           has onl
-00007150: 7920 6f6e 6520 6c61 7965 722c 2074 6861  y one layer, tha
-00007160: 7420 6c61 7965 7220 6973 2075 7365 642e  t layer is used.
-00007170: 2044 6566 6175 6c74 7320 746f 204e 6f6e   Defaults to Non
-00007180: 652e 0a20 2020 2020 2020 2066 6f72 6365  e..        force
-00007190: 5f75 7064 6174 6520 2862 6f6f 6c2c 206f  _update (bool, o
-000071a0: 7074 696f 6e61 6c29 3a20 4966 2074 6865  ptional): If the
-000071b0: 2063 6f6c 756d 6e20 616c 7265 6164 7920   column already 
-000071c0: 6578 6973 7473 2c20 6578 6563 7574 650a  exists, execute.
-000071d0: 2020 2020 2020 2020 2020 2020 7468 6520              the 
-000071e0: 7570 6461 7465 2061 6e79 7761 792e 2044  update anyway. D
-000071f0: 6566 6175 6c74 7320 746f 2046 616c 7365  efaults to False
-00007200: 2e0a 2020 2020 2020 2020 7769 6474 6820  ..        width 
-00007210: 2869 6e74 2c20 6f70 7469 6f6e 616c 293a  (int, optional):
-00007220: 2074 6865 2077 6964 7468 206f 6620 7468   the width of th
-00007230: 6520 6669 656c 642e 0a0a 2020 2020 5261  e field...    Ra
-00007240: 6973 6573 3a0a 2020 2020 2020 2020 6578  ises:.        ex
-00007250: 3a20 5b64 6573 6372 6970 7469 6f6e 5d0a  : [description].
-00007260: 2020 2020 2222 220a 2020 2020 2320 496e      """.    # In
-00007270: 6974 0a20 2020 2069 6620 6973 696e 7374  it.    if isinst
-00007280: 616e 6365 2874 7970 652c 2044 6174 6154  ance(type, DataT
-00007290: 7970 6529 3a0a 2020 2020 2020 2020 7479  ype):.        ty
-000072a0: 7065 5f73 7472 203d 2074 7970 652e 7661  pe_str = type.va
-000072b0: 6c75 650a 2020 2020 656c 7365 3a0a 2020  lue.    else:.  
-000072c0: 2020 2020 2020 7479 7065 5f6c 6f77 6572        type_lower
-000072d0: 203d 2074 7970 652e 6c6f 7765 7228 290a   = type.lower().
-000072e0: 2020 2020 2020 2020 6966 2074 7970 655f          if type_
-000072f0: 6c6f 7765 7220 3d3d 2022 7374 7269 6e67  lower == "string
-00007300: 223a 0a20 2020 2020 2020 2020 2020 2023  ":.            #
-00007310: 2054 4f44 4f3a 2074 6869 6e6b 2077 6865   TODO: think whe
-00007320: 7468 6572 2062 6569 6e67 2066 6c65 7869  ther being flexi
-00007330: 626c 6520 6865 7265 2069 7320 6120 676f  ble here is a go
-00007340: 6f64 2069 6465 612e 2e2e 0a20 2020 2020  od idea....     
-00007350: 2020 2020 2020 2074 7970 655f 7374 7220         type_str 
-00007360: 3d20 2254 4558 5422 0a20 2020 2020 2020  = "TEXT".       
-00007370: 2065 6c69 6620 7479 7065 5f6c 6f77 6572   elif type_lower
-00007380: 203d 3d20 2262 696e 6172 7922 3a0a 2020   == "binary":.  
-00007390: 2020 2020 2020 2020 2020 7479 7065 5f73            type_s
-000073a0: 7472 203d 2022 424c 4f42 220a 2020 2020  tr = "BLOB".    
-000073b0: 2020 2020 656c 6966 2074 7970 655f 6c6f      elif type_lo
-000073c0: 7765 7220 3d3d 2022 7469 6d65 223a 0a20  wer == "time":. 
-000073d0: 2020 2020 2020 2020 2020 2074 7970 655f             type_
-000073e0: 7374 7220 3d20 2244 4154 4554 494d 4522  str = "DATETIME"
-000073f0: 0a20 2020 2020 2020 2065 6c69 6620 7479  .        elif ty
-00007400: 7065 5f6c 6f77 6572 203d 3d20 2269 6e74  pe_lower == "int
-00007410: 6567 6572 3634 223a 0a20 2020 2020 2020  eger64":.       
-00007420: 2020 2020 2074 7970 655f 7374 7220 3d20       type_str = 
-00007430: 2249 4e54 4547 4552 220a 2020 2020 2020  "INTEGER".      
-00007440: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00007450: 2020 2020 7479 7065 5f73 7472 203d 2074      type_str = t
-00007460: 7970 650a 2020 2020 7061 7468 203d 2050  ype.    path = P
-00007470: 6174 6828 7061 7468 290a 2020 2020 6966  ath(path).    if
-00007480: 206c 6179 6572 2069 7320 4e6f 6e65 3a0a   layer is None:.
-00007490: 2020 2020 2020 2020 6c61 7965 7220 3d20          layer = 
-000074a0: 6765 745f 6f6e 6c79 5f6c 6179 6572 2870  get_only_layer(p
-000074b0: 6174 6829 0a20 2020 206c 6179 6572 696e  ath).    layerin
-000074c0: 666f 5f6f 7269 6720 3d20 6765 745f 6c61  fo_orig = get_la
-000074d0: 7965 7269 6e66 6f28 7061 7468 2c20 6c61  yerinfo(path, la
-000074e0: 7965 722c 2072 6169 7365 5f6f 6e5f 6e6f  yer, raise_on_no
-000074f0: 6765 6f6d 3d46 616c 7365 290a 0a20 2020  geom=False)..   
-00007500: 2023 2047 6f21 0a20 2020 2064 6174 6173   # Go!.    datas
-00007510: 6f75 7263 6520 3d20 4e6f 6e65 0a20 2020  ource = None.   
-00007520: 2074 7279 3a0a 2020 2020 2020 2020 2320   try:.        # 
-00007530: 4966 2063 6f6c 756d 6e20 646f 6573 6e27  If column doesn'
-00007540: 7420 6578 6973 7420 7965 742c 2063 7265  t exist yet, cre
-00007550: 6174 6520 6974 0a20 2020 2020 2020 2063  ate it.        c
-00007560: 6f6c 756d 6e73 5f75 7070 6572 203d 205b  olumns_upper = [
-00007570: 636f 6c75 6d6e 2e75 7070 6572 2829 2066  column.upper() f
-00007580: 6f72 2063 6f6c 756d 6e20 696e 206c 6179  or column in lay
-00007590: 6572 696e 666f 5f6f 7269 672e 636f 6c75  erinfo_orig.colu
-000075a0: 6d6e 735d 0a20 2020 2020 2020 2069 6620  mns].        if 
-000075b0: 6e61 6d65 2e75 7070 6572 2829 206e 6f74  name.upper() not
-000075c0: 2069 6e20 636f 6c75 6d6e 735f 7570 7065   in columns_uppe
-000075d0: 723a 0a20 2020 2020 2020 2020 2020 2077  r:.            w
-000075e0: 6964 7468 5f73 7472 203d 2066 2228 7b77  idth_str = f"({w
-000075f0: 6964 7468 7d29 2220 6966 2077 6964 7468  idth})" if width
-00007600: 2069 7320 6e6f 7420 4e6f 6e65 2065 6c73   is not None els
-00007610: 6520 2222 0a20 2020 2020 2020 2020 2020  e "".           
-00007620: 2073 716c 5f73 746d 7420 3d20 280a 2020   sql_stmt = (.  
-00007630: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-00007640: 414c 5445 5220 5441 424c 4520 227b 6c61  ALTER TABLE "{la
-00007650: 7965 727d 2220 4144 4420 434f 4c55 4d4e  yer}" ADD COLUMN
-00007660: 2022 7b6e 616d 657d 2220 7b74 7970 655f   "{name}" {type_
-00007670: 7374 727d 7b77 6964 7468 5f73 7472 7d27  str}{width_str}'
-00007680: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00007690: 2020 2020 2020 2020 2020 2064 6174 6173             datas
-000076a0: 6f75 7263 6520 3d20 6764 616c 2e4f 7065  ource = gdal.Ope
-000076b0: 6e45 7828 7374 7228 7061 7468 292c 206e  nEx(str(path), n
-000076c0: 4f70 656e 466c 6167 733d 6764 616c 2e4f  OpenFlags=gdal.O
-000076d0: 465f 5550 4441 5445 290a 2020 2020 2020  F_UPDATE).      
-000076e0: 2020 2020 2020 7265 7375 6c74 203d 2064        result = d
-000076f0: 6174 6173 6f75 7263 652e 4578 6563 7574  atasource.Execut
-00007700: 6553 514c 2873 716c 5f73 746d 7429 0a20  eSQL(sql_stmt). 
-00007710: 2020 2020 2020 2020 2020 2064 6174 6173             datas
-00007720: 6f75 7263 652e 5265 6c65 6173 6552 6573  ource.ReleaseRes
-00007730: 756c 7453 6574 2872 6573 756c 7429 0a20  ultSet(result). 
-00007740: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00007750: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-00007760: 7761 726e 696e 6728 6622 436f 6c75 6d6e  warning(f"Column
-00007770: 207b 6e61 6d65 7d20 6578 6973 7465 6420   {name} existed 
-00007780: 616c 7265 6164 7920 696e 207b 7061 7468  already in {path
-00007790: 7d2c 206c 6179 6572 207b 6c61 7965 727d  }, layer {layer}
-000077a0: 2229 0a0a 2020 2020 2020 2020 2320 4966  ")..        # If
-000077b0: 2061 6e20 6578 7072 6573 7369 6f6e 2077   an expression w
-000077c0: 6173 2070 726f 7669 6465 6420 616e 6420  as provided and 
-000077d0: 7570 6461 7465 2063 616e 2062 6520 646f  update can be do
-000077e0: 6e65 2c20 676f 2066 6f72 2069 742e 2e2e  ne, go for it...
-000077f0: 0a20 2020 2020 2020 2069 6620 6578 7072  .        if expr
-00007800: 6573 7369 6f6e 2069 7320 6e6f 7420 4e6f  ession is not No
-00007810: 6e65 2061 6e64 2028 0a20 2020 2020 2020  ne and (.       
-00007820: 2020 2020 206e 616d 6520 6e6f 7420 696e       name not in
-00007830: 206c 6179 6572 696e 666f 5f6f 7269 672e   layerinfo_orig.
-00007840: 636f 6c75 6d6e 7320 6f72 2066 6f72 6365  columns or force
-00007850: 5f75 7064 6174 6520 6973 2054 7275 650a  _update is True.
-00007860: 2020 2020 2020 2020 293a 0a20 2020 2020          ):.     
-00007870: 2020 2020 2020 2069 6620 6461 7461 736f         if dataso
-00007880: 7572 6365 2069 7320 4e6f 6e65 3a0a 2020  urce is None:.  
-00007890: 2020 2020 2020 2020 2020 2020 2020 6461                da
-000078a0: 7461 736f 7572 6365 203d 2067 6461 6c2e  tasource = gdal.
-000078b0: 4f70 656e 4578 2873 7472 2870 6174 6829  OpenEx(str(path)
-000078c0: 2c20 6e4f 7065 6e46 6c61 6773 3d67 6461  , nOpenFlags=gda
-000078d0: 6c2e 4f46 5f55 5044 4154 4529 0a20 2020  l.OF_UPDATE).   
-000078e0: 2020 2020 2020 2020 2073 716c 5f73 746d           sql_stm
-000078f0: 7420 3d20 6627 5550 4441 5445 2022 7b6c  t = f'UPDATE "{l
-00007900: 6179 6572 7d22 2053 4554 2022 7b6e 616d  ayer}" SET "{nam
-00007910: 657d 2220 3d20 7b65 7870 7265 7373 696f  e}" = {expressio
-00007920: 6e7d 270a 2020 2020 2020 2020 2020 2020  n}'.            
-00007930: 7265 7375 6c74 203d 2064 6174 6173 6f75  result = datasou
-00007940: 7263 652e 4578 6563 7574 6553 514c 2873  rce.ExecuteSQL(s
-00007950: 716c 5f73 746d 742c 2064 6961 6c65 6374  ql_stmt, dialect
-00007960: 3d65 7870 7265 7373 696f 6e5f 6469 616c  =expression_dial
-00007970: 6563 7429 0a20 2020 2020 2020 2020 2020  ect).           
-00007980: 2064 6174 6173 6f75 7263 652e 5265 6c65   datasource.Rele
-00007990: 6173 6552 6573 756c 7453 6574 2872 6573  aseResultSet(res
-000079a0: 756c 7429 0a0a 2020 2020 6578 6365 7074  ult)..    except
-000079b0: 2045 7863 6570 7469 6f6e 2061 7320 6578   Exception as ex
-000079c0: 3a0a 2020 2020 2020 2020 6578 2e61 7267  :.        ex.arg
-000079d0: 7320 3d20 2866 2261 6464 5f63 6f6c 756d  s = (f"add_colum
-000079e0: 6e20 6572 726f 7220 666f 7220 7b70 6174  n error for {pat
-000079f0: 687d 2e7b 6c61 7965 727d 3a5c 6e20 207b  h}.{layer}:\n  {
-00007a00: 6578 7d22 2c29 0a20 2020 2020 2020 2072  ex}",).        r
-00007a10: 6169 7365 0a20 2020 2066 696e 616c 6c79  aise.    finally
-00007a20: 3a0a 2020 2020 2020 2020 6461 7461 736f  :.        dataso
-00007a30: 7572 6365 203d 204e 6f6e 650a 0a0a 6465  urce = None...de
-00007a40: 6620 6472 6f70 5f63 6f6c 756d 6e28 0a20  f drop_column(. 
-00007a50: 2020 2070 6174 683a 2055 6e69 6f6e 5b73     path: Union[s
-00007a60: 7472 2c20 226f 732e 5061 7468 4c69 6b65  tr, "os.PathLike
-00007a70: 5b41 6e79 5d22 5d2c 2063 6f6c 756d 6e5f  [Any]"], column_
-00007a80: 6e61 6d65 3a20 7374 722c 206c 6179 6572  name: str, layer
-00007a90: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
-00007aa0: 3d20 4e6f 6e65 0a29 3a0a 2020 2020 2222  = None.):.    ""
-00007ab0: 220a 2020 2020 4472 6f70 2074 6865 2063  ".    Drop the c
-00007ac0: 6f6c 756d 6e20 7370 6563 6966 6965 642e  olumn specified.
-00007ad0: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
-00007ae0: 2020 2020 7061 7468 2028 5061 7468 4c69      path (PathLi
-00007af0: 6b65 293a 2054 6865 2066 696c 6520 7061  ke): The file pa
-00007b00: 7468 2e0a 2020 2020 2020 2020 636f 6c75  th..        colu
-00007b10: 6d6e 5f6e 616d 6520 2873 7472 293a 2074  mn_name (str): t
-00007b20: 6865 2063 6f6c 756d 6e20 6e61 6d65 2e0a  he column name..
-00007b30: 2020 2020 2020 2020 6c61 7965 7220 284f          layer (O
-00007b40: 7074 696f 6e61 6c5b 7374 725d 293a 2054  ptional[str]): T
-00007b50: 6865 206c 6179 6572 206e 616d 652e 2049  he layer name. I
-00007b60: 6620 6e6f 7420 7370 6563 6966 6965 642c  f not specified,
-00007b70: 2061 6e64 2074 6865 7265 2069 7320 6f6e   and there is on
-00007b80: 6c79 0a20 2020 2020 2020 2020 2020 206f  ly.            o
-00007b90: 6e65 206c 6179 6572 2069 6e20 7468 6520  ne layer in the 
-00007ba0: 6669 6c65 2c20 7468 6973 206c 6179 6572  file, this layer
-00007bb0: 2069 7320 7573 6564 2e20 4f74 6865 7277   is used. Otherw
-00007bc0: 6973 6520 6120 5661 6c75 6545 7272 6f72  ise a ValueError
-00007bd0: 2069 730a 2020 2020 2020 2020 2020 2020   is.            
-00007be0: 7261 6973 6564 2e0a 2020 2020 2222 220a  raised..    """.
-00007bf0: 2020 2020 2320 4368 6563 6b20 696e 7075      # Check inpu
-00007c00: 7420 7061 7261 6d65 7465 7273 0a20 2020  t parameters.   
-00007c10: 2070 6174 6820 3d20 5061 7468 2870 6174   path = Path(pat
-00007c20: 6829 0a20 2020 2069 6620 6c61 7965 7220  h).    if layer 
-00007c30: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-00007c40: 206c 6179 6572 203d 2067 6574 5f6f 6e6c   layer = get_onl
-00007c50: 795f 6c61 7965 7228 7061 7468 290a 2020  y_layer(path).  
-00007c60: 2020 696e 666f 203d 2067 6574 5f6c 6179    info = get_lay
-00007c70: 6572 696e 666f 2870 6174 682c 206c 6179  erinfo(path, lay
-00007c80: 6572 2c20 7261 6973 655f 6f6e 5f6e 6f67  er, raise_on_nog
-00007c90: 656f 6d3d 4661 6c73 6529 0a20 2020 2069  eom=False).    i
-00007ca0: 6620 636f 6c75 6d6e 5f6e 616d 6520 6e6f  f column_name no
-00007cb0: 7420 696e 2069 6e66 6f2e 636f 6c75 6d6e  t in info.column
-00007cc0: 733a 0a20 2020 2020 2020 206c 6f67 6765  s:.        logge
-00007cd0: 722e 696e 666f 2866 2243 6f6c 756d 6e20  r.info(f"Column 
-00007ce0: 7b63 6f6c 756d 6e5f 6e61 6d65 7d20 6e6f  {column_name} no
-00007cf0: 7420 7072 6573 656e 7420 736f 2063 616e  t present so can
-00007d00: 6e6f 7420 6265 2064 726f 7070 6564 2e22  not be dropped."
-00007d10: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-00007d20: 0a0a 2020 2020 2320 4e6f 7720 7265 616c  ..    # Now real
-00007d30: 6c79 2072 656e 616d 650a 2020 2020 6461  ly rename.    da
-00007d40: 7461 736f 7572 6365 203d 204e 6f6e 650a  tasource = None.
-00007d50: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00007d60: 2064 6174 6173 6f75 7263 6520 3d20 6764   datasource = gd
-00007d70: 616c 2e4f 7065 6e45 7828 7374 7228 7061  al.OpenEx(str(pa
-00007d80: 7468 292c 206e 4f70 656e 466c 6167 733d  th), nOpenFlags=
-00007d90: 6764 616c 2e4f 465f 5550 4441 5445 290a  gdal.OF_UPDATE).
-00007da0: 2020 2020 2020 2020 7371 6c5f 7374 6d74          sql_stmt
-00007db0: 203d 2066 2741 4c54 4552 2054 4142 4c45   = f'ALTER TABLE
-00007dc0: 2022 7b6c 6179 6572 7d22 2044 524f 5020   "{layer}" DROP 
-00007dd0: 434f 4c55 4d4e 2022 7b63 6f6c 756d 6e5f  COLUMN "{column_
-00007de0: 6e61 6d65 7d22 270a 2020 2020 2020 2020  name}"'.        
-00007df0: 7265 7375 6c74 203d 2064 6174 6173 6f75  result = datasou
-00007e00: 7263 652e 4578 6563 7574 6553 514c 2873  rce.ExecuteSQL(s
-00007e10: 716c 5f73 746d 7429 0a20 2020 2020 2020  ql_stmt).       
-00007e20: 2064 6174 6173 6f75 7263 652e 5265 6c65   datasource.Rele
-00007e30: 6173 6552 6573 756c 7453 6574 2872 6573  aseResultSet(res
-00007e40: 756c 7429 0a0a 2020 2020 6578 6365 7074  ult)..    except
-00007e50: 2045 7863 6570 7469 6f6e 2061 7320 6578   Exception as ex
-00007e60: 3a0a 2020 2020 2020 2020 6578 2e61 7267  :.        ex.arg
-00007e70: 7320 3d20 2866 2264 726f 705f 636f 6c75  s = (f"drop_colu
-00007e80: 6d6e 2065 7272 6f72 2066 6f72 207b 7061  mn error for {pa
-00007e90: 7468 7d2e 7b6c 6179 6572 7d3a 5c6e 2020  th}.{layer}:\n  
-00007ea0: 7b65 787d 222c 290a 2020 2020 2020 2020  {ex}",).        
-00007eb0: 7261 6973 650a 2020 2020 6669 6e61 6c6c  raise.    finall
-00007ec0: 793a 0a20 2020 2020 2020 2064 6174 6173  y:.        datas
-00007ed0: 6f75 7263 6520 3d20 4e6f 6e65 0a0a 0a64  ource = None...d
-00007ee0: 6566 2075 7064 6174 655f 636f 6c75 6d6e  ef update_column
-00007ef0: 280a 2020 2020 7061 7468 3a20 556e 696f  (.    path: Unio
-00007f00: 6e5b 7374 722c 2022 6f73 2e50 6174 684c  n[str, "os.PathL
-00007f10: 696b 655b 416e 795d 225d 2c0a 2020 2020  ike[Any]"],.    
-00007f20: 6e61 6d65 3a20 7374 722c 0a20 2020 2065  name: str,.    e
-00007f30: 7870 7265 7373 696f 6e3a 2073 7472 2c0a  xpression: str,.
-00007f40: 2020 2020 6c61 7965 723a 204f 7074 696f      layer: Optio
-00007f50: 6e61 6c5b 7374 725d 203d 204e 6f6e 652c  nal[str] = None,
-00007f60: 0a20 2020 2077 6865 7265 3a20 4f70 7469  .    where: Opti
-00007f70: 6f6e 616c 5b73 7472 5d20 3d20 4e6f 6e65  onal[str] = None
-00007f80: 2c0a 293a 0a20 2020 2022 2222 0a20 2020  ,.):.    """.   
-00007f90: 2055 7064 6174 6520 6120 636f 6c75 6d6e   Update a column
-00007fa0: 2066 726f 6d20 6120 6c61 7965 7220 6f66   from a layer of
-00007fb0: 2074 6865 2067 656f 6669 6c65 2e0a 0a20   the geofile... 
-00007fc0: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-00007fd0: 2070 6174 6820 2850 6174 684c 696b 6529   path (PathLike)
-00007fe0: 3a20 5061 7468 2074 6f20 7468 6520 6765  : Path to the ge
-00007ff0: 6f66 696c 650a 2020 2020 2020 2020 6e61  ofile.        na
-00008000: 6d65 2028 7374 7229 3a20 4e61 6d65 2066  me (str): Name f
-00008010: 6f72 2074 6865 206e 6577 2063 6f6c 756d  or the new colum
-00008020: 6e0a 2020 2020 2020 2020 6578 7072 6573  n.        expres
-00008030: 7369 6f6e 2028 7374 7229 3a20 5351 4c69  sion (str): SQLi
-00008040: 7465 2065 7870 7265 7373 696f 6e20 746f  te expression to
-00008050: 2075 7365 2074 6f20 7570 6461 7465 2074   use to update t
-00008060: 6865 2076 616c 7565 2e0a 2020 2020 2020  he value..      
-00008070: 2020 6c61 7965 7220 2873 7472 2c20 6f70    layer (str, op
-00008080: 7469 6f6e 616c 293a 2054 6865 206c 6179  tional): The lay
-00008090: 6572 206e 616d 652e 2049 6620 4e6f 6e65  er name. If None
-000080a0: 2061 6e64 2074 6865 2067 656f 6669 6c65   and the geofile
-000080b0: 0a20 2020 2020 2020 2020 2020 2068 6173  .            has
-000080c0: 206f 6e6c 7920 6f6e 6520 6c61 7965 722c   only one layer,
-000080d0: 2074 6861 7420 6c61 7965 7220 6973 2075   that layer is u
-000080e0: 7365 642e 2044 6566 6175 6c74 7320 746f  sed. Defaults to
-000080f0: 204e 6f6e 652e 0a20 2020 2020 2020 2077   None..        w
-00008100: 6865 7265 2028 7374 722c 206f 7074 696f  here (str, optio
-00008110: 6e61 6c29 3a20 5351 4c20 7768 6572 6520  nal): SQL where 
-00008120: 636c 6175 7365 2074 6f20 7265 7374 7269  clause to restri
-00008130: 6374 2074 6865 2072 6f77 7320 7468 6174  ct the rows that
-00008140: 2077 696c 6c0a 2020 2020 2020 2020 2020   will.          
-00008150: 2020 6265 2075 7064 6174 6564 2e20 4465    be updated. De
-00008160: 6661 756c 7473 2074 6f20 4e6f 6e65 2e0a  faults to None..
-00008170: 0a20 2020 2052 6169 7365 733a 0a20 2020  .    Raises:.   
-00008180: 2020 2020 2056 616c 7565 4572 726f 723a       ValueError:
-00008190: 2061 6e20 696e 7661 6c69 6420 7061 7261   an invalid para
-000081a0: 6d65 7465 7220 7661 6c75 6520 7761 7320  meter value was 
-000081b0: 7061 7373 6564 2e0a 2020 2020 2222 220a  passed..    """.
-000081c0: 2020 2020 2320 496e 6974 0a20 2020 2070      # Init.    p
-000081d0: 6174 6820 3d20 5061 7468 2870 6174 6829  ath = Path(path)
-000081e0: 0a20 2020 2069 6620 6c61 7965 7220 6973  .    if layer is
-000081f0: 204e 6f6e 653a 0a20 2020 2020 2020 206c   None:.        l
-00008200: 6179 6572 203d 2067 6574 5f6f 6e6c 795f  ayer = get_only_
-00008210: 6c61 7965 7228 7061 7468 290a 2020 2020  layer(path).    
-00008220: 6c61 7965 7269 6e66 6f5f 6f72 6967 203d  layerinfo_orig =
-00008230: 2067 6574 5f6c 6179 6572 696e 666f 2870   get_layerinfo(p
-00008240: 6174 682c 206c 6179 6572 290a 2020 2020  ath, layer).    
-00008250: 636f 6c75 6d6e 735f 7570 7065 7220 3d20  columns_upper = 
-00008260: 5b63 6f6c 756d 6e2e 7570 7065 7228 2920  [column.upper() 
-00008270: 666f 7220 636f 6c75 6d6e 2069 6e20 6c61  for column in la
-00008280: 7965 7269 6e66 6f5f 6f72 6967 2e63 6f6c  yerinfo_orig.col
-00008290: 756d 6e73 5d0a 2020 2020 6966 206c 6179  umns].    if lay
-000082a0: 6572 696e 666f 5f6f 7269 672e 6765 6f6d  erinfo_orig.geom
-000082b0: 6574 7279 636f 6c75 6d6e 2069 7320 6e6f  etrycolumn is no
-000082c0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-000082d0: 636f 6c75 6d6e 735f 7570 7065 722e 6170  columns_upper.ap
-000082e0: 7065 6e64 286c 6179 6572 696e 666f 5f6f  pend(layerinfo_o
-000082f0: 7269 672e 6765 6f6d 6574 7279 636f 6c75  rig.geometrycolu
-00008300: 6d6e 2e75 7070 6572 2829 290a 2020 2020  mn.upper()).    
-00008310: 6966 206e 616d 652e 7570 7065 7228 2920  if name.upper() 
-00008320: 6e6f 7420 696e 2063 6f6c 756d 6e73 5f75  not in columns_u
-00008330: 7070 6572 3a0a 2020 2020 2020 2020 2320  pper:.        # 
-00008340: 4966 2063 6f6c 756d 6e20 646f 6573 6e27  If column doesn'
-00008350: 7420 6578 6973 7420 7965 742c 2065 7272  t exist yet, err
-00008360: 6f72 210a 2020 2020 2020 2020 7261 6973  or!.        rais
-00008370: 6520 5661 6c75 6545 7272 6f72 2866 2243  e ValueError(f"C
-00008380: 6f6c 756d 6e20 7b6e 616d 657d 2064 6f65  olumn {name} doe
-00008390: 736e 2774 2065 7869 7374 2069 6e20 7b70  sn't exist in {p
-000083a0: 6174 687d 2c20 6c61 7965 7220 7b6c 6179  ath}, layer {lay
-000083b0: 6572 7d22 290a 0a20 2020 2023 2047 6f21  er}")..    # Go!
-000083c0: 0a20 2020 2064 6174 6173 6f75 7263 6520  .    datasource 
-000083d0: 3d20 4e6f 6e65 0a20 2020 2074 7279 3a0a  = None.    try:.
-000083e0: 2020 2020 2020 2020 6461 7461 736f 7572          datasour
-000083f0: 6365 203d 2067 6461 6c2e 4f70 656e 4578  ce = gdal.OpenEx
-00008400: 2873 7472 2870 6174 6829 2c20 6e4f 7065  (str(path), nOpe
-00008410: 6e46 6c61 6773 3d67 6461 6c2e 4f46 5f55  nFlags=gdal.OF_U
-00008420: 5044 4154 4529 0a20 2020 2020 2020 2073  PDATE).        s
-00008430: 716c 6974 655f 7374 6d74 203d 2066 2755  qlite_stmt = f'U
-00008440: 5044 4154 4520 227b 6c61 7965 727d 2220  PDATE "{layer}" 
-00008450: 5345 5420 227b 6e61 6d65 7d22 203d 207b  SET "{name}" = {
-00008460: 6578 7072 6573 7369 6f6e 7d27 0a20 2020  expression}'.   
-00008470: 2020 2020 2069 6620 7768 6572 6520 6973       if where is
-00008480: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-00008490: 2020 2020 2020 2073 716c 6974 655f 7374         sqlite_st
-000084a0: 6d74 202b 3d20 6622 5c6e 2057 4845 5245  mt += f"\n WHERE
-000084b0: 207b 7768 6572 657d 220a 2020 2020 2020   {where}".      
-000084c0: 2020 7265 7375 6c74 203d 2064 6174 6173    result = datas
-000084d0: 6f75 7263 652e 4578 6563 7574 6553 514c  ource.ExecuteSQL
-000084e0: 2873 716c 6974 655f 7374 6d74 2c20 6469  (sqlite_stmt, di
-000084f0: 616c 6563 743d 2253 514c 4954 4522 290a  alect="SQLITE").
-00008500: 2020 2020 2020 2020 6461 7461 736f 7572          datasour
-00008510: 6365 2e52 656c 6561 7365 5265 7375 6c74  ce.ReleaseResult
-00008520: 5365 7428 7265 7375 6c74 290a 0a20 2020  Set(result)..   
-00008530: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
-00008540: 6e20 6173 2065 783a 0a20 2020 2020 2020  n as ex:.       
-00008550: 2065 782e 6172 6773 203d 2028 6622 7570   ex.args = (f"up
-00008560: 6461 7465 5f63 6f6c 756d 6e20 6572 726f  date_column erro
-00008570: 7220 666f 7220 7b70 6174 687d 2e7b 6c61  r for {path}.{la
-00008580: 7965 727d 3a5c 6e20 207b 6578 7d22 2c29  yer}:\n  {ex}",)
-00008590: 0a20 2020 2020 2020 2072 6169 7365 0a20  .        raise. 
-000085a0: 2020 2066 696e 616c 6c79 3a0a 2020 2020     finally:.    
-000085b0: 2020 2020 6461 7461 736f 7572 6365 203d      datasource =
-000085c0: 204e 6f6e 650a 0a0a 6465 6620 7265 6164   None...def read
-000085d0: 5f66 696c 6528 0a20 2020 2070 6174 683a  _file(.    path:
-000085e0: 2055 6e69 6f6e 5b73 7472 2c20 226f 732e   Union[str, "os.
-000085f0: 5061 7468 4c69 6b65 5b41 6e79 5d22 5d2c  PathLike[Any]"],
-00008600: 0a20 2020 206c 6179 6572 3a20 4f70 7469  .    layer: Opti
-00008610: 6f6e 616c 5b73 7472 5d20 3d20 4e6f 6e65  onal[str] = None
-00008620: 2c0a 2020 2020 636f 6c75 6d6e 733a 204f  ,.    columns: O
-00008630: 7074 696f 6e61 6c5b 4974 6572 6162 6c65  ptional[Iterable
-00008640: 5b73 7472 5d5d 203d 204e 6f6e 652c 0a20  [str]] = None,. 
-00008650: 2020 2062 626f 783d 4e6f 6e65 2c0a 2020     bbox=None,.  
-00008660: 2020 726f 7773 3d4e 6f6e 652c 0a20 2020    rows=None,.   
-00008670: 2077 6865 7265 3a20 4f70 7469 6f6e 616c   where: Optional
-00008680: 5b73 7472 5d20 3d20 4e6f 6e65 2c0a 2020  [str] = None,.  
-00008690: 2020 7371 6c5f 7374 6d74 3a20 4f70 7469    sql_stmt: Opti
-000086a0: 6f6e 616c 5b73 7472 5d20 3d20 4e6f 6e65  onal[str] = None
-000086b0: 2c0a 2020 2020 7371 6c5f 6469 616c 6563  ,.    sql_dialec
-000086c0: 743a 204f 7074 696f 6e61 6c5b 4c69 7465  t: Optional[Lite
-000086d0: 7261 6c5b 2253 514c 4954 4522 2c20 224f  ral["SQLITE", "O
-000086e0: 4752 5351 4c22 5d5d 203d 204e 6f6e 652c  GRSQL"]] = None,
-000086f0: 0a20 2020 2069 676e 6f72 655f 6765 6f6d  .    ignore_geom
-00008700: 6574 7279 3a20 626f 6f6c 203d 2046 616c  etry: bool = Fal
-00008710: 7365 2c0a 2020 2020 6669 645f 6173 5f69  se,.    fid_as_i
-00008720: 6e64 6578 3a20 626f 6f6c 203d 2046 616c  ndex: bool = Fal
-00008730: 7365 2c0a 2920 2d3e 2067 7064 2e47 656f  se,.) -> gpd.Geo
-00008740: 4461 7461 4672 616d 653a 0a20 2020 2022  DataFrame:.    "
-00008750: 2222 0a20 2020 2052 6561 6473 2061 2066  "".    Reads a f
-00008760: 696c 6520 746f 2061 2067 656f 7061 6e64  ile to a geopand
-00008770: 6173 2047 656f 4461 7461 6672 616d 652e  as GeoDataframe.
-00008780: 0a0a 2020 2020 5468 6520 6669 6c65 2066  ..    The file f
-00008790: 6f72 6d61 7420 6973 2064 6574 6563 7465  ormat is detecte
-000087a0: 6420 6261 7365 6420 6f6e 2074 6865 2066  d based on the f
-000087b0: 696c 6570 6174 6820 6578 7465 6e73 696f  ilepath extensio
-000087c0: 6e2e 0a0a 2020 2020 4966 2060 6073 716c  n...    If ``sql
-000087d0: 5f73 746d 7460 6020 6973 2073 7065 6369  _stmt`` is speci
-000087e0: 6669 6564 2c20 7468 6520 7371 6c69 7465  fied, the sqlite
-000087f0: 2071 7565 7279 2063 616e 2063 6f6e 7461   query can conta
-00008800: 696e 2066 6f6c 6c6f 7769 6e67 2070 6c61  in following pla
-00008810: 6365 686f 6c64 6572 730a 2020 2020 7468  ceholders.    th
-00008820: 6174 2077 696c 6c20 6265 2061 7574 6f6d  at will be autom
-00008830: 6174 6963 616c 6c79 2072 6570 6c61 6365  atically replace
-00008840: 6420 666f 7220 796f 753a 0a0a 2020 2020  d for you:..    
-00008850: 2020 2a20 7b67 656f 6d65 7472 7963 6f6c    * {geometrycol
-00008860: 756d 6e7d 3a20 7468 6520 636f 6c75 6d6e  umn}: the column
-00008870: 2077 6865 7265 2074 6865 2070 7269 6d61   where the prima
-00008880: 7279 2067 656f 6d65 7472 7920 6973 2073  ry geometry is s
-00008890: 746f 7265 642e 0a20 2020 2020 202a 207b  tored..      * {
-000088a0: 636f 6c75 6d6e 735f 746f 5f73 656c 6563  columns_to_selec
-000088b0: 745f 7374 727d 3a20 6966 2060 6063 6f6c  t_str}: if ``col
-000088c0: 756d 6e73 6060 2069 7320 6e6f 7420 4e6f  umns`` is not No
-000088d0: 6e65 2c20 7468 6f73 6520 636f 6c75 6d6e  ne, those column
-000088e0: 732c 0a20 2020 2020 2020 206f 7468 6572  s,.        other
-000088f0: 7769 7365 2061 6c6c 2063 6f6c 756d 6e73  wise all columns
-00008900: 206f 6620 7468 6520 6c61 7965 722e 0a20   of the layer.. 
-00008910: 2020 2020 202a 207b 696e 7075 745f 6c61       * {input_la
-00008920: 7965 727d 3a20 7468 6520 6c61 7965 7220  yer}: the layer 
-00008930: 6e61 6d65 206f 6620 7468 6520 696e 7075  name of the inpu
-00008940: 7420 6c61 7965 722e 0a0a 2020 2020 4578  t layer...    Ex
-00008950: 616d 706c 6520 5351 4c20 7374 6174 656d  ample SQL statem
-00008960: 656e 7420 7769 7468 2070 6c61 6365 686f  ent with placeho
-00008970: 6c64 6572 733a 0a20 2020 203a 3a0a 0a20  lders:.    ::.. 
-00008980: 2020 2020 2020 2053 454c 4543 5420 7b67         SELECT {g
-00008990: 656f 6d65 7472 7963 6f6c 756d 6e7d 0a20  eometrycolumn}. 
-000089a0: 2020 2020 2020 2020 2020 2020 207b 636f               {co
-000089b0: 6c75 6d6e 735f 746f 5f73 656c 6563 745f  lumns_to_select_
-000089c0: 7374 727d 0a20 2020 2020 2020 2020 2046  str}.          F
-000089d0: 524f 4d20 227b 696e 7075 745f 6c61 7965  ROM "{input_laye
-000089e0: 727d 2220 6c61 7965 720a 0a20 2020 2054  r}" layer..    T
-000089f0: 6865 2075 6e64 6572 6c79 696e 6720 6c69  he underlying li
-00008a00: 6272 6172 7920 7573 6564 2074 6f20 7265  brary used to re
-00008a10: 6164 2074 6865 2066 696c 6520 6361 6e20  ad the file can 
-00008a20: 6265 2063 686f 6f73 656e 2075 7369 6e67  be choosen using
-00008a30: 2074 6865 0a20 2020 2022 4746 4f5f 494f   the.    "GFO_IO
-00008a40: 5f45 4e47 494e 4522 2065 6e76 6972 6f6e  _ENGINE" environ
-00008a50: 6d65 6e74 2076 6172 6961 626c 652e 2050  ment variable. P
-00008a60: 6f73 7369 626c 6520 7661 6c75 6573 2061  ossible values a
-00008a70: 7265 2022 6669 6f6e 6122 2061 6e64 2022  re "fiona" and "
-00008a80: 7079 6f67 7269 6f22 2e0a 2020 2020 5468  pyogrio"..    Th
-00008a90: 6973 206f 7074 696f 6e20 6973 2063 7265  is option is cre
-00008aa0: 6174 6564 2061 7320 6120 7465 6d70 6f72  ated as a tempor
-00008ab0: 6172 7920 6661 6c6c 6261 636b 2074 6f20  ary fallback to 
-00008ac0: 2266 696f 6e61 2220 666f 7220 6361 7365  "fiona" for case
-00008ad0: 7320 7768 6572 6520 2270 796f 6772 696f  s where "pyogrio
-00008ae0: 220a 2020 2020 6769 7665 7320 6973 7375  ".    gives issu
-00008af0: 6573 2c20 736f 2070 6c65 6173 6520 7265  es, so please re
-00008b00: 706f 7274 2069 7373 7565 7320 6966 2074  port issues if t
-00008b10: 6865 7920 6172 6520 656e 636f 756e 7465  hey are encounte
-00008b20: 7265 642e 2049 6e20 7468 6520 6675 7475  red. In the futu
-00008b30: 7265 2073 7570 706f 7274 0a20 2020 2066  re support.    f
-00008b40: 6f72 2074 6865 2022 6669 6f6e 6122 2065  or the "fiona" e
-00008b50: 6e67 696e 6520 6d6f 7374 206c 696b 656c  ngine most likel
-00008b60: 7920 7769 6c6c 2062 6520 7265 6d6f 7665  y will be remove
-00008b70: 642e 2044 6566 6175 6c74 2065 6e67 696e  d. Default engin
-00008b80: 6520 6973 2022 7079 6f67 7269 6f22 2e0a  e is "pyogrio"..
-00008b90: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
-00008ba0: 2020 2070 6174 6820 2866 696c 6520 7061     path (file pa
-00008bb0: 7468 293a 2070 6174 6820 746f 2074 6865  th): path to the
-00008bc0: 2066 696c 6520 746f 2072 6561 6420 6672   file to read fr
-00008bd0: 6f6d 0a20 2020 2020 2020 206c 6179 6572  om.        layer
-00008be0: 2028 7374 722c 206f 7074 696f 6e61 6c29   (str, optional)
-00008bf0: 3a20 5468 6520 6c61 7965 7220 746f 2072  : The layer to r
-00008c00: 6561 642e 2049 6620 4e6f 6e65 2061 6e64  ead. If None and
-00008c10: 2074 6865 7265 2069 7320 6f6e 6c79 206f   there is only o
-00008c20: 6e65 206c 6179 6572 2069 6e0a 2020 2020  ne layer in.    
-00008c30: 2020 2020 2020 2020 7468 6520 6669 6c65          the file
-00008c40: 2069 7420 6973 2072 6561 642c 206f 7468   it is read, oth
-00008c50: 6572 7769 7365 2061 6e20 6572 726f 7220  erwise an error 
-00008c60: 6973 2074 6872 6f77 6e2e 2044 6566 6175  is thrown. Defau
-00008c70: 6c74 7320 746f 204e 6f6e 652e 0a20 2020  lts to None..   
-00008c80: 2020 2020 2063 6f6c 756d 6e73 2028 4974       columns (It
-00008c90: 6572 6162 6c65 5b73 7472 5d2c 206f 7074  erable[str], opt
-00008ca0: 696f 6e61 6c29 3a20 5468 6520 286e 6f6e  ional): The (non
-00008cb0: 2d67 656f 6d65 7472 7929 2063 6f6c 756d  -geometry) colum
-00008cc0: 6e73 2074 6f20 7265 6164 2077 696c 6c0a  ns to read will.
-00008cd0: 2020 2020 2020 2020 2020 2020 6265 2072              be r
-00008ce0: 6574 7572 6e65 6420 696e 2074 6865 206f  eturned in the o
-00008cf0: 7264 6572 2073 7065 6369 6669 6564 2e20  rder specified. 
-00008d00: 4966 204e 6f6e 652c 2061 6c6c 2073 7461  If None, all sta
-00008d10: 6e64 6172 6420 636f 6c75 6d6e 7320 6172  ndard columns ar
-00008d20: 6520 7265 6164 2e0a 2020 2020 2020 2020  e read..        
-00008d30: 2020 2020 496e 2061 6464 6974 696f 6e20      In addition 
-00008d40: 746f 2073 7461 6e64 6172 6420 636f 6c75  to standard colu
-00008d50: 6d6e 732c 2069 7420 6973 2061 6c73 6f20  mns, it is also 
-00008d60: 706f 7373 6962 6c65 0a20 2020 2020 2020  possible.       
-00008d70: 2020 2020 2074 6f20 7370 6563 6966 7920       to specify 
-00008d80: 2266 6964 222c 2061 2075 6e69 7175 6520  "fid", a unique 
-00008d90: 696e 6465 7820 6176 6169 6c61 626c 6520  index available 
-00008da0: 696e 2061 6c6c 2069 6e70 7574 2066 696c  in all input fil
-00008db0: 6573 2e20 4e6f 7465 2074 6861 7420 7468  es. Note that th
-00008dc0: 650a 2020 2020 2020 2020 2020 2020 2266  e.            "f
-00008dd0: 6964 2220 7769 6c6c 2062 6520 616c 6961  id" will be alia
-00008de0: 7365 6420 6567 2e20 746f 2022 6669 645f  sed eg. to "fid_
-00008df0: 3122 2e20 4465 6661 756c 7473 2074 6f20  1". Defaults to 
-00008e00: 4e6f 6e65 2e0a 2020 2020 2020 2020 6262  None..        bb
-00008e10: 6f78 2028 5475 706c 652c 206f 7074 696f  ox (Tuple, optio
-00008e20: 6e61 6c29 3a20 7265 7475 726e 206f 6e6c  nal): return onl
-00008e30: 7920 6765 6f6d 6574 7269 6573 2069 6e74  y geometries int
-00008e40: 6572 7365 6374 696e 6720 7468 6973 2062  ersecting this b
-00008e50: 626f 782e 0a20 2020 2020 2020 2020 2020  box..           
-00008e60: 2044 6566 6175 6c74 7320 746f 204e 6f6e   Defaults to Non
-00008e70: 652c 2074 6865 6e20 616c 6c20 726f 7773  e, then all rows
-00008e80: 2061 7265 2072 6561 642e 0a20 2020 2020   are read..     
-00008e90: 2020 2072 6f77 7320 2873 6c69 6365 2c20     rows (slice, 
-00008ea0: 6f70 7469 6f6e 616c 293a 2072 6574 7572  optional): retur
-00008eb0: 6e20 6f6e 6c79 2074 6865 2072 6f77 7320  n only the rows 
-00008ec0: 7370 6563 6966 6965 642e 2046 6f72 206d  specified. For m
-00008ed0: 616e 7920 6669 6c65 2066 6f72 6d61 7473  any file formats
-00008ee0: 0a20 2020 2020 2020 2020 2020 2028 652e  .            (e.
-00008ef0: 672e 2047 656f 7061 636b 6167 6529 2074  g. Geopackage) t
-00008f00: 6869 7320 6973 2073 6c6f 772c 2073 6f20  his is slow, so 
-00008f10: 7573 696e 6720 652e 672e 2061 2077 6865  using e.g. a whe
-00008f20: 7265 2066 696c 7465 7220 696e 7374 6561  re filter instea
-00008f30: 6420 6973 0a20 2020 2020 2020 2020 2020  d is.           
-00008f40: 2072 6563 6f6d 6d65 6e64 6564 2e20 4465   recommended. De
-00008f50: 6661 756c 7473 2074 6f20 4e6f 6e65 2c20  faults to None, 
-00008f60: 7468 656e 2061 6c6c 2072 6f77 7320 6172  then all rows ar
-00008f70: 6520 7265 7475 726e 6564 2e0a 2020 2020  e returned..    
-00008f80: 2020 2020 7768 6572 6520 2873 7472 2c20      where (str, 
-00008f90: 6f70 7469 6f6e 616c 293a 2077 6865 7265  optional): where
-00008fa0: 2063 6c61 7573 6520 746f 2066 696c 7465   clause to filte
-00008fb0: 7220 6665 6174 7572 6573 2069 6e20 6c61  r features in la
-00008fc0: 7965 7220 6279 2061 7474 7269 6275 7465  yer by attribute
-00008fd0: 0a20 2020 2020 2020 2020 2020 2076 616c  .            val
-00008fe0: 7565 732e 2049 6620 7468 6520 6461 7461  ues. If the data
-00008ff0: 736f 7572 6365 206e 6174 6976 656c 7920  source natively 
-00009000: 7375 7070 6f72 7473 2073 716c 2c20 6974  supports sql, it
-00009010: 7320 7370 6563 6966 6963 2053 514c 2064  s specific SQL d
-00009020: 6961 6c65 6374 0a20 2020 2020 2020 2020  ialect.         
-00009030: 2020 2073 686f 756c 6420 6265 2075 7365     should be use
-00009040: 6420 2865 672e 2053 514c 6974 6520 616e  d (eg. SQLite an
-00009050: 6420 4765 6f50 6163 6b61 6765 3a20 6053  d GeoPackage: `S
-00009060: 514c 4954 4560 5f2c 2050 6f73 7467 7265  QLITE`_, Postgre
-00009070: 5351 4c29 2e20 4966 2069 740a 2020 2020  SQL). If it.    
-00009080: 2020 2020 2020 2020 646f 6573 6e27 742c          doesn't,
-00009090: 2074 6865 2060 4f47 5253 514c 2057 4845   the `OGRSQL WHE
-000090a0: 5245 605f 2073 796e 7461 7820 7368 6f75  RE`_ syntax shou
-000090b0: 6c64 2062 6520 7573 6564 2e20 4e6f 7465  ld be used. Note
-000090c0: 2074 6861 7420 6974 2069 7320 6e6f 740a   that it is not.
-000090d0: 2020 2020 2020 2020 2020 2020 706f 7373              poss
-000090e0: 6962 6c65 2074 6f20 6f76 6572 7275 6c65  ible to overrule
-000090f0: 2074 6865 2053 514c 2064 6961 6c65 6374   the SQL dialect
-00009100: 2c20 7468 6973 2069 7320 6f6e 6c79 2070  , this is only p
-00009110: 6f73 7369 626c 6520 7768 656e 2079 6f75  ossible when you
-00009120: 2075 7365 2074 6865 0a20 2020 2020 2020   use the.       
-00009130: 2020 2020 2053 514c 2070 6172 616d 6574       SQL paramet
-00009140: 6572 2e20 4578 616d 706c 6573 3a20 6060  er. Examples: ``
-00009150: 2249 534f 5f41 3320 3d20 2743 414e 2722  "ISO_A3 = 'CAN'"
-00009160: 6060 2c0a 2020 2020 2020 2020 2020 2020  ``,.            
-00009170: 6060 2250 4f50 5f45 5354 203e 2031 3030  ``"POP_EST > 100
-00009180: 3030 3030 3020 414e 4420 504f 505f 4553  00000 AND POP_ES
-00009190: 5420 3c20 3130 3030 3030 3030 3022 6060  T < 100000000"``
-000091a0: 2e20 4465 6661 756c 7473 2074 6f20 4e6f  . Defaults to No
-000091b0: 6e65 2e0a 2020 2020 2020 2020 7371 6c5f  ne..        sql_
-000091c0: 7374 6d74 2028 7374 7229 3a20 5351 4c20  stmt (str): SQL 
-000091d0: 7374 6174 656d 656e 7420 746f 2075 7365  statement to use
-000091e0: 2e20 4f6e 6c79 2073 7570 706f 7274 6564  . Only supported
-000091f0: 2077 6974 6820 2270 796f 6772 696f 2220   with "pyogrio" 
-00009200: 656e 6769 6e65 2e0a 2020 2020 2020 2020  engine..        
-00009210: 7371 6c5f 6469 616c 6563 7420 2873 7472  sql_dialect (str
-00009220: 2c20 6f70 7469 6f6e 616c 293a 2053 514c  , optional): SQL
-00009230: 2064 6961 6c65 6374 2075 7365 642e 204f   dialect used. O
-00009240: 7074 696f 6e73 2061 7265 204e 6f6e 652c  ptions are None,
-00009250: 2022 5351 4c49 5445 2220 6f72 0a20 2020   "SQLITE" or.   
-00009260: 2020 2020 2020 2020 2022 4f47 5253 514c           "OGRSQL
-00009270: 222e 2049 6620 4e6f 6e65 2c20 666f 7220  ". If None, for 
-00009280: 6461 7461 2073 6f75 7263 6573 2077 6974  data sources wit
-00009290: 6820 6578 706c 6963 6974 2053 514c 2073  h explicit SQL s
-000092a0: 7570 706f 7274 2074 6865 2073 7461 7465  upport the state
-000092b0: 6d65 6e74 0a20 2020 2020 2020 2020 2020  ment.           
-000092c0: 2069 7320 7072 6f63 6573 7365 6420 6279   is processed by
-000092d0: 2074 6865 2064 6566 6175 6c74 2053 514c   the default SQL
-000092e0: 2065 6e67 696e 6520 2865 2e67 2e20 666f   engine (e.g. fo
-000092f0: 7220 4765 6f70 6163 6b61 6765 2061 6e64  r Geopackage and
-00009300: 2053 7061 7469 616c 6974 650a 2020 2020   Spatialite.    
-00009310: 2020 2020 2020 2020 7468 6973 2069 7320          this is 
-00009320: 2253 514c 4954 4522 292e 2046 6f72 2064  "SQLITE"). For d
-00009330: 6174 6120 736f 7572 6365 7320 7769 7468  ata sources with
-00009340: 6f75 7420 6e61 7469 7665 2053 514c 2073  out native SQL s
-00009350: 7570 706f 7274 2028 652e 672e 202e 7368  upport (e.g. .sh
-00009360: 7029 2c0a 2020 2020 2020 2020 2020 2020  p),.            
-00009370: 7468 6520 224f 4752 5351 4c22 2064 6961  the "OGRSQL" dia
-00009380: 6c65 6374 2069 7320 7468 6520 6465 6661  lect is the defa
-00009390: 756c 742e 2049 6620 7468 6520 2253 514c  ult. If the "SQL
-000093a0: 4954 4522 2064 6961 6c65 6374 2069 7320  ITE" dialect is 
-000093b0: 7370 6563 6966 6965 642c 0a20 2020 2020  specified,.     
-000093c0: 2020 2020 2020 207c 7370 6174 6961 6c69         |spatiali
-000093d0: 7465 5f72 6566 6572 656e 6365 5f6c 696e  te_reference_lin
-000093e0: 6b7c 2066 756e 6374 696f 6e73 2063 616e  k| functions can
-000093f0: 2061 6c73 6f20 6265 2075 7365 642e 2044   also be used. D
-00009400: 6566 6175 6c74 7320 746f 204e 6f6e 652e  efaults to None.
-00009410: 0a20 2020 2020 2020 2069 676e 6f72 655f  .        ignore_
-00009420: 6765 6f6d 6574 7279 2028 626f 6f6c 2c20  geometry (bool, 
-00009430: 6f70 7469 6f6e 616c 293a 2054 7275 6520  optional): True 
-00009440: 6e6f 7420 746f 2072 6561 642f 7265 7475  not to read/retu
-00009450: 726e 2074 6865 2067 656f 6d65 7472 792e  rn the geometry.
-00009460: 0a20 2020 2020 2020 2020 2020 2044 6566  .            Def
-00009470: 6175 6c74 7320 746f 2046 616c 7365 2e0a  aults to False..
-00009480: 2020 2020 2020 2020 6669 645f 6173 5f69          fid_as_i
-00009490: 6e64 6578 2028 626f 6f6c 2c20 6f70 7469  ndex (bool, opti
-000094a0: 6f6e 616c 293a 2049 6620 5472 7565 2c20  onal): If True, 
-000094b0: 7769 6c6c 2075 7365 2074 6865 2046 4944  will use the FID
-000094c0: 7320 6f66 2074 6865 2066 6561 7475 7265  s of the feature
-000094d0: 7320 7468 6174 0a20 2020 2020 2020 2020  s that.         
-000094e0: 2020 2077 6572 6520 7265 6164 2061 7320     were read as 
-000094f0: 7468 6520 696e 6465 7820 6f66 2074 6865  the index of the
-00009500: 2047 656f 4461 7461 4672 616d 652e 204d   GeoDataFrame. M
-00009510: 6179 2073 7461 7274 2061 7420 3020 6f72  ay start at 0 or
-00009520: 2031 2064 6570 656e 6469 6e67 206f 6e0a   1 depending on.
-00009530: 2020 2020 2020 2020 2020 2020 7468 6520              the 
-00009540: 6472 6976 6572 2e20 4465 6661 756c 7473  driver. Defaults
-00009550: 2074 6f20 4661 6c73 652e 0a0a 2020 2020   to False...    
-00009560: 5261 6973 6573 3a0a 2020 2020 2020 2020  Raises:.        
-00009570: 5661 6c75 6545 7272 6f72 3a20 616e 2069  ValueError: an i
-00009580: 6e76 616c 6964 2070 6172 616d 6574 6572  nvalid parameter
-00009590: 2076 616c 7565 2077 6173 2070 6173 7365   value was passe
-000095a0: 642e 0a0a 2020 2020 5265 7475 726e 733a  d...    Returns:
-000095b0: 0a20 2020 2020 2020 2067 7064 2e47 656f  .        gpd.Geo
-000095c0: 4461 7461 4672 616d 653a 2074 6865 2064  DataFrame: the d
-000095d0: 6174 6120 7265 6164 2e0a 0a20 2020 202e  ata read...    .
-000095e0: 2e20 7c4f 4752 5351 4c20 5748 4552 457c  . |OGRSQL WHERE|
-000095f0: 2072 6177 3a3a 2068 746d 6c0a 0a20 2020   raw:: html..   
-00009600: 2020 2020 203c 6120 6872 6566 3d22 6874       <a href="ht
-00009610: 7470 733a 2f2f 6764 616c 2e6f 7267 2f75  tps://gdal.org/u
-00009620: 7365 722f 6f67 725f 7371 6c5f 6469 616c  ser/ogr_sql_dial
-00009630: 6563 742e 6874 6d6c 2377 6865 7265 2220  ect.html#where" 
-00009640: 7461 7267 6574 3d22 5f62 6c61 6e6b 223e  target="_blank">
-00009650: 4f47 5253 514c 2057 4845 5245 3c2f 613e  OGRSQL WHERE</a>
-00009660: 0a0a 2020 2020 2e2e 207c 7370 6174 6961  ..    .. |spatia
-00009670: 6c69 7465 5f72 6566 6572 656e 6365 5f6c  lite_reference_l
-00009680: 696e 6b7c 2072 6177 3a3a 2068 746d 6c0a  ink| raw:: html.
-00009690: 0a20 2020 2020 2020 203c 6120 6872 6566  .        <a href
-000096a0: 3d22 6874 7470 733a 2f2f 7777 772e 6761  ="https://www.ga
-000096b0: 6961 2d67 6973 2e69 742f 6761 6961 2d73  ia-gis.it/gaia-s
-000096c0: 696e 732f 7370 6174 6961 6c69 7465 2d73  ins/spatialite-s
-000096d0: 716c 2d6c 6174 6573 742e 6874 6d6c 2220  ql-latest.html" 
-000096e0: 7461 7267 6574 3d22 5f62 6c61 6e6b 223e  target="_blank">
-000096f0: 7370 6174 6961 6c69 7465 2072 6566 6572  spatialite refer
-00009700: 656e 6365 3c2f 613e 0a0a 2020 2020 2222  ence</a>..    ""
-00009710: 2220 2023 206e 6f71 613a 2045 3530 310a  "  # noqa: E501.
-00009720: 2020 2020 7265 7375 6c74 5f67 6466 203d      result_gdf =
-00009730: 205f 7265 6164 5f66 696c 655f 6261 7365   _read_file_base
-00009740: 280a 2020 2020 2020 2020 7061 7468 3d70  (.        path=p
-00009750: 6174 682c 0a20 2020 2020 2020 206c 6179  ath,.        lay
-00009760: 6572 3d6c 6179 6572 2c0a 2020 2020 2020  er=layer,.      
-00009770: 2020 636f 6c75 6d6e 733d 636f 6c75 6d6e    columns=column
-00009780: 732c 0a20 2020 2020 2020 2062 626f 783d  s,.        bbox=
-00009790: 6262 6f78 2c0a 2020 2020 2020 2020 726f  bbox,.        ro
-000097a0: 7773 3d72 6f77 732c 0a20 2020 2020 2020  ws=rows,.       
-000097b0: 2077 6865 7265 3d77 6865 7265 2c0a 2020   where=where,.  
-000097c0: 2020 2020 2020 7371 6c5f 7374 6d74 3d73        sql_stmt=s
-000097d0: 716c 5f73 746d 742c 0a20 2020 2020 2020  ql_stmt,.       
-000097e0: 2073 716c 5f64 6961 6c65 6374 3d73 716c   sql_dialect=sql
-000097f0: 5f64 6961 6c65 6374 2c0a 2020 2020 2020  _dialect,.      
-00009800: 2020 6967 6e6f 7265 5f67 656f 6d65 7472    ignore_geometr
-00009810: 793d 6967 6e6f 7265 5f67 656f 6d65 7472  y=ignore_geometr
-00009820: 792c 0a20 2020 2020 2020 2066 6964 5f61  y,.        fid_a
-00009830: 735f 696e 6465 783d 6669 645f 6173 5f69  s_index=fid_as_i
-00009840: 6e64 6578 2c0a 2020 2020 290a 0a20 2020  ndex,.    )..   
-00009850: 2023 204e 6f20 6173 7365 7274 2074 6f20   # No assert to 
-00009860: 6b65 6570 2062 6163 6b77 6172 6473 2063  keep backwards c
-00009870: 6f6d 7061 7469 6269 6c69 7479 0a20 2020  ompatibility.   
-00009880: 2072 6574 7572 6e20 7265 7375 6c74 5f67   return result_g
-00009890: 6466 0a0a 0a64 6566 2072 6561 645f 6669  df...def read_fi
-000098a0: 6c65 5f6e 6f67 656f 6d28 0a20 2020 2070  le_nogeom(.    p
-000098b0: 6174 683a 2055 6e69 6f6e 5b73 7472 2c20  ath: Union[str, 
-000098c0: 226f 732e 5061 7468 4c69 6b65 5b41 6e79  "os.PathLike[Any
-000098d0: 5d22 5d2c 0a20 2020 206c 6179 6572 3a20  ]"],.    layer: 
-000098e0: 4f70 7469 6f6e 616c 5b73 7472 5d20 3d20  Optional[str] = 
-000098f0: 4e6f 6e65 2c0a 2020 2020 636f 6c75 6d6e  None,.    column
-00009900: 733a 204f 7074 696f 6e61 6c5b 4974 6572  s: Optional[Iter
-00009910: 6162 6c65 5b73 7472 5d5d 203d 204e 6f6e  able[str]] = Non
-00009920: 652c 0a20 2020 2062 626f 783d 4e6f 6e65  e,.    bbox=None
-00009930: 2c0a 2020 2020 726f 7773 3d4e 6f6e 652c  ,.    rows=None,
-00009940: 0a20 2020 2073 716c 5f73 746d 743a 204f  .    sql_stmt: O
-00009950: 7074 696f 6e61 6c5b 7374 725d 203d 204e  ptional[str] = N
-00009960: 6f6e 652c 0a20 2020 2073 716c 5f64 6961  one,.    sql_dia
-00009970: 6c65 6374 3a20 4f70 7469 6f6e 616c 5b4c  lect: Optional[L
-00009980: 6974 6572 616c 5b22 5351 4c49 5445 222c  iteral["SQLITE",
-00009990: 2022 4f47 5253 514c 225d 5d20 3d20 4e6f   "OGRSQL"]] = No
-000099a0: 6e65 2c0a 2020 2020 6669 645f 6173 5f69  ne,.    fid_as_i
-000099b0: 6e64 6578 3a20 626f 6f6c 203d 2046 616c  ndex: bool = Fal
-000099c0: 7365 2c0a 2920 2d3e 2070 642e 4461 7461  se,.) -> pd.Data
-000099d0: 4672 616d 653a 0a20 2020 2022 2222 0a20  Frame:.    """. 
-000099e0: 2020 2044 4550 5245 4341 5445 443a 2070     DEPRECATED: p
-000099f0: 6c65 6173 6520 7573 6520 7265 6164 5f66  lease use read_f
-00009a00: 696c 6520 7769 7468 206f 7074 696f 6e20  ile with option 
-00009a10: 6967 6e6f 7265 5f67 656f 6d65 7472 793d  ignore_geometry=
-00009a20: 5472 7565 2e0a 2020 2020 2222 220a 2020  True..    """.  
-00009a30: 2020 7761 726e 696e 6773 2e77 6172 6e28    warnings.warn(
-00009a40: 0a20 2020 2020 2020 2022 7265 6164 5f66  .        "read_f
-00009a50: 696c 655f 6e6f 6765 6f6d 2069 7320 6465  ile_nogeom is de
-00009a60: 7072 6563 6174 6564 3a20 7573 6520 7265  precated: use re
-00009a70: 6164 5f66 696c 6520 7769 7468 2069 676e  ad_file with ign
-00009a80: 6f72 655f 6765 6f6d 6574 7279 3d54 7275  ore_geometry=Tru
-00009a90: 6522 2c0a 2020 2020 2020 2020 4675 7475  e",.        Futu
-00009aa0: 7265 5761 726e 696e 672c 0a20 2020 2020  reWarning,.     
-00009ab0: 2020 2073 7461 636b 6c65 7665 6c3d 322c     stacklevel=2,
-00009ac0: 0a20 2020 2029 0a20 2020 2072 6573 756c  .    ).    resul
-00009ad0: 745f 6764 6620 3d20 5f72 6561 645f 6669  t_gdf = _read_fi
-00009ae0: 6c65 5f62 6173 6528 0a20 2020 2020 2020  le_base(.       
-00009af0: 2070 6174 683d 7061 7468 2c0a 2020 2020   path=path,.    
-00009b00: 2020 2020 6c61 7965 723d 6c61 7965 722c      layer=layer,
-00009b10: 0a20 2020 2020 2020 2063 6f6c 756d 6e73  .        columns
-00009b20: 3d63 6f6c 756d 6e73 2c0a 2020 2020 2020  =columns,.      
-00009b30: 2020 6262 6f78 3d62 626f 782c 0a20 2020    bbox=bbox,.   
-00009b40: 2020 2020 2072 6f77 733d 726f 7773 2c0a       rows=rows,.
-00009b50: 2020 2020 2020 2020 7371 6c5f 7374 6d74          sql_stmt
-00009b60: 3d73 716c 5f73 746d 742c 0a20 2020 2020  =sql_stmt,.     
-00009b70: 2020 2073 716c 5f64 6961 6c65 6374 3d73     sql_dialect=s
-00009b80: 716c 5f64 6961 6c65 6374 2c0a 2020 2020  ql_dialect,.    
-00009b90: 2020 2020 6967 6e6f 7265 5f67 656f 6d65      ignore_geome
-00009ba0: 7472 793d 5472 7565 2c0a 2020 2020 2020  try=True,.      
-00009bb0: 2020 6669 645f 6173 5f69 6e64 6578 3d66    fid_as_index=f
-00009bc0: 6964 5f61 735f 696e 6465 782c 0a20 2020  id_as_index,.   
-00009bd0: 2029 0a20 2020 2061 7373 6572 7420 6973   ).    assert is
-00009be0: 696e 7374 616e 6365 2872 6573 756c 745f  instance(result_
-00009bf0: 6764 662c 2070 642e 4461 7461 4672 616d  gdf, pd.DataFram
-00009c00: 6529 0a20 2020 2072 6574 7572 6e20 7265  e).    return re
-00009c10: 7375 6c74 5f67 6466 0a0a 0a64 6566 205f  sult_gdf...def _
-00009c20: 7265 6164 5f66 696c 655f 6261 7365 280a  read_file_base(.
-00009c30: 2020 2020 7061 7468 3a20 556e 696f 6e5b      path: Union[
-00009c40: 7374 722c 2022 6f73 2e50 6174 684c 696b  str, "os.PathLik
-00009c50: 655b 416e 795d 225d 2c0a 2020 2020 6c61  e[Any]"],.    la
-00009c60: 7965 723a 204f 7074 696f 6e61 6c5b 7374  yer: Optional[st
-00009c70: 725d 203d 204e 6f6e 652c 0a20 2020 2063  r] = None,.    c
-00009c80: 6f6c 756d 6e73 3a20 4f70 7469 6f6e 616c  olumns: Optional
-00009c90: 5b49 7465 7261 626c 655b 7374 725d 5d20  [Iterable[str]] 
-00009ca0: 3d20 4e6f 6e65 2c0a 2020 2020 6262 6f78  = None,.    bbox
-00009cb0: 3d4e 6f6e 652c 0a20 2020 2072 6f77 733d  =None,.    rows=
-00009cc0: 4e6f 6e65 2c0a 2020 2020 7768 6572 653a  None,.    where:
-00009cd0: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
-00009ce0: 204e 6f6e 652c 0a20 2020 2073 716c 5f73   None,.    sql_s
-00009cf0: 746d 743a 204f 7074 696f 6e61 6c5b 7374  tmt: Optional[st
-00009d00: 725d 203d 204e 6f6e 652c 0a20 2020 2073  r] = None,.    s
-00009d10: 716c 5f64 6961 6c65 6374 3a20 4f70 7469  ql_dialect: Opti
-00009d20: 6f6e 616c 5b4c 6974 6572 616c 5b22 5351  onal[Literal["SQ
-00009d30: 4c49 5445 222c 2022 4f47 5253 514c 225d  LITE", "OGRSQL"]
-00009d40: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 6967  ] = None,.    ig
-00009d50: 6e6f 7265 5f67 656f 6d65 7472 793a 2062  nore_geometry: b
-00009d60: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
-00009d70: 2066 6964 5f61 735f 696e 6465 783a 2062   fid_as_index: b
-00009d80: 6f6f 6c20 3d20 4661 6c73 652c 0a29 202d  ool = False,.) -
-00009d90: 3e20 556e 696f 6e5b 7064 2e44 6174 6146  > Union[pd.DataF
-00009da0: 7261 6d65 2c20 6770 642e 4765 6f44 6174  rame, gpd.GeoDat
-00009db0: 6146 7261 6d65 5d3a 0a20 2020 2022 2222  aFrame]:.    """
-00009dc0: 0a20 2020 2052 6561 6473 2061 2066 696c  .    Reads a fil
-00009dd0: 6520 746f 2061 2070 616e 6461 7320 4461  e to a pandas Da
-00009de0: 7461 6672 616d 652e 0a20 2020 2022 2222  taframe..    """
-00009df0: 0a20 2020 2023 2043 6865 636b 2069 6620  .    # Check if 
-00009e00: 7468 6520 6669 6420 636f 6c75 6d6e 206e  the fid column n
-00009e10: 6565 6473 2074 6f20 6265 2072 6561 6420  eeds to be read 
-00009e20: 6173 2063 6f6c 756d 6e20 7669 6120 7468  as column via th
-00009e30: 6520 636f 6c75 6d6e 7320 7061 7261 6d65  e columns parame
-00009e40: 7465 720a 2020 2020 6669 645f 6173 5f63  ter.    fid_as_c
-00009e50: 6f6c 756d 6e20 3d20 4661 6c73 650a 2020  olumn = False.  
-00009e60: 2020 6966 2063 6f6c 756d 6e73 2069 7320    if columns is 
-00009e70: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00009e80: 2020 6966 2022 6669 6422 2069 6e20 5b63    if "fid" in [c
-00009e90: 6f6c 756d 6e2e 6c6f 7765 7228 2920 666f  olumn.lower() fo
-00009ea0: 7220 636f 6c75 6d6e 2069 6e20 636f 6c75  r column in colu
-00009eb0: 6d6e 735d 3a0a 2020 2020 2020 2020 2020  mns]:.          
-00009ec0: 2020 6669 645f 6173 5f63 6f6c 756d 6e20    fid_as_column 
-00009ed0: 3d20 5472 7565 0a0a 2020 2020 2320 5265  = True..    # Re
-00009ee0: 6164 2077 6974 6820 7468 6520 656e 6769  ad with the engi
-00009ef0: 6e65 2073 7065 6369 6669 6564 0a20 2020  ne specified.   
-00009f00: 2065 6e67 696e 6520 3d20 5f67 6574 5f65   engine = _get_e
-00009f10: 6e67 696e 6528 290a 2020 2020 6966 2065  ngine().    if e
-00009f20: 6e67 696e 6520 3d3d 2022 7079 6f67 7269  ngine == "pyogri
-00009f30: 6f22 3a0a 2020 2020 2020 2020 6764 6620  o":.        gdf 
-00009f40: 3d20 5f72 6561 645f 6669 6c65 5f62 6173  = _read_file_bas
-00009f50: 655f 7079 6f67 7269 6f28 0a20 2020 2020  e_pyogrio(.     
-00009f60: 2020 2020 2020 2070 6174 683d 7061 7468         path=path
-00009f70: 2c0a 2020 2020 2020 2020 2020 2020 6c61  ,.            la
-00009f80: 7965 723d 6c61 7965 722c 0a20 2020 2020  yer=layer,.     
-00009f90: 2020 2020 2020 2063 6f6c 756d 6e73 3d63         columns=c
-00009fa0: 6f6c 756d 6e73 2c0a 2020 2020 2020 2020  olumns,.        
-00009fb0: 2020 2020 6262 6f78 3d62 626f 782c 0a20      bbox=bbox,. 
-00009fc0: 2020 2020 2020 2020 2020 2072 6f77 733d             rows=
-00009fd0: 726f 7773 2c0a 2020 2020 2020 2020 2020  rows,.          
-00009fe0: 2020 7768 6572 653d 7768 6572 652c 0a20    where=where,. 
-00009ff0: 2020 2020 2020 2020 2020 2073 716c 5f73             sql_s
-0000a000: 746d 743d 7371 6c5f 7374 6d74 2c0a 2020  tmt=sql_stmt,.  
-0000a010: 2020 2020 2020 2020 2020 7371 6c5f 6469            sql_di
-0000a020: 616c 6563 743d 7371 6c5f 6469 616c 6563  alect=sql_dialec
-0000a030: 742c 0a20 2020 2020 2020 2020 2020 2069  t,.            i
-0000a040: 676e 6f72 655f 6765 6f6d 6574 7279 3d69  gnore_geometry=i
-0000a050: 676e 6f72 655f 6765 6f6d 6574 7279 2c0a  gnore_geometry,.
-0000a060: 2020 2020 2020 2020 2020 2020 6669 645f              fid_
-0000a070: 6173 5f69 6e64 6578 3d66 6964 5f61 735f  as_index=fid_as_
-0000a080: 696e 6465 7820 6f72 2066 6964 5f61 735f  index or fid_as_
-0000a090: 636f 6c75 6d6e 2c0a 2020 2020 2020 2020  column,.        
-0000a0a0: 290a 2020 2020 656c 6966 2065 6e67 696e  ).    elif engin
-0000a0b0: 6520 3d3d 2022 6669 6f6e 6122 3a0a 2020  e == "fiona":.  
-0000a0c0: 2020 2020 2020 6764 6620 3d20 5f72 6561        gdf = _rea
-0000a0d0: 645f 6669 6c65 5f62 6173 655f 6669 6f6e  d_file_base_fion
-0000a0e0: 6128 0a20 2020 2020 2020 2020 2020 2070  a(.            p
-0000a0f0: 6174 683d 7061 7468 2c0a 2020 2020 2020  ath=path,.      
-0000a100: 2020 2020 2020 6c61 7965 723d 6c61 7965        layer=laye
-0000a110: 722c 0a20 2020 2020 2020 2020 2020 2063  r,.            c
-0000a120: 6f6c 756d 6e73 3d63 6f6c 756d 6e73 2c0a  olumns=columns,.
-0000a130: 2020 2020 2020 2020 2020 2020 6262 6f78              bbox
-0000a140: 3d62 626f 782c 0a20 2020 2020 2020 2020  =bbox,.         
-0000a150: 2020 2072 6f77 733d 726f 7773 2c0a 2020     rows=rows,.  
-0000a160: 2020 2020 2020 2020 2020 7768 6572 653d            where=
-0000a170: 7768 6572 652c 0a20 2020 2020 2020 2020  where,.         
-0000a180: 2020 2073 716c 5f73 746d 743d 7371 6c5f     sql_stmt=sql_
-0000a190: 7374 6d74 2c0a 2020 2020 2020 2020 2020  stmt,.          
-0000a1a0: 2020 7371 6c5f 6469 616c 6563 743d 7371    sql_dialect=sq
-0000a1b0: 6c5f 6469 616c 6563 742c 0a20 2020 2020  l_dialect,.     
-0000a1c0: 2020 2020 2020 2069 676e 6f72 655f 6765         ignore_ge
-0000a1d0: 6f6d 6574 7279 3d69 676e 6f72 655f 6765  ometry=ignore_ge
-0000a1e0: 6f6d 6574 7279 2c0a 2020 2020 2020 2020  ometry,.        
-0000a1f0: 2020 2020 6669 645f 6173 5f69 6e64 6578      fid_as_index
-0000a200: 3d66 6964 5f61 735f 696e 6465 7820 6f72  =fid_as_index or
-0000a210: 2066 6964 5f61 735f 636f 6c75 6d6e 2c0a   fid_as_column,.
-0000a220: 2020 2020 2020 2020 290a 2020 2020 656c          ).    el
-0000a230: 7365 3a0a 2020 2020 2020 2020 7261 6973  se:.        rais
-0000a240: 6520 5661 6c75 6545 7272 6f72 2866 2255  e ValueError(f"U
-0000a250: 6e73 7570 706f 7274 6564 2065 6e67 696e  nsupported engin
-0000a260: 653a 207b 656e 6769 6e65 7d22 290a 0a20  e: {engine}").. 
-0000a270: 2020 2023 2043 6f70 7920 7468 6520 696e     # Copy the in
-0000a280: 6465 7820 746f 2061 2063 6f6c 756d 6e20  dex to a column 
-0000a290: 6966 206e 6565 6465 642e 2e2e 0a20 2020  if needed....   
-0000a2a0: 2069 6620 6669 645f 6173 5f63 6f6c 756d   if fid_as_colum
-0000a2b0: 6e3a 0a20 2020 2020 2020 2067 6466 5b22  n:.        gdf["
-0000a2c0: 6669 6422 5d20 3d20 6764 662e 696e 6465  fid"] = gdf.inde
-0000a2d0: 780a 2020 2020 2020 2020 6966 206e 6f74  x.        if not
-0000a2e0: 2066 6964 5f61 735f 696e 6465 783a 0a20   fid_as_index:. 
-0000a2f0: 2020 2020 2020 2020 2020 2067 6466 203d             gdf =
-0000a300: 2067 6466 2e72 6573 6574 5f69 6e64 6578   gdf.reset_index
-0000a310: 2864 726f 703d 5472 7565 290a 0a20 2020  (drop=True)..   
-0000a320: 2072 6574 7572 6e20 6764 660a 0a0a 6465   return gdf...de
-0000a330: 6620 5f72 6561 645f 6669 6c65 5f62 6173  f _read_file_bas
-0000a340: 655f 6669 6f6e 6128 0a20 2020 2070 6174  e_fiona(.    pat
-0000a350: 683a 2055 6e69 6f6e 5b73 7472 2c20 226f  h: Union[str, "o
-0000a360: 732e 5061 7468 4c69 6b65 5b41 6e79 5d22  s.PathLike[Any]"
-0000a370: 5d2c 0a20 2020 206c 6179 6572 3a20 4f70  ],.    layer: Op
-0000a380: 7469 6f6e 616c 5b73 7472 5d20 3d20 4e6f  tional[str] = No
-0000a390: 6e65 2c0a 2020 2020 636f 6c75 6d6e 733a  ne,.    columns:
-0000a3a0: 204f 7074 696f 6e61 6c5b 4974 6572 6162   Optional[Iterab
-0000a3b0: 6c65 5b73 7472 5d5d 203d 204e 6f6e 652c  le[str]] = None,
-0000a3c0: 0a20 2020 2062 626f 783d 4e6f 6e65 2c0a  .    bbox=None,.
-0000a3d0: 2020 2020 726f 7773 3d4e 6f6e 652c 0a20      rows=None,. 
-0000a3e0: 2020 2077 6865 7265 3a20 4f70 7469 6f6e     where: Option
-0000a3f0: 616c 5b73 7472 5d20 3d20 4e6f 6e65 2c0a  al[str] = None,.
-0000a400: 2020 2020 7371 6c5f 7374 6d74 3a20 4f70      sql_stmt: Op
-0000a410: 7469 6f6e 616c 5b73 7472 5d20 3d20 4e6f  tional[str] = No
-0000a420: 6e65 2c0a 2020 2020 7371 6c5f 6469 616c  ne,.    sql_dial
-0000a430: 6563 743a 204f 7074 696f 6e61 6c5b 4c69  ect: Optional[Li
-0000a440: 7465 7261 6c5b 2253 514c 4954 4522 2c20  teral["SQLITE", 
-0000a450: 224f 4752 5351 4c22 5d5d 203d 204e 6f6e  "OGRSQL"]] = Non
-0000a460: 652c 0a20 2020 2069 676e 6f72 655f 6765  e,.    ignore_ge
-0000a470: 6f6d 6574 7279 3a20 626f 6f6c 203d 2046  ometry: bool = F
-0000a480: 616c 7365 2c0a 2020 2020 6669 645f 6173  alse,.    fid_as
-0000a490: 5f69 6e64 6578 3a20 626f 6f6c 203d 2046  _index: bool = F
-0000a4a0: 616c 7365 2c0a 2920 2d3e 2055 6e69 6f6e  alse,.) -> Union
-0000a4b0: 5b70 642e 4461 7461 4672 616d 652c 2067  [pd.DataFrame, g
-0000a4c0: 7064 2e47 656f 4461 7461 4672 616d 655d  pd.GeoDataFrame]
-0000a4d0: 3a0a 2020 2020 2222 220a 2020 2020 5265  :.    """.    Re
-0000a4e0: 6164 7320 6120 6669 6c65 2074 6f20 6120  ads a file to a 
-0000a4f0: 7061 6e64 6173 2044 6174 6166 7261 6d65  pandas Dataframe
-0000a500: 2075 7369 6e67 2066 696f 6e61 2e0a 2020   using fiona..  
-0000a510: 2020 2222 220a 2020 2020 6966 2069 676e    """.    if ign
-0000a520: 6f72 655f 6765 6f6d 6574 7279 2061 6e64  ore_geometry and
-0000a530: 2063 6f6c 756d 6e73 203d 3d20 5b5d 3a0a   columns == []:.
-0000a540: 2020 2020 2020 2020 7265 7475 726e 2070          return p
-0000a550: 642e 4461 7461 4672 616d 6528 290a 2020  d.DataFrame().  
-0000a560: 2020 6966 2073 716c 5f73 746d 7420 6973    if sql_stmt is
-0000a570: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-0000a580: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-0000a590: 726f 7228 2273 716c 5f73 746d 7420 6973  ror("sql_stmt is
-0000a5a0: 206e 6f74 2073 7570 706f 7274 6564 2077   not supported w
-0000a5b0: 6974 6820 6669 6f6e 6120 656e 6769 6e65  ith fiona engine
-0000a5c0: 2229 0a0a 2020 2020 2320 496e 6974 0a20  ")..    # Init. 
-0000a5d0: 2020 2070 6174 6820 3d20 5061 7468 2870     path = Path(p
-0000a5e0: 6174 6829 0a20 2020 2069 6620 7061 7468  ath).    if path
-0000a5f0: 2e65 7869 7374 7328 2920 6973 2046 616c  .exists() is Fal
-0000a600: 7365 3a0a 2020 2020 2020 2020 7261 6973  se:.        rais
-0000a610: 6520 5661 6c75 6545 7272 6f72 2866 2266  e ValueError(f"f
-0000a620: 696c 6520 646f 6573 6e27 7420 6578 6973  ile doesn't exis
-0000a630: 743a 207b 7061 7468 7d22 290a 0a20 2020  t: {path}")..   
-0000a640: 2023 2049 6620 6e6f 206c 6179 6572 206e   # If no layer n
-0000a650: 616d 6520 7370 6563 6966 6965 642c 2063  ame specified, c
-0000a660: 6865 636b 2069 6620 7468 6572 6520 6973  heck if there is
-0000a670: 206f 6e6c 7920 6f6e 6520 6c61 7965 7220   only one layer 
-0000a680: 696e 2074 6865 2066 696c 652e 0a20 2020  in the file..   
-0000a690: 2069 6620 6c61 7965 7220 6973 204e 6f6e   if layer is Non
-0000a6a0: 653a 0a20 2020 2020 2020 206c 6179 6572  e:.        layer
-0000a6b0: 203d 2067 6574 5f6f 6e6c 795f 6c61 7965   = get_only_laye
-0000a6c0: 7228 7061 7468 290a 0a20 2020 2023 2056  r(path)..    # V
-0000a6d0: 4552 5920 4449 5254 5920 6861 636b 2074  ERY DIRTY hack t
-0000a6e0: 6f20 6765 7420 7468 6520 6669 640a 2020  o get the fid.  
-0000a6f0: 2020 6966 2066 6964 5f61 735f 696e 6465    if fid_as_inde
-0000a700: 783a 0a20 2020 2020 2020 2023 204d 616b  x:.        # Mak
-0000a710: 6520 6120 636f 7079 2f63 6f70 7920 696e  e a copy/copy in
-0000a720: 7075 7420 6669 6c65 2074 6f20 6765 6f70  put file to geop
-0000a730: 6163 6b61 6765 2c20 6173 2077 6520 7769  ackage, as we wi
-0000a740: 6c6c 2061 6464 2061 6e20 6669 642f 726f  ll add an fid/ro
-0000a750: 7764 2063 6f6c 756d 6e0a 2020 2020 2020  wd column.      
-0000a760: 2020 746d 705f 6669 645f 7061 7468 203d    tmp_fid_path =
-0000a770: 2050 6174 6828 7465 6d70 6669 6c65 2e6d   Path(tempfile.m
-0000a780: 6b64 7465 6d70 2829 2920 2f20 6622 7b70  kdtemp()) / f"{p
-0000a790: 6174 682e 7374 656d 7d2e 6770 6b67 220a  ath.stem}.gpkg".
-0000a7a0: 2020 2020 2020 2020 7061 7468 5f69 6e66          path_inf
-0000a7b0: 6f20 3d20 5f67 656f 6669 6c65 696e 666f  o = _geofileinfo
-0000a7c0: 2e67 6574 5f67 656f 6669 6c65 696e 666f  .get_geofileinfo
-0000a7d0: 2870 6174 6829 0a20 2020 2020 2020 2074  (path).        t
-0000a7e0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0000a7f0: 6966 2070 6174 685f 696e 666f 2e64 7269  if path_info.dri
-0000a800: 7665 7220 3d3d 2022 4750 4b47 223a 0a20  ver == "GPKG":. 
-0000a810: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0000a820: 6f70 7928 7061 7468 2c20 746d 705f 6669  opy(path, tmp_fi
-0000a830: 645f 7061 7468 290a 2020 2020 2020 2020  d_path).        
-0000a840: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0000a850: 2020 2020 2020 2020 2020 636f 7079 5f6c            copy_l
-0000a860: 6179 6572 2870 6174 682c 2074 6d70 5f66  ayer(path, tmp_f
-0000a870: 6964 5f70 6174 6829 0a20 2020 2020 2020  id_path).       
-0000a880: 2020 2020 2069 6620 7061 7468 5f69 6e66       if path_inf
-0000a890: 6f2e 6973 5f66 6964 5f7a 6572 6f62 6173  o.is_fid_zerobas
-0000a8a0: 6564 3a0a 2020 2020 2020 2020 2020 2020  ed:.            
-0000a8b0: 2020 2020 2320 6669 6420 696e 2073 6861      # fid in sha
-0000a8c0: 7065 6669 6c65 2069 7320 3020 6261 7365  pefile is 0 base
-0000a8d0: 642c 2073 6f20 6669 642d 310a 2020 2020  d, so fid-1.    
-0000a8e0: 2020 2020 2020 2020 2020 2020 6164 645f              add_
-0000a8f0: 636f 6c75 6d6e 2874 6d70 5f66 6964 5f70  column(tmp_fid_p
-0000a900: 6174 682c 2022 5f5f 544d 505f 4745 4f46  ath, "__TMP_GEOF
-0000a910: 494c 454f 5053 5f46 4944 222c 2022 494e  ILEOPS_FID", "IN
-0000a920: 5445 4745 5222 2c20 2266 6964 2d31 2229  TEGER", "fid-1")
-0000a930: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-0000a940: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0000a950: 2020 2061 6464 5f63 6f6c 756d 6e28 746d     add_column(tm
-0000a960: 705f 6669 645f 7061 7468 2c20 225f 5f54  p_fid_path, "__T
-0000a970: 4d50 5f47 454f 4649 4c45 4f50 535f 4649  MP_GEOFILEOPS_FI
-0000a980: 4422 2c20 2249 4e54 4547 4552 222c 2022  D", "INTEGER", "
-0000a990: 6669 6422 290a 0a20 2020 2020 2020 2020  fid")..         
-0000a9a0: 2020 2070 6174 6820 3d20 746d 705f 6669     path = tmp_fi
-0000a9b0: 645f 7061 7468 0a20 2020 2020 2020 2066  d_path.        f
-0000a9c0: 696e 616c 6c79 3a0a 2020 2020 2020 2020  inally:.        
-0000a9d0: 2020 2020 6966 2074 6d70 5f66 6964 5f70      if tmp_fid_p
-0000a9e0: 6174 682e 7061 7265 6e74 2e65 7869 7374  ath.parent.exist
-0000a9f0: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-0000aa00: 2020 2020 2073 6875 7469 6c2e 726d 7472       shutil.rmtr
-0000aa10: 6565 2874 6d70 5f66 6964 5f70 6174 682c  ee(tmp_fid_path,
-0000aa20: 2069 676e 6f72 655f 6572 726f 7273 3d54   ignore_errors=T
-0000aa30: 7275 6529 0a0a 2020 2020 2320 4368 6563  rue)..    # Chec
-0000aa40: 6b69 6e67 2069 6620 6669 656c 642f 636f  king if field/co
-0000aa50: 6c75 6d6e 206e 616d 6573 2073 686f 756c  lumn names shoul
-0000aa60: 6420 6265 2072 6561 6420 6973 2063 6173  d be read is cas
-0000aa70: 6520 7365 6e73 6974 6976 6520 696e 2066  e sensitive in f
-0000aa80: 696f 6e61 2c20 736f 0a20 2020 2023 206d  iona, so.    # m
-0000aa90: 616b 6520 7375 7265 2074 6865 2063 6f6c  ake sure the col
-0000aaa0: 756d 6e20 6e61 6d65 7320 7370 6563 6966  umn names specif
-0000aab0: 6965 6420 6861 7665 2074 6865 2073 616d  ied have the sam
-0000aac0: 6520 6361 7369 6e67 2e0a 2020 2020 636f  e casing..    co
-0000aad0: 6c75 6d6e 735f 7072 6570 6172 6564 203d  lumns_prepared =
-0000aae0: 204e 6f6e 650a 2020 2020 6966 2063 6f6c   None.    if col
-0000aaf0: 756d 6e73 2069 7320 6e6f 7420 4e6f 6e65  umns is not None
-0000ab00: 3a0a 2020 2020 2020 2020 6c61 7965 7269  :.        layeri
-0000ab10: 6e66 6f20 3d20 6765 745f 6c61 7965 7269  nfo = get_layeri
-0000ab20: 6e66 6f28 7061 7468 2c20 6c61 7965 723d  nfo(path, layer=
-0000ab30: 6c61 7965 722c 2072 6169 7365 5f6f 6e5f  layer, raise_on_
-0000ab40: 6e6f 6765 6f6d 3d46 616c 7365 290a 2020  nogeom=False).  
-0000ab50: 2020 2020 2020 636f 6c75 6d6e 735f 7570        columns_up
-0000ab60: 7065 725f 6c6f 6f6b 7570 203d 207b 636f  per_lookup = {co
-0000ab70: 6c75 6d6e 2e75 7070 6572 2829 3a20 636f  lumn.upper(): co
-0000ab80: 6c75 6d6e 2066 6f72 2063 6f6c 756d 6e20  lumn for column 
-0000ab90: 696e 2063 6f6c 756d 6e73 7d0a 2020 2020  in columns}.    
-0000aba0: 2020 2020 636f 6c75 6d6e 735f 7072 6570      columns_prep
-0000abb0: 6172 6564 203d 207b 0a20 2020 2020 2020  ared = {.       
-0000abc0: 2020 2020 2063 6f6c 756d 6e3a 2063 6f6c       column: col
-0000abd0: 756d 6e73 5f75 7070 6572 5f6c 6f6f 6b75  umns_upper_looku
-0000abe0: 705b 636f 6c75 6d6e 2e75 7070 6572 2829  p[column.upper()
-0000abf0: 5d0a 2020 2020 2020 2020 2020 2020 666f  ].            fo
-0000ac00: 7220 636f 6c75 6d6e 2069 6e20 6c61 7965  r column in laye
-0000ac10: 7269 6e66 6f2e 636f 6c75 6d6e 730a 2020  rinfo.columns.  
-0000ac20: 2020 2020 2020 2020 2020 6966 2063 6f6c            if col
-0000ac30: 756d 6e2e 7570 7065 7228 2920 696e 2063  umn.upper() in c
-0000ac40: 6f6c 756d 6e73 5f75 7070 6572 5f6c 6f6f  olumns_upper_loo
-0000ac50: 6b75 700a 2020 2020 2020 2020 7d0a 0a20  kup.        }.. 
-0000ac60: 2020 2023 2052 6561 642e 2e2e 0a20 2020     # Read....   
-0000ac70: 2063 6f6c 756d 6e73 5f6c 6973 7420 3d20   columns_list = 
-0000ac80: 4e6f 6e65 2069 6620 636f 6c75 6d6e 735f  None if columns_
-0000ac90: 7072 6570 6172 6564 2069 7320 4e6f 6e65  prepared is None
-0000aca0: 2065 6c73 6520 6c69 7374 2863 6f6c 756d   else list(colum
-0000acb0: 6e73 5f70 7265 7061 7265 6429 0a20 2020  ns_prepared).   
-0000acc0: 2072 6573 756c 745f 6764 6620 3d20 6770   result_gdf = gp
-0000acd0: 642e 7265 6164 5f66 696c 6528 0a20 2020  d.read_file(.   
-0000ace0: 2020 2020 2073 7472 2870 6174 6829 2c0a       str(path),.
-0000acf0: 2020 2020 2020 2020 6c61 7965 723d 6c61          layer=la
-0000ad00: 7965 722c 0a20 2020 2020 2020 2062 626f  yer,.        bbo
-0000ad10: 783d 6262 6f78 2c0a 2020 2020 2020 2020  x=bbox,.        
-0000ad20: 726f 7773 3d72 6f77 732c 0a20 2020 2020  rows=rows,.     
-0000ad30: 2020 2069 6e63 6c75 6465 5f66 6965 6c64     include_field
-0000ad40: 733d 636f 6c75 6d6e 735f 6c69 7374 2c0a  s=columns_list,.
-0000ad50: 2020 2020 2020 2020 7768 6572 653d 7768          where=wh
-0000ad60: 6572 652c 0a20 2020 2020 2020 2073 716c  ere,.        sql
-0000ad70: 3d73 716c 5f73 746d 742c 0a20 2020 2020  =sql_stmt,.     
-0000ad80: 2020 2073 716c 5f64 6961 6c65 6374 3d73     sql_dialect=s
-0000ad90: 716c 5f64 6961 6c65 6374 2c0a 2020 2020  ql_dialect,.    
-0000ada0: 2020 2020 6967 6e6f 7265 5f67 656f 6d65      ignore_geome
-0000adb0: 7472 793d 6967 6e6f 7265 5f67 656f 6d65  try=ignore_geome
-0000adc0: 7472 792c 0a20 2020 2029 0a0a 2020 2020  try,.    )..    
-0000add0: 2320 5365 7420 7468 6520 696e 6465 7820  # Set the index 
-0000ade0: 746f 2074 6865 2062 6163 6b65 642d 7570  to the backed-up
-0000adf0: 2066 6964 0a20 2020 2069 6620 6669 645f   fid.    if fid_
-0000ae00: 6173 5f69 6e64 6578 3a0a 2020 2020 2020  as_index:.      
-0000ae10: 2020 7265 7375 6c74 5f67 6466 203d 2072    result_gdf = r
-0000ae20: 6573 756c 745f 6764 662e 7365 745f 696e  esult_gdf.set_in
-0000ae30: 6465 7828 225f 5f54 4d50 5f47 454f 4649  dex("__TMP_GEOFI
-0000ae40: 4c45 4f50 535f 4649 4422 290a 2020 2020  LEOPS_FID").    
-0000ae50: 2020 2020 7265 7375 6c74 5f67 6466 2e69      result_gdf.i
-0000ae60: 6e64 6578 2e6e 616d 6520 3d20 2266 6964  ndex.name = "fid
-0000ae70: 220a 0a20 2020 2023 2052 656f 7264 6572  "..    # Reorder
-0000ae80: 2063 6f6c 756d 6e73 202b 2063 6861 6e67   columns + chang
-0000ae90: 6520 6361 7369 6e67 2073 6f20 7468 6579  e casing so they
-0000aea0: 2061 7265 2074 6865 2073 616d 6520 6173   are the same as
-0000aeb0: 2063 6f6c 756d 6e73 2070 6172 616d 6574   columns paramet
-0000aec0: 6572 0a20 2020 2069 6620 636f 6c75 6d6e  er.    if column
-0000aed0: 735f 7072 6570 6172 6564 2069 7320 6e6f  s_prepared is no
-0000aee0: 7420 4e6f 6e65 2061 6e64 206c 656e 2863  t None and len(c
-0000aef0: 6f6c 756d 6e73 5f70 7265 7061 7265 6429  olumns_prepared)
-0000af00: 203e 2030 3a0a 2020 2020 2020 2020 636f   > 0:.        co
-0000af10: 6c75 6d6e 735f 746f 5f6b 6565 7020 3d20  lumns_to_keep = 
-0000af20: 6c69 7374 2863 6f6c 756d 6e73 5f70 7265  list(columns_pre
-0000af30: 7061 7265 6429 0a20 2020 2020 2020 2069  pared).        i
-0000af40: 6620 2267 656f 6d65 7472 7922 2069 6e20  f "geometry" in 
-0000af50: 7265 7375 6c74 5f67 6466 2e63 6f6c 756d  result_gdf.colum
-0000af60: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
-0000af70: 636f 6c75 6d6e 735f 746f 5f6b 6565 7020  columns_to_keep 
-0000af80: 2b3d 205b 2267 656f 6d65 7472 7922 5d0a  += ["geometry"].
-0000af90: 2020 2020 2020 2020 7265 7375 6c74 5f67          result_g
-0000afa0: 6466 203d 2072 6573 756c 745f 6764 665b  df = result_gdf[
-0000afb0: 636f 6c75 6d6e 735f 746f 5f6b 6565 705d  columns_to_keep]
-0000afc0: 0a20 2020 2020 2020 2072 6573 756c 745f  .        result_
-0000afd0: 6764 6620 3d20 7265 7375 6c74 5f67 6466  gdf = result_gdf
-0000afe0: 2e72 656e 616d 6528 636f 6c75 6d6e 733d  .rename(columns=
-0000aff0: 636f 6c75 6d6e 735f 7072 6570 6172 6564  columns_prepared
-0000b000: 290a 0a20 2020 2023 2053 7461 7274 696e  )..    # Startin
-0000b010: 6720 6672 6f6d 2066 696f 6e61 2031 2e39  g from fiona 1.9
-0000b020: 2c20 7374 7269 6e67 2063 6f6c 756d 6e73  , string columns
-0000b030: 2077 6974 6820 616c 6c20 4e6f 6e65 2076   with all None v
-0000b040: 616c 7565 7320 6172 6520 7265 6164 2061  alues are read a
-0000b050: 7320 6265 696e 670a 2020 2020 2320 666c  s being.    # fl
-0000b060: 6f61 7420 636f 6c75 6d6e 732e 2043 6f6e  oat columns. Con
-0000b070: 7665 7274 2074 6865 6d20 746f 206f 626a  vert them to obj
-0000b080: 6563 7420 7479 7065 2e0a 2020 2020 666c  ect type..    fl
-0000b090: 6f61 745f 636f 6c73 203d 206c 6973 7428  oat_cols = list(
-0000b0a0: 7265 7375 6c74 5f67 6466 2e73 656c 6563  result_gdf.selec
-0000b0b0: 745f 6474 7970 6573 285b 2266 6c6f 6174  t_dtypes(["float
-0000b0c0: 3634 225d 292e 636f 6c75 6d6e 7329 0a20  64"]).columns). 
-0000b0d0: 2020 2069 6620 6c65 6e28 666c 6f61 745f     if len(float_
-0000b0e0: 636f 6c73 2920 3e20 303a 0a20 2020 2020  cols) > 0:.     
-0000b0f0: 2020 2023 2043 6865 636b 2066 6f72 2061     # Check for a
-0000b100: 6c6c 2066 6c6f 6174 2063 6f6c 756d 6e73  ll float columns
-0000b110: 2066 6f75 6e64 2069 6620 7468 6579 2073   found if they s
-0000b120: 686f 756c 6420 6265 206f 626a 6563 7420  hould be object 
-0000b130: 636f 6c75 6d6e 7320 696e 7374 6561 640a  columns instead.
-0000b140: 2020 2020 2020 2020 7769 7468 2066 696f          with fio
-0000b150: 6e61 2e6f 7065 6e28 7061 7468 2c20 6c61  na.open(path, la
-0000b160: 7965 723d 6c61 7965 7229 2061 7320 636f  yer=layer) as co
-0000b170: 6c6c 6563 7469 6f6e 3a0a 2020 2020 2020  llection:.      
-0000b180: 2020 2020 2020 6173 7365 7274 2063 6f6c        assert col
-0000b190: 6c65 6374 696f 6e2e 7363 6865 6d61 2069  lection.schema i
-0000b1a0: 7320 6e6f 7420 4e6f 6e65 0a20 2020 2020  s not None.     
-0000b1b0: 2020 2020 2020 2070 726f 7065 7274 6965         propertie
-0000b1c0: 7320 3d20 636f 6c6c 6563 7469 6f6e 2e73  s = collection.s
-0000b1d0: 6368 656d 615b 2270 726f 7065 7274 6965  chema["propertie
-0000b1e0: 7322 5d0a 2020 2020 2020 2020 2020 2020  s"].            
-0000b1f0: 666f 7220 636f 6c20 696e 2066 6c6f 6174  for col in float
-0000b200: 5f63 6f6c 733a 0a20 2020 2020 2020 2020  _cols:.         
-0000b210: 2020 2020 2020 2069 6620 636f 6c20 696e         if col in
-0000b220: 2070 726f 7065 7274 6965 7320 616e 6420   properties and 
-0000b230: 7072 6f70 6572 7469 6573 5b63 6f6c 5d2e  properties[col].
-0000b240: 7374 6172 7473 7769 7468 2822 7374 7222  startswith("str"
-0000b250: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0000b260: 2020 2020 2020 2072 6573 756c 745f 6764         result_gd
-0000b270: 665b 636f 6c5d 203d 2028 0a20 2020 2020  f[col] = (.     
-0000b280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b290: 2020 2072 6573 756c 745f 6764 665b 636f     result_gdf[co
-0000b2a0: 6c5d 2e61 7374 7970 6528 6f62 6a65 6374  l].astype(object
-0000b2b0: 292e 7265 706c 6163 6528 6e70 2e6e 616e  ).replace(np.nan
-0000b2c0: 2c20 4e6f 6e65 290a 2020 2020 2020 2020  , None).        
-0000b2d0: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-0000b2e0: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
-0000b2f0: 5f67 6466 0a0a 0a64 6566 205f 7265 6164  _gdf...def _read
-0000b300: 5f66 696c 655f 6261 7365 5f70 796f 6772  _file_base_pyogr
-0000b310: 696f 280a 2020 2020 7061 7468 3a20 556e  io(.    path: Un
-0000b320: 696f 6e5b 7374 722c 2022 6f73 2e50 6174  ion[str, "os.Pat
-0000b330: 684c 696b 655b 416e 795d 225d 2c0a 2020  hLike[Any]"],.  
-0000b340: 2020 6c61 7965 723a 204f 7074 696f 6e61    layer: Optiona
-0000b350: 6c5b 7374 725d 203d 204e 6f6e 652c 0a20  l[str] = None,. 
-0000b360: 2020 2063 6f6c 756d 6e73 3a20 4f70 7469     columns: Opti
-0000b370: 6f6e 616c 5b49 7465 7261 626c 655b 7374  onal[Iterable[st
-0000b380: 725d 5d20 3d20 4e6f 6e65 2c0a 2020 2020  r]] = None,.    
-0000b390: 6262 6f78 3d4e 6f6e 652c 0a20 2020 2072  bbox=None,.    r
-0000b3a0: 6f77 733d 4e6f 6e65 2c0a 2020 2020 7768  ows=None,.    wh
-0000b3b0: 6572 653a 204f 7074 696f 6e61 6c5b 7374  ere: Optional[st
-0000b3c0: 725d 203d 204e 6f6e 652c 0a20 2020 2073  r] = None,.    s
-0000b3d0: 716c 5f73 746d 743a 204f 7074 696f 6e61  ql_stmt: Optiona
-0000b3e0: 6c5b 7374 725d 203d 204e 6f6e 652c 0a20  l[str] = None,. 
-0000b3f0: 2020 2073 716c 5f64 6961 6c65 6374 3a20     sql_dialect: 
-0000b400: 4f70 7469 6f6e 616c 5b4c 6974 6572 616c  Optional[Literal
-0000b410: 5b22 5351 4c49 5445 222c 2022 4f47 5253  ["SQLITE", "OGRS
-0000b420: 514c 225d 5d20 3d20 4e6f 6e65 2c0a 2020  QL"]] = None,.  
-0000b430: 2020 6967 6e6f 7265 5f67 656f 6d65 7472    ignore_geometr
-0000b440: 793a 2062 6f6f 6c20 3d20 4661 6c73 652c  y: bool = False,
-0000b450: 0a20 2020 2066 6964 5f61 735f 696e 6465  .    fid_as_inde
-0000b460: 783a 2062 6f6f 6c20 3d20 4661 6c73 652c  x: bool = False,
-0000b470: 0a29 202d 3e20 556e 696f 6e5b 7064 2e44  .) -> Union[pd.D
-0000b480: 6174 6146 7261 6d65 2c20 6770 642e 4765  ataFrame, gpd.Ge
-0000b490: 6f44 6174 6146 7261 6d65 5d3a 0a20 2020  oDataFrame]:.   
-0000b4a0: 2022 2222 0a20 2020 2052 6561 6473 2061   """.    Reads a
-0000b4b0: 2066 696c 6520 746f 2061 2070 616e 6461   file to a panda
-0000b4c0: 7320 4461 7461 6672 616d 6520 7573 696e  s Dataframe usin
-0000b4d0: 6720 7079 6f67 7269 6f2e 0a20 2020 2022  g pyogrio..    "
-0000b4e0: 2222 0a20 2020 2023 2049 6e69 740a 2020  "".    # Init.  
-0000b4f0: 2020 7061 7468 203d 2050 6174 6828 7061    path = Path(pa
-0000b500: 7468 290a 2020 2020 6966 2070 6174 682e  th).    if path.
-0000b510: 6578 6973 7473 2829 2069 7320 4661 6c73  exists() is Fals
-0000b520: 653a 0a20 2020 2020 2020 2072 6169 7365  e:.        raise
-0000b530: 2056 616c 7565 4572 726f 7228 6622 6669   ValueError(f"fi
-0000b540: 6c65 2064 6f65 736e 2774 2065 7869 7374  le doesn't exist
-0000b550: 3a20 7b70 6174 687d 2229 0a0a 2020 2020  : {path}")..    
-0000b560: 2320 436f 6e76 6572 7420 726f 7773 2073  # Convert rows s
-0000b570: 6c69 6365 206f 626a 6563 7420 746f 2070  lice object to p
-0000b580: 796f 6772 696f 2070 6172 616d 6574 6572  yogrio parameter
-0000b590: 730a 2020 2020 6966 2072 6f77 7320 6973  s.    if rows is
-0000b5a0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-0000b5b0: 2020 2073 6b69 705f 6665 6174 7572 6573     skip_features
-0000b5c0: 203d 2072 6f77 732e 7374 6172 740a 2020   = rows.start.  
-0000b5d0: 2020 2020 2020 6d61 785f 6665 6174 7572        max_featur
-0000b5e0: 6573 203d 2072 6f77 732e 7374 6f70 202d  es = rows.stop -
-0000b5f0: 2072 6f77 732e 7374 6172 740a 2020 2020   rows.start.    
-0000b600: 656c 7365 3a0a 2020 2020 2020 2020 736b  else:.        sk
-0000b610: 6970 5f66 6561 7475 7265 7320 3d20 300a  ip_features = 0.
-0000b620: 2020 2020 2020 2020 6d61 785f 6665 6174          max_feat
-0000b630: 7572 6573 203d 204e 6f6e 650a 2020 2020  ures = None.    
-0000b640: 2320 4172 726f 7720 646f 6573 6e27 7420  # Arrow doesn't 
-0000b650: 7375 7070 6f72 7420 6669 6c74 6572 696e  support filterin
-0000b660: 6720 726f 7773 206c 696b 6520 7468 6973  g rows like this
-0000b670: 0a20 2020 2023 2075 7365 5f61 7272 6f77  .    # use_arrow
-0000b680: 203d 2054 7275 6520 6966 2072 6f77 7320   = True if rows 
-0000b690: 6973 204e 6f6e 6520 656c 7365 2046 616c  is None else Fal
-0000b6a0: 7365 0a0a 2020 2020 2320 4966 206e 6f20  se..    # If no 
-0000b6b0: 7371 6c5f 7374 6d74 2073 7065 6369 6669  sql_stmt specifi
-0000b6c0: 6564 0a20 2020 2063 6f6c 756d 6e73 5f70  ed.    columns_p
-0000b6d0: 7265 7061 7265 6420 3d20 4e6f 6e65 0a20  repared = None. 
-0000b6e0: 2020 2069 6620 7371 6c5f 7374 6d74 2069     if sql_stmt i
-0000b6f0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-0000b700: 2320 4966 206e 6f20 6c61 7965 7220 7370  # If no layer sp
-0000b710: 6563 6966 6965 642c 2074 6865 7265 2073  ecified, there s
-0000b720: 686f 756c 6420 6265 206f 6e6c 7920 6f6e  hould be only on
-0000b730: 6520 6c61 7965 7220 696e 2074 6865 2066  e layer in the f
-0000b740: 696c 652e 0a20 2020 2020 2020 2069 6620  ile..        if 
-0000b750: 6c61 7965 7220 6973 204e 6f6e 653a 0a20  layer is None:. 
-0000b760: 2020 2020 2020 2020 2020 206c 6179 6572             layer
-0000b770: 203d 2067 6574 5f6f 6e6c 795f 6c61 7965   = get_only_laye
-0000b780: 7228 7061 7468 290a 0a20 2020 2020 2020  r(path)..       
-0000b790: 2023 2043 6865 636b 696e 6720 6966 2063   # Checking if c
-0000b7a0: 6f6c 756d 6e20 6e61 6d65 7320 7368 6f75  olumn names shou
-0000b7b0: 6c64 2062 6520 7265 6164 2069 7320 6361  ld be read is ca
-0000b7c0: 7365 2073 656e 7369 7469 7665 2069 6e20  se sensitive in 
-0000b7d0: 7079 6f67 7269 6f2c 2073 6f0a 2020 2020  pyogrio, so.    
-0000b7e0: 2020 2020 2320 6d61 6b65 2073 7572 6520      # make sure 
-0000b7f0: 7468 6520 636f 6c75 6d6e 206e 616d 6573  the column names
-0000b800: 2073 7065 6369 6669 6564 2068 6176 6520   specified have 
-0000b810: 7468 6520 7361 6d65 2063 6173 696e 672e  the same casing.
-0000b820: 0a20 2020 2020 2020 2069 6620 636f 6c75  .        if colu
-0000b830: 6d6e 7320 6973 206e 6f74 204e 6f6e 653a  mns is not None:
-0000b840: 0a20 2020 2020 2020 2020 2020 206c 6179  .            lay
-0000b850: 6572 696e 666f 203d 2067 6574 5f6c 6179  erinfo = get_lay
-0000b860: 6572 696e 666f 2870 6174 682c 206c 6179  erinfo(path, lay
-0000b870: 6572 3d6c 6179 6572 2c20 7261 6973 655f  er=layer, raise_
-0000b880: 6f6e 5f6e 6f67 656f 6d3d 4661 6c73 6529  on_nogeom=False)
-0000b890: 0a20 2020 2020 2020 2020 2020 2063 6f6c  .            col
-0000b8a0: 756d 6e73 5f75 7070 6572 5f6c 6f6f 6b75  umns_upper_looku
-0000b8b0: 7020 3d20 7b63 6f6c 756d 6e2e 7570 7065  p = {column.uppe
-0000b8c0: 7228 293a 2063 6f6c 756d 6e20 666f 7220  r(): column for 
-0000b8d0: 636f 6c75 6d6e 2069 6e20 636f 6c75 6d6e  column in column
-0000b8e0: 737d 0a20 2020 2020 2020 2020 2020 2063  s}.            c
-0000b8f0: 6f6c 756d 6e73 5f70 7265 7061 7265 6420  olumns_prepared 
-0000b900: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
-0000b910: 2020 2020 636f 6c75 6d6e 3a20 636f 6c75      column: colu
-0000b920: 6d6e 735f 7570 7065 725f 6c6f 6f6b 7570  mns_upper_lookup
-0000b930: 5b63 6f6c 756d 6e2e 7570 7065 7228 295d  [column.upper()]
-0000b940: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b950: 2066 6f72 2063 6f6c 756d 6e20 696e 206c   for column in l
-0000b960: 6179 6572 696e 666f 2e63 6f6c 756d 6e73  ayerinfo.columns
-0000b970: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b980: 2069 6620 636f 6c75 6d6e 2e75 7070 6572   if column.upper
-0000b990: 2829 2069 6e20 636f 6c75 6d6e 735f 7570  () in columns_up
-0000b9a0: 7065 725f 6c6f 6f6b 7570 0a20 2020 2020  per_lookup.     
-0000b9b0: 2020 2020 2020 207d 0a20 2020 2065 6c73         }.    els
-0000b9c0: 653a 0a20 2020 2020 2020 2023 2046 696c  e:.        # Fil
-0000b9d0: 6c20 6f75 7420 706c 6163 6568 6f6c 6465  l out placeholde
-0000b9e0: 7273 2c20 6b65 6570 2063 6f6c 756d 6e73  rs, keep columns
-0000b9f0: 5f70 7265 7061 7265 6420 4e6f 6e65 2062  _prepared None b
-0000ba00: 6563 6175 7365 2063 6f6c 756d 6e20 6669  ecause column fi
-0000ba10: 6c74 6572 696e 670a 2020 2020 2020 2020  ltering.        
-0000ba20: 2320 7368 6f75 6c64 2068 6170 7065 6e20  # should happen 
-0000ba30: 696e 2073 716c 5f73 746d 742e 0a20 2020  in sql_stmt..   
-0000ba40: 2020 2020 2073 716c 5f73 746d 7420 3d20       sql_stmt = 
-0000ba50: 5f66 696c 6c5f 6f75 745f 7371 6c5f 706c  _fill_out_sql_pl
-0000ba60: 6163 6568 6f6c 6465 7273 280a 2020 2020  aceholders(.    
-0000ba70: 2020 2020 2020 2020 7061 7468 3d70 6174          path=pat
-0000ba80: 682c 206c 6179 6572 3d6c 6179 6572 2c20  h, layer=layer, 
-0000ba90: 7371 6c5f 7374 6d74 3d73 716c 5f73 746d  sql_stmt=sql_stm
-0000baa0: 742c 2063 6f6c 756d 6e73 3d63 6f6c 756d  t, columns=colum
-0000bab0: 6e73 0a20 2020 2020 2020 2029 0a20 2020  ns.        ).   
-0000bac0: 2020 2020 2023 2053 7065 6369 6679 696e       # Specifyin
-0000bad0: 6720 6120 6c61 7965 7220 6173 2077 656c  g a layer as wel
-0000bae0: 6c20 6173 2061 6e20 5351 4c20 7374 6174  l as an SQL stat
-0000baf0: 656d 656e 7420 696e 2070 796f 6772 696f  ement in pyogrio
-0000bb00: 2069 7320 6e6f 7420 7375 7070 6f72 7465   is not supporte
-0000bb10: 642e 0a20 2020 2020 2020 206c 6179 6572  d..        layer
-0000bb20: 203d 204e 6f6e 650a 0a20 2020 2023 2052   = None..    # R
-0000bb30: 6561 6421 0a20 2020 2063 6f6c 756d 6e73  ead!.    columns
-0000bb40: 5f6c 6973 7420 3d20 4e6f 6e65 2069 6620  _list = None if 
-0000bb50: 636f 6c75 6d6e 735f 7072 6570 6172 6564  columns_prepared
-0000bb60: 2069 7320 4e6f 6e65 2065 6c73 6520 6c69   is None else li
-0000bb70: 7374 2863 6f6c 756d 6e73 5f70 7265 7061  st(columns_prepa
-0000bb80: 7265 6429 0a20 2020 2072 6573 756c 745f  red).    result_
-0000bb90: 6764 6620 3d20 7079 6f67 7269 6f2e 7265  gdf = pyogrio.re
-0000bba0: 6164 5f64 6174 6166 7261 6d65 280a 2020  ad_dataframe(.  
-0000bbb0: 2020 2020 2020 7061 7468 2c0a 2020 2020        path,.    
-0000bbc0: 2020 2020 6c61 7965 723d 6c61 7965 722c      layer=layer,
-0000bbd0: 0a20 2020 2020 2020 2063 6f6c 756d 6e73  .        columns
-0000bbe0: 3d63 6f6c 756d 6e73 5f6c 6973 742c 0a20  =columns_list,. 
-0000bbf0: 2020 2020 2020 2062 626f 783d 6262 6f78         bbox=bbox
-0000bc00: 2c0a 2020 2020 2020 2020 736b 6970 5f66  ,.        skip_f
-0000bc10: 6561 7475 7265 733d 736b 6970 5f66 6561  eatures=skip_fea
-0000bc20: 7475 7265 732c 0a20 2020 2020 2020 206d  tures,.        m
-0000bc30: 6178 5f66 6561 7475 7265 733d 6d61 785f  ax_features=max_
-0000bc40: 6665 6174 7572 6573 2c0a 2020 2020 2020  features,.      
-0000bc50: 2020 7768 6572 653d 7768 6572 652c 0a20    where=where,. 
-0000bc60: 2020 2020 2020 2073 716c 3d73 716c 5f73         sql=sql_s
-0000bc70: 746d 742c 0a20 2020 2020 2020 2073 716c  tmt,.        sql
-0000bc80: 5f64 6961 6c65 6374 3d73 716c 5f64 6961  _dialect=sql_dia
-0000bc90: 6c65 6374 2c0a 2020 2020 2020 2020 7265  lect,.        re
-0000bca0: 6164 5f67 656f 6d65 7472 793d 6e6f 7420  ad_geometry=not 
-0000bcb0: 6967 6e6f 7265 5f67 656f 6d65 7472 792c  ignore_geometry,
-0000bcc0: 0a20 2020 2020 2020 2066 6964 5f61 735f  .        fid_as_
-0000bcd0: 696e 6465 783d 6669 645f 6173 5f69 6e64  index=fid_as_ind
-0000bce0: 6578 2c0a 2020 2020 2020 2020 2320 7573  ex,.        # us
-0000bcf0: 655f 6172 726f 773d 7573 655f 6172 726f  e_arrow=use_arro
-0000bd00: 772c 0a20 2020 2029 0a0a 2020 2020 2320  w,.    )..    # 
-0000bd10: 5265 6f72 6465 7220 636f 6c75 6d6e 7320  Reorder columns 
-0000bd20: 2b20 6368 616e 6765 2063 6173 696e 6720  + change casing 
-0000bd30: 736f 2074 6865 7920 6172 6520 7468 6520  so they are the 
-0000bd40: 7361 6d65 2061 7320 636f 6c75 6d6e 7320  same as columns 
-0000bd50: 7061 7261 6d65 7465 720a 2020 2020 6966  parameter.    if
-0000bd60: 2063 6f6c 756d 6e73 5f70 7265 7061 7265   columns_prepare
-0000bd70: 6420 6973 206e 6f74 204e 6f6e 6520 616e  d is not None an
-0000bd80: 6420 6c65 6e28 636f 6c75 6d6e 735f 7072  d len(columns_pr
-0000bd90: 6570 6172 6564 2920 3e20 303a 0a20 2020  epared) > 0:.   
-0000bda0: 2020 2020 2063 6f6c 756d 6e73 5f74 6f5f       columns_to_
-0000bdb0: 6b65 6570 203d 206c 6973 7428 636f 6c75  keep = list(colu
-0000bdc0: 6d6e 735f 7072 6570 6172 6564 290a 2020  mns_prepared).  
-0000bdd0: 2020 2020 2020 6966 206c 6179 6572 696e        if layerin
-0000bde0: 666f 2e67 656f 6d65 7472 7963 6f6c 756d  fo.geometrycolum
-0000bdf0: 6e20 6973 206e 6f74 204e 6f6e 6520 616e  n is not None an
-0000be00: 6420 6e6f 7420 6967 6e6f 7265 5f67 656f  d not ignore_geo
-0000be10: 6d65 7472 793a 0a20 2020 2020 2020 2020  metry:.         
-0000be20: 2020 2063 6f6c 756d 6e73 5f74 6f5f 6b65     columns_to_ke
-0000be30: 6570 202b 3d20 5b22 6765 6f6d 6574 7279  ep += ["geometry
-0000be40: 225d 0a20 2020 2020 2020 2072 6573 756c  "].        resul
-0000be50: 745f 6764 6620 3d20 7265 7375 6c74 5f67  t_gdf = result_g
-0000be60: 6466 5b63 6f6c 756d 6e73 5f74 6f5f 6b65  df[columns_to_ke
-0000be70: 6570 5d0a 2020 2020 2020 2020 7265 7375  ep].        resu
-0000be80: 6c74 5f67 6466 203d 2072 6573 756c 745f  lt_gdf = result_
-0000be90: 6764 662e 7265 6e61 6d65 2863 6f6c 756d  gdf.rename(colum
-0000bea0: 6e73 3d63 6f6c 756d 6e73 5f70 7265 7061  ns=columns_prepa
-0000beb0: 7265 6429 0a0a 2020 2020 2320 4361 7374  red)..    # Cast
-0000bec0: 2063 6f6c 756d 6e73 2074 6861 7420 6172   columns that ar
-0000bed0: 6520 6f66 206f 626a 6563 7420 7479 7065  e of object type
-0000bee0: 2c20 6275 7420 636f 6e74 6169 6e20 6461  , but contain da
-0000bef0: 7465 7469 6d65 2e64 6174 6520 6f72 2064  tetime.date or d
-0000bf00: 6174 6574 696d 652e 6461 7465 0a20 2020  atetime.date.   
-0000bf10: 2023 2074 6f20 7072 6f70 6572 2064 6174   # to proper dat
-0000bf20: 6574 696d 6536 3420 636f 6c75 6d6e 732e  etime64 columns.
-0000bf30: 0a20 2020 2069 6620 6c65 6e28 7265 7375  .    if len(resu
-0000bf40: 6c74 5f67 6466 2920 3e20 303a 0a20 2020  lt_gdf) > 0:.   
-0000bf50: 2020 2020 2066 6f72 2063 6f6c 756d 6e20       for column 
-0000bf60: 696e 2072 6573 756c 745f 6764 662e 7365  in result_gdf.se
-0000bf70: 6c65 6374 5f64 7479 7065 7328 696e 636c  lect_dtypes(incl
-0000bf80: 7564 653d 5b22 6f62 6a65 6374 225d 293a  ude=["object"]):
-0000bf90: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0000bfa0: 6973 696e 7374 616e 6365 280a 2020 2020  isinstance(.    
-0000bfb0: 2020 2020 2020 2020 2020 2020 7265 7375              resu
-0000bfc0: 6c74 5f67 6466 5b63 6f6c 756d 6e5d 2e69  lt_gdf[column].i
-0000bfd0: 6c6f 635b 305d 2c20 2864 6174 6574 696d  loc[0], (datetim
-0000bfe0: 652e 6461 7465 2c20 6461 7465 7469 6d65  e.date, datetime
-0000bff0: 2e64 6174 6574 696d 6529 0a20 2020 2020  .datetime).     
-0000c000: 2020 2020 2020 2029 3a0a 2020 2020 2020         ):.      
-0000c010: 2020 2020 2020 2020 2020 7265 7375 6c74            result
-0000c020: 5f67 6466 5b63 6f6c 756d 6e5d 203d 2070  _gdf[column] = p
-0000c030: 642e 746f 5f64 6174 6574 696d 6528 7265  d.to_datetime(re
-0000c040: 7375 6c74 5f67 6466 5b63 6f6c 756d 6e5d  sult_gdf[column]
-0000c050: 290a 0a20 2020 2061 7373 6572 7420 6973  )..    assert is
-0000c060: 696e 7374 616e 6365 2872 6573 756c 745f  instance(result_
-0000c070: 6764 662c 2028 6770 642e 4765 6f44 6174  gdf, (gpd.GeoDat
-0000c080: 6146 7261 6d65 2c20 7064 2e44 6174 6146  aFrame, pd.DataF
-0000c090: 7261 6d65 2929 0a20 2020 2072 6574 7572  rame)).    retur
-0000c0a0: 6e20 7265 7375 6c74 5f67 6466 0a0a 0a64  n result_gdf...d
-0000c0b0: 6566 205f 6669 6c6c 5f6f 7574 5f73 716c  ef _fill_out_sql
-0000c0c0: 5f70 6c61 6365 686f 6c64 6572 7328 0a20  _placeholders(. 
-0000c0d0: 2020 2070 6174 683a 2050 6174 682c 206c     path: Path, l
-0000c0e0: 6179 6572 3a20 4f70 7469 6f6e 616c 5b73  ayer: Optional[s
-0000c0f0: 7472 5d2c 2073 716c 5f73 746d 743a 2073  tr], sql_stmt: s
-0000c100: 7472 2c20 636f 6c75 6d6e 733a 204f 7074  tr, columns: Opt
-0000c110: 696f 6e61 6c5b 4974 6572 6162 6c65 5b73  ional[Iterable[s
-0000c120: 7472 5d5d 0a29 202d 3e20 7374 723a 0a20  tr]].) -> str:. 
-0000c130: 2020 2023 2046 696c 6c20 6f75 7420 706c     # Fill out pl
-0000c140: 6163 6568 6f6c 6465 7273 2069 6e20 7468  aceholders in th
-0000c150: 6520 7371 6c5f 7374 6d74 2069 6620 6e65  e sql_stmt if ne
-0000c160: 6564 6564 3a0a 2020 2020 706c 6163 6568  eded:.    placeh
-0000c170: 6f6c 6465 7273 203d 205b 0a20 2020 2020  olders = [.     
-0000c180: 2020 206e 616d 6520 666f 7220 5f2c 206e     name for _, n
-0000c190: 616d 652c 205f 2c20 5f20 696e 2073 7472  ame, _, _ in str
-0000c1a0: 696e 672e 466f 726d 6174 7465 7228 292e  ing.Formatter().
-0000c1b0: 7061 7273 6528 7371 6c5f 7374 6d74 2920  parse(sql_stmt) 
-0000c1c0: 6966 206e 616d 650a 2020 2020 5d0a 2020  if name.    ].  
-0000c1d0: 2020 6c61 7965 725f 746d 7020 3d20 6c61    layer_tmp = la
-0000c1e0: 7965 720a 2020 2020 6c61 7965 7269 6e66  yer.    layerinf
-0000c1f0: 6f20 3d20 4e6f 6e65 0a20 2020 2066 6f72  o = None.    for
-0000c200: 6d61 745f 6b77 6172 6773 3a20 4469 6374  mat_kwargs: Dict
-0000c210: 5b73 7472 2c20 416e 795d 203d 207b 7d0a  [str, Any] = {}.
-0000c220: 2020 2020 666f 7220 706c 6163 6568 6f6c      for placehol
-0000c230: 6465 7220 696e 2070 6c61 6365 686f 6c64  der in placehold
-0000c240: 6572 733a 0a20 2020 2020 2020 2069 6620  ers:.        if 
-0000c250: 6c61 7965 725f 746d 7020 6973 204e 6f6e  layer_tmp is Non
-0000c260: 653a 0a20 2020 2020 2020 2020 2020 206c  e:.            l
-0000c270: 6179 6572 5f74 6d70 203d 2067 6574 5f6f  ayer_tmp = get_o
-0000c280: 6e6c 795f 6c61 7965 7228 7061 7468 290a  nly_layer(path).
-0000c290: 0a20 2020 2020 2020 2069 6620 706c 6163  .        if plac
-0000c2a0: 6568 6f6c 6465 7220 3d3d 2022 696e 7075  eholder == "inpu
-0000c2b0: 745f 6c61 7965 7222 3a0a 2020 2020 2020  t_layer":.      
-0000c2c0: 2020 2020 2020 666f 726d 6174 5f6b 7761        format_kwa
-0000c2d0: 7267 735b 706c 6163 6568 6f6c 6465 725d  rgs[placeholder]
-0000c2e0: 203d 206c 6179 6572 5f74 6d70 0a20 2020   = layer_tmp.   
-0000c2f0: 2020 2020 2065 6c69 6620 706c 6163 6568       elif placeh
-0000c300: 6f6c 6465 7220 3d3d 2022 6765 6f6d 6574  older == "geomet
-0000c310: 7279 636f 6c75 6d6e 223a 0a20 2020 2020  rycolumn":.     
-0000c320: 2020 2020 2020 2069 6620 6c61 7965 7269         if layeri
-0000c330: 6e66 6f20 6973 204e 6f6e 653a 0a20 2020  nfo is None:.   
-0000c340: 2020 2020 2020 2020 2020 2020 206c 6179               lay
-0000c350: 6572 696e 666f 203d 2067 6574 5f6c 6179  erinfo = get_lay
-0000c360: 6572 696e 666f 2870 6174 682c 206c 6179  erinfo(path, lay
-0000c370: 6572 5f74 6d70 290a 2020 2020 2020 2020  er_tmp).        
-0000c380: 2020 2020 666f 726d 6174 5f6b 7761 7267      format_kwarg
-0000c390: 735b 706c 6163 6568 6f6c 6465 725d 203d  s[placeholder] =
-0000c3a0: 206c 6179 6572 696e 666f 2e67 656f 6d65   layerinfo.geome
-0000c3b0: 7472 7963 6f6c 756d 6e0a 2020 2020 2020  trycolumn.      
-0000c3c0: 2020 656c 6966 2070 6c61 6365 686f 6c64    elif placehold
-0000c3d0: 6572 203d 3d20 2263 6f6c 756d 6e73 5f74  er == "columns_t
-0000c3e0: 6f5f 7365 6c65 6374 5f73 7472 223a 0a20  o_select_str":. 
-0000c3f0: 2020 2020 2020 2020 2020 2069 6620 6c61             if la
-0000c400: 7965 7269 6e66 6f20 6973 204e 6f6e 653a  yerinfo is None:
-0000c410: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c420: 206c 6179 6572 696e 666f 203d 2067 6574   layerinfo = get
-0000c430: 5f6c 6179 6572 696e 666f 2870 6174 682c  _layerinfo(path,
-0000c440: 206c 6179 6572 5f74 6d70 290a 2020 2020   layer_tmp).    
-0000c450: 2020 2020 2020 2020 636f 6c75 6d6e 735f          columns_
-0000c460: 6173 6b65 6420 3d20 4e6f 6e65 2069 6620  asked = None if 
-0000c470: 636f 6c75 6d6e 7320 6973 204e 6f6e 6520  columns is None 
-0000c480: 656c 7365 206c 6973 7428 636f 6c75 6d6e  else list(column
-0000c490: 7329 0a20 2020 2020 2020 2020 2020 2066  s).            f
-0000c4a0: 6f72 6d61 7474 6572 203d 205f 6f67 725f  ormatter = _ogr_
-0000c4b0: 7371 6c5f 7574 696c 2e43 6f6c 756d 6e46  sql_util.ColumnF
-0000c4c0: 6f72 6d61 7474 6572 280a 2020 2020 2020  ormatter(.      
-0000c4d0: 2020 2020 2020 2020 2020 636f 6c75 6d6e            column
-0000c4e0: 735f 6173 6b65 643d 636f 6c75 6d6e 735f  s_asked=columns_
-0000c4f0: 6173 6b65 642c 0a20 2020 2020 2020 2020  asked,.         
-0000c500: 2020 2020 2020 2063 6f6c 756d 6e73 5f69         columns_i
-0000c510: 6e5f 6c61 7965 723d 6c61 7965 7269 6e66  n_layer=layerinf
-0000c520: 6f2e 636f 6c75 6d6e 732c 0a20 2020 2020  o.columns,.     
-0000c530: 2020 2020 2020 2020 2020 2066 6964 5f63             fid_c
-0000c540: 6f6c 756d 6e3d 6c61 7965 7269 6e66 6f2e  olumn=layerinfo.
-0000c550: 6669 645f 636f 6c75 6d6e 2c0a 2020 2020  fid_column,.    
-0000c560: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0000c570: 2020 2020 2020 666f 726d 6174 5f6b 7761        format_kwa
-0000c580: 7267 735b 706c 6163 6568 6f6c 6465 725d  rgs[placeholder]
-0000c590: 203d 2066 6f72 6d61 7474 6572 2e70 7265   = formatter.pre
-0000c5a0: 6669 7865 645f 616c 6961 7365 6428 290a  fixed_aliased().
-0000c5b0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-0000c5c0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0000c5d0: 2056 616c 7565 4572 726f 7228 0a20 2020   ValueError(.   
-0000c5e0: 2020 2020 2020 2020 2020 2020 2066 2275               f"u
-0000c5f0: 6e6b 6e6f 776e 2070 6c61 6365 686f 6c64  nknown placehold
-0000c600: 6572 207b 706c 6163 6568 6f6c 6465 727d  er {placeholder}
-0000c610: 2069 6e20 7371 6c5f 7374 6d74 3a20 7b73   in sql_stmt: {s
-0000c620: 716c 5f73 746d 747d 220a 2020 2020 2020  ql_stmt}".      
-0000c630: 2020 2020 2020 290a 0a20 2020 2069 6620        )..    if 
-0000c640: 6c65 6e28 666f 726d 6174 5f6b 7761 7267  len(format_kwarg
-0000c650: 7329 203e 2030 3a0a 2020 2020 2020 2020  s) > 0:.        
-0000c660: 7371 6c5f 7374 6d74 203d 2073 716c 5f73  sql_stmt = sql_s
-0000c670: 746d 742e 666f 726d 6174 282a 2a66 6f72  tmt.format(**for
-0000c680: 6d61 745f 6b77 6172 6773 290a 2020 2020  mat_kwargs).    
-0000c690: 7265 7475 726e 2073 716c 5f73 746d 740a  return sql_stmt.
-0000c6a0: 0a0a 6465 6620 7265 6164 5f66 696c 655f  ..def read_file_
-0000c6b0: 7371 6c28 0a20 2020 2070 6174 683a 2055  sql(.    path: U
-0000c6c0: 6e69 6f6e 5b73 7472 2c20 226f 732e 5061  nion[str, "os.Pa
-0000c6d0: 7468 4c69 6b65 5b41 6e79 5d22 5d2c 0a20  thLike[Any]"],. 
-0000c6e0: 2020 2073 716c 5f73 746d 743a 2073 7472     sql_stmt: str
-0000c6f0: 2c0a 2020 2020 7371 6c5f 6469 616c 6563  ,.    sql_dialec
-0000c700: 743a 204f 7074 696f 6e61 6c5b 4c69 7465  t: Optional[Lite
-0000c710: 7261 6c5b 2253 514c 4954 4522 2c20 224f  ral["SQLITE", "O
-0000c720: 4752 5351 4c22 5d5d 203d 2022 5351 4c49  GRSQL"]] = "SQLI
-0000c730: 5445 222c 0a20 2020 206c 6179 6572 3a20  TE",.    layer: 
-0000c740: 4f70 7469 6f6e 616c 5b73 7472 5d20 3d20  Optional[str] = 
-0000c750: 4e6f 6e65 2c0a 2020 2020 6967 6e6f 7265  None,.    ignore
-0000c760: 5f67 656f 6d65 7472 793a 2062 6f6f 6c20  _geometry: bool 
-0000c770: 3d20 4661 6c73 652c 0a29 202d 3e20 556e  = False,.) -> Un
-0000c780: 696f 6e5b 7064 2e44 6174 6146 7261 6d65  ion[pd.DataFrame
-0000c790: 2c20 6770 642e 4765 6f44 6174 6146 7261  , gpd.GeoDataFra
-0000c7a0: 6d65 5d3a 0a20 2020 2022 2222 0a20 2020  me]:.    """.   
-0000c7b0: 2044 4550 5245 4341 5445 443a 2052 6561   DEPRECATED: Rea
-0000c7c0: 6473 2061 2066 696c 6520 7573 696e 6720  ds a file using 
-0000c7d0: 616e 2053 514c 2073 7461 7465 6d65 6e74  an SQL statement
-0000c7e0: 2e0a 0a20 2020 2041 7267 733a 0a20 2020  ...    Args:.   
-0000c7f0: 2020 2020 2070 6174 6820 2866 696c 6520       path (file 
-0000c800: 7061 7468 293a 2070 6174 6820 746f 2074  path): path to t
-0000c810: 6865 2066 696c 6520 746f 2072 6561 6420  he file to read 
-0000c820: 6672 6f6d 0a20 2020 2020 2020 2073 716c  from.        sql
-0000c830: 5f73 746d 7420 2873 7472 293a 2053 514c  _stmt (str): SQL
-0000c840: 2073 7461 7465 6d65 6e74 2074 6f20 7573   statement to us
-0000c850: 650a 2020 2020 2020 2020 7371 6c5f 6469  e.        sql_di
-0000c860: 616c 6563 7420 2873 7472 2c20 6f70 7469  alect (str, opti
-0000c870: 6f6e 616c 293a 2053 514c 2064 6961 6c65  onal): SQL diale
-0000c880: 6374 2075 7365 642e 2044 6566 6175 6c74  ct used. Default
-0000c890: 7320 746f 2027 5351 4c49 5445 272e 0a20  s to 'SQLITE'.. 
-0000c8a0: 2020 2020 2020 206c 6179 6572 2028 7374         layer (st
-0000c8b0: 722c 206f 7074 696f 6e61 6c29 3a20 5468  r, optional): Th
-0000c8c0: 6520 6c61 7965 7220 746f 2072 6561 642e  e layer to read.
-0000c8d0: 2049 6620 6e6f 206c 6179 6572 2069 7320   If no layer is 
-0000c8e0: 7370 6563 6966 6965 642c 0a20 2020 2020  specified,.     
-0000c8f0: 2020 2020 2020 2072 6561 6473 2074 6865         reads the
-0000c900: 206f 6e6c 7920 6c61 7965 7220 696e 2074   only layer in t
-0000c910: 6865 2066 696c 6520 6f72 2074 6872 6f77  he file or throw
-0000c920: 7320 616e 2045 7863 6570 7469 6f6e 2e0a  s an Exception..
-0000c930: 2020 2020 2020 2020 6967 6e6f 7265 5f67          ignore_g
-0000c940: 656f 6d65 7472 7920 2862 6f6f 6c2c 206f  eometry (bool, o
-0000c950: 7074 696f 6e61 6c29 3a20 5472 7565 206e  ptional): True n
-0000c960: 6f74 2074 6f20 7265 6164 2f72 6574 7572  ot to read/retur
-0000c970: 6e20 7468 6520 6765 6f6d 6174 7279 2e0a  n the geomatry..
-0000c980: 2020 2020 2020 2020 2020 2020 4465 6661              Defa
-0000c990: 756c 7473 2074 6f20 4661 6c73 652e 0a0a  ults to False...
-0000c9a0: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
-0000c9b0: 2020 2020 2055 6e69 6f6e 5b70 642e 4461       Union[pd.Da
-0000c9c0: 7461 4672 616d 652c 2067 7064 2e47 656f  taFrame, gpd.Geo
-0000c9d0: 4461 7461 4672 616d 655d 3a20 5468 6520  DataFrame]: The 
-0000c9e0: 6461 7461 2072 6561 642e 0a20 2020 2022  data read..    "
-0000c9f0: 2222 0a20 2020 2077 6172 6e69 6e67 732e  "".    warnings.
-0000ca00: 7761 726e 280a 2020 2020 2020 2020 2772  warn(.        'r
-0000ca10: 6561 645f 6669 6c65 5f73 716c 2069 7320  ead_file_sql is 
-0000ca20: 6465 7072 6563 6174 6564 3a20 7573 6520  deprecated: use 
-0000ca30: 7265 6164 5f66 696c 6521 204d 696e 643a  read_file! Mind:
-0000ca40: 2073 716c 5f64 6961 6c65 6374 2069 7320   sql_dialect is 
-0000ca50: 6e6f 7420 2253 514c 4954 4522 2027 0a20  not "SQLITE" '. 
-0000ca60: 2020 2020 2020 2022 6279 2064 6566 6175         "by defau
-0000ca70: 6c74 2074 6865 7265 2122 2c0a 2020 2020  lt there!",.    
-0000ca80: 2020 2020 4675 7475 7265 5761 726e 696e      FutureWarnin
-0000ca90: 672c 0a20 2020 2020 2020 2073 7461 636b  g,.        stack
-0000caa0: 6c65 7665 6c3d 322c 0a20 2020 2029 0a0a  level=2,.    )..
-0000cab0: 2020 2020 2320 5275 6e0a 2020 2020 7265      # Run.    re
-0000cac0: 7475 726e 205f 7265 6164 5f66 696c 655f  turn _read_file_
-0000cad0: 6261 7365 280a 2020 2020 2020 2020 7061  base(.        pa
-0000cae0: 7468 2c0a 2020 2020 2020 2020 7371 6c5f  th,.        sql_
-0000caf0: 7374 6d74 3d73 716c 5f73 746d 742c 0a20  stmt=sql_stmt,. 
-0000cb00: 2020 2020 2020 2073 716c 5f64 6961 6c65         sql_diale
-0000cb10: 6374 3d73 716c 5f64 6961 6c65 6374 2c0a  ct=sql_dialect,.
-0000cb20: 2020 2020 2020 2020 6c61 7965 723d 6c61          layer=la
-0000cb30: 7965 722c 0a20 2020 2020 2020 2069 676e  yer,.        ign
-0000cb40: 6f72 655f 6765 6f6d 6574 7279 3d69 676e  ore_geometry=ign
-0000cb50: 6f72 655f 6765 6f6d 6574 7279 2c0a 2020  ore_geometry,.  
-0000cb60: 2020 290a 0a0a 6465 6620 746f 5f66 696c    )...def to_fil
-0000cb70: 6528 0a20 2020 2067 6466 3a20 556e 696f  e(.    gdf: Unio
-0000cb80: 6e5b 7064 2e44 6174 6146 7261 6d65 2c20  n[pd.DataFrame, 
-0000cb90: 6770 642e 4765 6f44 6174 6146 7261 6d65  gpd.GeoDataFrame
-0000cba0: 5d2c 0a20 2020 2070 6174 683a 2055 6e69  ],.    path: Uni
-0000cbb0: 6f6e 5b73 7472 2c20 226f 732e 5061 7468  on[str, "os.Path
-0000cbc0: 4c69 6b65 5b41 6e79 5d22 5d2c 0a20 2020  Like[Any]"],.   
-0000cbd0: 206c 6179 6572 3a20 4f70 7469 6f6e 616c   layer: Optional
-0000cbe0: 5b73 7472 5d20 3d20 4e6f 6e65 2c0a 2020  [str] = None,.  
-0000cbf0: 2020 666f 7263 655f 6f75 7470 7574 5f67    force_output_g
-0000cc00: 656f 6d65 7472 7974 7970 653a 2055 6e69  eometrytype: Uni
-0000cc10: 6f6e 5b47 656f 6d65 7472 7954 7970 652c  on[GeometryType,
-0000cc20: 2073 7472 2c20 4e6f 6e65 5d20 3d20 4e6f   str, None] = No
-0000cc30: 6e65 2c0a 2020 2020 666f 7263 655f 6d75  ne,.    force_mu
-0000cc40: 6c74 6974 7970 653a 2062 6f6f 6c20 3d20  ltitype: bool = 
-0000cc50: 4661 6c73 652c 0a20 2020 2061 7070 656e  False,.    appen
-0000cc60: 643a 2062 6f6f 6c20 3d20 4661 6c73 652c  d: bool = False,
-0000cc70: 0a20 2020 2061 7070 656e 645f 7469 6d65  .    append_time
-0000cc80: 6f75 745f 733a 2069 6e74 203d 2036 3030  out_s: int = 600
-0000cc90: 2c0a 2020 2020 696e 6465 783a 204f 7074  ,.    index: Opt
-0000cca0: 696f 6e61 6c5b 626f 6f6c 5d20 3d20 4e6f  ional[bool] = No
-0000ccb0: 6e65 2c0a 2020 2020 6372 6561 7465 5f73  ne,.    create_s
-0000ccc0: 7061 7469 616c 5f69 6e64 6578 3a20 4f70  patial_index: Op
-0000ccd0: 7469 6f6e 616c 5b62 6f6f 6c5d 203d 2054  tional[bool] = T
-0000cce0: 7275 652c 0a29 3a0a 2020 2020 2222 220a  rue,.):.    """.
-0000ccf0: 2020 2020 5772 6974 6573 2061 2070 616e      Writes a pan
-0000cd00: 6461 7320 6461 7461 6672 616d 6520 746f  das dataframe to
-0000cd10: 2066 696c 652e 0a0a 2020 2020 5468 6520   file...    The 
-0000cd20: 6669 6c65 666f 726d 6174 2069 7320 6465  fileformat is de
-0000cd30: 7465 6374 6564 2062 6173 6564 206f 6e20  tected based on 
-0000cd40: 7468 6520 6669 6c65 7061 7468 2065 7874  the filepath ext
-0000cd50: 656e 7369 6f6e 2e0a 0a20 2020 2054 6865  ension...    The
-0000cd60: 2075 6e64 6572 6c79 696e 6720 6c69 6272   underlying libr
-0000cd70: 6172 7920 7573 6564 2074 6f20 7772 6974  ary used to writ
-0000cd80: 6520 7468 6520 6669 6c65 2063 616e 2062  e the file can b
-0000cd90: 6520 6368 6f6f 7365 6e20 7573 696e 6720  e choosen using 
-0000cda0: 7468 650a 2020 2020 2247 464f 5f49 4f5f  the.    "GFO_IO_
-0000cdb0: 454e 4749 4e45 2220 656e 7669 726f 6e6d  ENGINE" environm
-0000cdc0: 656e 7420 7661 7269 6162 6c65 2e20 506f  ent variable. Po
-0000cdd0: 7373 6962 6c65 2076 616c 7565 7320 6172  ssible values ar
-0000cde0: 6520 2266 696f 6e61 2220 616e 6420 2270  e "fiona" and "p
-0000cdf0: 796f 6772 696f 222e 0a20 2020 2044 6566  yogrio"..    Def
-0000ce00: 6175 6c74 2065 6e67 696e 6520 6973 2022  ault engine is "
-0000ce10: 7079 6f67 7269 6f22 2e0a 0a20 2020 2041  pyogrio"...    A
-0000ce20: 7267 733a 0a20 2020 2020 2020 2067 6466  rgs:.        gdf
-0000ce30: 2028 6770 642e 4765 6f44 6174 6146 7261   (gpd.GeoDataFra
-0000ce40: 6d65 293a 2054 6865 2047 656f 4461 7461  me): The GeoData
-0000ce50: 4672 616d 6520 746f 2065 7870 6f72 7420  Frame to export 
-0000ce60: 746f 2066 696c 652e 0a20 2020 2020 2020  to file..       
-0000ce70: 2070 6174 6820 2855 6e69 6f6e 5b73 7472   path (Union[str
-0000ce80: 2c29 3a20 5468 6520 6669 6c65 2070 6174  ,): The file pat
-0000ce90: 6820 746f 2077 7269 7465 2074 6f2e 0a20  h to write to.. 
-0000cea0: 2020 2020 2020 206c 6179 6572 2028 7374         layer (st
-0000ceb0: 722c 206f 7074 696f 6e61 6c29 3a20 5468  r, optional): Th
-0000cec0: 6520 6c61 7965 7220 746f 2072 6561 642e  e layer to read.
-0000ced0: 2049 6620 6e6f 206c 6179 6572 2069 7320   If no layer is 
-0000cee0: 7370 6563 6966 6965 642c 0a20 2020 2020  specified,.     
-0000cef0: 2020 2020 2020 2072 6561 6473 2074 6865         reads the
-0000cf00: 206f 6e6c 7920 6c61 7965 7220 696e 2074   only layer in t
-0000cf10: 6865 2066 696c 6520 6f72 2074 6872 6f77  he file or throw
-0000cf20: 7320 616e 2045 7863 6570 7469 6f6e 2e0a  s an Exception..
-0000cf30: 2020 2020 2020 2020 666f 7263 655f 6f75          force_ou
-0000cf40: 7470 7574 5f67 656f 6d65 7472 7974 7970  tput_geometrytyp
-0000cf50: 6520 2855 6e69 6f6e 5b47 656f 6d65 7472  e (Union[Geometr
-0000cf60: 7954 7970 652c 2073 7472 5d2c 206f 7074  yType, str], opt
-0000cf70: 696f 6e61 6c29 3a20 4765 6f6d 6574 7279  ional): Geometry
-0000cf80: 2074 7970 650a 2020 2020 2020 2020 2020   type.          
-0000cf90: 2020 746f 2028 7472 7920 746f 2920 666f    to (try to) fo
-0000cfa0: 7263 6520 7468 6520 6f75 7470 7574 2074  rce the output t
-0000cfb0: 6f2e 2044 6566 6175 6c74 7320 746f 204e  o. Defaults to N
-0000cfc0: 6f6e 652e 0a20 2020 2020 2020 2020 2020  one..           
-0000cfd0: 204d 6172 6b3a 2063 6f6d 7061 7265 6420   Mark: compared 
-0000cfe0: 746f 206f 7468 6572 2066 756e 6374 696f  to other functio
-0000cff0: 6e73 2069 6e20 6766 6f20 7769 7468 2074  ns in gfo with t
-0000d000: 6869 7320 7061 7261 6d65 7465 722c 2074  his parameter, t
-0000d010: 6865 2062 6568 6176 696f 7572 0a20 2020  he behaviour.   
-0000d020: 2020 2020 2020 2020 2068 6572 6520 6973           here is
-0000d030: 206c 696d 6974 6564 2074 6f20 7468 6520   limited to the 
-0000d040: 666f 6c6c 6f77 696e 673a 0a20 2020 2020  following:.     
-0000d050: 2020 2020 2020 2020 2020 202d 2066 6f72             - for
-0000d060: 2065 6d70 7479 2069 6e70 7574 2067 6466   empty input gdf
-0000d070: 2773 2c20 6120 7374 616e 6461 7264 2067  's, a standard g
-0000d080: 656f 6d65 7472 7920 7479 7065 2028 6567  eometry type (eg
-0000d090: 2e20 506f 6c79 676f 6e2c 2e2e 2e29 2063  . Polygon,...) c
-0000d0a0: 616e 0a20 2020 2020 2020 2020 2020 2020  an.             
-0000d0b0: 2020 2020 2062 6520 7573 6564 2074 6f20       be used to 
-0000d0c0: 666f 7263 6520 7468 6520 6765 6f6d 6574  force the geomet
-0000d0d0: 7279 2063 6f6c 756d 6e20 746f 2062 6520  ry column to be 
-0000d0e0: 6f66 2074 6861 7420 7479 7065 2e0a 2020  of that type..  
-0000d0f0: 2020 2020 2020 2020 2020 2020 2020 2d20                - 
-0000d100: 6966 2066 6f72 6365 5f6f 7574 7075 745f  if force_output_
-0000d110: 6765 6f6d 6574 7279 7479 7065 2069 7320  geometrytype is 
-0000d120: 6120 4d55 4c54 4920 7479 7065 2c20 7061  a MULTI type, pa
-0000d130: 7261 6d65 7465 720a 2020 2020 2020 2020  rameter.        
-0000d140: 2020 2020 2020 2020 2020 666f 7263 655f            force_
-0000d150: 6d75 6c74 6974 7970 6520 6265 636f 6d65  multitype become
-0000d160: 7320 5472 7565 2e0a 2020 2020 2020 2020  s True..        
-0000d170: 666f 7263 655f 6d75 6c74 6974 7970 6520  force_multitype 
-0000d180: 2862 6f6f 6c2c 206f 7074 696f 6e61 6c29  (bool, optional)
-0000d190: 3a20 666f 7263 6520 7468 6520 6765 6f6d  : force the geom
-0000d1a0: 6574 7279 2074 7970 6520 746f 2061 206d  etry type to a m
-0000d1b0: 756c 7469 7479 7065 0a20 2020 2020 2020  ultitype.       
-0000d1c0: 2020 2020 2066 6f72 2066 696c 6520 7479       for file ty
-0000d1d0: 7065 7320 7468 6174 2072 6571 7569 7265  pes that require
-0000d1e0: 206f 6e65 2067 656f 6d65 7472 7974 7970   one geometrytyp
-0000d1f0: 6520 7065 7220 6c61 7965 722e 0a20 2020  e per layer..   
-0000d200: 2020 2020 2020 2020 2044 6566 6175 6c74           Default
-0000d210: 7320 746f 2046 616c 7365 2e0a 2020 2020  s to False..    
-0000d220: 2020 2020 6170 7065 6e64 2028 626f 6f6c      append (bool
-0000d230: 2c20 6f70 7469 6f6e 616c 293a 2054 7275  , optional): Tru
-0000d240: 6520 746f 2061 7070 656e 6420 746f 2074  e to append to t
-0000d250: 6865 2066 696c 652f 6c61 7965 7220 6966  he file/layer if
-0000d260: 2069 7420 6578 6973 7473 2061 6c72 6561   it exists alrea
-0000d270: 6479 2e0a 2020 2020 2020 2020 2020 2020  dy..            
-0000d280: 4966 2069 7420 646f 6573 6e27 7420 6578  If it doesn't ex
-0000d290: 6973 7420 7965 742c 2069 7420 6973 2063  ist yet, it is c
-0000d2a0: 7265 6174 6564 2e20 4465 6661 756c 7473  reated. Defaults
-0000d2b0: 2074 6f20 4661 6c73 652e 0a20 2020 2020   to False..     
-0000d2c0: 2020 2061 7070 656e 645f 7469 6d65 6f75     append_timeou
-0000d2d0: 745f 7320 2869 6e74 2c20 6f70 7469 6f6e  t_s (int, option
-0000d2e0: 616c 293a 2054 6865 206d 6178 696d 756d  al): The maximum
-0000d2f0: 2074 696d 656f 7574 2074 6f20 7761 6974   timeout to wait
-0000d300: 2077 6865 6e20 7468 650a 2020 2020 2020   when the.      
-0000d310: 2020 2020 2020 6f75 7470 7574 2066 696c        output fil
-0000d320: 6520 6973 2061 6c72 6561 6479 2062 6569  e is already bei
-0000d330: 6e67 2077 7269 7474 656e 2074 6f20 6279  ng written to by
-0000d340: 2061 6e6f 7468 6572 2070 726f 6365 7373   another process
-0000d350: 2e0a 2020 2020 2020 2020 2020 2020 4465  ..            De
-0000d360: 6661 756c 7473 2074 6f20 3630 302e 0a20  faults to 600.. 
-0000d370: 2020 2020 2020 2069 6e64 6578 2028 626f         index (bo
-0000d380: 6f6c 2c20 6f70 7469 6f6e 616c 293a 2049  ol, optional): I
-0000d390: 6620 5472 7565 2c20 7772 6974 6520 696e  f True, write in
-0000d3a0: 6465 7820 696e 746f 206f 6e65 206f 7220  dex into one or 
-0000d3b0: 6d6f 7265 2063 6f6c 756d 6e73 2028 666f  more columns (fo
-0000d3c0: 720a 2020 2020 2020 2020 2020 2020 4d75  r.            Mu
-0000d3d0: 6c74 6949 6e64 6578 292e 204e 6f6e 6520  ltiIndex). None 
-0000d3e0: 7772 6974 6573 2074 6865 2069 6e64 6578  writes the index
-0000d3f0: 2069 6e74 6f20 6f6e 6520 6f72 206d 6f72   into one or mor
-0000d400: 6520 636f 6c75 6d6e 7320 6f6e 6c79 2069  e columns only i
-0000d410: 6620 7468 650a 2020 2020 2020 2020 2020  f the.          
-0000d420: 2020 696e 6465 7820 6973 206e 616d 6564    index is named
-0000d430: 2c20 6973 2061 204d 756c 7469 496e 6465  , is a MultiInde
-0000d440: 782c 206f 7220 6861 7320 6120 6e6f 6e2d  x, or has a non-
-0000d450: 696e 7465 6765 7220 6461 7461 2074 7970  integer data typ
-0000d460: 652e 0a20 2020 2020 2020 2020 2020 2049  e..            I
-0000d470: 6620 4661 6c73 652c 206e 6f20 696e 6465  f False, no inde
-0000d480: 7820 6973 2077 7269 7474 656e 2e20 4465  x is written. De
-0000d490: 6661 756c 7473 2074 6f20 4e6f 6e65 2e0a  faults to None..
-0000d4a0: 2020 2020 2020 2020 6372 6561 7465 5f73          create_s
-0000d4b0: 7061 7469 616c 5f69 6e64 6578 2028 626f  patial_index (bo
-0000d4c0: 6f6c 2c20 6f70 7469 6f6e 616c 293a 2054  ol, optional): T
-0000d4d0: 7275 6520 746f 2066 6f72 6365 2063 7265  rue to force cre
-0000d4e0: 6174 696f 6e20 6f66 2073 7061 7469 616c  ation of spatial
-0000d4f0: 2069 6e64 6578 2c0a 2020 2020 2020 2020   index,.        
-0000d500: 2020 2020 4661 6c73 6520 746f 2061 766f      False to avo
-0000d510: 6964 2063 7265 6174 696f 6e2e 204e 6f6e  id creation. Non
-0000d520: 6520 6c65 6164 7320 746f 2074 6865 2064  e leads to the d
-0000d530: 6566 6175 6c74 2062 6568 6176 696f 7572  efault behaviour
-0000d540: 206f 6620 6764 616c 2e0a 2020 2020 2020   of gdal..      
-0000d550: 2020 2020 2020 4465 6661 756c 7473 2074        Defaults t
-0000d560: 6f20 5472 7565 2e0a 0a20 2020 2052 6169  o True...    Rai
-0000d570: 7365 733a 0a20 2020 2020 2020 2056 616c  ses:.        Val
-0000d580: 7565 4572 726f 723a 2061 6e20 696e 7661  ueError: an inva
-0000d590: 6c69 6420 7061 7261 6d65 7465 7220 7661  lid parameter va
-0000d5a0: 6c75 6520 7761 7320 7061 7373 6564 2e0a  lue was passed..
-0000d5b0: 2020 2020 2020 2020 5275 6e74 696d 6545          RuntimeE
-0000d5c0: 7272 6f72 3a20 7469 6d65 6f75 7420 7761  rror: timeout wa
-0000d5d0: 7320 7265 6163 6865 6420 7768 696c 6520  s reached while 
-0000d5e0: 7472 7969 6e67 2074 6f20 6170 7065 6e64  trying to append
-0000d5f0: 2064 6174 6120 746f 2070 6174 682e 0a20   data to path.. 
-0000d600: 2020 2022 2222 0a20 2020 2023 2043 6865     """.    # Che
-0000d610: 636b 2069 6e70 7574 2070 6172 616d 6574  ck input paramet
-0000d620: 6572 730a 2020 2020 2320 2d2d 2d2d 2d2d  ers.    # ------
-0000d630: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0000d640: 0a20 2020 2070 6174 6820 3d20 5061 7468  .    path = Path
-0000d650: 2870 6174 6829 0a0a 2020 2020 2320 4966  (path)..    # If
-0000d660: 206e 6f20 6c61 7965 7220 6e61 6d65 2073   no layer name s
-0000d670: 7065 6369 6669 6564 2c20 6465 7465 726d  pecified, determ
-0000d680: 696e 6520 6f6e 650a 2020 2020 6966 206c  ine one.    if l
-0000d690: 6179 6572 2069 7320 4e6f 6e65 3a0a 2020  ayer is None:.  
-0000d6a0: 2020 2020 2020 6966 2061 7070 656e 6420        if append 
-0000d6b0: 616e 6420 7061 7468 2e65 7869 7374 7328  and path.exists(
-0000d6c0: 293a 0a20 2020 2020 2020 2020 2020 206c  ):.            l
-0000d6d0: 6179 6572 203d 2067 6574 5f6f 6e6c 795f  ayer = get_only_
-0000d6e0: 6c61 7965 7228 7061 7468 290a 2020 2020  layer(path).    
-0000d6f0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0000d700: 2020 2020 2020 6c61 7965 7220 3d20 5061        layer = Pa
-0000d710: 7468 2870 6174 6829 2e73 7465 6d0a 0a20  th(path).stem.. 
-0000d720: 2020 2023 2049 6620 666f 7263 655f 6f75     # If force_ou
-0000d730: 7470 7574 5f67 656f 6d65 7472 7974 7970  tput_geometrytyp
-0000d740: 6520 6973 2061 2073 7472 696e 672c 2063  e is a string, c
-0000d750: 6865 636b 2069 6620 6974 2069 7320 6120  heck if it is a 
-0000d760: 2273 7461 6e64 6172 6422 2067 656f 6d65  "standard" geome
-0000d770: 7472 790a 2020 2020 2320 7479 7065 2c20  try.    # type, 
-0000d780: 6173 2047 4441 4c20 616c 736f 2073 7570  as GDAL also sup
-0000d790: 706f 7274 7320 7370 6563 6961 6c20 6765  ports special ge
-0000d7a0: 6f6d 6574 7279 2074 7970 6573 206c 696b  ometry types lik
-0000d7b0: 6520 2250 524f 4d4f 5445 5f54 4f5f 4d55  e "PROMOTE_TO_MU
-0000d7c0: 4c54 4922 0a20 2020 2069 6620 6973 696e  LTI".    if isin
-0000d7d0: 7374 616e 6365 2866 6f72 6365 5f6f 7574  stance(force_out
-0000d7e0: 7075 745f 6765 6f6d 6574 7279 7479 7065  put_geometrytype
-0000d7f0: 2c20 7374 7229 3a0a 2020 2020 2020 2020  , str):.        
-0000d800: 666f 7263 655f 6f75 7470 7574 5f67 656f  force_output_geo
-0000d810: 6d65 7472 7974 7970 6520 3d20 666f 7263  metrytype = forc
+00000a10: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00000a20: 2323 2323 2323 230a 2320 5468 6520 7265  #######.# The re
+00000a30: 616c 2077 6f72 6b0a 2323 2323 2323 2323  al work.########
+00000a40: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00000a50: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00000a60: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00000a70: 2323 2323 2323 2323 2323 2323 230a 0a0a  #############...
+00000a80: 6465 6620 6c69 7374 6c61 7965 7273 280a  def listlayers(.
+00000a90: 2020 2020 7061 7468 3a20 556e 696f 6e5b      path: Union[
+00000aa0: 7374 722c 2022 6f73 2e50 6174 684c 696b  str, "os.PathLik
+00000ab0: 655b 416e 795d 225d 2c0a 2020 2020 6f6e  e[Any]"],.    on
+00000ac0: 6c79 5f73 7061 7469 616c 5f6c 6179 6572  ly_spatial_layer
+00000ad0: 733a 2062 6f6f 6c20 3d20 5472 7565 2c0a  s: bool = True,.
+00000ae0: 2920 2d3e 206c 6973 745b 7374 725d 3a0a  ) -> list[str]:.
+00000af0: 2020 2020 2222 220a 2020 2020 4765 7420      """.    Get 
+00000b00: 7468 6520 6c69 7374 206f 6620 6c61 7965  the list of laye
+00000b10: 7273 2069 6e20 6120 6765 6f66 696c 652e  rs in a geofile.
+00000b20: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
+00000b30: 2020 2020 7061 7468 2028 5061 7468 4c69      path (PathLi
+00000b40: 6b65 293a 2070 6174 6820 746f 2074 6865  ke): path to the
+00000b50: 2066 696c 6520 746f 2067 6574 2069 6e66   file to get inf
+00000b60: 6f20 6162 6f75 740a 2020 2020 2020 2020  o about.        
+00000b70: 6f6e 6c79 5f73 7061 7469 616c 5f6c 6179  only_spatial_lay
+00000b80: 6572 7320 2862 6f6f 6c2c 206f 7074 696f  ers (bool, optio
+00000b90: 6e61 6c29 3a20 5472 7565 2074 6f20 6f6e  nal): True to on
+00000ba0: 6c79 206c 6973 7420 7370 6174 6961 6c20  ly list spatial 
+00000bb0: 6c61 7965 7273 2e0a 2020 2020 2020 2020  layers..        
+00000bc0: 2020 2020 4661 6c73 6520 746f 206c 6973      False to lis
+00000bd0: 7420 616c 6c20 7461 626c 6573 2e0a 0a20  t all tables... 
+00000be0: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
+00000bf0: 2020 2020 4c69 7374 5b73 7472 5d3a 2074      List[str]: t
+00000c00: 6865 206c 6973 7420 6f66 206c 6179 6572  he list of layer
+00000c10: 730a 2020 2020 2222 220a 2020 2020 7061  s.    """.    pa
+00000c20: 7468 203d 2050 6174 6828 7061 7468 290a  th = Path(path).
+00000c30: 2020 2020 6966 2070 6174 682e 7375 6666      if path.suff
+00000c40: 6978 2e6c 6f77 6572 2829 203d 3d20 222e  ix.lower() == ".
+00000c50: 7368 7022 3a0a 2020 2020 2020 2020 7265  shp":.        re
+00000c60: 7475 726e 205b 7061 7468 2e73 7465 6d5d  turn [path.stem]
+00000c70: 0a0a 2020 2020 6461 7461 736f 7572 6365  ..    datasource
+00000c80: 203d 204e 6f6e 650a 2020 2020 6c61 7965   = None.    laye
+00000c90: 7273 203d 205b 5d0a 2020 2020 7472 793a  rs = [].    try:
+00000ca0: 0a20 2020 2020 2020 2064 6174 6173 6f75  .        datasou
+00000cb0: 7263 6520 3d20 6764 616c 2e4f 7065 6e45  rce = gdal.OpenE
+00000cc0: 7828 0a20 2020 2020 2020 2020 2020 2073  x(.            s
+00000cd0: 7472 2870 6174 6829 2c20 6e4f 7065 6e46  tr(path), nOpenF
+00000ce0: 6c61 6773 3d67 6461 6c2e 4f46 5f56 4543  lags=gdal.OF_VEC
+00000cf0: 544f 5220 7c20 6764 616c 2e4f 465f 5245  TOR | gdal.OF_RE
+00000d00: 4144 4f4e 4c59 207c 2067 6461 6c2e 4f46  ADONLY | gdal.OF
+00000d10: 5f53 4841 5245 440a 2020 2020 2020 2020  _SHARED.        
+00000d20: 290a 2020 2020 2020 2020 6e62 5f6c 6179  ).        nb_lay
+00000d30: 6572 7320 3d20 6461 7461 736f 7572 6365  ers = datasource
+00000d40: 2e47 6574 4c61 7965 7243 6f75 6e74 2829  .GetLayerCount()
+00000d50: 0a20 2020 2020 2020 2066 6f72 206c 6179  .        for lay
+00000d60: 6572 5f69 6420 696e 2072 616e 6765 286e  er_id in range(n
+00000d70: 625f 6c61 7965 7273 293a 0a20 2020 2020  b_layers):.     
+00000d80: 2020 2020 2020 2064 6174 6173 6f75 7263         datasourc
+00000d90: 655f 6c61 7965 7220 3d20 6461 7461 736f  e_layer = dataso
+00000da0: 7572 6365 2e47 6574 4c61 7965 7242 7949  urce.GetLayerByI
+00000db0: 6e64 6578 286c 6179 6572 5f69 6429 0a20  ndex(layer_id). 
+00000dc0: 2020 2020 2020 2020 2020 2069 6620 280a             if (.
+00000dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000de0: 6f6e 6c79 5f73 7061 7469 616c 5f6c 6179  only_spatial_lay
+00000df0: 6572 7320 6973 2046 616c 7365 0a20 2020  ers is False.   
+00000e00: 2020 2020 2020 2020 2020 2020 206f 7220               or 
+00000e10: 6461 7461 736f 7572 6365 5f6c 6179 6572  datasource_layer
+00000e20: 2e47 6574 4765 6f6d 6574 7279 436f 6c75  .GetGeometryColu
+00000e30: 6d6e 2829 2021 3d20 2222 0a20 2020 2020  mn() != "".     
+00000e40: 2020 2020 2020 2029 3a0a 2020 2020 2020         ):.      
+00000e50: 2020 2020 2020 2020 2020 6c61 7965 7273            layers
+00000e60: 2e61 7070 656e 6428 6461 7461 736f 7572  .append(datasour
+00000e70: 6365 5f6c 6179 6572 2e47 6574 4e61 6d65  ce_layer.GetName
+00000e80: 2829 290a 0a20 2020 2065 7863 6570 7420  ())..    except 
+00000e90: 4578 6365 7074 696f 6e20 6173 2065 783a  Exception as ex:
+00000ea0: 0a20 2020 2020 2020 2065 782e 6172 6773  .        ex.args
+00000eb0: 203d 2028 6622 6c69 7374 6c61 7965 7273   = (f"listlayers
+00000ec0: 2065 7272 6f72 2066 6f72 207b 7061 7468   error for {path
+00000ed0: 7d3a 5c6e 2020 7b65 787d 222c 290a 2020  }:\n  {ex}",).  
+00000ee0: 2020 2020 2020 7261 6973 650a 2020 2020        raise.    
+00000ef0: 6669 6e61 6c6c 793a 0a20 2020 2020 2020  finally:.       
+00000f00: 2064 6174 6173 6f75 7263 6520 3d20 4e6f   datasource = No
+00000f10: 6e65 0a0a 2020 2020 7265 7475 726e 206c  ne..    return l
+00000f20: 6179 6572 730a 0a0a 636c 6173 7320 436f  ayers...class Co
+00000f30: 6c75 6d6e 496e 666f 3a0a 2020 2020 2222  lumnInfo:.    ""
+00000f40: 220a 2020 2020 4120 6461 7461 206f 626a  ".    A data obj
+00000f50: 6563 7420 636f 6e74 6169 6e69 6e67 206d  ect containing m
+00000f60: 6574 612d 696e 666f 726d 6174 696f 6e20  eta-information 
+00000f70: 6162 6f75 7420 6120 636f 6c75 6d6e 2e0a  about a column..
+00000f80: 0a20 2020 2041 7474 7269 6275 7465 733a  .    Attributes:
+00000f90: 0a20 2020 2020 2020 206e 616d 6520 2873  .        name (s
+00000fa0: 7472 293a 2074 6865 206e 616d 6520 6f66  tr): the name of
+00000fb0: 2074 6865 2063 6f6c 756d 6e2e 0a20 2020   the column..   
+00000fc0: 2020 2020 2067 6461 6c5f 7479 7065 2028       gdal_type (
+00000fd0: 7374 7229 3a20 7468 6520 7479 7065 206f  str): the type o
+00000fe0: 6620 7468 6520 636f 6c75 6d6e 2061 6363  f the column acc
+00000ff0: 6f72 6469 6e67 2074 6f20 6764 616c 2e0a  ording to gdal..
+00001000: 2020 2020 2020 2020 7769 6474 6820 2869          width (i
+00001010: 6e74 293a 2074 6865 2077 6964 7468 206f  nt): the width o
+00001020: 6620 7468 6520 636f 6c75 6d6e 2c20 6966  f the column, if
+00001030: 2073 7065 6369 6669 6564 2e0a 2020 2020   specified..    
+00001040: 2222 220a 0a20 2020 2064 6566 205f 5f69  """..    def __i
+00001050: 6e69 745f 5f28 0a20 2020 2020 2020 2073  nit__(.        s
+00001060: 656c 662c 0a20 2020 2020 2020 206e 616d  elf,.        nam
+00001070: 653a 2073 7472 2c0a 2020 2020 2020 2020  e: str,.        
+00001080: 6764 616c 5f74 7970 653a 2073 7472 2c0a  gdal_type: str,.
+00001090: 2020 2020 2020 2020 7769 6474 683a 204f          width: O
+000010a0: 7074 696f 6e61 6c5b 696e 745d 2c0a 2020  ptional[int],.  
+000010b0: 2020 2020 2020 7072 6563 6973 696f 6e3a        precision:
+000010c0: 204f 7074 696f 6e61 6c5b 696e 745d 2c0a   Optional[int],.
+000010d0: 2020 2020 293a 0a20 2020 2020 2020 2022      ):.        "
+000010e0: 2222 0a20 2020 2020 2020 2043 6f6e 7374  "".        Const
+000010f0: 7275 6374 6f72 206f 6620 436f 6c75 6d6e  ructor of Column
+00001100: 496e 666f 2e0a 0a20 2020 2020 2020 2041  Info...        A
+00001110: 7267 733a 0a20 2020 2020 2020 2020 2020  rgs:.           
+00001120: 206e 616d 6520 2873 7472 293a 2074 6865   name (str): the
+00001130: 2063 6f6c 756d 6e20 6e61 6d65 2e0a 2020   column name..  
+00001140: 2020 2020 2020 2020 2020 6764 616c 5f74            gdal_t
+00001150: 7970 6520 2873 7472 293a 2074 6865 2067  ype (str): the g
+00001160: 6461 6c20 7479 7065 206f 6620 7468 6520  dal type of the 
+00001170: 636f 6c75 6d6e 2e0a 2020 2020 2020 2020  column..        
+00001180: 2020 2020 7769 6474 6820 284f 7074 696f      width (Optio
+00001190: 6e61 6c5b 696e 745d 293a 2074 6865 2077  nal[int]): the w
+000011a0: 6964 7468 206f 6620 7468 6520 636f 6c75  idth of the colu
+000011b0: 6d6e 2c20 6966 2061 7070 6c69 6361 626c  mn, if applicabl
+000011c0: 652e 0a20 2020 2020 2020 2020 2020 2070  e..            p
+000011d0: 7265 6369 7369 6f6e 2028 4f70 7469 6f6e  recision (Option
+000011e0: 616c 5b69 6e74 5d29 3a20 7468 6520 7072  al[int]): the pr
+000011f0: 6563 6973 696f 6e20 6f66 2074 6865 2063  ecision of the c
+00001200: 6f6c 756d 6e2c 2069 6620 6170 706c 6963  olumn, if applic
+00001210: 6162 6c65 2e0a 2020 2020 2020 2020 2222  able..        ""
+00001220: 220a 2020 2020 2020 2020 7365 6c66 2e6e  ".        self.n
+00001230: 616d 6520 3d20 6e61 6d65 0a20 2020 2020  ame = name.     
+00001240: 2020 2073 656c 662e 6764 616c 5f74 7970     self.gdal_typ
+00001250: 6520 3d20 6764 616c 5f74 7970 650a 2020  e = gdal_type.  
+00001260: 2020 2020 2020 7365 6c66 2e77 6964 7468        self.width
+00001270: 203d 2077 6964 7468 0a20 2020 2020 2020   = width.       
+00001280: 2073 656c 662e 7072 6563 6973 696f 6e20   self.precision 
+00001290: 3d20 7072 6563 6973 696f 6e0a 0a20 2020  = precision..   
+000012a0: 2064 6566 205f 5f72 6570 725f 5f28 7365   def __repr__(se
+000012b0: 6c66 293a 0a20 2020 2020 2020 2022 2222  lf):.        """
+000012c0: 4f76 6572 7269 6465 7320 7468 6520 7265  Overrides the re
+000012d0: 7072 6573 656e 7461 7469 6f6e 2070 726f  presentation pro
+000012e0: 7065 7274 7920 6f66 2043 6f6c 756d 6e49  perty of ColumnI
+000012f0: 6e66 6f2e 2222 220a 2020 2020 2020 2020  nfo.""".        
+00001300: 7265 7475 726e 2066 227b 7365 6c66 2e5f  return f"{self._
+00001310: 5f63 6c61 7373 5f5f 7d28 7b73 656c 662e  _class__}({self.
+00001320: 5f5f 6469 6374 5f5f 7d29 220a 0a0a 636c  __dict__})"...cl
+00001330: 6173 7320 4c61 7965 7249 6e66 6f3a 0a20  ass LayerInfo:. 
+00001340: 2020 2022 2222 0a20 2020 2041 2064 6174     """.    A dat
+00001350: 6120 6f62 6a65 6374 2063 6f6e 7461 696e  a object contain
+00001360: 696e 6720 6d65 7461 2d69 6e66 6f72 6d61  ing meta-informa
+00001370: 7469 6f6e 2061 626f 7574 2061 206c 6179  tion about a lay
+00001380: 6572 2e0a 0a20 2020 2041 7474 7269 6275  er...    Attribu
+00001390: 7465 733a 0a20 2020 2020 2020 206e 616d  tes:.        nam
+000013a0: 6520 2873 7472 293a 2074 6865 206e 616d  e (str): the nam
+000013b0: 6520 6f66 2074 6865 206c 6179 6572 2e0a  e of the layer..
+000013c0: 2020 2020 2020 2020 6665 6174 7572 6563          featurec
+000013d0: 6f75 6e74 2028 696e 7429 3a20 7468 6520  ount (int): the 
+000013e0: 6e75 6d62 6572 206f 6620 6665 6174 7572  number of featur
+000013f0: 6573 2028 726f 7773 2920 696e 2074 6865  es (rows) in the
+00001400: 206c 6179 6572 2e0a 2020 2020 2020 2020   layer..        
+00001410: 746f 7461 6c5f 626f 756e 6473 2028 5475  total_bounds (Tu
+00001420: 706c 655b 666c 6f61 742c 2066 6c6f 6174  ple[float, float
+00001430: 2c20 666c 6f61 742c 2066 6c6f 6174 5d29  , float, float])
+00001440: 3a20 7468 6520 626f 756e 6469 6e67 2062  : the bounding b
+00001450: 6f78 206f 660a 2020 2020 2020 2020 2020  ox of.          
+00001460: 2020 7468 6520 6c61 7965 723a 2028 6d69    the layer: (mi
+00001470: 6e78 2c20 6d69 6e79 2c20 6d61 7878 2c20  nx, miny, maxx, 
+00001480: 6d61 7879 292e 0a20 2020 2020 2020 2067  maxy)..        g
+00001490: 656f 6d65 7472 7963 6f6c 756d 6e20 2873  eometrycolumn (s
+000014a0: 7472 293a 206e 616d 6520 6f66 2074 6865  tr): name of the
+000014b0: 2063 6f6c 756d 6e20 7468 6174 2063 6f6e   column that con
+000014c0: 7461 696e 7320 7468 650a 2020 2020 2020  tains the.      
+000014d0: 2020 2020 2020 7072 696d 6172 7920 6765        primary ge
+000014e0: 6f6d 6574 7279 2e0a 2020 2020 2020 2020  ometry..        
+000014f0: 6765 6f6d 6574 7279 7479 7065 6e61 6d65  geometrytypename
+00001500: 2028 7374 7229 3a20 7468 6520 6765 6f6d   (str): the geom
+00001510: 6574 7279 2074 7970 6520 6e61 6d65 206f  etry type name o
+00001520: 6620 7468 6520 6765 6f6d 6574 7279 636f  f the geometryco
+00001530: 6c75 6d6e 2e0a 2020 2020 2020 2020 2020  lumn..          
+00001540: 2020 5468 6520 7479 7065 206e 616d 6520    The type name 
+00001550: 7265 7475 726e 6564 2069 7320 6f6e 6520  returned is one 
+00001560: 6f66 2074 6865 2066 6f6c 6c6f 7769 6e67  of the following
+00001570: 3a20 504f 494e 542c 204d 554c 5449 504f  : POINT, MULTIPO
+00001580: 494e 542c 0a20 2020 2020 2020 2020 2020  INT,.           
+00001590: 204c 494e 4553 5452 494e 472c 204d 554c   LINESTRING, MUL
+000015a0: 5449 4c49 4e45 5354 5249 4e47 2c20 504f  TILINESTRING, PO
+000015b0: 4c59 474f 4e2c 204d 554c 5449 504f 4c59  LYGON, MULTIPOLY
+000015c0: 474f 4e2c 2043 4f4c 4c45 4354 494f 4e2e  GON, COLLECTION.
+000015d0: 0a20 2020 2020 2020 2067 656f 6d65 7472  .        geometr
+000015e0: 7974 7970 6520 2847 656f 6d65 7472 7954  ytype (GeometryT
+000015f0: 7970 6529 3a20 7468 6520 6765 6f6d 6574  ype): the geomet
+00001600: 7279 2074 7970 6520 6f66 2074 6865 2067  ry type of the g
+00001610: 656f 6d65 7472 7963 6f6c 756d 6e2e 0a20  eometrycolumn.. 
+00001620: 2020 2020 2020 2063 6f6c 756d 6e73 2028         columns (
+00001630: 6469 6374 293a 2074 6865 2063 6f6c 756d  dict): the colum
+00001640: 6e73 2028 6f74 6865 7220 7468 616e 2074  ns (other than t
+00001650: 6865 2067 656f 6d65 7472 7920 636f 6c75  he geometry colu
+00001660: 6d6e 2920 7468 6174 0a20 2020 2020 2020  mn) that.       
+00001670: 2020 2020 2061 7265 2061 7661 696c 6162       are availab
+00001680: 6c65 206f 6e20 7468 6520 6c61 7965 7220  le on the layer 
+00001690: 7769 7468 2074 6865 6972 2070 726f 7065  with their prope
+000016a0: 7274 6965 7320 6173 2061 2064 6963 742e  rties as a dict.
+000016b0: 0a20 2020 2020 2020 2066 6964 5f63 6f6c  .        fid_col
+000016c0: 756d 6e20 2873 7472 293a 2063 6f6c 756d  umn (str): colum
+000016d0: 6e20 6e61 6d65 206f 6620 7468 6520 4649  n name of the FI
+000016e0: 4420 636f 6c75 6d6e 2e20 4973 2022 2220  D column. Is "" 
+000016f0: 666f 7220 6669 6c65 2074 7970 6573 2074  for file types t
+00001700: 6861 7420 646f 6e27 740a 2020 2020 2020  hat don't.      
+00001710: 2020 2020 2020 6578 706c 6963 6974 6c79        explicitly
+00001720: 2073 746f 7265 2061 6e20 4649 442c 206c   store an FID, l
+00001730: 696b 6520 7368 6170 6566 696c 652e 0a20  ike shapefile.. 
+00001740: 2020 2020 2020 2063 7273 2028 7079 7072         crs (pypr
+00001750: 6f6a 2e43 5253 293a 2074 6865 2073 7061  oj.CRS): the spa
+00001760: 7469 616c 2072 6566 6572 656e 6365 206f  tial reference o
+00001770: 6620 7468 6520 6c61 7965 722e 0a20 2020  f the layer..   
+00001780: 2020 2020 2065 7272 6f72 7320 284c 6973       errors (Lis
+00001790: 745b 7374 725d 293a 206c 6973 7420 6f66  t[str]): list of
+000017a0: 2065 7272 6f72 7320 696e 2074 6865 206c   errors in the l
+000017b0: 6179 6572 2c20 6567 2e20 696e 7661 6c69  ayer, eg. invali
+000017c0: 6420 636f 6c75 6d6e 0a20 2020 2020 2020  d column.       
+000017d0: 2020 2020 206e 616d 6573 2c2e 2e2e 0a20       names,.... 
+000017e0: 2020 2022 2222 0a0a 2020 2020 6465 6620     """..    def 
+000017f0: 5f5f 696e 6974 5f5f 280a 2020 2020 2020  __init__(.      
+00001800: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+00001810: 6e61 6d65 3a20 7374 722c 0a20 2020 2020  name: str,.     
+00001820: 2020 2066 6561 7475 7265 636f 756e 743a     featurecount:
+00001830: 2069 6e74 2c0a 2020 2020 2020 2020 746f   int,.        to
+00001840: 7461 6c5f 626f 756e 6473 3a20 7475 706c  tal_bounds: tupl
+00001850: 655b 666c 6f61 742c 2066 6c6f 6174 2c20  e[float, float, 
+00001860: 666c 6f61 742c 2066 6c6f 6174 5d2c 0a20  float, float],. 
+00001870: 2020 2020 2020 2067 656f 6d65 7472 7963         geometryc
+00001880: 6f6c 756d 6e3a 2073 7472 2c0a 2020 2020  olumn: str,.    
+00001890: 2020 2020 6765 6f6d 6574 7279 7479 7065      geometrytype
+000018a0: 6e61 6d65 3a20 7374 722c 0a20 2020 2020  name: str,.     
+000018b0: 2020 2067 656f 6d65 7472 7974 7970 653a     geometrytype:
+000018c0: 2047 656f 6d65 7472 7954 7970 652c 0a20   GeometryType,. 
+000018d0: 2020 2020 2020 2063 6f6c 756d 6e73 3a20         columns: 
+000018e0: 6469 6374 5b73 7472 2c20 436f 6c75 6d6e  dict[str, Column
+000018f0: 496e 666f 5d2c 0a20 2020 2020 2020 2066  Info],.        f
+00001900: 6964 5f63 6f6c 756d 6e3a 2073 7472 2c0a  id_column: str,.
+00001910: 2020 2020 2020 2020 6372 733a 204f 7074          crs: Opt
+00001920: 696f 6e61 6c5b 7079 7072 6f6a 2e43 5253  ional[pyproj.CRS
+00001930: 5d2c 0a20 2020 2020 2020 2065 7272 6f72  ],.        error
+00001940: 733a 206c 6973 745b 7374 725d 2c0a 2020  s: list[str],.  
+00001950: 2020 293a 0a20 2020 2020 2020 2022 2222    ):.        """
+00001960: 0a20 2020 2020 2020 2043 6f6e 7374 7275  .        Constru
+00001970: 6374 6f72 206f 6620 4c61 7965 7269 6e66  ctor of Layerinf
+00001980: 6f2e 0a0a 2020 2020 2020 2020 4172 6773  o...        Args
+00001990: 3a0a 2020 2020 2020 2020 2020 2020 6e61  :.            na
+000019a0: 6d65 2028 7374 7229 3a20 6e61 6d65 206f  me (str): name o
+000019b0: 6620 7468 6520 6c61 7965 722e 0a20 2020  f the layer..   
+000019c0: 2020 2020 2020 2020 2066 6561 7475 7265           feature
+000019d0: 636f 756e 7420 2869 6e74 293a 206e 756d  count (int): num
+000019e0: 6265 7220 6f66 2066 6561 7475 7265 7320  ber of features 
+000019f0: 696e 2074 6865 206c 6179 6572 2e0a 2020  in the layer..  
+00001a00: 2020 2020 2020 2020 2020 746f 7461 6c5f            total_
+00001a10: 626f 756e 6473 2028 5475 706c 655b 666c  bounds (Tuple[fl
+00001a20: 6f61 742c 2066 6c6f 6174 2c20 666c 6f61  oat, float, floa
+00001a30: 742c 2066 6c6f 6174 5d29 3a20 7468 6520  t, float]): the 
+00001a40: 626f 756e 6473 206f 6620 7468 6520 6c61  bounds of the la
+00001a50: 7965 722e 0a20 2020 2020 2020 2020 2020  yer..           
+00001a60: 2067 656f 6d65 7472 7963 6f6c 756d 6e20   geometrycolumn 
+00001a70: 2873 7472 293a 2074 6865 206e 616d 6520  (str): the name 
+00001a80: 6f66 2074 6865 2067 656f 6d65 7472 7920  of the geometry 
+00001a90: 636f 6c75 6d6e 2e0a 2020 2020 2020 2020  column..        
+00001aa0: 2020 2020 6765 6f6d 6574 7279 7479 7065      geometrytype
+00001ab0: 6e61 6d65 2028 7374 7229 3a20 7468 6520  name (str): the 
+00001ac0: 6e61 6d65 206f 6620 7468 6520 6765 6f6d  name of the geom
+00001ad0: 6574 7279 2063 6f6c 756d 6e20 7479 7065  etry column type
+00001ae0: 2e0a 2020 2020 2020 2020 2020 2020 6765  ..            ge
+00001af0: 6f6d 6574 7279 7479 7065 2028 4765 6f6d  ometrytype (Geom
+00001b00: 6574 7279 5479 7065 293a 2074 6865 2074  etryType): the t
+00001b10: 7970 6520 6f66 2074 6865 2067 656f 6d65  ype of the geome
+00001b20: 7472 7920 636f 6c75 6d6e 2e0a 2020 2020  try column..    
+00001b30: 2020 2020 2020 2020 636f 6c75 6d6e 7320          columns 
+00001b40: 2844 6963 745b 7374 722c 2043 6f6c 756d  (Dict[str, Colum
+00001b50: 6e49 6e66 6f5d 293a 2074 6865 2061 7474  nInfo]): the att
+00001b60: 7269 6275 7465 2063 6f6c 756d 6e73 206f  ribute columns o
+00001b70: 6620 7468 6520 6c61 7965 722e 0a20 2020  f the layer..   
+00001b80: 2020 2020 2020 2020 2066 6964 5f63 6f6c           fid_col
+00001b90: 756d 6e20 2873 7472 293a 2074 6865 206e  umn (str): the n
+00001ba0: 616d 6520 6f66 2074 6865 2066 6964 2063  ame of the fid c
+00001bb0: 6f6c 756d 6e2e 0a20 2020 2020 2020 2020  olumn..         
+00001bc0: 2020 2063 7273 2028 4f70 7469 6f6e 616c     crs (Optional
+00001bd0: 5b70 7970 726f 6a2e 4352 535d 293a 2074  [pyproj.CRS]): t
+00001be0: 6865 2063 7273 206f 6620 7468 6520 6c61  he crs of the la
+00001bf0: 7965 722e 0a20 2020 2020 2020 2020 2020  yer..           
+00001c00: 2065 7272 6f72 7320 284c 6973 745b 7374   errors (List[st
+00001c10: 725d 293a 2065 7272 6f72 7320 656e 636f  r]): errors enco
+00001c20: 756e 7465 7265 6420 7265 6164 696e 6720  untered reading 
+00001c30: 7468 6520 6c61 7965 7220 696e 666f 2e0a  the layer info..
+00001c40: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00001c50: 2020 2020 7365 6c66 2e6e 616d 6520 3d20      self.name = 
+00001c60: 6e61 6d65 0a20 2020 2020 2020 2073 656c  name.        sel
+00001c70: 662e 6665 6174 7572 6563 6f75 6e74 203d  f.featurecount =
+00001c80: 2066 6561 7475 7265 636f 756e 740a 2020   featurecount.  
+00001c90: 2020 2020 2020 7365 6c66 2e74 6f74 616c        self.total
+00001ca0: 5f62 6f75 6e64 7320 3d20 746f 7461 6c5f  _bounds = total_
+00001cb0: 626f 756e 6473 0a20 2020 2020 2020 2073  bounds.        s
+00001cc0: 656c 662e 6765 6f6d 6574 7279 636f 6c75  elf.geometrycolu
+00001cd0: 6d6e 203d 2067 656f 6d65 7472 7963 6f6c  mn = geometrycol
+00001ce0: 756d 6e0a 2020 2020 2020 2020 7365 6c66  umn.        self
+00001cf0: 2e67 656f 6d65 7472 7974 7970 656e 616d  .geometrytypenam
+00001d00: 6520 3d20 6765 6f6d 6574 7279 7479 7065  e = geometrytype
+00001d10: 6e61 6d65 0a20 2020 2020 2020 2073 656c  name.        sel
+00001d20: 662e 6765 6f6d 6574 7279 7479 7065 203d  f.geometrytype =
+00001d30: 2067 656f 6d65 7472 7974 7970 650a 2020   geometrytype.  
+00001d40: 2020 2020 2020 7365 6c66 2e63 6f6c 756d        self.colum
+00001d50: 6e73 203d 2063 6f6c 756d 6e73 0a20 2020  ns = columns.   
+00001d60: 2020 2020 2073 656c 662e 6669 645f 636f       self.fid_co
+00001d70: 6c75 6d6e 203d 2066 6964 5f63 6f6c 756d  lumn = fid_colum
+00001d80: 6e0a 2020 2020 2020 2020 7365 6c66 2e63  n.        self.c
+00001d90: 7273 203d 2063 7273 0a20 2020 2020 2020  rs = crs.       
+00001da0: 2073 656c 662e 6572 726f 7273 203d 2065   self.errors = e
+00001db0: 7272 6f72 730a 0a20 2020 2064 6566 205f  rrors..    def _
+00001dc0: 5f72 6570 725f 5f28 7365 6c66 293a 0a20  _repr__(self):. 
+00001dd0: 2020 2020 2020 2022 2222 4f76 6572 7269         """Overri
+00001de0: 6465 7320 7468 6520 7265 7072 6573 656e  des the represen
+00001df0: 7461 7469 6f6e 2070 726f 7065 7274 7920  tation property 
+00001e00: 6f66 204c 6179 6572 496e 666f 2e22 2222  of LayerInfo."""
+00001e10: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00001e20: 6622 7b73 656c 662e 5f5f 636c 6173 735f  f"{self.__class_
+00001e30: 5f7d 287b 7365 6c66 2e5f 5f64 6963 745f  _}({self.__dict_
+00001e40: 5f7d 2922 0a0a 0a64 6566 2067 6574 5f6c  _})"...def get_l
+00001e50: 6179 6572 5f67 656f 6d65 7472 7974 7970  ayer_geometrytyp
+00001e60: 6573 280a 2020 2020 7061 7468 3a20 556e  es(.    path: Un
+00001e70: 696f 6e5b 7374 722c 2022 6f73 2e50 6174  ion[str, "os.Pat
+00001e80: 684c 696b 655b 416e 795d 225d 2c20 6c61  hLike[Any]"], la
+00001e90: 7965 723a 204f 7074 696f 6e61 6c5b 7374  yer: Optional[st
+00001ea0: 725d 203d 204e 6f6e 650a 2920 2d3e 206c  r] = None.) -> l
+00001eb0: 6973 745b 7374 725d 3a0a 2020 2020 2222  ist[str]:.    ""
+00001ec0: 220a 2020 2020 4765 7420 7468 6520 6765  ".    Get the ge
+00001ed0: 6f6d 6574 7279 2074 7970 6573 2069 6e20  ometry types in 
+00001ee0: 7468 6520 6c61 7965 7220 6279 2065 7861  the layer by exa
+00001ef0: 6d69 6e69 6e67 2065 6163 6820 6765 6f6d  mining each geom
+00001f00: 6574 7279 2069 6e20 7468 6520 6c61 7965  etry in the laye
+00001f10: 722e 0a0a 2020 2020 5468 6520 6765 6e65  r...    The gene
+00001f20: 7261 6c20 6765 6f6d 6574 7279 2074 7970  ral geometry typ
+00001f30: 6520 6f66 2074 6865 206c 6179 6572 2063  e of the layer c
+00001f40: 616e 2062 6520 6465 7465 726d 696e 6564  an be determined
+00001f50: 2075 7369 6e67 0a20 2020 203a 6d65 7468   using.    :meth
+00001f60: 3a60 7e67 6574 5f6c 6179 6572 696e 666f  :`~get_layerinfo
+00001f70: 602e 0a0a 2020 2020 4172 6773 3a0a 2020  `...    Args:.  
+00001f80: 2020 2020 2020 7061 7468 2028 5061 7468        path (Path
+00001f90: 4c69 6b65 293a 2070 6174 6820 746f 2074  Like): path to t
+00001fa0: 6865 2066 696c 6520 746f 2067 6574 2069  he file to get i
+00001fb0: 6e66 6f20 6162 6f75 740a 2020 2020 2020  nfo about.      
+00001fc0: 2020 6c61 7965 7220 2873 7472 293a 2074    layer (str): t
+00001fd0: 6865 206c 6179 6572 2079 6f75 2077 616e  he layer you wan
+00001fe0: 7420 696e 666f 2061 626f 7574 2e20 446f  t info about. Do
+00001ff0: 6573 6e27 7420 6e65 6564 2074 6f20 6265  esn't need to be
+00002000: 0a20 2020 2020 2020 2020 2020 2073 7065  .            spe
+00002010: 6369 6669 6564 2069 6620 7468 6572 6520  cified if there 
+00002020: 6973 206f 6e6c 7920 6f6e 6520 6c61 7965  is only one laye
+00002030: 7220 696e 2074 6865 2067 656f 6669 6c65  r in the geofile
+00002040: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
+00002050: 2020 2020 2020 2020 4c69 7374 5b73 7472          List[str
+00002060: 5d3a 2074 6865 2067 656f 6d65 7472 7920  ]: the geometry 
+00002070: 7479 7065 7320 696e 2074 6865 206c 6179  types in the lay
+00002080: 6572 2e0a 2020 2020 2222 220a 2020 2020  er..    """.    
+00002090: 7371 6c5f 7374 6d74 203d 2022 2222 0a20  sql_stmt = """. 
+000020a0: 2020 2020 2020 2053 454c 4543 5420 4449         SELECT DI
+000020b0: 5354 494e 4354 0a20 2020 2020 2020 2020  STINCT.         
+000020c0: 2020 2020 2020 4341 5345 0a20 2020 2020        CASE.     
+000020d0: 2020 2020 2020 2020 2020 2020 5748 454e              WHEN
+000020e0: 2043 6173 7454 6f53 696e 676c 6528 7b67   CastToSingle({g
+000020f0: 656f 6d65 7472 7963 6f6c 756d 6e7d 2920  eometrycolumn}) 
+00002100: 4953 204e 4f54 204e 554c 4c20 5448 454e  IS NOT NULL THEN
+00002110: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00002120: 2020 2020 2020 5354 5f47 656f 6d65 7472        ST_Geometr
+00002130: 7954 7970 6528 4361 7374 546f 5369 6e67  yType(CastToSing
+00002140: 6c65 287b 6765 6f6d 6574 7279 636f 6c75  le({geometrycolu
+00002150: 6d6e 7d29 290a 2020 2020 2020 2020 2020  mn})).          
+00002160: 2020 2020 2020 2045 4c53 4520 5354 5f47         ELSE ST_G
+00002170: 656f 6d65 7472 7954 7970 6528 7b67 656f  eometryType({geo
+00002180: 6d65 7472 7963 6f6c 756d 6e7d 290a 2020  metrycolumn}).  
+00002190: 2020 2020 2020 2020 2020 2020 2045 4e44               END
+000021a0: 2041 5320 6765 6f6d 5f74 7970 650a 2020   AS geom_type.  
+000021b0: 2020 2020 2020 2020 4652 4f4d 2022 7b69          FROM "{i
+000021c0: 6e70 7574 5f6c 6179 6572 7d22 206c 6179  nput_layer}" lay
+000021d0: 6572 0a20 2020 2022 2222 0a20 2020 2072  er.    """.    r
+000021e0: 6573 756c 745f 6466 203d 2072 6561 645f  esult_df = read_
+000021f0: 6669 6c65 2870 6174 682c 2073 716c 5f73  file(path, sql_s
+00002200: 746d 743d 7371 6c5f 7374 6d74 2c20 7371  tmt=sql_stmt, sq
+00002210: 6c5f 6469 616c 6563 743d 2253 514c 4954  l_dialect="SQLIT
+00002220: 4522 290a 2020 2020 7265 7475 726e 2072  E").    return r
+00002230: 6573 756c 745f 6466 5b22 6765 6f6d 5f74  esult_df["geom_t
+00002240: 7970 6522 5d2e 746f 5f6c 6973 7428 290a  ype"].to_list().
+00002250: 0a0a 6465 6620 6765 745f 6c61 7965 7269  ..def get_layeri
+00002260: 6e66 6f28 0a20 2020 2070 6174 683a 2055  nfo(.    path: U
+00002270: 6e69 6f6e 5b73 7472 2c20 226f 732e 5061  nion[str, "os.Pa
+00002280: 7468 4c69 6b65 5b41 6e79 5d22 5d2c 0a20  thLike[Any]"],. 
+00002290: 2020 206c 6179 6572 3a20 4f70 7469 6f6e     layer: Option
+000022a0: 616c 5b73 7472 5d20 3d20 4e6f 6e65 2c0a  al[str] = None,.
+000022b0: 2020 2020 7261 6973 655f 6f6e 5f6e 6f67      raise_on_nog
+000022c0: 656f 6d3a 2062 6f6f 6c20 3d20 5472 7565  eom: bool = True
+000022d0: 2c0a 2920 2d3e 204c 6179 6572 496e 666f  ,.) -> LayerInfo
+000022e0: 3a0a 2020 2020 2222 220a 2020 2020 4765  :.    """.    Ge
+000022f0: 7420 696e 666f 726d 6174 696f 6e20 6162  t information ab
+00002300: 6f75 7420 6120 6c61 7965 7220 696e 2074  out a layer in t
+00002310: 6865 2067 656f 6669 6c65 2e0a 0a20 2020  he geofile...   
+00002320: 2052 6169 7365 7320 5661 6c75 6545 7272   Raises ValueErr
+00002330: 6f72 2069 6620 7468 6520 6c61 7965 7220  or if the layer 
+00002340: 6465 6669 6e69 7469 6f6e 2068 6173 2065  definition has e
+00002350: 7272 6f72 7320 6c69 6b65 2069 6e76 616c  rrors like inval
+00002360: 6964 2063 6f6c 756d 6e20 6e61 6d65 732c  id column names,
+00002370: 2e2e 2e0a 0a20 2020 2041 7267 733a 0a20  .....    Args:. 
+00002380: 2020 2020 2020 2070 6174 6820 2850 6174         path (Pat
+00002390: 684c 696b 6529 3a20 7061 7468 2074 6f20  hLike): path to 
+000023a0: 7468 6520 6669 6c65 2074 6f20 6765 7420  the file to get 
+000023b0: 696e 666f 2061 626f 7574 0a20 2020 2020  info about.     
+000023c0: 2020 206c 6179 6572 2028 7374 722c 206f     layer (str, o
+000023d0: 7074 696f 6e61 6c29 3a20 7468 6520 6c61  ptional): the la
+000023e0: 7965 7220 796f 7520 7761 6e74 2069 6e66  yer you want inf
+000023f0: 6f20 6162 6f75 742e 2044 6f65 736e 2774  o about. Doesn't
+00002400: 206e 6565 6420 746f 2062 650a 2020 2020   need to be.    
+00002410: 2020 2020 2020 2020 7370 6563 6966 6965          specifie
+00002420: 6420 6966 2074 6865 7265 2069 7320 6f6e  d if there is on
+00002430: 6c79 206f 6e65 206c 6179 6572 2069 6e20  ly one layer in 
+00002440: 7468 6520 6765 6f66 696c 652e 0a20 2020  the geofile..   
+00002450: 2020 2020 2072 6169 7365 5f6f 6e5f 6e6f       raise_on_no
+00002460: 6765 6f6d 2028 626f 6f6c 2c20 6f70 7469  geom (bool, opti
+00002470: 6f6e 616c 293a 2054 7275 6520 746f 2072  onal): True to r
+00002480: 6169 7365 2069 6620 7468 6520 6c61 7965  aise if the laye
+00002490: 7220 646f 6573 6e27 7420 6861 7665 2061  r doesn't have a
+000024a0: 0a20 2020 2020 2020 2020 2020 2067 656f  .            geo
+000024b0: 6d65 7472 7920 636f 6c75 6d6e 2e20 4966  metry column. If
+000024c0: 2046 616c 7365 2c20 7468 6520 7265 7475   False, the retu
+000024d0: 726e 6564 204c 6179 6572 496e 666f 2e67  rned LayerInfo.g
+000024e0: 656f 6d65 7472 7963 6f6c 756d 6e20 7769  eometrycolumn wi
+000024f0: 6c6c 2062 650a 2020 2020 2020 2020 2020  ll be.          
+00002500: 2020 4e6f 6e65 2e20 4465 6661 756c 7473    None. Defaults
+00002510: 2074 6f20 5472 7565 2e0a 0a20 2020 2052   to True...    R
+00002520: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
+00002530: 4c61 7965 7249 6e66 6f3a 2074 6865 2069  LayerInfo: the i
+00002540: 6e66 6f72 6d61 7469 6f6e 2061 626f 7574  nformation about
+00002550: 2074 6865 206c 6179 6572 2e0a 2020 2020   the layer..    
+00002560: 2222 220a 2020 2020 2320 496e 6974 0a20  """.    # Init. 
+00002570: 2020 2070 6174 6820 3d20 5061 7468 2870     path = Path(p
+00002580: 6174 6829 0a20 2020 2069 6620 6e6f 7420  ath).    if not 
+00002590: 7061 7468 2e65 7869 7374 7328 293a 0a20  path.exists():. 
+000025a0: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+000025b0: 7565 4572 726f 7228 6622 696e 7075 745f  ueError(f"input_
+000025c0: 7061 7468 2064 6f65 736e 2774 2065 7869  path doesn't exi
+000025d0: 7374 3a20 7b70 6174 687d 2229 0a0a 2020  st: {path}")..  
+000025e0: 2020 6966 206c 6179 6572 2069 7320 4e6f    if layer is No
+000025f0: 6e65 3a0a 2020 2020 2020 2020 6c61 7965  ne:.        laye
+00002600: 7220 3d20 6765 745f 6f6e 6c79 5f6c 6179  r = get_only_lay
+00002610: 6572 2870 6174 6829 0a0a 2020 2020 6461  er(path)..    da
+00002620: 7461 736f 7572 6365 203d 204e 6f6e 650a  tasource = None.
+00002630: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00002640: 2064 6174 6173 6f75 7263 6520 3d20 6764   datasource = gd
+00002650: 616c 2e4f 7065 6e45 7828 0a20 2020 2020  al.OpenEx(.     
+00002660: 2020 2020 2020 2073 7472 2870 6174 6829         str(path)
+00002670: 2c20 6e4f 7065 6e46 6c61 6773 3d67 6461  , nOpenFlags=gda
+00002680: 6c2e 4f46 5f56 4543 544f 5220 7c20 6764  l.OF_VECTOR | gd
+00002690: 616c 2e4f 465f 5245 4144 4f4e 4c59 207c  al.OF_READONLY |
+000026a0: 2067 6461 6c2e 4f46 5f53 4841 5245 440a   gdal.OF_SHARED.
+000026b0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000026c0: 2020 6461 7461 736f 7572 6365 5f6c 6179    datasource_lay
+000026d0: 6572 203d 2064 6174 6173 6f75 7263 652e  er = datasource.
+000026e0: 4765 744c 6179 6572 286c 6179 6572 290a  GetLayer(layer).
+000026f0: 0a20 2020 2020 2020 2023 2049 6620 7468  .        # If th
+00002700: 6520 6c61 7965 7220 646f 6573 6e27 7420  e layer doesn't 
+00002710: 6578 6973 742c 2072 6169 7365 0a20 2020  exist, raise.   
+00002720: 2020 2020 2069 6620 6461 7461 736f 7572       if datasour
+00002730: 6365 5f6c 6179 6572 2069 7320 4e6f 6e65  ce_layer is None
+00002740: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+00002750: 6973 6520 5661 6c75 6545 7272 6f72 2866  ise ValueError(f
+00002760: 224c 6179 6572 207b 6c61 7965 727d 206e  "Layer {layer} n
+00002770: 6f74 2066 6f75 6e64 2069 6e20 6669 6c65  ot found in file
+00002780: 3a20 7b70 6174 687d 2229 0a0a 2020 2020  : {path}")..    
+00002790: 2020 2020 2320 4765 7420 636f 6c75 6d6e      # Get column
+000027a0: 2069 6e66 6f0a 2020 2020 2020 2020 636f   info.        co
+000027b0: 6c75 6d6e 7320 3d20 7b7d 0a20 2020 2020  lumns = {}.     
+000027c0: 2020 2065 7272 6f72 7320 3d20 5b5d 0a20     errors = []. 
+000027d0: 2020 2020 2020 2064 7269 7665 7220 3d20         driver = 
+000027e0: 6461 7461 736f 7572 6365 2e47 6574 4472  datasource.GetDr
+000027f0: 6976 6572 2829 2e53 686f 7274 4e61 6d65  iver().ShortName
+00002800: 0a20 2020 2020 2020 206c 6179 6572 5f64  .        layer_d
+00002810: 6566 6e20 3d20 6461 7461 736f 7572 6365  efn = datasource
+00002820: 5f6c 6179 6572 2e47 6574 4c61 7965 7244  _layer.GetLayerD
+00002830: 6566 6e28 290a 2020 2020 2020 2020 666f  efn().        fo
+00002840: 7220 6920 696e 2072 616e 6765 286c 6179  r i in range(lay
+00002850: 6572 5f64 6566 6e2e 4765 7446 6965 6c64  er_defn.GetField
+00002860: 436f 756e 7428 2929 3a0a 2020 2020 2020  Count()):.      
+00002870: 2020 2020 2020 6e61 6d65 203d 206c 6179        name = lay
+00002880: 6572 5f64 6566 6e2e 4765 7446 6965 6c64  er_defn.GetField
+00002890: 4465 666e 2869 292e 4765 744e 616d 6528  Defn(i).GetName(
+000028a0: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
+000028b0: 544f 444f 3a20 7468 696e 6b20 7768 6574  TODO: think whet
+000028c0: 6865 7220 7468 6520 7479 7065 206e 616d  her the type nam
+000028d0: 6520 7368 6f75 6c64 2062 6520 636f 6e76  e should be conv
+000028e0: 6572 7465 6420 746f 206f 7468 6572 206e  erted to other n
+000028f0: 616d 6573 0a20 2020 2020 2020 2020 2020  ames.           
+00002900: 2067 6461 6c5f 7479 7065 203d 206c 6179   gdal_type = lay
+00002910: 6572 5f64 6566 6e2e 4765 7446 6965 6c64  er_defn.GetField
+00002920: 4465 666e 2869 292e 4765 7454 7970 654e  Defn(i).GetTypeN
+00002930: 616d 6528 290a 2020 2020 2020 2020 2020  ame().          
+00002940: 2020 7769 6474 6820 3d20 6c61 7965 725f    width = layer_
+00002950: 6465 666e 2e47 6574 4669 656c 6444 6566  defn.GetFieldDef
+00002960: 6e28 6929 2e47 6574 5769 6474 6828 290a  n(i).GetWidth().
+00002970: 2020 2020 2020 2020 2020 2020 7769 6474              widt
+00002980: 6820 3d20 7769 6474 6820 6966 2077 6964  h = width if wid
+00002990: 7468 203e 2030 2065 6c73 6520 4e6f 6e65  th > 0 else None
+000029a0: 0a20 2020 2020 2020 2020 2020 2070 7265  .            pre
+000029b0: 6369 7369 6f6e 203d 206c 6179 6572 5f64  cision = layer_d
+000029c0: 6566 6e2e 4765 7446 6965 6c64 4465 666e  efn.GetFieldDefn
+000029d0: 2869 292e 4765 7450 7265 6369 7369 6f6e  (i).GetPrecision
+000029e0: 2829 0a20 2020 2020 2020 2020 2020 2070  ().            p
+000029f0: 7265 6369 7369 6f6e 203d 2070 7265 6369  recision = preci
+00002a00: 7369 6f6e 2069 6620 7072 6563 6973 696f  sion if precisio
+00002a10: 6e20 3e20 3020 656c 7365 204e 6f6e 650a  n > 0 else None.
+00002a20: 2020 2020 2020 2020 2020 2020 696c 6c65              ille
+00002a30: 6761 6c5f 636f 6c75 6d6e 5f63 6861 7273  gal_column_chars
+00002a40: 203d 205b 2722 275d 0a20 2020 2020 2020   = ['"'].       
+00002a50: 2020 2020 2066 6f72 2069 6c6c 6567 616c       for illegal
+00002a60: 5f63 6861 7220 696e 2069 6c6c 6567 616c  _char in illegal
+00002a70: 5f63 6f6c 756d 6e5f 6368 6172 733a 0a20  _column_chars:. 
+00002a80: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00002a90: 6620 696c 6c65 6761 6c5f 6368 6172 2069  f illegal_char i
+00002aa0: 6e20 6e61 6d65 3a0a 2020 2020 2020 2020  n name:.        
+00002ab0: 2020 2020 2020 2020 2020 2020 6572 726f              erro
+00002ac0: 7273 2e61 7070 656e 6428 0a20 2020 2020  rs.append(.     
+00002ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002ae0: 2020 2066 2243 6f6c 756d 6e20 6e61 6d65     f"Column name
+00002af0: 207b 6e61 6d65 7d20 636f 6e74 6169 6e73   {name} contains
+00002b00: 2069 6c6c 6567 616c 2063 6861 723a 207b   illegal char: {
+00002b10: 696c 6c65 6761 6c5f 6368 6172 7d20 220a  illegal_char} ".
+00002b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002b30: 2020 2020 2020 2020 6622 696e 2066 696c          f"in fil
+00002b40: 6520 7b70 6174 687d 2c20 6c61 7965 7220  e {path}, layer 
+00002b50: 7b6c 6179 6572 7d22 0a20 2020 2020 2020  {layer}".       
+00002b60: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+00002b70: 2020 2020 2020 2020 2020 2063 6f6c 756d             colum
+00002b80: 6e5f 696e 666f 203d 2043 6f6c 756d 6e49  n_info = ColumnI
+00002b90: 6e66 6f28 0a20 2020 2020 2020 2020 2020  nfo(.           
+00002ba0: 2020 2020 206e 616d 653d 6e61 6d65 2c20       name=name, 
+00002bb0: 6764 616c 5f74 7970 653d 6764 616c 5f74  gdal_type=gdal_t
+00002bc0: 7970 652c 2077 6964 7468 3d77 6964 7468  ype, width=width
+00002bd0: 2c20 7072 6563 6973 696f 6e3d 7072 6563  , precision=prec
+00002be0: 6973 696f 6e0a 2020 2020 2020 2020 2020  ision.          
+00002bf0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00002c00: 636f 6c75 6d6e 735b 6e61 6d65 5d20 3d20  columns[name] = 
+00002c10: 636f 6c75 6d6e 5f69 6e66 6f0a 2020 2020  column_info.    
+00002c20: 2020 2020 2020 2020 6966 2064 7269 7665          if drive
+00002c30: 7220 3d3d 2022 4553 5249 2053 6861 7065  r == "ESRI Shape
+00002c40: 6669 6c65 223a 0a20 2020 2020 2020 2020  file":.         
+00002c50: 2020 2020 2020 2069 6620 6e61 6d65 2e63         if name.c
+00002c60: 6173 6566 6f6c 6428 2920 3d3d 2022 6765  asefold() == "ge
+00002c70: 6f6d 6574 7279 223a 0a20 2020 2020 2020  ometry":.       
+00002c80: 2020 2020 2020 2020 2020 2020 2065 7272               err
+00002c90: 6f72 732e 6170 7065 6e64 280a 2020 2020  ors.append(.    
+00002ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002cb0: 2020 2020 2241 6e20 6174 7472 6962 7574      "An attribut
+00002cc0: 6520 636f 6c75 6d6e 2027 6765 6f6d 6574  e column 'geomet
+00002cd0: 7279 2720 6973 206e 6f74 2073 7570 706f  ry' is not suppo
+00002ce0: 7274 6564 2069 6e20 6120 7368 6170 6566  rted in a shapef
+00002cf0: 696c 6522 0a20 2020 2020 2020 2020 2020  ile".           
+00002d00: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+00002d10: 2020 2020 2320 4765 7420 6765 6f6d 6574      # Get geomet
+00002d20: 7279 2063 6f6c 756d 6e20 696e 666f 2e2e  ry column info..
+00002d30: 2e0a 2020 2020 2020 2020 6765 6f6d 6574  ..        geomet
+00002d40: 7279 7479 7065 203d 205f 6f67 725f 7574  rytype = _ogr_ut
+00002d50: 696c 2e6f 6772 7479 7065 5f74 6f5f 6765  il.ogrtype_to_ge
+00002d60: 6f6d 6574 7279 7479 7065 5b64 6174 6173  ometrytype[datas
+00002d70: 6f75 7263 655f 6c61 7965 722e 4765 7447  ource_layer.GetG
+00002d80: 656f 6d54 7970 6528 295d 0a20 2020 2020  eomType()].     
+00002d90: 2020 2069 6620 6765 6f6d 6574 7279 7479     if geometryty
+00002da0: 7065 2069 7320 4e6f 6e65 3a0a 2020 2020  pe is None:.    
+00002db0: 2020 2020 2020 2020 6765 6f6d 6574 7279          geometry
+00002dc0: 7479 7065 6e61 6d65 203d 2022 4e4f 4e45  typename = "NONE
+00002dd0: 220a 2020 2020 2020 2020 656c 7365 3a0a  ".        else:.
+00002de0: 2020 2020 2020 2020 2020 2020 2320 466f              # Fo
+00002df0: 7220 7368 6170 6520 6669 6c65 732c 2074  r shape files, t
+00002e00: 6865 2064 6966 6665 7265 6e63 6520 6265  he difference be
+00002e10: 7477 6565 6e20 7468 6520 274d 554c 5449  tween the 'MULTI
+00002e20: 2720 7661 7269 616e 7420 616e 6420 7468  ' variant and th
+00002e30: 650a 2020 2020 2020 2020 2020 2020 2320  e.            # 
+00002e40: 7369 6e67 6c65 206f 6e65 2064 6f65 736e  single one doesn
+00002e50: 2774 2065 7869 7374 732e 2e2e 2073 6f20  't exists... so 
+00002e60: 616c 7761 7973 2072 6570 6f72 7420 4d55  always report MU
+00002e70: 4c54 4920 7661 7269 616e 7420 6279 2063  LTI variant by c
+00002e80: 6f6e 7665 6e74 696f 6e2e 0a20 2020 2020  onvention..     
+00002e90: 2020 2020 2020 2069 6620 6472 6976 6572         if driver
+00002ea0: 203d 3d20 2245 5352 4920 5368 6170 6566   == "ESRI Shapef
+00002eb0: 696c 6522 3a0a 2020 2020 2020 2020 2020  ile":.          
+00002ec0: 2020 2020 2020 6765 6f6d 6574 7279 7479        geometryty
+00002ed0: 7065 203d 2067 656f 6d65 7472 7974 7970  pe = geometrytyp
+00002ee0: 652e 746f 5f6d 756c 7469 7479 7065 0a0a  e.to_multitype..
+00002ef0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00002f00: 7274 2067 656f 6d65 7472 7974 7970 6520  rt geometrytype 
+00002f10: 6973 206e 6f74 204e 6f6e 650a 2020 2020  is not None.    
+00002f20: 2020 2020 2020 2020 6765 6f6d 6574 7279          geometry
+00002f30: 7479 7065 6e61 6d65 203d 2067 656f 6d65  typename = geome
+00002f40: 7472 7974 7970 652e 6e61 6d65 0a0a 2020  trytype.name..  
+00002f50: 2020 2020 2020 2320 4966 2074 6865 2067        # If the g
+00002f60: 656f 6d65 7472 7920 7479 7065 2069 7320  eometry type is 
+00002f70: 6e6f 7420 4e6f 6e65 2c20 6669 6c6c 206f  not None, fill o
+00002f80: 7574 2074 6865 2065 7874 7261 2070 726f  ut the extra pro
+00002f90: 7065 7274 6965 730a 2020 2020 2020 2020  perties.        
+00002fa0: 6765 6f6d 6574 7279 636f 6c75 6d6e 203d  geometrycolumn =
+00002fb0: 204e 6f6e 650a 2020 2020 2020 2020 6578   None.        ex
+00002fc0: 7465 6e74 203d 204e 6f6e 650a 2020 2020  tent = None.    
+00002fd0: 2020 2020 6372 7320 3d20 4e6f 6e65 0a20      crs = None. 
+00002fe0: 2020 2020 2020 2074 6f74 616c 5f62 6f75         total_bou
+00002ff0: 6e64 7320 3d20 4e6f 6e65 0a20 2020 2020  nds = None.     
+00003000: 2020 2069 6620 6765 6f6d 6574 7279 7479     if geometryty
+00003010: 7065 2069 7320 6e6f 7420 4e6f 6e65 3a0a  pe is not None:.
+00003020: 2020 2020 2020 2020 2020 2020 2320 4765              # Ge
+00003030: 6f6d 6574 7279 2063 6f6c 756d 6e20 6e61  ometry column na
+00003040: 6d65 0a20 2020 2020 2020 2020 2020 2067  me.            g
+00003050: 656f 6d65 7472 7963 6f6c 756d 6e20 3d20  eometrycolumn = 
+00003060: 6461 7461 736f 7572 6365 5f6c 6179 6572  datasource_layer
+00003070: 2e47 6574 4765 6f6d 6574 7279 436f 6c75  .GetGeometryColu
+00003080: 6d6e 2829 0a20 2020 2020 2020 2020 2020  mn().           
+00003090: 2069 6620 6765 6f6d 6574 7279 636f 6c75   if geometrycolu
+000030a0: 6d6e 203d 3d20 2222 3a0a 2020 2020 2020  mn == "":.      
+000030b0: 2020 2020 2020 2020 2020 6765 6f6d 6574            geomet
+000030c0: 7279 636f 6c75 6d6e 203d 2022 6765 6f6d  rycolumn = "geom
+000030d0: 6574 7279 220a 2020 2020 2020 2020 2020  etry".          
+000030e0: 2020 2320 436f 6e76 6572 7420 6578 7465    # Convert exte
+000030f0: 6e74 2028 786d 696e 2c20 786d 6178 2c20  nt (xmin, xmax, 
+00003100: 796d 696e 2c20 796d 6178 2920 746f 2062  ymin, ymax) to b
+00003110: 6f75 6e64 7320 2878 6d69 6e2c 2079 6d69  ounds (xmin, ymi
+00003120: 6e2c 2078 6d61 782c 2079 6d61 7829 0a20  n, xmax, ymax). 
+00003130: 2020 2020 2020 2020 2020 2065 7874 656e             exten
+00003140: 7420 3d20 6461 7461 736f 7572 6365 5f6c  t = datasource_l
+00003150: 6179 6572 2e47 6574 4578 7465 6e74 2829  ayer.GetExtent()
+00003160: 0a20 2020 2020 2020 2020 2020 2074 6f74  .            tot
+00003170: 616c 5f62 6f75 6e64 7320 3d20 2865 7874  al_bounds = (ext
+00003180: 656e 745b 305d 2c20 6578 7465 6e74 5b32  ent[0], extent[2
+00003190: 5d2c 2065 7874 656e 745b 315d 2c20 6578  ], extent[1], ex
+000031a0: 7465 6e74 5b33 5d29 0a20 2020 2020 2020  tent[3]).       
+000031b0: 2020 2020 2023 2043 5253 0a20 2020 2020       # CRS.     
+000031c0: 2020 2020 2020 2073 7061 7469 616c 7265         spatialre
+000031d0: 6620 3d20 6461 7461 736f 7572 6365 5f6c  f = datasource_l
+000031e0: 6179 6572 2e47 6574 5370 6174 6961 6c52  ayer.GetSpatialR
+000031f0: 6566 2829 0a20 2020 2020 2020 2020 2020  ef().           
+00003200: 2069 6620 7370 6174 6961 6c72 6566 2069   if spatialref i
+00003210: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00003220: 2020 2020 2020 2020 2020 2020 6372 7320              crs 
+00003230: 3d20 7079 7072 6f6a 2e43 5253 2873 7061  = pyproj.CRS(spa
+00003240: 7469 616c 7265 662e 4578 706f 7274 546f  tialref.ExportTo
+00003250: 576b 7428 2929 0a0a 2020 2020 2020 2020  Wkt())..        
+00003260: 2020 2020 2020 2020 2320 4966 2073 7061          # If spa
+00003270: 7469 616c 2072 6566 2068 6173 206e 6f20  tial ref has no 
+00003280: 6570 7367 2c20 7472 7920 746f 2066 696e  epsg, try to fin
+00003290: 6420 636f 7272 6573 706f 6e64 696e 6720  d corresponding 
+000032a0: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+000032b0: 2020 2020 6966 2063 7273 2e74 6f5f 6570      if crs.to_ep
+000032c0: 7367 2829 2069 7320 4e6f 6e65 3a0a 2020  sg() is None:.  
+000032d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000032e0: 2020 6372 7320 3d20 5f63 7273 5f63 7573    crs = _crs_cus
+000032f0: 746f 6d5f 6d61 7463 6828 6372 732c 2070  tom_match(crs, p
+00003300: 6174 6829 0a0a 2020 2020 2020 2020 656c  ath)..        el
+00003310: 6966 2072 6169 7365 5f6f 6e5f 6e6f 6765  if raise_on_noge
+00003320: 6f6d 3a0a 2020 2020 2020 2020 2020 2020  om:.            
+00003330: 6572 726f 7273 2e61 7070 656e 6428 224c  errors.append("L
+00003340: 6179 6572 2064 6f65 736e 2774 2068 6176  ayer doesn't hav
+00003350: 6520 6120 6765 6f6d 6574 7279 2063 6f6c  e a geometry col
+00003360: 756d 6e21 2229 0a0a 2020 2020 2020 2020  umn!")..        
+00003370: 2320 4966 2074 6865 7265 2077 6572 6520  # If there were 
+00003380: 6e6f 2065 7272 6f72 732c 2065 7665 7279  no errors, every
+00003390: 7468 696e 6720 7761 7320 4f4b 2073 6f20  thing was OK so 
+000033a0: 7765 2063 616e 2072 6574 7572 6e2e 0a20  we can return.. 
+000033b0: 2020 2020 2020 2069 6620 6c65 6e28 6572         if len(er
+000033c0: 726f 7273 2920 3d3d 2030 3a0a 2020 2020  rors) == 0:.    
+000033d0: 2020 2020 2020 2020 7265 7475 726e 204c          return L
+000033e0: 6179 6572 496e 666f 280a 2020 2020 2020  ayerInfo(.      
+000033f0: 2020 2020 2020 2020 2020 6e61 6d65 3d64            name=d
+00003400: 6174 6173 6f75 7263 655f 6c61 7965 722e  atasource_layer.
+00003410: 4765 744e 616d 6528 292c 0a20 2020 2020  GetName(),.     
+00003420: 2020 2020 2020 2020 2020 2066 6561 7475             featu
+00003430: 7265 636f 756e 743d 6461 7461 736f 7572  recount=datasour
+00003440: 6365 5f6c 6179 6572 2e47 6574 4665 6174  ce_layer.GetFeat
+00003450: 7572 6543 6f75 6e74 2829 2c0a 2020 2020  ureCount(),.    
+00003460: 2020 2020 2020 2020 2020 2020 746f 7461              tota
+00003470: 6c5f 626f 756e 6473 3d74 6f74 616c 5f62  l_bounds=total_b
+00003480: 6f75 6e64 732c 2020 2320 7479 7065 3a20  ounds,  # type: 
+00003490: 6967 6e6f 7265 5b61 7267 2d74 7970 655d  ignore[arg-type]
+000034a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000034b0: 2067 656f 6d65 7472 7963 6f6c 756d 6e3d   geometrycolumn=
+000034c0: 6765 6f6d 6574 7279 636f 6c75 6d6e 2c20  geometrycolumn, 
+000034d0: 2023 2074 7970 653a 2069 676e 6f72 655b   # type: ignore[
+000034e0: 6172 672d 7479 7065 5d0a 2020 2020 2020  arg-type].      
+000034f0: 2020 2020 2020 2020 2020 6765 6f6d 6574            geomet
+00003500: 7279 7479 7065 6e61 6d65 3d67 656f 6d65  rytypename=geome
+00003510: 7472 7974 7970 656e 616d 652c 0a20 2020  trytypename,.   
+00003520: 2020 2020 2020 2020 2020 2020 2067 656f               geo
+00003530: 6d65 7472 7974 7970 653d 6765 6f6d 6574  metrytype=geomet
+00003540: 7279 7479 7065 2c20 2023 2074 7970 653a  rytype,  # type:
+00003550: 2069 676e 6f72 655b 6172 672d 7479 7065   ignore[arg-type
+00003560: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00003570: 2020 636f 6c75 6d6e 733d 636f 6c75 6d6e    columns=column
+00003580: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+00003590: 2020 2066 6964 5f63 6f6c 756d 6e3d 6461     fid_column=da
+000035a0: 7461 736f 7572 6365 5f6c 6179 6572 2e47  tasource_layer.G
+000035b0: 6574 4649 4443 6f6c 756d 6e28 292c 0a20  etFIDColumn(),. 
+000035c0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000035d0: 7273 3d63 7273 2c0a 2020 2020 2020 2020  rs=crs,.        
+000035e0: 2020 2020 2020 2020 6572 726f 7273 3d65          errors=e
+000035f0: 7272 6f72 732c 0a20 2020 2020 2020 2020  rrors,.         
+00003600: 2020 2029 0a0a 2020 2020 6578 6365 7074     )..    except
+00003610: 2045 7863 6570 7469 6f6e 2061 7320 6578   Exception as ex
+00003620: 3a0a 2020 2020 2020 2020 6578 2e61 7267  :.        ex.arg
+00003630: 7320 3d20 2866 2267 6574 5f6c 6179 6572  s = (f"get_layer
+00003640: 696e 666f 2065 7272 6f72 2066 6f72 207b  info error for {
+00003650: 7061 7468 7d2e 7b6c 6179 6572 7d3a 5c6e  path}.{layer}:\n
+00003660: 2020 7b65 787d 222c 290a 2020 2020 2020    {ex}",).      
+00003670: 2020 7261 6973 650a 2020 2020 6669 6e61    raise.    fina
+00003680: 6c6c 793a 0a20 2020 2020 2020 2064 6174  lly:.        dat
+00003690: 6173 6f75 7263 6520 3d20 4e6f 6e65 0a0a  asource = None..
+000036a0: 2020 2020 2320 4966 2077 6520 6469 646e      # If we didn
+000036b0: 2774 2072 6574 7572 6e20 6f72 2072 6169  't return or rai
+000036c0: 7365 2079 6574 2068 6572 652c 2074 6865  se yet here, the
+000036d0: 7265 206d 7573 7420 6861 7665 2062 6565  re must have bee
+000036e0: 6e20 6572 726f 7273 0a20 2020 2065 7272  n errors.    err
+000036f0: 6f72 735f 7374 7220 3d20 7070 7269 6e74  ors_str = pprint
+00003700: 2e70 666f 726d 6174 2865 7272 6f72 7329  .pformat(errors)
+00003710: 0a20 2020 2072 6169 7365 2056 616c 7565  .    raise Value
+00003720: 4572 726f 7228 0a20 2020 2020 2020 2066  Error(.        f
+00003730: 2245 7272 6f72 7320 696e 206c 6179 6572  "Errors in layer
+00003740: 2064 6566 696e 6974 696f 6e20 6f66 2066   definition of f
+00003750: 696c 6520 7b70 6174 687d 2c20 6c61 7965  ile {path}, laye
+00003760: 7220 7b6c 6179 6572 7d3a 205c 6e7b 6572  r {layer}: \n{er
+00003770: 726f 7273 5f73 7472 7d22 0a20 2020 2029  rors_str}".    )
+00003780: 0a0a 0a64 6566 2067 6574 5f6f 6e6c 795f  ...def get_only_
+00003790: 6c61 7965 7228 7061 7468 3a20 556e 696f  layer(path: Unio
+000037a0: 6e5b 7374 722c 2022 6f73 2e50 6174 684c  n[str, "os.PathL
+000037b0: 696b 655b 416e 795d 225d 2920 2d3e 2073  ike[Any]"]) -> s
+000037c0: 7472 3a0a 2020 2020 2222 220a 2020 2020  tr:.    """.    
+000037d0: 4765 7420 7468 6520 6c61 7965 726e 616d  Get the layernam
+000037e0: 6520 666f 7220 6120 6669 6c65 2074 6861  e for a file tha
+000037f0: 7420 6f6e 6c79 2063 6f6e 7461 696e 7320  t only contains 
+00003800: 6f6e 6520 6c61 7965 722e 0a0a 2020 2020  one layer...    
+00003810: 4966 2074 6865 2066 696c 6520 636f 6e74  If the file cont
+00003820: 6169 6e73 206d 756c 7469 706c 6520 6c61  ains multiple la
+00003830: 7965 7273 2c20 616e 2065 7863 6570 7469  yers, an excepti
+00003840: 6f6e 2069 7320 7468 726f 776e 2e0a 0a20  on is thrown... 
+00003850: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
+00003860: 2070 6174 6820 2850 6174 684c 696b 6529   path (PathLike)
+00003870: 3a20 7468 6520 6669 6c65 2e0a 0a20 2020  : the file...   
+00003880: 2052 6169 7365 733a 0a20 2020 2020 2020   Raises:.       
+00003890: 2056 616c 7565 4572 726f 723a 2061 6e20   ValueError: an 
+000038a0: 696e 7661 6c69 6420 7061 7261 6d65 7465  invalid paramete
+000038b0: 7220 7661 6c75 6520 7761 7320 7061 7373  r value was pass
+000038c0: 6564 2e0a 0a20 2020 2052 6574 7572 6e73  ed...    Returns
+000038d0: 3a0a 2020 2020 2020 2020 7374 723a 2074  :.        str: t
+000038e0: 6865 206c 6179 6572 206e 616d 650a 2020  he layer name.  
+000038f0: 2020 2222 220a 2020 2020 6461 7461 736f    """.    dataso
+00003900: 7572 6365 203d 204e 6f6e 650a 2020 2020  urce = None.    
+00003910: 7472 793a 0a20 2020 2020 2020 2064 6174  try:.        dat
+00003920: 6173 6f75 7263 655f 6c61 7965 7220 3d20  asource_layer = 
+00003930: 4e6f 6e65 0a20 2020 2020 2020 2064 6174  None.        dat
+00003940: 6173 6f75 7263 6520 3d20 6764 616c 2e4f  asource = gdal.O
+00003950: 7065 6e45 7828 0a20 2020 2020 2020 2020  penEx(.         
+00003960: 2020 2073 7472 2870 6174 6829 2c20 6e4f     str(path), nO
+00003970: 7065 6e46 6c61 6773 3d67 6461 6c2e 4f46  penFlags=gdal.OF
+00003980: 5f56 4543 544f 5220 7c20 6764 616c 2e4f  _VECTOR | gdal.O
+00003990: 465f 5245 4144 4f4e 4c59 207c 2067 6461  F_READONLY | gda
+000039a0: 6c2e 4f46 5f53 4841 5245 440a 2020 2020  l.OF_SHARED.    
+000039b0: 2020 2020 290a 2020 2020 2020 2020 6e62      ).        nb
+000039c0: 5f6c 6179 6572 7320 3d20 6461 7461 736f  _layers = dataso
+000039d0: 7572 6365 2e47 6574 4c61 7965 7243 6f75  urce.GetLayerCou
+000039e0: 6e74 2829 0a20 2020 2020 2020 2069 6620  nt().        if 
+000039f0: 6e62 5f6c 6179 6572 7320 3d3d 2031 3a0a  nb_layers == 1:.
+00003a00: 2020 2020 2020 2020 2020 2020 6461 7461              data
+00003a10: 736f 7572 6365 5f6c 6179 6572 203d 2064  source_layer = d
+00003a20: 6174 6173 6f75 7263 652e 4765 744c 6179  atasource.GetLay
+00003a30: 6572 4279 496e 6465 7828 3029 0a20 2020  erByIndex(0).   
+00003a40: 2020 2020 2065 6c69 6620 6e62 5f6c 6179       elif nb_lay
+00003a50: 6572 7320 3d3d 2030 3a0a 2020 2020 2020  ers == 0:.      
+00003a60: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
+00003a70: 6545 7272 6f72 2866 2245 7272 6f72 3a20  eError(f"Error: 
+00003a80: 4e6f 206c 6179 6572 7320 666f 756e 6420  No layers found 
+00003a90: 696e 207b 7061 7468 7d22 290a 2020 2020  in {path}").    
+00003aa0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00003ab0: 2020 2020 2020 2320 4368 6563 6b20 6966        # Check if
+00003ac0: 2074 6865 7265 2069 7320 6f6e 6c79 206f   there is only o
+00003ad0: 6e65 2073 7061 7469 616c 206c 6179 6572  ne spatial layer
+00003ae0: 0a20 2020 2020 2020 2020 2020 206c 6179  .            lay
+00003af0: 6572 7320 3d20 6c69 7374 6c61 7965 7273  ers = listlayers
+00003b00: 2870 6174 682c 206f 6e6c 795f 7370 6174  (path, only_spat
+00003b10: 6961 6c5f 6c61 7965 7273 3d54 7275 6529  ial_layers=True)
+00003b20: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00003b30: 6c65 6e28 6c61 7965 7273 2920 3d3d 2031  len(layers) == 1
+00003b40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00003b50: 2020 6461 7461 736f 7572 6365 5f6c 6179    datasource_lay
+00003b60: 6572 203d 2064 6174 6173 6f75 7263 652e  er = datasource.
+00003b70: 4765 744c 6179 6572 286c 6179 6572 735b  GetLayer(layers[
+00003b80: 305d 290a 2020 2020 2020 2020 2020 2020  0]).            
+00003b90: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00003ba0: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
+00003bb0: 6545 7272 6f72 280a 2020 2020 2020 2020  eError(.        
+00003bc0: 2020 2020 2020 2020 2020 2020 6622 696e              f"in
+00003bd0: 7075 7420 6861 7320 3e20 3120 6c61 7965  put has > 1 laye
+00003be0: 722c 2062 7574 206e 6f20 6c61 7965 7220  r, but no layer 
+00003bf0: 7370 6563 6966 6965 643a 207b 7061 7468  specified: {path
+00003c00: 7d3a 207b 6c61 7965 7273 7d22 0a20 2020  }: {layers}".   
+00003c10: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
+00003c20: 2020 2020 2020 2020 7265 7475 726e 2064          return d
+00003c30: 6174 6173 6f75 7263 655f 6c61 7965 722e  atasource_layer.
+00003c40: 4765 744e 616d 6528 290a 0a20 2020 2065  GetName()..    e
+00003c50: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
+00003c60: 6173 2065 783a 0a20 2020 2020 2020 2065  as ex:.        e
+00003c70: 782e 6172 6773 203d 2028 6622 6765 745f  x.args = (f"get_
+00003c80: 6f6e 6c79 5f6c 6179 6572 2065 7272 6f72  only_layer error
+00003c90: 2066 6f72 207b 7061 7468 7d3a 5c6e 2020   for {path}:\n  
+00003ca0: 7b65 787d 222c 290a 2020 2020 2020 2020  {ex}",).        
+00003cb0: 7261 6973 650a 2020 2020 6669 6e61 6c6c  raise.    finall
+00003cc0: 793a 0a20 2020 2020 2020 2064 6174 6173  y:.        datas
+00003cd0: 6f75 7263 6520 3d20 4e6f 6e65 0a0a 0a64  ource = None...d
+00003ce0: 6566 2067 6574 5f64 6566 6175 6c74 5f6c  ef get_default_l
+00003cf0: 6179 6572 2870 6174 683a 2055 6e69 6f6e  ayer(path: Union
+00003d00: 5b73 7472 2c20 226f 732e 5061 7468 4c69  [str, "os.PathLi
+00003d10: 6b65 5b41 6e79 5d22 5d29 202d 3e20 7374  ke[Any]"]) -> st
+00003d20: 723a 0a20 2020 2022 2222 0a20 2020 2047  r:.    """.    G
+00003d30: 6574 2074 6865 2064 6566 6175 6c74 206c  et the default l
+00003d40: 6179 6572 206e 616d 6520 746f 2062 6520  ayer name to be 
+00003d50: 7573 6564 2066 6f72 2061 206c 6179 6572  used for a layer
+00003d60: 2069 6e20 7468 6973 2066 696c 652e 0a0a   in this file...
+00003d70: 2020 2020 5468 6973 2069 7320 7468 6520      This is the 
+00003d80: 7374 656d 206f 6620 7468 6520 6669 6c65  stem of the file
+00003d90: 7061 7468 2e0a 0a20 2020 2041 7267 733a  path...    Args:
+00003da0: 0a20 2020 2020 2020 2070 6174 6820 2855  .        path (U
+00003db0: 6e69 6f6e 5b73 7472 2c29 3a20 5468 6520  nion[str,): The 
+00003dc0: 7061 7468 2074 6f20 7468 6520 6669 6c65  path to the file
+00003dd0: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
+00003de0: 2020 2020 2020 2020 7374 723a 2054 6865          str: The
+00003df0: 2064 6566 6175 6c74 206c 6179 6572 206e   default layer n
+00003e00: 616d 652e 0a20 2020 2022 2222 0a20 2020  ame..    """.   
+00003e10: 2072 6574 7572 6e20 5061 7468 2870 6174   return Path(pat
+00003e20: 6829 2e73 7465 6d0a 0a0a 6465 6620 6578  h).stem...def ex
+00003e30: 6563 7574 655f 7371 6c28 0a20 2020 2070  ecute_sql(.    p
+00003e40: 6174 683a 2055 6e69 6f6e 5b73 7472 2c20  ath: Union[str, 
+00003e50: 226f 732e 5061 7468 4c69 6b65 5b41 6e79  "os.PathLike[Any
+00003e60: 5d22 5d2c 0a20 2020 2073 716c 5f73 746d  ]"],.    sql_stm
+00003e70: 743a 2073 7472 2c0a 2020 2020 7371 6c5f  t: str,.    sql_
+00003e80: 6469 616c 6563 743a 204f 7074 696f 6e61  dialect: Optiona
+00003e90: 6c5b 7374 725d 203d 204e 6f6e 652c 0a29  l[str] = None,.)
+00003ea0: 3a0a 2020 2020 2222 220a 2020 2020 4578  :.    """.    Ex
+00003eb0: 6563 7574 6520 6120 5351 4c20 7374 6174  ecute a SQL stat
+00003ec0: 656d 656e 7420 2844 4d4c 206f 7220 4444  ement (DML or DD
+00003ed0: 4c29 206f 6e20 7468 6520 6669 6c65 2e0a  L) on the file..
+00003ee0: 0a20 2020 2054 6f20 7275 6e20 5345 4c45  .    To run SELE
+00003ef0: 4354 2053 514c 2073 7461 7465 6d65 6e74  CT SQL statement
+00003f00: 7320 6f6e 2061 2066 696c 652c 2075 7365  s on a file, use
+00003f10: 203a 6d65 7468 3a60 7e72 6561 645f 6669   :meth:`~read_fi
+00003f20: 6c65 602e 0a0a 2020 2020 4172 6773 3a0a  le`...    Args:.
+00003f30: 2020 2020 2020 2020 7061 7468 2028 5061          path (Pa
+00003f40: 7468 4c69 6b65 293a 2054 6865 2070 6174  thLike): The pat
+00003f50: 6820 746f 2074 6865 2066 696c 652e 0a20  h to the file.. 
+00003f60: 2020 2020 2020 2073 716c 5f73 746d 7420         sql_stmt 
+00003f70: 2873 7472 293a 2054 6865 2053 514c 2073  (str): The SQL s
+00003f80: 7461 7465 6d65 6e74 2074 6f20 6578 6563  tatement to exec
+00003f90: 7574 652e 0a20 2020 2020 2020 2073 716c  ute..        sql
+00003fa0: 5f64 6961 6c65 6374 2028 7374 7229 3a20  _dialect (str): 
+00003fb0: 5468 6520 5351 4c20 6469 616c 6563 7420  The SQL dialect 
+00003fc0: 746f 2075 7365 3a0a 2020 2020 2020 2020  to use:.        
+00003fd0: 2020 2020 2a20 4e6f 6e65 3a20 7573 6520      * None: use 
+00003fe0: 7468 6520 6e61 7469 7665 2053 514c 2064  the native SQL d
+00003ff0: 6961 6c65 6374 206f 6620 7468 6520 6765  ialect of the ge
+00004000: 6f66 696c 652e 0a20 2020 2020 2020 2020  ofile..         
+00004010: 2020 202a 2027 4f47 5253 514c 273a 2066     * 'OGRSQL': f
+00004020: 6f72 6365 2074 6865 2075 7365 206f 6620  orce the use of 
+00004030: 7468 6520 4f47 5220 5351 4c20 6469 616c  the OGR SQL dial
+00004040: 6563 742e 0a20 2020 2020 2020 2020 2020  ect..           
+00004050: 202a 2027 5351 4c49 5445 273a 2066 6f72   * 'SQLITE': for
+00004060: 6365 2074 6865 2075 7365 206f 6620 7468  ce the use of th
+00004070: 6520 5351 4c49 5445 2064 6961 6c65 6374  e SQLITE dialect
+00004080: 2e0a 2020 2020 2020 2020 2020 2020 4465  ..            De
+00004090: 6661 756c 7473 2074 6f20 4e6f 6e65 2e0a  faults to None..
+000040a0: 2020 2020 2222 220a 2020 2020 6461 7461      """.    data
+000040b0: 736f 7572 6365 203d 204e 6f6e 650a 2020  source = None.  
+000040c0: 2020 7472 793a 0a20 2020 2020 2020 2064    try:.        d
+000040d0: 6174 6173 6f75 7263 6520 3d20 6764 616c  atasource = gdal
+000040e0: 2e4f 7065 6e45 7828 7374 7228 7061 7468  .OpenEx(str(path
+000040f0: 292c 206e 4f70 656e 466c 6167 733d 6764  ), nOpenFlags=gd
+00004100: 616c 2e4f 465f 5550 4441 5445 290a 2020  al.OF_UPDATE).  
+00004110: 2020 2020 2020 7265 7375 6c74 203d 2064        result = d
+00004120: 6174 6173 6f75 7263 652e 4578 6563 7574  atasource.Execut
+00004130: 6553 514c 2873 716c 5f73 746d 742c 2064  eSQL(sql_stmt, d
+00004140: 6961 6c65 6374 3d73 716c 5f64 6961 6c65  ialect=sql_diale
+00004150: 6374 290a 2020 2020 2020 2020 6461 7461  ct).        data
+00004160: 736f 7572 6365 2e52 656c 6561 7365 5265  source.ReleaseRe
+00004170: 7375 6c74 5365 7428 7265 7375 6c74 290a  sultSet(result).
+00004180: 0a20 2020 2065 7863 6570 7420 4578 6365  .    except Exce
+00004190: 7074 696f 6e20 6173 2065 783a 0a20 2020  ption as ex:.   
+000041a0: 2020 2020 2065 782e 6172 6773 203d 2028       ex.args = (
+000041b0: 6622 6578 6563 7574 655f 7371 6c20 6572  f"execute_sql er
+000041c0: 726f 7220 666f 7220 7b70 6174 687d 5c6e  ror for {path}\n
+000041d0: 2020 7b65 787d 222c 290a 2020 2020 2020    {ex}",).      
+000041e0: 2020 7261 6973 650a 2020 2020 6669 6e61    raise.    fina
+000041f0: 6c6c 793a 0a20 2020 2020 2020 2064 6174  lly:.        dat
+00004200: 6173 6f75 7263 6520 3d20 4e6f 6e65 0a0a  asource = None..
+00004210: 0a64 6566 2063 7265 6174 655f 7370 6174  .def create_spat
+00004220: 6961 6c5f 696e 6465 7828 0a20 2020 2070  ial_index(.    p
+00004230: 6174 683a 2055 6e69 6f6e 5b73 7472 2c20  ath: Union[str, 
+00004240: 226f 732e 5061 7468 4c69 6b65 5b41 6e79  "os.PathLike[Any
+00004250: 5d22 5d2c 0a20 2020 206c 6179 6572 3a20  ]"],.    layer: 
+00004260: 4f70 7469 6f6e 616c 5b73 7472 5d20 3d20  Optional[str] = 
+00004270: 4e6f 6e65 2c0a 2020 2020 6361 6368 655f  None,.    cache_
+00004280: 7369 7a65 5f6d 623a 204f 7074 696f 6e61  size_mb: Optiona
+00004290: 6c5b 696e 745d 203d 2031 3238 2c0a 2020  l[int] = 128,.  
+000042a0: 2020 6578 6973 745f 6f6b 3a20 626f 6f6c    exist_ok: bool
+000042b0: 203d 2046 616c 7365 2c0a 2020 2020 666f   = False,.    fo
+000042c0: 7263 655f 7265 6275 696c 643a 2062 6f6f  rce_rebuild: boo
+000042d0: 6c20 3d20 4661 6c73 652c 0a20 2020 206e  l = False,.    n
+000042e0: 6f5f 6765 6f6d 5f6f 6b3a 2062 6f6f 6c20  o_geom_ok: bool 
+000042f0: 3d20 4661 6c73 652c 0a29 3a0a 2020 2020  = False,.):.    
+00004300: 2222 220a 2020 2020 4372 6561 7465 2061  """.    Create a
+00004310: 2073 7061 7469 616c 2069 6e64 6578 206f   spatial index o
+00004320: 6e20 7468 6520 6c61 7965 7220 7370 6563  n the layer spec
+00004330: 6966 6965 642e 0a0a 2020 2020 4172 6773  ified...    Args
+00004340: 3a0a 2020 2020 2020 2020 7061 7468 2028  :.        path (
+00004350: 5061 7468 4c69 6b65 293a 2054 6865 2066  PathLike): The f
+00004360: 696c 6520 7061 7468 2e0a 2020 2020 2020  ile path..      
+00004370: 2020 6c61 7965 7220 2873 7472 2c20 6f70    layer (str, op
+00004380: 7469 6f6e 616c 293a 2054 6865 206c 6179  tional): The lay
+00004390: 6572 2e20 4966 206e 6f74 2073 7065 6369  er. If not speci
+000043a0: 6669 6564 2c20 616e 6420 7468 6572 6520  fied, and there 
+000043b0: 6973 206f 6e6c 790a 2020 2020 2020 2020  is only.        
+000043c0: 2020 2020 6f6e 6520 6c61 7965 7220 696e      one layer in
+000043d0: 2074 6865 2066 696c 652c 2074 6869 7320   the file, this 
+000043e0: 6c61 7965 7220 6973 2075 7365 642e 204f  layer is used. O
+000043f0: 7468 6572 7769 7365 2065 7863 6570 7469  therwise excepti
+00004400: 6f6e 2e0a 2020 2020 2020 2020 6361 6368  on..        cach
+00004410: 655f 7369 7a65 5f6d 6220 2869 6e74 2c20  e_size_mb (int, 
+00004420: 6f70 7469 6f6e 616c 293a 2063 6163 6865  optional): cache
+00004430: 206d 656d 6f72 7920 696e 204d 4220 7468   memory in MB th
+00004440: 6174 2063 616e 2062 6520 7573 6564 2077  at can be used w
+00004450: 6869 6c65 0a20 2020 2020 2020 2020 2020  hile.           
+00004460: 2063 7265 6174 696e 6720 7370 6174 6961   creating spatia
+00004470: 6c20 696e 6465 7820 666f 7220 7370 6174  l index for spat
+00004480: 6961 6c69 7465 2066 696c 6573 2028 2e67  ialite files (.g
+00004490: 706b 6720 6f72 202e 7371 6c69 7465 292e  pkg or .sqlite).
+000044a0: 2049 6620 4e6f 6e65 2c0a 2020 2020 2020   If None,.      
+000044b0: 2020 2020 2020 7468 6520 6465 6661 756c        the defaul
+000044c0: 7420 6361 6368 655f 7369 7a65 2066 726f  t cache_size fro
+000044d0: 6d20 7371 6c69 7465 2069 7320 7573 6564  m sqlite is used
+000044e0: 2e20 4465 6661 756c 7473 2074 6f20 3132  . Defaults to 12
+000044f0: 382e 0a20 2020 2020 2020 2065 7869 7374  8..        exist
+00004500: 5f6f 6b20 2862 6f6f 6c2c 206f 7074 696f  _ok (bool, optio
+00004510: 6e61 6c29 3a20 4966 2054 7275 6520 616e  nal): If True an
+00004520: 6420 7468 6520 696e 6465 7820 6578 6973  d the index exis
+00004530: 7473 2061 6c72 6561 6479 2c20 646f 6e27  ts already, don'
+00004540: 740a 2020 2020 2020 2020 2020 2020 7468  t.            th
+00004550: 726f 7720 616e 2065 7272 6f72 2e20 4465  row an error. De
+00004560: 6661 756c 7473 2074 6f20 4661 6c73 652e  faults to False.
+00004570: 0a20 2020 2020 2020 2066 6f72 6365 5f72  .        force_r
+00004580: 6562 7569 6c64 2028 626f 6f6c 2c20 6f70  ebuild (bool, op
+00004590: 7469 6f6e 7329 3a20 5472 7565 2074 6f20  tions): True to 
+000045a0: 666f 7263 6520 7265 6275 696c 6420 6576  force rebuild ev
+000045b0: 656e 2069 6620 696e 6465 780a 2020 2020  en if index.    
+000045c0: 2020 2020 2020 2020 6578 6973 7473 2061          exists a
+000045d0: 6c72 6561 6479 2e20 4465 6661 756c 7473  lready. Defaults
+000045e0: 2074 6f20 4661 6c73 652e 0a20 2020 2020   to False..     
+000045f0: 2020 206e 6f5f 6765 6f6d 5f6f 6b20 2862     no_geom_ok (b
+00004600: 6f6f 6c2c 206f 7074 696f 6e73 293a 2049  ool, options): I
+00004610: 6620 5472 7565 2061 6e64 2074 6865 2066  f True and the f
+00004620: 696c 6520 646f 6573 6e27 7420 6861 7665  ile doesn't have
+00004630: 2061 2067 656f 6d65 7472 7920 636f 6c75   a geometry colu
+00004640: 6d6e 2c0a 2020 2020 2020 2020 2020 2020  mn,.            
+00004650: 646f 6e27 7420 7468 726f 7720 616e 2065  don't throw an e
+00004660: 7272 6f72 2e20 4465 6661 756c 7473 2074  rror. Defaults t
+00004670: 6f20 4661 6c73 652e 0a20 2020 2022 2222  o False..    """
+00004680: 0a20 2020 2023 2049 6e69 740a 2020 2020  .    # Init.    
+00004690: 7061 7468 203d 2050 6174 6828 7061 7468  path = Path(path
+000046a0: 290a 2020 2020 6966 206c 6179 6572 2069  ).    if layer i
+000046b0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+000046c0: 6c61 7965 7220 3d20 6765 745f 6f6e 6c79  layer = get_only
+000046d0: 5f6c 6179 6572 2870 6174 6829 0a0a 2020  _layer(path)..  
+000046e0: 2020 2320 4164 6420 696e 6465 780a 2020    # Add index.  
+000046f0: 2020 6461 7461 736f 7572 6365 203d 204e    datasource = N
+00004700: 6f6e 650a 2020 2020 7472 793a 0a20 2020  one.    try:.   
+00004710: 2020 2020 2070 6174 685f 696e 666f 203d       path_info =
+00004720: 205f 6765 6f66 696c 6569 6e66 6f2e 6765   _geofileinfo.ge
+00004730: 745f 6765 6f66 696c 6569 6e66 6f28 7061  t_geofileinfo(pa
+00004740: 7468 290a 0a20 2020 2020 2020 206c 6179  th)..        lay
+00004750: 6572 696e 666f 203d 2067 6574 5f6c 6179  erinfo = get_lay
+00004760: 6572 696e 666f 2870 6174 682c 206c 6179  erinfo(path, lay
+00004770: 6572 2c20 7261 6973 655f 6f6e 5f6e 6f67  er, raise_on_nog
+00004780: 656f 6d3d 6e6f 7420 6e6f 5f67 656f 6d5f  eom=not no_geom_
+00004790: 6f6b 290a 2020 2020 2020 2020 6966 206e  ok).        if n
+000047a0: 6f5f 6765 6f6d 5f6f 6b20 616e 6420 6c61  o_geom_ok and la
+000047b0: 7965 7269 6e66 6f2e 6765 6f6d 6574 7279  yerinfo.geometry
+000047c0: 636f 6c75 6d6e 2069 7320 4e6f 6e65 3a0a  column is None:.
+000047d0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+000047e0: 726e 0a0a 2020 2020 2020 2020 2320 4966  rn..        # If
+000047f0: 2069 6e64 6578 2061 6c72 6561 6479 2065   index already e
+00004800: 7869 7374 732c 2072 656d 6f76 6520 696e  xists, remove in
+00004810: 6465 7820 6f72 2072 6574 7572 6e0a 2020  dex or return.  
+00004820: 2020 2020 2020 6966 2068 6173 5f73 7061        if has_spa
+00004830: 7469 616c 5f69 6e64 6578 2870 6174 682c  tial_index(path,
+00004840: 206c 6179 6572 293a 0a20 2020 2020 2020   layer):.       
+00004850: 2020 2020 2069 6620 666f 7263 655f 7265       if force_re
+00004860: 6275 696c 643a 0a20 2020 2020 2020 2020  build:.         
+00004870: 2020 2020 2020 2072 656d 6f76 655f 7370         remove_sp
+00004880: 6174 6961 6c5f 696e 6465 7828 7061 7468  atial_index(path
+00004890: 2c20 6c61 7965 7229 0a20 2020 2020 2020  , layer).       
+000048a0: 2020 2020 2065 6c69 6620 6578 6973 745f       elif exist_
+000048b0: 6f6b 3a0a 2020 2020 2020 2020 2020 2020  ok:.            
+000048c0: 2020 2020 7265 7475 726e 0a20 2020 2020      return.     
+000048d0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+000048e0: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+000048f0: 7365 2052 756e 7469 6d65 4572 726f 7228  se RuntimeError(
+00004900: 6622 7370 6174 6961 6c20 696e 6465 7820  f"spatial index 
+00004910: 6578 6973 7473 2061 6c72 6561 6479 206f  exists already o
+00004920: 6e20 7b70 6174 687d 2e7b 6c61 7965 727d  n {path}.{layer}
+00004930: 2229 0a0a 2020 2020 2020 2020 6966 2070  ")..        if p
+00004940: 6174 685f 696e 666f 2e69 735f 7370 6174  ath_info.is_spat
+00004950: 6961 6c69 7465 5f62 6173 6564 3a0a 2020  ialite_based:.  
+00004960: 2020 2020 2020 2020 2020 2320 5468 6520            # The 
+00004970: 636f 6e66 6967 206f 7074 696f 6e73 206e  config options n
+00004980: 6565 6420 746f 2062 6520 7365 7420 6265  eed to be set be
+00004990: 666f 7265 206f 7065 6e69 6e67 2074 6865  fore opening the
+000049a0: 2066 696c 6521 0a20 2020 2020 2020 2020   file!.         
+000049b0: 2020 2077 6974 6820 5f6f 6772 5f75 7469     with _ogr_uti
+000049c0: 6c2e 7365 745f 636f 6e66 6967 5f6f 7074  l.set_config_opt
+000049d0: 696f 6e73 287b 224f 4752 5f53 514c 4954  ions({"OGR_SQLIT
+000049e0: 455f 4341 4348 4522 3a20 6361 6368 655f  E_CACHE": cache_
+000049f0: 7369 7a65 5f6d 627d 293a 0a20 2020 2020  size_mb}):.     
+00004a00: 2020 2020 2020 2020 2020 2064 6174 6173             datas
+00004a10: 6f75 7263 6520 3d20 6764 616c 2e4f 7065  ource = gdal.Ope
+00004a20: 6e45 7828 7374 7228 7061 7468 292c 206e  nEx(str(path), n
+00004a30: 4f70 656e 466c 6167 733d 6764 616c 2e4f  OpenFlags=gdal.O
+00004a40: 465f 5550 4441 5445 290a 2020 2020 2020  F_UPDATE).      
+00004a50: 2020 2020 2020 2020 2020 6765 6f6d 6574            geomet
+00004a60: 7279 636f 6c75 6d6e 203d 206c 6179 6572  rycolumn = layer
+00004a70: 696e 666f 2e67 656f 6d65 7472 7963 6f6c  info.geometrycol
+00004a80: 756d 6e0a 2020 2020 2020 2020 2020 2020  umn.            
+00004a90: 2020 2020 7371 6c20 3d20 6622 5345 4c45      sql = f"SELE
+00004aa0: 4354 2043 7265 6174 6553 7061 7469 616c  CT CreateSpatial
+00004ab0: 496e 6465 7828 277b 6c61 7965 727d 272c  Index('{layer}',
+00004ac0: 2027 7b67 656f 6d65 7472 7963 6f6c 756d   '{geometrycolum
+00004ad0: 6e7d 2729 220a 2020 2020 2020 2020 2020  n}')".          
+00004ae0: 2020 2020 2020 7265 7375 6c74 203d 2064        result = d
+00004af0: 6174 6173 6f75 7263 652e 4578 6563 7574  atasource.Execut
+00004b00: 6553 514c 2873 716c 2c20 6469 616c 6563  eSQL(sql, dialec
+00004b10: 743d 2253 514c 4954 4522 290a 2020 2020  t="SQLITE").    
+00004b20: 2020 2020 2020 2020 2020 2020 6461 7461              data
+00004b30: 736f 7572 6365 2e52 656c 6561 7365 5265  source.ReleaseRe
+00004b40: 7375 6c74 5365 7428 7265 7375 6c74 290a  sultSet(result).
+00004b50: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00004b60: 2020 2020 2020 2020 2020 6461 7461 736f            dataso
+00004b70: 7572 6365 203d 2067 6461 6c2e 4f70 656e  urce = gdal.Open
+00004b80: 4578 2873 7472 2870 6174 6829 2c20 6e4f  Ex(str(path), nO
+00004b90: 7065 6e46 6c61 6773 3d67 6461 6c2e 4f46  penFlags=gdal.OF
+00004ba0: 5f55 5044 4154 4529 0a20 2020 2020 2020  _UPDATE).       
+00004bb0: 2020 2020 2072 6573 756c 7420 3d20 6461       result = da
+00004bc0: 7461 736f 7572 6365 2e45 7865 6375 7465  tasource.Execute
+00004bd0: 5351 4c28 6627 4352 4541 5445 2053 5041  SQL(f'CREATE SPA
+00004be0: 5449 414c 2049 4e44 4558 204f 4e20 227b  TIAL INDEX ON "{
+00004bf0: 6c61 7965 727d 2227 290a 2020 2020 2020  layer}"').      
+00004c00: 2020 2020 2020 6461 7461 736f 7572 6365        datasource
+00004c10: 2e52 656c 6561 7365 5265 7375 6c74 5365  .ReleaseResultSe
+00004c20: 7428 7265 7375 6c74 290a 0a20 2020 2065  t(result)..    e
+00004c30: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
+00004c40: 6173 2065 783a 0a20 2020 2020 2020 2069  as ex:.        i
+00004c50: 6620 6973 696e 7374 616e 6365 2865 782c  f isinstance(ex,
+00004c60: 2056 616c 7565 4572 726f 7229 2061 6e64   ValueError) and
+00004c70: 2073 7472 2865 7829 2e73 7461 7274 7377   str(ex).startsw
+00004c80: 6974 6828 0a20 2020 2020 2020 2020 2020  ith(.           
+00004c90: 2022 6861 735f 7370 6174 6961 6c5f 696e   "has_spatial_in
+00004ca0: 6465 7820 6e6f 7420 7375 7070 6f72 7465  dex not supporte
+00004cb0: 6420 666f 7222 0a20 2020 2020 2020 2029  d for".        )
+00004cc0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+00004cd0: 6973 6520 5661 6c75 6545 7272 6f72 280a  ise ValueError(.
+00004ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004cf0: 6622 6372 6561 7465 5f73 7061 7469 616c  f"create_spatial
+00004d00: 5f69 6e64 6578 206e 6f74 2073 7570 706f  _index not suppo
+00004d10: 7274 6564 2066 6f72 207b 7061 7468 5f69  rted for {path_i
+00004d20: 6e66 6f2e 6472 6976 6572 7d3a 207b 7061  nfo.driver}: {pa
+00004d30: 7468 7d22 0a20 2020 2020 2020 2020 2020  th}".           
+00004d40: 2029 2066 726f 6d20 6578 0a20 2020 2020   ) from ex.     
+00004d50: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00004d60: 2020 2020 2065 782e 6172 6773 203d 2028       ex.args = (
+00004d70: 6622 6372 6561 7465 5f73 7061 7469 616c  f"create_spatial
+00004d80: 5f69 6e64 6578 2065 7272 6f72 3a20 7b65  _index error: {e
+00004d90: 787d 2c20 666f 7220 7b70 6174 687d 2e7b  x}, for {path}.{
+00004da0: 6c61 7965 727d 222c 290a 2020 2020 2020  layer}",).      
+00004db0: 2020 7261 6973 650a 2020 2020 6669 6e61    raise.    fina
+00004dc0: 6c6c 793a 0a20 2020 2020 2020 2064 6174  lly:.        dat
+00004dd0: 6173 6f75 7263 6520 3d20 4e6f 6e65 0a0a  asource = None..
+00004de0: 2020 2020 6966 206e 6f74 2068 6173 5f73      if not has_s
+00004df0: 7061 7469 616c 5f69 6e64 6578 2870 6174  patial_index(pat
+00004e00: 682c 206c 6179 6572 293a 0a20 2020 2020  h, layer):.     
+00004e10: 2020 2072 6169 7365 2052 756e 7469 6d65     raise Runtime
+00004e20: 4572 726f 7228 6622 6372 6561 7465 5f73  Error(f"create_s
+00004e30: 7061 7469 616c 5f69 6e64 6578 2066 6169  patial_index fai
+00004e40: 6c65 6420 6f6e 207b 7061 7468 7d2c 206c  led on {path}, l
+00004e50: 6179 6572 3a20 7b6c 6179 6572 7d22 290a  ayer: {layer}").
+00004e60: 0a0a 6465 6620 6861 735f 7370 6174 6961  ..def has_spatia
+00004e70: 6c5f 696e 6465 7828 0a20 2020 2070 6174  l_index(.    pat
+00004e80: 683a 2055 6e69 6f6e 5b73 7472 2c20 226f  h: Union[str, "o
+00004e90: 732e 5061 7468 4c69 6b65 5b41 6e79 5d22  s.PathLike[Any]"
+00004ea0: 5d2c 0a20 2020 206c 6179 6572 3a20 4f70  ],.    layer: Op
+00004eb0: 7469 6f6e 616c 5b73 7472 5d20 3d20 4e6f  tional[str] = No
+00004ec0: 6e65 2c0a 2020 2020 6e6f 5f67 656f 6d5f  ne,.    no_geom_
+00004ed0: 6f6b 3a20 626f 6f6c 203d 2046 616c 7365  ok: bool = False
+00004ee0: 2c0a 2920 2d3e 2062 6f6f 6c3a 0a20 2020  ,.) -> bool:.   
+00004ef0: 2022 2222 0a20 2020 2043 6865 636b 2069   """.    Check i
+00004f00: 6620 7468 6520 6c61 7965 722f 636f 6c75  f the layer/colu
+00004f10: 6d6e 2068 6173 2061 2073 7061 7469 616c  mn has a spatial
+00004f20: 2069 6e64 6578 2e0a 0a20 2020 2041 7267   index...    Arg
+00004f30: 733a 0a20 2020 2020 2020 2070 6174 6820  s:.        path 
+00004f40: 2850 6174 684c 696b 6529 3a20 5468 6520  (PathLike): The 
+00004f50: 6669 6c65 2070 6174 682e 0a20 2020 2020  file path..     
+00004f60: 2020 206c 6179 6572 2028 7374 722c 206f     layer (str, o
+00004f70: 7074 696f 6e61 6c29 3a20 5468 6520 6c61  ptional): The la
+00004f80: 7965 722e 2044 6566 6175 6c74 7320 746f  yer. Defaults to
+00004f90: 204e 6f6e 652e 0a20 2020 2020 2020 206e   None..        n
+00004fa0: 6f5f 6765 6f6d 5f6f 6b20 2862 6f6f 6c2c  o_geom_ok (bool,
+00004fb0: 206f 7074 696f 6e73 293a 2049 6620 5472   options): If Tr
+00004fc0: 7565 2061 6e64 2074 6865 2066 696c 6520  ue and the file 
+00004fd0: 646f 6573 6e27 7420 6861 7665 2061 2067  doesn't have a g
+00004fe0: 656f 6d65 7472 7920 636f 6c75 6d6e 2c0a  eometry column,.
+00004ff0: 2020 2020 2020 2020 2020 2020 646f 6e27              don'
+00005000: 7420 7468 726f 7720 616e 2065 7272 6f72  t throw an error
+00005010: 2e20 4465 6661 756c 7473 2074 6f20 4661  . Defaults to Fa
+00005020: 6c73 652e 0a0a 2020 2020 5261 6973 6573  lse...    Raises
+00005030: 3a0a 2020 2020 2020 2020 5661 6c75 6545  :.        ValueE
+00005040: 7272 6f72 3a20 616e 2069 6e76 616c 6964  rror: an invalid
+00005050: 2070 6172 616d 6574 6572 2076 616c 7565   parameter value
+00005060: 2077 6173 2070 6173 7365 642e 0a0a 2020   was passed...  
+00005070: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
+00005080: 2020 2062 6f6f 6c3a 2054 7275 6520 6966     bool: True if
+00005090: 2061 2073 7061 7469 616c 2069 6e64 6578   a spatial index
+000050a0: 2065 7869 7374 732c 2046 616c 7365 2069   exists, False i
+000050b0: 6620 6974 2064 6f65 736e 2774 2065 7869  f it doesn't exi
+000050c0: 7374 2e0a 2020 2020 2222 220a 2020 2020  st..    """.    
+000050d0: 2320 496e 6974 0a20 2020 2070 6174 6820  # Init.    path 
+000050e0: 3d20 5061 7468 2870 6174 6829 0a0a 2020  = Path(path)..  
+000050f0: 2020 2320 4e6f 7720 6368 6563 6b20 7468    # Now check th
+00005100: 6520 696e 6465 780a 2020 2020 6461 7461  e index.    data
+00005110: 736f 7572 6365 203d 204e 6f6e 650a 2020  source = None.  
+00005120: 2020 7061 7468 5f69 6e66 6f20 3d20 5f67    path_info = _g
+00005130: 656f 6669 6c65 696e 666f 2e67 6574 5f67  eofileinfo.get_g
+00005140: 656f 6669 6c65 696e 666f 2870 6174 6829  eofileinfo(path)
+00005150: 0a20 2020 2074 7279 3a0a 2020 2020 2020  .    try:.      
+00005160: 2020 6966 2070 6174 685f 696e 666f 2e69    if path_info.i
+00005170: 735f 7370 6174 6961 6c69 7465 5f62 6173  s_spatialite_bas
+00005180: 6564 3a0a 2020 2020 2020 2020 2020 2020  ed:.            
+00005190: 6c61 7965 7269 6e66 6f20 3d20 6765 745f  layerinfo = get_
+000051a0: 6c61 7965 7269 6e66 6f28 7061 7468 2c20  layerinfo(path, 
+000051b0: 6c61 7965 722c 2072 6169 7365 5f6f 6e5f  layer, raise_on_
+000051c0: 6e6f 6765 6f6d 3d6e 6f74 206e 6f5f 6765  nogeom=not no_ge
+000051d0: 6f6d 5f6f 6b29 0a20 2020 2020 2020 2020  om_ok).         
+000051e0: 2020 2069 6620 6e6f 5f67 656f 6d5f 6f6b     if no_geom_ok
+000051f0: 2061 6e64 206c 6179 6572 696e 666f 2e67   and layerinfo.g
+00005200: 656f 6d65 7472 7963 6f6c 756d 6e20 6973  eometrycolumn is
+00005210: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00005220: 2020 2020 2020 2072 6574 7572 6e20 4661         return Fa
+00005230: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
+00005240: 6461 7461 736f 7572 6365 203d 2067 6461  datasource = gda
+00005250: 6c2e 4f70 656e 4578 2873 7472 2870 6174  l.OpenEx(str(pat
+00005260: 6829 2c20 6e4f 7065 6e46 6c61 6773 3d67  h), nOpenFlags=g
+00005270: 6461 6c2e 4f46 5f52 4541 444f 4e4c 5929  dal.OF_READONLY)
+00005280: 0a20 2020 2020 2020 2020 2020 2073 716c  .            sql
+00005290: 203d 2066 2222 220a 2020 2020 2020 2020   = f""".        
+000052a0: 2020 2020 2020 2020 5345 4c45 4354 2048          SELECT H
+000052b0: 6173 5370 6174 6961 6c49 6e64 6578 2827  asSpatialIndex('
+000052c0: 7b6c 6179 6572 696e 666f 2e6e 616d 657d  {layerinfo.name}
+000052d0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+000052e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000052f0: 2020 2020 2020 2020 2020 277b 6c61 7965            '{laye
+00005300: 7269 6e66 6f2e 6765 6f6d 6574 7279 636f  rinfo.geometryco
+00005310: 6c75 6d6e 7d27 290a 2020 2020 2020 2020  lumn}').        
+00005320: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00005330: 2020 2020 7265 7375 6c74 203d 2064 6174      result = dat
+00005340: 6173 6f75 7263 652e 4578 6563 7574 6553  asource.ExecuteS
+00005350: 514c 2873 716c 2c20 6469 616c 6563 743d  QL(sql, dialect=
+00005360: 2253 514c 4954 4522 290a 2020 2020 2020  "SQLITE").      
+00005370: 2020 2020 2020 6861 735f 7370 6174 6961        has_spatia
+00005380: 6c5f 696e 6465 7820 3d20 7265 7375 6c74  l_index = result
+00005390: 2e47 6574 4e65 7874 4665 6174 7572 6528  .GetNextFeature(
+000053a0: 292e 4765 7446 6965 6c64 2830 2920 3d3d  ).GetField(0) ==
+000053b0: 2031 0a20 2020 2020 2020 2020 2020 2064   1.            d
+000053c0: 6174 6173 6f75 7263 652e 5265 6c65 6173  atasource.Releas
+000053d0: 6552 6573 756c 7453 6574 2872 6573 756c  eResultSet(resul
+000053e0: 7429 0a20 2020 2020 2020 2020 2020 2072  t).            r
+000053f0: 6574 7572 6e20 6861 735f 7370 6174 6961  eturn has_spatia
+00005400: 6c5f 696e 6465 780a 2020 2020 2020 2020  l_index.        
+00005410: 656c 6966 2070 6174 685f 696e 666f 2e64  elif path_info.d
+00005420: 7269 7665 7220 3d3d 2022 4553 5249 2053  river == "ESRI S
+00005430: 6861 7065 6669 6c65 223a 0a20 2020 2020  hapefile":.     
+00005440: 2020 2020 2020 2069 6e64 6578 5f70 6174         index_pat
+00005450: 6820 3d20 7061 7468 2e70 6172 656e 7420  h = path.parent 
+00005460: 2f20 6622 7b70 6174 682e 7374 656d 7d2e  / f"{path.stem}.
+00005470: 7169 7822 0a20 2020 2020 2020 2020 2020  qix".           
+00005480: 2072 6574 7572 6e20 696e 6465 785f 7061   return index_pa
+00005490: 7468 2e65 7869 7374 7328 290a 2020 2020  th.exists().    
+000054a0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000054b0: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
+000054c0: 6545 7272 6f72 280a 2020 2020 2020 2020  eError(.        
+000054d0: 2020 2020 2020 2020 6622 6861 735f 7370          f"has_sp
+000054e0: 6174 6961 6c5f 696e 6465 7820 6e6f 7420  atial_index not 
+000054f0: 7375 7070 6f72 7465 6420 666f 7220 7b70  supported for {p
+00005500: 6174 685f 696e 666f 2e64 7269 7665 727d  ath_info.driver}
+00005510: 3a20 7b70 6174 687d 220a 2020 2020 2020  : {path}".      
+00005520: 2020 2020 2020 290a 0a20 2020 2065 7863        )..    exc
+00005530: 6570 7420 5661 6c75 6545 7272 6f72 3a0a  ept ValueError:.
+00005540: 2020 2020 2020 2020 7261 6973 650a 2020          raise.  
+00005550: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
+00005560: 6f6e 2061 7320 6578 3a0a 2020 2020 2020  on as ex:.      
+00005570: 2020 6578 2e61 7267 7320 3d20 2866 2268    ex.args = (f"h
+00005580: 6173 5f73 7061 7469 616c 5f69 6e64 6578  as_spatial_index
+00005590: 2065 7272 6f72 3a20 7b65 787d 2c20 666f   error: {ex}, fo
+000055a0: 7220 7b70 6174 687d 2e7b 6c61 7965 727d  r {path}.{layer}
+000055b0: 222c 290a 2020 2020 2020 2020 7261 6973  ",).        rais
+000055c0: 650a 2020 2020 6669 6e61 6c6c 793a 0a20  e.    finally:. 
+000055d0: 2020 2020 2020 2064 6174 6173 6f75 7263         datasourc
+000055e0: 6520 3d20 4e6f 6e65 0a0a 0a64 6566 2072  e = None...def r
+000055f0: 656d 6f76 655f 7370 6174 6961 6c5f 696e  emove_spatial_in
+00005600: 6465 7828 0a20 2020 2070 6174 683a 2055  dex(.    path: U
+00005610: 6e69 6f6e 5b73 7472 2c20 226f 732e 5061  nion[str, "os.Pa
+00005620: 7468 4c69 6b65 5b41 6e79 5d22 5d2c 206c  thLike[Any]"], l
+00005630: 6179 6572 3a20 4f70 7469 6f6e 616c 5b73  ayer: Optional[s
+00005640: 7472 5d20 3d20 4e6f 6e65 0a29 3a0a 2020  tr] = None.):.  
+00005650: 2020 2222 220a 2020 2020 5265 6d6f 7665    """.    Remove
+00005660: 2074 6865 2073 7061 7469 616c 2069 6e64   the spatial ind
+00005670: 6578 2066 726f 6d20 7468 6520 6c61 7965  ex from the laye
+00005680: 7220 7370 6563 6966 6965 642e 0a0a 2020  r specified...  
+00005690: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+000056a0: 7061 7468 2028 5061 7468 4c69 6b65 293a  path (PathLike):
+000056b0: 2054 6865 2066 696c 6520 7061 7468 2e0a   The file path..
+000056c0: 2020 2020 2020 2020 6c61 7965 7220 2873          layer (s
+000056d0: 7472 2c20 6f70 7469 6f6e 616c 293a 2054  tr, optional): T
+000056e0: 6865 206c 6179 6572 2e20 4966 206e 6f74  he layer. If not
+000056f0: 2073 7065 6369 6669 6564 2c20 616e 6420   specified, and 
+00005700: 7468 6572 6520 6973 206f 6e6c 790a 2020  there is only.  
+00005710: 2020 2020 2020 2020 2020 6f6e 6520 6c61            one la
+00005720: 7965 7220 696e 2074 6865 2066 696c 652c  yer in the file,
+00005730: 2074 6869 7320 6c61 7965 7220 6973 2075   this layer is u
+00005740: 7365 642e 204f 7468 6572 7769 7365 2065  sed. Otherwise e
+00005750: 7863 6570 7469 6f6e 2e0a 2020 2020 2222  xception..    ""
+00005760: 220a 2020 2020 2320 496e 6974 0a20 2020  ".    # Init.   
+00005770: 2070 6174 6820 3d20 5061 7468 2870 6174   path = Path(pat
+00005780: 6829 0a0a 2020 2020 2320 4e6f 7720 7265  h)..    # Now re
+00005790: 616c 6c79 2072 656d 6f76 6520 696e 6465  ally remove inde
+000057a0: 780a 2020 2020 6461 7461 736f 7572 6365  x.    datasource
+000057b0: 203d 204e 6f6e 650a 2020 2020 7061 7468   = None.    path
+000057c0: 5f69 6e66 6f20 3d20 5f67 656f 6669 6c65  _info = _geofile
+000057d0: 696e 666f 2e67 6574 5f67 656f 6669 6c65  info.get_geofile
+000057e0: 696e 666f 2870 6174 6829 0a20 2020 2070  info(path).    p
+000057f0: 6174 685f 6c61 7965 7269 6e66 6f20 3d20  ath_layerinfo = 
+00005800: 6765 745f 6c61 7965 7269 6e66 6f28 7061  get_layerinfo(pa
+00005810: 7468 2c20 6c61 7965 7229 0a20 2020 2074  th, layer).    t
+00005820: 7279 3a0a 2020 2020 2020 2020 6966 2070  ry:.        if p
+00005830: 6174 685f 696e 666f 2e69 735f 7370 6174  ath_info.is_spat
+00005840: 6961 6c69 7465 5f62 6173 6564 3a0a 2020  ialite_based:.  
+00005850: 2020 2020 2020 2020 2020 6461 7461 736f            dataso
+00005860: 7572 6365 203d 2067 6461 6c2e 4f70 656e  urce = gdal.Open
+00005870: 4578 2873 7472 2870 6174 6829 2c20 6e4f  Ex(str(path), nO
+00005880: 7065 6e46 6c61 6773 3d67 6461 6c2e 4f46  penFlags=gdal.OF
+00005890: 5f55 5044 4154 4529 0a20 2020 2020 2020  _UPDATE).       
+000058a0: 2020 2020 2072 6573 756c 7420 3d20 6461       result = da
+000058b0: 7461 736f 7572 6365 2e45 7865 6375 7465  tasource.Execute
+000058c0: 5351 4c28 0a20 2020 2020 2020 2020 2020  SQL(.           
+000058d0: 2020 2020 2022 5345 4c45 4354 2044 6973       "SELECT Dis
+000058e0: 6162 6c65 5370 6174 6961 6c49 6e64 6578  ableSpatialIndex
+000058f0: 2822 0a20 2020 2020 2020 2020 2020 2020  (".             
+00005900: 2020 2066 2220 2020 2020 2027 7b70 6174     f"      '{pat
+00005910: 685f 6c61 7965 7269 6e66 6f2e 6e61 6d65  h_layerinfo.name
+00005920: 7d27 2c20 277b 7061 7468 5f6c 6179 6572  }', '{path_layer
+00005930: 696e 666f 2e67 656f 6d65 7472 7963 6f6c  info.geometrycol
+00005940: 756d 6e7d 2729 222c 0a20 2020 2020 2020  umn}')",.       
+00005950: 2020 2020 2020 2020 2064 6961 6c65 6374           dialect
+00005960: 3d22 5351 4c49 5445 222c 0a20 2020 2020  ="SQLITE",.     
+00005970: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00005980: 2020 2020 2064 6174 6173 6f75 7263 652e       datasource.
+00005990: 5265 6c65 6173 6552 6573 756c 7453 6574  ReleaseResultSet
+000059a0: 2872 6573 756c 7429 0a20 2020 2020 2020  (result).       
+000059b0: 2065 6c69 6620 7061 7468 5f69 6e66 6f2e   elif path_info.
+000059c0: 6472 6976 6572 203d 3d20 2245 5352 4920  driver == "ESRI 
+000059d0: 5368 6170 6566 696c 6522 3a0a 2020 2020  Shapefile":.    
+000059e0: 2020 2020 2020 2020 2320 4452 4f50 2053          # DROP S
+000059f0: 5041 5449 414c 2049 4e44 4558 204f 4e20  PATIAL INDEX ON 
+00005a00: 2e2e 2e20 636f 6d6d 616e 6420 6769 7665  ... command give
+00005a10: 7320 616e 2065 7272 6f72 2c20 736f 206a  s an error, so j
+00005a20: 7573 7420 7265 6d6f 7665 202e 7169 780a  ust remove .qix.
+00005a30: 2020 2020 2020 2020 2020 2020 696e 6465              inde
+00005a40: 785f 7061 7468 203d 2070 6174 682e 7061  x_path = path.pa
+00005a50: 7265 6e74 202f 2066 227b 7061 7468 2e73  rent / f"{path.s
+00005a60: 7465 6d7d 2e71 6978 220a 2020 2020 2020  tem}.qix".      
+00005a70: 2020 2020 2020 696e 6465 785f 7061 7468        index_path
+00005a80: 2e75 6e6c 696e 6b28 6d69 7373 696e 675f  .unlink(missing_
+00005a90: 6f6b 3d54 7275 6529 0a20 2020 2020 2020  ok=True).       
+00005aa0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00005ab0: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+00005ac0: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
+00005ad0: 2020 2020 2066 2272 656d 6f76 655f 7370       f"remove_sp
+00005ae0: 6174 6961 6c5f 696e 6465 7820 6e6f 7420  atial_index not 
+00005af0: 7375 7070 6f72 7465 6420 666f 7220 7b70  supported for {p
+00005b00: 6174 685f 696e 666f 2e64 7269 7665 727d  ath_info.driver}
+00005b10: 3a20 7b70 6174 687d 220a 2020 2020 2020  : {path}".      
+00005b20: 2020 2020 2020 290a 0a20 2020 2065 7863        )..    exc
+00005b30: 6570 7420 5661 6c75 6545 7272 6f72 3a0a  ept ValueError:.
+00005b40: 2020 2020 2020 2020 7261 6973 650a 2020          raise.  
+00005b50: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
+00005b60: 6f6e 2061 7320 6578 3a0a 2020 2020 2020  on as ex:.      
+00005b70: 2020 6578 2e61 7267 7320 3d20 2866 2272    ex.args = (f"r
+00005b80: 656d 6f76 655f 7370 6174 6961 6c5f 696e  emove_spatial_in
+00005b90: 6465 7820 6572 726f 723a 207b 6578 7d2c  dex error: {ex},
+00005ba0: 2066 6f72 207b 7061 7468 7d2e 7b6c 6179   for {path}.{lay
+00005bb0: 6572 7d22 2c29 0a20 2020 2020 2020 2072  er}",).        r
+00005bc0: 6169 7365 0a20 2020 2066 696e 616c 6c79  aise.    finally
+00005bd0: 3a0a 2020 2020 2020 2020 6461 7461 736f  :.        dataso
+00005be0: 7572 6365 203d 204e 6f6e 650a 0a0a 6465  urce = None...de
+00005bf0: 6620 7265 6e61 6d65 5f6c 6179 6572 280a  f rename_layer(.
+00005c00: 2020 2020 7061 7468 3a20 556e 696f 6e5b      path: Union[
+00005c10: 7374 722c 2022 6f73 2e50 6174 684c 696b  str, "os.PathLik
+00005c20: 655b 416e 795d 225d 2c20 6e65 775f 6c61  e[Any]"], new_la
+00005c30: 7965 723a 2073 7472 2c20 6c61 7965 723a  yer: str, layer:
+00005c40: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
+00005c50: 204e 6f6e 650a 293a 0a20 2020 2022 2222   None.):.    """
+00005c60: 0a20 2020 2052 656e 616d 6520 7468 6520  .    Rename the 
+00005c70: 6c61 7965 7220 7370 6563 6966 6965 642e  layer specified.
+00005c80: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
+00005c90: 2020 2020 7061 7468 2028 5061 7468 4c69      path (PathLi
+00005ca0: 6b65 293a 2054 6865 2066 696c 6520 7061  ke): The file pa
+00005cb0: 7468 2e0a 2020 2020 2020 2020 6c61 7965  th..        laye
+00005cc0: 7220 284f 7074 696f 6e61 6c5b 7374 725d  r (Optional[str]
+00005cd0: 293a 2054 6865 206c 6179 6572 206e 616d  ): The layer nam
+00005ce0: 652e 2049 6620 6e6f 7420 7370 6563 6966  e. If not specif
+00005cf0: 6965 642c 2061 6e64 2074 6865 7265 2069  ied, and there i
+00005d00: 7320 6f6e 6c79 0a20 2020 2020 2020 2020  s only.         
+00005d10: 2020 206f 6e65 206c 6179 6572 2069 6e20     one layer in 
+00005d20: 7468 6520 6669 6c65 2c20 7468 6973 206c  the file, this l
+00005d30: 6179 6572 2069 7320 7573 6564 2e20 4f74  ayer is used. Ot
+00005d40: 6865 7277 6973 6520 6578 6365 7074 696f  herwise exceptio
+00005d50: 6e2e 0a20 2020 2020 2020 206e 6577 5f6c  n..        new_l
+00005d60: 6179 6572 2028 7374 7229 3a20 5468 6520  ayer (str): The 
+00005d70: 6e65 7720 6c61 7965 7220 6e61 6d65 2e20  new layer name. 
+00005d80: 4966 206e 6f74 2073 7065 6369 6669 6564  If not specified
+00005d90: 2c20 616e 6420 7468 6572 6520 6973 206f  , and there is o
+00005da0: 6e6c 790a 2020 2020 2020 2020 2020 2020  nly.            
+00005db0: 6f6e 6520 6c61 7965 7220 696e 2074 6865  one layer in the
+00005dc0: 2066 696c 652c 2074 6869 7320 6c61 7965   file, this laye
+00005dd0: 7220 6973 2075 7365 642e 204f 7468 6572  r is used. Other
+00005de0: 7769 7365 2065 7863 6570 7469 6f6e 2e0a  wise exception..
+00005df0: 2020 2020 2222 220a 2020 2020 2320 4368      """.    # Ch
+00005e00: 6563 6b20 696e 7075 7420 7061 7261 6d65  eck input parame
+00005e10: 7465 7273 0a20 2020 2070 6174 6820 3d20  ters.    path = 
+00005e20: 5061 7468 2870 6174 6829 0a20 2020 2069  Path(path).    i
+00005e30: 6620 6c61 7965 7220 6973 204e 6f6e 653a  f layer is None:
+00005e40: 0a20 2020 2020 2020 206c 6179 6572 203d  .        layer =
+00005e50: 2067 6574 5f6f 6e6c 795f 6c61 7965 7228   get_only_layer(
+00005e60: 7061 7468 290a 0a20 2020 2023 2052 656e  path)..    # Ren
+00005e70: 616d 696e 6720 7468 6520 6c61 7965 7220  aming the layer 
+00005e80: 6e61 6d65 2069 7320 6e6f 7420 706f 7373  name is not poss
+00005e90: 6962 6c65 2066 6f72 2073 696e 676c 6520  ible for single 
+00005ea0: 6c61 7965 7220 6669 6c65 2066 6f72 6d61  layer file forma
+00005eb0: 7473 2e0a 2020 2020 7061 7468 5f69 6e66  ts..    path_inf
+00005ec0: 6f20 3d20 5f67 656f 6669 6c65 696e 666f  o = _geofileinfo
+00005ed0: 2e67 6574 5f67 656f 6669 6c65 696e 666f  .get_geofileinfo
+00005ee0: 2870 6174 6829 0a20 2020 2069 6620 7061  (path).    if pa
+00005ef0: 7468 5f69 6e66 6f2e 6973 5f73 696e 676c  th_info.is_singl
+00005f00: 656c 6179 6572 3a0a 2020 2020 2020 2020  elayer:.        
+00005f10: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+00005f20: 2866 2272 656e 616d 655f 6c61 7965 7220  (f"rename_layer 
+00005f30: 6e6f 7420 706f 7373 6962 6c65 2066 6f72  not possible for
+00005f40: 207b 7061 7468 5f69 6e66 6f2e 6472 6976   {path_info.driv
+00005f50: 6572 7d20 6669 6c65 2229 0a0a 2020 2020  er} file")..    
+00005f60: 2320 4e6f 7720 7265 616c 6c79 2072 656e  # Now really ren
+00005f70: 616d 650a 2020 2020 6461 7461 736f 7572  ame.    datasour
+00005f80: 6365 203d 204e 6f6e 650a 2020 2020 7472  ce = None.    tr
+00005f90: 793a 0a20 2020 2020 2020 2064 6174 6173  y:.        datas
+00005fa0: 6f75 7263 6520 3d20 6764 616c 2e4f 7065  ource = gdal.Ope
+00005fb0: 6e45 7828 7374 7228 7061 7468 292c 206e  nEx(str(path), n
+00005fc0: 4f70 656e 466c 6167 733d 6764 616c 2e4f  OpenFlags=gdal.O
+00005fd0: 465f 5550 4441 5445 290a 2020 2020 2020  F_UPDATE).      
+00005fe0: 2020 7371 6c5f 7374 6d74 203d 2066 2741    sql_stmt = f'A
+00005ff0: 4c54 4552 2054 4142 4c45 2022 7b6c 6179  LTER TABLE "{lay
+00006000: 6572 7d22 2052 454e 414d 4520 544f 2022  er}" RENAME TO "
+00006010: 7b6e 6577 5f6c 6179 6572 7d22 270a 2020  {new_layer}"'.  
+00006020: 2020 2020 2020 7265 7375 6c74 203d 2064        result = d
+00006030: 6174 6173 6f75 7263 652e 4578 6563 7574  atasource.Execut
+00006040: 6553 514c 2873 716c 5f73 746d 7429 0a20  eSQL(sql_stmt). 
+00006050: 2020 2020 2020 2064 6174 6173 6f75 7263         datasourc
+00006060: 652e 5265 6c65 6173 6552 6573 756c 7453  e.ReleaseResultS
+00006070: 6574 2872 6573 756c 7429 0a20 2020 2065  et(result).    e
+00006080: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
+00006090: 6173 2065 783a 0a20 2020 2020 2020 2065  as ex:.        e
+000060a0: 782e 6172 6773 203d 2028 6622 7265 6e61  x.args = (f"rena
+000060b0: 6d65 5f6c 6179 6572 2065 7272 6f72 3a20  me_layer error: 
+000060c0: 7b65 787d 2c20 666f 7220 7b70 6174 687d  {ex}, for {path}
+000060d0: 2e7b 6c61 7965 727d 222c 290a 2020 2020  .{layer}",).    
+000060e0: 2020 2020 7261 6973 650a 2020 2020 6669      raise.    fi
+000060f0: 6e61 6c6c 793a 0a20 2020 2020 2020 2064  nally:.        d
+00006100: 6174 6173 6f75 7263 6520 3d20 4e6f 6e65  atasource = None
+00006110: 0a0a 0a64 6566 2072 656e 616d 655f 636f  ...def rename_co
+00006120: 6c75 6d6e 280a 2020 2020 7061 7468 3a20  lumn(.    path: 
+00006130: 556e 696f 6e5b 7374 722c 2022 6f73 2e50  Union[str, "os.P
+00006140: 6174 684c 696b 655b 416e 795d 225d 2c0a  athLike[Any]"],.
+00006150: 2020 2020 636f 6c75 6d6e 5f6e 616d 653a      column_name:
+00006160: 2073 7472 2c0a 2020 2020 6e65 775f 636f   str,.    new_co
+00006170: 6c75 6d6e 5f6e 616d 653a 2073 7472 2c0a  lumn_name: str,.
+00006180: 2020 2020 6c61 7965 723a 204f 7074 696f      layer: Optio
+00006190: 6e61 6c5b 7374 725d 203d 204e 6f6e 652c  nal[str] = None,
+000061a0: 0a29 3a0a 2020 2020 2222 220a 2020 2020  .):.    """.    
+000061b0: 5265 6e61 6d65 2074 6865 2063 6f6c 756d  Rename the colum
+000061c0: 6e20 7370 6563 6966 6965 642e 0a0a 2020  n specified...  
+000061d0: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+000061e0: 7061 7468 2028 5061 7468 4c69 6b65 293a  path (PathLike):
+000061f0: 2074 6865 2066 696c 6520 7061 7468 2e0a   the file path..
+00006200: 2020 2020 2020 2020 636f 6c75 6d6e 5f6e          column_n
+00006210: 616d 6520 2873 7472 293a 2063 7572 7265  ame (str): curre
+00006220: 6e74 2063 6f6c 756d 6e20 6e61 6d65 2e0a  nt column name..
+00006230: 2020 2020 2020 2020 6e65 775f 636f 6c75          new_colu
+00006240: 6d6e 5f6e 616d 6520 2873 7472 293a 206e  mn_name (str): n
+00006250: 6577 2063 6f6c 756d 6e20 6e61 6d65 2e0a  ew column name..
+00006260: 2020 2020 2020 2020 6c61 7965 7220 284f          layer (O
+00006270: 7074 696f 6e61 6c5b 7374 725d 293a 206c  ptional[str]): l
+00006280: 6179 6572 206e 616d 652e 2049 6620 6e6f  ayer name. If no
+00006290: 7420 7370 6563 6966 6965 642c 2061 6e64  t specified, and
+000062a0: 2074 6865 7265 2069 7320 6f6e 6c79 0a20   there is only. 
+000062b0: 2020 2020 2020 2020 2020 206f 6e65 206c             one l
+000062c0: 6179 6572 2069 6e20 7468 6520 6669 6c65  ayer in the file
+000062d0: 2c20 7468 6973 206c 6179 6572 2069 7320  , this layer is 
+000062e0: 7573 6564 2e20 4f74 6865 7277 6973 6520  used. Otherwise 
+000062f0: 6578 6365 7074 696f 6e2e 0a20 2020 2022  exception..    "
+00006300: 2222 0a20 2020 2023 2043 6865 636b 2069  "".    # Check i
+00006310: 6e70 7574 2070 6172 616d 6574 6572 730a  nput parameters.
+00006320: 2020 2020 7061 7468 203d 2050 6174 6828      path = Path(
+00006330: 7061 7468 290a 2020 2020 6966 206c 6179  path).    if lay
+00006340: 6572 2069 7320 4e6f 6e65 3a0a 2020 2020  er is None:.    
+00006350: 2020 2020 6c61 7965 7220 3d20 6765 745f      layer = get_
+00006360: 6f6e 6c79 5f6c 6179 6572 2870 6174 6829  only_layer(path)
+00006370: 0a20 2020 2069 6e66 6f20 3d20 6765 745f  .    info = get_
+00006380: 6c61 7965 7269 6e66 6f28 7061 7468 2c20  layerinfo(path, 
+00006390: 6c61 7965 722c 2072 6169 7365 5f6f 6e5f  layer, raise_on_
+000063a0: 6e6f 6765 6f6d 3d46 616c 7365 290a 2020  nogeom=False).  
+000063b0: 2020 6966 2063 6f6c 756d 6e5f 6e61 6d65    if column_name
+000063c0: 206e 6f74 2069 6e20 696e 666f 2e63 6f6c   not in info.col
+000063d0: 756d 6e73 2061 6e64 206e 6577 5f63 6f6c  umns and new_col
+000063e0: 756d 6e5f 6e61 6d65 2069 6e20 696e 666f  umn_name in info
+000063f0: 2e63 6f6c 756d 6e73 3a0a 2020 2020 2020  .columns:.      
+00006400: 2020 6c6f 6767 6572 2e69 6e66 6f28 0a20    logger.info(. 
+00006410: 2020 2020 2020 2020 2020 2066 2243 6f6c             f"Col
+00006420: 756d 6e20 7b63 6f6c 756d 6e5f 6e61 6d65  umn {column_name
+00006430: 7d20 7365 656d 7320 746f 2062 6520 7265  } seems to be re
+00006440: 6e61 6d65 6420 616c 7265 6164 7920 746f  named already to
+00006450: 207b 6e65 775f 636f 6c75 6d6e 5f6e 616d   {new_column_nam
+00006460: 657d 220a 2020 2020 2020 2020 290a 2020  e}".        ).  
+00006470: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
+00006480: 2020 2320 4e6f 7720 7265 616c 6c79 2072    # Now really r
+00006490: 656e 616d 650a 2020 2020 6461 7461 736f  ename.    dataso
+000064a0: 7572 6365 203d 204e 6f6e 650a 2020 2020  urce = None.    
+000064b0: 7472 793a 0a20 2020 2020 2020 2064 6174  try:.        dat
+000064c0: 6173 6f75 7263 6520 3d20 6764 616c 2e4f  asource = gdal.O
+000064d0: 7065 6e45 7828 7374 7228 7061 7468 292c  penEx(str(path),
+000064e0: 206e 4f70 656e 466c 6167 733d 6764 616c   nOpenFlags=gdal
+000064f0: 2e4f 465f 5550 4441 5445 290a 2020 2020  .OF_UPDATE).    
+00006500: 2020 2020 6461 7461 736f 7572 6365 5f6c      datasource_l
+00006510: 6179 6572 203d 2064 6174 6173 6f75 7263  ayer = datasourc
+00006520: 652e 4765 744c 6179 6572 286c 6179 6572  e.GetLayer(layer
+00006530: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
+00006540: 2064 6174 6173 6f75 7263 655f 6c61 7965   datasource_laye
+00006550: 722e 5465 7374 4361 7061 6269 6c69 7479  r.TestCapability
+00006560: 2867 6461 6c2e 6f67 722e 4f4c 4341 6c74  (gdal.ogr.OLCAlt
+00006570: 6572 4669 656c 6444 6566 6e29 3a0a 2020  erFieldDefn):.  
+00006580: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00006590: 5661 6c75 6545 7272 6f72 2866 2272 656e  ValueError(f"ren
+000065a0: 616d 655f 636f 6c75 6d6e 206e 6f74 2073  ame_column not s
+000065b0: 7570 706f 7274 6564 2066 6f72 207b 7061  upported for {pa
+000065c0: 7468 7d22 290a 0a20 2020 2020 2020 2023  th}")..        #
+000065d0: 2052 656e 616d 6520 636f 6c75 6d6e 0a20   Rename column. 
+000065e0: 2020 2020 2020 2073 716c 5f73 746d 7420         sql_stmt 
+000065f0: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
+00006600: 6627 414c 5445 5220 5441 424c 4520 227b  f'ALTER TABLE "{
+00006610: 6c61 7965 727d 2220 270a 2020 2020 2020  layer}" '.      
+00006620: 2020 2020 2020 6627 5245 4e41 4d45 2043        f'RENAME C
+00006630: 4f4c 554d 4e20 227b 636f 6c75 6d6e 5f6e  OLUMN "{column_n
+00006640: 616d 657d 2220 544f 2022 7b6e 6577 5f63  ame}" TO "{new_c
+00006650: 6f6c 756d 6e5f 6e61 6d65 7d22 270a 2020  olumn_name}"'.  
+00006660: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00006670: 7265 7375 6c74 203d 2064 6174 6173 6f75  result = datasou
+00006680: 7263 652e 4578 6563 7574 6553 514c 2873  rce.ExecuteSQL(s
+00006690: 716c 5f73 746d 7429 0a20 2020 2020 2020  ql_stmt).       
+000066a0: 2064 6174 6173 6f75 7263 652e 5265 6c65   datasource.Rele
+000066b0: 6173 6552 6573 756c 7453 6574 2872 6573  aseResultSet(res
+000066c0: 756c 7429 0a0a 2020 2020 6578 6365 7074  ult)..    except
+000066d0: 2045 7863 6570 7469 6f6e 2061 7320 6578   Exception as ex
+000066e0: 3a0a 2020 2020 2020 2020 2320 4966 2069  :.        # If i
+000066f0: 7420 6973 2074 6865 2056 616c 7565 4572  t is the ValueEr
+00006700: 726f 7220 7468 726f 776e 2061 626f 7665  ror thrown above
+00006710: 2c20 6a75 7374 2072 6169 7365 0a20 2020  , just raise.   
+00006720: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+00006730: 6365 2865 782c 2056 616c 7565 4572 726f  ce(ex, ValueErro
+00006740: 7229 2061 6e64 2073 7472 2865 7829 2e73  r) and str(ex).s
+00006750: 7461 7274 7377 6974 6828 0a20 2020 2020  tartswith(.     
+00006760: 2020 2020 2020 2022 7265 6e61 6d65 5f63         "rename_c
+00006770: 6f6c 756d 6e20 6e6f 7420 7375 7070 6f72  olumn not suppor
+00006780: 7465 6420 666f 7222 0a20 2020 2020 2020  ted for".       
+00006790: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
+000067a0: 7261 6973 650a 0a20 2020 2020 2020 2023  raise..        #
+000067b0: 2049 7420 6973 2061 6e6f 7468 6572 2065   It is another e
+000067c0: 7272 6f72 2e2e 2e20 6164 6420 736f 6d65  rror... add some
+000067d0: 206d 6f72 6520 636f 6e74 6578 740a 2020   more context.  
+000067e0: 2020 2020 2020 6578 2e61 7267 7320 3d20        ex.args = 
+000067f0: 2866 2272 656e 616d 655f 636f 6c75 6d6e  (f"rename_column
+00006800: 2065 7272 6f72 3a20 7b65 787d 2066 6f72   error: {ex} for
+00006810: 207b 7061 7468 7d2e 7b6c 6179 6572 7d22   {path}.{layer}"
+00006820: 2c29 0a20 2020 2020 2020 2072 6169 7365  ,).        raise
+00006830: 0a20 2020 2066 696e 616c 6c79 3a0a 2020  .    finally:.  
+00006840: 2020 2020 2020 6461 7461 736f 7572 6365        datasource
+00006850: 203d 204e 6f6e 650a 0a0a 636c 6173 7320   = None...class 
+00006860: 4461 7461 5479 7065 2865 6e75 6d2e 456e  DataType(enum.En
+00006870: 756d 293a 0a20 2020 2022 2222 0a20 2020  um):.    """.   
+00006880: 2054 6869 7320 656e 756d 2064 6566 696e   This enum defin
+00006890: 6573 2074 6865 2073 7461 6e64 6172 6420  es the standard 
+000068a0: 6461 7461 2074 7970 6573 2074 6861 7420  data types that 
+000068b0: 6361 6e20 6265 2075 7365 6420 666f 7220  can be used for 
+000068c0: 636f 6c75 6d6e 732e 0a20 2020 2022 2222  columns..    """
+000068d0: 0a0a 2020 2020 5445 5854 203d 2022 5445  ..    TEXT = "TE
+000068e0: 5854 220a 2020 2020 2222 2243 6f6c 756d  XT".    """Colum
+000068f0: 6e20 7769 7468 2074 6578 7420 6461 7461  n with text data
+00006900: 3a20 7e20 7374 7269 6e67 2c20 6368 6172  : ~ string, char
+00006910: 2c20 7661 7263 6861 722c 2063 6c6f 622e  , varchar, clob.
+00006920: 2222 220a 2020 2020 494e 5445 4745 5220  """.    INTEGER 
+00006930: 3d20 2249 4e54 4547 4552 220a 2020 2020  = "INTEGER".    
+00006940: 2222 2243 6f6c 756d 6e20 7769 7468 2069  """Column with i
+00006950: 6e74 6567 6572 2064 6174 612e 2222 220a  nteger data.""".
+00006960: 2020 2020 5245 414c 203d 2022 5245 414c      REAL = "REAL
+00006970: 220a 2020 2020 2222 2243 6f6c 756d 6e20  ".    """Column 
+00006980: 7769 7468 2066 6c6f 6174 696e 6720 706f  with floating po
+00006990: 696e 7420 6461 7461 3a20 7e20 666c 6f61  int data: ~ floa
+000069a0: 742c 2064 6f75 626c 652e 2222 220a 2020  t, double.""".  
+000069b0: 2020 4441 5445 203d 2022 4441 5445 220a    DATE = "DATE".
+000069c0: 2020 2020 2222 2243 6f6c 756d 6e20 7769      """Column wi
+000069d0: 7468 2064 6174 6520 6461 7461 2e22 2222  th date data."""
+000069e0: 0a20 2020 2054 494d 4553 5441 4d50 203d  .    TIMESTAMP =
+000069f0: 2022 5449 4d45 5354 414d 5022 0a20 2020   "TIMESTAMP".   
+00006a00: 2022 2222 436f 6c75 6d6e 2077 6974 6820   """Column with 
+00006a10: 7469 6d65 7374 616d 7020 6461 7461 3a20  timestamp data: 
+00006a20: 7e20 6461 7465 7469 6d65 2e22 2222 0a20  ~ datetime.""". 
+00006a30: 2020 2042 4f4f 4c45 414e 203d 2022 424f     BOOLEAN = "BO
+00006a40: 4f4c 4541 4e22 0a20 2020 2022 2222 436f  OLEAN".    """Co
+00006a50: 6c75 6d6e 2077 6974 6820 626f 6f6c 6561  lumn with boolea
+00006a60: 6e20 6461 7461 2e22 2222 0a20 2020 2042  n data.""".    B
+00006a70: 4c4f 4220 3d20 2242 4c4f 4222 0a20 2020  LOB = "BLOB".   
+00006a80: 2022 2222 436f 6c75 6d6e 2077 6974 6820   """Column with 
+00006a90: 6269 6e61 7279 2064 6174 612e 2222 220a  binary data.""".
+00006aa0: 2020 2020 4e55 4d45 5249 4320 3d20 224e      NUMERIC = "N
+00006ab0: 554d 4552 4943 220a 2020 2020 2222 2243  UMERIC".    """C
+00006ac0: 6f6c 756d 6e20 7769 7468 206e 756d 6572  olumn with numer
+00006ad0: 6963 2064 6174 613a 2065 7861 6374 2064  ic data: exact d
+00006ae0: 6563 696d 616c 2064 6174 612e 2222 220a  ecimal data.""".
+00006af0: 0a0a 6465 6620 6164 645f 636f 6c75 6d6e  ..def add_column
+00006b00: 280a 2020 2020 7061 7468 3a20 556e 696f  (.    path: Unio
+00006b10: 6e5b 7374 722c 2022 6f73 2e50 6174 684c  n[str, "os.PathL
+00006b20: 696b 655b 416e 795d 225d 2c0a 2020 2020  ike[Any]"],.    
+00006b30: 6e61 6d65 3a20 7374 722c 0a20 2020 2074  name: str,.    t
+00006b40: 7970 653a 2055 6e69 6f6e 5b44 6174 6154  ype: Union[DataT
+00006b50: 7970 652c 2073 7472 5d2c 0a20 2020 2065  ype, str],.    e
+00006b60: 7870 7265 7373 696f 6e3a 2055 6e69 6f6e  xpression: Union
+00006b70: 5b73 7472 2c20 666c 6f61 742c 204e 6f6e  [str, float, Non
+00006b80: 655d 203d 204e 6f6e 652c 0a20 2020 2065  e] = None,.    e
+00006b90: 7870 7265 7373 696f 6e5f 6469 616c 6563  xpression_dialec
+00006ba0: 743a 204f 7074 696f 6e61 6c5b 7374 725d  t: Optional[str]
+00006bb0: 203d 204e 6f6e 652c 0a20 2020 206c 6179   = None,.    lay
+00006bc0: 6572 3a20 4f70 7469 6f6e 616c 5b73 7472  er: Optional[str
+00006bd0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 666f  ] = None,.    fo
+00006be0: 7263 655f 7570 6461 7465 3a20 626f 6f6c  rce_update: bool
+00006bf0: 203d 2046 616c 7365 2c0a 2020 2020 7769   = False,.    wi
+00006c00: 6474 683a 204f 7074 696f 6e61 6c5b 696e  dth: Optional[in
+00006c10: 745d 203d 204e 6f6e 652c 0a29 3a0a 2020  t] = None,.):.  
+00006c20: 2020 2222 220a 2020 2020 4164 6420 6120    """.    Add a 
+00006c30: 636f 6c75 6d6e 2074 6f20 6120 6c61 7965  column to a laye
+00006c40: 7220 6f66 2074 6865 2067 656f 6669 6c65  r of the geofile
+00006c50: 2e0a 0a20 2020 2041 7267 733a 0a20 2020  ...    Args:.   
+00006c60: 2020 2020 2070 6174 6820 2850 6174 684c       path (PathL
+00006c70: 696b 6529 3a20 5061 7468 2074 6f20 7468  ike): Path to th
+00006c80: 6520 6765 6f66 696c 652e 0a20 2020 2020  e geofile..     
+00006c90: 2020 206e 616d 6520 2873 7472 293a 204e     name (str): N
+00006ca0: 616d 6520 666f 7220 7468 6520 6e65 7720  ame for the new 
+00006cb0: 636f 6c75 6d6e 2e0a 2020 2020 2020 2020  column..        
+00006cc0: 7479 7065 2028 7374 7229 3a20 436f 6c75  type (str): Colu
+00006cd0: 6d6e 2074 7970 6520 6f66 2074 6865 206e  mn type of the n
+00006ce0: 6577 2063 6f6c 756d 6e2e 0a20 2020 2020  ew column..     
+00006cf0: 2020 2065 7870 7265 7373 696f 6e20 2873     expression (s
+00006d00: 7472 3b20 696e 7420 6f72 2066 6c6f 6174  tr; int or float
+00006d10: 2c20 6f70 7469 6f6e 616c 293a 2053 514c  , optional): SQL
+00006d20: 6974 6520 6578 7072 6573 7369 6f6e 2074  ite expression t
+00006d30: 6f20 7573 6520 746f 2075 7064 6174 650a  o use to update.
+00006d40: 2020 2020 2020 2020 2020 2020 7468 6520              the 
+00006d50: 7661 6c75 652e 2044 6566 6175 6c74 7320  value. Defaults 
+00006d60: 746f 204e 6f6e 652e 0a20 2020 2020 2020  to None..       
+00006d70: 2065 7870 7265 7373 696f 6e5f 6469 616c   expression_dial
+00006d80: 6563 7420 2873 7472 2c20 6f70 7469 6f6e  ect (str, option
+00006d90: 616c 293a 2053 514c 2064 6961 6c65 6374  al): SQL dialect
+00006da0: 2075 7365 6420 666f 7220 7468 6520 6578   used for the ex
+00006db0: 7072 6573 7369 6f6e 2e0a 2020 2020 2020  pression..      
+00006dc0: 2020 6c61 7965 7220 2873 7472 2c20 6f70    layer (str, op
+00006dd0: 7469 6f6e 616c 293a 2054 6865 206c 6179  tional): The lay
+00006de0: 6572 206e 616d 652e 2049 6620 4e6f 6e65  er name. If None
+00006df0: 2061 6e64 2074 6865 2067 656f 6669 6c65   and the geofile
+00006e00: 0a20 2020 2020 2020 2020 2020 2068 6173  .            has
+00006e10: 206f 6e6c 7920 6f6e 6520 6c61 7965 722c   only one layer,
+00006e20: 2074 6861 7420 6c61 7965 7220 6973 2075   that layer is u
+00006e30: 7365 642e 2044 6566 6175 6c74 7320 746f  sed. Defaults to
+00006e40: 204e 6f6e 652e 0a20 2020 2020 2020 2066   None..        f
+00006e50: 6f72 6365 5f75 7064 6174 6520 2862 6f6f  orce_update (boo
+00006e60: 6c2c 206f 7074 696f 6e61 6c29 3a20 4966  l, optional): If
+00006e70: 2074 6865 2063 6f6c 756d 6e20 616c 7265   the column alre
+00006e80: 6164 7920 6578 6973 7473 2c20 6578 6563  ady exists, exec
+00006e90: 7574 650a 2020 2020 2020 2020 2020 2020  ute.            
+00006ea0: 7468 6520 7570 6461 7465 2061 6e79 7761  the update anywa
+00006eb0: 792e 2044 6566 6175 6c74 7320 746f 2046  y. Defaults to F
+00006ec0: 616c 7365 2e0a 2020 2020 2020 2020 7769  alse..        wi
+00006ed0: 6474 6820 2869 6e74 2c20 6f70 7469 6f6e  dth (int, option
+00006ee0: 616c 293a 2074 6865 2077 6964 7468 206f  al): the width o
+00006ef0: 6620 7468 6520 6669 656c 642e 0a0a 2020  f the field...  
+00006f00: 2020 5261 6973 6573 3a0a 2020 2020 2020    Raises:.      
+00006f10: 2020 6578 3a20 5b64 6573 6372 6970 7469    ex: [descripti
+00006f20: 6f6e 5d0a 2020 2020 2222 220a 2020 2020  on].    """.    
+00006f30: 2320 496e 6974 0a20 2020 2069 6620 6973  # Init.    if is
+00006f40: 696e 7374 616e 6365 2874 7970 652c 2044  instance(type, D
+00006f50: 6174 6154 7970 6529 3a0a 2020 2020 2020  ataType):.      
+00006f60: 2020 7479 7065 5f73 7472 203d 2074 7970    type_str = typ
+00006f70: 652e 7661 6c75 650a 2020 2020 656c 7365  e.value.    else
+00006f80: 3a0a 2020 2020 2020 2020 7479 7065 5f6c  :.        type_l
+00006f90: 6f77 6572 203d 2074 7970 652e 6c6f 7765  ower = type.lowe
+00006fa0: 7228 290a 2020 2020 2020 2020 6966 2074  r().        if t
+00006fb0: 7970 655f 6c6f 7765 7220 3d3d 2022 7374  ype_lower == "st
+00006fc0: 7269 6e67 223a 0a20 2020 2020 2020 2020  ring":.         
+00006fd0: 2020 2023 2054 4f44 4f3a 2074 6869 6e6b     # TODO: think
+00006fe0: 2077 6865 7468 6572 2062 6569 6e67 2066   whether being f
+00006ff0: 6c65 7869 626c 6520 6865 7265 2069 7320  lexible here is 
+00007000: 6120 676f 6f64 2069 6465 612e 2e2e 0a20  a good idea.... 
+00007010: 2020 2020 2020 2020 2020 2074 7970 655f             type_
+00007020: 7374 7220 3d20 2254 4558 5422 0a20 2020  str = "TEXT".   
+00007030: 2020 2020 2065 6c69 6620 7479 7065 5f6c       elif type_l
+00007040: 6f77 6572 203d 3d20 2262 696e 6172 7922  ower == "binary"
+00007050: 3a0a 2020 2020 2020 2020 2020 2020 7479  :.            ty
+00007060: 7065 5f73 7472 203d 2022 424c 4f42 220a  pe_str = "BLOB".
+00007070: 2020 2020 2020 2020 656c 6966 2074 7970          elif typ
+00007080: 655f 6c6f 7765 7220 3d3d 2022 7469 6d65  e_lower == "time
+00007090: 223a 0a20 2020 2020 2020 2020 2020 2074  ":.            t
+000070a0: 7970 655f 7374 7220 3d20 2244 4154 4554  ype_str = "DATET
+000070b0: 494d 4522 0a20 2020 2020 2020 2065 6c69  IME".        eli
+000070c0: 6620 7479 7065 5f6c 6f77 6572 203d 3d20  f type_lower == 
+000070d0: 2269 6e74 6567 6572 3634 223a 0a20 2020  "integer64":.   
+000070e0: 2020 2020 2020 2020 2074 7970 655f 7374           type_st
+000070f0: 7220 3d20 2249 4e54 4547 4552 220a 2020  r = "INTEGER".  
+00007100: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00007110: 2020 2020 2020 2020 7479 7065 5f73 7472          type_str
+00007120: 203d 2074 7970 650a 2020 2020 7061 7468   = type.    path
+00007130: 203d 2050 6174 6828 7061 7468 290a 2020   = Path(path).  
+00007140: 2020 6966 206c 6179 6572 2069 7320 4e6f    if layer is No
+00007150: 6e65 3a0a 2020 2020 2020 2020 6c61 7965  ne:.        laye
+00007160: 7220 3d20 6765 745f 6f6e 6c79 5f6c 6179  r = get_only_lay
+00007170: 6572 2870 6174 6829 0a20 2020 206c 6179  er(path).    lay
+00007180: 6572 696e 666f 5f6f 7269 6720 3d20 6765  erinfo_orig = ge
+00007190: 745f 6c61 7965 7269 6e66 6f28 7061 7468  t_layerinfo(path
+000071a0: 2c20 6c61 7965 722c 2072 6169 7365 5f6f  , layer, raise_o
+000071b0: 6e5f 6e6f 6765 6f6d 3d46 616c 7365 290a  n_nogeom=False).
+000071c0: 0a20 2020 2023 2047 6f21 0a20 2020 2064  .    # Go!.    d
+000071d0: 6174 6173 6f75 7263 6520 3d20 4e6f 6e65  atasource = None
+000071e0: 0a20 2020 2074 7279 3a0a 2020 2020 2020  .    try:.      
+000071f0: 2020 2320 4966 2063 6f6c 756d 6e20 646f    # If column do
+00007200: 6573 6e27 7420 6578 6973 7420 7965 742c  esn't exist yet,
+00007210: 2063 7265 6174 6520 6974 0a20 2020 2020   create it.     
+00007220: 2020 2063 6f6c 756d 6e73 5f75 7070 6572     columns_upper
+00007230: 203d 205b 636f 6c75 6d6e 2e75 7070 6572   = [column.upper
+00007240: 2829 2066 6f72 2063 6f6c 756d 6e20 696e  () for column in
+00007250: 206c 6179 6572 696e 666f 5f6f 7269 672e   layerinfo_orig.
+00007260: 636f 6c75 6d6e 735d 0a20 2020 2020 2020  columns].       
+00007270: 2069 6620 6e61 6d65 2e75 7070 6572 2829   if name.upper()
+00007280: 206e 6f74 2069 6e20 636f 6c75 6d6e 735f   not in columns_
+00007290: 7570 7065 723a 0a20 2020 2020 2020 2020  upper:.         
+000072a0: 2020 2077 6964 7468 5f73 7472 203d 2066     width_str = f
+000072b0: 2228 7b77 6964 7468 7d29 2220 6966 2077  "({width})" if w
+000072c0: 6964 7468 2069 7320 6e6f 7420 4e6f 6e65  idth is not None
+000072d0: 2065 6c73 6520 2222 0a20 2020 2020 2020   else "".       
+000072e0: 2020 2020 2073 716c 5f73 746d 7420 3d20       sql_stmt = 
+000072f0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00007300: 2020 6627 414c 5445 5220 5441 424c 4520    f'ALTER TABLE 
+00007310: 227b 6c61 7965 727d 2220 4144 4420 434f  "{layer}" ADD CO
+00007320: 4c55 4d4e 2022 7b6e 616d 657d 2220 7b74  LUMN "{name}" {t
+00007330: 7970 655f 7374 727d 7b77 6964 7468 5f73  ype_str}{width_s
+00007340: 7472 7d27 0a20 2020 2020 2020 2020 2020  tr}'.           
+00007350: 2029 0a20 2020 2020 2020 2020 2020 2064   ).            d
+00007360: 6174 6173 6f75 7263 6520 3d20 6764 616c  atasource = gdal
+00007370: 2e4f 7065 6e45 7828 7374 7228 7061 7468  .OpenEx(str(path
+00007380: 292c 206e 4f70 656e 466c 6167 733d 6764  ), nOpenFlags=gd
+00007390: 616c 2e4f 465f 5550 4441 5445 290a 2020  al.OF_UPDATE).  
+000073a0: 2020 2020 2020 2020 2020 7265 7375 6c74            result
+000073b0: 203d 2064 6174 6173 6f75 7263 652e 4578   = datasource.Ex
+000073c0: 6563 7574 6553 514c 2873 716c 5f73 746d  ecuteSQL(sql_stm
+000073d0: 7429 0a20 2020 2020 2020 2020 2020 2064  t).            d
+000073e0: 6174 6173 6f75 7263 652e 5265 6c65 6173  atasource.Releas
+000073f0: 6552 6573 756c 7453 6574 2872 6573 756c  eResultSet(resul
+00007400: 7429 0a20 2020 2020 2020 2065 6c73 653a  t).        else:
+00007410: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+00007420: 6765 722e 7761 726e 696e 6728 6622 436f  ger.warning(f"Co
+00007430: 6c75 6d6e 207b 6e61 6d65 7d20 6578 6973  lumn {name} exis
+00007440: 7465 6420 616c 7265 6164 7920 696e 207b  ted already in {
+00007450: 7061 7468 7d2c 206c 6179 6572 207b 6c61  path}, layer {la
+00007460: 7965 727d 2229 0a0a 2020 2020 2020 2020  yer}")..        
+00007470: 2320 4966 2061 6e20 6578 7072 6573 7369  # If an expressi
+00007480: 6f6e 2077 6173 2070 726f 7669 6465 6420  on was provided 
+00007490: 616e 6420 7570 6461 7465 2063 616e 2062  and update can b
+000074a0: 6520 646f 6e65 2c20 676f 2066 6f72 2069  e done, go for i
+000074b0: 742e 2e2e 0a20 2020 2020 2020 2069 6620  t....        if 
+000074c0: 6578 7072 6573 7369 6f6e 2069 7320 6e6f  expression is no
+000074d0: 7420 4e6f 6e65 2061 6e64 2028 0a20 2020  t None and (.   
+000074e0: 2020 2020 2020 2020 206e 616d 6520 6e6f           name no
+000074f0: 7420 696e 206c 6179 6572 696e 666f 5f6f  t in layerinfo_o
+00007500: 7269 672e 636f 6c75 6d6e 7320 6f72 2066  rig.columns or f
+00007510: 6f72 6365 5f75 7064 6174 6520 6973 2054  orce_update is T
+00007520: 7275 650a 2020 2020 2020 2020 293a 0a20  rue.        ):. 
+00007530: 2020 2020 2020 2020 2020 2069 6620 6461             if da
+00007540: 7461 736f 7572 6365 2069 7320 4e6f 6e65  tasource is None
+00007550: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00007560: 2020 6461 7461 736f 7572 6365 203d 2067    datasource = g
+00007570: 6461 6c2e 4f70 656e 4578 2873 7472 2870  dal.OpenEx(str(p
+00007580: 6174 6829 2c20 6e4f 7065 6e46 6c61 6773  ath), nOpenFlags
+00007590: 3d67 6461 6c2e 4f46 5f55 5044 4154 4529  =gdal.OF_UPDATE)
+000075a0: 0a20 2020 2020 2020 2020 2020 2073 716c  .            sql
+000075b0: 5f73 746d 7420 3d20 6627 5550 4441 5445  _stmt = f'UPDATE
+000075c0: 2022 7b6c 6179 6572 7d22 2053 4554 2022   "{layer}" SET "
+000075d0: 7b6e 616d 657d 2220 3d20 7b65 7870 7265  {name}" = {expre
+000075e0: 7373 696f 6e7d 270a 2020 2020 2020 2020  ssion}'.        
+000075f0: 2020 2020 7265 7375 6c74 203d 2064 6174      result = dat
+00007600: 6173 6f75 7263 652e 4578 6563 7574 6553  asource.ExecuteS
+00007610: 514c 2873 716c 5f73 746d 742c 2064 6961  QL(sql_stmt, dia
+00007620: 6c65 6374 3d65 7870 7265 7373 696f 6e5f  lect=expression_
+00007630: 6469 616c 6563 7429 0a20 2020 2020 2020  dialect).       
+00007640: 2020 2020 2064 6174 6173 6f75 7263 652e       datasource.
+00007650: 5265 6c65 6173 6552 6573 756c 7453 6574  ReleaseResultSet
+00007660: 2872 6573 756c 7429 0a0a 2020 2020 6578  (result)..    ex
+00007670: 6365 7074 2045 7863 6570 7469 6f6e 2061  cept Exception a
+00007680: 7320 6578 3a0a 2020 2020 2020 2020 6578  s ex:.        ex
+00007690: 2e61 7267 7320 3d20 2866 2261 6464 5f63  .args = (f"add_c
+000076a0: 6f6c 756d 6e20 6572 726f 7220 666f 7220  olumn error for 
+000076b0: 7b70 6174 687d 2e7b 6c61 7965 727d 3a5c  {path}.{layer}:\
+000076c0: 6e20 207b 6578 7d22 2c29 0a20 2020 2020  n  {ex}",).     
+000076d0: 2020 2072 6169 7365 0a20 2020 2066 696e     raise.    fin
+000076e0: 616c 6c79 3a0a 2020 2020 2020 2020 6461  ally:.        da
+000076f0: 7461 736f 7572 6365 203d 204e 6f6e 650a  tasource = None.
+00007700: 0a0a 6465 6620 6472 6f70 5f63 6f6c 756d  ..def drop_colum
+00007710: 6e28 0a20 2020 2070 6174 683a 2055 6e69  n(.    path: Uni
+00007720: 6f6e 5b73 7472 2c20 226f 732e 5061 7468  on[str, "os.Path
+00007730: 4c69 6b65 5b41 6e79 5d22 5d2c 2063 6f6c  Like[Any]"], col
+00007740: 756d 6e5f 6e61 6d65 3a20 7374 722c 206c  umn_name: str, l
+00007750: 6179 6572 3a20 4f70 7469 6f6e 616c 5b73  ayer: Optional[s
+00007760: 7472 5d20 3d20 4e6f 6e65 0a29 3a0a 2020  tr] = None.):.  
+00007770: 2020 2222 220a 2020 2020 4472 6f70 2074    """.    Drop t
+00007780: 6865 2063 6f6c 756d 6e20 7370 6563 6966  he column specif
+00007790: 6965 642e 0a0a 2020 2020 4172 6773 3a0a  ied...    Args:.
+000077a0: 2020 2020 2020 2020 7061 7468 2028 5061          path (Pa
+000077b0: 7468 4c69 6b65 293a 2054 6865 2066 696c  thLike): The fil
+000077c0: 6520 7061 7468 2e0a 2020 2020 2020 2020  e path..        
+000077d0: 636f 6c75 6d6e 5f6e 616d 6520 2873 7472  column_name (str
+000077e0: 293a 2074 6865 2063 6f6c 756d 6e20 6e61  ): the column na
+000077f0: 6d65 2e0a 2020 2020 2020 2020 6c61 7965  me..        laye
+00007800: 7220 284f 7074 696f 6e61 6c5b 7374 725d  r (Optional[str]
+00007810: 293a 2054 6865 206c 6179 6572 206e 616d  ): The layer nam
+00007820: 652e 2049 6620 6e6f 7420 7370 6563 6966  e. If not specif
+00007830: 6965 642c 2061 6e64 2074 6865 7265 2069  ied, and there i
+00007840: 7320 6f6e 6c79 0a20 2020 2020 2020 2020  s only.         
+00007850: 2020 206f 6e65 206c 6179 6572 2069 6e20     one layer in 
+00007860: 7468 6520 6669 6c65 2c20 7468 6973 206c  the file, this l
+00007870: 6179 6572 2069 7320 7573 6564 2e20 4f74  ayer is used. Ot
+00007880: 6865 7277 6973 6520 6120 5661 6c75 6545  herwise a ValueE
+00007890: 7272 6f72 2069 730a 2020 2020 2020 2020  rror is.        
+000078a0: 2020 2020 7261 6973 6564 2e0a 2020 2020      raised..    
+000078b0: 2222 220a 2020 2020 2320 4368 6563 6b20  """.    # Check 
+000078c0: 696e 7075 7420 7061 7261 6d65 7465 7273  input parameters
+000078d0: 0a20 2020 2070 6174 6820 3d20 5061 7468  .    path = Path
+000078e0: 2870 6174 6829 0a20 2020 2069 6620 6c61  (path).    if la
+000078f0: 7965 7220 6973 204e 6f6e 653a 0a20 2020  yer is None:.   
+00007900: 2020 2020 206c 6179 6572 203d 2067 6574       layer = get
+00007910: 5f6f 6e6c 795f 6c61 7965 7228 7061 7468  _only_layer(path
+00007920: 290a 2020 2020 696e 666f 203d 2067 6574  ).    info = get
+00007930: 5f6c 6179 6572 696e 666f 2870 6174 682c  _layerinfo(path,
+00007940: 206c 6179 6572 2c20 7261 6973 655f 6f6e   layer, raise_on
+00007950: 5f6e 6f67 656f 6d3d 4661 6c73 6529 0a20  _nogeom=False). 
+00007960: 2020 2069 6620 636f 6c75 6d6e 5f6e 616d     if column_nam
+00007970: 6520 6e6f 7420 696e 2069 6e66 6f2e 636f  e not in info.co
+00007980: 6c75 6d6e 733a 0a20 2020 2020 2020 206c  lumns:.        l
+00007990: 6f67 6765 722e 696e 666f 2866 2243 6f6c  ogger.info(f"Col
+000079a0: 756d 6e20 7b63 6f6c 756d 6e5f 6e61 6d65  umn {column_name
+000079b0: 7d20 6e6f 7420 7072 6573 656e 7420 736f  } not present so
+000079c0: 2063 616e 6e6f 7420 6265 2064 726f 7070   cannot be dropp
+000079d0: 6564 2e22 290a 2020 2020 2020 2020 7265  ed.").        re
+000079e0: 7475 726e 0a0a 2020 2020 2320 4e6f 7720  turn..    # Now 
+000079f0: 7265 616c 6c79 2072 656e 616d 650a 2020  really rename.  
+00007a00: 2020 6461 7461 736f 7572 6365 203d 204e    datasource = N
+00007a10: 6f6e 650a 2020 2020 7472 793a 0a20 2020  one.    try:.   
+00007a20: 2020 2020 2064 6174 6173 6f75 7263 6520       datasource 
+00007a30: 3d20 6764 616c 2e4f 7065 6e45 7828 7374  = gdal.OpenEx(st
+00007a40: 7228 7061 7468 292c 206e 4f70 656e 466c  r(path), nOpenFl
+00007a50: 6167 733d 6764 616c 2e4f 465f 5550 4441  ags=gdal.OF_UPDA
+00007a60: 5445 290a 2020 2020 2020 2020 7371 6c5f  TE).        sql_
+00007a70: 7374 6d74 203d 2066 2741 4c54 4552 2054  stmt = f'ALTER T
+00007a80: 4142 4c45 2022 7b6c 6179 6572 7d22 2044  ABLE "{layer}" D
+00007a90: 524f 5020 434f 4c55 4d4e 2022 7b63 6f6c  ROP COLUMN "{col
+00007aa0: 756d 6e5f 6e61 6d65 7d22 270a 2020 2020  umn_name}"'.    
+00007ab0: 2020 2020 7265 7375 6c74 203d 2064 6174      result = dat
+00007ac0: 6173 6f75 7263 652e 4578 6563 7574 6553  asource.ExecuteS
+00007ad0: 514c 2873 716c 5f73 746d 7429 0a20 2020  QL(sql_stmt).   
+00007ae0: 2020 2020 2064 6174 6173 6f75 7263 652e       datasource.
+00007af0: 5265 6c65 6173 6552 6573 756c 7453 6574  ReleaseResultSet
+00007b00: 2872 6573 756c 7429 0a0a 2020 2020 6578  (result)..    ex
+00007b10: 6365 7074 2045 7863 6570 7469 6f6e 2061  cept Exception a
+00007b20: 7320 6578 3a0a 2020 2020 2020 2020 6578  s ex:.        ex
+00007b30: 2e61 7267 7320 3d20 2866 2264 726f 705f  .args = (f"drop_
+00007b40: 636f 6c75 6d6e 2065 7272 6f72 2066 6f72  column error for
+00007b50: 207b 7061 7468 7d2e 7b6c 6179 6572 7d3a   {path}.{layer}:
+00007b60: 5c6e 2020 7b65 787d 222c 290a 2020 2020  \n  {ex}",).    
+00007b70: 2020 2020 7261 6973 650a 2020 2020 6669      raise.    fi
+00007b80: 6e61 6c6c 793a 0a20 2020 2020 2020 2064  nally:.        d
+00007b90: 6174 6173 6f75 7263 6520 3d20 4e6f 6e65  atasource = None
+00007ba0: 0a0a 0a64 6566 2075 7064 6174 655f 636f  ...def update_co
+00007bb0: 6c75 6d6e 280a 2020 2020 7061 7468 3a20  lumn(.    path: 
+00007bc0: 556e 696f 6e5b 7374 722c 2022 6f73 2e50  Union[str, "os.P
+00007bd0: 6174 684c 696b 655b 416e 795d 225d 2c0a  athLike[Any]"],.
+00007be0: 2020 2020 6e61 6d65 3a20 7374 722c 0a20      name: str,. 
+00007bf0: 2020 2065 7870 7265 7373 696f 6e3a 2073     expression: s
+00007c00: 7472 2c0a 2020 2020 6c61 7965 723a 204f  tr,.    layer: O
+00007c10: 7074 696f 6e61 6c5b 7374 725d 203d 204e  ptional[str] = N
+00007c20: 6f6e 652c 0a20 2020 2077 6865 7265 3a20  one,.    where: 
+00007c30: 4f70 7469 6f6e 616c 5b73 7472 5d20 3d20  Optional[str] = 
+00007c40: 4e6f 6e65 2c0a 293a 0a20 2020 2022 2222  None,.):.    """
+00007c50: 0a20 2020 2055 7064 6174 6520 6120 636f  .    Update a co
+00007c60: 6c75 6d6e 2066 726f 6d20 6120 6c61 7965  lumn from a laye
+00007c70: 7220 6f66 2074 6865 2067 656f 6669 6c65  r of the geofile
+00007c80: 2e0a 0a20 2020 2041 7267 733a 0a20 2020  ...    Args:.   
+00007c90: 2020 2020 2070 6174 6820 2850 6174 684c       path (PathL
+00007ca0: 696b 6529 3a20 5061 7468 2074 6f20 7468  ike): Path to th
+00007cb0: 6520 6765 6f66 696c 650a 2020 2020 2020  e geofile.      
+00007cc0: 2020 6e61 6d65 2028 7374 7229 3a20 4e61    name (str): Na
+00007cd0: 6d65 2066 6f72 2074 6865 206e 6577 2063  me for the new c
+00007ce0: 6f6c 756d 6e0a 2020 2020 2020 2020 6578  olumn.        ex
+00007cf0: 7072 6573 7369 6f6e 2028 7374 7229 3a20  pression (str): 
+00007d00: 5351 4c69 7465 2065 7870 7265 7373 696f  SQLite expressio
+00007d10: 6e20 746f 2075 7365 2074 6f20 7570 6461  n to use to upda
+00007d20: 7465 2074 6865 2076 616c 7565 2e0a 2020  te the value..  
+00007d30: 2020 2020 2020 6c61 7965 7220 2873 7472        layer (str
+00007d40: 2c20 6f70 7469 6f6e 616c 293a 2054 6865  , optional): The
+00007d50: 206c 6179 6572 206e 616d 652e 2049 6620   layer name. If 
+00007d60: 4e6f 6e65 2061 6e64 2074 6865 2067 656f  None and the geo
+00007d70: 6669 6c65 0a20 2020 2020 2020 2020 2020  file.           
+00007d80: 2068 6173 206f 6e6c 7920 6f6e 6520 6c61   has only one la
+00007d90: 7965 722c 2074 6861 7420 6c61 7965 7220  yer, that layer 
+00007da0: 6973 2075 7365 642e 2044 6566 6175 6c74  is used. Default
+00007db0: 7320 746f 204e 6f6e 652e 0a20 2020 2020  s to None..     
+00007dc0: 2020 2077 6865 7265 2028 7374 722c 206f     where (str, o
+00007dd0: 7074 696f 6e61 6c29 3a20 5351 4c20 7768  ptional): SQL wh
+00007de0: 6572 6520 636c 6175 7365 2074 6f20 7265  ere clause to re
+00007df0: 7374 7269 6374 2074 6865 2072 6f77 7320  strict the rows 
+00007e00: 7468 6174 2077 696c 6c0a 2020 2020 2020  that will.      
+00007e10: 2020 2020 2020 6265 2075 7064 6174 6564        be updated
+00007e20: 2e20 4465 6661 756c 7473 2074 6f20 4e6f  . Defaults to No
+00007e30: 6e65 2e0a 0a20 2020 2052 6169 7365 733a  ne...    Raises:
+00007e40: 0a20 2020 2020 2020 2056 616c 7565 4572  .        ValueEr
+00007e50: 726f 723a 2061 6e20 696e 7661 6c69 6420  ror: an invalid 
+00007e60: 7061 7261 6d65 7465 7220 7661 6c75 6520  parameter value 
+00007e70: 7761 7320 7061 7373 6564 2e0a 2020 2020  was passed..    
+00007e80: 2222 220a 2020 2020 2320 496e 6974 0a20  """.    # Init. 
+00007e90: 2020 2070 6174 6820 3d20 5061 7468 2870     path = Path(p
+00007ea0: 6174 6829 0a20 2020 2069 6620 6c61 7965  ath).    if laye
+00007eb0: 7220 6973 204e 6f6e 653a 0a20 2020 2020  r is None:.     
+00007ec0: 2020 206c 6179 6572 203d 2067 6574 5f6f     layer = get_o
+00007ed0: 6e6c 795f 6c61 7965 7228 7061 7468 290a  nly_layer(path).
+00007ee0: 2020 2020 6c61 7965 7269 6e66 6f5f 6f72      layerinfo_or
+00007ef0: 6967 203d 2067 6574 5f6c 6179 6572 696e  ig = get_layerin
+00007f00: 666f 2870 6174 682c 206c 6179 6572 290a  fo(path, layer).
+00007f10: 2020 2020 636f 6c75 6d6e 735f 7570 7065      columns_uppe
+00007f20: 7220 3d20 5b63 6f6c 756d 6e2e 7570 7065  r = [column.uppe
+00007f30: 7228 2920 666f 7220 636f 6c75 6d6e 2069  r() for column i
+00007f40: 6e20 6c61 7965 7269 6e66 6f5f 6f72 6967  n layerinfo_orig
+00007f50: 2e63 6f6c 756d 6e73 5d0a 2020 2020 6966  .columns].    if
+00007f60: 206c 6179 6572 696e 666f 5f6f 7269 672e   layerinfo_orig.
+00007f70: 6765 6f6d 6574 7279 636f 6c75 6d6e 2069  geometrycolumn i
+00007f80: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00007f90: 2020 2020 636f 6c75 6d6e 735f 7570 7065      columns_uppe
+00007fa0: 722e 6170 7065 6e64 286c 6179 6572 696e  r.append(layerin
+00007fb0: 666f 5f6f 7269 672e 6765 6f6d 6574 7279  fo_orig.geometry
+00007fc0: 636f 6c75 6d6e 2e75 7070 6572 2829 290a  column.upper()).
+00007fd0: 2020 2020 6966 206e 616d 652e 7570 7065      if name.uppe
+00007fe0: 7228 2920 6e6f 7420 696e 2063 6f6c 756d  r() not in colum
+00007ff0: 6e73 5f75 7070 6572 3a0a 2020 2020 2020  ns_upper:.      
+00008000: 2020 2320 4966 2063 6f6c 756d 6e20 646f    # If column do
+00008010: 6573 6e27 7420 6578 6973 7420 7965 742c  esn't exist yet,
+00008020: 2065 7272 6f72 210a 2020 2020 2020 2020   error!.        
+00008030: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+00008040: 2866 2243 6f6c 756d 6e20 7b6e 616d 657d  (f"Column {name}
+00008050: 2064 6f65 736e 2774 2065 7869 7374 2069   doesn't exist i
+00008060: 6e20 7b70 6174 687d 2c20 6c61 7965 7220  n {path}, layer 
+00008070: 7b6c 6179 6572 7d22 290a 0a20 2020 2023  {layer}")..    #
+00008080: 2047 6f21 0a20 2020 2064 6174 6173 6f75   Go!.    datasou
+00008090: 7263 6520 3d20 4e6f 6e65 0a20 2020 2074  rce = None.    t
+000080a0: 7279 3a0a 2020 2020 2020 2020 6461 7461  ry:.        data
+000080b0: 736f 7572 6365 203d 2067 6461 6c2e 4f70  source = gdal.Op
+000080c0: 656e 4578 2873 7472 2870 6174 6829 2c20  enEx(str(path), 
+000080d0: 6e4f 7065 6e46 6c61 6773 3d67 6461 6c2e  nOpenFlags=gdal.
+000080e0: 4f46 5f55 5044 4154 4529 0a20 2020 2020  OF_UPDATE).     
+000080f0: 2020 2073 716c 6974 655f 7374 6d74 203d     sqlite_stmt =
+00008100: 2066 2755 5044 4154 4520 227b 6c61 7965   f'UPDATE "{laye
+00008110: 727d 2220 5345 5420 227b 6e61 6d65 7d22  r}" SET "{name}"
+00008120: 203d 207b 6578 7072 6573 7369 6f6e 7d27   = {expression}'
+00008130: 0a20 2020 2020 2020 2069 6620 7768 6572  .        if wher
+00008140: 6520 6973 206e 6f74 204e 6f6e 653a 0a20  e is not None:. 
+00008150: 2020 2020 2020 2020 2020 2073 716c 6974             sqlit
+00008160: 655f 7374 6d74 202b 3d20 6622 5c6e 2057  e_stmt += f"\n W
+00008170: 4845 5245 207b 7768 6572 657d 220a 2020  HERE {where}".  
+00008180: 2020 2020 2020 7265 7375 6c74 203d 2064        result = d
+00008190: 6174 6173 6f75 7263 652e 4578 6563 7574  atasource.Execut
+000081a0: 6553 514c 2873 716c 6974 655f 7374 6d74  eSQL(sqlite_stmt
+000081b0: 2c20 6469 616c 6563 743d 2253 514c 4954  , dialect="SQLIT
+000081c0: 4522 290a 2020 2020 2020 2020 6461 7461  E").        data
+000081d0: 736f 7572 6365 2e52 656c 6561 7365 5265  source.ReleaseRe
+000081e0: 7375 6c74 5365 7428 7265 7375 6c74 290a  sultSet(result).
+000081f0: 0a20 2020 2065 7863 6570 7420 4578 6365  .    except Exce
+00008200: 7074 696f 6e20 6173 2065 783a 0a20 2020  ption as ex:.   
+00008210: 2020 2020 2065 782e 6172 6773 203d 2028       ex.args = (
+00008220: 6622 7570 6461 7465 5f63 6f6c 756d 6e20  f"update_column 
+00008230: 6572 726f 7220 666f 7220 7b70 6174 687d  error for {path}
+00008240: 2e7b 6c61 7965 727d 3a5c 6e20 207b 6578  .{layer}:\n  {ex
+00008250: 7d22 2c29 0a20 2020 2020 2020 2072 6169  }",).        rai
+00008260: 7365 0a20 2020 2066 696e 616c 6c79 3a0a  se.    finally:.
+00008270: 2020 2020 2020 2020 6461 7461 736f 7572          datasour
+00008280: 6365 203d 204e 6f6e 650a 0a0a 6465 6620  ce = None...def 
+00008290: 7265 6164 5f66 696c 6528 0a20 2020 2070  read_file(.    p
+000082a0: 6174 683a 2055 6e69 6f6e 5b73 7472 2c20  ath: Union[str, 
+000082b0: 226f 732e 5061 7468 4c69 6b65 5b41 6e79  "os.PathLike[Any
+000082c0: 5d22 5d2c 0a20 2020 206c 6179 6572 3a20  ]"],.    layer: 
+000082d0: 4f70 7469 6f6e 616c 5b73 7472 5d20 3d20  Optional[str] = 
+000082e0: 4e6f 6e65 2c0a 2020 2020 636f 6c75 6d6e  None,.    column
+000082f0: 733a 204f 7074 696f 6e61 6c5b 4974 6572  s: Optional[Iter
+00008300: 6162 6c65 5b73 7472 5d5d 203d 204e 6f6e  able[str]] = Non
+00008310: 652c 0a20 2020 2062 626f 783d 4e6f 6e65  e,.    bbox=None
+00008320: 2c0a 2020 2020 726f 7773 3d4e 6f6e 652c  ,.    rows=None,
+00008330: 0a20 2020 2077 6865 7265 3a20 4f70 7469  .    where: Opti
+00008340: 6f6e 616c 5b73 7472 5d20 3d20 4e6f 6e65  onal[str] = None
+00008350: 2c0a 2020 2020 7371 6c5f 7374 6d74 3a20  ,.    sql_stmt: 
+00008360: 4f70 7469 6f6e 616c 5b73 7472 5d20 3d20  Optional[str] = 
+00008370: 4e6f 6e65 2c0a 2020 2020 7371 6c5f 6469  None,.    sql_di
+00008380: 616c 6563 743a 204f 7074 696f 6e61 6c5b  alect: Optional[
+00008390: 4c69 7465 7261 6c5b 2253 514c 4954 4522  Literal["SQLITE"
+000083a0: 2c20 224f 4752 5351 4c22 5d5d 203d 204e  , "OGRSQL"]] = N
+000083b0: 6f6e 652c 0a20 2020 2069 676e 6f72 655f  one,.    ignore_
+000083c0: 6765 6f6d 6574 7279 3a20 626f 6f6c 203d  geometry: bool =
+000083d0: 2046 616c 7365 2c0a 2020 2020 6669 645f   False,.    fid_
+000083e0: 6173 5f69 6e64 6578 3a20 626f 6f6c 203d  as_index: bool =
+000083f0: 2046 616c 7365 2c0a 2020 2020 2a2a 6b77   False,.    **kw
+00008400: 6172 6773 2c0a 2920 2d3e 2067 7064 2e47  args,.) -> gpd.G
+00008410: 656f 4461 7461 4672 616d 653a 0a20 2020  eoDataFrame:.   
+00008420: 2022 2222 0a20 2020 2052 6561 6473 2061   """.    Reads a
+00008430: 2066 696c 6520 746f 2061 2067 656f 7061   file to a geopa
+00008440: 6e64 6173 2047 656f 4461 7461 6672 616d  ndas GeoDatafram
+00008450: 652e 0a0a 2020 2020 5468 6520 6669 6c65  e...    The file
+00008460: 2066 6f72 6d61 7420 6973 2064 6574 6563   format is detec
+00008470: 7465 6420 6261 7365 6420 6f6e 2074 6865  ted based on the
+00008480: 2066 696c 6570 6174 6820 6578 7465 6e73   filepath extens
+00008490: 696f 6e2e 0a0a 2020 2020 4966 2060 6073  ion...    If ``s
+000084a0: 716c 5f73 746d 7460 6020 6973 2073 7065  ql_stmt`` is spe
+000084b0: 6369 6669 6564 2c20 7468 6520 7371 6c69  cified, the sqli
+000084c0: 7465 2071 7565 7279 2063 616e 2063 6f6e  te query can con
+000084d0: 7461 696e 2066 6f6c 6c6f 7769 6e67 2070  tain following p
+000084e0: 6c61 6365 686f 6c64 6572 730a 2020 2020  laceholders.    
+000084f0: 7468 6174 2077 696c 6c20 6265 2061 7574  that will be aut
+00008500: 6f6d 6174 6963 616c 6c79 2072 6570 6c61  omatically repla
+00008510: 6365 6420 666f 7220 796f 753a 0a0a 2020  ced for you:..  
+00008520: 2020 2020 2a20 7b67 656f 6d65 7472 7963      * {geometryc
+00008530: 6f6c 756d 6e7d 3a20 7468 6520 636f 6c75  olumn}: the colu
+00008540: 6d6e 2077 6865 7265 2074 6865 2070 7269  mn where the pri
+00008550: 6d61 7279 2067 656f 6d65 7472 7920 6973  mary geometry is
+00008560: 2073 746f 7265 642e 0a20 2020 2020 202a   stored..      *
+00008570: 207b 636f 6c75 6d6e 735f 746f 5f73 656c   {columns_to_sel
+00008580: 6563 745f 7374 727d 3a20 6966 2060 6063  ect_str}: if ``c
+00008590: 6f6c 756d 6e73 6060 2069 7320 6e6f 7420  olumns`` is not 
+000085a0: 4e6f 6e65 2c20 7468 6f73 6520 636f 6c75  None, those colu
+000085b0: 6d6e 732c 0a20 2020 2020 2020 206f 7468  mns,.        oth
+000085c0: 6572 7769 7365 2061 6c6c 2063 6f6c 756d  erwise all colum
+000085d0: 6e73 206f 6620 7468 6520 6c61 7965 722e  ns of the layer.
+000085e0: 0a20 2020 2020 202a 207b 696e 7075 745f  .      * {input_
+000085f0: 6c61 7965 727d 3a20 7468 6520 6c61 7965  layer}: the laye
+00008600: 7220 6e61 6d65 206f 6620 7468 6520 696e  r name of the in
+00008610: 7075 7420 6c61 7965 722e 0a0a 2020 2020  put layer...    
+00008620: 4578 616d 706c 6520 5351 4c20 7374 6174  Example SQL stat
+00008630: 656d 656e 7420 7769 7468 2070 6c61 6365  ement with place
+00008640: 686f 6c64 6572 733a 0a20 2020 203a 3a0a  holders:.    ::.
+00008650: 0a20 2020 2020 2020 2053 454c 4543 5420  .        SELECT 
+00008660: 7b67 656f 6d65 7472 7963 6f6c 756d 6e7d  {geometrycolumn}
+00008670: 0a20 2020 2020 2020 2020 2020 2020 207b  .              {
+00008680: 636f 6c75 6d6e 735f 746f 5f73 656c 6563  columns_to_selec
+00008690: 745f 7374 727d 0a20 2020 2020 2020 2020  t_str}.         
+000086a0: 2046 524f 4d20 227b 696e 7075 745f 6c61   FROM "{input_la
+000086b0: 7965 727d 2220 6c61 7965 720a 0a20 2020  yer}" layer..   
+000086c0: 2054 6865 2075 6e64 6572 6c79 696e 6720   The underlying 
+000086d0: 6c69 6272 6172 7920 7573 6564 2074 6f20  library used to 
+000086e0: 7265 6164 2074 6865 2066 696c 6520 6361  read the file ca
+000086f0: 6e20 6265 2063 686f 6f73 656e 2075 7369  n be choosen usi
+00008700: 6e67 2074 6865 0a20 2020 2022 4746 4f5f  ng the.    "GFO_
+00008710: 494f 5f45 4e47 494e 4522 2065 6e76 6972  IO_ENGINE" envir
+00008720: 6f6e 6d65 6e74 2076 6172 6961 626c 652e  onment variable.
+00008730: 2050 6f73 7369 626c 6520 7661 6c75 6573   Possible values
+00008740: 2061 7265 2022 6669 6f6e 6122 2061 6e64   are "fiona" and
+00008750: 2022 7079 6f67 7269 6f22 2e0a 2020 2020   "pyogrio"..    
+00008760: 5468 6973 206f 7074 696f 6e20 6973 2063  This option is c
+00008770: 7265 6174 6564 2061 7320 6120 7465 6d70  reated as a temp
+00008780: 6f72 6172 7920 6661 6c6c 6261 636b 2074  orary fallback t
+00008790: 6f20 2266 696f 6e61 2220 666f 7220 6361  o "fiona" for ca
+000087a0: 7365 7320 7768 6572 6520 2270 796f 6772  ses where "pyogr
+000087b0: 696f 220a 2020 2020 6769 7665 7320 6973  io".    gives is
+000087c0: 7375 6573 2c20 736f 2070 6c65 6173 6520  sues, so please 
+000087d0: 7265 706f 7274 2069 7373 7565 7320 6966  report issues if
+000087e0: 2074 6865 7920 6172 6520 656e 636f 756e   they are encoun
+000087f0: 7465 7265 642e 2049 6e20 7468 6520 6675  tered. In the fu
+00008800: 7475 7265 2073 7570 706f 7274 0a20 2020  ture support.   
+00008810: 2066 6f72 2074 6865 2022 6669 6f6e 6122   for the "fiona"
+00008820: 2065 6e67 696e 6520 6d6f 7374 206c 696b   engine most lik
+00008830: 656c 7920 7769 6c6c 2062 6520 7265 6d6f  ely will be remo
+00008840: 7665 642e 2044 6566 6175 6c74 2065 6e67  ved. Default eng
+00008850: 696e 6520 6973 2022 7079 6f67 7269 6f22  ine is "pyogrio"
+00008860: 2e0a 0a20 2020 2041 7267 733a 0a20 2020  ...    Args:.   
+00008870: 2020 2020 2070 6174 6820 2866 696c 6520       path (file 
+00008880: 7061 7468 293a 2070 6174 6820 746f 2074  path): path to t
+00008890: 6865 2066 696c 6520 746f 2072 6561 6420  he file to read 
+000088a0: 6672 6f6d 0a20 2020 2020 2020 206c 6179  from.        lay
+000088b0: 6572 2028 7374 722c 206f 7074 696f 6e61  er (str, optiona
+000088c0: 6c29 3a20 5468 6520 6c61 7965 7220 746f  l): The layer to
+000088d0: 2072 6561 642e 2049 6620 4e6f 6e65 2061   read. If None a
+000088e0: 6e64 2074 6865 7265 2069 7320 6f6e 6c79  nd there is only
+000088f0: 206f 6e65 206c 6179 6572 2069 6e0a 2020   one layer in.  
+00008900: 2020 2020 2020 2020 2020 7468 6520 6669            the fi
+00008910: 6c65 2069 7420 6973 2072 6561 642c 206f  le it is read, o
+00008920: 7468 6572 7769 7365 2061 6e20 6572 726f  therwise an erro
+00008930: 7220 6973 2074 6872 6f77 6e2e 2044 6566  r is thrown. Def
+00008940: 6175 6c74 7320 746f 204e 6f6e 652e 0a20  aults to None.. 
+00008950: 2020 2020 2020 2063 6f6c 756d 6e73 2028         columns (
+00008960: 4974 6572 6162 6c65 5b73 7472 5d2c 206f  Iterable[str], o
+00008970: 7074 696f 6e61 6c29 3a20 5468 6520 286e  ptional): The (n
+00008980: 6f6e 2d67 656f 6d65 7472 7929 2063 6f6c  on-geometry) col
+00008990: 756d 6e73 2074 6f20 7265 6164 2077 696c  umns to read wil
+000089a0: 6c0a 2020 2020 2020 2020 2020 2020 6265  l.            be
+000089b0: 2072 6574 7572 6e65 6420 696e 2074 6865   returned in the
+000089c0: 206f 7264 6572 2073 7065 6369 6669 6564   order specified
+000089d0: 2e20 4966 204e 6f6e 652c 2061 6c6c 2073  . If None, all s
+000089e0: 7461 6e64 6172 6420 636f 6c75 6d6e 7320  tandard columns 
+000089f0: 6172 6520 7265 6164 2e0a 2020 2020 2020  are read..      
+00008a00: 2020 2020 2020 496e 2061 6464 6974 696f        In additio
+00008a10: 6e20 746f 2073 7461 6e64 6172 6420 636f  n to standard co
+00008a20: 6c75 6d6e 732c 2069 7420 6973 2061 6c73  lumns, it is als
+00008a30: 6f20 706f 7373 6962 6c65 0a20 2020 2020  o possible.     
+00008a40: 2020 2020 2020 2074 6f20 7370 6563 6966         to specif
+00008a50: 7920 2266 6964 222c 2061 2075 6e69 7175  y "fid", a uniqu
+00008a60: 6520 696e 6465 7820 6176 6169 6c61 626c  e index availabl
+00008a70: 6520 696e 2061 6c6c 2069 6e70 7574 2066  e in all input f
+00008a80: 696c 6573 2e20 4e6f 7465 2074 6861 7420  iles. Note that 
+00008a90: 7468 650a 2020 2020 2020 2020 2020 2020  the.            
+00008aa0: 2266 6964 2220 7769 6c6c 2062 6520 616c  "fid" will be al
+00008ab0: 6961 7365 6420 6567 2e20 746f 2022 6669  iased eg. to "fi
+00008ac0: 645f 3122 2e20 4465 6661 756c 7473 2074  d_1". Defaults t
+00008ad0: 6f20 4e6f 6e65 2e0a 2020 2020 2020 2020  o None..        
+00008ae0: 6262 6f78 2028 5475 706c 652c 206f 7074  bbox (Tuple, opt
+00008af0: 696f 6e61 6c29 3a20 7265 7475 726e 206f  ional): return o
+00008b00: 6e6c 7920 6765 6f6d 6574 7269 6573 2069  nly geometries i
+00008b10: 6e74 6572 7365 6374 696e 6720 7468 6973  ntersecting this
+00008b20: 2062 626f 782e 0a20 2020 2020 2020 2020   bbox..         
+00008b30: 2020 2044 6566 6175 6c74 7320 746f 204e     Defaults to N
+00008b40: 6f6e 652c 2074 6865 6e20 616c 6c20 726f  one, then all ro
+00008b50: 7773 2061 7265 2072 6561 642e 0a20 2020  ws are read..   
+00008b60: 2020 2020 2072 6f77 7320 2873 6c69 6365       rows (slice
+00008b70: 2c20 6f70 7469 6f6e 616c 293a 2072 6574  , optional): ret
+00008b80: 7572 6e20 6f6e 6c79 2074 6865 2072 6f77  urn only the row
+00008b90: 7320 7370 6563 6966 6965 642e 2046 6f72  s specified. For
+00008ba0: 206d 616e 7920 6669 6c65 2066 6f72 6d61   many file forma
+00008bb0: 7473 0a20 2020 2020 2020 2020 2020 2028  ts.            (
+00008bc0: 652e 672e 2047 656f 7061 636b 6167 6529  e.g. Geopackage)
+00008bd0: 2074 6869 7320 6973 2073 6c6f 772c 2073   this is slow, s
+00008be0: 6f20 7573 696e 6720 652e 672e 2061 2077  o using e.g. a w
+00008bf0: 6865 7265 2066 696c 7465 7220 696e 7374  here filter inst
+00008c00: 6561 6420 6973 0a20 2020 2020 2020 2020  ead is.         
+00008c10: 2020 2072 6563 6f6d 6d65 6e64 6564 2e20     recommended. 
+00008c20: 4465 6661 756c 7473 2074 6f20 4e6f 6e65  Defaults to None
+00008c30: 2c20 7468 656e 2061 6c6c 2072 6f77 7320  , then all rows 
+00008c40: 6172 6520 7265 7475 726e 6564 2e0a 2020  are returned..  
+00008c50: 2020 2020 2020 7768 6572 6520 2873 7472        where (str
+00008c60: 2c20 6f70 7469 6f6e 616c 293a 2077 6865  , optional): whe
+00008c70: 7265 2063 6c61 7573 6520 746f 2066 696c  re clause to fil
+00008c80: 7465 7220 6665 6174 7572 6573 2069 6e20  ter features in 
+00008c90: 6c61 7965 7220 6279 2061 7474 7269 6275  layer by attribu
+00008ca0: 7465 0a20 2020 2020 2020 2020 2020 2076  te.            v
+00008cb0: 616c 7565 732e 2049 6620 7468 6520 6461  alues. If the da
+00008cc0: 7461 736f 7572 6365 206e 6174 6976 656c  tasource nativel
+00008cd0: 7920 7375 7070 6f72 7473 2073 716c 2c20  y supports sql, 
+00008ce0: 6974 7320 7370 6563 6966 6963 2053 514c  its specific SQL
+00008cf0: 2064 6961 6c65 6374 0a20 2020 2020 2020   dialect.       
+00008d00: 2020 2020 2073 686f 756c 6420 6265 2075       should be u
+00008d10: 7365 6420 2865 672e 2053 514c 6974 6520  sed (eg. SQLite 
+00008d20: 616e 6420 4765 6f50 6163 6b61 6765 3a20  and GeoPackage: 
+00008d30: 6053 514c 4954 4560 5f2c 2050 6f73 7467  `SQLITE`_, Postg
+00008d40: 7265 5351 4c29 2e20 4966 2069 740a 2020  reSQL). If it.  
+00008d50: 2020 2020 2020 2020 2020 646f 6573 6e27            doesn'
+00008d60: 742c 2074 6865 2060 4f47 5253 514c 2057  t, the `OGRSQL W
+00008d70: 4845 5245 605f 2073 796e 7461 7820 7368  HERE`_ syntax sh
+00008d80: 6f75 6c64 2062 6520 7573 6564 2e20 4e6f  ould be used. No
+00008d90: 7465 2074 6861 7420 6974 2069 7320 6e6f  te that it is no
+00008da0: 740a 2020 2020 2020 2020 2020 2020 706f  t.            po
+00008db0: 7373 6962 6c65 2074 6f20 6f76 6572 7275  ssible to overru
+00008dc0: 6c65 2074 6865 2053 514c 2064 6961 6c65  le the SQL diale
+00008dd0: 6374 2c20 7468 6973 2069 7320 6f6e 6c79  ct, this is only
+00008de0: 2070 6f73 7369 626c 6520 7768 656e 2079   possible when y
+00008df0: 6f75 2075 7365 2074 6865 0a20 2020 2020  ou use the.     
+00008e00: 2020 2020 2020 2053 514c 2070 6172 616d         SQL param
+00008e10: 6574 6572 2e20 4578 616d 706c 6573 3a20  eter. Examples: 
+00008e20: 6060 2249 534f 5f41 3320 3d20 2743 414e  ``"ISO_A3 = 'CAN
+00008e30: 2722 6060 2c0a 2020 2020 2020 2020 2020  '"``,.          
+00008e40: 2020 6060 2250 4f50 5f45 5354 203e 2031    ``"POP_EST > 1
+00008e50: 3030 3030 3030 3020 414e 4420 504f 505f  0000000 AND POP_
+00008e60: 4553 5420 3c20 3130 3030 3030 3030 3022  EST < 100000000"
+00008e70: 6060 2e20 4465 6661 756c 7473 2074 6f20  ``. Defaults to 
+00008e80: 4e6f 6e65 2e0a 2020 2020 2020 2020 7371  None..        sq
+00008e90: 6c5f 7374 6d74 2028 7374 7229 3a20 5351  l_stmt (str): SQ
+00008ea0: 4c20 7374 6174 656d 656e 7420 746f 2075  L statement to u
+00008eb0: 7365 2e20 4f6e 6c79 2073 7570 706f 7274  se. Only support
+00008ec0: 6564 2077 6974 6820 2270 796f 6772 696f  ed with "pyogrio
+00008ed0: 2220 656e 6769 6e65 2e0a 2020 2020 2020  " engine..      
+00008ee0: 2020 7371 6c5f 6469 616c 6563 7420 2873    sql_dialect (s
+00008ef0: 7472 2c20 6f70 7469 6f6e 616c 293a 2053  tr, optional): S
+00008f00: 514c 2064 6961 6c65 6374 2075 7365 642e  QL dialect used.
+00008f10: 204f 7074 696f 6e73 2061 7265 204e 6f6e   Options are Non
+00008f20: 652c 2022 5351 4c49 5445 2220 6f72 0a20  e, "SQLITE" or. 
+00008f30: 2020 2020 2020 2020 2020 2022 4f47 5253             "OGRS
+00008f40: 514c 222e 2049 6620 4e6f 6e65 2c20 666f  QL". If None, fo
+00008f50: 7220 6461 7461 2073 6f75 7263 6573 2077  r data sources w
+00008f60: 6974 6820 6578 706c 6963 6974 2053 514c  ith explicit SQL
+00008f70: 2073 7570 706f 7274 2074 6865 2073 7461   support the sta
+00008f80: 7465 6d65 6e74 0a20 2020 2020 2020 2020  tement.         
+00008f90: 2020 2069 7320 7072 6f63 6573 7365 6420     is processed 
+00008fa0: 6279 2074 6865 2064 6566 6175 6c74 2053  by the default S
+00008fb0: 514c 2065 6e67 696e 6520 2865 2e67 2e20  QL engine (e.g. 
+00008fc0: 666f 7220 4765 6f70 6163 6b61 6765 2061  for Geopackage a
+00008fd0: 6e64 2053 7061 7469 616c 6974 650a 2020  nd Spatialite.  
+00008fe0: 2020 2020 2020 2020 2020 7468 6973 2069            this i
+00008ff0: 7320 2253 514c 4954 4522 292e 2046 6f72  s "SQLITE"). For
+00009000: 2064 6174 6120 736f 7572 6365 7320 7769   data sources wi
+00009010: 7468 6f75 7420 6e61 7469 7665 2053 514c  thout native SQL
+00009020: 2073 7570 706f 7274 2028 652e 672e 202e   support (e.g. .
+00009030: 7368 7029 2c0a 2020 2020 2020 2020 2020  shp),.          
+00009040: 2020 7468 6520 224f 4752 5351 4c22 2064    the "OGRSQL" d
+00009050: 6961 6c65 6374 2069 7320 7468 6520 6465  ialect is the de
+00009060: 6661 756c 742e 2049 6620 7468 6520 2253  fault. If the "S
+00009070: 514c 4954 4522 2064 6961 6c65 6374 2069  QLITE" dialect i
+00009080: 7320 7370 6563 6966 6965 642c 0a20 2020  s specified,.   
+00009090: 2020 2020 2020 2020 207c 7370 6174 6961           |spatia
+000090a0: 6c69 7465 5f72 6566 6572 656e 6365 5f6c  lite_reference_l
+000090b0: 696e 6b7c 2066 756e 6374 696f 6e73 2063  ink| functions c
+000090c0: 616e 2061 6c73 6f20 6265 2075 7365 642e  an also be used.
+000090d0: 2044 6566 6175 6c74 7320 746f 204e 6f6e   Defaults to Non
+000090e0: 652e 0a20 2020 2020 2020 2069 676e 6f72  e..        ignor
+000090f0: 655f 6765 6f6d 6574 7279 2028 626f 6f6c  e_geometry (bool
+00009100: 2c20 6f70 7469 6f6e 616c 293a 2054 7275  , optional): Tru
+00009110: 6520 6e6f 7420 746f 2072 6561 642f 7265  e not to read/re
+00009120: 7475 726e 2074 6865 2067 656f 6d65 7472  turn the geometr
+00009130: 792e 0a20 2020 2020 2020 2020 2020 2044  y..            D
+00009140: 6566 6175 6c74 7320 746f 2046 616c 7365  efaults to False
+00009150: 2e0a 2020 2020 2020 2020 6669 645f 6173  ..        fid_as
+00009160: 5f69 6e64 6578 2028 626f 6f6c 2c20 6f70  _index (bool, op
+00009170: 7469 6f6e 616c 293a 2049 6620 5472 7565  tional): If True
+00009180: 2c20 7769 6c6c 2075 7365 2074 6865 2046  , will use the F
+00009190: 4944 7320 6f66 2074 6865 2066 6561 7475  IDs of the featu
+000091a0: 7265 7320 7468 6174 0a20 2020 2020 2020  res that.       
+000091b0: 2020 2020 2077 6572 6520 7265 6164 2061       were read a
+000091c0: 7320 7468 6520 696e 6465 7820 6f66 2074  s the index of t
+000091d0: 6865 2047 656f 4461 7461 4672 616d 652e  he GeoDataFrame.
+000091e0: 204d 6179 2073 7461 7274 2061 7420 3020   May start at 0 
+000091f0: 6f72 2031 2064 6570 656e 6469 6e67 206f  or 1 depending o
+00009200: 6e0a 2020 2020 2020 2020 2020 2020 7468  n.            th
+00009210: 6520 6472 6976 6572 2e20 4465 6661 756c  e driver. Defaul
+00009220: 7473 2074 6f20 4661 6c73 652e 0a20 2020  ts to False..   
+00009230: 2020 2020 202a 2a6b 7761 7267 733a 2041       **kwargs: A
+00009240: 6c6c 2061 6464 6974 696f 6e61 6c20 7061  ll additional pa
+00009250: 7261 6d65 7465 7273 2077 696c 6c20 6265  rameters will be
+00009260: 2070 6173 7365 6420 6f6e 2074 6f20 7468   passed on to th
+00009270: 6520 696f 2d65 6e67 696e 6520 7573 6564  e io-engine used
+00009280: 0a20 2020 2020 2020 2020 2020 2028 2270  .            ("p
+00009290: 796f 6772 696f 2220 6f72 2022 6669 6f6e  yogrio" or "fion
+000092a0: 6122 292e 0a0a 2020 2020 5261 6973 6573  a")...    Raises
+000092b0: 3a0a 2020 2020 2020 2020 5661 6c75 6545  :.        ValueE
+000092c0: 7272 6f72 3a20 616e 2069 6e76 616c 6964  rror: an invalid
+000092d0: 2070 6172 616d 6574 6572 2076 616c 7565   parameter value
+000092e0: 2077 6173 2070 6173 7365 642e 0a0a 2020   was passed...  
+000092f0: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
+00009300: 2020 2067 7064 2e47 656f 4461 7461 4672     gpd.GeoDataFr
+00009310: 616d 653a 2074 6865 2064 6174 6120 7265  ame: the data re
+00009320: 6164 2e0a 0a20 2020 202e 2e20 7c4f 4752  ad...    .. |OGR
+00009330: 5351 4c20 5748 4552 457c 2072 6177 3a3a  SQL WHERE| raw::
+00009340: 2068 746d 6c0a 0a20 2020 2020 2020 203c   html..        <
+00009350: 6120 6872 6566 3d22 6874 7470 733a 2f2f  a href="https://
+00009360: 6764 616c 2e6f 7267 2f75 7365 722f 6f67  gdal.org/user/og
+00009370: 725f 7371 6c5f 6469 616c 6563 742e 6874  r_sql_dialect.ht
+00009380: 6d6c 2377 6865 7265 2220 7461 7267 6574  ml#where" target
+00009390: 3d22 5f62 6c61 6e6b 223e 4f47 5253 514c  ="_blank">OGRSQL
+000093a0: 2057 4845 5245 3c2f 613e 0a0a 2020 2020   WHERE</a>..    
+000093b0: 2e2e 207c 7370 6174 6961 6c69 7465 5f72  .. |spatialite_r
+000093c0: 6566 6572 656e 6365 5f6c 696e 6b7c 2072  eference_link| r
+000093d0: 6177 3a3a 2068 746d 6c0a 0a20 2020 2020  aw:: html..     
+000093e0: 2020 203c 6120 6872 6566 3d22 6874 7470     <a href="http
+000093f0: 733a 2f2f 7777 772e 6761 6961 2d67 6973  s://www.gaia-gis
+00009400: 2e69 742f 6761 6961 2d73 696e 732f 7370  .it/gaia-sins/sp
+00009410: 6174 6961 6c69 7465 2d73 716c 2d6c 6174  atialite-sql-lat
+00009420: 6573 742e 6874 6d6c 2220 7461 7267 6574  est.html" target
+00009430: 3d22 5f62 6c61 6e6b 223e 7370 6174 6961  ="_blank">spatia
+00009440: 6c69 7465 2072 6566 6572 656e 6365 3c2f  lite reference</
+00009450: 613e 0a0a 2020 2020 2222 2220 2023 206e  a>..    """  # n
+00009460: 6f71 613a 2045 3530 310a 2020 2020 7265  oqa: E501.    re
+00009470: 7375 6c74 5f67 6466 203d 205f 7265 6164  sult_gdf = _read
+00009480: 5f66 696c 655f 6261 7365 280a 2020 2020  _file_base(.    
+00009490: 2020 2020 7061 7468 3d70 6174 682c 0a20      path=path,. 
+000094a0: 2020 2020 2020 206c 6179 6572 3d6c 6179         layer=lay
+000094b0: 6572 2c0a 2020 2020 2020 2020 636f 6c75  er,.        colu
+000094c0: 6d6e 733d 636f 6c75 6d6e 732c 0a20 2020  mns=columns,.   
+000094d0: 2020 2020 2062 626f 783d 6262 6f78 2c0a       bbox=bbox,.
+000094e0: 2020 2020 2020 2020 726f 7773 3d72 6f77          rows=row
+000094f0: 732c 0a20 2020 2020 2020 2077 6865 7265  s,.        where
+00009500: 3d77 6865 7265 2c0a 2020 2020 2020 2020  =where,.        
+00009510: 7371 6c5f 7374 6d74 3d73 716c 5f73 746d  sql_stmt=sql_stm
+00009520: 742c 0a20 2020 2020 2020 2073 716c 5f64  t,.        sql_d
+00009530: 6961 6c65 6374 3d73 716c 5f64 6961 6c65  ialect=sql_diale
+00009540: 6374 2c0a 2020 2020 2020 2020 6967 6e6f  ct,.        igno
+00009550: 7265 5f67 656f 6d65 7472 793d 6967 6e6f  re_geometry=igno
+00009560: 7265 5f67 656f 6d65 7472 792c 0a20 2020  re_geometry,.   
+00009570: 2020 2020 2066 6964 5f61 735f 696e 6465       fid_as_inde
+00009580: 783d 6669 645f 6173 5f69 6e64 6578 2c0a  x=fid_as_index,.
+00009590: 2020 2020 2020 2020 2a2a 6b77 6172 6773          **kwargs
+000095a0: 2c0a 2020 2020 290a 0a20 2020 2023 204e  ,.    )..    # N
+000095b0: 6f20 6173 7365 7274 2074 6f20 6b65 6570  o assert to keep
+000095c0: 2062 6163 6b77 6172 6473 2063 6f6d 7061   backwards compa
+000095d0: 7469 6269 6c69 7479 0a20 2020 2072 6574  tibility.    ret
+000095e0: 7572 6e20 7265 7375 6c74 5f67 6466 0a0a  urn result_gdf..
+000095f0: 0a64 6566 2072 6561 645f 6669 6c65 5f6e  .def read_file_n
+00009600: 6f67 656f 6d28 0a20 2020 2070 6174 683a  ogeom(.    path:
+00009610: 2055 6e69 6f6e 5b73 7472 2c20 226f 732e   Union[str, "os.
+00009620: 5061 7468 4c69 6b65 5b41 6e79 5d22 5d2c  PathLike[Any]"],
+00009630: 0a20 2020 206c 6179 6572 3a20 4f70 7469  .    layer: Opti
+00009640: 6f6e 616c 5b73 7472 5d20 3d20 4e6f 6e65  onal[str] = None
+00009650: 2c0a 2020 2020 636f 6c75 6d6e 733a 204f  ,.    columns: O
+00009660: 7074 696f 6e61 6c5b 4974 6572 6162 6c65  ptional[Iterable
+00009670: 5b73 7472 5d5d 203d 204e 6f6e 652c 0a20  [str]] = None,. 
+00009680: 2020 2062 626f 783d 4e6f 6e65 2c0a 2020     bbox=None,.  
+00009690: 2020 726f 7773 3d4e 6f6e 652c 0a20 2020    rows=None,.   
+000096a0: 2073 716c 5f73 746d 743a 204f 7074 696f   sql_stmt: Optio
+000096b0: 6e61 6c5b 7374 725d 203d 204e 6f6e 652c  nal[str] = None,
+000096c0: 0a20 2020 2073 716c 5f64 6961 6c65 6374  .    sql_dialect
+000096d0: 3a20 4f70 7469 6f6e 616c 5b4c 6974 6572  : Optional[Liter
+000096e0: 616c 5b22 5351 4c49 5445 222c 2022 4f47  al["SQLITE", "OG
+000096f0: 5253 514c 225d 5d20 3d20 4e6f 6e65 2c0a  RSQL"]] = None,.
+00009700: 2020 2020 6669 645f 6173 5f69 6e64 6578      fid_as_index
+00009710: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
+00009720: 2920 2d3e 2070 642e 4461 7461 4672 616d  ) -> pd.DataFram
+00009730: 653a 0a20 2020 2022 2222 0a20 2020 2044  e:.    """.    D
+00009740: 4550 5245 4341 5445 443a 2070 6c65 6173  EPRECATED: pleas
+00009750: 6520 7573 6520 7265 6164 5f66 696c 6520  e use read_file 
+00009760: 7769 7468 206f 7074 696f 6e20 6967 6e6f  with option igno
+00009770: 7265 5f67 656f 6d65 7472 793d 5472 7565  re_geometry=True
+00009780: 2e0a 2020 2020 2222 220a 2020 2020 7761  ..    """.    wa
+00009790: 726e 696e 6773 2e77 6172 6e28 0a20 2020  rnings.warn(.   
+000097a0: 2020 2020 2022 7265 6164 5f66 696c 655f       "read_file_
+000097b0: 6e6f 6765 6f6d 2069 7320 6465 7072 6563  nogeom is deprec
+000097c0: 6174 6564 3a20 7573 6520 7265 6164 5f66  ated: use read_f
+000097d0: 696c 6520 7769 7468 2069 676e 6f72 655f  ile with ignore_
+000097e0: 6765 6f6d 6574 7279 3d54 7275 6522 2c0a  geometry=True",.
+000097f0: 2020 2020 2020 2020 4675 7475 7265 5761          FutureWa
+00009800: 726e 696e 672c 0a20 2020 2020 2020 2073  rning,.        s
+00009810: 7461 636b 6c65 7665 6c3d 322c 0a20 2020  tacklevel=2,.   
+00009820: 2029 0a20 2020 2072 6573 756c 745f 6764   ).    result_gd
+00009830: 6620 3d20 5f72 6561 645f 6669 6c65 5f62  f = _read_file_b
+00009840: 6173 6528 0a20 2020 2020 2020 2070 6174  ase(.        pat
+00009850: 683d 7061 7468 2c0a 2020 2020 2020 2020  h=path,.        
+00009860: 6c61 7965 723d 6c61 7965 722c 0a20 2020  layer=layer,.   
+00009870: 2020 2020 2063 6f6c 756d 6e73 3d63 6f6c       columns=col
+00009880: 756d 6e73 2c0a 2020 2020 2020 2020 6262  umns,.        bb
+00009890: 6f78 3d62 626f 782c 0a20 2020 2020 2020  ox=bbox,.       
+000098a0: 2072 6f77 733d 726f 7773 2c0a 2020 2020   rows=rows,.    
+000098b0: 2020 2020 7371 6c5f 7374 6d74 3d73 716c      sql_stmt=sql
+000098c0: 5f73 746d 742c 0a20 2020 2020 2020 2073  _stmt,.        s
+000098d0: 716c 5f64 6961 6c65 6374 3d73 716c 5f64  ql_dialect=sql_d
+000098e0: 6961 6c65 6374 2c0a 2020 2020 2020 2020  ialect,.        
+000098f0: 6967 6e6f 7265 5f67 656f 6d65 7472 793d  ignore_geometry=
+00009900: 5472 7565 2c0a 2020 2020 2020 2020 6669  True,.        fi
+00009910: 645f 6173 5f69 6e64 6578 3d66 6964 5f61  d_as_index=fid_a
+00009920: 735f 696e 6465 782c 0a20 2020 2029 0a20  s_index,.    ). 
+00009930: 2020 2061 7373 6572 7420 6973 696e 7374     assert isinst
+00009940: 616e 6365 2872 6573 756c 745f 6764 662c  ance(result_gdf,
+00009950: 2070 642e 4461 7461 4672 616d 6529 0a20   pd.DataFrame). 
+00009960: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
+00009970: 5f67 6466 0a0a 0a64 6566 205f 7265 6164  _gdf...def _read
+00009980: 5f66 696c 655f 6261 7365 280a 2020 2020  _file_base(.    
+00009990: 7061 7468 3a20 556e 696f 6e5b 7374 722c  path: Union[str,
+000099a0: 2022 6f73 2e50 6174 684c 696b 655b 416e   "os.PathLike[An
+000099b0: 795d 225d 2c0a 2020 2020 6c61 7965 723a  y]"],.    layer:
+000099c0: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
+000099d0: 204e 6f6e 652c 0a20 2020 2063 6f6c 756d   None,.    colum
+000099e0: 6e73 3a20 4f70 7469 6f6e 616c 5b49 7465  ns: Optional[Ite
+000099f0: 7261 626c 655b 7374 725d 5d20 3d20 4e6f  rable[str]] = No
+00009a00: 6e65 2c0a 2020 2020 6262 6f78 3d4e 6f6e  ne,.    bbox=Non
+00009a10: 652c 0a20 2020 2072 6f77 733d 4e6f 6e65  e,.    rows=None
+00009a20: 2c0a 2020 2020 7768 6572 653a 204f 7074  ,.    where: Opt
+00009a30: 696f 6e61 6c5b 7374 725d 203d 204e 6f6e  ional[str] = Non
+00009a40: 652c 0a20 2020 2073 716c 5f73 746d 743a  e,.    sql_stmt:
+00009a50: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
+00009a60: 204e 6f6e 652c 0a20 2020 2073 716c 5f64   None,.    sql_d
+00009a70: 6961 6c65 6374 3a20 4f70 7469 6f6e 616c  ialect: Optional
+00009a80: 5b4c 6974 6572 616c 5b22 5351 4c49 5445  [Literal["SQLITE
+00009a90: 222c 2022 4f47 5253 514c 225d 5d20 3d20  ", "OGRSQL"]] = 
+00009aa0: 4e6f 6e65 2c0a 2020 2020 6967 6e6f 7265  None,.    ignore
+00009ab0: 5f67 656f 6d65 7472 793a 2062 6f6f 6c20  _geometry: bool 
+00009ac0: 3d20 4661 6c73 652c 0a20 2020 2066 6964  = False,.    fid
+00009ad0: 5f61 735f 696e 6465 783a 2062 6f6f 6c20  _as_index: bool 
+00009ae0: 3d20 4661 6c73 652c 0a20 2020 202a 2a6b  = False,.    **k
+00009af0: 7761 7267 732c 0a29 202d 3e20 556e 696f  wargs,.) -> Unio
+00009b00: 6e5b 7064 2e44 6174 6146 7261 6d65 2c20  n[pd.DataFrame, 
+00009b10: 6770 642e 4765 6f44 6174 6146 7261 6d65  gpd.GeoDataFrame
+00009b20: 5d3a 0a20 2020 2022 2222 0a20 2020 2052  ]:.    """.    R
+00009b30: 6561 6473 2061 2066 696c 6520 746f 2061  eads a file to a
+00009b40: 2070 616e 6461 7320 4461 7461 6672 616d   pandas Datafram
+00009b50: 652e 0a20 2020 2022 2222 0a20 2020 2023  e..    """.    #
+00009b60: 2043 6865 636b 2069 6620 7468 6520 6669   Check if the fi
+00009b70: 6420 636f 6c75 6d6e 206e 6565 6473 2074  d column needs t
+00009b80: 6f20 6265 2072 6561 6420 6173 2063 6f6c  o be read as col
+00009b90: 756d 6e20 7669 6120 7468 6520 636f 6c75  umn via the colu
+00009ba0: 6d6e 7320 7061 7261 6d65 7465 720a 2020  mns parameter.  
+00009bb0: 2020 6669 645f 6173 5f63 6f6c 756d 6e20    fid_as_column 
+00009bc0: 3d20 4661 6c73 650a 2020 2020 6966 2063  = False.    if c
+00009bd0: 6f6c 756d 6e73 2069 7320 6e6f 7420 4e6f  olumns is not No
+00009be0: 6e65 3a0a 2020 2020 2020 2020 6966 2022  ne:.        if "
+00009bf0: 6669 6422 2069 6e20 5b63 6f6c 756d 6e2e  fid" in [column.
+00009c00: 6c6f 7765 7228 2920 666f 7220 636f 6c75  lower() for colu
+00009c10: 6d6e 2069 6e20 636f 6c75 6d6e 735d 3a0a  mn in columns]:.
+00009c20: 2020 2020 2020 2020 2020 2020 6669 645f              fid_
+00009c30: 6173 5f63 6f6c 756d 6e20 3d20 5472 7565  as_column = True
+00009c40: 0a0a 2020 2020 2320 5265 6164 2077 6974  ..    # Read wit
+00009c50: 6820 7468 6520 656e 6769 6e65 2073 7065  h the engine spe
+00009c60: 6369 6669 6564 0a20 2020 2065 6e67 696e  cified.    engin
+00009c70: 6520 3d20 436f 6e66 6967 4f70 7469 6f6e  e = ConfigOption
+00009c80: 732e 696f 5f65 6e67 696e 650a 2020 2020  s.io_engine.    
+00009c90: 6966 2065 6e67 696e 6520 3d3d 2022 7079  if engine == "py
+00009ca0: 6f67 7269 6f22 3a0a 2020 2020 2020 2020  ogrio":.        
+00009cb0: 6764 6620 3d20 5f72 6561 645f 6669 6c65  gdf = _read_file
+00009cc0: 5f62 6173 655f 7079 6f67 7269 6f28 0a20  _base_pyogrio(. 
+00009cd0: 2020 2020 2020 2020 2020 2070 6174 683d             path=
+00009ce0: 7061 7468 2c0a 2020 2020 2020 2020 2020  path,.          
+00009cf0: 2020 6c61 7965 723d 6c61 7965 722c 0a20    layer=layer,. 
+00009d00: 2020 2020 2020 2020 2020 2063 6f6c 756d             colum
+00009d10: 6e73 3d63 6f6c 756d 6e73 2c0a 2020 2020  ns=columns,.    
+00009d20: 2020 2020 2020 2020 6262 6f78 3d62 626f          bbox=bbo
+00009d30: 782c 0a20 2020 2020 2020 2020 2020 2072  x,.            r
+00009d40: 6f77 733d 726f 7773 2c0a 2020 2020 2020  ows=rows,.      
+00009d50: 2020 2020 2020 7768 6572 653d 7768 6572        where=wher
+00009d60: 652c 0a20 2020 2020 2020 2020 2020 2073  e,.            s
+00009d70: 716c 5f73 746d 743d 7371 6c5f 7374 6d74  ql_stmt=sql_stmt
+00009d80: 2c0a 2020 2020 2020 2020 2020 2020 7371  ,.            sq
+00009d90: 6c5f 6469 616c 6563 743d 7371 6c5f 6469  l_dialect=sql_di
+00009da0: 616c 6563 742c 0a20 2020 2020 2020 2020  alect,.         
+00009db0: 2020 2069 676e 6f72 655f 6765 6f6d 6574     ignore_geomet
+00009dc0: 7279 3d69 676e 6f72 655f 6765 6f6d 6574  ry=ignore_geomet
+00009dd0: 7279 2c0a 2020 2020 2020 2020 2020 2020  ry,.            
+00009de0: 6669 645f 6173 5f69 6e64 6578 3d66 6964  fid_as_index=fid
+00009df0: 5f61 735f 696e 6465 7820 6f72 2066 6964  _as_index or fid
+00009e00: 5f61 735f 636f 6c75 6d6e 2c0a 2020 2020  _as_column,.    
+00009e10: 2020 2020 2020 2020 2a2a 6b77 6172 6773          **kwargs
+00009e20: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
+00009e30: 656c 6966 2065 6e67 696e 6520 3d3d 2022  elif engine == "
+00009e40: 6669 6f6e 6122 3a0a 2020 2020 2020 2020  fiona":.        
+00009e50: 6764 6620 3d20 5f72 6561 645f 6669 6c65  gdf = _read_file
+00009e60: 5f62 6173 655f 6669 6f6e 6128 0a20 2020  _base_fiona(.   
+00009e70: 2020 2020 2020 2020 2070 6174 683d 7061           path=pa
+00009e80: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
+00009e90: 6c61 7965 723d 6c61 7965 722c 0a20 2020  layer=layer,.   
+00009ea0: 2020 2020 2020 2020 2063 6f6c 756d 6e73           columns
+00009eb0: 3d63 6f6c 756d 6e73 2c0a 2020 2020 2020  =columns,.      
+00009ec0: 2020 2020 2020 6262 6f78 3d62 626f 782c        bbox=bbox,
+00009ed0: 0a20 2020 2020 2020 2020 2020 2072 6f77  .            row
+00009ee0: 733d 726f 7773 2c0a 2020 2020 2020 2020  s=rows,.        
+00009ef0: 2020 2020 7768 6572 653d 7768 6572 652c      where=where,
+00009f00: 0a20 2020 2020 2020 2020 2020 2073 716c  .            sql
+00009f10: 5f73 746d 743d 7371 6c5f 7374 6d74 2c0a  _stmt=sql_stmt,.
+00009f20: 2020 2020 2020 2020 2020 2020 7371 6c5f              sql_
+00009f30: 6469 616c 6563 743d 7371 6c5f 6469 616c  dialect=sql_dial
+00009f40: 6563 742c 0a20 2020 2020 2020 2020 2020  ect,.           
+00009f50: 2069 676e 6f72 655f 6765 6f6d 6574 7279   ignore_geometry
+00009f60: 3d69 676e 6f72 655f 6765 6f6d 6574 7279  =ignore_geometry
+00009f70: 2c0a 2020 2020 2020 2020 2020 2020 6669  ,.            fi
+00009f80: 645f 6173 5f69 6e64 6578 3d66 6964 5f61  d_as_index=fid_a
+00009f90: 735f 696e 6465 7820 6f72 2066 6964 5f61  s_index or fid_a
+00009fa0: 735f 636f 6c75 6d6e 2c0a 2020 2020 2020  s_column,.      
+00009fb0: 2020 2020 2020 2a2a 6b77 6172 6773 2c0a        **kwargs,.
+00009fc0: 2020 2020 2020 2020 290a 2020 2020 656c          ).    el
+00009fd0: 7365 3a0a 2020 2020 2020 2020 7261 6973  se:.        rais
+00009fe0: 6520 5661 6c75 6545 7272 6f72 2866 2255  e ValueError(f"U
+00009ff0: 6e73 7570 706f 7274 6564 2065 6e67 696e  nsupported engin
+0000a000: 653a 207b 656e 6769 6e65 7d22 290a 0a20  e: {engine}").. 
+0000a010: 2020 2023 2043 6f70 7920 7468 6520 696e     # Copy the in
+0000a020: 6465 7820 746f 2061 2063 6f6c 756d 6e20  dex to a column 
+0000a030: 6966 206e 6565 6465 642e 2e2e 0a20 2020  if needed....   
+0000a040: 2069 6620 6669 645f 6173 5f63 6f6c 756d   if fid_as_colum
+0000a050: 6e3a 0a20 2020 2020 2020 2067 6466 5b22  n:.        gdf["
+0000a060: 6669 6422 5d20 3d20 6764 662e 696e 6465  fid"] = gdf.inde
+0000a070: 780a 2020 2020 2020 2020 6966 206e 6f74  x.        if not
+0000a080: 2066 6964 5f61 735f 696e 6465 783a 0a20   fid_as_index:. 
+0000a090: 2020 2020 2020 2020 2020 2067 6466 203d             gdf =
+0000a0a0: 2067 6466 2e72 6573 6574 5f69 6e64 6578   gdf.reset_index
+0000a0b0: 2864 726f 703d 5472 7565 290a 0a20 2020  (drop=True)..   
+0000a0c0: 2072 6574 7572 6e20 6764 660a 0a0a 6465   return gdf...de
+0000a0d0: 6620 5f72 6561 645f 6669 6c65 5f62 6173  f _read_file_bas
+0000a0e0: 655f 6669 6f6e 6128 0a20 2020 2070 6174  e_fiona(.    pat
+0000a0f0: 683a 2055 6e69 6f6e 5b73 7472 2c20 226f  h: Union[str, "o
+0000a100: 732e 5061 7468 4c69 6b65 5b41 6e79 5d22  s.PathLike[Any]"
+0000a110: 5d2c 0a20 2020 206c 6179 6572 3a20 4f70  ],.    layer: Op
+0000a120: 7469 6f6e 616c 5b73 7472 5d20 3d20 4e6f  tional[str] = No
+0000a130: 6e65 2c0a 2020 2020 636f 6c75 6d6e 733a  ne,.    columns:
+0000a140: 204f 7074 696f 6e61 6c5b 4974 6572 6162   Optional[Iterab
+0000a150: 6c65 5b73 7472 5d5d 203d 204e 6f6e 652c  le[str]] = None,
+0000a160: 0a20 2020 2062 626f 783d 4e6f 6e65 2c0a  .    bbox=None,.
+0000a170: 2020 2020 726f 7773 3d4e 6f6e 652c 0a20      rows=None,. 
+0000a180: 2020 2077 6865 7265 3a20 4f70 7469 6f6e     where: Option
+0000a190: 616c 5b73 7472 5d20 3d20 4e6f 6e65 2c0a  al[str] = None,.
+0000a1a0: 2020 2020 7371 6c5f 7374 6d74 3a20 4f70      sql_stmt: Op
+0000a1b0: 7469 6f6e 616c 5b73 7472 5d20 3d20 4e6f  tional[str] = No
+0000a1c0: 6e65 2c0a 2020 2020 7371 6c5f 6469 616c  ne,.    sql_dial
+0000a1d0: 6563 743a 204f 7074 696f 6e61 6c5b 4c69  ect: Optional[Li
+0000a1e0: 7465 7261 6c5b 2253 514c 4954 4522 2c20  teral["SQLITE", 
+0000a1f0: 224f 4752 5351 4c22 5d5d 203d 204e 6f6e  "OGRSQL"]] = Non
+0000a200: 652c 0a20 2020 2069 676e 6f72 655f 6765  e,.    ignore_ge
+0000a210: 6f6d 6574 7279 3a20 626f 6f6c 203d 2046  ometry: bool = F
+0000a220: 616c 7365 2c0a 2020 2020 6669 645f 6173  alse,.    fid_as
+0000a230: 5f69 6e64 6578 3a20 626f 6f6c 203d 2046  _index: bool = F
+0000a240: 616c 7365 2c0a 2020 2020 2a2a 6b77 6172  alse,.    **kwar
+0000a250: 6773 2c0a 2920 2d3e 2055 6e69 6f6e 5b70  gs,.) -> Union[p
+0000a260: 642e 4461 7461 4672 616d 652c 2067 7064  d.DataFrame, gpd
+0000a270: 2e47 656f 4461 7461 4672 616d 655d 3a0a  .GeoDataFrame]:.
+0000a280: 2020 2020 2222 220a 2020 2020 5265 6164      """.    Read
+0000a290: 7320 6120 6669 6c65 2074 6f20 6120 7061  s a file to a pa
+0000a2a0: 6e64 6173 2044 6174 6166 7261 6d65 2075  ndas Dataframe u
+0000a2b0: 7369 6e67 2066 696f 6e61 2e0a 2020 2020  sing fiona..    
+0000a2c0: 2222 220a 2020 2020 6966 2069 676e 6f72  """.    if ignor
+0000a2d0: 655f 6765 6f6d 6574 7279 2061 6e64 2063  e_geometry and c
+0000a2e0: 6f6c 756d 6e73 203d 3d20 5b5d 3a0a 2020  olumns == []:.  
+0000a2f0: 2020 2020 2020 7265 7475 726e 2070 642e        return pd.
+0000a300: 4461 7461 4672 616d 6528 290a 2020 2020  DataFrame().    
+0000a310: 6966 2073 716c 5f73 746d 7420 6973 206e  if sql_stmt is n
+0000a320: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+0000a330: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+0000a340: 7228 2273 716c 5f73 746d 7420 6973 206e  r("sql_stmt is n
+0000a350: 6f74 2073 7570 706f 7274 6564 2077 6974  ot supported wit
+0000a360: 6820 6669 6f6e 6120 656e 6769 6e65 2229  h fiona engine")
+0000a370: 0a0a 2020 2020 2320 496e 6974 0a20 2020  ..    # Init.   
+0000a380: 2070 6174 6820 3d20 5061 7468 2870 6174   path = Path(pat
+0000a390: 6829 0a20 2020 2069 6620 7061 7468 2e65  h).    if path.e
+0000a3a0: 7869 7374 7328 2920 6973 2046 616c 7365  xists() is False
+0000a3b0: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
+0000a3c0: 5661 6c75 6545 7272 6f72 2866 2266 696c  ValueError(f"fil
+0000a3d0: 6520 646f 6573 6e27 7420 6578 6973 743a  e doesn't exist:
+0000a3e0: 207b 7061 7468 7d22 290a 0a20 2020 2023   {path}")..    #
+0000a3f0: 2049 6620 6e6f 206c 6179 6572 206e 616d   If no layer nam
+0000a400: 6520 7370 6563 6966 6965 642c 2063 6865  e specified, che
+0000a410: 636b 2069 6620 7468 6572 6520 6973 206f  ck if there is o
+0000a420: 6e6c 7920 6f6e 6520 6c61 7965 7220 696e  nly one layer in
+0000a430: 2074 6865 2066 696c 652e 0a20 2020 2069   the file..    i
+0000a440: 6620 6c61 7965 7220 6973 204e 6f6e 653a  f layer is None:
+0000a450: 0a20 2020 2020 2020 206c 6179 6572 203d  .        layer =
+0000a460: 2067 6574 5f6f 6e6c 795f 6c61 7965 7228   get_only_layer(
+0000a470: 7061 7468 290a 0a20 2020 2023 2056 4552  path)..    # VER
+0000a480: 5920 4449 5254 5920 6861 636b 2074 6f20  Y DIRTY hack to 
+0000a490: 6765 7420 7468 6520 6669 640a 2020 2020  get the fid.    
+0000a4a0: 6966 2066 6964 5f61 735f 696e 6465 783a  if fid_as_index:
+0000a4b0: 0a20 2020 2020 2020 2023 204d 616b 6520  .        # Make 
+0000a4c0: 6120 636f 7079 2f63 6f70 7920 696e 7075  a copy/copy inpu
+0000a4d0: 7420 6669 6c65 2074 6f20 6765 6f70 6163  t file to geopac
+0000a4e0: 6b61 6765 2c20 6173 2077 6520 7769 6c6c  kage, as we will
+0000a4f0: 2061 6464 2061 6e20 6669 642f 726f 7764   add an fid/rowd
+0000a500: 2063 6f6c 756d 6e0a 2020 2020 2020 2020   column.        
+0000a510: 746d 705f 6669 645f 7061 7468 203d 2050  tmp_fid_path = P
+0000a520: 6174 6828 7465 6d70 6669 6c65 2e6d 6b64  ath(tempfile.mkd
+0000a530: 7465 6d70 2829 2920 2f20 6622 7b70 6174  temp()) / f"{pat
+0000a540: 682e 7374 656d 7d2e 6770 6b67 220a 2020  h.stem}.gpkg".  
+0000a550: 2020 2020 2020 7061 7468 5f69 6e66 6f20        path_info 
+0000a560: 3d20 5f67 656f 6669 6c65 696e 666f 2e67  = _geofileinfo.g
+0000a570: 6574 5f67 656f 6669 6c65 696e 666f 2870  et_geofileinfo(p
+0000a580: 6174 6829 0a20 2020 2020 2020 2074 7279  ath).        try
+0000a590: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+0000a5a0: 2070 6174 685f 696e 666f 2e64 7269 7665   path_info.drive
+0000a5b0: 7220 3d3d 2022 4750 4b47 223a 0a20 2020  r == "GPKG":.   
+0000a5c0: 2020 2020 2020 2020 2020 2020 2063 6f70               cop
+0000a5d0: 7928 7061 7468 2c20 746d 705f 6669 645f  y(path, tmp_fid_
+0000a5e0: 7061 7468 290a 2020 2020 2020 2020 2020  path).          
+0000a5f0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0000a600: 2020 2020 2020 2020 636f 7079 5f6c 6179          copy_lay
+0000a610: 6572 2870 6174 682c 2074 6d70 5f66 6964  er(path, tmp_fid
+0000a620: 5f70 6174 6829 0a20 2020 2020 2020 2020  _path).         
+0000a630: 2020 2069 6620 7061 7468 5f69 6e66 6f2e     if path_info.
+0000a640: 6973 5f66 6964 5f7a 6572 6f62 6173 6564  is_fid_zerobased
+0000a650: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000a660: 2020 2320 6669 6420 696e 2073 6861 7065    # fid in shape
+0000a670: 6669 6c65 2069 7320 3020 6261 7365 642c  file is 0 based,
+0000a680: 2073 6f20 6669 642d 310a 2020 2020 2020   so fid-1.      
+0000a690: 2020 2020 2020 2020 2020 6164 645f 636f            add_co
+0000a6a0: 6c75 6d6e 2874 6d70 5f66 6964 5f70 6174  lumn(tmp_fid_pat
+0000a6b0: 682c 2022 5f5f 544d 505f 4745 4f46 494c  h, "__TMP_GEOFIL
+0000a6c0: 454f 5053 5f46 4944 222c 2022 494e 5445  EOPS_FID", "INTE
+0000a6d0: 4745 5222 2c20 2266 6964 2d31 2229 0a20  GER", "fid-1"). 
+0000a6e0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0000a6f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a700: 2061 6464 5f63 6f6c 756d 6e28 746d 705f   add_column(tmp_
+0000a710: 6669 645f 7061 7468 2c20 225f 5f54 4d50  fid_path, "__TMP
+0000a720: 5f47 454f 4649 4c45 4f50 535f 4649 4422  _GEOFILEOPS_FID"
+0000a730: 2c20 2249 4e54 4547 4552 222c 2022 6669  , "INTEGER", "fi
+0000a740: 6422 290a 0a20 2020 2020 2020 2020 2020  d")..           
+0000a750: 2070 6174 6820 3d20 746d 705f 6669 645f   path = tmp_fid_
+0000a760: 7061 7468 0a20 2020 2020 2020 2066 696e  path.        fin
+0000a770: 616c 6c79 3a0a 2020 2020 2020 2020 2020  ally:.          
+0000a780: 2020 6966 2043 6f6e 6669 674f 7074 696f    if ConfigOptio
+0000a790: 6e73 2e72 656d 6f76 655f 7465 6d70 5f66  ns.remove_temp_f
+0000a7a0: 696c 6573 2061 6e64 2074 6d70 5f66 6964  iles and tmp_fid
+0000a7b0: 5f70 6174 682e 7061 7265 6e74 2e65 7869  _path.parent.exi
+0000a7c0: 7374 7328 293a 0a20 2020 2020 2020 2020  sts():.         
+0000a7d0: 2020 2020 2020 2073 6875 7469 6c2e 726d         shutil.rm
+0000a7e0: 7472 6565 2874 6d70 5f66 6964 5f70 6174  tree(tmp_fid_pat
+0000a7f0: 682c 2069 676e 6f72 655f 6572 726f 7273  h, ignore_errors
+0000a800: 3d54 7275 6529 0a0a 2020 2020 2320 4368  =True)..    # Ch
+0000a810: 6563 6b69 6e67 2069 6620 6669 656c 642f  ecking if field/
+0000a820: 636f 6c75 6d6e 206e 616d 6573 2073 686f  column names sho
+0000a830: 756c 6420 6265 2072 6561 6420 6973 2063  uld be read is c
+0000a840: 6173 6520 7365 6e73 6974 6976 6520 696e  ase sensitive in
+0000a850: 2066 696f 6e61 2c20 736f 0a20 2020 2023   fiona, so.    #
+0000a860: 206d 616b 6520 7375 7265 2074 6865 2063   make sure the c
+0000a870: 6f6c 756d 6e20 6e61 6d65 7320 7370 6563  olumn names spec
+0000a880: 6966 6965 6420 6861 7665 2074 6865 2073  ified have the s
+0000a890: 616d 6520 6361 7369 6e67 2e0a 2020 2020  ame casing..    
+0000a8a0: 636f 6c75 6d6e 735f 7072 6570 6172 6564  columns_prepared
+0000a8b0: 203d 204e 6f6e 650a 2020 2020 6966 2063   = None.    if c
+0000a8c0: 6f6c 756d 6e73 2069 7320 6e6f 7420 4e6f  olumns is not No
+0000a8d0: 6e65 3a0a 2020 2020 2020 2020 6c61 7965  ne:.        laye
+0000a8e0: 7269 6e66 6f20 3d20 6765 745f 6c61 7965  rinfo = get_laye
+0000a8f0: 7269 6e66 6f28 7061 7468 2c20 6c61 7965  rinfo(path, laye
+0000a900: 723d 6c61 7965 722c 2072 6169 7365 5f6f  r=layer, raise_o
+0000a910: 6e5f 6e6f 6765 6f6d 3d46 616c 7365 290a  n_nogeom=False).
+0000a920: 2020 2020 2020 2020 636f 6c75 6d6e 735f          columns_
+0000a930: 7570 7065 725f 6c6f 6f6b 7570 203d 207b  upper_lookup = {
+0000a940: 636f 6c75 6d6e 2e75 7070 6572 2829 3a20  column.upper(): 
+0000a950: 636f 6c75 6d6e 2066 6f72 2063 6f6c 756d  column for colum
+0000a960: 6e20 696e 2063 6f6c 756d 6e73 7d0a 2020  n in columns}.  
+0000a970: 2020 2020 2020 636f 6c75 6d6e 735f 7072        columns_pr
+0000a980: 6570 6172 6564 203d 207b 0a20 2020 2020  epared = {.     
+0000a990: 2020 2020 2020 2063 6f6c 756d 6e3a 2063         column: c
+0000a9a0: 6f6c 756d 6e73 5f75 7070 6572 5f6c 6f6f  olumns_upper_loo
+0000a9b0: 6b75 705b 636f 6c75 6d6e 2e75 7070 6572  kup[column.upper
+0000a9c0: 2829 5d0a 2020 2020 2020 2020 2020 2020  ()].            
+0000a9d0: 666f 7220 636f 6c75 6d6e 2069 6e20 6c61  for column in la
+0000a9e0: 7965 7269 6e66 6f2e 636f 6c75 6d6e 730a  yerinfo.columns.
+0000a9f0: 2020 2020 2020 2020 2020 2020 6966 2063              if c
+0000aa00: 6f6c 756d 6e2e 7570 7065 7228 2920 696e  olumn.upper() in
+0000aa10: 2063 6f6c 756d 6e73 5f75 7070 6572 5f6c   columns_upper_l
+0000aa20: 6f6f 6b75 700a 2020 2020 2020 2020 7d0a  ookup.        }.
+0000aa30: 0a20 2020 2023 2052 6561 642e 2e2e 0a20  .    # Read.... 
+0000aa40: 2020 2063 6f6c 756d 6e73 5f6c 6973 7420     columns_list 
+0000aa50: 3d20 4e6f 6e65 2069 6620 636f 6c75 6d6e  = None if column
+0000aa60: 735f 7072 6570 6172 6564 2069 7320 4e6f  s_prepared is No
+0000aa70: 6e65 2065 6c73 6520 6c69 7374 2863 6f6c  ne else list(col
+0000aa80: 756d 6e73 5f70 7265 7061 7265 6429 0a20  umns_prepared). 
+0000aa90: 2020 2072 6573 756c 745f 6764 6620 3d20     result_gdf = 
+0000aaa0: 6770 642e 7265 6164 5f66 696c 6528 0a20  gpd.read_file(. 
+0000aab0: 2020 2020 2020 2073 7472 2870 6174 6829         str(path)
+0000aac0: 2c0a 2020 2020 2020 2020 6c61 7965 723d  ,.        layer=
+0000aad0: 6c61 7965 722c 0a20 2020 2020 2020 2062  layer,.        b
+0000aae0: 626f 783d 6262 6f78 2c0a 2020 2020 2020  box=bbox,.      
+0000aaf0: 2020 726f 7773 3d72 6f77 732c 0a20 2020    rows=rows,.   
+0000ab00: 2020 2020 2069 6e63 6c75 6465 5f66 6965       include_fie
+0000ab10: 6c64 733d 636f 6c75 6d6e 735f 6c69 7374  lds=columns_list
+0000ab20: 2c0a 2020 2020 2020 2020 7768 6572 653d  ,.        where=
+0000ab30: 7768 6572 652c 0a20 2020 2020 2020 2073  where,.        s
+0000ab40: 716c 3d73 716c 5f73 746d 742c 0a20 2020  ql=sql_stmt,.   
+0000ab50: 2020 2020 2073 716c 5f64 6961 6c65 6374       sql_dialect
+0000ab60: 3d73 716c 5f64 6961 6c65 6374 2c0a 2020  =sql_dialect,.  
+0000ab70: 2020 2020 2020 6967 6e6f 7265 5f67 656f        ignore_geo
+0000ab80: 6d65 7472 793d 6967 6e6f 7265 5f67 656f  metry=ignore_geo
+0000ab90: 6d65 7472 792c 0a20 2020 2020 2020 202a  metry,.        *
+0000aba0: 2a6b 7761 7267 732c 0a20 2020 2029 0a0a  *kwargs,.    )..
+0000abb0: 2020 2020 2320 5365 7420 7468 6520 696e      # Set the in
+0000abc0: 6465 7820 746f 2074 6865 2062 6163 6b65  dex to the backe
+0000abd0: 642d 7570 2066 6964 0a20 2020 2069 6620  d-up fid.    if 
+0000abe0: 6669 645f 6173 5f69 6e64 6578 3a0a 2020  fid_as_index:.  
+0000abf0: 2020 2020 2020 7265 7375 6c74 5f67 6466        result_gdf
+0000ac00: 203d 2072 6573 756c 745f 6764 662e 7365   = result_gdf.se
+0000ac10: 745f 696e 6465 7828 225f 5f54 4d50 5f47  t_index("__TMP_G
+0000ac20: 454f 4649 4c45 4f50 535f 4649 4422 290a  EOFILEOPS_FID").
+0000ac30: 2020 2020 2020 2020 7265 7375 6c74 5f67          result_g
+0000ac40: 6466 2e69 6e64 6578 2e6e 616d 6520 3d20  df.index.name = 
+0000ac50: 2266 6964 220a 0a20 2020 2023 2052 656f  "fid"..    # Reo
+0000ac60: 7264 6572 2063 6f6c 756d 6e73 202b 2063  rder columns + c
+0000ac70: 6861 6e67 6520 6361 7369 6e67 2073 6f20  hange casing so 
+0000ac80: 7468 6579 2061 7265 2074 6865 2073 616d  they are the sam
+0000ac90: 6520 6173 2063 6f6c 756d 6e73 2070 6172  e as columns par
+0000aca0: 616d 6574 6572 0a20 2020 2069 6620 636f  ameter.    if co
+0000acb0: 6c75 6d6e 735f 7072 6570 6172 6564 2069  lumns_prepared i
+0000acc0: 7320 6e6f 7420 4e6f 6e65 2061 6e64 206c  s not None and l
+0000acd0: 656e 2863 6f6c 756d 6e73 5f70 7265 7061  en(columns_prepa
+0000ace0: 7265 6429 203e 2030 3a0a 2020 2020 2020  red) > 0:.      
+0000acf0: 2020 636f 6c75 6d6e 735f 746f 5f6b 6565    columns_to_kee
+0000ad00: 7020 3d20 6c69 7374 2863 6f6c 756d 6e73  p = list(columns
+0000ad10: 5f70 7265 7061 7265 6429 0a20 2020 2020  _prepared).     
+0000ad20: 2020 2069 6620 2267 656f 6d65 7472 7922     if "geometry"
+0000ad30: 2069 6e20 7265 7375 6c74 5f67 6466 2e63   in result_gdf.c
+0000ad40: 6f6c 756d 6e73 3a0a 2020 2020 2020 2020  olumns:.        
+0000ad50: 2020 2020 636f 6c75 6d6e 735f 746f 5f6b      columns_to_k
+0000ad60: 6565 7020 2b3d 205b 2267 656f 6d65 7472  eep += ["geometr
+0000ad70: 7922 5d0a 2020 2020 2020 2020 7265 7375  y"].        resu
+0000ad80: 6c74 5f67 6466 203d 2072 6573 756c 745f  lt_gdf = result_
+0000ad90: 6764 665b 636f 6c75 6d6e 735f 746f 5f6b  gdf[columns_to_k
+0000ada0: 6565 705d 0a20 2020 2020 2020 2072 6573  eep].        res
+0000adb0: 756c 745f 6764 6620 3d20 7265 7375 6c74  ult_gdf = result
+0000adc0: 5f67 6466 2e72 656e 616d 6528 636f 6c75  _gdf.rename(colu
+0000add0: 6d6e 733d 636f 6c75 6d6e 735f 7072 6570  mns=columns_prep
+0000ade0: 6172 6564 290a 0a20 2020 2023 2053 7461  ared)..    # Sta
+0000adf0: 7274 696e 6720 6672 6f6d 2066 696f 6e61  rting from fiona
+0000ae00: 2031 2e39 2c20 7374 7269 6e67 2063 6f6c   1.9, string col
+0000ae10: 756d 6e73 2077 6974 6820 616c 6c20 4e6f  umns with all No
+0000ae20: 6e65 2076 616c 7565 7320 6172 6520 7265  ne values are re
+0000ae30: 6164 2061 7320 6265 696e 670a 2020 2020  ad as being.    
+0000ae40: 2320 666c 6f61 7420 636f 6c75 6d6e 732e  # float columns.
+0000ae50: 2043 6f6e 7665 7274 2074 6865 6d20 746f   Convert them to
+0000ae60: 206f 626a 6563 7420 7479 7065 2e0a 2020   object type..  
+0000ae70: 2020 666c 6f61 745f 636f 6c73 203d 206c    float_cols = l
+0000ae80: 6973 7428 7265 7375 6c74 5f67 6466 2e73  ist(result_gdf.s
+0000ae90: 656c 6563 745f 6474 7970 6573 285b 2266  elect_dtypes(["f
+0000aea0: 6c6f 6174 3634 225d 292e 636f 6c75 6d6e  loat64"]).column
+0000aeb0: 7329 0a20 2020 2069 6620 6c65 6e28 666c  s).    if len(fl
+0000aec0: 6f61 745f 636f 6c73 2920 3e20 303a 0a20  oat_cols) > 0:. 
+0000aed0: 2020 2020 2020 2023 2043 6865 636b 2066         # Check f
+0000aee0: 6f72 2061 6c6c 2066 6c6f 6174 2063 6f6c  or all float col
+0000aef0: 756d 6e73 2066 6f75 6e64 2069 6620 7468  umns found if th
+0000af00: 6579 2073 686f 756c 6420 6265 206f 626a  ey should be obj
+0000af10: 6563 7420 636f 6c75 6d6e 7320 696e 7374  ect columns inst
+0000af20: 6561 640a 2020 2020 2020 2020 696d 706f  ead.        impo
+0000af30: 7274 2066 696f 6e61 0a0a 2020 2020 2020  rt fiona..      
+0000af40: 2020 7769 7468 2066 696f 6e61 2e6f 7065    with fiona.ope
+0000af50: 6e28 7061 7468 2c20 6c61 7965 723d 6c61  n(path, layer=la
+0000af60: 7965 7229 2061 7320 636f 6c6c 6563 7469  yer) as collecti
+0000af70: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
+0000af80: 6173 7365 7274 2063 6f6c 6c65 6374 696f  assert collectio
+0000af90: 6e2e 7363 6865 6d61 2069 7320 6e6f 7420  n.schema is not 
+0000afa0: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+0000afb0: 2070 726f 7065 7274 6965 7320 3d20 636f   properties = co
+0000afc0: 6c6c 6563 7469 6f6e 2e73 6368 656d 615b  llection.schema[
+0000afd0: 2270 726f 7065 7274 6965 7322 5d0a 2020  "properties"].  
+0000afe0: 2020 2020 2020 2020 2020 666f 7220 636f            for co
+0000aff0: 6c20 696e 2066 6c6f 6174 5f63 6f6c 733a  l in float_cols:
+0000b000: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b010: 2069 6620 636f 6c20 696e 2070 726f 7065   if col in prope
+0000b020: 7274 6965 7320 616e 6420 7072 6f70 6572  rties and proper
+0000b030: 7469 6573 5b63 6f6c 5d2e 7374 6172 7473  ties[col].starts
+0000b040: 7769 7468 2822 7374 7222 293a 0a20 2020  with("str"):.   
+0000b050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b060: 2072 6573 756c 745f 6764 665b 636f 6c5d   result_gdf[col]
+0000b070: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
+0000b080: 2020 2020 2020 2020 2020 2020 2072 6573               res
+0000b090: 756c 745f 6764 665b 636f 6c5d 2e61 7374  ult_gdf[col].ast
+0000b0a0: 7970 6528 6f62 6a65 6374 292e 7265 706c  ype(object).repl
+0000b0b0: 6163 6528 6e70 2e6e 616e 2c20 4e6f 6e65  ace(np.nan, None
+0000b0c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000b0d0: 2020 2020 2020 290a 0a20 2020 2072 6574        )..    ret
+0000b0e0: 7572 6e20 7265 7375 6c74 5f67 6466 0a0a  urn result_gdf..
+0000b0f0: 0a64 6566 205f 7265 6164 5f66 696c 655f  .def _read_file_
+0000b100: 6261 7365 5f70 796f 6772 696f 280a 2020  base_pyogrio(.  
+0000b110: 2020 7061 7468 3a20 556e 696f 6e5b 7374    path: Union[st
+0000b120: 722c 2022 6f73 2e50 6174 684c 696b 655b  r, "os.PathLike[
+0000b130: 416e 795d 225d 2c0a 2020 2020 6c61 7965  Any]"],.    laye
+0000b140: 723a 204f 7074 696f 6e61 6c5b 7374 725d  r: Optional[str]
+0000b150: 203d 204e 6f6e 652c 0a20 2020 2063 6f6c   = None,.    col
+0000b160: 756d 6e73 3a20 4f70 7469 6f6e 616c 5b49  umns: Optional[I
+0000b170: 7465 7261 626c 655b 7374 725d 5d20 3d20  terable[str]] = 
+0000b180: 4e6f 6e65 2c0a 2020 2020 6262 6f78 3d4e  None,.    bbox=N
+0000b190: 6f6e 652c 0a20 2020 2072 6f77 733d 4e6f  one,.    rows=No
+0000b1a0: 6e65 2c0a 2020 2020 7768 6572 653a 204f  ne,.    where: O
+0000b1b0: 7074 696f 6e61 6c5b 7374 725d 203d 204e  ptional[str] = N
+0000b1c0: 6f6e 652c 0a20 2020 2073 716c 5f73 746d  one,.    sql_stm
+0000b1d0: 743a 204f 7074 696f 6e61 6c5b 7374 725d  t: Optional[str]
+0000b1e0: 203d 204e 6f6e 652c 0a20 2020 2073 716c   = None,.    sql
+0000b1f0: 5f64 6961 6c65 6374 3a20 4f70 7469 6f6e  _dialect: Option
+0000b200: 616c 5b4c 6974 6572 616c 5b22 5351 4c49  al[Literal["SQLI
+0000b210: 5445 222c 2022 4f47 5253 514c 225d 5d20  TE", "OGRSQL"]] 
+0000b220: 3d20 4e6f 6e65 2c0a 2020 2020 6967 6e6f  = None,.    igno
+0000b230: 7265 5f67 656f 6d65 7472 793a 2062 6f6f  re_geometry: boo
+0000b240: 6c20 3d20 4661 6c73 652c 0a20 2020 2066  l = False,.    f
+0000b250: 6964 5f61 735f 696e 6465 783a 2062 6f6f  id_as_index: boo
+0000b260: 6c20 3d20 4661 6c73 652c 0a20 2020 202a  l = False,.    *
+0000b270: 2a6b 7761 7267 732c 0a29 202d 3e20 556e  *kwargs,.) -> Un
+0000b280: 696f 6e5b 7064 2e44 6174 6146 7261 6d65  ion[pd.DataFrame
+0000b290: 2c20 6770 642e 4765 6f44 6174 6146 7261  , gpd.GeoDataFra
+0000b2a0: 6d65 5d3a 0a20 2020 2022 2222 0a20 2020  me]:.    """.   
+0000b2b0: 2052 6561 6473 2061 2066 696c 6520 746f   Reads a file to
+0000b2c0: 2061 2070 616e 6461 7320 4461 7461 6672   a pandas Datafr
+0000b2d0: 616d 6520 7573 696e 6720 7079 6f67 7269  ame using pyogri
+0000b2e0: 6f2e 0a20 2020 2022 2222 0a20 2020 2023  o..    """.    #
+0000b2f0: 2049 6e69 740a 2020 2020 7061 7468 203d   Init.    path =
+0000b300: 2050 6174 6828 7061 7468 290a 2020 2020   Path(path).    
+0000b310: 6966 2070 6174 682e 6578 6973 7473 2829  if path.exists()
+0000b320: 2069 7320 4661 6c73 653a 0a20 2020 2020   is False:.     
+0000b330: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+0000b340: 726f 7228 6622 6669 6c65 2064 6f65 736e  ror(f"file doesn
+0000b350: 2774 2065 7869 7374 3a20 7b70 6174 687d  't exist: {path}
+0000b360: 2229 0a0a 2020 2020 2320 436f 6e76 6572  ")..    # Conver
+0000b370: 7420 726f 7773 2073 6c69 6365 206f 626a  t rows slice obj
+0000b380: 6563 7420 746f 2070 796f 6772 696f 2070  ect to pyogrio p
+0000b390: 6172 616d 6574 6572 730a 2020 2020 6966  arameters.    if
+0000b3a0: 2072 6f77 7320 6973 206e 6f74 204e 6f6e   rows is not Non
+0000b3b0: 653a 0a20 2020 2020 2020 2073 6b69 705f  e:.        skip_
+0000b3c0: 6665 6174 7572 6573 203d 2072 6f77 732e  features = rows.
+0000b3d0: 7374 6172 740a 2020 2020 2020 2020 6d61  start.        ma
+0000b3e0: 785f 6665 6174 7572 6573 203d 2072 6f77  x_features = row
+0000b3f0: 732e 7374 6f70 202d 2072 6f77 732e 7374  s.stop - rows.st
+0000b400: 6172 740a 2020 2020 656c 7365 3a0a 2020  art.    else:.  
+0000b410: 2020 2020 2020 736b 6970 5f66 6561 7475        skip_featu
+0000b420: 7265 7320 3d20 300a 2020 2020 2020 2020  res = 0.        
+0000b430: 6d61 785f 6665 6174 7572 6573 203d 204e  max_features = N
+0000b440: 6f6e 650a 2020 2020 2320 4172 726f 7720  one.    # Arrow 
+0000b450: 646f 6573 6e27 7420 7375 7070 6f72 7420  doesn't support 
+0000b460: 6669 6c74 6572 696e 6720 726f 7773 206c  filtering rows l
+0000b470: 696b 6520 7468 6973 0a20 2020 2023 2075  ike this.    # u
+0000b480: 7365 5f61 7272 6f77 203d 2054 7275 6520  se_arrow = True 
+0000b490: 6966 2072 6f77 7320 6973 204e 6f6e 6520  if rows is None 
+0000b4a0: 656c 7365 2046 616c 7365 0a0a 2020 2020  else False..    
+0000b4b0: 2320 4966 206e 6f20 7371 6c5f 7374 6d74  # If no sql_stmt
+0000b4c0: 2073 7065 6369 6669 6564 0a20 2020 2063   specified.    c
+0000b4d0: 6f6c 756d 6e73 5f70 7265 7061 7265 6420  olumns_prepared 
+0000b4e0: 3d20 4e6f 6e65 0a20 2020 2069 6620 7371  = None.    if sq
+0000b4f0: 6c5f 7374 6d74 2069 7320 4e6f 6e65 3a0a  l_stmt is None:.
+0000b500: 2020 2020 2020 2020 2320 4966 206e 6f20          # If no 
+0000b510: 6c61 7965 7220 7370 6563 6966 6965 642c  layer specified,
+0000b520: 2074 6865 7265 2073 686f 756c 6420 6265   there should be
+0000b530: 206f 6e6c 7920 6f6e 6520 6c61 7965 7220   only one layer 
+0000b540: 696e 2074 6865 2066 696c 652e 0a20 2020  in the file..   
+0000b550: 2020 2020 2069 6620 6c61 7965 7220 6973       if layer is
+0000b560: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0000b570: 2020 206c 6179 6572 203d 2067 6574 5f6f     layer = get_o
+0000b580: 6e6c 795f 6c61 7965 7228 7061 7468 290a  nly_layer(path).
+0000b590: 0a20 2020 2020 2020 2023 2043 6865 636b  .        # Check
+0000b5a0: 696e 6720 6966 2063 6f6c 756d 6e20 6e61  ing if column na
+0000b5b0: 6d65 7320 7368 6f75 6c64 2062 6520 7265  mes should be re
+0000b5c0: 6164 2069 7320 6361 7365 2073 656e 7369  ad is case sensi
+0000b5d0: 7469 7665 2069 6e20 7079 6f67 7269 6f2c  tive in pyogrio,
+0000b5e0: 2073 6f0a 2020 2020 2020 2020 2320 6d61   so.        # ma
+0000b5f0: 6b65 2073 7572 6520 7468 6520 636f 6c75  ke sure the colu
+0000b600: 6d6e 206e 616d 6573 2073 7065 6369 6669  mn names specifi
+0000b610: 6564 2068 6176 6520 7468 6520 7361 6d65  ed have the same
+0000b620: 2063 6173 696e 672e 0a20 2020 2020 2020   casing..       
+0000b630: 2069 6620 636f 6c75 6d6e 7320 6973 206e   if columns is n
+0000b640: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+0000b650: 2020 2020 206c 6179 6572 696e 666f 203d       layerinfo =
+0000b660: 2067 6574 5f6c 6179 6572 696e 666f 2870   get_layerinfo(p
+0000b670: 6174 682c 206c 6179 6572 3d6c 6179 6572  ath, layer=layer
+0000b680: 2c20 7261 6973 655f 6f6e 5f6e 6f67 656f  , raise_on_nogeo
+0000b690: 6d3d 4661 6c73 6529 0a20 2020 2020 2020  m=False).       
+0000b6a0: 2020 2020 2063 6f6c 756d 6e73 5f75 7070       columns_upp
+0000b6b0: 6572 5f6c 6f6f 6b75 7020 3d20 7b63 6f6c  er_lookup = {col
+0000b6c0: 756d 6e2e 7570 7065 7228 293a 2063 6f6c  umn.upper(): col
+0000b6d0: 756d 6e20 666f 7220 636f 6c75 6d6e 2069  umn for column i
+0000b6e0: 6e20 636f 6c75 6d6e 737d 0a20 2020 2020  n columns}.     
+0000b6f0: 2020 2020 2020 2063 6f6c 756d 6e73 5f70         columns_p
+0000b700: 7265 7061 7265 6420 3d20 7b0a 2020 2020  repared = {.    
+0000b710: 2020 2020 2020 2020 2020 2020 636f 6c75              colu
+0000b720: 6d6e 3a20 636f 6c75 6d6e 735f 7570 7065  mn: columns_uppe
+0000b730: 725f 6c6f 6f6b 7570 5b63 6f6c 756d 6e2e  r_lookup[column.
+0000b740: 7570 7065 7228 295d 0a20 2020 2020 2020  upper()].       
+0000b750: 2020 2020 2020 2020 2066 6f72 2063 6f6c           for col
+0000b760: 756d 6e20 696e 206c 6179 6572 696e 666f  umn in layerinfo
+0000b770: 2e63 6f6c 756d 6e73 0a20 2020 2020 2020  .columns.       
+0000b780: 2020 2020 2020 2020 2069 6620 636f 6c75           if colu
+0000b790: 6d6e 2e75 7070 6572 2829 2069 6e20 636f  mn.upper() in co
+0000b7a0: 6c75 6d6e 735f 7570 7065 725f 6c6f 6f6b  lumns_upper_look
+0000b7b0: 7570 0a20 2020 2020 2020 2020 2020 207d  up.            }
+0000b7c0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+0000b7d0: 2020 2023 2046 696c 6c20 6f75 7420 706c     # Fill out pl
+0000b7e0: 6163 6568 6f6c 6465 7273 2c20 6b65 6570  aceholders, keep
+0000b7f0: 2063 6f6c 756d 6e73 5f70 7265 7061 7265   columns_prepare
+0000b800: 6420 4e6f 6e65 2062 6563 6175 7365 2063  d None because c
+0000b810: 6f6c 756d 6e20 6669 6c74 6572 696e 670a  olumn filtering.
+0000b820: 2020 2020 2020 2020 2320 7368 6f75 6c64          # should
+0000b830: 2068 6170 7065 6e20 696e 2073 716c 5f73   happen in sql_s
+0000b840: 746d 742e 0a20 2020 2020 2020 2073 716c  tmt..        sql
+0000b850: 5f73 746d 7420 3d20 5f66 696c 6c5f 6f75  _stmt = _fill_ou
+0000b860: 745f 7371 6c5f 706c 6163 6568 6f6c 6465  t_sql_placeholde
+0000b870: 7273 280a 2020 2020 2020 2020 2020 2020  rs(.            
+0000b880: 7061 7468 3d70 6174 682c 206c 6179 6572  path=path, layer
+0000b890: 3d6c 6179 6572 2c20 7371 6c5f 7374 6d74  =layer, sql_stmt
+0000b8a0: 3d73 716c 5f73 746d 742c 2063 6f6c 756d  =sql_stmt, colum
+0000b8b0: 6e73 3d63 6f6c 756d 6e73 0a20 2020 2020  ns=columns.     
+0000b8c0: 2020 2029 0a20 2020 2020 2020 2023 2053     ).        # S
+0000b8d0: 7065 6369 6679 696e 6720 6120 6c61 7965  pecifying a laye
+0000b8e0: 7220 6173 2077 656c 6c20 6173 2061 6e20  r as well as an 
+0000b8f0: 5351 4c20 7374 6174 656d 656e 7420 696e  SQL statement in
+0000b900: 2070 796f 6772 696f 2069 7320 6e6f 7420   pyogrio is not 
+0000b910: 7375 7070 6f72 7465 642e 0a20 2020 2020  supported..     
+0000b920: 2020 206c 6179 6572 203d 204e 6f6e 650a     layer = None.
+0000b930: 0a20 2020 2023 2052 6561 6421 0a20 2020  .    # Read!.   
+0000b940: 2063 6f6c 756d 6e73 5f6c 6973 7420 3d20   columns_list = 
+0000b950: 4e6f 6e65 2069 6620 636f 6c75 6d6e 735f  None if columns_
+0000b960: 7072 6570 6172 6564 2069 7320 4e6f 6e65  prepared is None
+0000b970: 2065 6c73 6520 6c69 7374 2863 6f6c 756d   else list(colum
+0000b980: 6e73 5f70 7265 7061 7265 6429 0a20 2020  ns_prepared).   
+0000b990: 2072 6573 756c 745f 6764 6620 3d20 7079   result_gdf = py
+0000b9a0: 6f67 7269 6f2e 7265 6164 5f64 6174 6166  ogrio.read_dataf
+0000b9b0: 7261 6d65 280a 2020 2020 2020 2020 7061  rame(.        pa
+0000b9c0: 7468 2c0a 2020 2020 2020 2020 6c61 7965  th,.        laye
+0000b9d0: 723d 6c61 7965 722c 0a20 2020 2020 2020  r=layer,.       
+0000b9e0: 2063 6f6c 756d 6e73 3d63 6f6c 756d 6e73   columns=columns
+0000b9f0: 5f6c 6973 742c 0a20 2020 2020 2020 2062  _list,.        b
+0000ba00: 626f 783d 6262 6f78 2c0a 2020 2020 2020  box=bbox,.      
+0000ba10: 2020 736b 6970 5f66 6561 7475 7265 733d    skip_features=
+0000ba20: 736b 6970 5f66 6561 7475 7265 732c 0a20  skip_features,. 
+0000ba30: 2020 2020 2020 206d 6178 5f66 6561 7475         max_featu
+0000ba40: 7265 733d 6d61 785f 6665 6174 7572 6573  res=max_features
+0000ba50: 2c0a 2020 2020 2020 2020 7768 6572 653d  ,.        where=
+0000ba60: 7768 6572 652c 0a20 2020 2020 2020 2073  where,.        s
+0000ba70: 716c 3d73 716c 5f73 746d 742c 0a20 2020  ql=sql_stmt,.   
+0000ba80: 2020 2020 2073 716c 5f64 6961 6c65 6374       sql_dialect
+0000ba90: 3d73 716c 5f64 6961 6c65 6374 2c0a 2020  =sql_dialect,.  
+0000baa0: 2020 2020 2020 7265 6164 5f67 656f 6d65        read_geome
+0000bab0: 7472 793d 6e6f 7420 6967 6e6f 7265 5f67  try=not ignore_g
+0000bac0: 656f 6d65 7472 792c 0a20 2020 2020 2020  eometry,.       
+0000bad0: 2066 6964 5f61 735f 696e 6465 783d 6669   fid_as_index=fi
+0000bae0: 645f 6173 5f69 6e64 6578 2c0a 2020 2020  d_as_index,.    
+0000baf0: 2020 2020 2a2a 6b77 6172 6773 2c0a 2020      **kwargs,.  
+0000bb00: 2020 290a 0a20 2020 2023 2052 656f 7264    )..    # Reord
+0000bb10: 6572 2063 6f6c 756d 6e73 202b 2063 6861  er columns + cha
+0000bb20: 6e67 6520 6361 7369 6e67 2073 6f20 7468  nge casing so th
+0000bb30: 6579 2061 7265 2074 6865 2073 616d 6520  ey are the same 
+0000bb40: 6173 2063 6f6c 756d 6e73 2070 6172 616d  as columns param
+0000bb50: 6574 6572 0a20 2020 2069 6620 636f 6c75  eter.    if colu
+0000bb60: 6d6e 735f 7072 6570 6172 6564 2069 7320  mns_prepared is 
+0000bb70: 6e6f 7420 4e6f 6e65 2061 6e64 206c 656e  not None and len
+0000bb80: 2863 6f6c 756d 6e73 5f70 7265 7061 7265  (columns_prepare
+0000bb90: 6429 203e 2030 3a0a 2020 2020 2020 2020  d) > 0:.        
+0000bba0: 636f 6c75 6d6e 735f 746f 5f6b 6565 7020  columns_to_keep 
+0000bbb0: 3d20 6c69 7374 2863 6f6c 756d 6e73 5f70  = list(columns_p
+0000bbc0: 7265 7061 7265 6429 0a20 2020 2020 2020  repared).       
+0000bbd0: 2069 6620 6c61 7965 7269 6e66 6f2e 6765   if layerinfo.ge
+0000bbe0: 6f6d 6574 7279 636f 6c75 6d6e 2069 7320  ometrycolumn is 
+0000bbf0: 6e6f 7420 4e6f 6e65 2061 6e64 206e 6f74  not None and not
+0000bc00: 2069 676e 6f72 655f 6765 6f6d 6574 7279   ignore_geometry
+0000bc10: 3a0a 2020 2020 2020 2020 2020 2020 636f  :.            co
+0000bc20: 6c75 6d6e 735f 746f 5f6b 6565 7020 2b3d  lumns_to_keep +=
+0000bc30: 205b 2267 656f 6d65 7472 7922 5d0a 2020   ["geometry"].  
+0000bc40: 2020 2020 2020 7265 7375 6c74 5f67 6466        result_gdf
+0000bc50: 203d 2072 6573 756c 745f 6764 665b 636f   = result_gdf[co
+0000bc60: 6c75 6d6e 735f 746f 5f6b 6565 705d 0a20  lumns_to_keep]. 
+0000bc70: 2020 2020 2020 2072 6573 756c 745f 6764         result_gd
+0000bc80: 6620 3d20 7265 7375 6c74 5f67 6466 2e72  f = result_gdf.r
+0000bc90: 656e 616d 6528 636f 6c75 6d6e 733d 636f  ename(columns=co
+0000bca0: 6c75 6d6e 735f 7072 6570 6172 6564 290a  lumns_prepared).
+0000bcb0: 0a20 2020 2023 2043 6173 7420 636f 6c75  .    # Cast colu
+0000bcc0: 6d6e 7320 7468 6174 2061 7265 206f 6620  mns that are of 
+0000bcd0: 6f62 6a65 6374 2074 7970 652c 2062 7574  object type, but
+0000bce0: 2063 6f6e 7461 696e 2064 6174 6574 696d   contain datetim
+0000bcf0: 652e 6461 7465 206f 7220 6461 7465 7469  e.date or dateti
+0000bd00: 6d65 2e64 6174 650a 2020 2020 2320 746f  me.date.    # to
+0000bd10: 2070 726f 7065 7220 6461 7465 7469 6d65   proper datetime
+0000bd20: 3634 2063 6f6c 756d 6e73 2e0a 2020 2020  64 columns..    
+0000bd30: 6966 206c 656e 2872 6573 756c 745f 6764  if len(result_gd
+0000bd40: 6629 203e 2030 3a0a 2020 2020 2020 2020  f) > 0:.        
+0000bd50: 666f 7220 636f 6c75 6d6e 2069 6e20 7265  for column in re
+0000bd60: 7375 6c74 5f67 6466 2e73 656c 6563 745f  sult_gdf.select_
+0000bd70: 6474 7970 6573 2869 6e63 6c75 6465 3d5b  dtypes(include=[
+0000bd80: 226f 626a 6563 7422 5d29 3a0a 2020 2020  "object"]):.    
+0000bd90: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+0000bda0: 7461 6e63 6528 7265 7375 6c74 5f67 6466  tance(result_gdf
+0000bdb0: 5b63 6f6c 756d 6e5d 2e69 6c6f 635b 305d  [column].iloc[0]
+0000bdc0: 2c20 2864 6174 652c 2064 6174 6574 696d  , (date, datetim
+0000bdd0: 6529 293a 0a20 2020 2020 2020 2020 2020  e)):.           
+0000bde0: 2020 2020 2072 6573 756c 745f 6764 665b       result_gdf[
+0000bdf0: 636f 6c75 6d6e 5d20 3d20 7064 2e74 6f5f  column] = pd.to_
+0000be00: 6461 7465 7469 6d65 2872 6573 756c 745f  datetime(result_
+0000be10: 6764 665b 636f 6c75 6d6e 5d29 0a0a 2020  gdf[column])..  
+0000be20: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
+0000be30: 6e63 6528 7265 7375 6c74 5f67 6466 2c20  nce(result_gdf, 
+0000be40: 2867 7064 2e47 656f 4461 7461 4672 616d  (gpd.GeoDataFram
+0000be50: 652c 2070 642e 4461 7461 4672 616d 6529  e, pd.DataFrame)
+0000be60: 290a 2020 2020 7265 7475 726e 2072 6573  ).    return res
+0000be70: 756c 745f 6764 660a 0a0a 6465 6620 5f66  ult_gdf...def _f
+0000be80: 696c 6c5f 6f75 745f 7371 6c5f 706c 6163  ill_out_sql_plac
+0000be90: 6568 6f6c 6465 7273 280a 2020 2020 7061  eholders(.    pa
+0000bea0: 7468 3a20 5061 7468 2c20 6c61 7965 723a  th: Path, layer:
+0000beb0: 204f 7074 696f 6e61 6c5b 7374 725d 2c20   Optional[str], 
+0000bec0: 7371 6c5f 7374 6d74 3a20 7374 722c 2063  sql_stmt: str, c
+0000bed0: 6f6c 756d 6e73 3a20 4f70 7469 6f6e 616c  olumns: Optional
+0000bee0: 5b49 7465 7261 626c 655b 7374 725d 5d0a  [Iterable[str]].
+0000bef0: 2920 2d3e 2073 7472 3a0a 2020 2020 2320  ) -> str:.    # 
+0000bf00: 4669 6c6c 206f 7574 2070 6c61 6365 686f  Fill out placeho
+0000bf10: 6c64 6572 7320 696e 2074 6865 2073 716c  lders in the sql
+0000bf20: 5f73 746d 7420 6966 206e 6565 6465 643a  _stmt if needed:
+0000bf30: 0a20 2020 2070 6c61 6365 686f 6c64 6572  .    placeholder
+0000bf40: 7320 3d20 5b0a 2020 2020 2020 2020 6e61  s = [.        na
+0000bf50: 6d65 2066 6f72 205f 2c20 6e61 6d65 2c20  me for _, name, 
+0000bf60: 5f2c 205f 2069 6e20 7374 7269 6e67 2e46  _, _ in string.F
+0000bf70: 6f72 6d61 7474 6572 2829 2e70 6172 7365  ormatter().parse
+0000bf80: 2873 716c 5f73 746d 7429 2069 6620 6e61  (sql_stmt) if na
+0000bf90: 6d65 0a20 2020 205d 0a20 2020 206c 6179  me.    ].    lay
+0000bfa0: 6572 5f74 6d70 203d 206c 6179 6572 0a20  er_tmp = layer. 
+0000bfb0: 2020 206c 6179 6572 696e 666f 203d 204e     layerinfo = N
+0000bfc0: 6f6e 650a 2020 2020 666f 726d 6174 5f6b  one.    format_k
+0000bfd0: 7761 7267 733a 2064 6963 745b 7374 722c  wargs: dict[str,
+0000bfe0: 2041 6e79 5d20 3d20 7b7d 0a20 2020 2066   Any] = {}.    f
+0000bff0: 6f72 2070 6c61 6365 686f 6c64 6572 2069  or placeholder i
+0000c000: 6e20 706c 6163 6568 6f6c 6465 7273 3a0a  n placeholders:.
+0000c010: 2020 2020 2020 2020 6966 206c 6179 6572          if layer
+0000c020: 5f74 6d70 2069 7320 4e6f 6e65 3a0a 2020  _tmp is None:.  
+0000c030: 2020 2020 2020 2020 2020 6c61 7965 725f            layer_
+0000c040: 746d 7020 3d20 6765 745f 6f6e 6c79 5f6c  tmp = get_only_l
+0000c050: 6179 6572 2870 6174 6829 0a0a 2020 2020  ayer(path)..    
+0000c060: 2020 2020 6966 2070 6c61 6365 686f 6c64      if placehold
+0000c070: 6572 203d 3d20 2269 6e70 7574 5f6c 6179  er == "input_lay
+0000c080: 6572 223a 0a20 2020 2020 2020 2020 2020  er":.           
+0000c090: 2066 6f72 6d61 745f 6b77 6172 6773 5b70   format_kwargs[p
+0000c0a0: 6c61 6365 686f 6c64 6572 5d20 3d20 6c61  laceholder] = la
+0000c0b0: 7965 725f 746d 700a 2020 2020 2020 2020  yer_tmp.        
+0000c0c0: 656c 6966 2070 6c61 6365 686f 6c64 6572  elif placeholder
+0000c0d0: 203d 3d20 2267 656f 6d65 7472 7963 6f6c   == "geometrycol
+0000c0e0: 756d 6e22 3a0a 2020 2020 2020 2020 2020  umn":.          
+0000c0f0: 2020 6966 206c 6179 6572 696e 666f 2069    if layerinfo i
+0000c100: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0000c110: 2020 2020 2020 2020 6c61 7965 7269 6e66          layerinf
+0000c120: 6f20 3d20 6765 745f 6c61 7965 7269 6e66  o = get_layerinf
+0000c130: 6f28 7061 7468 2c20 6c61 7965 725f 746d  o(path, layer_tm
+0000c140: 7029 0a20 2020 2020 2020 2020 2020 2066  p).            f
+0000c150: 6f72 6d61 745f 6b77 6172 6773 5b70 6c61  ormat_kwargs[pla
+0000c160: 6365 686f 6c64 6572 5d20 3d20 6c61 7965  ceholder] = laye
+0000c170: 7269 6e66 6f2e 6765 6f6d 6574 7279 636f  rinfo.geometryco
+0000c180: 6c75 6d6e 0a20 2020 2020 2020 2065 6c69  lumn.        eli
+0000c190: 6620 706c 6163 6568 6f6c 6465 7220 3d3d  f placeholder ==
+0000c1a0: 2022 636f 6c75 6d6e 735f 746f 5f73 656c   "columns_to_sel
+0000c1b0: 6563 745f 7374 7222 3a0a 2020 2020 2020  ect_str":.      
+0000c1c0: 2020 2020 2020 6966 206c 6179 6572 696e        if layerin
+0000c1d0: 666f 2069 7320 4e6f 6e65 3a0a 2020 2020  fo is None:.    
+0000c1e0: 2020 2020 2020 2020 2020 2020 6c61 7965              laye
+0000c1f0: 7269 6e66 6f20 3d20 6765 745f 6c61 7965  rinfo = get_laye
+0000c200: 7269 6e66 6f28 7061 7468 2c20 6c61 7965  rinfo(path, laye
+0000c210: 725f 746d 7029 0a20 2020 2020 2020 2020  r_tmp).         
+0000c220: 2020 2063 6f6c 756d 6e73 5f61 736b 6564     columns_asked
+0000c230: 203d 204e 6f6e 6520 6966 2063 6f6c 756d   = None if colum
+0000c240: 6e73 2069 7320 4e6f 6e65 2065 6c73 6520  ns is None else 
+0000c250: 6c69 7374 2863 6f6c 756d 6e73 290a 2020  list(columns).  
+0000c260: 2020 2020 2020 2020 2020 666f 726d 6174            format
+0000c270: 7465 7220 3d20 5f6f 6772 5f73 716c 5f75  ter = _ogr_sql_u
+0000c280: 7469 6c2e 436f 6c75 6d6e 466f 726d 6174  til.ColumnFormat
+0000c290: 7465 7228 0a20 2020 2020 2020 2020 2020  ter(.           
+0000c2a0: 2020 2020 2063 6f6c 756d 6e73 5f61 736b       columns_ask
+0000c2b0: 6564 3d63 6f6c 756d 6e73 5f61 736b 6564  ed=columns_asked
+0000c2c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000c2d0: 2020 636f 6c75 6d6e 735f 696e 5f6c 6179    columns_in_lay
+0000c2e0: 6572 3d6c 6179 6572 696e 666f 2e63 6f6c  er=layerinfo.col
+0000c2f0: 756d 6e73 2c0a 2020 2020 2020 2020 2020  umns,.          
+0000c300: 2020 2020 2020 6669 645f 636f 6c75 6d6e        fid_column
+0000c310: 3d6c 6179 6572 696e 666f 2e66 6964 5f63  =layerinfo.fid_c
+0000c320: 6f6c 756d 6e2c 0a20 2020 2020 2020 2020  olumn,.         
+0000c330: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0000c340: 2066 6f72 6d61 745f 6b77 6172 6773 5b70   format_kwargs[p
+0000c350: 6c61 6365 686f 6c64 6572 5d20 3d20 666f  laceholder] = fo
+0000c360: 726d 6174 7465 722e 7072 6566 6978 6564  rmatter.prefixed
+0000c370: 5f61 6c69 6173 6564 2829 0a0a 2020 2020  _aliased()..    
+0000c380: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0000c390: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
+0000c3a0: 6545 7272 6f72 280a 2020 2020 2020 2020  eError(.        
+0000c3b0: 2020 2020 2020 2020 6622 756e 6b6e 6f77          f"unknow
+0000c3c0: 6e20 706c 6163 6568 6f6c 6465 7220 7b70  n placeholder {p
+0000c3d0: 6c61 6365 686f 6c64 6572 7d20 696e 2073  laceholder} in s
+0000c3e0: 716c 5f73 746d 743a 207b 7371 6c5f 7374  ql_stmt: {sql_st
+0000c3f0: 6d74 7d22 0a20 2020 2020 2020 2020 2020  mt}".           
+0000c400: 2029 0a0a 2020 2020 6966 206c 656e 2866   )..    if len(f
+0000c410: 6f72 6d61 745f 6b77 6172 6773 2920 3e20  ormat_kwargs) > 
+0000c420: 303a 0a20 2020 2020 2020 2073 716c 5f73  0:.        sql_s
+0000c430: 746d 7420 3d20 7371 6c5f 7374 6d74 2e66  tmt = sql_stmt.f
+0000c440: 6f72 6d61 7428 2a2a 666f 726d 6174 5f6b  ormat(**format_k
+0000c450: 7761 7267 7329 0a20 2020 2072 6574 7572  wargs).    retur
+0000c460: 6e20 7371 6c5f 7374 6d74 0a0a 0a64 6566  n sql_stmt...def
+0000c470: 2072 6561 645f 6669 6c65 5f73 716c 280a   read_file_sql(.
+0000c480: 2020 2020 7061 7468 3a20 556e 696f 6e5b      path: Union[
+0000c490: 7374 722c 2022 6f73 2e50 6174 684c 696b  str, "os.PathLik
+0000c4a0: 655b 416e 795d 225d 2c0a 2020 2020 7371  e[Any]"],.    sq
+0000c4b0: 6c5f 7374 6d74 3a20 7374 722c 0a20 2020  l_stmt: str,.   
+0000c4c0: 2073 716c 5f64 6961 6c65 6374 3a20 4f70   sql_dialect: Op
+0000c4d0: 7469 6f6e 616c 5b4c 6974 6572 616c 5b22  tional[Literal["
+0000c4e0: 5351 4c49 5445 222c 2022 4f47 5253 514c  SQLITE", "OGRSQL
+0000c4f0: 225d 5d20 3d20 2253 514c 4954 4522 2c0a  "]] = "SQLITE",.
+0000c500: 2020 2020 6c61 7965 723a 204f 7074 696f      layer: Optio
+0000c510: 6e61 6c5b 7374 725d 203d 204e 6f6e 652c  nal[str] = None,
+0000c520: 0a20 2020 2069 676e 6f72 655f 6765 6f6d  .    ignore_geom
+0000c530: 6574 7279 3a20 626f 6f6c 203d 2046 616c  etry: bool = Fal
+0000c540: 7365 2c0a 2920 2d3e 2055 6e69 6f6e 5b70  se,.) -> Union[p
+0000c550: 642e 4461 7461 4672 616d 652c 2067 7064  d.DataFrame, gpd
+0000c560: 2e47 656f 4461 7461 4672 616d 655d 3a0a  .GeoDataFrame]:.
+0000c570: 2020 2020 2222 220a 2020 2020 4445 5052      """.    DEPR
+0000c580: 4543 4154 4544 3a20 5265 6164 7320 6120  ECATED: Reads a 
+0000c590: 6669 6c65 2075 7369 6e67 2061 6e20 5351  file using an SQ
+0000c5a0: 4c20 7374 6174 656d 656e 742e 0a0a 2020  L statement...  
+0000c5b0: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+0000c5c0: 7061 7468 2028 6669 6c65 2070 6174 6829  path (file path)
+0000c5d0: 3a20 7061 7468 2074 6f20 7468 6520 6669  : path to the fi
+0000c5e0: 6c65 2074 6f20 7265 6164 2066 726f 6d0a  le to read from.
+0000c5f0: 2020 2020 2020 2020 7371 6c5f 7374 6d74          sql_stmt
+0000c600: 2028 7374 7229 3a20 5351 4c20 7374 6174   (str): SQL stat
+0000c610: 656d 656e 7420 746f 2075 7365 0a20 2020  ement to use.   
+0000c620: 2020 2020 2073 716c 5f64 6961 6c65 6374       sql_dialect
+0000c630: 2028 7374 722c 206f 7074 696f 6e61 6c29   (str, optional)
+0000c640: 3a20 5351 4c20 6469 616c 6563 7420 7573  : SQL dialect us
+0000c650: 6564 2e20 4465 6661 756c 7473 2074 6f20  ed. Defaults to 
+0000c660: 2753 514c 4954 4527 2e0a 2020 2020 2020  'SQLITE'..      
+0000c670: 2020 6c61 7965 7220 2873 7472 2c20 6f70    layer (str, op
+0000c680: 7469 6f6e 616c 293a 2054 6865 206c 6179  tional): The lay
+0000c690: 6572 2074 6f20 7265 6164 2e20 4966 206e  er to read. If n
+0000c6a0: 6f20 6c61 7965 7220 6973 2073 7065 6369  o layer is speci
+0000c6b0: 6669 6564 2c0a 2020 2020 2020 2020 2020  fied,.          
+0000c6c0: 2020 7265 6164 7320 7468 6520 6f6e 6c79    reads the only
+0000c6d0: 206c 6179 6572 2069 6e20 7468 6520 6669   layer in the fi
+0000c6e0: 6c65 206f 7220 7468 726f 7773 2061 6e20  le or throws an 
+0000c6f0: 4578 6365 7074 696f 6e2e 0a20 2020 2020  Exception..     
+0000c700: 2020 2069 676e 6f72 655f 6765 6f6d 6574     ignore_geomet
+0000c710: 7279 2028 626f 6f6c 2c20 6f70 7469 6f6e  ry (bool, option
+0000c720: 616c 293a 2054 7275 6520 6e6f 7420 746f  al): True not to
+0000c730: 2072 6561 642f 7265 7475 726e 2074 6865   read/return the
+0000c740: 2067 656f 6d61 7472 792e 0a20 2020 2020   geomatry..     
+0000c750: 2020 2020 2020 2044 6566 6175 6c74 7320         Defaults 
+0000c760: 746f 2046 616c 7365 2e0a 0a20 2020 2052  to False...    R
+0000c770: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
+0000c780: 556e 696f 6e5b 7064 2e44 6174 6146 7261  Union[pd.DataFra
+0000c790: 6d65 2c20 6770 642e 4765 6f44 6174 6146  me, gpd.GeoDataF
+0000c7a0: 7261 6d65 5d3a 2054 6865 2064 6174 6120  rame]: The data 
+0000c7b0: 7265 6164 2e0a 2020 2020 2222 220a 2020  read..    """.  
+0000c7c0: 2020 7761 726e 696e 6773 2e77 6172 6e28    warnings.warn(
+0000c7d0: 0a20 2020 2020 2020 2027 7265 6164 5f66  .        'read_f
+0000c7e0: 696c 655f 7371 6c20 6973 2064 6570 7265  ile_sql is depre
+0000c7f0: 6361 7465 643a 2075 7365 2072 6561 645f  cated: use read_
+0000c800: 6669 6c65 2120 4d69 6e64 3a20 7371 6c5f  file! Mind: sql_
+0000c810: 6469 616c 6563 7420 6973 206e 6f74 2022  dialect is not "
+0000c820: 5351 4c49 5445 2220 270a 2020 2020 2020  SQLITE" '.      
+0000c830: 2020 2262 7920 6465 6661 756c 7420 7468    "by default th
+0000c840: 6572 6521 222c 0a20 2020 2020 2020 2046  ere!",.        F
+0000c850: 7574 7572 6557 6172 6e69 6e67 2c0a 2020  utureWarning,.  
+0000c860: 2020 2020 2020 7374 6163 6b6c 6576 656c        stacklevel
+0000c870: 3d32 2c0a 2020 2020 290a 0a20 2020 2023  =2,.    )..    #
+0000c880: 2052 756e 0a20 2020 2072 6574 7572 6e20   Run.    return 
+0000c890: 5f72 6561 645f 6669 6c65 5f62 6173 6528  _read_file_base(
+0000c8a0: 0a20 2020 2020 2020 2070 6174 682c 0a20  .        path,. 
+0000c8b0: 2020 2020 2020 2073 716c 5f73 746d 743d         sql_stmt=
+0000c8c0: 7371 6c5f 7374 6d74 2c0a 2020 2020 2020  sql_stmt,.      
+0000c8d0: 2020 7371 6c5f 6469 616c 6563 743d 7371    sql_dialect=sq
+0000c8e0: 6c5f 6469 616c 6563 742c 0a20 2020 2020  l_dialect,.     
+0000c8f0: 2020 206c 6179 6572 3d6c 6179 6572 2c0a     layer=layer,.
+0000c900: 2020 2020 2020 2020 6967 6e6f 7265 5f67          ignore_g
+0000c910: 656f 6d65 7472 793d 6967 6e6f 7265 5f67  eometry=ignore_g
+0000c920: 656f 6d65 7472 792c 0a20 2020 2029 0a0a  eometry,.    )..
+0000c930: 0a64 6566 2074 6f5f 6669 6c65 280a 2020  .def to_file(.  
+0000c940: 2020 6764 663a 2055 6e69 6f6e 5b70 642e    gdf: Union[pd.
+0000c950: 4461 7461 4672 616d 652c 2067 7064 2e47  DataFrame, gpd.G
+0000c960: 656f 4461 7461 4672 616d 655d 2c0a 2020  eoDataFrame],.  
+0000c970: 2020 7061 7468 3a20 556e 696f 6e5b 7374    path: Union[st
+0000c980: 722c 2022 6f73 2e50 6174 684c 696b 655b  r, "os.PathLike[
+0000c990: 416e 795d 225d 2c0a 2020 2020 6c61 7965  Any]"],.    laye
+0000c9a0: 723a 204f 7074 696f 6e61 6c5b 7374 725d  r: Optional[str]
+0000c9b0: 203d 204e 6f6e 652c 0a20 2020 2066 6f72   = None,.    for
+0000c9c0: 6365 5f6f 7574 7075 745f 6765 6f6d 6574  ce_output_geomet
+0000c9d0: 7279 7479 7065 3a20 556e 696f 6e5b 4765  rytype: Union[Ge
+0000c9e0: 6f6d 6574 7279 5479 7065 2c20 7374 722c  ometryType, str,
+0000c9f0: 204e 6f6e 655d 203d 204e 6f6e 652c 0a20   None] = None,. 
+0000ca00: 2020 2066 6f72 6365 5f6d 756c 7469 7479     force_multity
+0000ca10: 7065 3a20 626f 6f6c 203d 2046 616c 7365  pe: bool = False
+0000ca20: 2c0a 2020 2020 6170 7065 6e64 3a20 626f  ,.    append: bo
+0000ca30: 6f6c 203d 2046 616c 7365 2c0a 2020 2020  ol = False,.    
+0000ca40: 6170 7065 6e64 5f74 696d 656f 7574 5f73  append_timeout_s
+0000ca50: 3a20 696e 7420 3d20 3630 302c 0a20 2020  : int = 600,.   
+0000ca60: 2069 6e64 6578 3a20 4f70 7469 6f6e 616c   index: Optional
+0000ca70: 5b62 6f6f 6c5d 203d 204e 6f6e 652c 0a20  [bool] = None,. 
+0000ca80: 2020 2063 7265 6174 655f 7370 6174 6961     create_spatia
+0000ca90: 6c5f 696e 6465 783a 204f 7074 696f 6e61  l_index: Optiona
+0000caa0: 6c5b 626f 6f6c 5d20 3d20 4e6f 6e65 2c0a  l[bool] = None,.
+0000cab0: 2020 2020 2a2a 6b77 6172 6773 2c0a 293a      **kwargs,.):
+0000cac0: 0a20 2020 2022 2222 0a20 2020 2057 7269  .    """.    Wri
+0000cad0: 7465 7320 6120 7061 6e64 6173 2064 6174  tes a pandas dat
+0000cae0: 6166 7261 6d65 2074 6f20 6669 6c65 2e0a  aframe to file..
+0000caf0: 0a20 2020 2054 6865 2066 696c 6566 6f72  .    The filefor
+0000cb00: 6d61 7420 6973 2064 6574 6563 7465 6420  mat is detected 
+0000cb10: 6261 7365 6420 6f6e 2074 6865 2066 696c  based on the fil
+0000cb20: 6570 6174 6820 6578 7465 6e73 696f 6e2e  epath extension.
+0000cb30: 0a0a 2020 2020 5468 6520 756e 6465 726c  ..    The underl
+0000cb40: 7969 6e67 206c 6962 7261 7279 2075 7365  ying library use
+0000cb50: 6420 746f 2077 7269 7465 2074 6865 2066  d to write the f
+0000cb60: 696c 6520 6361 6e20 6265 2063 686f 6f73  ile can be choos
+0000cb70: 656e 2075 7369 6e67 2074 6865 0a20 2020  en using the.   
+0000cb80: 2022 4746 4f5f 494f 5f45 4e47 494e 4522   "GFO_IO_ENGINE"
+0000cb90: 2065 6e76 6972 6f6e 6d65 6e74 2076 6172   environment var
+0000cba0: 6961 626c 652e 2050 6f73 7369 626c 6520  iable. Possible 
+0000cbb0: 7661 6c75 6573 2061 7265 2022 6669 6f6e  values are "fion
+0000cbc0: 6122 2061 6e64 2022 7079 6f67 7269 6f22  a" and "pyogrio"
+0000cbd0: 2e0a 2020 2020 4465 6661 756c 7420 656e  ..    Default en
+0000cbe0: 6769 6e65 2069 7320 2270 796f 6772 696f  gine is "pyogrio
+0000cbf0: 222e 0a0a 2020 2020 4172 6773 3a0a 2020  "...    Args:.  
+0000cc00: 2020 2020 2020 6764 6620 2867 7064 2e47        gdf (gpd.G
+0000cc10: 656f 4461 7461 4672 616d 6529 3a20 5468  eoDataFrame): Th
+0000cc20: 6520 4765 6f44 6174 6146 7261 6d65 2074  e GeoDataFrame t
+0000cc30: 6f20 6578 706f 7274 2074 6f20 6669 6c65  o export to file
+0000cc40: 2e0a 2020 2020 2020 2020 7061 7468 2028  ..        path (
+0000cc50: 556e 696f 6e5b 7374 722c 293a 2054 6865  Union[str,): The
+0000cc60: 2066 696c 6520 7061 7468 2074 6f20 7772   file path to wr
+0000cc70: 6974 6520 746f 2e0a 2020 2020 2020 2020  ite to..        
+0000cc80: 6c61 7965 7220 2873 7472 2c20 6f70 7469  layer (str, opti
+0000cc90: 6f6e 616c 293a 2054 6865 206c 6179 6572  onal): The layer
+0000cca0: 2074 6f20 7265 6164 2e20 4966 206e 6f20   to read. If no 
+0000ccb0: 6c61 7965 7220 6973 2073 7065 6369 6669  layer is specifi
+0000ccc0: 6564 2c0a 2020 2020 2020 2020 2020 2020  ed,.            
+0000ccd0: 7265 6164 7320 7468 6520 6f6e 6c79 206c  reads the only l
+0000cce0: 6179 6572 2069 6e20 7468 6520 6669 6c65  ayer in the file
+0000ccf0: 206f 7220 7468 726f 7773 2061 6e20 4578   or throws an Ex
+0000cd00: 6365 7074 696f 6e2e 0a20 2020 2020 2020  ception..       
+0000cd10: 2066 6f72 6365 5f6f 7574 7075 745f 6765   force_output_ge
+0000cd20: 6f6d 6574 7279 7479 7065 2028 556e 696f  ometrytype (Unio
+0000cd30: 6e5b 4765 6f6d 6574 7279 5479 7065 2c20  n[GeometryType, 
+0000cd40: 7374 725d 2c20 6f70 7469 6f6e 616c 293a  str], optional):
+0000cd50: 2047 656f 6d65 7472 7920 7479 7065 0a20   Geometry type. 
+0000cd60: 2020 2020 2020 2020 2020 2074 6f20 2874             to (t
+0000cd70: 7279 2074 6f29 2066 6f72 6365 2074 6865  ry to) force the
+0000cd80: 206f 7574 7075 7420 746f 2e20 4465 6661   output to. Defa
+0000cd90: 756c 7473 2074 6f20 4e6f 6e65 2e0a 2020  ults to None..  
+0000cda0: 2020 2020 2020 2020 2020 4d61 726b 3a20            Mark: 
+0000cdb0: 636f 6d70 6172 6564 2074 6f20 6f74 6865  compared to othe
+0000cdc0: 7220 6675 6e63 7469 6f6e 7320 696e 2067  r functions in g
+0000cdd0: 666f 2077 6974 6820 7468 6973 2070 6172  fo with this par
+0000cde0: 616d 6574 6572 2c20 7468 6520 6265 6861  ameter, the beha
+0000cdf0: 7669 6f75 720a 2020 2020 2020 2020 2020  viour.          
+0000ce00: 2020 6865 7265 2069 7320 6c69 6d69 7465    here is limite
+0000ce10: 6420 746f 2074 6865 2066 6f6c 6c6f 7769  d to the followi
+0000ce20: 6e67 3a0a 2020 2020 2020 2020 2020 2020  ng:.            
+0000ce30: 2020 2020 2d20 666f 7220 656d 7074 7920      - for empty 
+0000ce40: 696e 7075 7420 6764 6627 732c 2061 2073  input gdf's, a s
+0000ce50: 7461 6e64 6172 6420 6765 6f6d 6574 7279  tandard geometry
+0000ce60: 2074 7970 6520 2865 672e 2050 6f6c 7967   type (eg. Polyg
+0000ce70: 6f6e 2c2e 2e2e 2920 6361 6e0a 2020 2020  on,...) can.    
+0000ce80: 2020 2020 2020 2020 2020 2020 2020 6265                be
+0000ce90: 2075 7365 6420 746f 2066 6f72 6365 2074   used to force t
+0000cea0: 6865 2067 656f 6d65 7472 7920 636f 6c75  he geometry colu
+0000ceb0: 6d6e 2074 6f20 6265 206f 6620 7468 6174  mn to be of that
+0000cec0: 2074 7970 652e 0a20 2020 2020 2020 2020   type..         
+0000ced0: 2020 2020 2020 202d 2069 6620 666f 7263         - if forc
+0000cee0: 655f 6f75 7470 7574 5f67 656f 6d65 7472  e_output_geometr
+0000cef0: 7974 7970 6520 6973 2061 204d 554c 5449  ytype is a MULTI
+0000cf00: 2074 7970 652c 2070 6172 616d 6574 6572   type, parameter
+0000cf10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000cf20: 2020 2066 6f72 6365 5f6d 756c 7469 7479     force_multity
+0000cf30: 7065 2062 6563 6f6d 6573 2054 7275 652e  pe becomes True.
+0000cf40: 0a20 2020 2020 2020 2066 6f72 6365 5f6d  .        force_m
+0000cf50: 756c 7469 7479 7065 2028 626f 6f6c 2c20  ultitype (bool, 
+0000cf60: 6f70 7469 6f6e 616c 293a 2066 6f72 6365  optional): force
+0000cf70: 2074 6865 2067 656f 6d65 7472 7920 7479   the geometry ty
+0000cf80: 7065 2074 6f20 6120 6d75 6c74 6974 7970  pe to a multityp
+0000cf90: 650a 2020 2020 2020 2020 2020 2020 666f  e.            fo
+0000cfa0: 7220 6669 6c65 2074 7970 6573 2074 6861  r file types tha
+0000cfb0: 7420 7265 7175 6972 6520 6f6e 6520 6765  t require one ge
+0000cfc0: 6f6d 6574 7279 7479 7065 2070 6572 206c  ometrytype per l
+0000cfd0: 6179 6572 2e0a 2020 2020 2020 2020 2020  ayer..          
+0000cfe0: 2020 4465 6661 756c 7473 2074 6f20 4661    Defaults to Fa
+0000cff0: 6c73 652e 0a20 2020 2020 2020 2061 7070  lse..        app
+0000d000: 656e 6420 2862 6f6f 6c2c 206f 7074 696f  end (bool, optio
+0000d010: 6e61 6c29 3a20 5472 7565 2074 6f20 6170  nal): True to ap
+0000d020: 7065 6e64 2074 6f20 7468 6520 6669 6c65  pend to the file
+0000d030: 2f6c 6179 6572 2069 6620 6974 2065 7869  /layer if it exi
+0000d040: 7374 7320 616c 7265 6164 792e 0a20 2020  sts already..   
+0000d050: 2020 2020 2020 2020 2049 6620 6974 2064           If it d
+0000d060: 6f65 736e 2774 2065 7869 7374 2079 6574  oesn't exist yet
+0000d070: 2c20 6974 2069 7320 6372 6561 7465 642e  , it is created.
+0000d080: 2044 6566 6175 6c74 7320 746f 2046 616c   Defaults to Fal
+0000d090: 7365 2e0a 2020 2020 2020 2020 6170 7065  se..        appe
+0000d0a0: 6e64 5f74 696d 656f 7574 5f73 2028 696e  nd_timeout_s (in
+0000d0b0: 742c 206f 7074 696f 6e61 6c29 3a20 5468  t, optional): Th
+0000d0c0: 6520 6d61 7869 6d75 6d20 7469 6d65 6f75  e maximum timeou
+0000d0d0: 7420 746f 2077 6169 7420 7768 656e 2074  t to wait when t
+0000d0e0: 6865 0a20 2020 2020 2020 2020 2020 206f  he.            o
+0000d0f0: 7574 7075 7420 6669 6c65 2069 7320 616c  utput file is al
+0000d100: 7265 6164 7920 6265 696e 6720 7772 6974  ready being writ
+0000d110: 7465 6e20 746f 2062 7920 616e 6f74 6865  ten to by anothe
+0000d120: 7220 7072 6f63 6573 732e 0a20 2020 2020  r process..     
+0000d130: 2020 2020 2020 2044 6566 6175 6c74 7320         Defaults 
+0000d140: 746f 2036 3030 2e0a 2020 2020 2020 2020  to 600..        
+0000d150: 696e 6465 7820 2862 6f6f 6c2c 206f 7074  index (bool, opt
+0000d160: 696f 6e61 6c29 3a20 4966 2054 7275 652c  ional): If True,
+0000d170: 2077 7269 7465 2069 6e64 6578 2069 6e74   write index int
+0000d180: 6f20 6f6e 6520 6f72 206d 6f72 6520 636f  o one or more co
+0000d190: 6c75 6d6e 7320 2866 6f72 0a20 2020 2020  lumns (for.     
+0000d1a0: 2020 2020 2020 204d 756c 7469 496e 6465         MultiInde
+0000d1b0: 7829 2e20 4e6f 6e65 2077 7269 7465 7320  x). None writes 
+0000d1c0: 7468 6520 696e 6465 7820 696e 746f 206f  the index into o
+0000d1d0: 6e65 206f 7220 6d6f 7265 2063 6f6c 756d  ne or more colum
+0000d1e0: 6e73 206f 6e6c 7920 6966 2074 6865 0a20  ns only if the. 
+0000d1f0: 2020 2020 2020 2020 2020 2069 6e64 6578             index
+0000d200: 2069 7320 6e61 6d65 642c 2069 7320 6120   is named, is a 
+0000d210: 4d75 6c74 6949 6e64 6578 2c20 6f72 2068  MultiIndex, or h
+0000d220: 6173 2061 206e 6f6e 2d69 6e74 6567 6572  as a non-integer
+0000d230: 2064 6174 6120 7479 7065 2e0a 2020 2020   data type..    
+0000d240: 2020 2020 2020 2020 4966 2046 616c 7365          If False
+0000d250: 2c20 6e6f 2069 6e64 6578 2069 7320 7772  , no index is wr
+0000d260: 6974 7465 6e2e 2044 6566 6175 6c74 7320  itten. Defaults 
+0000d270: 746f 204e 6f6e 652e 0a20 2020 2020 2020  to None..       
+0000d280: 2063 7265 6174 655f 7370 6174 6961 6c5f   create_spatial_
+0000d290: 696e 6465 7820 2862 6f6f 6c2c 206f 7074  index (bool, opt
+0000d2a0: 696f 6e61 6c29 3a20 5472 7565 2074 6f20  ional): True to 
+0000d2b0: 666f 7263 6520 6372 6561 7469 6f6e 206f  force creation o
+0000d2c0: 6620 7370 6174 6961 6c20 696e 6465 782c  f spatial index,
+0000d2d0: 0a20 2020 2020 2020 2020 2020 2046 616c  .            Fal
+0000d2e0: 7365 2074 6f20 6176 6f69 6420 6372 6561  se to avoid crea
+0000d2f0: 7469 6f6e 2e20 4e6f 6e65 206c 6561 6473  tion. None leads
+0000d300: 2074 6f20 7468 6520 6465 6661 756c 7420   to the default 
+0000d310: 6265 6861 7669 6f75 7220 6f66 2067 6461  behaviour of gda
+0000d320: 6c2e 0a20 2020 2020 2020 2020 2020 2044  l..            D
+0000d330: 6566 6175 6c74 7320 746f 204e 6f6e 652e  efaults to None.
+0000d340: 0a20 2020 2020 2020 202a 2a6b 7761 7267  .        **kwarg
+0000d350: 733a 2041 6c6c 2061 6464 6974 696f 6e61  s: All additiona
+0000d360: 6c20 7061 7261 6d65 7465 7273 2077 696c  l parameters wil
+0000d370: 6c20 6265 2070 6173 7365 6420 6f6e 2074  l be passed on t
+0000d380: 6f20 7468 6520 696f 2d65 6e67 696e 6520  o the io-engine 
+0000d390: 7573 6564 0a20 2020 2020 2020 2020 2020  used.           
+0000d3a0: 2028 2270 796f 6772 696f 2220 6f72 2022   ("pyogrio" or "
+0000d3b0: 6669 6f6e 6122 292e 0a0a 2020 2020 5261  fiona")...    Ra
+0000d3c0: 6973 6573 3a0a 2020 2020 2020 2020 5661  ises:.        Va
+0000d3d0: 6c75 6545 7272 6f72 3a20 616e 2069 6e76  lueError: an inv
+0000d3e0: 616c 6964 2070 6172 616d 6574 6572 2076  alid parameter v
+0000d3f0: 616c 7565 2077 6173 2070 6173 7365 642e  alue was passed.
+0000d400: 0a20 2020 2020 2020 2052 756e 7469 6d65  .        Runtime
+0000d410: 4572 726f 723a 2074 696d 656f 7574 2077  Error: timeout w
+0000d420: 6173 2072 6561 6368 6564 2077 6869 6c65  as reached while
+0000d430: 2074 7279 696e 6720 746f 2061 7070 656e   trying to appen
+0000d440: 6420 6461 7461 2074 6f20 7061 7468 2e0a  d data to path..
+0000d450: 2020 2020 2222 220a 2020 2020 2320 4368      """.    # Ch
+0000d460: 6563 6b20 696e 7075 7420 7061 7261 6d65  eck input parame
+0000d470: 7465 7273 0a20 2020 2023 202d 2d2d 2d2d  ters.    # -----
+0000d480: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0000d490: 2d0a 2020 2020 7061 7468 203d 2050 6174  -.    path = Pat
+0000d4a0: 6828 7061 7468 290a 0a20 2020 2023 2049  h(path)..    # I
+0000d4b0: 6620 6e6f 206c 6179 6572 206e 616d 6520  f no layer name 
+0000d4c0: 7370 6563 6966 6965 642c 2064 6574 6572  specified, deter
+0000d4d0: 6d69 6e65 206f 6e65 0a20 2020 2069 6620  mine one.    if 
+0000d4e0: 6c61 7965 7220 6973 204e 6f6e 653a 0a20  layer is None:. 
+0000d4f0: 2020 2020 2020 2069 6620 6170 7065 6e64         if append
+0000d500: 2061 6e64 2070 6174 682e 6578 6973 7473   and path.exists
+0000d510: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+0000d520: 6c61 7965 7220 3d20 6765 745f 6f6e 6c79  layer = get_only
+0000d530: 5f6c 6179 6572 2870 6174 6829 0a20 2020  _layer(path).   
+0000d540: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0000d550: 2020 2020 2020 206c 6179 6572 203d 2050         layer = P
+0000d560: 6174 6828 7061 7468 292e 7374 656d 0a0a  ath(path).stem..
+0000d570: 2020 2020 2320 4966 2066 6f72 6365 5f6f      # If force_o
+0000d580: 7574 7075 745f 6765 6f6d 6574 7279 7479  utput_geometryty
+0000d590: 7065 2069 7320 6120 7374 7269 6e67 2c20  pe is a string, 
+0000d5a0: 6368 6563 6b20 6966 2069 7420 6973 2061  check if it is a
+0000d5b0: 2022 7374 616e 6461 7264 2220 6765 6f6d   "standard" geom
+0000d5c0: 6574 7279 0a20 2020 2023 2074 7970 652c  etry.    # type,
+0000d5d0: 2061 7320 4744 414c 2061 6c73 6f20 7375   as GDAL also su
+0000d5e0: 7070 6f72 7473 2073 7065 6369 616c 2067  pports special g
+0000d5f0: 656f 6d65 7472 7920 7479 7065 7320 6c69  eometry types li
+0000d600: 6b65 2022 5052 4f4d 4f54 455f 544f 5f4d  ke "PROMOTE_TO_M
+0000d610: 554c 5449 220a 2020 2020 6966 2069 7369  ULTI".    if isi
+0000d620: 6e73 7461 6e63 6528 666f 7263 655f 6f75  nstance(force_ou
+0000d630: 7470 7574 5f67 656f 6d65 7472 7974 7970  tput_geometrytyp
+0000d640: 652c 2073 7472 293a 0a20 2020 2020 2020  e, str):.       
+0000d650: 2066 6f72 6365 5f6f 7574 7075 745f 6765   force_output_ge
+0000d660: 6f6d 6574 7279 7479 7065 203d 2066 6f72  ometrytype = for
+0000d670: 6365 5f6f 7574 7075 745f 6765 6f6d 6574  ce_output_geomet
+0000d680: 7279 7479 7065 2e75 7070 6572 2829 0a20  rytype.upper(). 
+0000d690: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+0000d6a0: 2020 2020 2020 2020 2320 5665 7269 6679          # Verify
+0000d6b0: 2069 6620 6974 2069 7320 6120 2273 7461   if it is a "sta
+0000d6c0: 6e64 6172 6422 2067 656f 6d65 7472 7920  ndard" geometry 
+0000d6d0: 7479 7065 2c20 6173 2047 4441 4c20 616c  type, as GDAL al
+0000d6e0: 736f 2073 7570 706f 7274 730a 2020 2020  so supports.    
+0000d6f0: 2020 2020 2020 2020 2320 7370 6563 6961          # specia
+0000d700: 6c20 6765 6f6d 6574 7279 2074 7970 6573  l geometry types
+0000d710: 206c 696b 6520 2250 524f 4d4f 5445 5f54   like "PROMOTE_T
+0000d720: 4f5f 4d55 4c54 4922 0a20 2020 2020 2020  O_MULTI".       
+0000d730: 2020 2020 2066 6f72 6365 5f6f 7574 7075       force_outpu
+0000d740: 745f 6765 6f6d 6574 7279 7479 7065 203d  t_geometrytype =
+0000d750: 2047 656f 6d65 7472 7954 7970 655b 666f   GeometryType[fo
+0000d760: 7263 655f 6f75 7470 7574 5f67 656f 6d65  rce_output_geome
+0000d770: 7472 7974 7970 655d 0a20 2020 2020 2020  trytype].       
+0000d780: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+0000d790: 6e3a 0a20 2020 2020 2020 2020 2020 2072  n:.            r
+0000d7a0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+0000d7b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000d7c0: 2066 2255 6e73 7570 706f 7274 6564 2066   f"Unsupported f
+0000d7d0: 6f72 6365 5f6f 7574 7075 745f 6765 6f6d  orce_output_geom
+0000d7e0: 6574 7279 7479 7065 3a20 7b66 6f72 6365  etrytype: {force
+0000d7f0: 5f6f 7574 7075 745f 6765 6f6d 6574 7279  _output_geometry
+0000d800: 7479 7065 7d22 0a20 2020 2020 2020 2020  type}".         
+0000d810: 2020 2029 0a20 2020 2069 6620 666f 7263     ).    if forc
 0000d820: 655f 6f75 7470 7574 5f67 656f 6d65 7472  e_output_geometr
-0000d830: 7974 7970 652e 7570 7065 7228 290a 2020  ytype.upper().  
-0000d840: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-0000d850: 2020 2020 2020 2023 2056 6572 6966 7920         # Verify 
-0000d860: 6966 2069 7420 6973 2061 2022 7374 616e  if it is a "stan
-0000d870: 6461 7264 2220 6765 6f6d 6574 7279 2074  dard" geometry t
-0000d880: 7970 652c 2061 7320 4744 414c 2061 6c73  ype, as GDAL als
-0000d890: 6f20 7375 7070 6f72 7473 0a20 2020 2020  o supports.     
-0000d8a0: 2020 2020 2020 2023 2073 7065 6369 616c         # special
-0000d8b0: 2067 656f 6d65 7472 7920 7479 7065 7320   geometry types 
-0000d8c0: 6c69 6b65 2022 5052 4f4d 4f54 455f 544f  like "PROMOTE_TO
-0000d8d0: 5f4d 554c 5449 220a 2020 2020 2020 2020  _MULTI".        
-0000d8e0: 2020 2020 666f 7263 655f 6f75 7470 7574      force_output
-0000d8f0: 5f67 656f 6d65 7472 7974 7970 6520 3d20  _geometrytype = 
-0000d900: 4765 6f6d 6574 7279 5479 7065 5b66 6f72  GeometryType[for
-0000d910: 6365 5f6f 7574 7075 745f 6765 6f6d 6574  ce_output_geomet
-0000d920: 7279 7479 7065 5d0a 2020 2020 2020 2020  rytype].        
-0000d930: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-0000d940: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-0000d950: 6973 6520 5661 6c75 6545 7272 6f72 280a  ise ValueError(.
-0000d960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d970: 6622 556e 7375 7070 6f72 7465 6420 666f  f"Unsupported fo
-0000d980: 7263 655f 6f75 7470 7574 5f67 656f 6d65  rce_output_geome
-0000d990: 7472 7974 7970 653a 207b 666f 7263 655f  trytype: {force_
-0000d9a0: 6f75 7470 7574 5f67 656f 6d65 7472 7974  output_geometryt
-0000d9b0: 7970 657d 220a 2020 2020 2020 2020 2020  ype}".          
-0000d9c0: 2020 290a 2020 2020 6966 2066 6f72 6365    ).    if force
-0000d9d0: 5f6f 7574 7075 745f 6765 6f6d 6574 7279  _output_geometry
-0000d9e0: 7479 7065 2069 7320 6e6f 7420 4e6f 6e65  type is not None
-0000d9f0: 2061 6e64 2066 6f72 6365 5f6f 7574 7075   and force_outpu
-0000da00: 745f 6765 6f6d 6574 7279 7479 7065 2e69  t_geometrytype.i
-0000da10: 735f 6d75 6c74 6974 7970 653a 0a20 2020  s_multitype:.   
-0000da20: 2020 2020 2066 6f72 6365 5f6d 756c 7469       force_multi
-0000da30: 7479 7065 203d 2054 7275 650a 0a20 2020  type = True..   
-0000da40: 2023 2049 6620 7468 6572 6520 6973 206e   # If there is n
-0000da50: 6f20 6765 6f6d 6574 7279 2063 6f6c 756d  o geometry colum
-0000da60: 6e20 696e 2074 6865 2069 6e70 7574 2c20  n in the input, 
-0000da70: 616c 7761 7973 2075 7365 2066 696f 6e61  always use fiona
-0000da80: 2c20 6173 2070 796f 6772 696f 2064 6f65  , as pyogrio doe
-0000da90: 736e 2774 0a20 2020 2023 2073 7570 706f  sn't.    # suppo
-0000daa0: 7274 2074 6861 7420 7965 7420 6174 2074  rt that yet at t
-0000dab0: 696d 6520 6f66 2077 7269 7469 6e67 2e0a  ime of writing..
-0000dac0: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-0000dad0: 6528 6764 662c 2067 7064 2e47 656f 4461  e(gdf, gpd.GeoDa
-0000dae0: 7461 4672 616d 6529 2069 7320 4661 6c73  taFrame) is Fals
-0000daf0: 6520 6f72 2028 0a20 2020 2020 2020 2069  e or (.        i
-0000db00: 7369 6e73 7461 6e63 6528 6764 662c 2067  sinstance(gdf, g
-0000db10: 7064 2e47 656f 4461 7461 4672 616d 6529  pd.GeoDataFrame)
-0000db20: 2061 6e64 2022 6765 6f6d 6574 7279 2220   and "geometry" 
-0000db30: 6e6f 7420 696e 2067 6466 2e63 6f6c 756d  not in gdf.colum
-0000db40: 6e73 0a20 2020 2029 3a0a 2020 2020 2020  ns.    ):.      
-0000db50: 2020 656e 6769 6e65 203d 2022 6669 6f6e    engine = "fion
-0000db60: 6122 0a20 2020 2020 2020 2063 7265 6174  a".        creat
-0000db70: 655f 7370 6174 6961 6c5f 696e 6465 7820  e_spatial_index 
-0000db80: 3d20 4661 6c73 650a 2020 2020 656c 7365  = False.    else
-0000db90: 3a0a 2020 2020 2020 2020 656e 6769 6e65  :.        engine
-0000dba0: 203d 205f 6765 745f 656e 6769 6e65 2829   = _get_engine()
-0000dbb0: 0a0a 2020 2020 2320 4e6f 7720 7772 6974  ..    # Now writ
-0000dbc0: 6520 7769 7468 2074 6865 2063 6f72 7265  e with the corre
-0000dbd0: 6374 2065 6e67 696e 650a 2020 2020 6966  ct engine.    if
-0000dbe0: 2065 6e67 696e 6520 3d3d 2022 7079 6f67   engine == "pyog
-0000dbf0: 7269 6f22 3a0a 2020 2020 2020 2020 6173  rio":.        as
-0000dc00: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
-0000dc10: 6764 662c 2067 7064 2e47 656f 4461 7461  gdf, gpd.GeoData
-0000dc20: 4672 616d 6529 0a20 2020 2020 2020 2072  Frame).        r
-0000dc30: 6574 7572 6e20 5f74 6f5f 6669 6c65 5f70  eturn _to_file_p
-0000dc40: 796f 6772 696f 280a 2020 2020 2020 2020  yogrio(.        
-0000dc50: 2020 2020 6764 663d 6764 662c 0a20 2020      gdf=gdf,.   
-0000dc60: 2020 2020 2020 2020 2070 6174 683d 7061           path=pa
-0000dc70: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
-0000dc80: 6c61 7965 723d 6c61 7965 722c 0a20 2020  layer=layer,.   
-0000dc90: 2020 2020 2020 2020 2066 6f72 6365 5f6f           force_o
-0000dca0: 7574 7075 745f 6765 6f6d 6574 7279 7479  utput_geometryty
-0000dcb0: 7065 3d66 6f72 6365 5f6f 7574 7075 745f  pe=force_output_
-0000dcc0: 6765 6f6d 6574 7279 7479 7065 2c0a 2020  geometrytype,.  
-0000dcd0: 2020 2020 2020 2020 2020 666f 7263 655f            force_
-0000dce0: 6d75 6c74 6974 7970 653d 666f 7263 655f  multitype=force_
-0000dcf0: 6d75 6c74 6974 7970 652c 0a20 2020 2020  multitype,.     
-0000dd00: 2020 2020 2020 2061 7070 656e 643d 6170         append=ap
-0000dd10: 7065 6e64 2c0a 2020 2020 2020 2020 2020  pend,.          
-0000dd20: 2020 6170 7065 6e64 5f74 696d 656f 7574    append_timeout
-0000dd30: 5f73 3d61 7070 656e 645f 7469 6d65 6f75  _s=append_timeou
-0000dd40: 745f 732c 0a20 2020 2020 2020 2020 2020  t_s,.           
-0000dd50: 2069 6e64 6578 3d69 6e64 6578 2c0a 2020   index=index,.  
-0000dd60: 2020 2020 2020 2020 2020 6372 6561 7465            create
-0000dd70: 5f73 7061 7469 616c 5f69 6e64 6578 3d63  _spatial_index=c
-0000dd80: 7265 6174 655f 7370 6174 6961 6c5f 696e  reate_spatial_in
-0000dd90: 6465 782c 0a20 2020 2020 2020 2029 0a20  dex,.        ). 
-0000dda0: 2020 2065 6c69 6620 656e 6769 6e65 203d     elif engine =
-0000ddb0: 3d20 2266 696f 6e61 223a 0a20 2020 2020  = "fiona":.     
-0000ddc0: 2020 2072 6574 7572 6e20 5f74 6f5f 6669     return _to_fi
-0000ddd0: 6c65 5f66 696f 6e61 280a 2020 2020 2020  le_fiona(.      
-0000dde0: 2020 2020 2020 6764 663d 6764 662c 0a20        gdf=gdf,. 
-0000ddf0: 2020 2020 2020 2020 2020 2070 6174 683d             path=
-0000de00: 7061 7468 2c0a 2020 2020 2020 2020 2020  path,.          
-0000de10: 2020 6c61 7965 723d 6c61 7965 722c 0a20    layer=layer,. 
-0000de20: 2020 2020 2020 2020 2020 2066 6f72 6365             force
-0000de30: 5f6f 7574 7075 745f 6765 6f6d 6574 7279  _output_geometry
-0000de40: 7479 7065 3d66 6f72 6365 5f6f 7574 7075  type=force_outpu
-0000de50: 745f 6765 6f6d 6574 7279 7479 7065 2c0a  t_geometrytype,.
-0000de60: 2020 2020 2020 2020 2020 2020 666f 7263              forc
-0000de70: 655f 6d75 6c74 6974 7970 653d 666f 7263  e_multitype=forc
-0000de80: 655f 6d75 6c74 6974 7970 652c 0a20 2020  e_multitype,.   
-0000de90: 2020 2020 2020 2020 2061 7070 656e 643d           append=
-0000dea0: 6170 7065 6e64 2c0a 2020 2020 2020 2020  append,.        
-0000deb0: 2020 2020 6170 7065 6e64 5f74 696d 656f      append_timeo
-0000dec0: 7574 5f73 3d61 7070 656e 645f 7469 6d65  ut_s=append_time
-0000ded0: 6f75 745f 732c 0a20 2020 2020 2020 2020  out_s,.         
-0000dee0: 2020 2069 6e64 6578 3d69 6e64 6578 2c0a     index=index,.
-0000def0: 2020 2020 2020 2020 2020 2020 6372 6561              crea
-0000df00: 7465 5f73 7061 7469 616c 5f69 6e64 6578  te_spatial_index
-0000df10: 3d63 7265 6174 655f 7370 6174 6961 6c5f  =create_spatial_
-0000df20: 696e 6465 782c 0a20 2020 2020 2020 2029  index,.        )
-0000df30: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-0000df40: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-0000df50: 726f 7228 6622 556e 7375 7070 6f72 7465  ror(f"Unsupporte
-0000df60: 6420 656e 6769 6e65 3a20 7b65 6e67 696e  d engine: {engin
-0000df70: 657d 2229 0a0a 0a64 6566 205f 6765 745f  e}")...def _get_
-0000df80: 656e 6769 6e65 2829 3a0a 2020 2020 7265  engine():.    re
-0000df90: 7475 726e 206f 732e 656e 7669 726f 6e2e  turn os.environ.
-0000dfa0: 6765 7428 2247 464f 5f49 4f5f 454e 4749  get("GFO_IO_ENGI
-0000dfb0: 4e45 222c 2022 7079 6f67 7269 6f22 290a  NE", "pyogrio").
-0000dfc0: 0a0a 6465 6620 5f74 6f5f 6669 6c65 5f66  ..def _to_file_f
-0000dfd0: 696f 6e61 280a 2020 2020 6764 663a 2055  iona(.    gdf: U
-0000dfe0: 6e69 6f6e 5b70 642e 4461 7461 4672 616d  nion[pd.DataFram
-0000dff0: 652c 2067 7064 2e47 656f 4461 7461 4672  e, gpd.GeoDataFr
-0000e000: 616d 655d 2c0a 2020 2020 7061 7468 3a20  ame],.    path: 
-0000e010: 5061 7468 2c0a 2020 2020 6c61 7965 723a  Path,.    layer:
-0000e020: 2073 7472 2c0a 2020 2020 666f 7263 655f   str,.    force_
-0000e030: 6f75 7470 7574 5f67 656f 6d65 7472 7974  output_geometryt
-0000e040: 7970 653a 2055 6e69 6f6e 5b47 656f 6d65  ype: Union[Geome
-0000e050: 7472 7954 7970 652c 2073 7472 2c20 4e6f  tryType, str, No
-0000e060: 6e65 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ne] = None,.    
-0000e070: 666f 7263 655f 6d75 6c74 6974 7970 653a  force_multitype:
-0000e080: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
-0000e090: 2020 2061 7070 656e 643a 2062 6f6f 6c20     append: bool 
-0000e0a0: 3d20 4661 6c73 652c 0a20 2020 2061 7070  = False,.    app
-0000e0b0: 656e 645f 7469 6d65 6f75 745f 733a 2069  end_timeout_s: i
-0000e0c0: 6e74 203d 2036 3030 2c0a 2020 2020 696e  nt = 600,.    in
-0000e0d0: 6465 783a 204f 7074 696f 6e61 6c5b 626f  dex: Optional[bo
-0000e0e0: 6f6c 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ol] = None,.    
-0000e0f0: 6372 6561 7465 5f73 7061 7469 616c 5f69  create_spatial_i
-0000e100: 6e64 6578 3a20 4f70 7469 6f6e 616c 5b62  ndex: Optional[b
-0000e110: 6f6f 6c5d 203d 2054 7275 652c 0a29 3a0a  ool] = True,.):.
-0000e120: 2020 2020 2222 220a 2020 2020 5772 6974      """.    Writ
-0000e130: 6573 2061 2070 616e 6461 7320 6461 7461  es a pandas data
-0000e140: 6672 616d 6520 746f 2066 696c 6520 7573  frame to file us
-0000e150: 696e 6720 6669 6f6e 612e 0a20 2020 2022  ing fiona..    "
-0000e160: 2222 0a20 2020 2023 2053 6861 7065 6669  "".    # Shapefi
-0000e170: 6c65 2064 6f65 736e 2774 2073 7570 706f  le doesn't suppo
-0000e180: 7274 2064 6174 6574 696d 6520 636f 6c75  rt datetime colu
-0000e190: 6d6e 732c 2073 6f20 6669 7273 7420 6361  mns, so first ca
-0000e1a0: 7374 2074 6865 6d20 746f 2073 7472 696e  st them to strin
-0000e1b0: 670a 2020 2020 6966 2070 6174 682e 7375  g.    if path.su
-0000e1c0: 6666 6978 2e6c 6f77 6572 2829 2069 6e20  ffix.lower() in 
-0000e1d0: 5b22 2e73 6870 222c 2022 2e64 6266 225d  [".shp", ".dbf"]
-0000e1e0: 3a0a 2020 2020 2020 2020 6764 6620 3d20  :.        gdf = 
-0000e1f0: 6764 662e 636f 7079 2829 0a20 2020 2020  gdf.copy().     
-0000e200: 2020 2023 2043 6f6c 756d 6e73 2074 6861     # Columns tha
-0000e210: 7420 6861 7665 2061 2070 726f 7065 7220  t have a proper 
-0000e220: 6461 7465 7469 6d65 3634 2074 7970 650a  datetime64 type.
-0000e230: 2020 2020 2020 2020 666f 7220 636f 6c75          for colu
-0000e240: 6d6e 2069 6e20 6764 662e 7365 6c65 6374  mn in gdf.select
-0000e250: 5f64 7479 7065 7328 696e 636c 7564 653d  _dtypes(include=
-0000e260: 5b22 6461 7465 7469 6d65 3634 225d 293a  ["datetime64"]):
-0000e270: 0a20 2020 2020 2020 2020 2020 2067 6466  .            gdf
-0000e280: 5b63 6f6c 756d 6e5d 203d 2067 6466 5b63  [column] = gdf[c
-0000e290: 6f6c 756d 6e5d 2e61 7374 7970 6528 7374  olumn].astype(st
-0000e2a0: 7229 0a0a 2020 2020 2020 2020 2320 436f  r)..        # Co
-0000e2b0: 6c75 6d6e 7320 7468 6174 2061 7265 206f  lumns that are o
-0000e2c0: 6620 6f62 6a65 6374 2074 7970 652c 2062  f object type, b
-0000e2d0: 7574 2063 6f6e 7461 696e 2064 6174 6574  ut contain datet
-0000e2e0: 696d 652e 6461 7465 206f 7220 6461 7465  ime.date or date
-0000e2f0: 7469 6d65 2e64 6174 650a 2020 2020 2020  time.date.      
-0000e300: 2020 2320 7479 7065 2064 6174 6120 696e    # type data in
-0000e310: 7374 6561 6420 6f66 2073 7472 696e 6773  stead of strings
-0000e320: 2e0a 2020 2020 2020 2020 6966 206c 656e  ..        if len
-0000e330: 2867 6466 2920 3e20 303a 0a20 2020 2020  (gdf) > 0:.     
-0000e340: 2020 2020 2020 2066 6f72 2063 6f6c 756d         for colum
-0000e350: 6e20 696e 2067 6466 2e73 656c 6563 745f  n in gdf.select_
-0000e360: 6474 7970 6573 2869 6e63 6c75 6465 3d5b  dtypes(include=[
-0000e370: 226f 626a 6563 7422 5d29 3a0a 2020 2020  "object"]):.    
-0000e380: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-0000e390: 7369 6e73 7461 6e63 6528 6764 665b 636f  sinstance(gdf[co
-0000e3a0: 6c75 6d6e 5d5b 305d 2c20 2864 6174 6574  lumn][0], (datet
-0000e3b0: 696d 652e 6461 7465 2c20 6461 7465 7469  ime.date, dateti
-0000e3c0: 6d65 2e64 6174 6574 696d 6529 293a 0a20  me.datetime)):. 
-0000e3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e3e0: 2020 2067 6466 5b63 6f6c 756d 6e5d 203d     gdf[column] =
-0000e3f0: 2067 6466 5b63 6f6c 756d 6e5d 2e61 7374   gdf[column].ast
-0000e400: 7970 6528 7374 7229 0a0a 2020 2020 2320  ype(str)..    # 
-0000e410: 4861 6e64 6c65 2073 6f6d 6520 7370 6563  Handle some spec
-0000e420: 6966 6963 2063 6173 6573 2077 6865 7265  ific cases where
-0000e430: 2074 6865 2066 696c 6520 7363 6865 6d61   the file schema
-0000e440: 206e 6565 6473 2074 6f20 6265 206d 616e   needs to be man
-0000e450: 6970 756c 6174 6564 2e0a 2020 2020 7363  ipulated..    sc
-0000e460: 6865 6d61 203d 204e 6f6e 650a 2020 2020  hema = None.    
-0000e470: 6966 2069 7369 6e73 7461 6e63 6528 6764  if isinstance(gd
-0000e480: 662c 2067 7064 2e47 656f 4461 7461 4672  f, gpd.GeoDataFr
-0000e490: 616d 6529 2069 7320 4661 6c73 6520 6f72  ame) is False or
-0000e4a0: 2028 0a20 2020 2020 2020 2069 7369 6e73   (.        isins
-0000e4b0: 7461 6e63 6528 6764 662c 2067 7064 2e47  tance(gdf, gpd.G
-0000e4c0: 656f 4461 7461 4672 616d 6529 2061 6e64  eoDataFrame) and
-0000e4d0: 2022 6765 6f6d 6574 7279 2220 6e6f 7420   "geometry" not 
-0000e4e0: 696e 2067 6466 2e63 6f6c 756d 6e73 0a20  in gdf.columns. 
-0000e4f0: 2020 2029 3a0a 2020 2020 2020 2020 2320     ):.        # 
-0000e500: 4e6f 2067 656f 6d65 7472 792c 2073 6f20  No geometry, so 
-0000e510: 7072 6570 6172 6520 746f 2062 6520 7772  prepare to be wr
-0000e520: 6974 7465 6e20 6173 2061 7474 7269 6275  itten as attribu
-0000e530: 7465 2074 6162 6c65 3a20 6164 6420 6765  te table: add ge
-0000e540: 6f6d 6574 7279 2063 6f6c 756d 6e0a 2020  ometry column.  
-0000e550: 2020 2020 2020 2320 7769 7468 204e 6f6e        # with Non
-0000e560: 6520 6765 6f6d 6574 7279 2074 7970 6520  e geometry type 
-0000e570: 696e 2073 6368 656d 610a 2020 2020 2020  in schema.      
-0000e580: 2020 2320 5769 7468 206f 6c64 6572 2076    # With older v
-0000e590: 6572 7369 6f6e 7320 6f66 2070 616e 6461  ersions of panda
-0000e5a0: 7320 616e 642f 6f72 2067 656f 7061 6e64  s and/or geopand
-0000e5b0: 6173 2c20 7769 7468 6f75 7420 7468 6520  as, without the 
-0000e5c0: 636f 7079 2074 6865 2061 6374 7561 6c0a  copy the actual.
-0000e5d0: 2020 2020 2020 2020 2320 6764 6620 6973          # gdf is
-0000e5e0: 2063 6861 6e67 6564 2061 6e64 2072 6574   changed and ret
-0000e5f0: 7572 6e65 6420 7768 6963 6820 6973 6e27  urned which isn'
-0000e600: 7420 4f4b 2e0a 2020 2020 2020 2020 2320  t OK..        # 
-0000e610: 5468 6973 2063 6175 7365 6420 7465 7374  This caused test
-0000e620: 5f74 6f5f 6669 6c65 2077 6974 6820 2e63  _to_file with .c
-0000e630: 7376 2074 6f20 6661 696c 2066 6f72 2074  sv to fail for t
-0000e640: 6865 2022 6d69 6e69 6d61 6c22 2043 4920  he "minimal" CI 
-0000e650: 656e 762e 0a20 2020 2020 2020 2067 6466  env..        gdf
-0000e660: 203d 2067 7064 2e47 656f 4461 7461 4672   = gpd.GeoDataFr
-0000e670: 616d 6528 6764 662e 636f 7079 2829 2c20  ame(gdf.copy(), 
-0000e680: 6765 6f6d 6574 7279 3d5b 4e6f 6e65 2066  geometry=[None f
-0000e690: 6f72 2069 2069 6e20 6764 662e 696e 6465  or i in gdf.inde
-0000e6a0: 785d 290a 0a20 2020 2020 2020 2073 6368  x])..        sch
-0000e6b0: 656d 6120 3d20 6770 645f 696f 5f66 696c  ema = gpd_io_fil
-0000e6c0: 652e 696e 6665 725f 7363 6865 6d61 2867  e.infer_schema(g
-0000e6d0: 6466 290a 2020 2020 2020 2020 7363 6865  df).        sche
-0000e6e0: 6d61 5b22 6765 6f6d 6574 7279 225d 203d  ma["geometry"] =
-0000e6f0: 2022 4e6f 6e65 220a 2020 2020 656c 6966   "None".    elif
-0000e700: 2028 0a20 2020 2020 2020 206c 656e 2867   (.        len(g
-0000e710: 6466 2920 3d3d 2030 0a20 2020 2020 2020  df) == 0.       
-0000e720: 2061 6e64 2066 6f72 6365 5f6f 7574 7075   and force_outpu
-0000e730: 745f 6765 6f6d 6574 7279 7479 7065 2069  t_geometrytype i
-0000e740: 7320 6e6f 7420 4e6f 6e65 0a20 2020 2020  s not None.     
-0000e750: 2020 2061 6e64 2069 7369 6e73 7461 6e63     and isinstanc
-0000e760: 6528 666f 7263 655f 6f75 7470 7574 5f67  e(force_output_g
-0000e770: 656f 6d65 7472 7974 7970 652c 2047 656f  eometrytype, Geo
-0000e780: 6d65 7472 7954 7970 6529 0a20 2020 2029  metryType).    )
-0000e790: 3a0a 2020 2020 2020 2020 2320 4966 2074  :.        # If t
-0000e7a0: 6865 2067 6466 2069 7320 656d 7074 7920  he gdf is empty 
-0000e7b0: 6275 7420 6120 6765 6f6d 6574 7279 2074  but a geometry t
-0000e7c0: 7970 6520 6973 2073 7065 6369 6669 6564  ype is specified
-0000e7d0: 2c20 7573 6520 7468 6520 7370 6563 6966  , use the specif
-0000e7e0: 6965 6420 7479 7065 0a20 2020 2020 2020  ied type.       
-0000e7f0: 2073 6368 656d 6120 3d20 6770 645f 696f   schema = gpd_io
-0000e800: 5f66 696c 652e 696e 6665 725f 7363 6865  _file.infer_sche
-0000e810: 6d61 2867 6466 290a 2020 2020 2020 2020  ma(gdf).        
-0000e820: 2320 4765 6f6d 6574 7279 2074 7970 6520  # Geometry type 
-0000e830: 6d75 7374 2062 6520 696e 2063 616d 656c  must be in camel
-0000e840: 6361 7365 2066 6f72 2066 696f 6e61 0a20  case for fiona. 
-0000e850: 2020 2020 2020 2073 6368 656d 615b 2267         schema["g
-0000e860: 656f 6d65 7472 7922 5d20 3d20 666f 7263  eometry"] = forc
-0000e870: 655f 6f75 7470 7574 5f67 656f 6d65 7472  e_output_geometr
-0000e880: 7974 7970 652e 6e61 6d65 5f63 616d 656c  ytype.name_camel
-0000e890: 6361 7365 0a20 2020 2061 7373 6572 7420  case.    assert 
-0000e8a0: 6973 696e 7374 616e 6365 2867 6466 2c20  isinstance(gdf, 
-0000e8b0: 6770 642e 4765 6f44 6174 6146 7261 6d65  gpd.GeoDataFrame
-0000e8c0: 290a 0a20 2020 2023 2043 6f6e 7665 7274  )..    # Convert
-0000e8d0: 2066 6f72 6365 5f6f 7574 7075 745f 6765   force_output_ge
-0000e8e0: 6f6d 6574 7279 7479 7065 2074 6f20 7374  ometrytype to st
-0000e8f0: 7269 6e67 2074 6f20 7369 6d70 6c69 6679  ring to simplify
-0000e900: 2063 6f64 6520 6166 7465 7277 6172 6473   code afterwards
-0000e910: 0a20 2020 2069 6620 6973 696e 7374 616e  .    if isinstan
-0000e920: 6365 2866 6f72 6365 5f6f 7574 7075 745f  ce(force_output_
-0000e930: 6765 6f6d 6574 7279 7479 7065 2c20 4765  geometrytype, Ge
-0000e940: 6f6d 6574 7279 5479 7065 293a 0a20 2020  ometryType):.   
-0000e950: 2020 2020 2066 6f72 6365 5f6f 7574 7075       force_outpu
-0000e960: 745f 6765 6f6d 6574 7279 7479 7065 203d  t_geometrytype =
-0000e970: 2066 6f72 6365 5f6f 7574 7075 745f 6765   force_output_ge
-0000e980: 6f6d 6574 7279 7479 7065 2e6e 616d 650a  ometrytype.name.
-0000e990: 0a20 2020 2023 204e 6f20 7468 6520 6669  .    # No the fi
-0000e9a0: 6c65 2063 616e 2061 6374 7561 6c6c 7920  le can actually 
-0000e9b0: 6265 2077 7269 7474 656e 0a20 2020 2023  be written.    #
-0000e9c0: 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   ---------------
-0000e9d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0000e9e0: 2d2d 2d2d 0a20 2020 2023 2046 696f 6e61  ----.    # Fiona
-0000e9f0: 2064 6f65 736e 2774 2073 7570 706f 7274   doesn't support
-0000ea00: 2074 6865 206f 7574 7075 7420 6765 6f6d   the output geom
-0000ea10: 6574 7279 7479 7065 2070 6172 616d 6574  etrytype paramet
-0000ea20: 6572 2061 7320 7573 6564 2069 6e20 6764  er as used in gd
-0000ea30: 616c 2c20 736f 2061 7320 610a 2020 2020  al, so as a.    
-0000ea40: 2320 6c69 6768 7477 6569 6768 7420 696d  # lightweight im
-0000ea50: 706c 656d 656e 7461 7469 6f6e 206a 7573  plementation jus
-0000ea60: 7420 7365 7420 666f 7263 650a 2020 2020  t set force.    
-0000ea70: 6465 6620 7772 6974 655f 746f 5f66 696c  def write_to_fil
-0000ea80: 6528 0a20 2020 2020 2020 2067 6466 3a20  e(.        gdf: 
-0000ea90: 6770 642e 4765 6f44 6174 6146 7261 6d65  gpd.GeoDataFrame
-0000eaa0: 2c0a 2020 2020 2020 2020 7061 7468 3a20  ,.        path: 
-0000eab0: 5061 7468 2c0a 2020 2020 2020 2020 6c61  Path,.        la
-0000eac0: 7965 723a 2073 7472 2c0a 2020 2020 2020  yer: str,.      
-0000ead0: 2020 696e 6465 783a 204f 7074 696f 6e61    index: Optiona
-0000eae0: 6c5b 626f 6f6c 5d20 3d20 4e6f 6e65 2c0a  l[bool] = None,.
-0000eaf0: 2020 2020 2020 2020 666f 7263 655f 6f75          force_ou
-0000eb00: 7470 7574 5f67 656f 6d65 7472 7974 7970  tput_geometrytyp
-0000eb10: 653a 204f 7074 696f 6e61 6c5b 7374 725d  e: Optional[str]
-0000eb20: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-0000eb30: 2066 6f72 6365 5f6d 756c 7469 7479 7065   force_multitype
-0000eb40: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
-0000eb50: 2020 2020 2020 2020 6170 7065 6e64 3a20          append: 
-0000eb60: 626f 6f6c 203d 2046 616c 7365 2c0a 2020  bool = False,.  
-0000eb70: 2020 2020 2020 7363 6865 6d61 3a20 4f70        schema: Op
-0000eb80: 7469 6f6e 616c 5b64 6963 745d 203d 204e  tional[dict] = N
-0000eb90: 6f6e 652c 0a20 2020 2020 2020 2063 7265  one,.        cre
-0000eba0: 6174 655f 7370 6174 6961 6c5f 696e 6465  ate_spatial_inde
-0000ebb0: 783a 204f 7074 696f 6e61 6c5b 626f 6f6c  x: Optional[bool
-0000ebc0: 5d20 3d20 5472 7565 2c0a 2020 2020 293a  ] = True,.    ):
-0000ebd0: 0a20 2020 2020 2020 2023 2050 7265 7061  .        # Prepa
-0000ebe0: 7265 2061 7267 7320 666f 7220 746f 5f66  re args for to_f
-0000ebf0: 696c 650a 2020 2020 2020 2020 6966 2061  ile.        if a
-0000ec00: 7070 656e 6420 6973 2054 7275 653a 0a20  ppend is True:. 
-0000ec10: 2020 2020 2020 2020 2020 2069 6620 7061             if pa
-0000ec20: 7468 2e65 7869 7374 7328 293a 0a20 2020  th.exists():.   
-0000ec30: 2020 2020 2020 2020 2020 2020 206d 6f64               mod
-0000ec40: 6520 3d20 2261 220a 2020 2020 2020 2020  e = "a".        
-0000ec50: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0000ec60: 2020 2020 2020 2020 2020 6d6f 6465 203d            mode =
-0000ec70: 2022 7722 0a20 2020 2020 2020 2065 6c73   "w".        els
-0000ec80: 653a 0a20 2020 2020 2020 2020 2020 206d  e:.            m
-0000ec90: 6f64 6520 3d20 2277 220a 0a20 2020 2020  ode = "w"..     
-0000eca0: 2020 206b 7761 7267 733a 2044 6963 745b     kwargs: Dict[
-0000ecb0: 7374 722c 2041 6e79 5d20 3d20 7b7d 0a20  str, Any] = {}. 
-0000ecc0: 2020 2020 2020 206b 7761 7267 735b 2265         kwargs["e
-0000ecd0: 6e67 696e 6522 5d20 3d20 2266 696f 6e61  ngine"] = "fiona
-0000ece0: 220a 2020 2020 2020 2020 6b77 6172 6773  ".        kwargs
-0000ecf0: 5b22 6d6f 6465 225d 203d 206d 6f64 650a  ["mode"] = mode.
-0000ed00: 2020 2020 2020 2020 6472 6976 6572 6e61          driverna
-0000ed10: 6d65 203d 205f 6765 6f66 696c 6569 6e66  me = _geofileinf
-0000ed20: 6f2e 6765 745f 6472 6976 6572 2870 6174  o.get_driver(pat
-0000ed30: 6829 0a20 2020 2020 2020 206b 7761 7267  h).        kwarg
-0000ed40: 735b 2264 7269 7665 7222 5d20 3d20 6472  s["driver"] = dr
-0000ed50: 6976 6572 6e61 6d65 0a20 2020 2020 2020  ivername.       
-0000ed60: 206b 7761 7267 735b 2269 6e64 6578 225d   kwargs["index"]
-0000ed70: 203d 2069 6e64 6578 0a20 2020 2020 2020   = index.       
-0000ed80: 2069 6620 6372 6561 7465 5f73 7061 7469   if create_spati
-0000ed90: 616c 5f69 6e64 6578 2069 7320 6e6f 7420  al_index is not 
-0000eda0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0000edb0: 2020 6b77 6172 6773 5b22 5350 4154 4941    kwargs["SPATIA
-0000edc0: 4c5f 494e 4445 5822 5d20 3d20 6372 6561  L_INDEX"] = crea
-0000edd0: 7465 5f73 7061 7469 616c 5f69 6e64 6578  te_spatial_index
-0000ede0: 0a20 2020 2020 2020 2069 6620 666f 7263  .        if forc
-0000edf0: 655f 6f75 7470 7574 5f67 656f 6d65 7472  e_output_geometr
-0000ee00: 7974 7970 6520 6973 206e 6f74 204e 6f6e  ytype is not Non
-0000ee10: 653a 0a20 2020 2020 2020 2020 2020 206b  e:.            k
-0000ee20: 7761 7267 735b 2267 656f 6d65 7472 7974  wargs["geometryt
-0000ee30: 7970 6522 5d20 3d20 666f 7263 655f 6f75  ype"] = force_ou
-0000ee40: 7470 7574 5f67 656f 6d65 7472 7974 7970  tput_geometrytyp
-0000ee50: 650a 2020 2020 2020 2020 6966 2073 6368  e.        if sch
-0000ee60: 656d 6120 6973 206e 6f74 204e 6f6e 653a  ema is not None:
-0000ee70: 0a20 2020 2020 2020 2020 2020 206b 7761  .            kwa
-0000ee80: 7267 735b 2273 6368 656d 6122 5d20 3d20  rgs["schema"] = 
-0000ee90: 7363 6865 6d61 0a0a 2020 2020 2020 2020  schema..        
-0000eea0: 2320 4e6f 7720 7765 2063 616e 2077 7269  # Now we can wri
-0000eeb0: 7465 0a20 2020 2020 2020 2069 6620 6472  te.        if dr
-0000eec0: 6976 6572 6e61 6d65 203d 3d20 2247 504b  ivername == "GPK
-0000eed0: 4722 3a0a 2020 2020 2020 2020 2020 2020  G":.            
-0000eee0: 2320 5472 7920 746f 2068 6172 6d6f 6e69  # Try to harmoni
-0000eef0: 7a65 2074 6865 2067 656f 6d65 7472 7974  ze the geometryt
-0000ef00: 7970 6520 746f 206f 6e65 2028 6d75 6c74  ype to one (mult
-0000ef10: 6929 7479 7065 2c20 6173 2047 504b 470a  i)type, as GPKG.
-0000ef20: 2020 2020 2020 2020 2020 2020 2320 646f              # do
-0000ef30: 6573 6e27 7420 6c69 6b65 203e 2031 2074  esn't like > 1 t
-0000ef40: 7970 6520 696e 2061 206c 6179 6572 0a20  ype in a layer. 
-0000ef50: 2020 2020 2020 2020 2020 2069 6620 7363             if sc
-0000ef60: 6865 6d61 2069 7320 4e6f 6e65 206f 7220  hema is None or 
-0000ef70: 286c 656e 2867 6466 2920 3e20 3020 616e  (len(gdf) > 0 an
-0000ef80: 6420 7363 6865 6d61 5b22 6765 6f6d 6574  d schema["geomet
-0000ef90: 7279 225d 2021 3d20 224e 6f6e 6522 293a  ry"] != "None"):
-0000efa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000efb0: 2067 6466 203d 2067 6466 2e63 6f70 7928   gdf = gdf.copy(
-0000efc0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000efd0: 2020 6764 662e 6765 6f6d 6574 7279 203d    gdf.geometry =
-0000efe0: 205f 6765 6f73 6572 6965 735f 7574 696c   _geoseries_util
-0000eff0: 2e68 6172 6d6f 6e69 7a65 5f67 656f 6d65  .harmonize_geome
-0000f000: 7472 7974 7970 6573 280a 2020 2020 2020  trytypes(.      
-0000f010: 2020 2020 2020 2020 2020 2020 2020 6764                gd
-0000f020: 662e 6765 6f6d 6574 7279 2c20 666f 7263  f.geometry, forc
-0000f030: 655f 6d75 6c74 6974 7970 653d 666f 7263  e_multitype=forc
-0000f040: 655f 6d75 6c74 6974 7970 650a 2020 2020  e_multitype.    
-0000f050: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0000f060: 2020 2020 2020 2020 2020 6764 662e 746f            gdf.to
-0000f070: 5f66 696c 6528 7374 7228 7061 7468 292c  _file(str(path),
-0000f080: 206c 6179 6572 3d6c 6179 6572 2c20 2a2a   layer=layer, **
-0000f090: 6b77 6172 6773 290a 2020 2020 2020 2020  kwargs).        
-0000f0a0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0000f0b0: 2020 6764 662e 746f 5f66 696c 6528 7374    gdf.to_file(st
-0000f0c0: 7228 7061 7468 292c 206c 6179 6572 3d6c  r(path), layer=l
-0000f0d0: 6179 6572 2c20 2a2a 6b77 6172 6773 290a  ayer, **kwargs).
-0000f0e0: 0a20 2020 2023 2049 6620 6e6f 2061 7070  .    # If no app
-0000f0f0: 656e 642c 206a 7573 7420 7772 6974 6520  end, just write 
-0000f100: 746f 206f 7574 7075 7420 7061 7468 0a20  to output path. 
-0000f110: 2020 2069 6620 6e6f 7420 6170 7065 6e64     if not append
-0000f120: 3a0a 2020 2020 2020 2020 7772 6974 655f  :.        write_
-0000f130: 746f 5f66 696c 6528 0a20 2020 2020 2020  to_file(.       
-0000f140: 2020 2020 2067 6466 3d67 6466 2c0a 2020       gdf=gdf,.  
-0000f150: 2020 2020 2020 2020 2020 7061 7468 3d70            path=p
-0000f160: 6174 682c 0a20 2020 2020 2020 2020 2020  ath,.           
-0000f170: 206c 6179 6572 3d6c 6179 6572 2c0a 2020   layer=layer,.  
-0000f180: 2020 2020 2020 2020 2020 696e 6465 783d            index=
-0000f190: 696e 6465 782c 0a20 2020 2020 2020 2020  index,.         
-0000f1a0: 2020 2066 6f72 6365 5f6f 7574 7075 745f     force_output_
-0000f1b0: 6765 6f6d 6574 7279 7479 7065 3d66 6f72  geometrytype=for
-0000f1c0: 6365 5f6f 7574 7075 745f 6765 6f6d 6574  ce_output_geomet
-0000f1d0: 7279 7479 7065 2c0a 2020 2020 2020 2020  rytype,.        
-0000f1e0: 2020 2020 666f 7263 655f 6d75 6c74 6974      force_multit
-0000f1f0: 7970 653d 666f 7263 655f 6d75 6c74 6974  ype=force_multit
-0000f200: 7970 652c 0a20 2020 2020 2020 2020 2020  ype,.           
-0000f210: 2061 7070 656e 643d 6170 7065 6e64 2c0a   append=append,.
-0000f220: 2020 2020 2020 2020 2020 2020 7363 6865              sche
-0000f230: 6d61 3d73 6368 656d 612c 0a20 2020 2020  ma=schema,.     
-0000f240: 2020 2020 2020 2063 7265 6174 655f 7370         create_sp
-0000f250: 6174 6961 6c5f 696e 6465 783d 6372 6561  atial_index=crea
-0000f260: 7465 5f73 7061 7469 616c 5f69 6e64 6578  te_spatial_index
-0000f270: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-0000f280: 656c 7365 3a0a 2020 2020 2020 2020 2320  else:.        # 
-0000f290: 4170 7065 6e64 2069 7320 6173 6b65 642c  Append is asked,
-0000f2a0: 2063 6865 636b 2069 6620 7468 6520 6669   check if the fi
-0000f2b0: 6f6e 6120 6472 6976 6572 2073 7570 706f  ona driver suppo
-0000f2c0: 7274 7320 6170 7065 6e64 696e 672e 2049  rts appending. I
-0000f2d0: 660a 2020 2020 2020 2020 2320 6e6f 742c  f.        # not,
-0000f2e0: 2077 7269 7465 2074 6f20 7465 6d70 6f72   write to tempor
-0000f2f0: 6172 7920 6f75 7470 7574 2066 696c 650a  ary output file.
-0000f300: 0a20 2020 2020 2020 2023 2052 656d 6172  .        # Remar
-0000f310: 6b3a 2066 696f 6e61 2070 7265 2d31 2e38  k: fiona pre-1.8
-0000f320: 2e31 3420 6469 646e 2774 2073 7570 706f  .14 didn't suppo
-0000f330: 7274 2061 7070 656e 6469 6e67 2074 6f20  rt appending to 
-0000f340: 6765 6f70 6163 6b61 6765 2e20 4f6e 6365  geopackage. Once
-0000f350: 0a20 2020 2020 2020 2023 206f 6c64 6572  .        # older
-0000f360: 2076 6572 7369 6f6e 7320 6265 636f 6d65   versions become
-0000f370: 7320 7261 7265 2c20 6465 7065 6e64 656e  s rare, dependen
-0000f380: 6379 2063 616e 2062 6520 7075 7420 746f  cy can be put to
-0000f390: 2074 6869 7320 7665 7273 696f 6e2c 2061   this version, a
-0000f3a0: 6e64 0a20 2020 2020 2020 2023 2074 6869  nd.        # thi
-0000f3b0: 7320 636f 6465 2063 616e 2062 6520 636c  s code can be cl
-0000f3c0: 6561 6e65 6420 7570 2e2e 2e0a 2020 2020  eaned up....    
-0000f3d0: 2020 2020 7061 7468 5f69 6e66 6f20 3d20      path_info = 
-0000f3e0: 5f67 656f 6669 6c65 696e 666f 2e67 6574  _geofileinfo.get
-0000f3f0: 5f67 656f 6669 6c65 696e 666f 2870 6174  _geofileinfo(pat
-0000f400: 6829 0a20 2020 2020 2020 2067 6466 7465  h).        gdfte
-0000f410: 6d70 5f70 6174 6820 3d20 4e6f 6e65 0a20  mp_path = None. 
-0000f420: 2020 2020 2020 2067 6466 7465 6d70 5f6c         gdftemp_l
-0000f430: 6f63 6b70 6174 6820 3d20 4e6f 6e65 0a20  ockpath = None. 
-0000f440: 2020 2020 2020 2069 6620 2261 2220 6e6f         if "a" no
-0000f450: 7420 696e 2066 696f 6e61 2e73 7570 706f  t in fiona.suppo
-0000f460: 7274 6564 5f64 7269 7665 7273 5b70 6174  rted_drivers[pat
-0000f470: 685f 696e 666f 2e64 7269 7665 725d 3a0a  h_info.driver]:.
-0000f480: 2020 2020 2020 2020 2020 2020 2320 4765              # Ge
-0000f490: 7420 6120 756e 6971 7565 2074 656d 7020  t a unique temp 
-0000f4a0: 6669 6c65 2070 6174 682e 2054 6865 2066  file path. The f
-0000f4b0: 696c 6520 6361 6e6e 6f74 2062 6520 6372  ile cannot be cr
-0000f4c0: 6561 7465 6420 7965 742c 2073 6f0a 2020  eated yet, so.  
-0000f4d0: 2020 2020 2020 2020 2020 2320 6f6e 6c79            # only
-0000f4e0: 2063 7265 6174 6520 6120 6c6f 636b 2066   create a lock f
-0000f4f0: 696c 6520 746f 2061 766f 6964 206f 7468  ile to avoid oth
-0000f500: 6572 2070 726f 6365 7373 6573 2075 7369  er processes usi
-0000f510: 6e67 2074 6865 2073 616d 650a 2020 2020  ng the same.    
-0000f520: 2020 2020 2020 2020 2320 7465 6d70 2066          # temp f
-0000f530: 696c 6520 6e61 6d65 0a20 2020 2020 2020  ile name.       
-0000f540: 2020 2020 2067 6466 7465 6d70 5f70 6174       gdftemp_pat
-0000f550: 682c 2067 6466 7465 6d70 5f6c 6f63 6b70  h, gdftemp_lockp
-0000f560: 6174 6820 3d20 5f69 6f5f 7574 696c 2e67  ath = _io_util.g
-0000f570: 6574 5f74 656d 7066 696c 655f 6c6f 636b  et_tempfile_lock
-0000f580: 6564 280a 2020 2020 2020 2020 2020 2020  ed(.            
-0000f590: 2020 2020 6261 7365 5f66 696c 656e 616d      base_filenam
-0000f5a0: 653d 2267 6466 7465 6d70 222c 2073 7566  e="gdftemp", suf
-0000f5b0: 6669 783d 7061 7468 2e73 7566 6669 782c  fix=path.suffix,
-0000f5c0: 2064 6972 6e61 6d65 3d22 6765 6f66 696c   dirname="geofil
-0000f5d0: 655f 746f 5f66 696c 6522 0a20 2020 2020  e_to_file".     
-0000f5e0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0000f5f0: 2020 2020 2077 7269 7465 5f74 6f5f 6669       write_to_fi
-0000f600: 6c65 280a 2020 2020 2020 2020 2020 2020  le(.            
-0000f610: 2020 2020 6764 662c 0a20 2020 2020 2020      gdf,.       
-0000f620: 2020 2020 2020 2020 2070 6174 683d 6764           path=gd
-0000f630: 6674 656d 705f 7061 7468 2c0a 2020 2020  ftemp_path,.    
-0000f640: 2020 2020 2020 2020 2020 2020 6c61 7965              laye
-0000f650: 723d 6c61 7965 722c 0a20 2020 2020 2020  r=layer,.       
-0000f660: 2020 2020 2020 2020 2069 6e64 6578 3d69           index=i
-0000f670: 6e64 6578 2c0a 2020 2020 2020 2020 2020  ndex,.          
-0000f680: 2020 2020 2020 666f 7263 655f 6f75 7470        force_outp
-0000f690: 7574 5f67 656f 6d65 7472 7974 7970 653d  ut_geometrytype=
-0000f6a0: 666f 7263 655f 6f75 7470 7574 5f67 656f  force_output_geo
-0000f6b0: 6d65 7472 7974 7970 652c 0a20 2020 2020  metrytype,.     
-0000f6c0: 2020 2020 2020 2020 2020 2066 6f72 6365             force
-0000f6d0: 5f6d 756c 7469 7479 7065 3d66 6f72 6365  _multitype=force
-0000f6e0: 5f6d 756c 7469 7479 7065 2c0a 2020 2020  _multitype,.    
-0000f6f0: 2020 2020 2020 2020 2020 2020 7363 6865              sche
-0000f700: 6d61 3d73 6368 656d 612c 0a20 2020 2020  ma=schema,.     
-0000f710: 2020 2020 2020 2020 2020 2063 7265 6174             creat
-0000f720: 655f 7370 6174 6961 6c5f 696e 6465 783d  e_spatial_index=
-0000f730: 6372 6561 7465 5f73 7061 7469 616c 5f69  create_spatial_i
-0000f740: 6e64 6578 2c0a 2020 2020 2020 2020 2020  ndex,.          
-0000f750: 2020 290a 0a20 2020 2020 2020 2023 2046    )..        # F
-0000f760: 696c 6573 2064 6f6e 2774 2074 7970 6963  iles don't typic
-0000f770: 616c 6c79 2073 7570 706f 7274 2068 6176  ally support hav
-0000f780: 696e 6720 6d75 6c74 6970 6c65 2070 726f  ing multiple pro
-0000f790: 6365 7373 6573 2077 7269 7469 6e67 0a20  cesses writing. 
-0000f7a0: 2020 2020 2020 2023 2073 696d 756c 7461         # simulta
-0000f7b0: 6e6f 7573 6c79 2074 6f20 7468 656d 2c20  nously to them, 
-0000f7c0: 736f 2075 7365 206c 6f63 6b20 6669 6c65  so use lock file
-0000f7d0: 2074 6f20 7379 6e63 6872 6f6e 697a 6520   to synchronize 
-0000f7e0: 6163 6365 7373 2e0a 2020 2020 2020 2020  access..        
-0000f7f0: 6c6f 636b 6669 6c65 203d 2050 6174 6828  lockfile = Path(
-0000f800: 6622 7b73 7472 2870 6174 6829 7d2e 6c6f  f"{str(path)}.lo
-0000f810: 636b 2229 0a20 2020 2020 2020 2073 7461  ck").        sta
-0000f820: 7274 5f74 696d 6520 3d20 6461 7465 7469  rt_time = dateti
-0000f830: 6d65 2e64 6174 6574 696d 652e 6e6f 7728  me.datetime.now(
-0000f840: 290a 2020 2020 2020 2020 7265 6164 7920  ).        ready 
-0000f850: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
-0000f860: 7768 696c 6520 6e6f 7420 7265 6164 793a  while not ready:
-0000f870: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0000f880: 5f69 6f5f 7574 696c 2e63 7265 6174 655f  _io_util.create_
-0000f890: 6669 6c65 5f61 746f 6d69 6328 6c6f 636b  file_atomic(lock
-0000f8a0: 6669 6c65 2920 6973 2054 7275 653a 0a20  file) is True:. 
-0000f8b0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0000f8c0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0000f8d0: 2020 2020 2020 2020 2320 4966 2067 6466          # If gdf
-0000f8e0: 2077 6173 6e27 7420 7772 6974 7465 6e20   wasn't written 
-0000f8f0: 746f 2074 656d 7020 6669 6c65 2c20 7573  to temp file, us
-0000f900: 6520 7374 616e 6461 7264 2077 7269 7465  e standard write
-0000f910: 2d74 6f2d 6669 6c65 0a20 2020 2020 2020  -to-file.       
-0000f920: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0000f930: 6764 6674 656d 705f 7061 7468 2069 7320  gdftemp_path is 
-0000f940: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0000f950: 2020 2020 2020 2020 2020 2020 2020 7772                wr
-0000f960: 6974 655f 746f 5f66 696c 6528 0a20 2020  ite_to_file(.   
-0000f970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f980: 2020 2020 2020 2020 2067 6466 3d67 6466           gdf=gdf
-0000f990: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000f9a0: 2020 2020 2020 2020 2020 2020 2020 7061                pa
-0000f9b0: 7468 3d70 6174 682c 0a20 2020 2020 2020  th=path,.       
-0000f9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f9d0: 2020 2020 206c 6179 6572 3d6c 6179 6572       layer=layer
-0000f9e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000f9f0: 2020 2020 2020 2020 2020 2020 2020 696e                in
-0000fa00: 6465 783d 696e 6465 782c 0a20 2020 2020  dex=index,.     
-0000fa10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fa20: 2020 2020 2020 2066 6f72 6365 5f6f 7574         force_out
-0000fa30: 7075 745f 6765 6f6d 6574 7279 7479 7065  put_geometrytype
-0000fa40: 3d66 6f72 6365 5f6f 7574 7075 745f 6765  =force_output_ge
-0000fa50: 6f6d 6574 7279 7479 7065 2c0a 2020 2020  ometrytype,.    
-0000fa60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fa70: 2020 2020 2020 2020 666f 7263 655f 6d75          force_mu
-0000fa80: 6c74 6974 7970 653d 666f 7263 655f 6d75  ltitype=force_mu
-0000fa90: 6c74 6974 7970 652c 0a20 2020 2020 2020  ltitype,.       
-0000faa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fab0: 2020 2020 2061 7070 656e 643d 5472 7565       append=True
-0000fac0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000fad0: 2020 2020 2020 2020 2020 2020 2020 7363                sc
-0000fae0: 6865 6d61 3d73 6368 656d 612c 0a20 2020  hema=schema,.   
-0000faf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fb00: 2020 2020 2020 2020 2063 7265 6174 655f           create_
-0000fb10: 7370 6174 6961 6c5f 696e 6465 783d 6372  spatial_index=cr
-0000fb20: 6561 7465 5f73 7061 7469 616c 5f69 6e64  eate_spatial_ind
-0000fb30: 6578 2c0a 2020 2020 2020 2020 2020 2020  ex,.            
-0000fb40: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0000fb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fb60: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0000fb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fb80: 2320 4966 2067 6466 2077 7269 7474 656e  # If gdf written
-0000fb90: 2074 6f20 7465 6d70 2066 696c 652c 2075   to temp file, u
-0000fba0: 7365 2061 7070 656e 645f 746f 5f6e 6f6c  se append_to_nol
-0000fbb0: 6f63 6b20 2b20 636c 6561 6e75 700a 2020  ock + cleanup.  
-0000fbc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fbd0: 2020 2020 2020 5f61 7070 656e 645f 746f        _append_to
-0000fbe0: 5f6e 6f6c 6f63 6b28 0a20 2020 2020 2020  _nolock(.       
-0000fbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fc00: 2020 2020 2073 7263 3d67 6466 7465 6d70       src=gdftemp
-0000fc10: 5f70 6174 682c 0a20 2020 2020 2020 2020  _path,.         
-0000fc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fc30: 2020 2064 7374 3d70 6174 682c 0a20 2020     dst=path,.   
-0000fc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fc50: 2020 2020 2020 2020 2064 7374 5f6c 6179           dst_lay
-0000fc60: 6572 3d6c 6179 6572 2c0a 2020 2020 2020  er=layer,.      
-0000fc70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fc80: 2020 2020 2020 666f 7263 655f 6f75 7470        force_outp
-0000fc90: 7574 5f67 656f 6d65 7472 7974 7970 653d  ut_geometrytype=
-0000fca0: 666f 7263 655f 6f75 7470 7574 5f67 656f  force_output_geo
-0000fcb0: 6d65 7472 7974 7970 652c 0a20 2020 2020  metrytype,.     
-0000fcc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fcd0: 2020 2020 2020 2063 7265 6174 655f 7370         create_sp
-0000fce0: 6174 6961 6c5f 696e 6465 783d 6372 6561  atial_index=crea
-0000fcf0: 7465 5f73 7061 7469 616c 5f69 6e64 6578  te_spatial_index
-0000fd00: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000fd10: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0000fd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fd30: 2020 2020 7265 6d6f 7665 2867 6466 7465      remove(gdfte
-0000fd40: 6d70 5f70 6174 6829 0a20 2020 2020 2020  mp_path).       
-0000fd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fd60: 2069 6620 6764 6674 656d 705f 6c6f 636b   if gdftemp_lock
-0000fd70: 7061 7468 2069 7320 6e6f 7420 4e6f 6e65  path is not None
-0000fd80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000fd90: 2020 2020 2020 2020 2020 2020 2020 6764                gd
-0000fda0: 6674 656d 705f 6c6f 636b 7061 7468 2e75  ftemp_lockpath.u
-0000fdb0: 6e6c 696e 6b28 290a 2020 2020 2020 2020  nlink().        
-0000fdc0: 2020 2020 2020 2020 6578 6365 7074 2045          except E
-0000fdd0: 7863 6570 7469 6f6e 2061 7320 6578 3a0a  xception as ex:.
-0000fde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fdf0: 2020 2020 2320 4966 2073 716c 6974 6520      # If sqlite 
-0000fe00: 6f75 7470 7574 2066 696c 6520 6c6f 636b  output file lock
-0000fe10: 6564 2c20 616c 736f 2072 6574 7279 0a20  ed, also retry. 
-0000fe20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fe30: 2020 2069 6620 7061 7468 5f69 6e66 6f2e     if path_info.
-0000fe40: 6973 5f73 7061 7469 616c 6974 655f 6261  is_spatialite_ba
-0000fe50: 7365 6420 616e 6420 7374 7228 6578 2920  sed and str(ex) 
-0000fe60: 6e6f 7420 696e 205b 0a20 2020 2020 2020  not in [.       
-0000fe70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fe80: 2022 6461 7461 6261 7365 2069 7320 6c6f   "database is lo
-0000fe90: 636b 6564 222c 0a20 2020 2020 2020 2020  cked",.         
-0000fea0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0000feb0: 6174 7465 6d70 7420 746f 2077 7269 7465  attempt to write
-0000fec0: 2061 2072 6561 646f 6e6c 7920 6461 7461   a readonly data
-0000fed0: 6261 7365 222c 0a20 2020 2020 2020 2020  base",.         
-0000fee0: 2020 2020 2020 2020 2020 205d 3a0a 2020             ]:.  
-0000fef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ff00: 2020 2020 2020 7261 6973 6520 6578 0a20        raise ex. 
-0000ff10: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0000ff20: 696e 616c 6c79 3a0a 2020 2020 2020 2020  inally:.        
-0000ff30: 2020 2020 2020 2020 2020 2020 7265 6164              read
-0000ff40: 7920 3d20 5472 7565 0a20 2020 2020 2020  y = True.       
-0000ff50: 2020 2020 2020 2020 2020 2020 206c 6f63               loc
-0000ff60: 6b66 696c 652e 756e 6c69 6e6b 2829 0a20  kfile.unlink(). 
-0000ff70: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0000ff80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ff90: 2074 696d 655f 7761 6974 696e 6720 3d20   time_waiting = 
-0000ffa0: 2864 6174 6574 696d 652e 6461 7465 7469  (datetime.dateti
-0000ffb0: 6d65 2e6e 6f77 2829 202d 2073 7461 7274  me.now() - start
-0000ffc0: 5f74 696d 6529 2e74 6f74 616c 5f73 6563  _time).total_sec
-0000ffd0: 6f6e 6473 2829 0a20 2020 2020 2020 2020  onds().         
-0000ffe0: 2020 2020 2020 2069 6620 7469 6d65 5f77         if time_w
-0000fff0: 6169 7469 6e67 203e 2061 7070 656e 645f  aiting > append_
-00010000: 7469 6d65 6f75 745f 733a 0a20 2020 2020  timeout_s:.     
-00010010: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00010020: 6169 7365 2052 756e 7469 6d65 4572 726f  aise RuntimeErro
-00010030: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-00010040: 2020 2020 2020 2020 2020 2066 2274 6f5f             f"to_
-00010050: 6669 6c65 2074 696d 656f 7574 206f 6620  file timeout of 
-00010060: 7b61 7070 656e 645f 7469 6d65 6f75 745f  {append_timeout_
-00010070: 737d 2072 6561 6368 6564 2c20 7374 6f70  s} reached, stop
-00010080: 2061 7070 656e 6420 220a 2020 2020 2020   append ".      
-00010090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000100a0: 2020 6622 746f 207b 7061 7468 7d21 220a    f"to {path}!".
-000100b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000100c0: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
-000100d0: 2020 2023 2053 6c65 6570 2066 6f72 2061     # Sleep for a
-000100e0: 2073 6563 6f6e 6420 6265 666f 7265 2074   second before t
-000100f0: 7279 696e 6720 6167 6169 6e0a 2020 2020  rying again.    
-00010100: 2020 2020 2020 2020 7469 6d65 2e73 6c65          time.sle
-00010110: 6570 2831 290a 0a0a 6465 6620 5f74 6f5f  ep(1)...def _to_
-00010120: 6669 6c65 5f70 796f 6772 696f 280a 2020  file_pyogrio(.  
-00010130: 2020 6764 663a 2067 7064 2e47 656f 4461    gdf: gpd.GeoDa
-00010140: 7461 4672 616d 652c 0a20 2020 2070 6174  taFrame,.    pat
-00010150: 683a 2050 6174 682c 0a20 2020 206c 6179  h: Path,.    lay
-00010160: 6572 3a20 7374 722c 0a20 2020 2066 6f72  er: str,.    for
-00010170: 6365 5f6f 7574 7075 745f 6765 6f6d 6574  ce_output_geomet
-00010180: 7279 7479 7065 3a20 556e 696f 6e5b 4765  rytype: Union[Ge
-00010190: 6f6d 6574 7279 5479 7065 2c20 7374 722c  ometryType, str,
-000101a0: 204e 6f6e 655d 203d 204e 6f6e 652c 0a20   None] = None,. 
-000101b0: 2020 2066 6f72 6365 5f6d 756c 7469 7479     force_multity
-000101c0: 7065 3a20 626f 6f6c 203d 2046 616c 7365  pe: bool = False
-000101d0: 2c0a 2020 2020 6170 7065 6e64 3a20 626f  ,.    append: bo
-000101e0: 6f6c 203d 2046 616c 7365 2c0a 2020 2020  ol = False,.    
-000101f0: 6170 7065 6e64 5f74 696d 656f 7574 5f73  append_timeout_s
-00010200: 3a20 696e 7420 3d20 3630 302c 0a20 2020  : int = 600,.   
-00010210: 2069 6e64 6578 3a20 4f70 7469 6f6e 616c   index: Optional
-00010220: 5b62 6f6f 6c5d 203d 204e 6f6e 652c 0a20  [bool] = None,. 
-00010230: 2020 2063 7265 6174 655f 7370 6174 6961     create_spatia
-00010240: 6c5f 696e 6465 783a 204f 7074 696f 6e61  l_index: Optiona
-00010250: 6c5b 626f 6f6c 5d20 3d20 5472 7565 2c0a  l[bool] = True,.
-00010260: 293a 0a20 2020 2022 2222 0a20 2020 2057  ):.    """.    W
-00010270: 7269 7465 7320 6120 7061 6e64 6173 2064  rites a pandas d
-00010280: 6174 6166 7261 6d65 2074 6f20 6669 6c65  ataframe to file
-00010290: 2075 7369 6e67 2070 796f 6772 696f 2e0a   using pyogrio..
-000102a0: 0a20 2020 2052 656d 6172 6b3a 2074 6869  .    Remark: thi
-000102b0: 7320 6675 6e63 7469 6f6e 206f 6e6c 7920  s function only 
-000102c0: 7375 7070 6f72 7473 2077 7269 7469 6e67  supports writing
-000102d0: 2047 656f 4461 7461 4672 616d 6573 2061   GeoDataFrames a
-000102e0: 7420 7468 6520 6d6f 6d65 6e74 2e0a 2020  t the moment..  
-000102f0: 2020 2222 220a 2020 2020 2320 5072 6570    """.    # Prep
-00010300: 6172 6520 6172 6773 2066 6f72 2077 7269  are args for wri
-00010310: 7465 5f64 6174 6166 7261 6d65 0a20 2020  te_dataframe.   
-00010320: 206b 7761 7267 733a 2044 6963 745b 7374   kwargs: Dict[st
-00010330: 722c 2041 6e79 5d20 3d20 7b7d 0a20 2020  r, Any] = {}.   
-00010340: 206b 7761 7267 735b 2265 6e67 696e 6522   kwargs["engine"
-00010350: 5d20 3d20 2270 796f 6772 696f 220a 0a20  ] = "pyogrio".. 
-00010360: 2020 2023 2043 6865 636b 2075 7066 726f     # Check upfro
-00010370: 6e74 2069 6620 6170 7065 6e64 2069 7320  nt if append is 
-00010380: 676f 696e 6720 746f 2077 6f72 6b20 746f  going to work to
-00010390: 2067 6976 6520 6e69 6365 2065 7272 6f72   give nice error
-000103a0: 0a20 2020 2069 6620 6170 7065 6e64 2069  .    if append i
-000103b0: 7320 5472 7565 2061 6e64 2070 6174 682e  s True and path.
-000103c0: 6578 6973 7473 2829 3a0a 2020 2020 2020  exists():.      
-000103d0: 2020 6b77 6172 6773 5b22 6170 7065 6e64    kwargs["append
-000103e0: 225d 203d 2054 7275 650a 2020 2020 2020  "] = True.      
-000103f0: 2020 6c61 7965 7269 6e66 6f20 3d20 6765    layerinfo = ge
-00010400: 745f 6c61 7965 7269 6e66 6f28 7061 7468  t_layerinfo(path
-00010410: 2c20 6c61 7965 7229 0a20 2020 2020 2020  , layer).       
-00010420: 2066 696c 655f 636f 6c73 203d 205b 636f   file_cols = [co
-00010430: 6c2e 7570 7065 7228 2920 666f 7220 636f  l.upper() for co
-00010440: 6c20 696e 206c 6179 6572 696e 666f 2e63  l in layerinfo.c
-00010450: 6f6c 756d 6e73 5d0a 2020 2020 2020 2020  olumns].        
-00010460: 6764 665f 636f 6c73 203d 205b 636f 6c2e  gdf_cols = [col.
-00010470: 7570 7065 7228 2920 666f 7220 636f 6c20  upper() for col 
-00010480: 696e 2067 6466 2e63 6f6c 756d 6e73 2069  in gdf.columns i
-00010490: 6620 636f 6c20 213d 2067 6466 2e67 656f  f col != gdf.geo
-000104a0: 6d65 7472 792e 6e61 6d65 5d0a 2020 2020  metry.name].    
-000104b0: 2020 2020 6966 2067 6466 5f63 6f6c 7320      if gdf_cols 
-000104c0: 213d 2066 696c 655f 636f 6c73 3a0a 2020  != file_cols:.  
-000104d0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-000104e0: 5661 6c75 6545 7272 6f72 280a 2020 2020  ValueError(.    
-000104f0: 2020 2020 2020 2020 2020 2020 2264 6573              "des
-00010500: 7469 6e61 7469 6f6e 206c 6179 6572 2064  tination layer d
-00010510: 6f65 736e 2774 2068 6176 6520 7468 6520  oesn't have the 
-00010520: 7361 6d65 2063 6f6c 756d 6e73 2061 7320  same columns as 
-00010530: 6764 663a 2022 0a20 2020 2020 2020 2020  gdf: ".         
-00010540: 2020 2020 2020 2066 227b 6669 6c65 5f63         f"{file_c
-00010550: 6f6c 737d 2076 7320 7b67 6466 5f63 6f6c  ols} vs {gdf_col
-00010560: 737d 220a 2020 2020 2020 2020 2020 2020  s}".            
-00010570: 290a 0a20 2020 2023 2050 7265 7061 7265  )..    # Prepare
-00010580: 206b 7761 7267 7320 746f 2075 7365 2069   kwargs to use i
-00010590: 6e20 6765 6f70 616e 6461 732e 746f 5f66  n geopandas.to_f
-000105a0: 696c 650a 2020 2020 6966 2063 7265 6174  ile.    if creat
-000105b0: 655f 7370 6174 6961 6c5f 696e 6465 7820  e_spatial_index 
-000105c0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-000105d0: 2020 2020 206b 7761 7267 735b 2253 5041       kwargs["SPA
-000105e0: 5449 414c 5f49 4e44 4558 225d 203d 2063  TIAL_INDEX"] = c
-000105f0: 7265 6174 655f 7370 6174 6961 6c5f 696e  reate_spatial_in
-00010600: 6465 780a 2020 2020 7061 7468 5f69 6e66  dex.    path_inf
-00010610: 6f20 3d20 5f67 656f 6669 6c65 696e 666f  o = _geofileinfo
-00010620: 2e67 6574 5f67 656f 6669 6c65 696e 666f  .get_geofileinfo
-00010630: 2870 6174 6829 0a20 2020 206b 7761 7267  (path).    kwarg
-00010640: 735b 2264 7269 7665 7222 5d20 3d20 7061  s["driver"] = pa
-00010650: 7468 5f69 6e66 6f2e 6472 6976 6572 0a20  th_info.driver. 
-00010660: 2020 206b 7761 7267 735b 2269 6e64 6578     kwargs["index
-00010670: 225d 203d 2069 6e64 6578 0a20 2020 2069  "] = index.    i
-00010680: 6620 6372 6561 7465 5f73 7061 7469 616c  f create_spatial
-00010690: 5f69 6e64 6578 2069 7320 6e6f 7420 4e6f  _index is not No
-000106a0: 6e65 3a0a 2020 2020 2020 2020 6b77 6172  ne:.        kwar
-000106b0: 6773 5b22 5350 4154 4941 4c5f 494e 4445  gs["SPATIAL_INDE
-000106c0: 5822 5d20 3d20 6372 6561 7465 5f73 7061  X"] = create_spa
-000106d0: 7469 616c 5f69 6e64 6578 0a20 2020 2069  tial_index.    i
-000106e0: 6620 666f 7263 655f 6f75 7470 7574 5f67  f force_output_g
-000106f0: 656f 6d65 7472 7974 7970 6520 6973 206e  eometrytype is n
-00010700: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-00010710: 2069 6620 6973 696e 7374 616e 6365 2866   if isinstance(f
-00010720: 6f72 6365 5f6f 7574 7075 745f 6765 6f6d  orce_output_geom
-00010730: 6574 7279 7479 7065 2c20 4765 6f6d 6574  etrytype, Geomet
-00010740: 7279 5479 7065 293a 0a20 2020 2020 2020  ryType):.       
-00010750: 2020 2020 2066 6f72 6365 5f6f 7574 7075       force_outpu
-00010760: 745f 6765 6f6d 6574 7279 7479 7065 203d  t_geometrytype =
-00010770: 2066 6f72 6365 5f6f 7574 7075 745f 6765   force_output_ge
-00010780: 6f6d 6574 7279 7479 7065 2e6e 616d 655f  ometrytype.name_
-00010790: 6361 6d65 6c63 6173 650a 2020 2020 2020  camelcase.      
-000107a0: 2020 6b77 6172 6773 5b22 6765 6f6d 6574    kwargs["geomet
-000107b0: 7279 5f74 7970 6522 5d20 3d20 666f 7263  ry_type"] = forc
-000107c0: 655f 6f75 7470 7574 5f67 656f 6d65 7472  e_output_geometr
-000107d0: 7974 7970 650a 2020 2020 6966 2066 6f72  ytype.    if for
-000107e0: 6365 5f6d 756c 7469 7479 7065 3a0a 2020  ce_multitype:.  
-000107f0: 2020 2020 2020 6b77 6172 6773 5b22 7072        kwargs["pr
-00010800: 6f6d 6f74 655f 746f 5f6d 756c 7469 225d  omote_to_multi"]
-00010810: 203d 2054 7275 650a 0a20 2020 2023 2054   = True..    # T
-00010820: 656d 7020 6669 7820 666f 7220 6275 6720  emp fix for bug 
-00010830: 696e 2070 796f 6772 696f 2030 2e37 2e32  in pyogrio 0.7.2
-00010840: 2028 6874 7470 733a 2f2f 6769 7468 7562   (https://github
-00010850: 2e63 6f6d 2f67 656f 7061 6e64 6173 2f70  .com/geopandas/p
-00010860: 796f 6772 696f 2f70 756c 6c2f 3332 3429  yogrio/pull/324)
-00010870: 0a20 2020 2023 204c 6f67 6963 2062 6173  .    # Logic bas
-00010880: 6564 206f 6e20 6765 6f70 616e 6461 732e  ed on geopandas.
-00010890: 746f 5f66 696c 650a 2020 2020 6966 206c  to_file.    if l
-000108a0: 6973 7428 6764 662e 696e 6465 782e 6e61  ist(gdf.index.na
-000108b0: 6d65 7329 203d 3d20 5b4e 6f6e 655d 2061  mes) == [None] a
-000108c0: 6e64 2069 735f 696e 7465 6765 725f 6474  nd is_integer_dt
-000108d0: 7970 6528 6764 662e 696e 6465 782e 6474  ype(gdf.index.dt
-000108e0: 7970 6529 3a0a 2020 2020 2020 2020 6764  ype):.        gd
-000108f0: 6620 3d20 6764 662e 7265 7365 745f 696e  f = gdf.reset_in
-00010900: 6465 7828 6472 6f70 3d54 7275 6529 0a0a  dex(drop=True)..
-00010910: 2020 2020 2320 4e6f 7720 7765 2063 616e      # Now we can
-00010920: 2077 7269 7465 0a20 2020 2069 6620 7061   write.    if pa
-00010930: 7468 5f69 6e66 6f2e 6973 5f73 696e 676c  th_info.is_singl
-00010940: 656c 6179 6572 3a0a 2020 2020 2020 2020  elayer:.        
-00010950: 6764 662e 746f 5f66 696c 6528 7374 7228  gdf.to_file(str(
-00010960: 7061 7468 292c 202a 2a6b 7761 7267 7329  path), **kwargs)
-00010970: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-00010980: 2020 2067 6466 2e74 6f5f 6669 6c65 2873     gdf.to_file(s
-00010990: 7472 2870 6174 6829 2c20 6c61 7965 723d  tr(path), layer=
-000109a0: 6c61 7965 722c 202a 2a6b 7761 7267 7329  layer, **kwargs)
-000109b0: 0a0a 0a64 6566 2067 6574 5f63 7273 2870  ...def get_crs(p
-000109c0: 6174 683a 2055 6e69 6f6e 5b73 7472 2c20  ath: Union[str, 
-000109d0: 226f 732e 5061 7468 4c69 6b65 5b41 6e79  "os.PathLike[Any
-000109e0: 5d22 5d29 202d 3e20 7079 7072 6f6a 2e43  ]"]) -> pyproj.C
-000109f0: 5253 3a0a 2020 2020 2222 220a 2020 2020  RS:.    """.    
-00010a00: 4765 7420 7468 6520 4352 5320 2870 726f  Get the CRS (pro
-00010a10: 6a65 6374 696f 6e29 206f 6620 7468 6520  jection) of the 
-00010a20: 6669 6c65 2e0a 0a20 2020 2041 7267 733a  file...    Args:
-00010a30: 0a20 2020 2020 2020 2070 6174 6820 2850  .        path (P
-00010a40: 6174 684c 696b 6529 3a20 5061 7468 2074  athLike): Path t
-00010a50: 6f20 7468 6520 6669 6c65 2e0a 0a20 2020  o the file...   
-00010a60: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
-00010a70: 2020 7079 7072 6f6a 2e43 5253 3a20 5468    pyproj.CRS: Th
-00010a80: 6520 7072 6f6a 6563 7469 6f6e 206f 6620  e projection of 
-00010a90: 7468 6520 6669 6c65 0a20 2020 2022 2222  the file.    """
-00010aa0: 0a20 2020 2023 2054 4f44 4f3a 2073 6565  .    # TODO: see
-00010ab0: 6d73 206c 696b 6520 7375 7070 6f72 7420  ms like support 
-00010ac0: 666f 7220 6d75 6c74 6970 6c65 206c 6179  for multiple lay
-00010ad0: 6572 7320 696e 2074 6865 2066 696c 6520  ers in the file 
-00010ae0: 6973 6e27 7420 6865 7265 2079 6574 3f3f  isn't here yet??
-00010af0: 3f0a 2020 2020 7769 7468 2066 696f 6e61  ?.    with fiona
-00010b00: 2e6f 7065 6e28 7374 7228 7061 7468 292c  .open(str(path),
-00010b10: 2022 7222 2920 6173 2067 656f 6669 6c65   "r") as geofile
-00010b20: 3a0a 2020 2020 2020 2020 6173 7365 7274  :.        assert
-00010b30: 2067 656f 6669 6c65 2069 7320 6e6f 7420   geofile is not 
-00010b40: 4e6f 6e65 0a20 2020 2020 2020 2072 6574  None.        ret
-00010b50: 7572 6e20 7079 7072 6f6a 2e43 5253 2867  urn pyproj.CRS(g
-00010b60: 656f 6669 6c65 2e63 7273 290a 0a0a 6465  eofile.crs)...de
-00010b70: 6620 6973 5f67 656f 6669 6c65 2870 6174  f is_geofile(pat
-00010b80: 683a 2055 6e69 6f6e 5b73 7472 2c20 226f  h: Union[str, "o
-00010b90: 732e 5061 7468 4c69 6b65 5b41 6e79 5d22  s.PathLike[Any]"
-00010ba0: 5d29 202d 3e20 626f 6f6c 3a0a 2020 2020  ]) -> bool:.    
-00010bb0: 2222 220a 2020 2020 4465 7465 726d 696e  """.    Determin
-00010bc0: 6573 2062 6173 6564 206f 6e20 7468 6520  es based on the 
-00010bd0: 6669 6c65 7061 7468 2069 6620 7468 6973  filepath if this
-00010be0: 2069 7320 6120 6765 6f66 696c 652e 0a0a   is a geofile...
-00010bf0: 2020 2020 4445 5052 4543 4154 4544 2e0a      DEPRECATED..
-00010c00: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
-00010c10: 2020 2070 6174 6820 2850 6174 684c 696b     path (PathLik
-00010c20: 6529 3a20 5468 6520 6669 6c65 2070 6174  e): The file pat
-00010c30: 682e 0a0a 2020 2020 5265 7475 726e 733a  h...    Returns:
-00010c40: 0a20 2020 2020 2020 2062 6f6f 6c3a 2054  .        bool: T
-00010c50: 7275 6520 6966 2069 7420 6973 2061 2067  rue if it is a g
-00010c60: 656f 2066 696c 652e 0a20 2020 2022 2222  eo file..    """
-00010c70: 0a20 2020 2077 6172 6e69 6e67 732e 7761  .    warnings.wa
-00010c80: 726e 280a 2020 2020 2020 2020 2269 735f  rn(.        "is_
-00010c90: 6765 6f66 696c 6520 6973 2064 6570 7265  geofile is depre
-00010ca0: 6361 7465 6420 616e 6420 7769 6c6c 2062  cated and will b
-00010cb0: 6520 7265 6d6f 7665 6420 696e 2061 2066  e removed in a f
-00010cc0: 7574 7572 6520 7665 7273 696f 6e22 2c0a  uture version",.
-00010cd0: 2020 2020 2020 2020 4675 7475 7265 5761          FutureWa
-00010ce0: 726e 696e 672c 0a20 2020 2020 2020 2073  rning,.        s
-00010cf0: 7461 636b 6c65 7665 6c3d 322c 0a20 2020  tacklevel=2,.   
-00010d00: 2029 0a20 2020 2072 6574 7572 6e20 6973   ).    return is
-00010d10: 5f67 656f 6669 6c65 5f65 7874 2850 6174  _geofile_ext(Pat
-00010d20: 6828 7061 7468 292e 7375 6666 6978 290a  h(path).suffix).
-00010d30: 0a0a 6465 6620 6973 5f67 656f 6669 6c65  ..def is_geofile
-00010d40: 5f65 7874 2866 696c 655f 6578 743a 2073  _ext(file_ext: s
-00010d50: 7472 2920 2d3e 2062 6f6f 6c3a 0a20 2020  tr) -> bool:.   
-00010d60: 2022 2222 0a20 2020 2044 6574 6572 6d69   """.    Determi
-00010d70: 6e65 7320 6261 7365 6420 6f6e 2074 6865  nes based on the
-00010d80: 2066 696c 6520 6578 7465 6e73 696f 6e20   file extension 
-00010d90: 6966 2074 6869 7320 6973 2061 2067 656f  if this is a geo
-00010da0: 6669 6c65 2e0a 0a20 2020 2044 4550 5245  file...    DEPRE
-00010db0: 4341 5445 442e 0a0a 2020 2020 4172 6773  CATED...    Args
-00010dc0: 3a0a 2020 2020 2020 2020 6669 6c65 5f65  :.        file_e
-00010dd0: 7874 2028 7374 7229 3a20 7468 6520 6578  xt (str): the ex
-00010de0: 7465 6e73 696f 6e2e 0a0a 2020 2020 5265  tension...    Re
-00010df0: 7475 726e 733a 0a20 2020 2020 2020 2062  turns:.        b
-00010e00: 6f6f 6c3a 2054 7275 6520 6966 2069 7420  ool: True if it 
-00010e10: 6973 2061 2067 656f 6669 6c65 2e0a 2020  is a geofile..  
-00010e20: 2020 2222 220a 2020 2020 7761 726e 696e    """.    warnin
-00010e30: 6773 2e77 6172 6e28 0a20 2020 2020 2020  gs.warn(.       
-00010e40: 2022 6973 5f67 656f 6669 6c65 5f65 7874   "is_geofile_ext
-00010e50: 2069 7320 6465 7072 6563 6174 6564 2061   is deprecated a
-00010e60: 6e64 2077 696c 6c20 6265 2072 656d 6f76  nd will be remov
-00010e70: 6564 2069 6e20 6120 6675 7475 7265 2076  ed in a future v
-00010e80: 6572 7369 6f6e 222c 0a20 2020 2020 2020  ersion",.       
-00010e90: 2046 7574 7572 6557 6172 6e69 6e67 2c0a   FutureWarning,.
-00010ea0: 2020 2020 2020 2020 7374 6163 6b6c 6576          stacklev
-00010eb0: 656c 3d32 2c0a 2020 2020 290a 2020 2020  el=2,.    ).    
-00010ec0: 7472 793a 0a20 2020 2020 2020 2023 2049  try:.        # I
-00010ed0: 6620 7468 6520 6472 6976 6572 2063 616e  f the driver can
-00010ee0: 2062 6520 6465 7465 726d 696e 6564 2c20   be determined, 
-00010ef0: 6974 2069 7320 6120 2873 7570 706f 7274  it is a (support
-00010f00: 6564 2920 6765 6f20 6669 6c65 2e0a 2020  ed) geo file..  
-00010f10: 2020 2020 2020 5f20 3d20 5f67 656f 6669        _ = _geofi
-00010f20: 6c65 696e 666f 2e47 656f 6669 6c65 5479  leinfo.GeofileTy
-00010f30: 7065 2866 696c 655f 6578 7429 0a20 2020  pe(file_ext).   
-00010f40: 2020 2020 2072 6574 7572 6e20 5472 7565       return True
-00010f50: 0a20 2020 2065 7863 6570 7420 4578 6365  .    except Exce
-00010f60: 7074 696f 6e3a 0a20 2020 2020 2020 2072  ption:.        r
-00010f70: 6574 7572 6e20 4661 6c73 650a 0a0a 6465  eturn False...de
-00010f80: 6620 636d 7028 0a20 2020 2070 6174 6831  f cmp(.    path1
-00010f90: 3a20 556e 696f 6e5b 7374 722c 2022 6f73  : Union[str, "os
-00010fa0: 2e50 6174 684c 696b 655b 416e 795d 225d  .PathLike[Any]"]
-00010fb0: 2c20 7061 7468 323a 2055 6e69 6f6e 5b73  , path2: Union[s
-00010fc0: 7472 2c20 226f 732e 5061 7468 4c69 6b65  tr, "os.PathLike
-00010fd0: 5b41 6e79 5d22 5d0a 2920 2d3e 2062 6f6f  [Any]"].) -> boo
-00010fe0: 6c3a 0a20 2020 2022 2222 0a20 2020 2043  l:.    """.    C
-00010ff0: 6f6d 7061 7265 2069 6620 7477 6f20 6765  ompare if two ge
-00011000: 6f66 696c 6573 2061 7265 2069 6465 6e74  ofiles are ident
-00011010: 6963 616c 2e0a 0a20 2020 2046 6f72 2067  ical...    For g
-00011020: 656f 6669 6c65 7320 7468 6174 2075 7365  eofiles that use
-00011030: 206d 756c 7469 706c 6520 6669 6c65 732c   multiple files,
-00011040: 2061 6c6c 2072 656c 6576 616e 7420 6669   all relevant fi
-00011050: 6c65 7320 6d75 7374 2062 6520 6964 656e  les must be iden
-00011060: 7469 6361 6c2e 0a20 2020 2045 672e 2066  tical..    Eg. f
-00011070: 6f72 2073 6861 7065 6669 6c65 732c 2074  or shapefiles, t
-00011080: 6865 202e 7368 702c 202e 7368 7820 616e  he .shp, .shx an
-00011090: 6420 2e64 6266 2066 696c 6520 6d75 7374  d .dbf file must
-000110a0: 2062 6520 6964 656e 7469 6361 6c2e 0a0a   be identical...
-000110b0: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
-000110c0: 2020 7061 7468 3120 2850 6174 684c 696b    path1 (PathLik
-000110d0: 6529 3a20 7061 7468 2074 6f20 7468 6520  e): path to the 
-000110e0: 6669 7273 7420 6669 6c65 2e0a 2020 2020  first file..    
-000110f0: 2020 2020 7061 7468 3220 2850 6174 684c      path2 (PathL
-00011100: 696b 6529 3a20 7061 7468 2074 6f20 7468  ike): path to th
-00011110: 6520 7365 636f 6e64 2066 696c 652e 0a0a  e second file...
-00011120: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
-00011130: 2020 2020 2062 6f6f 6c3a 2054 7275 6520       bool: True 
-00011140: 6966 2074 6865 2066 696c 6573 2061 7265  if the files are
-00011150: 2069 6465 6e74 6963 616c 0a20 2020 2022   identical.    "
-00011160: 2222 0a20 2020 2023 2043 6865 636b 2069  "".    # Check i
-00011170: 6e70 7574 2070 6172 616d 6574 6572 730a  nput parameters.
-00011180: 2020 2020 7061 7468 3120 3d20 5061 7468      path1 = Path
-00011190: 2870 6174 6831 290a 2020 2020 7061 7468  (path1).    path
-000111a0: 3220 3d20 5061 7468 2870 6174 6832 290a  2 = Path(path2).
-000111b0: 0a20 2020 2023 2046 6f72 2061 2073 6861  .    # For a sha
-000111c0: 7065 6669 6c65 2c20 6d75 6c74 6970 6c65  pefile, multiple
-000111d0: 2066 696c 6573 206e 6565 6420 746f 2062   files need to b
-000111e0: 6520 636f 6d70 6172 6564 0a20 2020 2069  e compared.    i
-000111f0: 6620 7061 7468 312e 7375 6666 6978 2e6c  f path1.suffix.l
-00011200: 6f77 6572 2829 203d 3d20 222e 7368 7022  ower() == ".shp"
-00011210: 3a0a 2020 2020 2020 2020 7368 6170 6566  :.        shapef
-00011220: 696c 655f 6261 7365 5f73 7566 6669 7865  ile_base_suffixe
-00011230: 7320 3d20 5b22 2e73 6870 222c 2022 2e64  s = [".shp", ".d
-00011240: 6266 222c 2022 2e73 6878 225d 0a20 2020  bf", ".shx"].   
-00011250: 2020 2020 2066 6f72 2073 7566 6669 7820       for suffix 
-00011260: 696e 2073 6861 7065 6669 6c65 5f62 6173  in shapefile_bas
-00011270: 655f 7375 6666 6978 6573 3a0a 2020 2020  e_suffixes:.    
-00011280: 2020 2020 2020 2020 6966 206e 6f74 2066          if not f
-00011290: 696c 6563 6d70 2e63 6d70 2870 6174 6831  ilecmp.cmp(path1
-000112a0: 2e77 6974 685f 7375 6666 6978 2873 7566  .with_suffix(suf
-000112b0: 6669 7829 2c20 7061 7468 322e 7769 7468  fix), path2.with
-000112c0: 5f73 7566 6669 7828 7375 6666 6978 2929  _suffix(suffix))
-000112d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000112e0: 2020 6c6f 6767 6572 2e69 6e66 6f28 0a20    logger.info(. 
-000112f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011300: 2020 2066 2246 696c 6520 7b70 6174 6831     f"File {path1
-00011310: 2e77 6974 685f 7375 6666 6978 2873 7566  .with_suffix(suf
-00011320: 6669 7829 7d20 6973 2064 6966 6665 7265  fix)} is differe
-00011330: 6e74 2066 726f 6d20 220a 2020 2020 2020  nt from ".      
-00011340: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-00011350: 7b70 6174 6832 2e77 6974 685f 7375 6666  {path2.with_suff
-00011360: 6978 2873 7566 6669 7829 7d22 0a20 2020  ix(suffix)}".   
-00011370: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-00011380: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00011390: 6574 7572 6e20 4661 6c73 650a 2020 2020  eturn False.    
-000113a0: 2020 2020 7265 7475 726e 2054 7275 650a      return True.
-000113b0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-000113c0: 2020 7265 7475 726e 2066 696c 6563 6d70    return filecmp
-000113d0: 2e63 6d70 2873 7472 2870 6174 6831 292c  .cmp(str(path1),
-000113e0: 2073 7472 2870 6174 6832 2929 0a0a 0a64   str(path2))...d
-000113f0: 6566 2063 6f70 7928 7372 633a 2055 6e69  ef copy(src: Uni
-00011400: 6f6e 5b73 7472 2c20 226f 732e 5061 7468  on[str, "os.Path
-00011410: 4c69 6b65 5b41 6e79 5d22 5d2c 2064 7374  Like[Any]"], dst
-00011420: 3a20 556e 696f 6e5b 7374 722c 2022 6f73  : Union[str, "os
-00011430: 2e50 6174 684c 696b 655b 416e 795d 225d  .PathLike[Any]"]
-00011440: 293a 0a20 2020 2022 2222 0a20 2020 2043  ):.    """.    C
-00011450: 6f70 6965 7320 7468 6520 6765 6f66 696c  opies the geofil
-00011460: 6520 6672 6f6d 2073 7263 2074 6f20 6473  e from src to ds
-00011470: 742e 0a0a 2020 2020 4966 2074 6865 2073  t...    If the s
-00011480: 6f75 7263 6520 6669 6c65 2069 7320 6120  ource file is a 
-00011490: 6765 6f66 696c 6520 636f 6e74 6169 6e69  geofile containi
-000114a0: 6e67 206f 6620 6d75 6c74 6970 6c65 2066  ng of multiple f
-000114b0: 696c 6573 2028 6567 2e20 2e73 6870 2920  iles (eg. .shp) 
-000114c0: 616c 6c20 6669 6c65 730a 2020 2020 6172  all files.    ar
-000114d0: 6520 636f 7069 6564 2e0a 0a20 2020 2041  e copied...    A
-000114e0: 7267 733a 0a20 2020 2020 2020 2073 7263  rgs:.        src
-000114f0: 2028 5061 7468 4c69 6b65 293a 2074 6865   (PathLike): the
-00011500: 2066 696c 6520 746f 2063 6f70 792e 0a20   file to copy.. 
-00011510: 2020 2020 2020 2064 7374 2028 5061 7468         dst (Path
-00011520: 4c69 6b65 293a 2074 6865 206c 6f63 6174  Like): the locat
-00011530: 696f 6e20 746f 2063 6f70 7920 7468 6520  ion to copy the 
-00011540: 6669 6c65 2873 2920 746f 2e0a 2020 2020  file(s) to..    
-00011550: 2222 220a 2020 2020 2320 4368 6563 6b20  """.    # Check 
-00011560: 696e 7075 7420 7061 7261 6d65 7465 7273  input parameters
-00011570: 0a20 2020 2073 7263 203d 2050 6174 6828  .    src = Path(
-00011580: 7372 6329 0a20 2020 2064 7374 203d 2050  src).    dst = P
-00011590: 6174 6828 6473 7429 0a20 2020 2073 7263  ath(dst).    src
-000115a0: 5f69 6e66 6f20 3d20 5f67 656f 6669 6c65  _info = _geofile
-000115b0: 696e 666f 2e67 6574 5f67 656f 6669 6c65  info.get_geofile
-000115c0: 696e 666f 2873 7263 290a 0a20 2020 2023  info(src)..    #
-000115d0: 2043 6f70 7920 7468 6520 6d61 696e 2066   Copy the main f
-000115e0: 696c 650a 2020 2020 7368 7574 696c 2e63  ile.    shutil.c
-000115f0: 6f70 7928 7374 7228 7372 6329 2c20 6473  opy(str(src), ds
-00011600: 7429 0a0a 2020 2020 2320 466f 7220 736f  t)..    # For so
-00011610: 6d65 2066 696c 6520 7479 7065 732c 2065  me file types, e
-00011620: 7874 7261 2066 696c 6573 206e 6565 6420  xtra files need 
-00011630: 746f 2062 6520 636f 7069 6564 0a20 2020  to be copied.   
-00011640: 2023 2049 6620 6465 7374 2069 7320 6120   # If dest is a 
-00011650: 6469 722c 206a 7573 7420 7573 6520 6d6f  dir, just use mo
-00011660: 7665 2e20 4f74 6865 7277 6973 6520 636f  ve. Otherwise co
-00011670: 6e63 6174 2064 6573 7420 6669 6c65 7061  ncat dest filepa
-00011680: 7468 730a 2020 2020 6966 2073 7263 5f69  ths.    if src_i
-00011690: 6e66 6f2e 7375 6666 6978 6573 5f65 7874  nfo.suffixes_ext
-000116a0: 7261 6669 6c65 7320 6973 206e 6f74 204e  rafiles is not N
-000116b0: 6f6e 653a 0a20 2020 2020 2020 2069 6620  one:.        if 
-000116c0: 6473 742e 6973 5f64 6972 2829 3a0a 2020  dst.is_dir():.  
-000116d0: 2020 2020 2020 2020 2020 666f 7220 7375            for su
-000116e0: 6666 6978 2069 6e20 7372 635f 696e 666f  ffix in src_info
-000116f0: 2e73 7566 6669 7865 735f 6578 7472 6166  .suffixes_extraf
-00011700: 696c 6573 3a0a 2020 2020 2020 2020 2020  iles:.          
-00011710: 2020 2020 2020 7372 6366 696c 6520 3d20        srcfile = 
-00011720: 7372 632e 7061 7265 6e74 202f 2066 227b  src.parent / f"{
-00011730: 7372 632e 7374 656d 7d7b 7375 6666 6978  src.stem}{suffix
-00011740: 7d22 0a20 2020 2020 2020 2020 2020 2020  }".             
-00011750: 2020 2069 6620 7372 6366 696c 652e 6578     if srcfile.ex
-00011760: 6973 7473 2829 3a0a 2020 2020 2020 2020  ists():.        
-00011770: 2020 2020 2020 2020 2020 2020 7368 7574              shut
-00011780: 696c 2e63 6f70 7928 7374 7228 7372 6366  il.copy(str(srcf
-00011790: 696c 6529 2c20 6473 7429 0a20 2020 2020  ile), dst).     
-000117a0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000117b0: 2020 2020 2066 6f72 2073 7566 6669 7820       for suffix 
-000117c0: 696e 2073 7263 5f69 6e66 6f2e 7375 6666  in src_info.suff
-000117d0: 6978 6573 5f65 7874 7261 6669 6c65 733a  ixes_extrafiles:
-000117e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000117f0: 2073 7263 6669 6c65 203d 2073 7263 2e70   srcfile = src.p
-00011800: 6172 656e 7420 2f20 6622 7b73 7263 2e73  arent / f"{src.s
-00011810: 7465 6d7d 7b73 7566 6669 787d 220a 2020  tem}{suffix}".  
-00011820: 2020 2020 2020 2020 2020 2020 2020 6473                ds
-00011830: 7466 696c 6520 3d20 6473 742e 7061 7265  tfile = dst.pare
-00011840: 6e74 202f 2066 227b 6473 742e 7374 656d  nt / f"{dst.stem
-00011850: 7d7b 7375 6666 6978 7d22 0a20 2020 2020  }{suffix}".     
-00011860: 2020 2020 2020 2020 2020 2069 6620 7372             if sr
-00011870: 6366 696c 652e 6578 6973 7473 2829 3a0a  cfile.exists():.
-00011880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011890: 2020 2020 7368 7574 696c 2e63 6f70 7928      shutil.copy(
-000118a0: 7374 7228 7372 6366 696c 6529 2c20 6473  str(srcfile), ds
-000118b0: 7466 696c 6529 0a0a 0a64 6566 206d 6f76  tfile)...def mov
-000118c0: 6528 7372 633a 2055 6e69 6f6e 5b73 7472  e(src: Union[str
-000118d0: 2c20 226f 732e 5061 7468 4c69 6b65 5b41  , "os.PathLike[A
-000118e0: 6e79 5d22 5d2c 2064 7374 3a20 556e 696f  ny]"], dst: Unio
-000118f0: 6e5b 7374 722c 2022 6f73 2e50 6174 684c  n[str, "os.PathL
-00011900: 696b 655b 416e 795d 225d 293a 0a20 2020  ike[Any]"]):.   
-00011910: 2022 2222 0a20 2020 204d 6f76 6573 2074   """.    Moves t
-00011920: 6865 2067 656f 6669 6c65 2066 726f 6d20  he geofile from 
-00011930: 7372 6320 746f 2064 7374 2e0a 0a20 2020  src to dst...   
-00011940: 2049 6620 7468 6520 736f 7572 6365 2066   If the source f
-00011950: 696c 6520 6973 2061 2067 656f 6669 6c65  ile is a geofile
-00011960: 2063 6f6e 7461 696e 696e 6720 6f66 206d   containing of m
-00011970: 756c 7469 706c 6520 6669 6c65 7320 2865  ultiple files (e
-00011980: 672e 202e 7368 7029 2061 6c6c 2066 696c  g. .shp) all fil
-00011990: 6573 0a20 2020 2061 7265 206d 6f76 6564  es.    are moved
-000119a0: 2e0a 0a20 2020 2041 7267 733a 0a20 2020  ...    Args:.   
-000119b0: 2020 2020 2073 7263 2028 5061 7468 4c69       src (PathLi
-000119c0: 6b65 293a 2074 6865 2066 696c 6520 746f  ke): the file to
-000119d0: 206d 6f76 650a 2020 2020 2020 2020 6473   move.        ds
-000119e0: 7420 2850 6174 684c 696b 6529 3a20 7468  t (PathLike): th
-000119f0: 6520 6c6f 6361 7469 6f6e 2074 6f20 6d6f  e location to mo
-00011a00: 7665 2074 6865 2066 696c 6528 7329 2074  ve the file(s) t
-00011a10: 6f0a 2020 2020 2222 220a 2020 2020 2320  o.    """.    # 
-00011a20: 4368 6563 6b20 696e 7075 7420 7061 7261  Check input para
-00011a30: 6d65 7465 7273 0a20 2020 2073 7263 203d  meters.    src =
-00011a40: 2050 6174 6828 7372 6329 0a20 2020 2064   Path(src).    d
-00011a50: 7374 203d 2050 6174 6828 6473 7429 0a20  st = Path(dst). 
-00011a60: 2020 2073 7263 5f69 6e66 6f20 3d20 5f67     src_info = _g
-00011a70: 656f 6669 6c65 696e 666f 2e67 6574 5f67  eofileinfo.get_g
-00011a80: 656f 6669 6c65 696e 666f 2873 7263 290a  eofileinfo(src).
-00011a90: 0a20 2020 2023 204d 6f76 6520 7468 6520  .    # Move the 
-00011aa0: 6d61 696e 2066 696c 650a 2020 2020 7368  main file.    sh
-00011ab0: 7574 696c 2e6d 6f76 6528 7374 7228 7372  util.move(str(sr
-00011ac0: 6329 2c20 6473 7429 0a0a 2020 2020 2320  c), dst)..    # 
-00011ad0: 466f 7220 736f 6d65 2066 696c 6520 7479  For some file ty
-00011ae0: 7065 732c 2065 7874 7261 2066 696c 6573  pes, extra files
-00011af0: 206e 6565 6420 746f 2062 6520 6d6f 7665   need to be move
-00011b00: 640a 2020 2020 2320 4966 2064 6573 7420  d.    # If dest 
-00011b10: 6973 2061 2064 6972 2c20 6a75 7374 2075  is a dir, just u
-00011b20: 7365 206d 6f76 652e 204f 7468 6572 7769  se move. Otherwi
-00011b30: 7365 2063 6f6e 6361 7420 6465 7374 2066  se concat dest f
-00011b40: 696c 6570 6174 6873 0a20 2020 2069 6620  ilepaths.    if 
-00011b50: 7372 635f 696e 666f 2e73 7566 6669 7865  src_info.suffixe
-00011b60: 735f 6578 7472 6166 696c 6573 2069 7320  s_extrafiles is 
-00011b70: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00011b80: 2020 6966 2064 7374 2e69 735f 6469 7228    if dst.is_dir(
-00011b90: 293a 0a20 2020 2020 2020 2020 2020 2066  ):.            f
-00011ba0: 6f72 2073 7566 6669 7820 696e 2073 7263  or suffix in src
-00011bb0: 5f69 6e66 6f2e 7375 6666 6978 6573 5f65  _info.suffixes_e
-00011bc0: 7874 7261 6669 6c65 733a 0a20 2020 2020  xtrafiles:.     
-00011bd0: 2020 2020 2020 2020 2020 2073 7263 6669             srcfi
-00011be0: 6c65 203d 2073 7263 2e70 6172 656e 7420  le = src.parent 
-00011bf0: 2f20 6622 7b73 7263 2e73 7465 6d7d 7b73  / f"{src.stem}{s
-00011c00: 7566 6669 787d 220a 2020 2020 2020 2020  uffix}".        
-00011c10: 2020 2020 2020 2020 6966 2073 7263 6669          if srcfi
-00011c20: 6c65 2e65 7869 7374 7328 293a 0a20 2020  le.exists():.   
-00011c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011c40: 2073 6875 7469 6c2e 6d6f 7665 2873 7472   shutil.move(str
-00011c50: 2873 7263 6669 6c65 292c 2064 7374 290a  (srcfile), dst).
-00011c60: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00011c70: 2020 2020 2020 2020 2020 666f 7220 7375            for su
-00011c80: 6666 6978 2069 6e20 7372 635f 696e 666f  ffix in src_info
-00011c90: 2e73 7566 6669 7865 735f 6578 7472 6166  .suffixes_extraf
-00011ca0: 696c 6573 3a0a 2020 2020 2020 2020 2020  iles:.          
-00011cb0: 2020 2020 2020 7372 6366 696c 6520 3d20        srcfile = 
-00011cc0: 7372 632e 7061 7265 6e74 202f 2066 227b  src.parent / f"{
-00011cd0: 7372 632e 7374 656d 7d7b 7375 6666 6978  src.stem}{suffix
-00011ce0: 7d22 0a20 2020 2020 2020 2020 2020 2020  }".             
-00011cf0: 2020 2064 7374 6669 6c65 203d 2064 7374     dstfile = dst
-00011d00: 2e70 6172 656e 7420 2f20 6622 7b64 7374  .parent / f"{dst
-00011d10: 2e73 7465 6d7d 7b73 7566 6669 787d 220a  .stem}{suffix}".
-00011d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011d30: 6966 2073 7263 6669 6c65 2e65 7869 7374  if srcfile.exist
-00011d40: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-00011d50: 2020 2020 2020 2020 2073 6875 7469 6c2e           shutil.
-00011d60: 6d6f 7665 2873 7472 2873 7263 6669 6c65  move(str(srcfile
-00011d70: 292c 2064 7374 6669 6c65 290a 0a0a 6465  ), dstfile)...de
-00011d80: 6620 7265 6d6f 7665 2870 6174 683a 2055  f remove(path: U
-00011d90: 6e69 6f6e 5b73 7472 2c20 226f 732e 5061  nion[str, "os.Pa
-00011da0: 7468 4c69 6b65 5b41 6e79 5d22 5d2c 206d  thLike[Any]"], m
-00011db0: 6973 7369 6e67 5f6f 6b3a 2062 6f6f 6c20  issing_ok: bool 
-00011dc0: 3d20 4661 6c73 6529 3a0a 2020 2020 2222  = False):.    ""
-00011dd0: 220a 2020 2020 5265 6d6f 7665 7320 7468  ".    Removes th
-00011de0: 6520 6765 6f66 696c 652e 0a0a 2020 2020  e geofile...    
-00011df0: 4973 2069 7420 6973 2061 2067 656f 6669  Is it is a geofi
-00011e00: 6c65 2063 6f6d 706f 7365 6420 6f66 206d  le composed of m
-00011e10: 756c 7469 706c 6520 6669 6c65 7320 2865  ultiple files (e
-00011e20: 672e 202e 7368 7029 2061 6c6c 2066 696c  g. .shp) all fil
-00011e30: 6573 2061 7265 2072 656d 6f76 6564 2e0a  es are removed..
-00011e40: 2020 2020 4966 202e 6c6f 636b 2066 696c      If .lock fil
-00011e50: 6573 2061 7265 2070 7265 7365 6e74 2c20  es are present, 
-00011e60: 7468 6579 2061 7265 2072 656d 6f76 6564  they are removed
-00011e70: 2061 7320 7765 6c6c 2e0a 0a20 2020 2041   as well...    A
-00011e80: 7267 733a 0a20 2020 2020 2020 2070 6174  rgs:.        pat
-00011e90: 6820 2850 6174 684c 696b 6529 3a20 7468  h (PathLike): th
-00011ea0: 6520 6669 6c65 2074 6f20 7265 6d6f 7665  e file to remove
-00011eb0: 0a20 2020 2020 2020 206d 6973 7369 6e67  .        missing
-00011ec0: 5f6f 6b20 2862 6f6f 6c2c 206f 7074 696f  _ok (bool, optio
-00011ed0: 6e61 6c29 3a20 5472 7565 206e 6f74 2074  nal): True not t
-00011ee0: 6f20 6769 7665 2061 6e20 6572 726f 7220  o give an error 
-00011ef0: 6966 2074 6865 2066 696c 6520 746f 2062  if the file to b
-00011f00: 6520 7265 6d6f 7665 640a 2020 2020 2020  e removed.      
-00011f10: 2020 2020 2020 646f 6573 6e27 7420 6578        doesn't ex
-00011f20: 6973 742e 2044 6566 6175 6c74 7320 746f  ist. Defaults to
-00011f30: 2046 616c 7365 2e0a 2020 2020 2222 220a   False..    """.
-00011f40: 2020 2020 2320 4368 6563 6b20 696e 7075      # Check inpu
-00011f50: 7420 7061 7261 6d65 7465 7273 0a20 2020  t parameters.   
-00011f60: 2070 6174 6820 3d20 5061 7468 2870 6174   path = Path(pat
-00011f70: 6829 0a20 2020 2070 6174 685f 696e 666f  h).    path_info
-00011f80: 203d 205f 6765 6f66 696c 6569 6e66 6f2e   = _geofileinfo.
-00011f90: 6765 745f 6765 6f66 696c 6569 6e66 6f28  get_geofileinfo(
-00011fa0: 7061 7468 290a 0a20 2020 2023 2049 6620  path)..    # If 
-00011fb0: 7468 6572 6520 6973 2061 206c 6f63 6b20  there is a lock 
-00011fc0: 6669 6c65 2c20 7265 6d6f 7665 2069 740a  file, remove it.
-00011fd0: 2020 2020 6c6f 636b 6669 6c65 5f70 6174      lockfile_pat
-00011fe0: 6820 3d20 7061 7468 2e70 6172 656e 7420  h = path.parent 
-00011ff0: 2f20 6622 7b70 6174 682e 6e61 6d65 7d2e  / f"{path.name}.
-00012000: 6c6f 636b 220a 2020 2020 6c6f 636b 6669  lock".    lockfi
-00012010: 6c65 5f70 6174 682e 756e 6c69 6e6b 286d  le_path.unlink(m
-00012020: 6973 7369 6e67 5f6f 6b3d 5472 7565 290a  issing_ok=True).
-00012030: 0a20 2020 2023 2052 656d 6f76 6520 7468  .    # Remove th
-00012040: 6520 6d61 696e 2066 696c 650a 2020 2020  e main file.    
-00012050: 6966 2070 6174 682e 6578 6973 7473 2829  if path.exists()
-00012060: 3a0a 2020 2020 2020 2020 7061 7468 2e75  :.        path.u
-00012070: 6e6c 696e 6b28 6d69 7373 696e 675f 6f6b  nlink(missing_ok
-00012080: 3d6d 6973 7369 6e67 5f6f 6b29 0a0a 2020  =missing_ok)..  
-00012090: 2020 2320 466f 7220 736f 6d65 2066 696c    # For some fil
-000120a0: 6520 7479 7065 732c 2065 7874 7261 2066  e types, extra f
-000120b0: 696c 6573 206e 6565 6420 746f 2062 6520  iles need to be 
-000120c0: 7265 6d6f 7665 640a 2020 2020 6966 2070  removed.    if p
-000120d0: 6174 685f 696e 666f 2e73 7566 6669 7865  ath_info.suffixe
-000120e0: 735f 6578 7472 6166 696c 6573 2069 7320  s_extrafiles is 
-000120f0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00012100: 2020 666f 7220 7375 6666 6978 2069 6e20    for suffix in 
-00012110: 7061 7468 5f69 6e66 6f2e 7375 6666 6978  path_info.suffix
-00012120: 6573 5f65 7874 7261 6669 6c65 733a 0a20  es_extrafiles:. 
-00012130: 2020 2020 2020 2020 2020 2063 7572 725f             curr_
-00012140: 7061 7468 203d 2070 6174 682e 7061 7265  path = path.pare
-00012150: 6e74 202f 2066 227b 7061 7468 2e73 7465  nt / f"{path.ste
-00012160: 6d7d 7b73 7566 6669 787d 220a 2020 2020  m}{suffix}".    
-00012170: 2020 2020 2020 2020 6375 7272 5f70 6174          curr_pat
-00012180: 682e 756e 6c69 6e6b 286d 6973 7369 6e67  h.unlink(missing
-00012190: 5f6f 6b3d 5472 7565 290a 0a0a 6465 6620  _ok=True)...def 
-000121a0: 6170 7065 6e64 5f74 6f28 0a20 2020 2073  append_to(.    s
-000121b0: 7263 3a20 556e 696f 6e5b 7374 722c 2022  rc: Union[str, "
-000121c0: 6f73 2e50 6174 684c 696b 655b 416e 795d  os.PathLike[Any]
-000121d0: 225d 2c0a 2020 2020 6473 743a 2055 6e69  "],.    dst: Uni
-000121e0: 6f6e 5b73 7472 2c20 226f 732e 5061 7468  on[str, "os.Path
-000121f0: 4c69 6b65 5b41 6e79 5d22 5d2c 0a20 2020  Like[Any]"],.   
-00012200: 2073 7263 5f6c 6179 6572 3a20 4f70 7469   src_layer: Opti
-00012210: 6f6e 616c 5b73 7472 5d20 3d20 4e6f 6e65  onal[str] = None
-00012220: 2c0a 2020 2020 6473 745f 6c61 7965 723a  ,.    dst_layer:
-00012230: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
-00012240: 204e 6f6e 652c 0a20 2020 2073 7263 5f63   None,.    src_c
-00012250: 7273 3a20 556e 696f 6e5b 696e 742c 2073  rs: Union[int, s
-00012260: 7472 2c20 4e6f 6e65 5d20 3d20 4e6f 6e65  tr, None] = None
-00012270: 2c0a 2020 2020 6473 745f 6372 733a 2055  ,.    dst_crs: U
-00012280: 6e69 6f6e 5b69 6e74 2c20 7374 722c 204e  nion[int, str, N
-00012290: 6f6e 655d 203d 204e 6f6e 652c 0a20 2020  one] = None,.   
-000122a0: 2063 6f6c 756d 6e73 3a20 4f70 7469 6f6e   columns: Option
-000122b0: 616c 5b49 7465 7261 626c 655b 7374 725d  al[Iterable[str]
-000122c0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 7768  ] = None,.    wh
-000122d0: 6572 653a 204f 7074 696f 6e61 6c5b 7374  ere: Optional[st
-000122e0: 725d 203d 204e 6f6e 652c 0a20 2020 2073  r] = None,.    s
-000122f0: 716c 5f73 746d 743a 204f 7074 696f 6e61  ql_stmt: Optiona
-00012300: 6c5b 7374 725d 203d 204e 6f6e 652c 0a20  l[str] = None,. 
-00012310: 2020 2073 716c 5f64 6961 6c65 6374 3a20     sql_dialect: 
-00012320: 4f70 7469 6f6e 616c 5b4c 6974 6572 616c  Optional[Literal
-00012330: 5b22 5351 4c49 5445 222c 2022 4f47 5253  ["SQLITE", "OGRS
-00012340: 514c 225d 5d20 3d20 4e6f 6e65 2c0a 2020  QL"]] = None,.  
-00012350: 2020 7265 7072 6f6a 6563 743a 2062 6f6f    reproject: boo
-00012360: 6c20 3d20 4661 6c73 652c 0a20 2020 2065  l = False,.    e
-00012370: 7870 6c6f 6465 636f 6c6c 6563 7469 6f6e  xplodecollection
-00012380: 733a 2062 6f6f 6c20 3d20 4661 6c73 652c  s: bool = False,
-00012390: 0a20 2020 2066 6f72 6365 5f6f 7574 7075  .    force_outpu
-000123a0: 745f 6765 6f6d 6574 7279 7479 7065 3a20  t_geometrytype: 
-000123b0: 556e 696f 6e5b 4765 6f6d 6574 7279 5479  Union[GeometryTy
-000123c0: 7065 2c20 7374 722c 204e 6f6e 655d 203d  pe, str, None] =
-000123d0: 204e 6f6e 652c 0a20 2020 2063 7265 6174   None,.    creat
-000123e0: 655f 7370 6174 6961 6c5f 696e 6465 783a  e_spatial_index:
-000123f0: 204f 7074 696f 6e61 6c5b 626f 6f6c 5d20   Optional[bool] 
-00012400: 3d20 5472 7565 2c0a 2020 2020 6170 7065  = True,.    appe
-00012410: 6e64 5f74 696d 656f 7574 5f73 3a20 696e  nd_timeout_s: in
-00012420: 7420 3d20 3630 302c 0a20 2020 2074 7261  t = 600,.    tra
-00012430: 6e73 6163 7469 6f6e 5f73 697a 653a 2069  nsaction_size: i
-00012440: 6e74 203d 2035 3030 3030 2c0a 2020 2020  nt = 50000,.    
-00012450: 7072 6573 6572 7665 5f66 6964 3a20 4f70  preserve_fid: Op
-00012460: 7469 6f6e 616c 5b62 6f6f 6c5d 203d 204e  tional[bool] = N
-00012470: 6f6e 652c 0a20 2020 2064 7374 5f64 696d  one,.    dst_dim
-00012480: 656e 7369 6f6e 733a 204f 7074 696f 6e61  ensions: Optiona
-00012490: 6c5b 7374 725d 203d 204e 6f6e 652c 0a20  l[str] = None,. 
-000124a0: 2020 206f 7074 696f 6e73 3a20 6469 6374     options: dict
-000124b0: 203d 207b 7d2c 0a29 3a0a 2020 2020 2222   = {},.):.    ""
-000124c0: 220a 2020 2020 4170 7065 6e64 2073 7263  ".    Append src
-000124d0: 2066 696c 6520 746f 2074 6865 2064 7374   file to the dst
-000124e0: 2066 696c 652e 0a0a 2020 2020 4966 2061   file...    If a
-000124f0: 6e20 7371 6c5f 7374 6d74 2069 7320 7370  n sql_stmt is sp
-00012500: 6563 6966 6965 642c 2074 6865 2073 716c  ecified, the sql
-00012510: 6974 6520 7175 6572 7920 6361 6e20 636f  ite query can co
-00012520: 6e74 6169 6e20 666f 6c6c 6f77 696e 6720  ntain following 
-00012530: 706c 6163 6568 6f6c 6465 7273 0a20 2020  placeholders.   
-00012540: 2074 6861 7420 7769 6c6c 2062 6520 6175   that will be au
-00012550: 746f 6d61 7469 6361 6c6c 7920 7265 706c  tomatically repl
-00012560: 6163 6564 2066 6f72 2079 6f75 3a0a 0a20  aced for you:.. 
-00012570: 2020 2020 202a 207b 6765 6f6d 6574 7279       * {geometry
-00012580: 636f 6c75 6d6e 7d3a 2074 6865 2063 6f6c  column}: the col
-00012590: 756d 6e20 7768 6572 6520 7468 6520 7072  umn where the pr
-000125a0: 696d 6172 7920 6765 6f6d 6574 7279 2069  imary geometry i
-000125b0: 7320 7374 6f72 6564 2e0a 2020 2020 2020  s stored..      
-000125c0: 2a20 7b63 6f6c 756d 6e73 5f74 6f5f 7365  * {columns_to_se
-000125d0: 6c65 6374 5f73 7472 7d3a 2069 6620 2763  lect_str}: if 'c
-000125e0: 6f6c 756d 6e73 2720 6973 206e 6f74 204e  olumns' is not N
-000125f0: 6f6e 652c 2074 686f 7365 2063 6f6c 756d  one, those colum
-00012600: 6e73 2c0a 2020 2020 2020 2020 6f74 6865  ns,.        othe
-00012610: 7277 6973 6520 616c 6c20 636f 6c75 6d6e  rwise all column
-00012620: 7320 6f66 2074 6865 206c 6179 6572 2e0a  s of the layer..
-00012630: 2020 2020 2020 2a20 7b69 6e70 7574 5f6c        * {input_l
-00012640: 6179 6572 7d3a 2074 6865 206c 6179 6572  ayer}: the layer
-00012650: 206e 616d 6520 6f66 2074 6865 2069 6e70   name of the inp
-00012660: 7574 206c 6179 6572 2e0a 0a20 2020 2045  ut layer...    E
-00012670: 7861 6d70 6c65 2053 514c 2073 7461 7465  xample SQL state
-00012680: 6d65 6e74 2077 6974 6820 706c 6163 6568  ment with placeh
-00012690: 6f6c 6465 7273 3a0a 2020 2020 3a3a 0a0a  olders:.    ::..
-000126a0: 2020 2020 2020 2020 5345 4c45 4354 207b          SELECT {
-000126b0: 6765 6f6d 6574 7279 636f 6c75 6d6e 7d0a  geometrycolumn}.
-000126c0: 2020 2020 2020 2020 2020 2020 2020 7b63                {c
-000126d0: 6f6c 756d 6e73 5f74 6f5f 7365 6c65 6374  olumns_to_select
-000126e0: 5f73 7472 7d0a 2020 2020 2020 2020 2020  _str}.          
-000126f0: 4652 4f4d 2022 7b69 6e70 7574 5f6c 6179  FROM "{input_lay
-00012700: 6572 7d22 206c 6179 6572 0a0a 2020 2020  er}" layer..    
-00012710: 5468 6520 6f70 7469 6f6e 7320 7061 7261  The options para
-00012720: 6d65 7465 7220 6361 6e20 6265 2075 7365  meter can be use
-00012730: 6420 746f 2070 6173 7320 616e 7920 7479  d to pass any ty
-00012740: 7065 206f 6620 6f70 7469 6f6e 7320 746f  pe of options to
-00012750: 2047 4441 4c20 696e 0a20 2020 2074 6865   GDAL in.    the
-00012760: 2066 6f6c 6c6f 7769 6e67 2066 6f72 6d3a   following form:
-00012770: 0a20 2020 2020 2020 207b 2022 3c6f 7074  .        { "<opt
-00012780: 696f 6e5f 7479 7065 3e2e 3c6f 7074 696f  ion_type>.<optio
-00012790: 6e5f 6e61 6d65 3e22 3a20 3c6f 7074 696f  n_name>": <optio
-000127a0: 6e5f 7661 6c75 653e 207d 0a0a 2020 2020  n_value> }..    
-000127b0: 5468 6520 6f70 7469 6f6e 2074 7970 6573  The option types
-000127c0: 2063 616e 2062 6520 616e 7920 6f66 2074   can be any of t
-000127d0: 6865 2066 6f6c 6c6f 7769 6e67 3a0a 2020  he following:.  
-000127e0: 2020 2020 2020 2d20 4c41 5945 525f 4352        - LAYER_CR
-000127f0: 4541 5449 4f4e 3a20 6c61 7965 7220 6372  EATION: layer cr
-00012800: 6561 7469 6f6e 206f 7074 696f 6e20 286c  eation option (l
-00012810: 636f 290a 2020 2020 2020 2020 2d20 4441  co).        - DA
-00012820: 5441 5345 545f 4352 4541 5449 4f4e 3a20  TASET_CREATION: 
-00012830: 6461 7461 7365 7420 6372 6561 7469 6f6e  dataset creation
-00012840: 206f 7074 696f 6e20 2864 7363 6f29 0a20   option (dsco). 
-00012850: 2020 2020 2020 202d 2049 4e50 5554 5f4f         - INPUT_O
-00012860: 5045 4e3a 2069 6e70 7574 2064 6174 6173  PEN: input datas
-00012870: 6574 206f 7065 6e20 6f70 7469 6f6e 2028  et open option (
-00012880: 6f6f 290a 2020 2020 2020 2020 2d20 4445  oo).        - DE
-00012890: 5354 494e 4154 494f 4e5f 4f50 454e 3a20  STINATION_OPEN: 
-000128a0: 6465 7374 696e 6174 696f 6e20 6461 7461  destination data
-000128b0: 7365 7420 6f70 656e 206f 7074 696f 6e20  set open option 
-000128c0: 2864 6f6f 290a 2020 2020 2020 2020 2d20  (doo).        - 
-000128d0: 434f 4e46 4947 3a20 636f 6e66 6967 206f  CONFIG: config o
-000128e0: 7074 696f 6e20 2863 6f6e 6669 6729 0a0a  ption (config)..
-000128f0: 2020 2020 5468 6520 6f70 7469 6f6e 7320      The options 
-00012900: 6361 6e20 6265 2066 6f75 6e64 2069 6e20  can be found in 
-00012910: 7468 6520 7c47 4441 4c5f 7665 6374 6f72  the |GDAL_vector
-00012920: 5f64 7269 7665 725f 646f 6375 6d65 6e74  _driver_document
-00012930: 6174 696f 6e7c 2e0a 0a20 2020 2041 7267  ation|...    Arg
-00012940: 733a 0a20 2020 2020 2020 2073 7263 2028  s:.        src (
-00012950: 556e 696f 6e5b 7374 722c 293a 2073 6f75  Union[str,): sou
-00012960: 7263 6520 6669 6c65 2070 6174 682e 0a20  rce file path.. 
-00012970: 2020 2020 2020 2064 7374 2028 556e 696f         dst (Unio
-00012980: 6e5b 7374 722c 293a 2064 6573 7469 6e61  n[str,): destina
-00012990: 7469 6f6e 2066 696c 6520 7061 7468 2e0a  tion file path..
-000129a0: 2020 2020 2020 2020 7372 635f 6c61 7965          src_laye
-000129b0: 7220 2873 7472 2c20 6f70 7469 6f6e 616c  r (str, optional
-000129c0: 293a 2073 6f75 7263 6520 6c61 7965 722e  ): source layer.
-000129d0: 2044 6566 6175 6c74 7320 746f 204e 6f6e   Defaults to Non
-000129e0: 652e 0a20 2020 2020 2020 2064 7374 5f6c  e..        dst_l
-000129f0: 6179 6572 2028 7374 722c 206f 7074 696f  ayer (str, optio
-00012a00: 6e61 6c29 3a20 6465 7374 696e 6174 696f  nal): destinatio
-00012a10: 6e20 6c61 7965 722e 2044 6566 6175 6c74  n layer. Default
-00012a20: 7320 746f 204e 6f6e 652e 0a20 2020 2020  s to None..     
-00012a30: 2020 2073 7263 5f63 7273 2028 7374 722c     src_crs (str,
-00012a40: 206f 7074 696f 6e61 6c29 3a20 616e 2065   optional): an e
-00012a50: 7073 6720 696e 7420 6f72 2061 6e79 7468  psg int or anyth
-00012a60: 696e 6720 7375 7070 6f72 7465 640a 2020  ing supported.  
-00012a70: 2020 2020 2020 2020 2020 6279 2074 6865            by the
-00012a80: 204f 4752 5370 6174 6961 6c52 6566 6572   OGRSpatialRefer
-00012a90: 656e 6365 2e53 6574 4672 6f6d 5573 6572  ence.SetFromUser
-00012aa0: 496e 7075 7428 2920 6361 6c6c 2c20 7768  Input() call, wh
-00012ab0: 6963 6820 696e 636c 7564 6573 0a20 2020  ich includes.   
-00012ac0: 2020 2020 2020 2020 2061 6e20 4550 5347           an EPSG
-00012ad0: 2073 7472 696e 6720 2865 672e 2022 4550   string (eg. "EP
-00012ae0: 5347 3a34 3332 3622 292c 2061 2077 656c  SG:4326"), a wel
-00012af0: 6c20 6b6e 6f77 6e20 7465 7874 2028 574b  l known text (WK
-00012b00: 5429 2043 5253 0a20 2020 2020 2020 2020  T) CRS.         
-00012b10: 2020 2064 6566 696e 6974 696f 6e2c 2e2e     definition,..
-00012b20: 2e20 4465 6661 756c 7473 2074 6f20 4e6f  . Defaults to No
-00012b30: 6e65 2e0a 2020 2020 2020 2020 6473 745f  ne..        dst_
-00012b40: 6372 7320 2873 7472 2c20 6f70 7469 6f6e  crs (str, option
-00012b50: 616c 293a 2061 6e20 6570 7367 2069 6e74  al): an epsg int
-00012b60: 206f 7220 616e 7974 6869 6e67 2073 7570   or anything sup
-00012b70: 706f 7274 6564 0a20 2020 2020 2020 2020  ported.         
-00012b80: 2020 2062 7920 7468 6520 4f47 5253 7061     by the OGRSpa
-00012b90: 7469 616c 5265 6665 7265 6e63 652e 5365  tialReference.Se
-00012ba0: 7446 726f 6d55 7365 7249 6e70 7574 2829  tFromUserInput()
-00012bb0: 2063 616c 6c2c 2077 6869 6368 2069 6e63   call, which inc
-00012bc0: 6c75 6465 730a 2020 2020 2020 2020 2020  ludes.          
-00012bd0: 2020 616e 2045 5053 4720 7374 7269 6e67    an EPSG string
-00012be0: 2028 6567 2e20 2245 5053 473a 3433 3236   (eg. "EPSG:4326
-00012bf0: 2229 2c20 6120 7765 6c6c 206b 6e6f 776e  "), a well known
-00012c00: 2074 6578 7420 2857 4b54 2920 4352 530a   text (WKT) CRS.
-00012c10: 2020 2020 2020 2020 2020 2020 6465 6669              defi
-00012c20: 6e69 7469 6f6e 2c2e 2e2e 2044 6566 6175  nition,... Defau
-00012c30: 6c74 7320 746f 204e 6f6e 652e 0a20 2020  lts to None..   
-00012c40: 2020 2020 2063 6f6c 756d 6e73 2028 4974       columns (It
-00012c50: 6572 6162 6c65 5b73 7472 5d2c 206f 7074  erable[str], opt
-00012c60: 696f 6e61 6c29 3a20 5468 6520 286e 6f6e  ional): The (non
-00012c70: 2d67 656f 6d65 7472 7929 2063 6f6c 756d  -geometry) colum
-00012c80: 6e73 2074 6f20 7265 6164 2077 696c 6c0a  ns to read will.
-00012c90: 2020 2020 2020 2020 2020 2020 6265 2072              be r
-00012ca0: 6574 7572 6e65 6420 696e 2074 6865 206f  eturned in the o
-00012cb0: 7264 6572 2073 7065 6369 6669 6564 2e20  rder specified. 
-00012cc0: 4966 204e 6f6e 652c 2061 6c6c 2073 7461  If None, all sta
-00012cd0: 6e64 6172 6420 636f 6c75 6d6e 7320 6172  ndard columns ar
-00012ce0: 6520 7265 6164 2e0a 2020 2020 2020 2020  e read..        
-00012cf0: 2020 2020 496e 2061 6464 6974 696f 6e20      In addition 
-00012d00: 746f 2073 7461 6e64 6172 6420 636f 6c75  to standard colu
-00012d10: 6d6e 732c 2069 7420 6973 2061 6c73 6f20  mns, it is also 
-00012d20: 706f 7373 6962 6c65 0a20 2020 2020 2020  possible.       
-00012d30: 2020 2020 2074 6f20 7370 6563 6966 7920       to specify 
-00012d40: 2266 6964 222c 2061 2075 6e69 7175 6520  "fid", a unique 
-00012d50: 696e 6465 7820 6176 6169 6c61 626c 6520  index available 
-00012d60: 696e 2061 6c6c 2069 6e70 7574 2066 696c  in all input fil
-00012d70: 6573 2e20 4e6f 7465 2074 6861 7420 7468  es. Note that th
-00012d80: 650a 2020 2020 2020 2020 2020 2020 2266  e.            "f
-00012d90: 6964 2220 7769 6c6c 2062 6520 616c 6961  id" will be alia
-00012da0: 7365 6420 6567 2e20 746f 2022 6669 645f  sed eg. to "fid_
-00012db0: 3122 2e20 4465 6661 756c 7473 2074 6f20  1". Defaults to 
-00012dc0: 4e6f 6e65 2e0a 2020 2020 2020 2020 7768  None..        wh
-00012dd0: 6572 6520 2873 7472 2c20 6f70 7469 6f6e  ere (str, option
-00012de0: 616c 293a 206f 6e6c 7920 6170 7065 6e64  al): only append
-00012df0: 2074 6865 2072 6f77 7320 6672 6f6d 2073   the rows from s
-00012e00: 7263 2074 6861 7420 636f 6d70 6c79 2074  rc that comply t
-00012e10: 6f20 7468 6520 6669 6c74 6572 0a20 2020  o the filter.   
-00012e20: 2020 2020 2020 2020 2073 7065 6369 6669           specifi
-00012e30: 6564 2e20 4170 706c 6965 6420 6265 666f  ed. Applied befo
-00012e40: 7265 2065 7870 6c6f 6465 636f 6c6c 6563  re explodecollec
-00012e50: 7469 6f6e 732e 2046 696c 7465 7220 7368  tions. Filter sh
-00012e60: 6f75 6c64 2062 6520 696e 2073 716c 6974  ould be in sqlit
-00012e70: 650a 2020 2020 2020 2020 2020 2020 5351  e.            SQ
-00012e80: 4c20 5748 4552 4520 7379 6e74 6178 2061  L WHERE syntax a
-00012e90: 6e64 207c 7370 6174 6961 6c69 7465 5f72  nd |spatialite_r
-00012ea0: 6566 6572 656e 6365 5f6c 696e 6b7c 2066  eference_link| f
-00012eb0: 756e 6374 696f 6e73 2063 616e 2062 6520  unctions can be 
-00012ec0: 7573 6564 2e20 4966 0a20 2020 2020 2020  used. If.       
-00012ed0: 2020 2020 2077 6865 7265 2063 6f6e 7461       where conta
-00012ee0: 696e 7320 7468 6520 7b67 656f 6d65 7472  ins the {geometr
-00012ef0: 7963 6f6c 756d 6e7d 2070 6c61 6365 686f  ycolumn} placeho
-00012f00: 6c64 6572 2c20 6974 2069 7320 6669 6c6c  lder, it is fill
-00012f10: 6564 206f 7574 2077 6974 6820 7468 650a  ed out with the.
-00012f20: 2020 2020 2020 2020 2020 2020 6765 6f6d              geom
-00012f30: 6574 7279 2063 6f6c 756d 6e20 6e61 6d65  etry column name
-00012f40: 206f 6620 7468 6520 7372 6320 6669 6c65   of the src file
-00012f50: 2e20 4465 6661 756c 7473 2074 6f20 4e6f  . Defaults to No
-00012f60: 6e65 2e0a 2020 2020 2020 2020 7371 6c5f  ne..        sql_
-00012f70: 7374 6d74 2028 7374 7229 3a20 5351 4c20  stmt (str): SQL 
-00012f80: 7374 6174 656d 656e 7420 746f 2075 7365  statement to use
-00012f90: 2e20 4f6e 6c79 2073 7570 706f 7274 6564  . Only supported
-00012fa0: 2077 6974 6820 2270 796f 6772 696f 2220   with "pyogrio" 
-00012fb0: 656e 6769 6e65 2e0a 2020 2020 2020 2020  engine..        
-00012fc0: 7371 6c5f 6469 616c 6563 7420 2873 7472  sql_dialect (str
-00012fd0: 2c20 6f70 7469 6f6e 616c 293a 2053 514c  , optional): SQL
-00012fe0: 2064 6961 6c65 6374 2075 7365 642e 204f   dialect used. O
-00012ff0: 7074 696f 6e73 2061 7265 204e 6f6e 652c  ptions are None,
-00013000: 2022 5351 4c49 5445 2220 6f72 0a20 2020   "SQLITE" or.   
-00013010: 2020 2020 2020 2020 2022 4f47 5253 514c           "OGRSQL
-00013020: 222e 2049 6620 4e6f 6e65 2c20 666f 7220  ". If None, for 
-00013030: 6461 7461 2073 6f75 7263 6573 2077 6974  data sources wit
-00013040: 6820 6578 706c 6963 6974 2053 514c 2073  h explicit SQL s
-00013050: 7570 706f 7274 2074 6865 2073 7461 7465  upport the state
-00013060: 6d65 6e74 0a20 2020 2020 2020 2020 2020  ment.           
-00013070: 2069 7320 7072 6f63 6573 7365 6420 6279   is processed by
-00013080: 2074 6865 2064 6566 6175 6c74 2053 514c   the default SQL
-00013090: 2065 6e67 696e 6520 2865 2e67 2e20 666f   engine (e.g. fo
-000130a0: 7220 4765 6f70 6163 6b61 6765 2061 6e64  r Geopackage and
-000130b0: 2053 7061 7469 616c 6974 650a 2020 2020   Spatialite.    
-000130c0: 2020 2020 2020 2020 7468 6973 2069 7320          this is 
-000130d0: 2253 514c 4954 4522 292e 2046 6f72 2064  "SQLITE"). For d
-000130e0: 6174 6120 736f 7572 6365 7320 7769 7468  ata sources with
-000130f0: 6f75 7420 6e61 7469 7665 2053 514c 2073  out native SQL s
-00013100: 7570 706f 7274 2028 652e 672e 202e 7368  upport (e.g. .sh
-00013110: 7029 2c0a 2020 2020 2020 2020 2020 2020  p),.            
-00013120: 7468 6520 224f 4752 5351 4c22 2064 6961  the "OGRSQL" dia
-00013130: 6c65 6374 2069 7320 7468 6520 6465 6661  lect is the defa
-00013140: 756c 742e 2049 6620 7468 6520 2253 514c  ult. If the "SQL
-00013150: 4954 4522 2064 6961 6c65 6374 2069 7320  ITE" dialect is 
-00013160: 7370 6563 6966 6965 642c 0a20 2020 2020  specified,.     
-00013170: 2020 2020 2020 207c 7370 6174 6961 6c69         |spatiali
-00013180: 7465 5f72 6566 6572 656e 6365 5f6c 696e  te_reference_lin
-00013190: 6b7c 2066 756e 6374 696f 6e73 2063 616e  k| functions can
-000131a0: 2061 6c73 6f20 6265 2075 7365 642e 2044   also be used. D
-000131b0: 6566 6175 6c74 7320 746f 204e 6f6e 652e  efaults to None.
-000131c0: 0a20 2020 2020 2020 2072 6570 726f 6a65  .        reproje
-000131d0: 6374 2028 626f 6f6c 2c20 6f70 7469 6f6e  ct (bool, option
-000131e0: 616c 293a 2054 7275 6520 746f 2072 6570  al): True to rep
-000131f0: 726f 6a65 6374 2077 6869 6c65 2063 6f6e  roject while con
-00013200: 7665 7274 696e 6720 7468 650a 2020 2020  verting the.    
-00013210: 2020 2020 2020 2020 6669 6c65 2e20 4465          file. De
-00013220: 6661 756c 7473 2074 6f20 4661 6c73 652e  faults to False.
-00013230: 0a20 2020 2020 2020 2065 7870 6c6f 6465  .        explode
-00013240: 636f 6c6c 6563 7469 6f6e 7320 2862 6f6f  collections (boo
-00013250: 6c29 2c20 6f70 7469 6f6e 616c 293a 2054  l), optional): T
-00013260: 7275 6520 746f 206f 7574 7075 7420 6f6e  rue to output on
-00013270: 6c79 2073 696d 706c 6520 6765 6f6d 6574  ly simple geomet
-00013280: 7269 6573 2e0a 2020 2020 2020 2020 2020  ries..          
-00013290: 2020 4465 6661 756c 7473 2074 6f20 4661    Defaults to Fa
-000132a0: 6c73 652e 0a20 2020 2020 2020 2066 6f72  lse..        for
-000132b0: 6365 5f6f 7574 7075 745f 6765 6f6d 6574  ce_output_geomet
-000132c0: 7279 7479 7065 2028 556e 696f 6e5b 4765  rytype (Union[Ge
-000132d0: 6f6d 6574 7279 5479 7065 2c20 7374 725d  ometryType, str]
-000132e0: 2c20 6f70 7469 6f6e 616c 293a 2047 656f  , optional): Geo
-000132f0: 6d65 7472 7920 7479 7065 2e0a 2020 2020  metry type..    
-00013300: 2020 2020 2020 2020 746f 2028 7472 7920          to (try 
-00013310: 746f 2920 666f 7263 6520 7468 6520 6f75  to) force the ou
-00013320: 7470 7574 2074 6f2e 2044 6566 6175 6c74  tput to. Default
-00013330: 7320 746f 204e 6f6e 652e 0a20 2020 2020  s to None..     
-00013340: 2020 2063 7265 6174 655f 7370 6174 6961     create_spatia
-00013350: 6c5f 696e 6465 7820 2862 6f6f 6c2c 206f  l_index (bool, o
-00013360: 7074 696f 6e61 6c29 3a20 5472 7565 2074  ptional): True t
-00013370: 6f20 6372 6561 7465 2061 2073 7061 7469  o create a spati
-00013380: 616c 2069 6e64 6578 0a20 2020 2020 2020  al index.       
-00013390: 2020 2020 206f 6e20 7468 6520 6465 7374       on the dest
-000133a0: 696e 6174 696f 6e20 6669 6c65 2f6c 6179  ination file/lay
-000133b0: 6572 2e20 4966 204e 6f6e 652c 2074 6865  er. If None, the
-000133c0: 2064 6566 6175 6c74 2062 6568 6176 696f   default behavio
-000133d0: 7572 2062 7920 6764 616c 2066 6f72 0a20  ur by gdal for. 
-000133e0: 2020 2020 2020 2020 2020 2074 6861 7420             that 
-000133f0: 6669 6c65 2074 7970 6520 6973 2072 6573  file type is res
-00013400: 7065 6374 6564 2e20 4966 2074 6865 2060  pected. If the `
-00013410: 4c41 5945 525f 4352 4541 5449 4f4e 2e53  LAYER_CREATION.S
-00013420: 5041 5449 414c 5f49 4e44 4558 600a 2020  PATIAL_INDEX`.  
-00013430: 2020 2020 2020 2020 2020 7061 7261 6d65            parame
-00013440: 7465 7220 6973 2073 7065 6369 6669 6564  ter is specified
-00013450: 2069 6e20 6f70 7469 6f6e 732c 2060 6372   in options, `cr
-00013460: 6561 7465 5f73 7061 7469 616c 5f69 6e64  eate_spatial_ind
-00013470: 6578 6020 6973 2069 676e 6f72 6564 2e20  ex` is ignored. 
-00013480: 4966 2074 6865 0a20 2020 2020 2020 2020  If the.         
-00013490: 2020 2064 6573 7469 6e61 7469 6f6e 206c     destination l
-000134a0: 6179 6572 2065 7869 7374 7320 616c 7265  ayer exists alre
-000134b0: 6164 792c 2060 6372 6561 7465 5f73 7061  ady, `create_spa
-000134c0: 7469 616c 5f69 6e64 6578 6020 6973 2061  tial_index` is a
-000134d0: 6c73 6f20 6967 6e6f 7265 642e 0a20 2020  lso ignored..   
-000134e0: 2020 2020 2020 2020 2044 6566 6175 6c74           Default
-000134f0: 7320 746f 2054 7275 652e 0a20 2020 2020  s to True..     
-00013500: 2020 2061 7070 656e 645f 7469 6d65 6f75     append_timeou
-00013510: 745f 7320 2869 6e74 2c20 6f70 7469 6f6e  t_s (int, option
-00013520: 616c 293a 2074 696d 656f 7574 2074 6f20  al): timeout to 
-00013530: 7573 6520 6966 2074 6865 206f 7574 7075  use if the outpu
-00013540: 7420 6669 6c65 2069 730a 2020 2020 2020  t file is.      
-00013550: 2020 2020 2020 6265 696e 6720 7772 6974        being writ
-00013560: 7465 6e20 746f 2062 7920 616e 6f74 6865  ten to by anothe
-00013570: 7220 7072 6f63 6573 7320 616c 7265 6164  r process alread
-00013580: 792e 2044 6566 6175 6c74 7320 746f 2036  y. Defaults to 6
-00013590: 3030 2e0a 2020 2020 2020 2020 7472 616e  00..        tran
-000135a0: 7361 6374 696f 6e5f 7369 7a65 2028 696e  saction_size (in
-000135b0: 742c 206f 7074 696f 6e61 6c29 3a20 5472  t, optional): Tr
-000135c0: 616e 7361 6374 696f 6e20 7369 7a65 2e20  ansaction size. 
-000135d0: 4465 6661 756c 7473 2074 6f20 3530 3030  Defaults to 5000
-000135e0: 302e 0a20 2020 2020 2020 2070 7265 7365  0..        prese
-000135f0: 7276 655f 6669 6420 2862 6f6f 6c2c 206f  rve_fid (bool, o
-00013600: 7074 696f 6e61 6c29 3a20 5472 7565 2074  ptional): True t
-00013610: 6f20 6d61 6b65 2061 6e20 6578 7472 6120  o make an extra 
-00013620: 6566 666f 7274 2074 6f20 7072 6573 6572  effort to preser
-00013630: 7665 2066 6964 2773 206f 660a 2020 2020  ve fid's of.    
-00013640: 2020 2020 2020 2020 7468 6520 736f 7572          the sour
-00013650: 6365 206c 6179 6572 2074 6f20 7468 6520  ce layer to the 
-00013660: 6465 7374 696e 6174 696f 6e20 6c61 7965  destination laye
-00013670: 722e 2046 616c 7365 206e 6f74 2074 6f20  r. False not to 
-00013680: 646f 2061 6e79 2065 6666 6f72 742e 204e  do any effort. N
-00013690: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
-000136a0: 746f 2075 7365 2074 6865 2064 6566 6175  to use the defau
-000136b0: 6c74 2062 6568 6176 696f 7572 206f 6620  lt behaviour of 
-000136c0: 6764 616c 2c20 7468 6174 2061 6c72 6561  gdal, that alrea
-000136d0: 6479 2070 7265 7365 7276 6573 2069 6e20  dy preserves in 
-000136e0: 736f 6d65 2063 6173 6573 2e0a 2020 2020  some cases..    
-000136f0: 2020 2020 2020 2020 536f 6d65 2066 696c          Some fil
-00013700: 6520 666f 726d 6174 7320 646f 6e27 7420  e formats don't 
-00013710: 6578 706c 6963 6974 6c79 2073 746f 7265  explicitly store
-00013720: 2074 6865 2066 6964 2028 652e 672e 2073   the fid (e.g. s
-00013730: 6861 7065 6669 6c65 292c 2073 6f20 7468  hapefile), so th
-00013740: 6579 0a20 2020 2020 2020 2020 2020 2077  ey.            w
-00013750: 696c 6c20 6e65 7665 7220 6265 2061 626c  ill never be abl
-00013760: 6520 746f 2070 7265 7365 7276 6520 6669  e to preserve fi
-00013770: 6473 2e20 4465 6661 756c 7473 2074 6f20  ds. Defaults to 
-00013780: 4e6f 6e65 2e0a 2020 2020 2020 2020 6473  None..        ds
-00013790: 745f 6469 6d65 6e73 696f 6e73 2028 7374  t_dimensions (st
-000137a0: 722c 206f 7074 696f 6e61 6c29 3a20 466f  r, optional): Fo
-000137b0: 7263 6520 7468 6520 6469 6d65 6e73 696f  rce the dimensio
-000137c0: 6e73 206f 6620 7468 6520 6465 7374 696e  ns of the destin
-000137d0: 6174 696f 6e20 6c61 7965 7220 746f 0a20  ation layer to. 
-000137e0: 2020 2020 2020 2020 2020 2074 6865 2076             the v
-000137f0: 616c 7565 2073 7065 6369 6669 6564 2e20  alue specified. 
-00013800: 5661 6c69 6420 7661 6c75 6573 3a20 2258  Valid values: "X
-00013810: 5922 2c20 2258 595a 222c 2022 5859 4d22  Y", "XYZ", "XYM"
-00013820: 206f 7220 2258 595a 4d22 2e0a 2020 2020   or "XYZM"..    
-00013830: 2020 2020 2020 2020 4465 6661 756c 7473          Defaults
-00013840: 2074 6f20 4e6f 6e65 2e0a 2020 2020 2020   to None..      
-00013850: 2020 6f70 7469 6f6e 7320 2864 6963 742c    options (dict,
-00013860: 206f 7074 696f 6e61 6c29 3a20 6f70 7469   optional): opti
-00013870: 6f6e 7320 746f 2070 6173 7320 746f 2067  ons to pass to g
-00013880: 6461 6c2e 0a0a 2020 2020 5261 6973 6573  dal...    Raises
-00013890: 3a0a 2020 2020 2020 2020 5661 6c75 6545  :.        ValueE
-000138a0: 7272 6f72 3a20 616e 2069 6e76 616c 6964  rror: an invalid
-000138b0: 2070 6172 616d 6574 6572 2076 616c 7565   parameter value
-000138c0: 2077 6173 2070 6173 7365 642e 0a20 2020   was passed..   
-000138d0: 2020 2020 2052 756e 7469 6d65 4572 726f       RuntimeErro
-000138e0: 723a 2074 696d 656f 7574 2077 6173 2072  r: timeout was r
-000138f0: 6561 6368 6564 2077 6869 6c65 2074 7279  eached while try
-00013900: 696e 6720 746f 2061 7070 656e 6420 6461  ing to append da
-00013910: 7461 2074 6f20 7061 7468 2e0a 0a20 2020  ta to path...   
-00013920: 202e 2e20 7c73 7061 7469 616c 6974 655f   .. |spatialite_
-00013930: 7265 6665 7265 6e63 655f 6c69 6e6b 7c20  reference_link| 
-00013940: 7261 773a 3a20 6874 6d6c 0a0a 2020 2020  raw:: html..    
-00013950: 2020 2020 3c61 2068 7265 663d 2268 7474      <a href="htt
-00013960: 7073 3a2f 2f77 7777 2e67 6169 612d 6769  ps://www.gaia-gi
-00013970: 732e 6974 2f67 6169 612d 7369 6e73 2f73  s.it/gaia-sins/s
-00013980: 7061 7469 616c 6974 652d 7371 6c2d 6c61  patialite-sql-la
-00013990: 7465 7374 2e68 746d 6c22 2074 6172 6765  test.html" targe
-000139a0: 743d 225f 626c 616e 6b22 3e73 7061 7469  t="_blank">spati
-000139b0: 616c 6974 6520 7265 6665 7265 6e63 653c  alite reference<
-000139c0: 2f61 3e0a 0a20 2020 202e 2e20 7c47 4441  /a>..    .. |GDA
-000139d0: 4c5f 7665 6374 6f72 5f64 7269 7665 725f  L_vector_driver_
-000139e0: 646f 6375 6d65 6e74 6174 696f 6e7c 2072  documentation| r
-000139f0: 6177 3a3a 2068 746d 6c0a 0a20 2020 2020  aw:: html..     
-00013a00: 2020 203c 6120 6872 6566 3d22 6874 7470     <a href="http
-00013a10: 733a 2f2f 6764 616c 2e6f 7267 2f64 7269  s://gdal.org/dri
-00013a20: 7665 7273 2f76 6563 746f 722f 696e 6465  vers/vector/inde
-00013a30: 782e 6874 6d6c 2220 7461 7267 6574 3d22  x.html" target="
-00013a40: 5f62 6c61 6e6b 223e 4744 414c 2076 6563  _blank">GDAL vec
-00013a50: 746f 7220 6472 6976 6572 2064 6f63 756d  tor driver docum
-00013a60: 656e 7461 7469 6f6e 3c2f 613e 0a0a 2020  entation</a>..  
-00013a70: 2020 2222 2220 2023 206e 6f71 613a 2045    """  # noqa: E
-00013a80: 3530 310a 2020 2020 2320 4368 6563 6b2f  501.    # Check/
-00013a90: 636c 6561 6e20 696e 7075 7420 7061 7261  clean input para
-00013aa0: 6d73 0a20 2020 2073 7263 203d 2050 6174  ms.    src = Pat
-00013ab0: 6828 7372 6329 0a20 2020 2064 7374 203d  h(src).    dst =
-00013ac0: 2050 6174 6828 6473 7429 0a20 2020 2069   Path(dst).    i
-00013ad0: 6620 666f 7263 655f 6f75 7470 7574 5f67  f force_output_g
-00013ae0: 656f 6d65 7472 7974 7970 6520 6973 206e  eometrytype is n
-00013af0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-00013b00: 2066 6f72 6365 5f6f 7574 7075 745f 6765   force_output_ge
-00013b10: 6f6d 6574 7279 7479 7065 203d 2047 656f  ometrytype = Geo
-00013b20: 6d65 7472 7954 7970 6528 666f 7263 655f  metryType(force_
-00013b30: 6f75 7470 7574 5f67 656f 6d65 7472 7974  output_geometryt
-00013b40: 7970 6529 0a0a 2020 2020 2320 4669 6c65  ype)..    # File
-00013b50: 7320 646f 6e27 7420 7479 7069 6361 6c6c  s don't typicall
-00013b60: 7920 7375 7070 6f72 7420 6861 7669 6e67  y support having
-00013b70: 206d 756c 7469 706c 6520 7072 6f63 6573   multiple proces
-00013b80: 7365 7320 7772 6974 696e 670a 2020 2020  ses writing.    
-00013b90: 2320 7369 6d75 6c74 616e 6f75 736c 7920  # simultanously 
-00013ba0: 746f 2074 6865 6d2c 2073 6f20 7573 6520  to them, so use 
-00013bb0: 6c6f 636b 2066 696c 6520 746f 2073 796e  lock file to syn
-00013bc0: 6368 726f 6e69 7a65 2061 6363 6573 732e  chronize access.
-00013bd0: 0a20 2020 206c 6f63 6b66 696c 6520 3d20  .    lockfile = 
-00013be0: 5061 7468 2866 227b 7374 7228 6473 7429  Path(f"{str(dst)
-00013bf0: 7d2e 6c6f 636b 2229 0a0a 2020 2020 2320  }.lock")..    # 
-00013c00: 4966 2074 6865 2064 6573 7469 6e61 7469  If the destinati
-00013c10: 6f6e 2066 696c 6520 646f 6573 6e27 7420  on file doesn't 
-00013c20: 6578 6973 7420 7965 742c 2062 7574 2074  exist yet, but t
-00013c30: 6865 206c 6f63 6b66 696c 6520 646f 6573  he lockfile does
-00013c40: 2c0a 2020 2020 2320 7472 7920 7265 6d6f  ,.    # try remo
-00013c50: 7669 6e67 2074 6865 206c 6f63 6b66 696c  ving the lockfil
-00013c60: 6520 6173 2069 7420 6d69 6768 7420 6265  e as it might be
-00013c70: 2061 2067 686f 7374 206c 6f63 6b66 696c   a ghost lockfil
-00013c80: 652e 0a20 2020 2069 6620 6e6f 7420 6473  e..    if not ds
-00013c90: 742e 6578 6973 7473 2829 2061 6e64 206c  t.exists() and l
-00013ca0: 6f63 6b66 696c 652e 6578 6973 7473 2829  ockfile.exists()
-00013cb0: 3a0a 2020 2020 2020 2020 7472 793a 0a20  :.        try:. 
-00013cc0: 2020 2020 2020 2020 2020 206c 6f63 6b66             lockf
-00013cd0: 696c 652e 756e 6c69 6e6b 2829 0a20 2020  ile.unlink().   
-00013ce0: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
-00013cf0: 7074 696f 6e3a 0a20 2020 2020 2020 2020  ption:.         
-00013d00: 2020 205f 203d 204e 6f6e 650a 0a20 2020     _ = None..   
-00013d10: 2023 2043 7265 6174 696e 6720 6c6f 636b   # Creating lock
-00013d20: 6669 6c65 2061 6e64 2061 7070 656e 640a  file and append.
-00013d30: 2020 2020 7374 6172 745f 7469 6d65 203d      start_time =
-00013d40: 2064 6174 6574 696d 652e 6461 7465 7469   datetime.dateti
-00013d50: 6d65 2e6e 6f77 2829 0a20 2020 2072 6561  me.now().    rea
-00013d60: 6479 203d 2046 616c 7365 0a20 2020 2077  dy = False.    w
-00013d70: 6869 6c65 206e 6f74 2072 6561 6479 3a0a  hile not ready:.
-00013d80: 2020 2020 2020 2020 6966 205f 696f 5f75          if _io_u
-00013d90: 7469 6c2e 6372 6561 7465 5f66 696c 655f  til.create_file_
-00013da0: 6174 6f6d 6963 286c 6f63 6b66 696c 6529  atomic(lockfile)
-00013db0: 2069 7320 5472 7565 3a0a 2020 2020 2020   is True:.      
-00013dc0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-00013dd0: 2020 2020 2020 2020 2020 2023 2061 7070             # app
-00013de0: 656e 640a 2020 2020 2020 2020 2020 2020  end.            
-00013df0: 2020 2020 5f61 7070 656e 645f 746f 5f6e      _append_to_n
-00013e00: 6f6c 6f63 6b28 0a20 2020 2020 2020 2020  olock(.         
-00013e10: 2020 2020 2020 2020 2020 2073 7263 3d73             src=s
-00013e20: 7263 2c0a 2020 2020 2020 2020 2020 2020  rc,.            
-00013e30: 2020 2020 2020 2020 6473 743d 6473 742c          dst=dst,
-00013e40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013e50: 2020 2020 2073 7263 5f6c 6179 6572 3d73       src_layer=s
-00013e60: 7263 5f6c 6179 6572 2c0a 2020 2020 2020  rc_layer,.      
-00013e70: 2020 2020 2020 2020 2020 2020 2020 6473                ds
-00013e80: 745f 6c61 7965 723d 6473 745f 6c61 7965  t_layer=dst_laye
-00013e90: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
-00013ea0: 2020 2020 2020 2073 7263 5f63 7273 3d73         src_crs=s
-00013eb0: 7263 5f63 7273 2c0a 2020 2020 2020 2020  rc_crs,.        
-00013ec0: 2020 2020 2020 2020 2020 2020 6473 745f              dst_
-00013ed0: 6372 733d 6473 745f 6372 732c 0a20 2020  crs=dst_crs,.   
-00013ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013ef0: 2063 6f6c 756d 6e73 3d63 6f6c 756d 6e73   columns=columns
-00013f00: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00013f10: 2020 2020 2020 7768 6572 653d 7768 6572        where=wher
-00013f20: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00013f30: 2020 2020 2020 2073 716c 5f73 746d 743d         sql_stmt=
-00013f40: 7371 6c5f 7374 6d74 2c0a 2020 2020 2020  sql_stmt,.      
-00013f50: 2020 2020 2020 2020 2020 2020 2020 7371                sq
-00013f60: 6c5f 6469 616c 6563 743d 7371 6c5f 6469  l_dialect=sql_di
-00013f70: 616c 6563 742c 0a20 2020 2020 2020 2020  alect,.         
-00013f80: 2020 2020 2020 2020 2020 2072 6570 726f             repro
-00013f90: 6a65 6374 3d72 6570 726f 6a65 6374 2c0a  ject=reproject,.
-00013fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013fb0: 2020 2020 6578 706c 6f64 6563 6f6c 6c65      explodecolle
-00013fc0: 6374 696f 6e73 3d65 7870 6c6f 6465 636f  ctions=explodeco
-00013fd0: 6c6c 6563 7469 6f6e 732c 0a20 2020 2020  llections,.     
-00013fe0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00013ff0: 6f72 6365 5f6f 7574 7075 745f 6765 6f6d  orce_output_geom
-00014000: 6574 7279 7479 7065 3d66 6f72 6365 5f6f  etrytype=force_o
-00014010: 7574 7075 745f 6765 6f6d 6574 7279 7479  utput_geometryty
-00014020: 7065 2c0a 2020 2020 2020 2020 2020 2020  pe,.            
-00014030: 2020 2020 2020 2020 6372 6561 7465 5f73          create_s
-00014040: 7061 7469 616c 5f69 6e64 6578 3d63 7265  patial_index=cre
-00014050: 6174 655f 7370 6174 6961 6c5f 696e 6465  ate_spatial_inde
-00014060: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
-00014070: 2020 2020 2020 2074 7261 6e73 6163 7469         transacti
-00014080: 6f6e 5f73 697a 653d 7472 616e 7361 6374  on_size=transact
-00014090: 696f 6e5f 7369 7a65 2c0a 2020 2020 2020  ion_size,.      
-000140a0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-000140b0: 6573 6572 7665 5f66 6964 3d70 7265 7365  eserve_fid=prese
-000140c0: 7276 655f 6669 642c 0a20 2020 2020 2020  rve_fid,.       
-000140d0: 2020 2020 2020 2020 2020 2020 2064 7374               dst
-000140e0: 5f64 696d 656e 7369 6f6e 733d 6473 745f  _dimensions=dst_
-000140f0: 6469 6d65 6e73 696f 6e73 2c0a 2020 2020  dimensions,.    
-00014100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014110: 6f70 7469 6f6e 733d 6f70 7469 6f6e 732c  options=options,
-00014120: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014130: 2029 0a20 2020 2020 2020 2020 2020 2066   ).            f
-00014140: 696e 616c 6c79 3a0a 2020 2020 2020 2020  inally:.        
-00014150: 2020 2020 2020 2020 7265 6164 7920 3d20          ready = 
-00014160: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
-00014170: 2020 2020 206c 6f63 6b66 696c 652e 756e       lockfile.un
-00014180: 6c69 6e6b 2829 0a20 2020 2020 2020 2065  link().        e
-00014190: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-000141a0: 2074 696d 655f 7761 6974 696e 6720 3d20   time_waiting = 
-000141b0: 2864 6174 6574 696d 652e 6461 7465 7469  (datetime.dateti
-000141c0: 6d65 2e6e 6f77 2829 202d 2073 7461 7274  me.now() - start
-000141d0: 5f74 696d 6529 2e74 6f74 616c 5f73 6563  _time).total_sec
-000141e0: 6f6e 6473 2829 0a20 2020 2020 2020 2020  onds().         
-000141f0: 2020 2069 6620 7469 6d65 5f77 6169 7469     if time_waiti
-00014200: 6e67 203e 2061 7070 656e 645f 7469 6d65  ng > append_time
-00014210: 6f75 745f 733a 0a20 2020 2020 2020 2020  out_s:.         
-00014220: 2020 2020 2020 2072 6169 7365 2052 756e         raise Run
-00014230: 7469 6d65 4572 726f 7228 0a20 2020 2020  timeError(.     
-00014240: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00014250: 2261 7070 656e 645f 746f 2074 696d 656f  "append_to timeo
-00014260: 7574 206f 6620 7b61 7070 656e 645f 7469  ut of {append_ti
-00014270: 6d65 6f75 745f 737d 2072 6561 6368 6564  meout_s} reached
-00014280: 2c20 736f 2073 746f 7020 7772 6974 6520  , so stop write 
-00014290: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-000142a0: 2020 2020 2020 6622 746f 207b 6473 747d        f"to {dst}
-000142b0: 2122 0a20 2020 2020 2020 2020 2020 2020  !".             
-000142c0: 2020 2029 0a0a 2020 2020 2020 2020 2320     )..        # 
-000142d0: 536c 6565 7020 666f 7220 6120 7365 636f  Sleep for a seco
-000142e0: 6e64 2062 6566 6f72 6520 7472 7969 6e67  nd before trying
-000142f0: 2061 6761 696e 0a20 2020 2020 2020 2074   again.        t
-00014300: 696d 652e 736c 6565 7028 3129 0a0a 0a64  ime.sleep(1)...d
-00014310: 6566 205f 6170 7065 6e64 5f74 6f5f 6e6f  ef _append_to_no
-00014320: 6c6f 636b 280a 2020 2020 7372 633a 2050  lock(.    src: P
-00014330: 6174 682c 0a20 2020 2064 7374 3a20 5061  ath,.    dst: Pa
-00014340: 7468 2c0a 2020 2020 7372 635f 6c61 7965  th,.    src_laye
-00014350: 723a 204f 7074 696f 6e61 6c5b 7374 725d  r: Optional[str]
-00014360: 203d 204e 6f6e 652c 0a20 2020 2064 7374   = None,.    dst
-00014370: 5f6c 6179 6572 3a20 4f70 7469 6f6e 616c  _layer: Optional
-00014380: 5b73 7472 5d20 3d20 4e6f 6e65 2c0a 2020  [str] = None,.  
-00014390: 2020 7372 635f 6372 733a 2055 6e69 6f6e    src_crs: Union
-000143a0: 5b69 6e74 2c20 7374 722c 204e 6f6e 655d  [int, str, None]
-000143b0: 203d 204e 6f6e 652c 0a20 2020 2064 7374   = None,.    dst
-000143c0: 5f63 7273 3a20 556e 696f 6e5b 696e 742c  _crs: Union[int,
-000143d0: 2073 7472 2c20 4e6f 6e65 5d20 3d20 4e6f   str, None] = No
-000143e0: 6e65 2c0a 2020 2020 636f 6c75 6d6e 733a  ne,.    columns:
-000143f0: 204f 7074 696f 6e61 6c5b 4974 6572 6162   Optional[Iterab
-00014400: 6c65 5b73 7472 5d5d 203d 204e 6f6e 652c  le[str]] = None,
-00014410: 0a20 2020 2077 6865 7265 3a20 4f70 7469  .    where: Opti
-00014420: 6f6e 616c 5b73 7472 5d20 3d20 4e6f 6e65  onal[str] = None
-00014430: 2c0a 2020 2020 7371 6c5f 7374 6d74 3a20  ,.    sql_stmt: 
-00014440: 4f70 7469 6f6e 616c 5b73 7472 5d20 3d20  Optional[str] = 
-00014450: 4e6f 6e65 2c0a 2020 2020 7371 6c5f 6469  None,.    sql_di
-00014460: 616c 6563 743a 204f 7074 696f 6e61 6c5b  alect: Optional[
-00014470: 4c69 7465 7261 6c5b 2253 514c 4954 4522  Literal["SQLITE"
-00014480: 2c20 224f 4752 5351 4c22 5d5d 203d 204e  , "OGRSQL"]] = N
-00014490: 6f6e 652c 0a20 2020 2072 6570 726f 6a65  one,.    reproje
-000144a0: 6374 3a20 626f 6f6c 203d 2046 616c 7365  ct: bool = False
-000144b0: 2c0a 2020 2020 6578 706c 6f64 6563 6f6c  ,.    explodecol
-000144c0: 6c65 6374 696f 6e73 3a20 626f 6f6c 203d  lections: bool =
-000144d0: 2046 616c 7365 2c0a 2020 2020 6372 6561   False,.    crea
-000144e0: 7465 5f73 7061 7469 616c 5f69 6e64 6578  te_spatial_index
-000144f0: 3a20 4f70 7469 6f6e 616c 5b62 6f6f 6c5d  : Optional[bool]
-00014500: 203d 2054 7275 652c 0a20 2020 2066 6f72   = True,.    for
-00014510: 6365 5f6f 7574 7075 745f 6765 6f6d 6574  ce_output_geomet
-00014520: 7279 7479 7065 3a20 556e 696f 6e5b 4765  rytype: Union[Ge
-00014530: 6f6d 6574 7279 5479 7065 2c20 7374 722c  ometryType, str,
-00014540: 204e 6f6e 655d 203d 204e 6f6e 652c 0a20   None] = None,. 
-00014550: 2020 2074 7261 6e73 6163 7469 6f6e 5f73     transaction_s
-00014560: 697a 653a 2069 6e74 203d 2035 3030 3030  ize: int = 50000
-00014570: 2c0a 2020 2020 7072 6573 6572 7665 5f66  ,.    preserve_f
-00014580: 6964 3a20 4f70 7469 6f6e 616c 5b62 6f6f  id: Optional[boo
-00014590: 6c5d 203d 204e 6f6e 652c 0a20 2020 2064  l] = None,.    d
-000145a0: 7374 5f64 696d 656e 7369 6f6e 733a 204f  st_dimensions: O
-000145b0: 7074 696f 6e61 6c5b 7374 725d 203d 204e  ptional[str] = N
-000145c0: 6f6e 652c 0a20 2020 206f 7074 696f 6e73  one,.    options
-000145d0: 3a20 6469 6374 203d 207b 7d2c 0a29 3a0a  : dict = {},.):.
-000145e0: 2020 2020 2320 4368 6563 6b2f 636c 6561      # Check/clea
-000145f0: 6e20 696e 7075 7420 7061 7261 6d73 0a20  n input params. 
-00014600: 2020 206f 7074 696f 6e73 203d 205f 6f67     options = _og
-00014610: 725f 7574 696c 2e5f 7072 6570 6172 655f  r_util._prepare_
-00014620: 6764 616c 5f6f 7074 696f 6e73 286f 7074  gdal_options(opt
-00014630: 696f 6e73 290a 2020 2020 6966 2028 0a20  ions).    if (. 
-00014640: 2020 2020 2020 2063 7265 6174 655f 7370         create_sp
-00014650: 6174 6961 6c5f 696e 6465 7820 6973 206e  atial_index is n
-00014660: 6f74 204e 6f6e 650a 2020 2020 2020 2020  ot None.        
-00014670: 616e 6420 224c 4159 4552 5f43 5245 4154  and "LAYER_CREAT
-00014680: 494f 4e2e 5350 4154 4941 4c5f 494e 4445  ION.SPATIAL_INDE
-00014690: 5822 206e 6f74 2069 6e20 6f70 7469 6f6e  X" not in option
-000146a0: 730a 2020 2020 293a 0a20 2020 2020 2020  s.    ):.       
-000146b0: 206f 7074 696f 6e73 5b22 4c41 5945 525f   options["LAYER_
-000146c0: 4352 4541 5449 4f4e 2e53 5041 5449 414c  CREATION.SPATIAL
-000146d0: 5f49 4e44 4558 225d 203d 2063 7265 6174  _INDEX"] = creat
-000146e0: 655f 7370 6174 6961 6c5f 696e 6465 780a  e_spatial_index.
-000146f0: 0a20 2020 2073 7263 5f6c 6179 6572 203d  .    src_layer =
-00014700: 2073 7263 5f6c 6179 6572 2069 6620 7372   src_layer if sr
-00014710: 635f 6c61 7965 7220 6973 206e 6f74 204e  c_layer is not N
-00014720: 6f6e 6520 656c 7365 2067 6574 5f6f 6e6c  one else get_onl
-00014730: 795f 6c61 7965 7228 7372 6329 0a20 2020  y_layer(src).   
-00014740: 2073 7263 5f6c 6179 6572 696e 666f 203d   src_layerinfo =
-00014750: 204e 6f6e 650a 2020 2020 6966 2077 6865   None.    if whe
-00014760: 7265 2069 7320 6e6f 7420 4e6f 6e65 3a0a  re is not None:.
-00014770: 2020 2020 2020 2020 7372 635f 6c61 7965          src_laye
-00014780: 7269 6e66 6f20 3d20 6765 745f 6c61 7965  rinfo = get_laye
-00014790: 7269 6e66 6f28 7372 632c 2073 7263 5f6c  rinfo(src, src_l
-000147a0: 6179 6572 2c20 7261 6973 655f 6f6e 5f6e  ayer, raise_on_n
-000147b0: 6f67 656f 6d3d 4661 6c73 6529 0a20 2020  ogeom=False).   
-000147c0: 2020 2020 2077 6865 7265 203d 2077 6865       where = whe
-000147d0: 7265 2e66 6f72 6d61 7428 6765 6f6d 6574  re.format(geomet
-000147e0: 7279 636f 6c75 6d6e 3d73 7263 5f6c 6179  rycolumn=src_lay
-000147f0: 6572 696e 666f 2e67 656f 6d65 7472 7963  erinfo.geometryc
-00014800: 6f6c 756d 6e29 0a0a 2020 2020 6966 2073  olumn)..    if s
-00014810: 716c 5f73 746d 7420 6973 206e 6f74 204e  ql_stmt is not N
-00014820: 6f6e 653a 0a20 2020 2020 2020 2023 2046  one:.        # F
-00014830: 696c 6c20 6f75 7420 706c 6163 6568 6f6c  ill out placehol
-00014840: 6465 7273 2e0a 2020 2020 2020 2020 7371  ders..        sq
-00014850: 6c5f 7374 6d74 203d 205f 6669 6c6c 5f6f  l_stmt = _fill_o
-00014860: 7574 5f73 716c 5f70 6c61 6365 686f 6c64  ut_sql_placehold
-00014870: 6572 7328 0a20 2020 2020 2020 2020 2020  ers(.           
-00014880: 2070 6174 683d 7372 632c 206c 6179 6572   path=src, layer
-00014890: 3d73 7263 5f6c 6179 6572 2c20 7371 6c5f  =src_layer, sql_
-000148a0: 7374 6d74 3d73 716c 5f73 746d 742c 2063  stmt=sql_stmt, c
-000148b0: 6f6c 756d 6e73 3d63 6f6c 756d 6e73 0a20  olumns=columns. 
-000148c0: 2020 2020 2020 2029 0a0a 2020 2020 2320         )..    # 
-000148d0: 5768 656e 2063 7265 6174 696e 672f 6170  When creating/ap
-000148e0: 7065 6e64 696e 6720 746f 2061 2073 6861  pending to a sha
-000148f0: 7065 6669 6c65 2c20 736f 6d65 2065 7874  pefile, some ext
-00014900: 7261 2074 6869 6e67 7320 6e65 6564 2074  ra things need t
-00014910: 6f20 6265 2064 6f6e 652f 6368 6563 6b65  o be done/checke
-00014920: 642e 0a20 2020 2069 6620 7371 6c5f 7374  d..    if sql_st
-00014930: 6d74 2069 7320 4e6f 6e65 2061 6e64 2064  mt is None and d
-00014940: 7374 2e73 7566 6669 782e 6c6f 7765 7228  st.suffix.lower(
-00014950: 2920 3d3d 2022 2e73 6870 223a 0a20 2020  ) == ".shp":.   
-00014960: 2020 2020 2023 2049 6620 7468 6520 6465       # If the de
-00014970: 7374 696e 6174 696f 6e20 6669 6c65 2064  stination file d
-00014980: 6f65 736e 2774 2065 7869 7374 2079 6574  oesn't exist yet
-00014990: 2c20 616e 6420 7468 6520 736f 7572 6365  , and the source
-000149a0: 2066 696c 6520 6861 730a 2020 2020 2020   file has.      
-000149b0: 2020 2320 6765 6f6d 6574 7279 7479 7065    # geometrytype
-000149c0: 2022 4765 6f6d 6574 7279 222c 2072 6169   "Geometry", rai
-000149d0: 7365 2062 6563 6175 7365 2074 7970 6520  se because type 
-000149e0: 6973 206e 6f74 2073 7570 706f 7274 6564  is not supported
-000149f0: 2062 7920 7368 7020 2861 6e64 2077 696c   by shp (and wil
-00014a00: 6c0a 2020 2020 2020 2020 2320 6465 6661  l.        # defa
-00014a10: 756c 7420 746f 206c 696e 6573 7472 696e  ult to linestrin
-00014a20: 6729 2e0a 2020 2020 2020 2020 6966 2073  g)..        if s
-00014a30: 7263 5f6c 6179 6572 696e 666f 2069 7320  rc_layerinfo is 
-00014a40: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00014a50: 2020 7372 635f 6c61 7965 7269 6e66 6f20    src_layerinfo 
-00014a60: 3d20 6765 745f 6c61 7965 7269 6e66 6f28  = get_layerinfo(
-00014a70: 7372 632c 2073 7263 5f6c 6179 6572 2c20  src, src_layer, 
-00014a80: 7261 6973 655f 6f6e 5f6e 6f67 656f 6d3d  raise_on_nogeom=
-00014a90: 4661 6c73 6529 0a20 2020 2020 2020 2069  False).        i
-00014aa0: 6620 280a 2020 2020 2020 2020 2020 2020  f (.            
-00014ab0: 666f 7263 655f 6f75 7470 7574 5f67 656f  force_output_geo
-00014ac0: 6d65 7472 7974 7970 6520 6973 204e 6f6e  metrytype is Non
-00014ad0: 650a 2020 2020 2020 2020 2020 2020 616e  e.            an
-00014ae0: 6420 7372 635f 6c61 7965 7269 6e66 6f2e  d src_layerinfo.
-00014af0: 6765 6f6d 6574 7279 7479 7065 0a20 2020  geometrytype.   
-00014b00: 2020 2020 2020 2020 2069 6e20 5b47 656f           in [Geo
-00014b10: 6d65 7472 7954 7970 652e 4745 4f4d 4554  metryType.GEOMET
-00014b20: 5259 2c20 4765 6f6d 6574 7279 5479 7065  RY, GeometryType
-00014b30: 2e47 454f 4d45 5452 5943 4f4c 4c45 4354  .GEOMETRYCOLLECT
-00014b40: 494f 4e5d 0a20 2020 2020 2020 2020 2020  ION].           
-00014b50: 2061 6e64 206e 6f74 2064 7374 2e65 7869   and not dst.exi
-00014b60: 7374 7328 290a 2020 2020 2020 2020 293a  sts().        ):
-00014b70: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-00014b80: 7365 2056 616c 7565 4572 726f 7228 0a20  se ValueError(. 
-00014b90: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00014ba0: 2273 7263 2066 696c 6520 7b73 7263 7d20  "src file {src} 
-00014bb0: 6861 7320 6765 6f6d 6574 7279 7479 7065  has geometrytype
-00014bc0: 207b 7372 635f 6c61 7965 7269 6e66 6f2e   {src_layerinfo.
-00014bd0: 6765 6f6d 6574 7279 7479 7065 6e61 6d65  geometrytypename
-00014be0: 7d20 220a 2020 2020 2020 2020 2020 2020  } ".            
-00014bf0: 2020 2020 2277 6869 6368 2069 7320 6e6f      "which is no
-00014c00: 7420 7375 7070 6f72 7465 6420 696e 202e  t supported in .
-00014c10: 7368 702e 204d 6179 6265 2075 7365 2066  shp. Maybe use f
-00014c20: 6f72 6365 5f6f 7574 7075 745f 6765 6f6d  orce_output_geom
-00014c30: 6574 7279 7479 7065 3f22 0a20 2020 2020  etrytype?".     
-00014c40: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00014c50: 2020 2320 4c61 756e 6465 7220 7468 6520    # Launder the 
-00014c60: 636f 6c75 6d6e 7320 6e61 6d65 7320 7669  columns names vi
-00014c70: 6120 6120 5351 4c20 7374 6174 656d 656e  a a SQL statemen
-00014c80: 742c 206f 7468 6572 7769 7365 2077 6865  t, otherwise whe
-00014c90: 6e20 6170 7065 6e64 696e 6720 7468 650a  n appending the.
-00014ca0: 2020 2020 2020 2020 2320 6c61 756e 6465          # launde
-00014cb0: 7265 6420 636f 6c75 6d6e 7320 7769 6c6c  red columns will
-00014cc0: 2067 6574 204e 554c 4c20 7661 6c75 6573   get NULL values
-00014cd0: 2069 6e73 7465 6164 206f 6620 7468 6520   instead of the 
-00014ce0: 6461 7461 2e0a 2020 2020 2020 2020 6966  data..        if
-00014cf0: 2063 6f6c 756d 6e73 2069 7320 4e6f 6e65   columns is None
-00014d00: 3a0a 2020 2020 2020 2020 2020 2020 636f  :.            co
-00014d10: 6c75 6d6e 7320 3d20 7372 635f 6c61 7965  lumns = src_laye
-00014d20: 7269 6e66 6f2e 636f 6c75 6d6e 730a 2020  rinfo.columns.  
-00014d30: 2020 2020 2020 636f 6c75 6d6e 735f 6c61        columns_la
-00014d40: 756e 6465 7265 6420 3d20 5f6c 6175 6e64  undered = _laund
-00014d50: 6572 5f63 6f6c 756d 6e5f 6e61 6d65 7328  er_column_names(
-00014d60: 636f 6c75 6d6e 7329 0a20 2020 2020 2020  columns).       
-00014d70: 2063 6f6c 756d 6e73 5f61 6c69 6173 6564   columns_aliased
-00014d80: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
-00014d90: 2066 2722 7b63 6f6c 756d 6e7d 2220 4153   f'"{column}" AS
-00014da0: 2022 7b6c 6175 6e64 6572 6564 7d22 2720   "{laundered}"' 
-00014db0: 666f 7220 636f 6c75 6d6e 2c20 6c61 756e  for column, laun
-00014dc0: 6465 7265 6420 696e 2063 6f6c 756d 6e73  dered in columns
-00014dd0: 5f6c 6175 6e64 6572 6564 0a20 2020 2020  _laundered.     
-00014de0: 2020 205d 0a20 2020 2020 2020 2023 2049     ].        # I
-00014df0: 6620 7468 6572 6520 6973 2061 2077 6865  f there is a whe
-00014e00: 7265 2073 7065 6369 6669 6564 2c20 696e  re specified, in
-00014e10: 7465 6772 6174 6520 6974 2e2e 2e0a 2020  tegrate it....  
-00014e20: 2020 2020 2020 7768 6572 655f 636c 6175        where_clau
-00014e30: 7365 203d 2022 220a 2020 2020 2020 2020  se = "".        
-00014e40: 6966 2077 6865 7265 2069 7320 6e6f 7420  if where is not 
-00014e50: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00014e60: 2020 7768 6572 655f 636c 6175 7365 203d    where_clause =
-00014e70: 2066 2257 4845 5245 207b 7768 6572 657d   f"WHERE {where}
-00014e80: 220a 2020 2020 2020 2020 2020 2020 7768  ".            wh
-00014e90: 6572 6520 3d20 4e6f 6e65 0a20 2020 2020  ere = None.     
-00014ea0: 2020 2067 656f 6d65 7472 7963 6f6c 756d     geometrycolum
-00014eb0: 6e20 3d20 2222 0a20 2020 2020 2020 2069  n = "".        i
-00014ec0: 6620 7372 635f 6c61 7965 7269 6e66 6f2e  f src_layerinfo.
-00014ed0: 6765 6f6d 6574 7279 636f 6c75 6d6e 2069  geometrycolumn i
-00014ee0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00014ef0: 2020 2020 2020 2020 6765 6f6d 6574 7279          geometry
-00014f00: 636f 6c75 6d6e 203d 2066 227b 7372 635f  column = f"{src_
-00014f10: 6c61 7965 7269 6e66 6f2e 6765 6f6d 6574  layerinfo.geomet
-00014f20: 7279 636f 6c75 6d6e 7d2c 2022 0a20 2020  rycolumn}, ".   
-00014f30: 2020 2020 2073 716c 5f73 746d 7420 3d20       sql_stmt = 
-00014f40: 6622 2222 0a20 2020 2020 2020 2020 2020  f""".           
-00014f50: 2053 454c 4543 5420 7b67 656f 6d65 7472   SELECT {geometr
-00014f60: 7963 6f6c 756d 6e7d 7b22 2c20 222e 6a6f  ycolumn}{", ".jo
-00014f70: 696e 2863 6f6c 756d 6e73 5f61 6c69 6173  in(columns_alias
-00014f80: 6564 297d 0a20 2020 2020 2020 2020 2020  ed)}.           
-00014f90: 2020 2046 524f 4d20 227b 7372 635f 6c61     FROM "{src_la
-00014fa0: 7965 727d 220a 2020 2020 2020 2020 2020  yer}".          
-00014fb0: 2020 207b 7768 6572 655f 636c 6175 7365     {where_clause
-00014fc0: 7d0a 2020 2020 2020 2020 2222 220a 2020  }.        """.  
-00014fd0: 2020 2020 2020 7371 6c5f 6469 616c 6563        sql_dialec
-00014fe0: 7420 3d20 2253 514c 4954 4522 0a20 2020  t = "SQLITE".   
-00014ff0: 2020 2020 2063 6f6c 756d 6e73 203d 204e       columns = N
-00015000: 6f6e 650a 0a20 2020 2023 2057 6865 6e20  one..    # When 
-00015010: 6473 7420 6669 6c65 2064 6f65 736e 2774  dst file doesn't
-00015020: 2065 7869 7374 2061 6e64 2073 7263 2069   exist and src i
-00015030: 7320 656d 7074 7920 666f 7263 655f 6f75  s empty force_ou
-00015040: 7470 7574 5f67 656f 6d65 7472 7974 7970  tput_geometrytyp
-00015050: 6520 7368 6f75 6c64 2062 650a 2020 2020  e should be.    
-00015060: 2320 7370 6563 6966 6965 642c 206f 7468  # specified, oth
-00015070: 6572 7769 7365 2069 6e76 616c 6964 206f  erwise invalid o
-00015080: 7574 7075 742e 0a20 2020 2069 6620 666f  utput..    if fo
-00015090: 7263 655f 6f75 7470 7574 5f67 656f 6d65  rce_output_geome
-000150a0: 7472 7974 7970 6520 6973 204e 6f6e 6520  trytype is None 
-000150b0: 616e 6420 6e6f 7420 6473 742e 6578 6973  and not dst.exis
-000150c0: 7473 2829 3a0a 2020 2020 2020 2020 6966  ts():.        if
-000150d0: 2073 7263 5f6c 6179 6572 696e 666f 2069   src_layerinfo i
-000150e0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-000150f0: 2020 2020 7372 635f 6c61 7965 7269 6e66      src_layerinf
-00015100: 6f20 3d20 6765 745f 6c61 7965 7269 6e66  o = get_layerinf
-00015110: 6f28 7372 632c 2073 7263 5f6c 6179 6572  o(src, src_layer
-00015120: 2c20 7261 6973 655f 6f6e 5f6e 6f67 656f  , raise_on_nogeo
-00015130: 6d3d 4661 6c73 6529 0a20 2020 2020 2020  m=False).       
-00015140: 2066 6f72 6365 5f6f 7574 7075 745f 6765   force_output_ge
-00015150: 6f6d 6574 7279 7479 7065 203d 2073 7263  ometrytype = src
-00015160: 5f6c 6179 6572 696e 666f 2e67 656f 6d65  _layerinfo.geome
-00015170: 7472 7974 7970 650a 0a20 2020 2023 2047  trytype..    # G
-00015180: 6f21 0a20 2020 2074 7261 6e73 6c61 7465  o!.    translate
-00015190: 5f69 6e66 6f20 3d20 5f6f 6772 5f75 7469  _info = _ogr_uti
-000151a0: 6c2e 5665 6374 6f72 5472 616e 736c 6174  l.VectorTranslat
-000151b0: 6549 6e66 6f28 0a20 2020 2020 2020 2069  eInfo(.        i
-000151c0: 6e70 7574 5f70 6174 683d 7372 632c 0a20  nput_path=src,. 
-000151d0: 2020 2020 2020 206f 7574 7075 745f 7061         output_pa
-000151e0: 7468 3d64 7374 2c0a 2020 2020 2020 2020  th=dst,.        
-000151f0: 696e 7075 745f 6c61 7965 7273 3d73 7263  input_layers=src
-00015200: 5f6c 6179 6572 2c0a 2020 2020 2020 2020  _layer,.        
-00015210: 6f75 7470 7574 5f6c 6179 6572 3d64 7374  output_layer=dst
-00015220: 5f6c 6179 6572 2c0a 2020 2020 2020 2020  _layer,.        
-00015230: 696e 7075 745f 7372 733d 7372 635f 6372  input_srs=src_cr
-00015240: 732c 0a20 2020 2020 2020 206f 7574 7075  s,.        outpu
-00015250: 745f 7372 733d 6473 745f 6372 732c 0a20  t_srs=dst_crs,. 
-00015260: 2020 2020 2020 2063 6f6c 756d 6e73 3d63         columns=c
-00015270: 6f6c 756d 6e73 2c0a 2020 2020 2020 2020  olumns,.        
-00015280: 7371 6c5f 7374 6d74 3d73 716c 5f73 746d  sql_stmt=sql_stm
-00015290: 742c 0a20 2020 2020 2020 2073 716c 5f64  t,.        sql_d
-000152a0: 6961 6c65 6374 3d73 716c 5f64 6961 6c65  ialect=sql_diale
-000152b0: 6374 2c0a 2020 2020 2020 2020 7768 6572  ct,.        wher
-000152c0: 653d 7768 6572 652c 0a20 2020 2020 2020  e=where,.       
-000152d0: 2072 6570 726f 6a65 6374 3d72 6570 726f   reproject=repro
-000152e0: 6a65 6374 2c0a 2020 2020 2020 2020 7472  ject,.        tr
-000152f0: 616e 7361 6374 696f 6e5f 7369 7a65 3d74  ansaction_size=t
-00015300: 7261 6e73 6163 7469 6f6e 5f73 697a 652c  ransaction_size,
-00015310: 0a20 2020 2020 2020 2061 7070 656e 643d  .        append=
-00015320: 5472 7565 2c0a 2020 2020 2020 2020 7570  True,.        up
-00015330: 6461 7465 3d54 7275 652c 0a20 2020 2020  date=True,.     
-00015340: 2020 2065 7870 6c6f 6465 636f 6c6c 6563     explodecollec
-00015350: 7469 6f6e 733d 6578 706c 6f64 6563 6f6c  tions=explodecol
-00015360: 6c65 6374 696f 6e73 2c0a 2020 2020 2020  lections,.      
-00015370: 2020 666f 7263 655f 6f75 7470 7574 5f67    force_output_g
-00015380: 656f 6d65 7472 7974 7970 653d 666f 7263  eometrytype=forc
-00015390: 655f 6f75 7470 7574 5f67 656f 6d65 7472  e_output_geometr
-000153a0: 7974 7970 652c 0a20 2020 2020 2020 206f  ytype,.        o
-000153b0: 7074 696f 6e73 3d6f 7074 696f 6e73 2c0a  ptions=options,.
-000153c0: 2020 2020 2020 2020 7072 6573 6572 7665          preserve
-000153d0: 5f66 6964 3d70 7265 7365 7276 655f 6669  _fid=preserve_fi
-000153e0: 642c 0a20 2020 2020 2020 2064 7374 5f64  d,.        dst_d
-000153f0: 696d 656e 7369 6f6e 733d 6473 745f 6469  imensions=dst_di
-00015400: 6d65 6e73 696f 6e73 2c0a 2020 2020 290a  mensions,.    ).
-00015410: 2020 2020 5f6f 6772 5f75 7469 6c2e 7665      _ogr_util.ve
-00015420: 6374 6f72 5f74 7261 6e73 6c61 7465 5f62  ctor_translate_b
-00015430: 795f 696e 666f 2869 6e66 6f3d 7472 616e  y_info(info=tran
-00015440: 736c 6174 655f 696e 666f 290a 0a0a 6465  slate_info)...de
-00015450: 6620 636f 6e76 6572 7428 0a20 2020 2073  f convert(.    s
-00015460: 7263 3a20 556e 696f 6e5b 7374 722c 2022  rc: Union[str, "
-00015470: 6f73 2e50 6174 684c 696b 655b 416e 795d  os.PathLike[Any]
-00015480: 225d 2c0a 2020 2020 6473 743a 2055 6e69  "],.    dst: Uni
-00015490: 6f6e 5b73 7472 2c20 226f 732e 5061 7468  on[str, "os.Path
-000154a0: 4c69 6b65 5b41 6e79 5d22 5d2c 0a20 2020  Like[Any]"],.   
-000154b0: 2073 7263 5f6c 6179 6572 3a20 4f70 7469   src_layer: Opti
-000154c0: 6f6e 616c 5b73 7472 5d20 3d20 4e6f 6e65  onal[str] = None
-000154d0: 2c0a 2020 2020 6473 745f 6c61 7965 723a  ,.    dst_layer:
-000154e0: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
-000154f0: 204e 6f6e 652c 0a20 2020 2073 7263 5f63   None,.    src_c
-00015500: 7273 3a20 556e 696f 6e5b 7374 722c 2069  rs: Union[str, i
-00015510: 6e74 2c20 4e6f 6e65 5d20 3d20 4e6f 6e65  nt, None] = None
-00015520: 2c0a 2020 2020 6473 745f 6372 733a 2055  ,.    dst_crs: U
-00015530: 6e69 6f6e 5b73 7472 2c20 696e 742c 204e  nion[str, int, N
-00015540: 6f6e 655d 203d 204e 6f6e 652c 0a20 2020  one] = None,.   
-00015550: 2077 6865 7265 3a20 4f70 7469 6f6e 616c   where: Optional
-00015560: 5b73 7472 5d20 3d20 4e6f 6e65 2c0a 2020  [str] = None,.  
-00015570: 2020 7265 7072 6f6a 6563 743a 2062 6f6f    reproject: boo
-00015580: 6c20 3d20 4661 6c73 652c 0a20 2020 2065  l = False,.    e
-00015590: 7870 6c6f 6465 636f 6c6c 6563 7469 6f6e  xplodecollection
-000155a0: 733a 2062 6f6f 6c20 3d20 4661 6c73 652c  s: bool = False,
-000155b0: 0a20 2020 2066 6f72 6365 5f6f 7574 7075  .    force_outpu
-000155c0: 745f 6765 6f6d 6574 7279 7479 7065 3a20  t_geometrytype: 
-000155d0: 556e 696f 6e5b 4765 6f6d 6574 7279 5479  Union[GeometryTy
-000155e0: 7065 2c20 7374 722c 204e 6f6e 655d 203d  pe, str, None] =
-000155f0: 204e 6f6e 652c 0a20 2020 2063 7265 6174   None,.    creat
-00015600: 655f 7370 6174 6961 6c5f 696e 6465 783a  e_spatial_index:
-00015610: 204f 7074 696f 6e61 6c5b 626f 6f6c 5d20   Optional[bool] 
-00015620: 3d20 5472 7565 2c0a 2020 2020 7072 6573  = True,.    pres
-00015630: 6572 7665 5f66 6964 3a20 4f70 7469 6f6e  erve_fid: Option
-00015640: 616c 5b62 6f6f 6c5d 203d 204e 6f6e 652c  al[bool] = None,
-00015650: 0a20 2020 206f 7074 696f 6e73 3a20 6469  .    options: di
-00015660: 6374 203d 207b 7d2c 0a20 2020 2061 7070  ct = {},.    app
-00015670: 656e 643a 2062 6f6f 6c20 3d20 4661 6c73  end: bool = Fals
-00015680: 652c 0a20 2020 2066 6f72 6365 3a20 626f  e,.    force: bo
-00015690: 6f6c 203d 2046 616c 7365 2c0a 293a 0a20  ol = False,.):. 
-000156a0: 2020 2022 2222 0a20 2020 2044 4550 5245     """.    DEPRE
-000156b0: 4341 5445 443a 2070 6c65 6173 6520 7573  CATED: please us
-000156c0: 6520 636f 7079 5f6c 6179 6572 2e0a 2020  e copy_layer..  
-000156d0: 2020 2222 220a 2020 2020 7761 726e 696e    """.    warnin
-000156e0: 6773 2e77 6172 6e28 2263 6f6e 7665 7274  gs.warn("convert
-000156f0: 2069 7320 6465 7072 6563 6174 6564 3a20   is deprecated: 
-00015700: 7573 6520 636f 7079 5f6c 6179 6572 2e22  use copy_layer."
-00015710: 2c20 4675 7475 7265 5761 726e 696e 672c  , FutureWarning,
-00015720: 2073 7461 636b 6c65 7665 6c3d 3229 0a20   stacklevel=2). 
-00015730: 2020 2072 6574 7572 6e20 636f 7079 5f6c     return copy_l
-00015740: 6179 6572 280a 2020 2020 2020 2020 7372  ayer(.        sr
-00015750: 633d 7372 632c 0a20 2020 2020 2020 2064  c=src,.        d
-00015760: 7374 3d64 7374 2c0a 2020 2020 2020 2020  st=dst,.        
-00015770: 7372 635f 6c61 7965 723d 7372 635f 6c61  src_layer=src_la
-00015780: 7965 722c 0a20 2020 2020 2020 2064 7374  yer,.        dst
-00015790: 5f6c 6179 6572 3d64 7374 5f6c 6179 6572  _layer=dst_layer
-000157a0: 2c0a 2020 2020 2020 2020 7372 635f 6372  ,.        src_cr
-000157b0: 733d 7372 635f 6372 732c 0a20 2020 2020  s=src_crs,.     
-000157c0: 2020 2064 7374 5f63 7273 3d64 7374 5f63     dst_crs=dst_c
-000157d0: 7273 2c0a 2020 2020 2020 2020 7768 6572  rs,.        wher
-000157e0: 653d 7768 6572 652c 0a20 2020 2020 2020  e=where,.       
-000157f0: 2072 6570 726f 6a65 6374 3d72 6570 726f   reproject=repro
-00015800: 6a65 6374 2c0a 2020 2020 2020 2020 6578  ject,.        ex
-00015810: 706c 6f64 6563 6f6c 6c65 6374 696f 6e73  plodecollections
-00015820: 3d65 7870 6c6f 6465 636f 6c6c 6563 7469  =explodecollecti
-00015830: 6f6e 732c 0a20 2020 2020 2020 2066 6f72  ons,.        for
-00015840: 6365 5f6f 7574 7075 745f 6765 6f6d 6574  ce_output_geomet
-00015850: 7279 7479 7065 3d66 6f72 6365 5f6f 7574  rytype=force_out
-00015860: 7075 745f 6765 6f6d 6574 7279 7479 7065  put_geometrytype
-00015870: 2c0a 2020 2020 2020 2020 6372 6561 7465  ,.        create
-00015880: 5f73 7061 7469 616c 5f69 6e64 6578 3d63  _spatial_index=c
-00015890: 7265 6174 655f 7370 6174 6961 6c5f 696e  reate_spatial_in
-000158a0: 6465 782c 0a20 2020 2020 2020 2070 7265  dex,.        pre
-000158b0: 7365 7276 655f 6669 643d 7072 6573 6572  serve_fid=preser
-000158c0: 7665 5f66 6964 2c0a 2020 2020 2020 2020  ve_fid,.        
-000158d0: 6f70 7469 6f6e 733d 6f70 7469 6f6e 732c  options=options,
-000158e0: 0a20 2020 2020 2020 2061 7070 656e 643d  .        append=
-000158f0: 6170 7065 6e64 2c0a 2020 2020 2020 2020  append,.        
-00015900: 666f 7263 653d 666f 7263 652c 0a20 2020  force=force,.   
-00015910: 2029 0a0a 0a64 6566 2063 6f70 795f 6c61   )...def copy_la
-00015920: 7965 7228 0a20 2020 2073 7263 3a20 556e  yer(.    src: Un
-00015930: 696f 6e5b 7374 722c 2022 6f73 2e50 6174  ion[str, "os.Pat
-00015940: 684c 696b 655b 416e 795d 225d 2c0a 2020  hLike[Any]"],.  
-00015950: 2020 6473 743a 2055 6e69 6f6e 5b73 7472    dst: Union[str
-00015960: 2c20 226f 732e 5061 7468 4c69 6b65 5b41  , "os.PathLike[A
-00015970: 6e79 5d22 5d2c 0a20 2020 2073 7263 5f6c  ny]"],.    src_l
-00015980: 6179 6572 3a20 4f70 7469 6f6e 616c 5b73  ayer: Optional[s
-00015990: 7472 5d20 3d20 4e6f 6e65 2c0a 2020 2020  tr] = None,.    
-000159a0: 6473 745f 6c61 7965 723a 204f 7074 696f  dst_layer: Optio
-000159b0: 6e61 6c5b 7374 725d 203d 204e 6f6e 652c  nal[str] = None,
-000159c0: 0a20 2020 2073 7263 5f63 7273 3a20 556e  .    src_crs: Un
-000159d0: 696f 6e5b 7374 722c 2069 6e74 2c20 4e6f  ion[str, int, No
-000159e0: 6e65 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ne] = None,.    
-000159f0: 6473 745f 6372 733a 2055 6e69 6f6e 5b73  dst_crs: Union[s
-00015a00: 7472 2c20 696e 742c 204e 6f6e 655d 203d  tr, int, None] =
-00015a10: 204e 6f6e 652c 0a20 2020 2063 6f6c 756d   None,.    colum
-00015a20: 6e73 3a20 4f70 7469 6f6e 616c 5b49 7465  ns: Optional[Ite
-00015a30: 7261 626c 655b 7374 725d 5d20 3d20 4e6f  rable[str]] = No
-00015a40: 6e65 2c0a 2020 2020 7768 6572 653a 204f  ne,.    where: O
-00015a50: 7074 696f 6e61 6c5b 7374 725d 203d 204e  ptional[str] = N
-00015a60: 6f6e 652c 0a20 2020 2073 716c 5f73 746d  one,.    sql_stm
-00015a70: 743a 204f 7074 696f 6e61 6c5b 7374 725d  t: Optional[str]
-00015a80: 203d 204e 6f6e 652c 0a20 2020 2073 716c   = None,.    sql
-00015a90: 5f64 6961 6c65 6374 3a20 4f70 7469 6f6e  _dialect: Option
-00015aa0: 616c 5b4c 6974 6572 616c 5b22 5351 4c49  al[Literal["SQLI
-00015ab0: 5445 222c 2022 4f47 5253 514c 225d 5d20  TE", "OGRSQL"]] 
-00015ac0: 3d20 4e6f 6e65 2c0a 2020 2020 7265 7072  = None,.    repr
-00015ad0: 6f6a 6563 743a 2062 6f6f 6c20 3d20 4661  oject: bool = Fa
-00015ae0: 6c73 652c 0a20 2020 2065 7870 6c6f 6465  lse,.    explode
-00015af0: 636f 6c6c 6563 7469 6f6e 733a 2062 6f6f  collections: boo
-00015b00: 6c20 3d20 4661 6c73 652c 0a20 2020 2066  l = False,.    f
-00015b10: 6f72 6365 5f6f 7574 7075 745f 6765 6f6d  orce_output_geom
-00015b20: 6574 7279 7479 7065 3a20 556e 696f 6e5b  etrytype: Union[
-00015b30: 4765 6f6d 6574 7279 5479 7065 2c20 7374  GeometryType, st
-00015b40: 722c 204e 6f6e 655d 203d 204e 6f6e 652c  r, None] = None,
-00015b50: 0a20 2020 2063 7265 6174 655f 7370 6174  .    create_spat
-00015b60: 6961 6c5f 696e 6465 783a 204f 7074 696f  ial_index: Optio
-00015b70: 6e61 6c5b 626f 6f6c 5d20 3d20 5472 7565  nal[bool] = True
-00015b80: 2c0a 2020 2020 7072 6573 6572 7665 5f66  ,.    preserve_f
-00015b90: 6964 3a20 4f70 7469 6f6e 616c 5b62 6f6f  id: Optional[boo
-00015ba0: 6c5d 203d 204e 6f6e 652c 0a20 2020 2064  l] = None,.    d
-00015bb0: 7374 5f64 696d 656e 7369 6f6e 733a 204f  st_dimensions: O
-00015bc0: 7074 696f 6e61 6c5b 7374 725d 203d 204e  ptional[str] = N
-00015bd0: 6f6e 652c 0a20 2020 206f 7074 696f 6e73  one,.    options
-00015be0: 3a20 6469 6374 203d 207b 7d2c 0a20 2020  : dict = {},.   
-00015bf0: 2061 7070 656e 643a 2062 6f6f 6c20 3d20   append: bool = 
-00015c00: 4661 6c73 652c 0a20 2020 2066 6f72 6365  False,.    force
-00015c10: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
-00015c20: 293a 0a20 2020 2022 2222 0a20 2020 2052  ):.    """.    R
-00015c30: 6561 6420 6120 6c61 7965 7220 6672 6f6d  ead a layer from
-00015c40: 2061 2073 6f75 7263 6520 6669 6c65 2061   a source file a
-00015c50: 6e64 2077 7269 7465 2069 7420 746f 2061  nd write it to a
-00015c60: 206e 6577 2064 6573 7469 6e61 7469 6f6e   new destination
-00015c70: 2066 696c 652e 0a0a 2020 2020 5479 7069   file...    Typi
-00015c80: 6361 6c6c 7920 7573 6564 2074 6f20 636f  cally used to co
-00015c90: 6e76 6572 7420 6672 6f6d 206f 6e65 2066  nvert from one f
-00015ca0: 696c 6566 6f72 6d61 7420 746f 2061 6e6f  ileformat to ano
-00015cb0: 7468 6572 206f 7220 746f 2072 6570 726f  ther or to repro
-00015cc0: 6a65 6374 2e0a 0a20 2020 2054 6865 206f  ject...    The o
-00015cd0: 7074 696f 6e73 2070 6172 616d 6574 6572  ptions parameter
-00015ce0: 2063 616e 2062 6520 7573 6564 2074 6f20   can be used to 
-00015cf0: 7061 7373 2061 6e79 2074 7970 6520 6f66  pass any type of
-00015d00: 206f 7074 696f 6e73 2074 6f20 4744 414c   options to GDAL
-00015d10: 2069 6e0a 2020 2020 7468 6520 666f 6c6c   in.    the foll
-00015d20: 6f77 696e 6720 666f 726d 3a0a 2020 2020  owing form:.    
-00015d30: 2020 2020 7b20 223c 6f70 7469 6f6e 5f74      { "<option_t
-00015d40: 7970 653e 2e3c 6f70 7469 6f6e 5f6e 616d  ype>.<option_nam
-00015d50: 653e 223a 203c 6f70 7469 6f6e 5f76 616c  e>": <option_val
-00015d60: 7565 3e20 7d0a 0a20 2020 2054 6865 206f  ue> }..    The o
-00015d70: 7074 696f 6e20 7479 7065 7320 6361 6e20  ption types can 
-00015d80: 6265 2061 6e79 206f 6620 7468 6520 666f  be any of the fo
-00015d90: 6c6c 6f77 696e 673a 0a20 2020 2020 2020  llowing:.       
-00015da0: 202d 204c 4159 4552 5f43 5245 4154 494f   - LAYER_CREATIO
-00015db0: 4e3a 206c 6179 6572 2063 7265 6174 696f  N: layer creatio
-00015dc0: 6e20 6f70 7469 6f6e 2028 6c63 6f29 0a20  n option (lco). 
-00015dd0: 2020 2020 2020 202d 2044 4154 4153 4554         - DATASET
-00015de0: 5f43 5245 4154 494f 4e3a 2064 6174 6173  _CREATION: datas
-00015df0: 6574 2063 7265 6174 696f 6e20 6f70 7469  et creation opti
-00015e00: 6f6e 2028 6473 636f 290a 2020 2020 2020  on (dsco).      
-00015e10: 2020 2d20 494e 5055 545f 4f50 454e 3a20    - INPUT_OPEN: 
-00015e20: 696e 7075 7420 6461 7461 7365 7420 6f70  input dataset op
-00015e30: 656e 206f 7074 696f 6e20 286f 6f29 0a20  en option (oo). 
-00015e40: 2020 2020 2020 202d 2044 4553 5449 4e41         - DESTINA
-00015e50: 5449 4f4e 5f4f 5045 4e3a 2064 6573 7469  TION_OPEN: desti
-00015e60: 6e61 7469 6f6e 2064 6174 6173 6574 206f  nation dataset o
-00015e70: 7065 6e20 6f70 7469 6f6e 2028 646f 6f29  pen option (doo)
-00015e80: 0a20 2020 2020 2020 202d 2043 4f4e 4649  .        - CONFI
-00015e90: 473a 2063 6f6e 6669 6720 6f70 7469 6f6e  G: config option
-00015ea0: 2028 636f 6e66 6967 290a 0a20 2020 2054   (config)..    T
-00015eb0: 6865 206f 7074 696f 6e73 2063 616e 2062  he options can b
-00015ec0: 6520 666f 756e 6420 696e 2074 6865 207c  e found in the |
-00015ed0: 4744 414c 5f76 6563 746f 725f 6472 6976  GDAL_vector_driv
-00015ee0: 6572 5f64 6f63 756d 656e 7461 7469 6f6e  er_documentation
-00015ef0: 7c2e 0a0a 2020 2020 4172 6773 3a0a 2020  |...    Args:.  
-00015f00: 2020 2020 2020 7372 6320 2850 6174 684c        src (PathL
-00015f10: 696b 6529 3a20 5468 6520 736f 7572 6365  ike): The source
-00015f20: 2066 696c 6520 7061 7468 2e0a 2020 2020   file path..    
-00015f30: 2020 2020 6473 7420 2850 6174 684c 696b      dst (PathLik
-00015f40: 6529 3a20 5468 6520 6465 7374 696e 6174  e): The destinat
-00015f50: 696f 6e20 6669 6c65 2070 6174 682e 0a20  ion file path.. 
-00015f60: 2020 2020 2020 2073 7263 5f6c 6179 6572         src_layer
-00015f70: 2028 7374 722c 206f 7074 696f 6e61 6c29   (str, optional)
-00015f80: 3a20 5468 6520 736f 7572 6365 206c 6179  : The source lay
-00015f90: 6572 2e20 4966 204e 6f6e 6520 616e 6420  er. If None and 
-00015fa0: 7468 6572 6520 6973 206f 6e6c 790a 2020  there is only.  
-00015fb0: 2020 2020 2020 2020 2020 6f6e 6520 6c61            one la
-00015fc0: 7965 7220 696e 2074 6865 2073 7263 2066  yer in the src f
-00015fd0: 696c 652c 2074 6861 7420 6c61 7965 7220  ile, that layer 
-00015fe0: 6973 2074 616b 656e 2e20 4465 6661 756c  is taken. Defaul
-00015ff0: 7473 2074 6f20 4e6f 6e65 2e0a 2020 2020  ts to None..    
-00016000: 2020 2020 6473 745f 6c61 7965 7220 2873      dst_layer (s
-00016010: 7472 2c20 6f70 7469 6f6e 616c 293a 2054  tr, optional): T
-00016020: 6865 2064 6573 7469 6e61 7469 6f6e 206c  he destination l
-00016030: 6179 6572 2e20 4966 204e 6f6e 652c 2074  ayer. If None, t
-00016040: 6865 2066 696c 650a 2020 2020 2020 2020  he file.        
-00016050: 2020 2020 7374 656d 2069 7320 7461 6b65      stem is take
-00016060: 6e20 6173 206c 6179 6572 206e 616d 652e  n as layer name.
-00016070: 2044 6566 6175 6c74 7320 746f 204e 6f6e   Defaults to Non
-00016080: 652e 0a20 2020 2020 2020 2073 7263 5f63  e..        src_c
-00016090: 7273 2028 556e 696f 6e5b 7374 722c 2069  rs (Union[str, i
-000160a0: 6e74 5d2c 206f 7074 696f 6e61 6c29 3a20  nt], optional): 
-000160b0: 616e 2065 7073 6720 696e 7420 6f72 2061  an epsg int or a
-000160c0: 6e79 7468 696e 6720 7375 7070 6f72 7465  nything supporte
-000160d0: 640a 2020 2020 2020 2020 2020 2020 6279  d.            by
-000160e0: 2074 6865 204f 4752 5370 6174 6961 6c52   the OGRSpatialR
-000160f0: 6566 6572 656e 6365 2e53 6574 4672 6f6d  eference.SetFrom
-00016100: 5573 6572 496e 7075 7428 2920 6361 6c6c  UserInput() call
-00016110: 2c20 7768 6963 6820 696e 636c 7564 6573  , which includes
-00016120: 0a20 2020 2020 2020 2020 2020 2061 6e20  .            an 
-00016130: 4550 5347 2073 7472 696e 6720 2865 672e  EPSG string (eg.
-00016140: 2022 4550 5347 3a34 3332 3622 292c 2061   "EPSG:4326"), a
-00016150: 2077 656c 6c20 6b6e 6f77 6e20 7465 7874   well known text
-00016160: 2028 574b 5429 2043 5253 0a20 2020 2020   (WKT) CRS.     
-00016170: 2020 2020 2020 2064 6566 696e 6974 696f         definitio
-00016180: 6e2c 2e2e 2e20 4465 6661 756c 7473 2074  n,... Defaults t
-00016190: 6f20 4e6f 6e65 2e0a 2020 2020 2020 2020  o None..        
-000161a0: 6473 745f 6372 7320 2855 6e69 6f6e 5b73  dst_crs (Union[s
-000161b0: 7472 2c20 696e 745d 2c20 6f70 7469 6f6e  tr, int], option
-000161c0: 616c 293a 2061 6e20 6570 7367 2069 6e74  al): an epsg int
-000161d0: 206f 7220 616e 7974 6869 6e67 2073 7570   or anything sup
-000161e0: 706f 7274 6564 0a20 2020 2020 2020 2020  ported.         
-000161f0: 2020 2062 7920 7468 6520 4f47 5253 7061     by the OGRSpa
-00016200: 7469 616c 5265 6665 7265 6e63 652e 5365  tialReference.Se
-00016210: 7446 726f 6d55 7365 7249 6e70 7574 2829  tFromUserInput()
-00016220: 2063 616c 6c2c 2077 6869 6368 2069 6e63   call, which inc
-00016230: 6c75 6465 730a 2020 2020 2020 2020 2020  ludes.          
-00016240: 2020 616e 2045 5053 4720 7374 7269 6e67    an EPSG string
-00016250: 2028 6567 2e20 2245 5053 473a 3433 3236   (eg. "EPSG:4326
-00016260: 2229 2c20 6120 7765 6c6c 206b 6e6f 776e  "), a well known
-00016270: 2074 6578 7420 2857 4b54 2920 4352 530a   text (WKT) CRS.
-00016280: 2020 2020 2020 2020 2020 2020 6465 6669              defi
-00016290: 6e69 7469 6f6e 2c2e 2e2e 2044 6566 6175  nition,... Defau
-000162a0: 6c74 7320 746f 204e 6f6e 652e 0a20 2020  lts to None..   
-000162b0: 2020 2020 2063 6f6c 756d 6e73 2028 4974       columns (It
-000162c0: 6572 6162 6c65 5b73 7472 5d2c 206f 7074  erable[str], opt
-000162d0: 696f 6e61 6c29 3a20 5468 6520 286e 6f6e  ional): The (non
-000162e0: 2d67 656f 6d65 7472 7929 2063 6f6c 756d  -geometry) colum
-000162f0: 6e73 2074 6f20 7265 6164 2077 696c 6c0a  ns to read will.
-00016300: 2020 2020 2020 2020 2020 2020 6265 2072              be r
-00016310: 6574 7572 6e65 6420 696e 2074 6865 206f  eturned in the o
-00016320: 7264 6572 2073 7065 6369 6669 6564 2e20  rder specified. 
-00016330: 4966 204e 6f6e 652c 2061 6c6c 2073 7461  If None, all sta
-00016340: 6e64 6172 6420 636f 6c75 6d6e 7320 6172  ndard columns ar
-00016350: 6520 7265 6164 2e0a 2020 2020 2020 2020  e read..        
-00016360: 2020 2020 496e 2061 6464 6974 696f 6e20      In addition 
-00016370: 746f 2073 7461 6e64 6172 6420 636f 6c75  to standard colu
-00016380: 6d6e 732c 2069 7420 6973 2061 6c73 6f20  mns, it is also 
-00016390: 706f 7373 6962 6c65 0a20 2020 2020 2020  possible.       
-000163a0: 2020 2020 2074 6f20 7370 6563 6966 7920       to specify 
-000163b0: 2266 6964 222c 2061 2075 6e69 7175 6520  "fid", a unique 
-000163c0: 696e 6465 7820 6176 6169 6c61 626c 6520  index available 
-000163d0: 696e 2061 6c6c 2069 6e70 7574 2066 696c  in all input fil
-000163e0: 6573 2e20 4e6f 7465 2074 6861 7420 7468  es. Note that th
-000163f0: 650a 2020 2020 2020 2020 2020 2020 2266  e.            "f
-00016400: 6964 2220 7769 6c6c 2062 6520 616c 6961  id" will be alia
-00016410: 7365 6420 6567 2e20 746f 2022 6669 645f  sed eg. to "fid_
-00016420: 3122 2e20 4465 6661 756c 7473 2074 6f20  1". Defaults to 
-00016430: 4e6f 6e65 2e0a 2020 2020 2020 2020 7768  None..        wh
-00016440: 6572 6520 2873 7472 2c20 6f70 7469 6f6e  ere (str, option
-00016450: 616c 293a 206f 6e6c 7920 6170 7065 6e64  al): only append
-00016460: 2074 6865 2072 6f77 7320 6672 6f6d 2073   the rows from s
-00016470: 7263 2074 6861 7420 636f 6d70 6c79 2074  rc that comply t
-00016480: 6f20 7468 6520 6669 6c74 6572 0a20 2020  o the filter.   
-00016490: 2020 2020 2020 2020 2073 7065 6369 6669           specifi
-000164a0: 6564 2e20 4170 706c 6965 6420 6265 666f  ed. Applied befo
-000164b0: 7265 2060 6065 7870 6c6f 6465 636f 6c6c  re ``explodecoll
-000164c0: 6563 7469 6f6e 7360 602e 2046 696c 7465  ections``. Filte
-000164d0: 7220 7368 6f75 6c64 2062 6520 696e 2073  r should be in s
-000164e0: 716c 6974 650a 2020 2020 2020 2020 2020  qlite.          
-000164f0: 2020 5351 4c20 5748 4552 4520 7379 6e74    SQL WHERE synt
-00016500: 6178 2061 6e64 207c 7370 6174 6961 6c69  ax and |spatiali
-00016510: 7465 5f72 6566 6572 656e 6365 5f6c 696e  te_reference_lin
-00016520: 6b7c 2066 756e 6374 696f 6e73 2063 616e  k| functions can
-00016530: 2062 6520 7573 6564 2e20 4966 0a20 2020   be used. If.   
-00016540: 2020 2020 2020 2020 2077 6865 7265 2063           where c
-00016550: 6f6e 7461 696e 7320 7468 6520 7b67 656f  ontains the {geo
-00016560: 6d65 7472 7963 6f6c 756d 6e7d 2070 6c61  metrycolumn} pla
-00016570: 6365 686f 6c64 6572 2c20 6974 2069 7320  ceholder, it is 
-00016580: 6669 6c6c 6564 206f 7574 2077 6974 6820  filled out with 
-00016590: 7468 650a 2020 2020 2020 2020 2020 2020  the.            
-000165a0: 6765 6f6d 6574 7279 2063 6f6c 756d 6e20  geometry column 
-000165b0: 6e61 6d65 206f 6620 7468 6520 7372 6320  name of the src 
-000165c0: 6669 6c65 2e20 4465 6661 756c 7473 2074  file. Defaults t
-000165d0: 6f20 4e6f 6e65 2e0a 2020 2020 2020 2020  o None..        
-000165e0: 7371 6c5f 7374 6d74 2028 7374 7229 3a20  sql_stmt (str): 
-000165f0: 5351 4c20 7374 6174 656d 656e 7420 746f  SQL statement to
-00016600: 2075 7365 2e20 4f6e 6c79 2073 7570 706f   use. Only suppo
-00016610: 7274 6564 2077 6974 6820 2270 796f 6772  rted with "pyogr
-00016620: 696f 2220 656e 6769 6e65 2e0a 2020 2020  io" engine..    
-00016630: 2020 2020 7371 6c5f 6469 616c 6563 7420      sql_dialect 
-00016640: 2873 7472 2c20 6f70 7469 6f6e 616c 293a  (str, optional):
-00016650: 2053 514c 2064 6961 6c65 6374 2075 7365   SQL dialect use
-00016660: 642e 204f 7074 696f 6e73 2061 7265 204e  d. Options are N
-00016670: 6f6e 652c 2022 5351 4c49 5445 2220 6f72  one, "SQLITE" or
-00016680: 0a20 2020 2020 2020 2020 2020 2022 4f47  .            "OG
-00016690: 5253 514c 222e 2049 6620 4e6f 6e65 2c20  RSQL". If None, 
-000166a0: 666f 7220 6461 7461 2073 6f75 7263 6573  for data sources
-000166b0: 2077 6974 6820 6578 706c 6963 6974 2053   with explicit S
-000166c0: 514c 2073 7570 706f 7274 2074 6865 2073  QL support the s
-000166d0: 7461 7465 6d65 6e74 0a20 2020 2020 2020  tatement.       
-000166e0: 2020 2020 2069 7320 7072 6f63 6573 7365       is processe
-000166f0: 6420 6279 2074 6865 2064 6566 6175 6c74  d by the default
-00016700: 2053 514c 2065 6e67 696e 6520 2865 2e67   SQL engine (e.g
-00016710: 2e20 666f 7220 4765 6f70 6163 6b61 6765  . for Geopackage
-00016720: 2061 6e64 2053 7061 7469 616c 6974 650a   and Spatialite.
-00016730: 2020 2020 2020 2020 2020 2020 7468 6973              this
-00016740: 2069 7320 2253 514c 4954 4522 292e 2046   is "SQLITE"). F
-00016750: 6f72 2064 6174 6120 736f 7572 6365 7320  or data sources 
-00016760: 7769 7468 6f75 7420 6e61 7469 7665 2053  without native S
-00016770: 514c 2073 7570 706f 7274 2028 652e 672e  QL support (e.g.
-00016780: 202e 7368 7029 2c0a 2020 2020 2020 2020   .shp),.        
-00016790: 2020 2020 7468 6520 224f 4752 5351 4c22      the "OGRSQL"
-000167a0: 2064 6961 6c65 6374 2069 7320 7468 6520   dialect is the 
-000167b0: 6465 6661 756c 742e 2049 6620 7468 6520  default. If the 
-000167c0: 2253 514c 4954 4522 2064 6961 6c65 6374  "SQLITE" dialect
-000167d0: 2069 7320 7370 6563 6966 6965 642c 0a20   is specified,. 
-000167e0: 2020 2020 2020 2020 2020 207c 7370 6174             |spat
-000167f0: 6961 6c69 7465 5f72 6566 6572 656e 6365  ialite_reference
-00016800: 5f6c 696e 6b7c 2066 756e 6374 696f 6e73  _link| functions
-00016810: 2063 616e 2061 6c73 6f20 6265 2075 7365   can also be use
-00016820: 642e 2044 6566 6175 6c74 7320 746f 204e  d. Defaults to N
-00016830: 6f6e 652e 0a20 2020 2020 2020 2072 6570  one..        rep
-00016840: 726f 6a65 6374 2028 626f 6f6c 2c20 6f70  roject (bool, op
-00016850: 7469 6f6e 616c 293a 2054 7275 6520 746f  tional): True to
-00016860: 2072 6570 726f 6a65 6374 2077 6869 6c65   reproject while
-00016870: 2063 6f6e 7665 7274 696e 6720 7468 650a   converting the.
-00016880: 2020 2020 2020 2020 2020 2020 6669 6c65              file
-00016890: 2e20 4465 6661 756c 7473 2074 6f20 4661  . Defaults to Fa
-000168a0: 6c73 652e 0a20 2020 2020 2020 2065 7870  lse..        exp
-000168b0: 6c6f 6465 636f 6c6c 6563 7469 6f6e 7320  lodecollections 
-000168c0: 2862 6f6f 6c2c 206f 7074 696f 6e61 6c29  (bool, optional)
-000168d0: 3a20 5472 7565 2074 6f20 6f75 7470 7574  : True to output
-000168e0: 206f 6e6c 7920 7369 6d70 6c65 0a20 2020   only simple.   
-000168f0: 2020 2020 2020 2020 2067 656f 6d65 7472           geometr
-00016900: 6965 732e 2044 6566 6175 6c74 7320 746f  ies. Defaults to
-00016910: 2046 616c 7365 2e0a 2020 2020 2020 2020   False..        
-00016920: 666f 7263 655f 6f75 7470 7574 5f67 656f  force_output_geo
-00016930: 6d65 7472 7974 7970 6520 2855 6e69 6f6e  metrytype (Union
-00016940: 5b47 656f 6d65 7472 7954 7970 652c 2073  [GeometryType, s
-00016950: 7472 5d2c 206f 7074 696f 6e61 6c29 3a20  tr], optional): 
-00016960: 4765 6f6d 6574 7279 2074 7970 652e 0a20  Geometry type.. 
-00016970: 2020 2020 2020 2020 2020 2074 6f20 2874             to (t
-00016980: 7279 2074 6f29 2066 6f72 6365 2074 6865  ry to) force the
-00016990: 206f 7574 7075 7420 746f 2e20 4465 6661   output to. Defa
-000169a0: 756c 7473 2074 6f20 4e6f 6e65 2e0a 2020  ults to None..  
-000169b0: 2020 2020 2020 6372 6561 7465 5f73 7061        create_spa
-000169c0: 7469 616c 5f69 6e64 6578 2028 626f 6f6c  tial_index (bool
-000169d0: 2c20 6f70 7469 6f6e 616c 293a 2054 7275  , optional): Tru
-000169e0: 6520 746f 2063 7265 6174 6520 6120 7370  e to create a sp
-000169f0: 6174 6961 6c20 696e 6465 780a 2020 2020  atial index.    
-00016a00: 2020 2020 2020 2020 6f6e 2074 6865 2064          on the d
-00016a10: 6573 7469 6e61 7469 6f6e 2066 696c 652f  estination file/
-00016a20: 6c61 7965 722e 2049 6620 4e6f 6e65 2c20  layer. If None, 
-00016a30: 7468 6520 6465 6661 756c 7420 6265 6861  the default beha
-00016a40: 7669 6f75 7220 6279 2067 6461 6c20 666f  viour by gdal fo
-00016a50: 720a 2020 2020 2020 2020 2020 2020 7468  r.            th
-00016a60: 6174 2066 696c 6520 7479 7065 2069 7320  at file type is 
-00016a70: 7265 7370 6563 7465 642e 2049 6620 7468  respected. If th
-00016a80: 6520 4c41 5945 525f 4352 4541 5449 4f4e  e LAYER_CREATION
-00016a90: 2e53 5041 5449 414c 5f49 4e44 4558 0a20  .SPATIAL_INDEX. 
-00016aa0: 2020 2020 2020 2020 2020 2070 6172 616d             param
-00016ab0: 6574 6572 2069 7320 7370 6563 6966 6965  eter is specifie
-00016ac0: 6420 696e 206f 7074 696f 6e73 2c20 6372  d in options, cr
-00016ad0: 6561 7465 5f73 7061 7469 616c 5f69 6e64  eate_spatial_ind
-00016ae0: 6578 2069 7320 6967 6e6f 7265 642e 0a20  ex is ignored.. 
-00016af0: 2020 2020 2020 2020 2020 2044 6566 6175             Defau
-00016b00: 6c74 7320 746f 2054 7275 652e 0a20 2020  lts to True..   
-00016b10: 2020 2020 2070 7265 7365 7276 655f 6669       preserve_fi
-00016b20: 6420 2862 6f6f 6c2c 206f 7074 696f 6e61  d (bool, optiona
-00016b30: 6c29 3a20 5472 7565 2074 6f20 6d61 6b65  l): True to make
-00016b40: 2061 6e20 6578 7472 6120 6566 666f 7274   an extra effort
-00016b50: 2074 6f20 7072 6573 6572 7665 2066 6964   to preserve fid
-00016b60: 2773 206f 660a 2020 2020 2020 2020 2020  's of.          
-00016b70: 2020 7468 6520 736f 7572 6365 206c 6179    the source lay
-00016b80: 6572 2074 6f20 7468 6520 6465 7374 696e  er to the destin
-00016b90: 6174 696f 6e20 6c61 7965 722e 2046 616c  ation layer. Fal
-00016ba0: 7365 206e 6f74 2074 6f20 646f 2061 6e79  se not to do any
-00016bb0: 2065 6666 6f72 742e 204e 6f6e 650a 2020   effort. None.  
-00016bc0: 2020 2020 2020 2020 2020 746f 2075 7365            to use
-00016bd0: 2074 6865 2064 6566 6175 6c74 2062 6568   the default beh
-00016be0: 6176 696f 7572 206f 6620 6764 616c 2c20  aviour of gdal, 
-00016bf0: 7468 6174 2061 6c72 6561 6479 2070 7265  that already pre
-00016c00: 7365 7276 6573 2069 6e20 736f 6d65 2063  serves in some c
-00016c10: 6173 6573 2e0a 2020 2020 2020 2020 2020  ases..          
-00016c20: 2020 536f 6d65 2066 696c 6520 666f 726d    Some file form
-00016c30: 6174 7320 646f 6e27 7420 6578 706c 6963  ats don't explic
-00016c40: 6974 6c79 2073 746f 7265 2074 6865 2066  itly store the f
-00016c50: 6964 2028 652e 672e 2073 6861 7065 6669  id (e.g. shapefi
-00016c60: 6c65 292c 2073 6f20 7468 6579 0a20 2020  le), so they.   
-00016c70: 2020 2020 2020 2020 2077 696c 6c20 6e65           will ne
-00016c80: 7665 7220 6265 2061 626c 6520 746f 2070  ver be able to p
-00016c90: 7265 7365 7276 6520 6669 6473 2e20 4465  reserve fids. De
-00016ca0: 6661 756c 7473 2074 6f20 4e6f 6e65 2e0a  faults to None..
-00016cb0: 2020 2020 2020 2020 6473 745f 6469 6d65          dst_dime
-00016cc0: 6e73 696f 6e73 2028 7374 722c 206f 7074  nsions (str, opt
-00016cd0: 696f 6e61 6c29 3a20 466f 7263 6520 7468  ional): Force th
-00016ce0: 6520 6469 6d65 6e73 696f 6e73 206f 6620  e dimensions of 
-00016cf0: 7468 6520 6465 7374 696e 6174 696f 6e20  the destination 
-00016d00: 6c61 7965 7220 746f 0a20 2020 2020 2020  layer to.       
-00016d10: 2020 2020 2074 6865 2076 616c 7565 2073       the value s
-00016d20: 7065 6369 6669 6564 2e20 5661 6c69 6420  pecified. Valid 
-00016d30: 7661 6c75 6573 3a20 2258 5922 2c20 2258  values: "XY", "X
-00016d40: 595a 222c 2022 5859 4d22 206f 7220 2258  YZ", "XYM" or "X
-00016d50: 595a 4d22 2e0a 2020 2020 2020 2020 2020  YZM"..          
-00016d60: 2020 4465 6661 756c 7473 2074 6f20 4e6f    Defaults to No
-00016d70: 6e65 2e0a 2020 2020 2020 2020 6f70 7469  ne..        opti
-00016d80: 6f6e 7320 2864 6963 742c 206f 7074 696f  ons (dict, optio
-00016d90: 6e61 6c29 3a20 6f70 7469 6f6e 7320 746f  nal): options to
-00016da0: 2070 6173 7320 746f 2067 6461 6c2e 0a20   pass to gdal.. 
-00016db0: 2020 2020 2020 2061 7070 656e 6420 2862         append (b
-00016dc0: 6f6f 6c2c 206f 7074 696f 6e61 6c29 3a20  ool, optional): 
-00016dd0: 5472 7565 2074 6f20 6170 7065 6e64 2074  True to append t
-00016de0: 6f20 7468 6520 6f75 7470 7574 2066 696c  o the output fil
-00016df0: 6520 6966 2069 7420 6578 6973 7473 2e0a  e if it exists..
-00016e00: 2020 2020 2020 2020 2020 2020 4465 6661              Defa
-00016e10: 756c 7473 2074 6f20 4661 6c73 652e 0a20  ults to False.. 
-00016e20: 2020 2020 2020 2066 6f72 6365 2028 626f         force (bo
-00016e30: 6f6c 2c20 6f70 7469 6f6e 616c 293a 206f  ol, optional): o
-00016e40: 7665 7277 7269 7465 2065 7869 7374 696e  verwrite existin
-00016e50: 6720 6f75 7470 7574 2066 696c 6528 7329  g output file(s)
-00016e60: 0a20 2020 2020 2020 2020 2020 2044 6566  .            Def
-00016e70: 6175 6c74 7320 746f 2046 616c 7365 2e0a  aults to False..
-00016e80: 0a20 2020 202e 2e20 7c73 7061 7469 616c  .    .. |spatial
-00016e90: 6974 655f 7265 6665 7265 6e63 655f 6c69  ite_reference_li
-00016ea0: 6e6b 7c20 7261 773a 3a20 6874 6d6c 0a0a  nk| raw:: html..
-00016eb0: 2020 2020 2020 2020 3c61 2068 7265 663d          <a href=
-00016ec0: 2268 7474 7073 3a2f 2f77 7777 2e67 6169  "https://www.gai
-00016ed0: 612d 6769 732e 6974 2f67 6169 612d 7369  a-gis.it/gaia-si
-00016ee0: 6e73 2f73 7061 7469 616c 6974 652d 7371  ns/spatialite-sq
-00016ef0: 6c2d 6c61 7465 7374 2e68 746d 6c22 2074  l-latest.html" t
-00016f00: 6172 6765 743d 225f 626c 616e 6b22 3e73  arget="_blank">s
-00016f10: 7061 7469 616c 6974 6520 7265 6665 7265  patialite refere
-00016f20: 6e63 653c 2f61 3e0a 0a20 2020 202e 2e20  nce</a>..    .. 
-00016f30: 7c47 4441 4c5f 7665 6374 6f72 5f64 7269  |GDAL_vector_dri
-00016f40: 7665 725f 646f 6375 6d65 6e74 6174 696f  ver_documentatio
-00016f50: 6e7c 2072 6177 3a3a 2068 746d 6c0a 0a20  n| raw:: html.. 
-00016f60: 2020 2020 2020 203c 6120 6872 6566 3d22         <a href="
-00016f70: 6874 7470 733a 2f2f 6764 616c 2e6f 7267  https://gdal.org
-00016f80: 2f64 7269 7665 7273 2f76 6563 746f 722f  /drivers/vector/
-00016f90: 696e 6465 782e 6874 6d6c 2220 7461 7267  index.html" targ
-00016fa0: 6574 3d22 5f62 6c61 6e6b 223e 4744 414c  et="_blank">GDAL
-00016fb0: 2076 6563 746f 7220 6472 6976 6572 2064   vector driver d
-00016fc0: 6f63 756d 656e 7461 7469 6f6e 3c2f 613e  ocumentation</a>
-00016fd0: 0a0a 2020 2020 2222 2220 2023 206e 6f71  ..    """  # noq
-00016fe0: 613a 2045 3530 310a 2020 2020 2320 496e  a: E501.    # In
-00016ff0: 6974 0a20 2020 2073 7263 203d 2050 6174  it.    src = Pat
-00017000: 6828 7372 6329 0a20 2020 2064 7374 203d  h(src).    dst =
-00017010: 2050 6174 6828 6473 7429 0a0a 2020 2020   Path(dst)..    
-00017020: 2320 4966 2073 6f75 7263 6520 6669 6c65  # If source file
-00017030: 2064 6f65 736e 2774 2065 7869 7374 2c20   doesn't exist, 
-00017040: 7261 6973 6520 6572 726f 720a 2020 2020  raise error.    
-00017050: 6966 206e 6f74 2073 7263 2e65 7869 7374  if not src.exist
-00017060: 7328 293a 0a20 2020 2020 2020 2072 6169  s():.        rai
-00017070: 7365 2056 616c 7565 4572 726f 7228 6622  se ValueError(f"
-00017080: 7372 6320 6669 6c65 2064 6f65 736e 2774  src file doesn't
-00017090: 2065 7869 7374 3a20 7b73 7263 7d22 290a   exist: {src}").
-000170a0: 2020 2020 2320 4966 2064 6573 7420 6669      # If dest fi
-000170b0: 6c65 2065 7869 7374 7320 616c 7265 6164  le exists alread
-000170c0: 7920 616e 6420 6e6f 2061 7070 656e 640a  y and no append.
-000170d0: 2020 2020 6966 206e 6f74 2061 7070 656e      if not appen
-000170e0: 6420 616e 6420 6473 742e 6578 6973 7473  d and dst.exists
-000170f0: 2829 3a0a 2020 2020 2020 2020 6966 2066  ():.        if f
-00017100: 6f72 6365 2069 7320 5472 7565 3a0a 2020  orce is True:.  
-00017110: 2020 2020 2020 2020 2020 7265 6d6f 7665            remove
-00017120: 2864 7374 290a 2020 2020 2020 2020 656c  (dst).        el
-00017130: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00017140: 6c6f 6767 6572 2e69 6e66 6f28 6622 4f75  logger.info(f"Ou
-00017150: 7470 7574 2066 696c 6520 6578 6973 7473  tput file exists
-00017160: 2061 6c72 6561 6479 2c20 736f 2073 746f   already, so sto
-00017170: 703a 207b 6473 747d 2229 0a20 2020 2020  p: {dst}").     
-00017180: 2020 2020 2020 2072 6574 7572 6e0a 0a20         return.. 
-00017190: 2020 2023 2043 6f6e 7665 7274 0a20 2020     # Convert.   
-000171a0: 206c 6f67 6765 722e 696e 666f 2866 2243   logger.info(f"C
-000171b0: 6f70 7920 6c61 7965 7220 6672 6f6d 207b  opy layer from {
-000171c0: 7372 637d 2074 6f20 7b64 7374 7d22 290a  src} to {dst}").
-000171d0: 2020 2020 5f61 7070 656e 645f 746f 5f6e      _append_to_n
-000171e0: 6f6c 6f63 6b28 0a20 2020 2020 2020 2073  olock(.        s
-000171f0: 7263 2c0a 2020 2020 2020 2020 6473 742c  rc,.        dst,
-00017200: 0a20 2020 2020 2020 2073 7263 5f6c 6179  .        src_lay
-00017210: 6572 2c0a 2020 2020 2020 2020 6473 745f  er,.        dst_
-00017220: 6c61 7965 722c 0a20 2020 2020 2020 2073  layer,.        s
-00017230: 7263 5f63 7273 3d73 7263 5f63 7273 2c0a  rc_crs=src_crs,.
-00017240: 2020 2020 2020 2020 6473 745f 6372 733d          dst_crs=
-00017250: 6473 745f 6372 732c 0a20 2020 2020 2020  dst_crs,.       
-00017260: 2063 6f6c 756d 6e73 3d63 6f6c 756d 6e73   columns=columns
-00017270: 2c0a 2020 2020 2020 2020 7768 6572 653d  ,.        where=
-00017280: 7768 6572 652c 0a20 2020 2020 2020 2073  where,.        s
-00017290: 716c 5f73 746d 743d 7371 6c5f 7374 6d74  ql_stmt=sql_stmt
-000172a0: 2c0a 2020 2020 2020 2020 7371 6c5f 6469  ,.        sql_di
-000172b0: 616c 6563 743d 7371 6c5f 6469 616c 6563  alect=sql_dialec
-000172c0: 742c 0a20 2020 2020 2020 2072 6570 726f  t,.        repro
-000172d0: 6a65 6374 3d72 6570 726f 6a65 6374 2c0a  ject=reproject,.
-000172e0: 2020 2020 2020 2020 6578 706c 6f64 6563          explodec
-000172f0: 6f6c 6c65 6374 696f 6e73 3d65 7870 6c6f  ollections=explo
-00017300: 6465 636f 6c6c 6563 7469 6f6e 732c 0a20  decollections,. 
-00017310: 2020 2020 2020 2066 6f72 6365 5f6f 7574         force_out
-00017320: 7075 745f 6765 6f6d 6574 7279 7479 7065  put_geometrytype
-00017330: 3d66 6f72 6365 5f6f 7574 7075 745f 6765  =force_output_ge
-00017340: 6f6d 6574 7279 7479 7065 2c0a 2020 2020  ometrytype,.    
-00017350: 2020 2020 6372 6561 7465 5f73 7061 7469      create_spati
-00017360: 616c 5f69 6e64 6578 3d63 7265 6174 655f  al_index=create_
-00017370: 7370 6174 6961 6c5f 696e 6465 782c 0a20  spatial_index,. 
-00017380: 2020 2020 2020 2070 7265 7365 7276 655f         preserve_
-00017390: 6669 643d 7072 6573 6572 7665 5f66 6964  fid=preserve_fid
-000173a0: 2c0a 2020 2020 2020 2020 6473 745f 6469  ,.        dst_di
-000173b0: 6d65 6e73 696f 6e73 3d64 7374 5f64 696d  mensions=dst_dim
-000173c0: 656e 7369 6f6e 732c 0a20 2020 2020 2020  ensions,.       
-000173d0: 206f 7074 696f 6e73 3d6f 7074 696f 6e73   options=options
-000173e0: 2c0a 2020 2020 290a 0a0a 6465 6620 5f6c  ,.    )...def _l
-000173f0: 6175 6e64 6572 5f63 6f6c 756d 6e5f 6e61  aunder_column_na
-00017400: 6d65 7328 636f 6c75 6d6e 733a 2049 7465  mes(columns: Ite
-00017410: 7261 626c 6529 202d 3e20 4c69 7374 5b54  rable) -> List[T
-00017420: 7570 6c65 5b73 7472 2c20 7374 725d 5d3a  uple[str, str]]:
-00017430: 0a20 2020 2022 2222 0a20 2020 204c 6175  .    """.    Lau
-00017440: 6e64 6572 7320 7468 6520 636f 6c75 6d6e  nders the column
-00017450: 206e 616d 6573 2070 6173 7365 6420 746f   names passed to
-00017460: 2063 6f6d 706c 7920 7769 7468 2073 6861   comply with sha
-00017470: 7065 6669 6c65 2072 6573 7472 6963 7469  pefile restricti
-00017480: 6f6e 732e 0a0a 2020 2020 5261 7469 6f6e  ons...    Ration
-00017490: 616c 653a 206e 6f72 6d61 6c6c 7920 6764  ale: normally gd
-000174a0: 616c 206c 6175 6e64 6572 7320 7468 656d  al launders them
-000174b0: 2069 6620 6e65 6564 6564 2c20 6275 7420   if needed, but 
-000174c0: 7768 656e 2079 6f75 2061 7070 656e 640a  when you append.
-000174d0: 2020 2020 6d75 6c74 6970 6c65 2066 696c      multiple fil
-000174e0: 6573 2074 6f20 6120 7368 6170 6566 696c  es to a shapefil
-000174f0: 6520 7769 7468 2063 6f6c 756d 6e73 2074  e with columns t
-00017500: 6861 7420 6e65 6564 2074 6f20 6265 206c  hat need to be l
-00017510: 6175 6e64 6572 6564 0a20 2020 2074 6865  aundered.    the
-00017520: 7920 6172 6520 6e6f 7420 6d61 7463 6865  y are not matche
-00017530: 6420 616e 6420 736f 2061 7265 2061 7070  d and so are app
-00017540: 656e 6465 6420 7769 7468 204e 554c 4c20  ended with NULL 
-00017550: 7661 6c75 6573 2066 6f72 2074 6865 7365  values for these
-00017560: 0a20 2020 2063 6f6c 756d 6e73 2e20 4e6f  .    columns. No
-00017570: 726d 616c 6c79 2074 6865 202d 7265 6c61  rmally the -rela
-00017580: 7865 6446 6965 6c64 4e61 6d65 4d61 7463  xedFieldNameMatc
-00017590: 6820 7061 7261 6d65 7465 7220 696e 206f  h parameter in o
-000175a0: 6772 326f 6772 0a20 2020 2073 686f 756c  gr2ogr.    shoul
-000175b0: 6420 6669 7820 7468 6973 2c20 6275 7420  d fix this, but 
-000175c0: 6974 2073 6565 6d73 2074 6861 7420 7468  it seems that th
-000175d0: 6973 2069 736e 2774 2073 7570 706f 7274  is isn't support
-000175e0: 6564 2066 6f72 2073 6861 7065 6669 6c65  ed for shapefile
-000175f0: 732e 0a0a 2020 2020 4c61 756e 6465 7269  s...    Launderi
-00017600: 6e67 2069 7320 6261 7365 6420 6f6e 2074  ng is based on t
-00017610: 6869 7320 7465 7874 2066 726f 6d20 7468  his text from th
-00017620: 6520 6764 616c 2073 6861 7065 6669 6c65  e gdal shapefile
-00017630: 2064 7269 7665 720a 2020 2020 646f 6375   driver.    docu
-00017640: 6d65 6e74 6174 696f 6e3a 0a0a 2020 2020  mentation:..    
-00017650: 5368 6170 6566 696c 6520 6665 6174 7572  Shapefile featur
-00017660: 6520 6174 7472 6962 7574 6573 2061 7265  e attributes are
-00017670: 2073 746f 7265 6420 696e 2061 6e20 6173   stored in an as
-00017680: 736f 6369 6174 6564 202e 6462 6620 6669  sociated .dbf fi
-00017690: 6c65 2c20 616e 640a 2020 2020 736f 2061  le, and.    so a
-000176a0: 7474 7269 6275 7465 7320 7375 6666 6572  ttributes suffer
-000176b0: 2061 206e 756d 6265 7220 6f66 206c 696d   a number of lim
-000176c0: 6974 6174 696f 6e73 3a0a 2020 2020 2d20  itations:.    - 
-000176d0: 2020 4174 7472 6962 7574 6520 6e61 6d65    Attribute name
-000176e0: 7320 6361 6e20 6f6e 6c79 2062 6520 7570  s can only be up
-000176f0: 2074 6f20 3130 2063 6861 7261 6374 6572   to 10 character
-00017700: 7320 6c6f 6e67 2e0a 2020 2020 2020 2020  s long..        
-00017710: 5468 6520 4f47 5220 5368 6170 6566 696c  The OGR Shapefil
-00017720: 6520 6472 6976 6572 2074 7269 6573 2074  e driver tries t
-00017730: 6f20 6765 6e65 7261 7465 2075 6e69 7175  o generate uniqu
-00017740: 6520 6669 656c 640a 2020 2020 2020 2020  e field.        
-00017750: 6e61 6d65 732e 2053 7563 6365 7373 6976  names. Successiv
-00017760: 6520 6475 706c 6963 6174 6520 6669 656c  e duplicate fiel
-00017770: 6420 6e61 6d65 732c 2069 6e63 6c75 6469  d names, includi
-00017780: 6e67 2074 686f 7365 2063 7265 6174 6564  ng those created
-00017790: 2062 790a 2020 2020 2020 2020 7472 756e   by.        trun
-000177a0: 6361 7469 6f6e 2074 6f20 3130 2063 6861  cation to 10 cha
-000177b0: 7261 6374 6572 732c 2077 696c 6c20 6265  racters, will be
-000177c0: 2074 7275 6e63 6174 6564 2074 6f20 3820   truncated to 8 
-000177d0: 6368 6172 6163 7465 7273 2061 6e64 0a20  characters and. 
-000177e0: 2020 2020 2020 2061 7070 656e 6465 6420         appended 
-000177f0: 7769 7468 2061 2073 6572 6961 6c20 6e75  with a serial nu
-00017800: 6d62 6572 2066 726f 6d20 3120 746f 2039  mber from 1 to 9
-00017810: 392e 0a0a 2020 2020 2020 2020 466f 7220  9...        For 
-00017820: 6578 616d 706c 653a 0a0a 2020 2020 2020  example:..      
-00017830: 2020 2d20 2061 20e2 8692 2061 2c20 6120    -  a ... a, a 
-00017840: e286 9220 615f 312c 2041 20e2 8692 2041  ... a_1, A ... A
-00017850: 5f32 3b0a 2020 2020 2020 2020 2d20 2061  _2;.        -  a
-00017860: 6263 6465 6667 6869 6a6b 20e2 8692 2061  bcdefghijk ... a
-00017870: 6263 6465 6667 6869 6a2c 2061 6263 6465  bcdefghij, abcde
-00017880: 6667 6869 6a6b 6c20 e286 9220 6162 6364  fghijkl ... abcd
-00017890: 6566 6768 5f31 0a0a 2020 2020 2d20 2020  efgh_1..    -   
-000178a0: 4f6e 6c79 2049 6e74 6567 6572 2c20 496e  Only Integer, In
-000178b0: 7465 6765 7236 342c 2052 6561 6c2c 2053  teger64, Real, S
-000178c0: 7472 696e 6720 616e 6420 4461 7465 2028  tring and Date (
-000178d0: 6e6f 7420 4461 7465 5469 6d65 2c20 6a75  not DateTime, ju
-000178e0: 7374 0a20 2020 2020 2020 2079 6561 722f  st.        year/
-000178f0: 6d6f 6e74 682f 6461 7929 2066 6965 6c64  month/day) field
-00017900: 2074 7970 6573 2061 7265 2073 7570 706f   types are suppo
-00017910: 7274 6564 2e20 5468 6520 7661 7269 6f75  rted. The variou
-00017920: 7320 6c69 7374 2c20 616e 640a 2020 2020  s list, and.    
-00017930: 2020 2020 6269 6e61 7279 2066 6965 6c64      binary field
-00017940: 2074 7970 6573 2063 616e 6e6f 7420 6265   types cannot be
-00017950: 2063 7265 6174 6564 2e0a 2020 2020 2d20   created..    - 
-00017960: 2020 5468 6520 6669 656c 6420 7769 6474    The field widt
-00017970: 6820 616e 6420 7072 6563 6973 696f 6e20  h and precision 
-00017980: 6172 6520 6469 7265 6374 6c79 2075 7365  are directly use
-00017990: 6420 746f 2065 7374 6162 6c69 7368 2073  d to establish s
-000179a0: 746f 7261 6765 0a20 2020 2020 2020 2073  torage.        s
-000179b0: 697a 6520 696e 2074 6865 202e 6462 6620  ize in the .dbf 
-000179c0: 6669 6c65 2e20 5468 6973 206d 6561 6e73  file. This means
-000179d0: 2074 6861 7420 7374 7269 6e67 7320 6c6f   that strings lo
-000179e0: 6e67 6572 2074 6861 6e20 7468 6520 6669  nger than the fi
-000179f0: 656c 640a 2020 2020 2020 2020 7769 6474  eld.        widt
-00017a00: 682c 206f 7220 6e75 6d62 6572 7320 7468  h, or numbers th
-00017a10: 6174 2064 6f6e 2774 2066 6974 2069 6e74  at don't fit int
-00017a20: 6f20 7468 6520 696e 6469 6361 7465 6420  o the indicated 
-00017a30: 6669 656c 6420 666f 726d 6174 2077 696c  field format wil
-00017a40: 6c0a 2020 2020 2020 2020 7375 6666 6572  l.        suffer
-00017a50: 2074 7275 6e63 6174 696f 6e2e 0a20 2020   truncation..   
-00017a60: 202d 2020 2049 6e74 6567 6572 2066 6965   -   Integer fie
-00017a70: 6c64 7320 7769 7468 6f75 7420 616e 2065  lds without an e
-00017a80: 7870 6c69 6369 7420 7769 6474 6820 6172  xplicit width ar
-00017a90: 6520 7472 6561 7465 6420 6173 2077 6964  e treated as wid
-00017aa0: 7468 2039 2c20 616e 640a 2020 2020 2020  th 9, and.      
-00017ab0: 2020 6578 7465 6e64 6564 2074 6f20 3130    extended to 10
-00017ac0: 206f 7220 3131 2069 6620 6e65 6564 6564   or 11 if needed
-00017ad0: 2e0a 2020 2020 2d20 2020 496e 7465 6765  ..    -   Intege
-00017ae0: 7236 3420 6669 656c 6473 2077 6974 686f  r64 fields witho
-00017af0: 7574 2061 6e20 6578 706c 6963 6974 2077  ut an explicit w
-00017b00: 6964 7468 2061 7265 2074 7265 6174 6564  idth are treated
-00017b10: 2061 7320 7769 6474 6820 3138 2c0a 2020   as width 18,.  
-00017b20: 2020 2020 2020 616e 6420 6578 7465 6e64        and extend
-00017b30: 6564 2074 6f20 3139 206f 7220 3230 2069  ed to 19 or 20 i
-00017b40: 6620 6e65 6564 6564 2e0a 2020 2020 2d20  f needed..    - 
-00017b50: 2020 5265 616c 2028 666c 6f61 7469 6e67    Real (floating
-00017b60: 2070 6f69 6e74 2920 6669 656c 6473 2077   point) fields w
-00017b70: 6974 686f 7574 2061 6e20 6578 706c 6963  ithout an explic
-00017b80: 6974 2077 6964 7468 2061 7265 2074 7265  it width are tre
-00017b90: 6174 6564 2061 730a 2020 2020 2020 2020  ated as.        
-00017ba0: 7769 6474 6820 3234 2077 6974 6820 3135  width 24 with 15
-00017bb0: 2064 6563 696d 616c 2070 6c61 6365 7320   decimal places 
-00017bc0: 6f66 2070 7265 6369 7369 6f6e 2e0a 2020  of precision..  
-00017bd0: 2020 2d20 2020 5374 7269 6e67 2066 6965    -   String fie
-00017be0: 6c64 7320 7769 7468 6f75 7420 616e 2061  lds without an a
-00017bf0: 7373 6967 6e65 6420 7769 6474 6820 6172  ssigned width ar
-00017c00: 6520 7472 6561 7465 6420 6173 2038 3020  e treated as 80 
-00017c10: 6368 6172 6163 7465 7273 2e0a 0a20 2020  characters...   
-00017c20: 2041 7267 733a 0a20 2020 2020 2020 2063   Args:.        c
-00017c30: 6f6c 756d 6e73 2028 4974 6572 6162 6c65  olumns (Iterable
-00017c40: 293a 2074 6865 2063 6f6c 756d 6e73 2074  ): the columns t
-00017c50: 6f20 6c61 756e 6465 722e 0a0a 2020 2020  o launder...    
-00017c60: 5265 7475 726e 733a 2061 204c 6973 7420  Returns: a List 
-00017c70: 6f66 2074 7570 706c 6573 2077 6974 6820  of tupples with 
-00017c80: 7468 6520 6f72 6967 696e 616c 2061 6e64  the original and
-00017c90: 206c 6175 6e64 6572 6564 2063 6f6c 756d   laundered colum
-00017ca0: 6e20 6e61 6d65 732e 0a20 2020 2022 2222  n names..    """
-00017cb0: 0a20 2020 206c 6175 6e64 6572 6564 203d  .    laundered =
-00017cc0: 205b 5d0a 2020 2020 6c61 756e 6465 7265   [].    laundere
-00017cd0: 645f 7570 7065 7220 3d20 5b5d 0a20 2020  d_upper = [].   
-00017ce0: 2066 6f72 2063 6f6c 756d 6e20 696e 2063   for column in c
-00017cf0: 6f6c 756d 6e73 3a0a 2020 2020 2020 2020  olumns:.        
-00017d00: 2320 446f 7562 6c65 7320 696e 2063 6173  # Doubles in cas
-00017d10: 696e 6720 6172 6565 206e 6f74 2061 6c6c  ing aree not all
-00017d20: 6f77 6564 2065 6974 6865 720a 2020 2020  owed either.    
-00017d30: 2020 2020 6966 206c 656e 2863 6f6c 756d      if len(colum
-00017d40: 6e29 203c 3d20 3130 3a0a 2020 2020 2020  n) <= 10:.      
-00017d50: 2020 2020 2020 6966 2063 6f6c 756d 6e2e        if column.
-00017d60: 7570 7065 7228 2920 6e6f 7420 696e 206c  upper() not in l
-00017d70: 6175 6e64 6572 6564 5f75 7070 6572 3a0a  aundered_upper:.
-00017d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017d90: 6c61 756e 6465 7265 645f 7570 7065 722e  laundered_upper.
-00017da0: 6170 7065 6e64 2863 6f6c 756d 6e2e 7570  append(column.up
-00017db0: 7065 7228 2929 0a20 2020 2020 2020 2020  per()).         
-00017dc0: 2020 2020 2020 206c 6175 6e64 6572 6564         laundered
-00017dd0: 2e61 7070 656e 6428 2863 6f6c 756d 6e2c  .append((column,
-00017de0: 2063 6f6c 756d 6e29 290a 2020 2020 2020   column)).      
-00017df0: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
-00017e00: 7565 0a0a 2020 2020 2020 2020 2320 4c61  ue..        # La
-00017e10: 756e 6465 7269 6e67 2069 7320 6e65 6564  undering is need
-00017e20: 6564 0a20 2020 2020 2020 2063 6f6c 756d  ed.        colum
-00017e30: 6e5f 6c61 756e 6465 7265 6420 3d20 636f  n_laundered = co
-00017e40: 6c75 6d6e 5b3a 3130 5d0a 2020 2020 2020  lumn[:10].      
-00017e50: 2020 6966 2063 6f6c 756d 6e5f 6c61 756e    if column_laun
-00017e60: 6465 7265 642e 7570 7065 7228 2920 6e6f  dered.upper() no
-00017e70: 7420 696e 206c 6175 6e64 6572 6564 5f75  t in laundered_u
-00017e80: 7070 6572 3a0a 2020 2020 2020 2020 2020  pper:.          
-00017e90: 2020 6c61 756e 6465 7265 645f 7570 7065    laundered_uppe
-00017ea0: 722e 6170 7065 6e64 2863 6f6c 756d 6e5f  r.append(column_
-00017eb0: 6c61 756e 6465 7265 642e 7570 7065 7228  laundered.upper(
-00017ec0: 2929 0a20 2020 2020 2020 2020 2020 206c  )).            l
-00017ed0: 6175 6e64 6572 6564 2e61 7070 656e 6428  aundered.append(
-00017ee0: 2863 6f6c 756d 6e2c 2063 6f6c 756d 6e5f  (column, column_
-00017ef0: 6c61 756e 6465 7265 6429 290a 2020 2020  laundered)).    
-00017f00: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00017f10: 2020 2020 2020 2320 4a75 7374 2074 616b        # Just tak
-00017f20: 696e 6720 6669 7273 7420 3130 2063 6861  ing first 10 cha
-00017f30: 7261 6374 6572 7320 6469 646e 2774 2068  racters didn't h
-00017f40: 656c 700a 2020 2020 2020 2020 2020 2020  elp.            
-00017f50: 666f 7220 696e 6465 7820 696e 2072 616e  for index in ran
-00017f60: 6765 2831 2c20 3130 3129 3a0a 2020 2020  ge(1, 101):.    
-00017f70: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-00017f80: 6e64 6578 203e 3d20 3130 303a 0a20 2020  ndex >= 100:.   
-00017f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017fa0: 2072 6169 7365 204e 6f74 496d 706c 656d   raise NotImplem
-00017fb0: 656e 7465 6445 7272 6f72 280a 2020 2020  entedError(.    
-00017fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017fd0: 2020 2020 224e 6f74 2073 7570 706f 7274      "Not support
-00017fe0: 6564 2074 6f20 6c61 756e 6465 7220 3e20  ed to launder > 
-00017ff0: 3939 2063 6f6c 756d 6e73 2073 7461 7274  99 columns start
-00018000: 696e 6720 220a 2020 2020 2020 2020 2020  ing ".          
-00018010: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-00018020: 7769 7468 207b 636f 6c75 6d6e 5f6c 6175  with {column_lau
-00018030: 6e64 6572 6564 5b3a 385d 7d22 0a20 2020  ndered[:8]}".   
-00018040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018050: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00018060: 2020 2069 6620 696e 6465 7820 3c3d 2039     if index <= 9
-00018070: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00018080: 2020 2020 2020 636f 6c75 6d6e 5f6c 6175        column_lau
-00018090: 6e64 6572 6564 203d 2066 227b 636f 6c75  ndered = f"{colu
-000180a0: 6d6e 5f6c 6175 6e64 6572 6564 5b3a 385d  mn_laundered[:8]
-000180b0: 7d5f 7b69 6e64 6578 7d22 0a20 2020 2020  }_{index}".     
-000180c0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-000180d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000180e0: 2020 2020 2063 6f6c 756d 6e5f 6c61 756e       column_laun
-000180f0: 6465 7265 6420 3d20 6622 7b63 6f6c 756d  dered = f"{colum
-00018100: 6e5f 6c61 756e 6465 7265 645b 3a38 5d7d  n_laundered[:8]}
-00018110: 7b69 6e64 6578 7d22 0a20 2020 2020 2020  {index}".       
-00018120: 2020 2020 2020 2020 2069 6620 636f 6c75           if colu
-00018130: 6d6e 5f6c 6175 6e64 6572 6564 2e75 7070  mn_laundered.upp
-00018140: 6572 2829 206e 6f74 2069 6e20 6c61 756e  er() not in laun
-00018150: 6465 7265 645f 7570 7065 723a 0a20 2020  dered_upper:.   
-00018160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018170: 206c 6175 6e64 6572 6564 5f75 7070 6572   laundered_upper
-00018180: 2e61 7070 656e 6428 636f 6c75 6d6e 5f6c  .append(column_l
-00018190: 6175 6e64 6572 6564 2e75 7070 6572 2829  aundered.upper()
-000181a0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000181b0: 2020 2020 2020 6c61 756e 6465 7265 642e        laundered.
-000181c0: 6170 7065 6e64 2828 636f 6c75 6d6e 2c20  append((column, 
-000181d0: 636f 6c75 6d6e 5f6c 6175 6e64 6572 6564  column_laundered
-000181e0: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-000181f0: 2020 2020 2020 2062 7265 616b 0a0a 2020         break..  
-00018200: 2020 7265 7475 726e 206c 6175 6e64 6572    return launder
-00018210: 6564 0a                                  ed.
+0000d830: 7974 7970 6520 6973 206e 6f74 204e 6f6e  ytype is not Non
+0000d840: 6520 616e 6420 666f 7263 655f 6f75 7470  e and force_outp
+0000d850: 7574 5f67 656f 6d65 7472 7974 7970 652e  ut_geometrytype.
+0000d860: 6973 5f6d 756c 7469 7479 7065 3a0a 2020  is_multitype:.  
+0000d870: 2020 2020 2020 666f 7263 655f 6d75 6c74        force_mult
+0000d880: 6974 7970 6520 3d20 5472 7565 0a0a 2020  itype = True..  
+0000d890: 2020 656e 6769 6e65 203d 2043 6f6e 6669    engine = Confi
+0000d8a0: 674f 7074 696f 6e73 2e69 6f5f 656e 6769  gOptions.io_engi
+0000d8b0: 6e65 0a0a 2020 2020 2320 7079 6f67 7269  ne..    # pyogri
+0000d8c0: 6f20 3c20 302e 3720 646f 6573 6e27 7420  o < 0.7 doesn't 
+0000d8d0: 7375 7070 6f72 7420 7772 6974 696e 6720  support writing 
+0000d8e0: 7769 7468 6f75 7420 6765 6f6d 6574 7279  without geometry
+0000d8f0: 2c20 736f 2069 6e20 7468 6174 2063 6173  , so in that cas
+0000d900: 6520 7573 6520 6669 6f6e 612e 0a20 2020  e use fiona..   
+0000d910: 2069 6620 6e6f 7420 5059 4f47 5249 4f5f   if not PYOGRIO_
+0000d920: 4754 455f 3037 3a0a 2020 2020 2020 2020  GTE_07:.        
+0000d930: 6966 2069 7369 6e73 7461 6e63 6528 6764  if isinstance(gd
+0000d940: 662c 2067 7064 2e47 656f 4461 7461 4672  f, gpd.GeoDataFr
+0000d950: 616d 6529 2069 7320 4661 6c73 6520 6f72  ame) is False or
+0000d960: 2028 0a20 2020 2020 2020 2020 2020 2069   (.            i
+0000d970: 7369 6e73 7461 6e63 6528 6764 662c 2067  sinstance(gdf, g
+0000d980: 7064 2e47 656f 4461 7461 4672 616d 6529  pd.GeoDataFrame)
+0000d990: 2061 6e64 2022 6765 6f6d 6574 7279 2220   and "geometry" 
+0000d9a0: 6e6f 7420 696e 2067 6466 2e63 6f6c 756d  not in gdf.colum
+0000d9b0: 6e73 0a20 2020 2020 2020 2029 3a0a 2020  ns.        ):.  
+0000d9c0: 2020 2020 2020 2020 2020 2320 4769 7665            # Give
+0000d9d0: 2061 2063 6c65 6172 2065 7272 6f72 2069   a clear error i
+0000d9e0: 6620 6669 6f6e 6120 6973 6e27 7420 696e  f fiona isn't in
+0000d9f0: 7374 616c 6c65 642e 0a20 2020 2020 2020  stalled..       
+0000da00: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+0000da10: 2020 2020 2020 2020 2020 696d 706f 7274            import
+0000da20: 2066 696f 6e61 2020 2320 6e6f 7161 3a20   fiona  # noqa: 
+0000da30: 4634 3031 0a20 2020 2020 2020 2020 2020  F401.           
+0000da40: 2065 7863 6570 7420 496d 706f 7274 4572   except ImportEr
+0000da50: 726f 7220 6173 2065 783a 2020 2320 7072  ror as ex:  # pr
+0000da60: 6167 6d61 3a20 6e6f 2063 6f76 6572 0a20  agma: no cover. 
+0000da70: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0000da80: 6169 7365 2052 756e 7469 6d65 4572 726f  aise RuntimeErro
+0000da90: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+0000daa0: 2020 2020 2020 2022 746f 2077 7269 7465         "to write
+0000dab0: 2064 6174 6166 7261 6d65 7320 7769 7468   dataframes with
+0000dac0: 6f75 7420 6765 6f6d 6574 7279 2065 6974  out geometry eit
+0000dad0: 6865 7220 7079 6f67 7269 6f20 3e3d 2030  her pyogrio >= 0
+0000dae0: 2e37 2022 0a20 2020 2020 2020 2020 2020  .7 ".           
+0000daf0: 2020 2020 2020 2020 2022 2872 6563 6f6d           "(recom
+0000db00: 6d65 6e64 6564 2920 6f72 2066 696f 6e61  mended) or fiona
+0000db10: 206e 6565 6473 2074 6f20 6265 2069 6e73   needs to be ins
+0000db20: 7461 6c6c 6564 2e22 0a20 2020 2020 2020  talled.".       
+0000db30: 2020 2020 2020 2020 2029 2066 726f 6d20           ) from 
+0000db40: 6578 0a0a 2020 2020 2020 2020 2020 2020  ex..            
+0000db50: 656e 6769 6e65 203d 2022 6669 6f6e 6122  engine = "fiona"
+0000db60: 0a0a 2020 2020 2320 5772 6974 6520 6669  ..    # Write fi
+0000db70: 6c65 2077 6974 6820 7468 6520 636f 7272  le with the corr
+0000db80: 6563 7420 656e 6769 6e65 0a20 2020 2069  ect engine.    i
+0000db90: 6620 656e 6769 6e65 203d 3d20 2270 796f  f engine == "pyo
+0000dba0: 6772 696f 223a 0a20 2020 2020 2020 2072  grio":.        r
+0000dbb0: 6574 7572 6e20 5f74 6f5f 6669 6c65 5f70  eturn _to_file_p
+0000dbc0: 796f 6772 696f 280a 2020 2020 2020 2020  yogrio(.        
+0000dbd0: 2020 2020 6764 663d 6764 662c 0a20 2020      gdf=gdf,.   
+0000dbe0: 2020 2020 2020 2020 2070 6174 683d 7061           path=pa
+0000dbf0: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
+0000dc00: 6c61 7965 723d 6c61 7965 722c 0a20 2020  layer=layer,.   
+0000dc10: 2020 2020 2020 2020 2066 6f72 6365 5f6f           force_o
+0000dc20: 7574 7075 745f 6765 6f6d 6574 7279 7479  utput_geometryty
+0000dc30: 7065 3d66 6f72 6365 5f6f 7574 7075 745f  pe=force_output_
+0000dc40: 6765 6f6d 6574 7279 7479 7065 2c0a 2020  geometrytype,.  
+0000dc50: 2020 2020 2020 2020 2020 666f 7263 655f            force_
+0000dc60: 6d75 6c74 6974 7970 653d 666f 7263 655f  multitype=force_
+0000dc70: 6d75 6c74 6974 7970 652c 0a20 2020 2020  multitype,.     
+0000dc80: 2020 2020 2020 2061 7070 656e 643d 6170         append=ap
+0000dc90: 7065 6e64 2c0a 2020 2020 2020 2020 2020  pend,.          
+0000dca0: 2020 6170 7065 6e64 5f74 696d 656f 7574    append_timeout
+0000dcb0: 5f73 3d61 7070 656e 645f 7469 6d65 6f75  _s=append_timeou
+0000dcc0: 745f 732c 0a20 2020 2020 2020 2020 2020  t_s,.           
+0000dcd0: 2069 6e64 6578 3d69 6e64 6578 2c0a 2020   index=index,.  
+0000dce0: 2020 2020 2020 2020 2020 6372 6561 7465            create
+0000dcf0: 5f73 7061 7469 616c 5f69 6e64 6578 3d63  _spatial_index=c
+0000dd00: 7265 6174 655f 7370 6174 6961 6c5f 696e  reate_spatial_in
+0000dd10: 6465 782c 0a20 2020 2020 2020 2020 2020  dex,.           
+0000dd20: 202a 2a6b 7761 7267 732c 0a20 2020 2020   **kwargs,.     
+0000dd30: 2020 2029 0a20 2020 2065 6c69 6620 656e     ).    elif en
+0000dd40: 6769 6e65 203d 3d20 2266 696f 6e61 223a  gine == "fiona":
+0000dd50: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000dd60: 5f74 6f5f 6669 6c65 5f66 696f 6e61 280a  _to_file_fiona(.
+0000dd70: 2020 2020 2020 2020 2020 2020 6764 663d              gdf=
+0000dd80: 6764 662c 0a20 2020 2020 2020 2020 2020  gdf,.           
+0000dd90: 2070 6174 683d 7061 7468 2c0a 2020 2020   path=path,.    
+0000dda0: 2020 2020 2020 2020 6c61 7965 723d 6c61          layer=la
+0000ddb0: 7965 722c 0a20 2020 2020 2020 2020 2020  yer,.           
+0000ddc0: 2066 6f72 6365 5f6f 7574 7075 745f 6765   force_output_ge
+0000ddd0: 6f6d 6574 7279 7479 7065 3d66 6f72 6365  ometrytype=force
+0000dde0: 5f6f 7574 7075 745f 6765 6f6d 6574 7279  _output_geometry
+0000ddf0: 7479 7065 2c0a 2020 2020 2020 2020 2020  type,.          
+0000de00: 2020 666f 7263 655f 6d75 6c74 6974 7970    force_multityp
+0000de10: 653d 666f 7263 655f 6d75 6c74 6974 7970  e=force_multityp
+0000de20: 652c 0a20 2020 2020 2020 2020 2020 2061  e,.            a
+0000de30: 7070 656e 643d 6170 7065 6e64 2c0a 2020  ppend=append,.  
+0000de40: 2020 2020 2020 2020 2020 6170 7065 6e64            append
+0000de50: 5f74 696d 656f 7574 5f73 3d61 7070 656e  _timeout_s=appen
+0000de60: 645f 7469 6d65 6f75 745f 732c 0a20 2020  d_timeout_s,.   
+0000de70: 2020 2020 2020 2020 2069 6e64 6578 3d69           index=i
+0000de80: 6e64 6578 2c0a 2020 2020 2020 2020 2020  ndex,.          
+0000de90: 2020 6372 6561 7465 5f73 7061 7469 616c    create_spatial
+0000dea0: 5f69 6e64 6578 3d63 7265 6174 655f 7370  _index=create_sp
+0000deb0: 6174 6961 6c5f 696e 6465 782c 0a20 2020  atial_index,.   
+0000dec0: 2020 2020 2020 2020 202a 2a6b 7761 7267           **kwarg
+0000ded0: 732c 0a20 2020 2020 2020 2029 0a20 2020  s,.        ).   
+0000dee0: 2065 6c73 653a 0a20 2020 2020 2020 2072   else:.        r
+0000def0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+0000df00: 6622 556e 7375 7070 6f72 7465 6420 656e  f"Unsupported en
+0000df10: 6769 6e65 3a20 7b65 6e67 696e 657d 2229  gine: {engine}")
+0000df20: 0a0a 0a64 6566 205f 746f 5f66 696c 655f  ...def _to_file_
+0000df30: 6669 6f6e 6128 0a20 2020 2067 6466 3a20  fiona(.    gdf: 
+0000df40: 556e 696f 6e5b 7064 2e44 6174 6146 7261  Union[pd.DataFra
+0000df50: 6d65 2c20 6770 642e 4765 6f44 6174 6146  me, gpd.GeoDataF
+0000df60: 7261 6d65 5d2c 0a20 2020 2070 6174 683a  rame],.    path:
+0000df70: 2050 6174 682c 0a20 2020 206c 6179 6572   Path,.    layer
+0000df80: 3a20 7374 722c 0a20 2020 2066 6f72 6365  : str,.    force
+0000df90: 5f6f 7574 7075 745f 6765 6f6d 6574 7279  _output_geometry
+0000dfa0: 7479 7065 3a20 556e 696f 6e5b 4765 6f6d  type: Union[Geom
+0000dfb0: 6574 7279 5479 7065 2c20 7374 722c 204e  etryType, str, N
+0000dfc0: 6f6e 655d 203d 204e 6f6e 652c 0a20 2020  one] = None,.   
+0000dfd0: 2066 6f72 6365 5f6d 756c 7469 7479 7065   force_multitype
+0000dfe0: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
+0000dff0: 2020 2020 6170 7065 6e64 3a20 626f 6f6c      append: bool
+0000e000: 203d 2046 616c 7365 2c0a 2020 2020 6170   = False,.    ap
+0000e010: 7065 6e64 5f74 696d 656f 7574 5f73 3a20  pend_timeout_s: 
+0000e020: 696e 7420 3d20 3630 302c 0a20 2020 2069  int = 600,.    i
+0000e030: 6e64 6578 3a20 4f70 7469 6f6e 616c 5b62  ndex: Optional[b
+0000e040: 6f6f 6c5d 203d 204e 6f6e 652c 0a20 2020  ool] = None,.   
+0000e050: 2063 7265 6174 655f 7370 6174 6961 6c5f   create_spatial_
+0000e060: 696e 6465 783a 204f 7074 696f 6e61 6c5b  index: Optional[
+0000e070: 626f 6f6c 5d20 3d20 4e6f 6e65 2c0a 2020  bool] = None,.  
+0000e080: 2020 2a2a 6b77 6172 6773 2c0a 293a 0a20    **kwargs,.):. 
+0000e090: 2020 2022 2222 0a20 2020 2057 7269 7465     """.    Write
+0000e0a0: 7320 6120 7061 6e64 6173 2064 6174 6166  s a pandas dataf
+0000e0b0: 7261 6d65 2074 6f20 6669 6c65 2075 7369  rame to file usi
+0000e0c0: 6e67 2066 696f 6e61 2e0a 2020 2020 2222  ng fiona..    ""
+0000e0d0: 220a 2020 2020 2320 5368 6170 6566 696c  ".    # Shapefil
+0000e0e0: 6520 646f 6573 6e27 7420 7375 7070 6f72  e doesn't suppor
+0000e0f0: 7420 6461 7465 7469 6d65 2063 6f6c 756d  t datetime colum
+0000e100: 6e73 2c20 736f 2066 6972 7374 2063 6173  ns, so first cas
+0000e110: 7420 7468 656d 2074 6f20 7374 7269 6e67  t them to string
+0000e120: 0a20 2020 2069 6620 7061 7468 2e73 7566  .    if path.suf
+0000e130: 6669 782e 6c6f 7765 7228 2920 696e 205b  fix.lower() in [
+0000e140: 222e 7368 7022 2c20 222e 6462 6622 5d3a  ".shp", ".dbf"]:
+0000e150: 0a20 2020 2020 2020 2067 6466 203d 2067  .        gdf = g
+0000e160: 6466 2e63 6f70 7928 290a 2020 2020 2020  df.copy().      
+0000e170: 2020 2320 436f 6c75 6d6e 7320 7468 6174    # Columns that
+0000e180: 2068 6176 6520 6120 7072 6f70 6572 2064   have a proper d
+0000e190: 6174 6574 696d 6536 3420 7479 7065 0a20  atetime64 type. 
+0000e1a0: 2020 2020 2020 2066 6f72 2063 6f6c 756d         for colum
+0000e1b0: 6e20 696e 2067 6466 2e73 656c 6563 745f  n in gdf.select_
+0000e1c0: 6474 7970 6573 2869 6e63 6c75 6465 3d5b  dtypes(include=[
+0000e1d0: 2264 6174 6574 696d 6536 3422 5d29 3a0a  "datetime64"]):.
+0000e1e0: 2020 2020 2020 2020 2020 2020 6764 665b              gdf[
+0000e1f0: 636f 6c75 6d6e 5d20 3d20 6764 665b 636f  column] = gdf[co
+0000e200: 6c75 6d6e 5d2e 6173 7479 7065 2873 7472  lumn].astype(str
+0000e210: 290a 0a20 2020 2020 2020 2023 2043 6f6c  )..        # Col
+0000e220: 756d 6e73 2074 6861 7420 6172 6520 6f66  umns that are of
+0000e230: 206f 626a 6563 7420 7479 7065 2c20 6275   object type, bu
+0000e240: 7420 636f 6e74 6169 6e20 6461 7465 7469  t contain dateti
+0000e250: 6d65 2e64 6174 6520 6f72 2064 6174 6574  me.date or datet
+0000e260: 696d 652e 6461 7465 0a20 2020 2020 2020  ime.date.       
+0000e270: 2023 2074 7970 6520 6461 7461 2069 6e73   # type data ins
+0000e280: 7465 6164 206f 6620 7374 7269 6e67 732e  tead of strings.
+0000e290: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
+0000e2a0: 6764 6629 203e 2030 3a0a 2020 2020 2020  gdf) > 0:.      
+0000e2b0: 2020 2020 2020 666f 7220 636f 6c75 6d6e        for column
+0000e2c0: 2069 6e20 6764 662e 7365 6c65 6374 5f64   in gdf.select_d
+0000e2d0: 7479 7065 7328 696e 636c 7564 653d 5b22  types(include=["
+0000e2e0: 6f62 6a65 6374 225d 293a 0a20 2020 2020  object"]):.     
+0000e2f0: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+0000e300: 696e 7374 616e 6365 2867 6466 5b63 6f6c  instance(gdf[col
+0000e310: 756d 6e5d 5b30 5d2c 2028 6461 7465 2c20  umn][0], (date, 
+0000e320: 6461 7465 7469 6d65 2929 3a0a 2020 2020  datetime)):.    
+0000e330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e340: 6764 665b 636f 6c75 6d6e 5d20 3d20 6764  gdf[column] = gd
+0000e350: 665b 636f 6c75 6d6e 5d2e 6173 7479 7065  f[column].astype
+0000e360: 2873 7472 290a 0a20 2020 2023 2048 616e  (str)..    # Han
+0000e370: 646c 6520 736f 6d65 2073 7065 6369 6669  dle some specifi
+0000e380: 6320 6361 7365 7320 7768 6572 6520 7468  c cases where th
+0000e390: 6520 6669 6c65 2073 6368 656d 6120 6e65  e file schema ne
+0000e3a0: 6564 7320 746f 2062 6520 6d61 6e69 7075  eds to be manipu
+0000e3b0: 6c61 7465 642e 0a20 2020 2073 6368 656d  lated..    schem
+0000e3c0: 6120 3d20 4e6f 6e65 0a20 2020 2069 6620  a = None.    if 
+0000e3d0: 6973 696e 7374 616e 6365 2867 6466 2c20  isinstance(gdf, 
+0000e3e0: 6770 642e 4765 6f44 6174 6146 7261 6d65  gpd.GeoDataFrame
+0000e3f0: 2920 6973 2046 616c 7365 206f 7220 280a  ) is False or (.
+0000e400: 2020 2020 2020 2020 6973 696e 7374 616e          isinstan
+0000e410: 6365 2867 6466 2c20 6770 642e 4765 6f44  ce(gdf, gpd.GeoD
+0000e420: 6174 6146 7261 6d65 2920 616e 6420 2267  ataFrame) and "g
+0000e430: 656f 6d65 7472 7922 206e 6f74 2069 6e20  eometry" not in 
+0000e440: 6764 662e 636f 6c75 6d6e 730a 2020 2020  gdf.columns.    
+0000e450: 293a 0a20 2020 2020 2020 2023 204e 6f20  ):.        # No 
+0000e460: 6765 6f6d 6574 7279 2c20 736f 2070 7265  geometry, so pre
+0000e470: 7061 7265 2074 6f20 6265 2077 7269 7474  pare to be writt
+0000e480: 656e 2061 7320 6174 7472 6962 7574 6520  en as attribute 
+0000e490: 7461 626c 653a 2061 6464 2067 656f 6d65  table: add geome
+0000e4a0: 7472 7920 636f 6c75 6d6e 0a20 2020 2020  try column.     
+0000e4b0: 2020 2023 2077 6974 6820 4e6f 6e65 2067     # with None g
+0000e4c0: 656f 6d65 7472 7920 7479 7065 2069 6e20  eometry type in 
+0000e4d0: 7363 6865 6d61 0a20 2020 2020 2020 2023  schema.        #
+0000e4e0: 2057 6974 6820 6f6c 6465 7220 7665 7273   With older vers
+0000e4f0: 696f 6e73 206f 6620 7061 6e64 6173 2061  ions of pandas a
+0000e500: 6e64 2f6f 7220 6765 6f70 616e 6461 732c  nd/or geopandas,
+0000e510: 2077 6974 686f 7574 2074 6865 2063 6f70   without the cop
+0000e520: 7920 7468 6520 6163 7475 616c 0a20 2020  y the actual.   
+0000e530: 2020 2020 2023 2067 6466 2069 7320 6368       # gdf is ch
+0000e540: 616e 6765 6420 616e 6420 7265 7475 726e  anged and return
+0000e550: 6564 2077 6869 6368 2069 736e 2774 204f  ed which isn't O
+0000e560: 4b2e 0a20 2020 2020 2020 2023 2054 6869  K..        # Thi
+0000e570: 7320 6361 7573 6564 2074 6573 745f 746f  s caused test_to
+0000e580: 5f66 696c 6520 7769 7468 202e 6373 7620  _file with .csv 
+0000e590: 746f 2066 6169 6c20 666f 7220 7468 6520  to fail for the 
+0000e5a0: 226d 696e 696d 616c 2220 4349 2065 6e76  "minimal" CI env
+0000e5b0: 2e0a 2020 2020 2020 2020 6764 6620 3d20  ..        gdf = 
+0000e5c0: 6770 642e 4765 6f44 6174 6146 7261 6d65  gpd.GeoDataFrame
+0000e5d0: 2867 6466 2e63 6f70 7928 292c 2067 656f  (gdf.copy(), geo
+0000e5e0: 6d65 7472 793d 5b4e 6f6e 6520 666f 7220  metry=[None for 
+0000e5f0: 6920 696e 2067 6466 2e69 6e64 6578 5d29  i in gdf.index])
+0000e600: 0a0a 2020 2020 2020 2020 7363 6865 6d61  ..        schema
+0000e610: 203d 2067 7064 5f69 6f5f 6669 6c65 2e69   = gpd_io_file.i
+0000e620: 6e66 6572 5f73 6368 656d 6128 6764 6629  nfer_schema(gdf)
+0000e630: 0a20 2020 2020 2020 2073 6368 656d 615b  .        schema[
+0000e640: 2267 656f 6d65 7472 7922 5d20 3d20 224e  "geometry"] = "N
+0000e650: 6f6e 6522 0a20 2020 2020 2020 2063 7265  one".        cre
+0000e660: 6174 655f 7370 6174 6961 6c5f 696e 6465  ate_spatial_inde
+0000e670: 7820 3d20 4e6f 6e65 0a20 2020 2065 6c69  x = None.    eli
+0000e680: 6620 280a 2020 2020 2020 2020 6c65 6e28  f (.        len(
+0000e690: 6764 6629 203d 3d20 300a 2020 2020 2020  gdf) == 0.      
+0000e6a0: 2020 616e 6420 666f 7263 655f 6f75 7470    and force_outp
+0000e6b0: 7574 5f67 656f 6d65 7472 7974 7970 6520  ut_geometrytype 
+0000e6c0: 6973 206e 6f74 204e 6f6e 650a 2020 2020  is not None.    
+0000e6d0: 2020 2020 616e 6420 6973 696e 7374 616e      and isinstan
+0000e6e0: 6365 2866 6f72 6365 5f6f 7574 7075 745f  ce(force_output_
+0000e6f0: 6765 6f6d 6574 7279 7479 7065 2c20 4765  geometrytype, Ge
+0000e700: 6f6d 6574 7279 5479 7065 290a 2020 2020  ometryType).    
+0000e710: 293a 0a20 2020 2020 2020 2023 2049 6620  ):.        # If 
+0000e720: 7468 6520 6764 6620 6973 2065 6d70 7479  the gdf is empty
+0000e730: 2062 7574 2061 2067 656f 6d65 7472 7920   but a geometry 
+0000e740: 7479 7065 2069 7320 7370 6563 6966 6965  type is specifie
+0000e750: 642c 2075 7365 2074 6865 2073 7065 6369  d, use the speci
+0000e760: 6669 6564 2074 7970 650a 2020 2020 2020  fied type.      
+0000e770: 2020 7363 6865 6d61 203d 2067 7064 5f69    schema = gpd_i
+0000e780: 6f5f 6669 6c65 2e69 6e66 6572 5f73 6368  o_file.infer_sch
+0000e790: 656d 6128 6764 6629 0a20 2020 2020 2020  ema(gdf).       
+0000e7a0: 2023 2047 656f 6d65 7472 7920 7479 7065   # Geometry type
+0000e7b0: 206d 7573 7420 6265 2069 6e20 6361 6d65   must be in came
+0000e7c0: 6c63 6173 6520 666f 7220 6669 6f6e 610a  lcase for fiona.
+0000e7d0: 2020 2020 2020 2020 7363 6865 6d61 5b22          schema["
+0000e7e0: 6765 6f6d 6574 7279 225d 203d 2066 6f72  geometry"] = for
+0000e7f0: 6365 5f6f 7574 7075 745f 6765 6f6d 6574  ce_output_geomet
+0000e800: 7279 7479 7065 2e6e 616d 655f 6361 6d65  rytype.name_came
+0000e810: 6c63 6173 650a 2020 2020 6173 7365 7274  lcase.    assert
+0000e820: 2069 7369 6e73 7461 6e63 6528 6764 662c   isinstance(gdf,
+0000e830: 2067 7064 2e47 656f 4461 7461 4672 616d   gpd.GeoDataFram
+0000e840: 6529 0a0a 2020 2020 2320 436f 6e76 6572  e)..    # Conver
+0000e850: 7420 666f 7263 655f 6f75 7470 7574 5f67  t force_output_g
+0000e860: 656f 6d65 7472 7974 7970 6520 746f 2073  eometrytype to s
+0000e870: 7472 696e 6720 746f 2073 696d 706c 6966  tring to simplif
+0000e880: 7920 636f 6465 2061 6674 6572 7761 7264  y code afterward
+0000e890: 730a 2020 2020 6966 2069 7369 6e73 7461  s.    if isinsta
+0000e8a0: 6e63 6528 666f 7263 655f 6f75 7470 7574  nce(force_output
+0000e8b0: 5f67 656f 6d65 7472 7974 7970 652c 2047  _geometrytype, G
+0000e8c0: 656f 6d65 7472 7954 7970 6529 3a0a 2020  eometryType):.  
+0000e8d0: 2020 2020 2020 666f 7263 655f 6f75 7470        force_outp
+0000e8e0: 7574 5f67 656f 6d65 7472 7974 7970 6520  ut_geometrytype 
+0000e8f0: 3d20 666f 7263 655f 6f75 7470 7574 5f67  = force_output_g
+0000e900: 656f 6d65 7472 7974 7970 652e 6e61 6d65  eometrytype.name
+0000e910: 0a0a 2020 2020 2320 4e6f 2074 6865 2066  ..    # No the f
+0000e920: 696c 6520 6361 6e20 6163 7475 616c 6c79  ile can actually
+0000e930: 2062 6520 7772 6974 7465 6e0a 2020 2020   be written.    
+0000e940: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  # --------------
+0000e950: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0000e960: 2d2d 2d2d 2d0a 2020 2020 2320 4669 6f6e  -----.    # Fion
+0000e970: 6120 646f 6573 6e27 7420 7375 7070 6f72  a doesn't suppor
+0000e980: 7420 7468 6520 6f75 7470 7574 2067 656f  t the output geo
+0000e990: 6d65 7472 7974 7970 6520 7061 7261 6d65  metrytype parame
+0000e9a0: 7465 7220 6173 2075 7365 6420 696e 2067  ter as used in g
+0000e9b0: 6461 6c2c 2073 6f20 6173 2061 0a20 2020  dal, so as a.   
+0000e9c0: 2023 206c 6967 6874 7765 6967 6874 2069   # lightweight i
+0000e9d0: 6d70 6c65 6d65 6e74 6174 696f 6e20 6a75  mplementation ju
+0000e9e0: 7374 2073 6574 2066 6f72 6365 0a20 2020  st set force.   
+0000e9f0: 2064 6566 2077 7269 7465 5f74 6f5f 6669   def write_to_fi
+0000ea00: 6c65 280a 2020 2020 2020 2020 6764 663a  le(.        gdf:
+0000ea10: 2067 7064 2e47 656f 4461 7461 4672 616d   gpd.GeoDataFram
+0000ea20: 652c 0a20 2020 2020 2020 2070 6174 683a  e,.        path:
+0000ea30: 2050 6174 682c 0a20 2020 2020 2020 206c   Path,.        l
+0000ea40: 6179 6572 3a20 7374 722c 0a20 2020 2020  ayer: str,.     
+0000ea50: 2020 2069 6e64 6578 3a20 4f70 7469 6f6e     index: Option
+0000ea60: 616c 5b62 6f6f 6c5d 203d 204e 6f6e 652c  al[bool] = None,
+0000ea70: 0a20 2020 2020 2020 2066 6f72 6365 5f6f  .        force_o
+0000ea80: 7574 7075 745f 6765 6f6d 6574 7279 7479  utput_geometryty
+0000ea90: 7065 3a20 4f70 7469 6f6e 616c 5b73 7472  pe: Optional[str
+0000eaa0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+0000eab0: 2020 666f 7263 655f 6d75 6c74 6974 7970    force_multityp
+0000eac0: 653a 2062 6f6f 6c20 3d20 4661 6c73 652c  e: bool = False,
+0000ead0: 0a20 2020 2020 2020 2061 7070 656e 643a  .        append:
+0000eae0: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
+0000eaf0: 2020 2020 2020 2073 6368 656d 613a 204f         schema: O
+0000eb00: 7074 696f 6e61 6c5b 6469 6374 5d20 3d20  ptional[dict] = 
+0000eb10: 4e6f 6e65 2c0a 2020 2020 2020 2020 6372  None,.        cr
+0000eb20: 6561 7465 5f73 7061 7469 616c 5f69 6e64  eate_spatial_ind
+0000eb30: 6578 3a20 4f70 7469 6f6e 616c 5b62 6f6f  ex: Optional[boo
+0000eb40: 6c5d 203d 204e 6f6e 652c 0a20 2020 2020  l] = None,.     
+0000eb50: 2020 202a 2a6b 7761 7267 732c 0a20 2020     **kwargs,.   
+0000eb60: 2029 3a0a 2020 2020 2020 2020 2320 5072   ):.        # Pr
+0000eb70: 6570 6172 6520 6172 6773 2066 6f72 2074  epare args for t
+0000eb80: 6f5f 6669 6c65 0a20 2020 2020 2020 2069  o_file.        i
+0000eb90: 6620 6170 7065 6e64 2069 7320 5472 7565  f append is True
+0000eba0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+0000ebb0: 2070 6174 682e 6578 6973 7473 2829 3a0a   path.exists():.
+0000ebc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ebd0: 6d6f 6465 203d 2022 6122 0a20 2020 2020  mode = "a".     
+0000ebe0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0000ebf0: 2020 2020 2020 2020 2020 2020 206d 6f64               mod
+0000ec00: 6520 3d20 2277 220a 2020 2020 2020 2020  e = "w".        
+0000ec10: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0000ec20: 2020 6d6f 6465 203d 2022 7722 0a0a 2020    mode = "w"..  
+0000ec30: 2020 2020 2020 6b77 6172 6773 5b22 656e        kwargs["en
+0000ec40: 6769 6e65 225d 203d 2022 6669 6f6e 6122  gine"] = "fiona"
+0000ec50: 0a20 2020 2020 2020 206b 7761 7267 735b  .        kwargs[
+0000ec60: 226d 6f64 6522 5d20 3d20 6d6f 6465 0a20  "mode"] = mode. 
+0000ec70: 2020 2020 2020 2064 7269 7665 726e 616d         drivernam
+0000ec80: 6520 3d20 5f67 656f 6669 6c65 696e 666f  e = _geofileinfo
+0000ec90: 2e67 6574 5f64 7269 7665 7228 7061 7468  .get_driver(path
+0000eca0: 290a 2020 2020 2020 2020 6b77 6172 6773  ).        kwargs
+0000ecb0: 5b22 6472 6976 6572 225d 203d 2064 7269  ["driver"] = dri
+0000ecc0: 7665 726e 616d 650a 2020 2020 2020 2020  vername.        
+0000ecd0: 6b77 6172 6773 5b22 696e 6465 7822 5d20  kwargs["index"] 
+0000ece0: 3d20 696e 6465 780a 2020 2020 2020 2020  = index.        
+0000ecf0: 6966 2063 7265 6174 655f 7370 6174 6961  if create_spatia
+0000ed00: 6c5f 696e 6465 7820 6973 206e 6f74 204e  l_index is not N
+0000ed10: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0000ed20: 206b 7761 7267 735b 2253 5041 5449 414c   kwargs["SPATIAL
+0000ed30: 5f49 4e44 4558 225d 203d 2063 7265 6174  _INDEX"] = creat
+0000ed40: 655f 7370 6174 6961 6c5f 696e 6465 780a  e_spatial_index.
+0000ed50: 2020 2020 2020 2020 6966 2066 6f72 6365          if force
+0000ed60: 5f6f 7574 7075 745f 6765 6f6d 6574 7279  _output_geometry
+0000ed70: 7479 7065 2069 7320 6e6f 7420 4e6f 6e65  type is not None
+0000ed80: 3a0a 2020 2020 2020 2020 2020 2020 6b77  :.            kw
+0000ed90: 6172 6773 5b22 6765 6f6d 6574 7279 7479  args["geometryty
+0000eda0: 7065 225d 203d 2066 6f72 6365 5f6f 7574  pe"] = force_out
+0000edb0: 7075 745f 6765 6f6d 6574 7279 7479 7065  put_geometrytype
+0000edc0: 0a20 2020 2020 2020 2069 6620 7363 6865  .        if sche
+0000edd0: 6d61 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ma is not None:.
+0000ede0: 2020 2020 2020 2020 2020 2020 6b77 6172              kwar
+0000edf0: 6773 5b22 7363 6865 6d61 225d 203d 2073  gs["schema"] = s
+0000ee00: 6368 656d 610a 0a20 2020 2020 2020 2023  chema..        #
+0000ee10: 204e 6f77 2077 6520 6361 6e20 7772 6974   Now we can writ
+0000ee20: 650a 2020 2020 2020 2020 6966 2064 7269  e.        if dri
+0000ee30: 7665 726e 616d 6520 3d3d 2022 4750 4b47  vername == "GPKG
+0000ee40: 223a 0a20 2020 2020 2020 2020 2020 2023  ":.            #
+0000ee50: 2054 7279 2074 6f20 6861 726d 6f6e 697a   Try to harmoniz
+0000ee60: 6520 7468 6520 6765 6f6d 6574 7279 7479  e the geometryty
+0000ee70: 7065 2074 6f20 6f6e 6520 286d 756c 7469  pe to one (multi
+0000ee80: 2974 7970 652c 2061 7320 4750 4b47 0a20  )type, as GPKG. 
+0000ee90: 2020 2020 2020 2020 2020 2023 2064 6f65             # doe
+0000eea0: 736e 2774 206c 696b 6520 3e20 3120 7479  sn't like > 1 ty
+0000eeb0: 7065 2069 6e20 6120 6c61 7965 720a 2020  pe in a layer.  
+0000eec0: 2020 2020 2020 2020 2020 6966 2073 6368            if sch
+0000eed0: 656d 6120 6973 204e 6f6e 6520 6f72 2028  ema is None or (
+0000eee0: 6c65 6e28 6764 6629 203e 2030 2061 6e64  len(gdf) > 0 and
+0000eef0: 2073 6368 656d 615b 2267 656f 6d65 7472   schema["geometr
+0000ef00: 7922 5d20 213d 2022 4e6f 6e65 2229 3a0a  y"] != "None"):.
+0000ef10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ef20: 6764 6620 3d20 6764 662e 636f 7079 2829  gdf = gdf.copy()
+0000ef30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ef40: 2067 6466 2e67 656f 6d65 7472 7920 3d20   gdf.geometry = 
+0000ef50: 5f67 656f 7365 7269 6573 5f75 7469 6c2e  _geoseries_util.
+0000ef60: 6861 726d 6f6e 697a 655f 6765 6f6d 6574  harmonize_geomet
+0000ef70: 7279 7479 7065 7328 0a20 2020 2020 2020  rytypes(.       
+0000ef80: 2020 2020 2020 2020 2020 2020 2067 6466               gdf
+0000ef90: 2e67 656f 6d65 7472 792c 2066 6f72 6365  .geometry, force
+0000efa0: 5f6d 756c 7469 7479 7065 3d66 6f72 6365  _multitype=force
+0000efb0: 5f6d 756c 7469 7479 7065 0a20 2020 2020  _multitype.     
+0000efc0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0000efd0: 2020 2020 2020 2020 2067 6466 2e74 6f5f           gdf.to_
+0000efe0: 6669 6c65 2873 7472 2870 6174 6829 2c20  file(str(path), 
+0000eff0: 6c61 7965 723d 6c61 7965 722c 202a 2a6b  layer=layer, **k
+0000f000: 7761 7267 7329 0a20 2020 2020 2020 2065  wargs).        e
+0000f010: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0000f020: 2067 6466 2e74 6f5f 6669 6c65 2873 7472   gdf.to_file(str
+0000f030: 2870 6174 6829 2c20 6c61 7965 723d 6c61  (path), layer=la
+0000f040: 7965 722c 202a 2a6b 7761 7267 7329 0a0a  yer, **kwargs)..
+0000f050: 2020 2020 2320 4966 206e 6f20 6170 7065      # If no appe
+0000f060: 6e64 2c20 6a75 7374 2077 7269 7465 2074  nd, just write t
+0000f070: 6f20 6f75 7470 7574 2070 6174 680a 2020  o output path.  
+0000f080: 2020 6966 206e 6f74 2061 7070 656e 643a    if not append:
+0000f090: 0a20 2020 2020 2020 2077 7269 7465 5f74  .        write_t
+0000f0a0: 6f5f 6669 6c65 280a 2020 2020 2020 2020  o_file(.        
+0000f0b0: 2020 2020 6764 663d 6764 662c 0a20 2020      gdf=gdf,.   
+0000f0c0: 2020 2020 2020 2020 2070 6174 683d 7061           path=pa
+0000f0d0: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
+0000f0e0: 6c61 7965 723d 6c61 7965 722c 0a20 2020  layer=layer,.   
+0000f0f0: 2020 2020 2020 2020 2069 6e64 6578 3d69           index=i
+0000f100: 6e64 6578 2c0a 2020 2020 2020 2020 2020  ndex,.          
+0000f110: 2020 666f 7263 655f 6f75 7470 7574 5f67    force_output_g
+0000f120: 656f 6d65 7472 7974 7970 653d 666f 7263  eometrytype=forc
+0000f130: 655f 6f75 7470 7574 5f67 656f 6d65 7472  e_output_geometr
+0000f140: 7974 7970 652c 0a20 2020 2020 2020 2020  ytype,.         
+0000f150: 2020 2066 6f72 6365 5f6d 756c 7469 7479     force_multity
+0000f160: 7065 3d66 6f72 6365 5f6d 756c 7469 7479  pe=force_multity
+0000f170: 7065 2c0a 2020 2020 2020 2020 2020 2020  pe,.            
+0000f180: 6170 7065 6e64 3d61 7070 656e 642c 0a20  append=append,. 
+0000f190: 2020 2020 2020 2020 2020 2073 6368 656d             schem
+0000f1a0: 613d 7363 6865 6d61 2c0a 2020 2020 2020  a=schema,.      
+0000f1b0: 2020 2020 2020 6372 6561 7465 5f73 7061        create_spa
+0000f1c0: 7469 616c 5f69 6e64 6578 3d63 7265 6174  tial_index=creat
+0000f1d0: 655f 7370 6174 6961 6c5f 696e 6465 782c  e_spatial_index,
+0000f1e0: 0a20 2020 2020 2020 2020 2020 202a 2a6b  .            **k
+0000f1f0: 7761 7267 732c 0a20 2020 2020 2020 2029  wargs,.        )
+0000f200: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+0000f210: 2020 2070 6174 685f 696e 666f 203d 205f     path_info = _
+0000f220: 6765 6f66 696c 6569 6e66 6f2e 6765 745f  geofileinfo.get_
+0000f230: 6765 6f66 696c 6569 6e66 6f28 7061 7468  geofileinfo(path
+0000f240: 290a 0a20 2020 2020 2020 2023 2046 696c  )..        # Fil
+0000f250: 6573 2064 6f6e 2774 2074 7970 6963 616c  es don't typical
+0000f260: 6c79 2073 7570 706f 7274 2068 6176 696e  ly support havin
+0000f270: 6720 6d75 6c74 6970 6c65 2070 726f 6365  g multiple proce
+0000f280: 7373 6573 2077 7269 7469 6e67 0a20 2020  sses writing.   
+0000f290: 2020 2020 2023 2073 696d 756c 7461 6e6f       # simultano
+0000f2a0: 7573 6c79 2074 6f20 7468 656d 2c20 736f  usly to them, so
+0000f2b0: 2075 7365 206c 6f63 6b20 6669 6c65 2074   use lock file t
+0000f2c0: 6f20 7379 6e63 6872 6f6e 697a 6520 6163  o synchronize ac
+0000f2d0: 6365 7373 2e0a 2020 2020 2020 2020 6c6f  cess..        lo
+0000f2e0: 636b 6669 6c65 203d 2050 6174 6828 6622  ckfile = Path(f"
+0000f2f0: 7b73 7472 2870 6174 6829 7d2e 6c6f 636b  {str(path)}.lock
+0000f300: 2229 0a20 2020 2020 2020 2073 7461 7274  ").        start
+0000f310: 5f74 696d 6520 3d20 6461 7465 7469 6d65  _time = datetime
+0000f320: 2e6e 6f77 2829 0a20 2020 2020 2020 2072  .now().        r
+0000f330: 6561 6479 203d 2046 616c 7365 0a20 2020  eady = False.   
+0000f340: 2020 2020 2077 6869 6c65 206e 6f74 2072       while not r
+0000f350: 6561 6479 3a0a 2020 2020 2020 2020 2020  eady:.          
+0000f360: 2020 6966 205f 696f 5f75 7469 6c2e 6372    if _io_util.cr
+0000f370: 6561 7465 5f66 696c 655f 6174 6f6d 6963  eate_file_atomic
+0000f380: 286c 6f63 6b66 696c 6529 2069 7320 5472  (lockfile) is Tr
+0000f390: 7565 3a0a 2020 2020 2020 2020 2020 2020  ue:.            
+0000f3a0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0000f3b0: 2020 2020 2020 2020 2020 2020 2077 7269               wri
+0000f3c0: 7465 5f74 6f5f 6669 6c65 280a 2020 2020  te_to_file(.    
+0000f3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f3e0: 2020 2020 6764 663d 6764 662c 0a20 2020      gdf=gdf,.   
+0000f3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f400: 2020 2020 2070 6174 683d 7061 7468 2c0a       path=path,.
+0000f410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f420: 2020 2020 2020 2020 6c61 7965 723d 6c61          layer=la
+0000f430: 7965 722c 0a20 2020 2020 2020 2020 2020  yer,.           
+0000f440: 2020 2020 2020 2020 2020 2020 2069 6e64               ind
+0000f450: 6578 3d69 6e64 6578 2c0a 2020 2020 2020  ex=index,.      
+0000f460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f470: 2020 666f 7263 655f 6f75 7470 7574 5f67    force_output_g
+0000f480: 656f 6d65 7472 7974 7970 653d 666f 7263  eometrytype=forc
+0000f490: 655f 6f75 7470 7574 5f67 656f 6d65 7472  e_output_geometr
+0000f4a0: 7974 7970 652c 0a20 2020 2020 2020 2020  ytype,.         
+0000f4b0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000f4c0: 6f72 6365 5f6d 756c 7469 7479 7065 3d66  orce_multitype=f
+0000f4d0: 6f72 6365 5f6d 756c 7469 7479 7065 2c0a  orce_multitype,.
+0000f4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f4f0: 2020 2020 2020 2020 6170 7065 6e64 3d54          append=T
+0000f500: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
+0000f510: 2020 2020 2020 2020 2020 2020 2073 6368               sch
+0000f520: 656d 613d 7363 6865 6d61 2c0a 2020 2020  ema=schema,.    
+0000f530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f540: 2020 2020 6372 6561 7465 5f73 7061 7469      create_spati
+0000f550: 616c 5f69 6e64 6578 3d63 7265 6174 655f  al_index=create_
+0000f560: 7370 6174 6961 6c5f 696e 6465 782c 0a20  spatial_index,. 
+0000f570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f580: 2020 2020 2020 202a 2a6b 7761 7267 732c         **kwargs,
+0000f590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f5a0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+0000f5b0: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
+0000f5c0: 6365 7074 696f 6e20 6173 2065 783a 0a20  ception as ex:. 
+0000f5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f5e0: 2020 2023 2049 6620 7371 6c69 7465 206f     # If sqlite o
+0000f5f0: 7574 7075 7420 6669 6c65 206c 6f63 6b65  utput file locke
+0000f600: 642c 2061 6c73 6f20 7265 7472 790a 2020  d, also retry.  
+0000f610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f620: 2020 6966 2070 6174 685f 696e 666f 2e69    if path_info.i
+0000f630: 735f 7370 6174 6961 6c69 7465 5f62 6173  s_spatialite_bas
+0000f640: 6564 2061 6e64 2073 7472 2865 7829 206e  ed and str(ex) n
+0000f650: 6f74 2069 6e20 5b0a 2020 2020 2020 2020  ot in [.        
+0000f660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f670: 2264 6174 6162 6173 6520 6973 206c 6f63  "database is loc
+0000f680: 6b65 6422 2c0a 2020 2020 2020 2020 2020  ked",.          
+0000f690: 2020 2020 2020 2020 2020 2020 2020 2261                "a
+0000f6a0: 7474 656d 7074 2074 6f20 7772 6974 6520  ttempt to write 
+0000f6b0: 6120 7265 6164 6f6e 6c79 2064 6174 6162  a readonly datab
+0000f6c0: 6173 6522 2c0a 2020 2020 2020 2020 2020  ase",.          
+0000f6d0: 2020 2020 2020 2020 2020 5d3a 0a20 2020            ]:.   
+0000f6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f6f0: 2020 2020 2072 6169 7365 2065 780a 2020       raise ex.  
+0000f700: 2020 2020 2020 2020 2020 2020 2020 6669                fi
+0000f710: 6e61 6c6c 793a 0a20 2020 2020 2020 2020  nally:.         
+0000f720: 2020 2020 2020 2020 2020 2072 6561 6479             ready
+0000f730: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
+0000f740: 2020 2020 2020 2020 2020 2020 6c6f 636b              lock
+0000f750: 6669 6c65 2e75 6e6c 696e 6b28 290a 2020  file.unlink().  
+0000f760: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0000f770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f780: 7469 6d65 5f77 6169 7469 6e67 203d 2028  time_waiting = (
+0000f790: 6461 7465 7469 6d65 2e6e 6f77 2829 202d  datetime.now() -
+0000f7a0: 2073 7461 7274 5f74 696d 6529 2e74 6f74   start_time).tot
+0000f7b0: 616c 5f73 6563 6f6e 6473 2829 0a20 2020  al_seconds().   
+0000f7c0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0000f7d0: 7469 6d65 5f77 6169 7469 6e67 203e 2061  time_waiting > a
+0000f7e0: 7070 656e 645f 7469 6d65 6f75 745f 733a  ppend_timeout_s:
+0000f7f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f800: 2020 2020 2072 6169 7365 2052 756e 7469       raise Runti
+0000f810: 6d65 4572 726f 7228 0a20 2020 2020 2020  meError(.       
+0000f820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f830: 2066 2274 6f5f 6669 6c65 2074 696d 656f   f"to_file timeo
+0000f840: 7574 206f 6620 7b61 7070 656e 645f 7469  ut of {append_ti
+0000f850: 6d65 6f75 745f 737d 2072 6561 6368 6564  meout_s} reached
+0000f860: 2c20 7374 6f70 2061 7070 656e 6420 220a  , stop append ".
+0000f870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f880: 2020 2020 2020 2020 6622 746f 207b 7061          f"to {pa
+0000f890: 7468 7d21 220a 2020 2020 2020 2020 2020  th}!".          
+0000f8a0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+0000f8b0: 2020 2020 2020 2020 2023 2053 6c65 6570           # Sleep
+0000f8c0: 2066 6f72 2061 2073 6563 6f6e 6420 6265   for a second be
+0000f8d0: 666f 7265 2074 7279 696e 6720 6167 6169  fore trying agai
+0000f8e0: 6e0a 2020 2020 2020 2020 2020 2020 7469  n.            ti
+0000f8f0: 6d65 2e73 6c65 6570 2831 290a 0a0a 6465  me.sleep(1)...de
+0000f900: 6620 5f74 6f5f 6669 6c65 5f70 796f 6772  f _to_file_pyogr
+0000f910: 696f 280a 2020 2020 6764 663a 2067 7064  io(.    gdf: gpd
+0000f920: 2e47 656f 4461 7461 4672 616d 652c 0a20  .GeoDataFrame,. 
+0000f930: 2020 2070 6174 683a 2050 6174 682c 0a20     path: Path,. 
+0000f940: 2020 206c 6179 6572 3a20 7374 722c 0a20     layer: str,. 
+0000f950: 2020 2066 6f72 6365 5f6f 7574 7075 745f     force_output_
+0000f960: 6765 6f6d 6574 7279 7479 7065 3a20 556e  geometrytype: Un
+0000f970: 696f 6e5b 4765 6f6d 6574 7279 5479 7065  ion[GeometryType
+0000f980: 2c20 7374 722c 204e 6f6e 655d 203d 204e  , str, None] = N
+0000f990: 6f6e 652c 0a20 2020 2066 6f72 6365 5f6d  one,.    force_m
+0000f9a0: 756c 7469 7479 7065 3a20 626f 6f6c 203d  ultitype: bool =
+0000f9b0: 2046 616c 7365 2c0a 2020 2020 6170 7065   False,.    appe
+0000f9c0: 6e64 3a20 626f 6f6c 203d 2046 616c 7365  nd: bool = False
+0000f9d0: 2c0a 2020 2020 6170 7065 6e64 5f74 696d  ,.    append_tim
+0000f9e0: 656f 7574 5f73 3a20 696e 7420 3d20 3630  eout_s: int = 60
+0000f9f0: 302c 0a20 2020 2069 6e64 6578 3a20 4f70  0,.    index: Op
+0000fa00: 7469 6f6e 616c 5b62 6f6f 6c5d 203d 204e  tional[bool] = N
+0000fa10: 6f6e 652c 0a20 2020 2063 7265 6174 655f  one,.    create_
+0000fa20: 7370 6174 6961 6c5f 696e 6465 783a 204f  spatial_index: O
+0000fa30: 7074 696f 6e61 6c5b 626f 6f6c 5d20 3d20  ptional[bool] = 
+0000fa40: 4e6f 6e65 2c0a 2020 2020 2a2a 6b77 6172  None,.    **kwar
+0000fa50: 6773 2c0a 293a 0a20 2020 2022 2222 0a20  gs,.):.    """. 
+0000fa60: 2020 2057 7269 7465 7320 6120 7061 6e64     Writes a pand
+0000fa70: 6173 2064 6174 6166 7261 6d65 2074 6f20  as dataframe to 
+0000fa80: 6669 6c65 2075 7369 6e67 2070 796f 6772  file using pyogr
+0000fa90: 696f 2e0a 2020 2020 2222 220a 2020 2020  io..    """.    
+0000faa0: 2320 4368 6563 6b20 7570 6672 6f6e 7420  # Check upfront 
+0000fab0: 6966 2061 7070 656e 6420 6973 2067 6f69  if append is goi
+0000fac0: 6e67 2074 6f20 776f 726b 2074 6f20 6769  ng to work to gi
+0000fad0: 7665 206e 6963 6520 6572 726f 720a 2020  ve nice error.  
+0000fae0: 2020 6966 2061 7070 656e 6420 6973 2054    if append is T
+0000faf0: 7275 6520 616e 6420 7061 7468 2e65 7869  rue and path.exi
+0000fb00: 7374 7328 293a 0a20 2020 2020 2020 206b  sts():.        k
+0000fb10: 7761 7267 735b 2261 7070 656e 6422 5d20  wargs["append"] 
+0000fb20: 3d20 5472 7565 0a20 2020 2020 2020 206c  = True.        l
+0000fb30: 6179 6572 696e 666f 203d 2067 6574 5f6c  ayerinfo = get_l
+0000fb40: 6179 6572 696e 666f 2870 6174 682c 206c  ayerinfo(path, l
+0000fb50: 6179 6572 2c20 7261 6973 655f 6f6e 5f6e  ayer, raise_on_n
+0000fb60: 6f67 656f 6d3d 4661 6c73 6529 0a0a 2020  ogeom=False)..  
+0000fb70: 2020 2020 2020 2320 4465 7465 726d 696e        # Determin
+0000fb80: 6520 636f 6c75 6d6e 7320 616e 6420 636f  e columns and co
+0000fb90: 6d70 6172 6520 7468 656d 0a20 2020 2020  mpare them.     
+0000fba0: 2020 2066 696c 655f 636f 6c73 203d 205b     file_cols = [
+0000fbb0: 636f 6c2e 7570 7065 7228 2920 666f 7220  col.upper() for 
+0000fbc0: 636f 6c20 696e 206c 6179 6572 696e 666f  col in layerinfo
+0000fbd0: 2e63 6f6c 756d 6e73 5d0a 2020 2020 2020  .columns].      
+0000fbe0: 2020 6966 206c 6179 6572 696e 666f 2e67    if layerinfo.g
+0000fbf0: 656f 6d65 7472 7963 6f6c 756d 6e20 6973  eometrycolumn is
+0000fc00: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+0000fc10: 2020 2020 2020 2067 6466 5f63 6f6c 7320         gdf_cols 
+0000fc20: 3d20 5b63 6f6c 2e75 7070 6572 2829 2066  = [col.upper() f
+0000fc30: 6f72 2063 6f6c 2069 6e20 6764 662e 636f  or col in gdf.co
+0000fc40: 6c75 6d6e 7320 6966 2063 6f6c 2021 3d20  lumns if col != 
+0000fc50: 6764 662e 6765 6f6d 6574 7279 2e6e 616d  gdf.geometry.nam
+0000fc60: 655d 0a20 2020 2020 2020 2065 6c73 653a  e].        else:
+0000fc70: 0a20 2020 2020 2020 2020 2020 2067 6466  .            gdf
+0000fc80: 5f63 6f6c 7320 3d20 5b63 6f6c 2e75 7070  _cols = [col.upp
+0000fc90: 6572 2829 2066 6f72 2063 6f6c 2069 6e20  er() for col in 
+0000fca0: 6764 662e 636f 6c75 6d6e 735d 0a20 2020  gdf.columns].   
+0000fcb0: 2020 2020 2069 6620 6764 665f 636f 6c73       if gdf_cols
+0000fcc0: 2021 3d20 6669 6c65 5f63 6f6c 733a 0a20   != file_cols:. 
+0000fcd0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+0000fce0: 2056 616c 7565 4572 726f 7228 0a20 2020   ValueError(.   
+0000fcf0: 2020 2020 2020 2020 2020 2020 2022 6465               "de
+0000fd00: 7374 696e 6174 696f 6e20 6c61 7965 7220  stination layer 
+0000fd10: 646f 6573 6e27 7420 6861 7665 2074 6865  doesn't have the
+0000fd20: 2073 616d 6520 636f 6c75 6d6e 7320 6173   same columns as
+0000fd30: 2067 6466 3a20 220a 2020 2020 2020 2020   gdf: ".        
+0000fd40: 2020 2020 2020 2020 6622 7b66 696c 655f          f"{file_
+0000fd50: 636f 6c73 7d20 7673 207b 6764 665f 636f  cols} vs {gdf_co
+0000fd60: 6c73 7d22 0a20 2020 2020 2020 2020 2020  ls}".           
+0000fd70: 2029 0a0a 2020 2020 2320 5072 6570 6172   )..    # Prepar
+0000fd80: 6520 6b77 6172 6773 2074 6f20 7573 6520  e kwargs to use 
+0000fd90: 696e 2067 656f 7061 6e64 6173 2e74 6f5f  in geopandas.to_
+0000fda0: 6669 6c65 0a20 2020 2069 6620 6372 6561  file.    if crea
+0000fdb0: 7465 5f73 7061 7469 616c 5f69 6e64 6578  te_spatial_index
+0000fdc0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+0000fdd0: 2020 2020 2020 6b77 6172 6773 5b22 5350        kwargs["SP
+0000fde0: 4154 4941 4c5f 494e 4445 5822 5d20 3d20  ATIAL_INDEX"] = 
+0000fdf0: 6372 6561 7465 5f73 7061 7469 616c 5f69  create_spatial_i
+0000fe00: 6e64 6578 0a20 2020 2070 6174 685f 696e  ndex.    path_in
+0000fe10: 666f 203d 205f 6765 6f66 696c 6569 6e66  fo = _geofileinf
+0000fe20: 6f2e 6765 745f 6765 6f66 696c 6569 6e66  o.get_geofileinf
+0000fe30: 6f28 7061 7468 290a 2020 2020 6b77 6172  o(path).    kwar
+0000fe40: 6773 5b22 6472 6976 6572 225d 203d 2070  gs["driver"] = p
+0000fe50: 6174 685f 696e 666f 2e64 7269 7665 720a  ath_info.driver.
+0000fe60: 2020 2020 6b77 6172 6773 5b22 696e 6465      kwargs["inde
+0000fe70: 7822 5d20 3d20 696e 6465 780a 2020 2020  x"] = index.    
+0000fe80: 6966 2066 6f72 6365 5f6f 7574 7075 745f  if force_output_
+0000fe90: 6765 6f6d 6574 7279 7479 7065 2069 7320  geometrytype is 
+0000fea0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+0000feb0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+0000fec0: 666f 7263 655f 6f75 7470 7574 5f67 656f  force_output_geo
+0000fed0: 6d65 7472 7974 7970 652c 2047 656f 6d65  metrytype, Geome
+0000fee0: 7472 7954 7970 6529 3a0a 2020 2020 2020  tryType):.      
+0000fef0: 2020 2020 2020 666f 7263 655f 6f75 7470        force_outp
+0000ff00: 7574 5f67 656f 6d65 7472 7974 7970 6520  ut_geometrytype 
+0000ff10: 3d20 666f 7263 655f 6f75 7470 7574 5f67  = force_output_g
+0000ff20: 656f 6d65 7472 7974 7970 652e 6e61 6d65  eometrytype.name
+0000ff30: 5f63 616d 656c 6361 7365 0a20 2020 2020  _camelcase.     
+0000ff40: 2020 206b 7761 7267 735b 2267 656f 6d65     kwargs["geome
+0000ff50: 7472 795f 7479 7065 225d 203d 2066 6f72  try_type"] = for
+0000ff60: 6365 5f6f 7574 7075 745f 6765 6f6d 6574  ce_output_geomet
+0000ff70: 7279 7479 7065 0a20 2020 2069 6620 666f  rytype.    if fo
+0000ff80: 7263 655f 6d75 6c74 6974 7970 653a 0a20  rce_multitype:. 
+0000ff90: 2020 2020 2020 206b 7761 7267 735b 2270         kwargs["p
+0000ffa0: 726f 6d6f 7465 5f74 6f5f 6d75 6c74 6922  romote_to_multi"
+0000ffb0: 5d20 3d20 5472 7565 0a20 2020 2069 6620  ] = True.    if 
+0000ffc0: 6e6f 7420 7061 7468 5f69 6e66 6f2e 6973  not path_info.is
+0000ffd0: 5f73 696e 676c 656c 6179 6572 3a0a 2020  _singlelayer:.  
+0000ffe0: 2020 2020 2020 6b77 6172 6773 5b22 6c61        kwargs["la
+0000fff0: 7965 7222 5d20 3d20 6c61 7965 720a 0a20  yer"] = layer.. 
+00010000: 2020 2023 2054 656d 7020 6669 7820 666f     # Temp fix fo
+00010010: 7220 6275 6720 696e 2070 796f 6772 696f  r bug in pyogrio
+00010020: 2030 2e37 2e32 2028 6874 7470 733a 2f2f   0.7.2 (https://
+00010030: 6769 7468 7562 2e63 6f6d 2f67 656f 7061  github.com/geopa
+00010040: 6e64 6173 2f70 796f 6772 696f 2f70 756c  ndas/pyogrio/pul
+00010050: 6c2f 3332 3429 0a20 2020 2023 204c 6f67  l/324).    # Log
+00010060: 6963 2062 6173 6564 206f 6e20 6765 6f70  ic based on geop
+00010070: 616e 6461 732e 746f 5f66 696c 650a 2020  andas.to_file.  
+00010080: 2020 6966 206c 6973 7428 6764 662e 696e    if list(gdf.in
+00010090: 6465 782e 6e61 6d65 7329 203d 3d20 5b4e  dex.names) == [N
+000100a0: 6f6e 655d 2061 6e64 2069 735f 696e 7465  one] and is_inte
+000100b0: 6765 725f 6474 7970 6528 6764 662e 696e  ger_dtype(gdf.in
+000100c0: 6465 782e 6474 7970 6529 3a0a 2020 2020  dex.dtype):.    
+000100d0: 2020 2020 6764 6620 3d20 6764 662e 7265      gdf = gdf.re
+000100e0: 7365 745f 696e 6465 7828 6472 6f70 3d54  set_index(drop=T
+000100f0: 7275 6529 0a0a 2020 2020 2320 4e6f 7720  rue)..    # Now 
+00010100: 7765 2063 616e 2077 7269 7465 0a20 2020  we can write.   
+00010110: 2023 2049 6620 7468 6572 6520 6973 206e   # If there is n
+00010120: 6f20 6765 6f6d 6574 7279 2063 6f6c 756d  o geometry colum
+00010130: 6e20 696e 2074 6865 2069 6e70 7574 2c20  n in the input, 
+00010140: 6e65 7665 7220 6372 6561 7465 2061 2073  never create a s
+00010150: 7061 7469 616c 2069 6e64 6578 2e0a 2020  patial index..  
+00010160: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+00010170: 6764 662c 2067 7064 2e47 656f 4461 7461  gdf, gpd.GeoData
+00010180: 4672 616d 6529 2069 7320 4661 6c73 6520  Frame) is False 
+00010190: 6f72 2028 0a20 2020 2020 2020 2069 7369  or (.        isi
+000101a0: 6e73 7461 6e63 6528 6764 662c 2067 7064  nstance(gdf, gpd
+000101b0: 2e47 656f 4461 7461 4672 616d 6529 2061  .GeoDataFrame) a
+000101c0: 6e64 2022 6765 6f6d 6574 7279 2220 6e6f  nd "geometry" no
+000101d0: 7420 696e 2067 6466 2e63 6f6c 756d 6e73  t in gdf.columns
+000101e0: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
+000101f0: 2320 4966 2067 656f 6d65 7472 7920 636f  # If geometry co
+00010200: 6c75 6d6e 2073 686f 756c 6420 6265 2077  lumn should be w
+00010210: 7269 7474 656e 2c20 7370 6563 6966 7969  ritten, specifyi
+00010220: 6e67 2053 5041 5449 414c 2049 4e44 4558  ng SPATIAL INDEX
+00010230: 2069 7320 6e6f 7420 616c 6c6f 7765 642e   is not allowed.
+00010240: 0a20 2020 2020 2020 2069 6620 2253 5041  .        if "SPA
+00010250: 5449 414c 5f49 4e44 4558 2220 696e 206b  TIAL_INDEX" in k
+00010260: 7761 7267 733a 0a20 2020 2020 2020 2020  wargs:.         
+00010270: 2020 2064 656c 206b 7761 7267 735b 2253     del kwargs["S
+00010280: 5041 5449 414c 5f49 4e44 4558 225d 0a20  PATIAL_INDEX"]. 
+00010290: 2020 2020 2020 2070 796f 6772 696f 2e77         pyogrio.w
+000102a0: 7269 7465 5f64 6174 6166 7261 6d65 2867  rite_dataframe(g
+000102b0: 6466 2c20 7374 7228 7061 7468 292c 202a  df, str(path), *
+000102c0: 2a6b 7761 7267 7329 0a20 2020 2065 6c73  *kwargs).    els
+000102d0: 653a 0a20 2020 2020 2020 206b 7761 7267  e:.        kwarg
+000102e0: 735b 2265 6e67 696e 6522 5d20 3d20 2270  s["engine"] = "p
+000102f0: 796f 6772 696f 220a 2020 2020 2020 2020  yogrio".        
+00010300: 6764 662e 746f 5f66 696c 6528 7374 7228  gdf.to_file(str(
+00010310: 7061 7468 292c 202a 2a6b 7761 7267 7329  path), **kwargs)
+00010320: 0a0a 0a64 6566 2067 6574 5f63 7273 280a  ...def get_crs(.
+00010330: 2020 2020 7061 7468 3a20 556e 696f 6e5b      path: Union[
+00010340: 7374 722c 2022 6f73 2e50 6174 684c 696b  str, "os.PathLik
+00010350: 655b 416e 795d 225d 2c0a 2020 2020 6c61  e[Any]"],.    la
+00010360: 7965 723a 204f 7074 696f 6e61 6c5b 7374  yer: Optional[st
+00010370: 725d 203d 204e 6f6e 652c 0a20 2020 206d  r] = None,.    m
+00010380: 696e 5f63 6f6e 6669 6465 6e63 653a 2069  in_confidence: i
+00010390: 6e74 203d 2037 302c 0a29 202d 3e20 4f70  nt = 70,.) -> Op
+000103a0: 7469 6f6e 616c 5b70 7970 726f 6a2e 4352  tional[pyproj.CR
+000103b0: 535d 3a0a 2020 2020 2222 220a 2020 2020  S]:.    """.    
+000103c0: 4765 7420 7468 6520 4352 5320 2870 726f  Get the CRS (pro
+000103d0: 6a65 6374 696f 6e29 206f 6620 7468 6520  jection) of the 
+000103e0: 6669 6c65 2e0a 0a20 2020 2041 7267 733a  file...    Args:
+000103f0: 0a20 2020 2020 2020 2070 6174 6820 2850  .        path (P
+00010400: 6174 684c 696b 6529 3a20 7061 7468 2074  athLike): path t
+00010410: 6f20 7468 6520 6669 6c65 2e0a 2020 2020  o the file..    
+00010420: 2020 2020 6c61 7965 7220 284f 7074 696f      layer (Optio
+00010430: 6e61 6c5b 7374 725d 293a 206c 6179 6572  nal[str]): layer
+00010440: 206e 616d 652e 2049 6620 6e6f 7420 7370   name. If not sp
+00010450: 6563 6966 6965 642c 2061 6e64 2074 6865  ecified, and the
+00010460: 7265 2069 7320 6f6e 6c79 0a20 2020 2020  re is only.     
+00010470: 2020 2020 2020 206f 6e65 206c 6179 6572         one layer
+00010480: 2069 6e20 7468 6520 6669 6c65 2c20 7468   in the file, th
+00010490: 6973 206c 6179 6572 2069 7320 7573 6564  is layer is used
+000104a0: 2e20 4f74 6865 7277 6973 6520 6578 6365  . Otherwise exce
+000104b0: 7074 696f 6e2e 0a20 2020 2020 2020 206d  ption..        m
+000104c0: 696e 5f63 6f6e 6669 6465 6e63 6520 2869  in_confidence (i
+000104d0: 6e74 293a 2061 2076 616c 7565 2062 6574  nt): a value bet
+000104e0: 7765 656e 2030 2d31 3030 2077 6865 7265  ween 0-100 where
+000104f0: 2031 3030 2069 7320 7468 6520 6d6f 7374   100 is the most
+00010500: 2063 6f6e 6669 6465 6e74 2e0a 2020 2020   confident..    
+00010510: 2020 2020 2020 2020 4974 2069 7320 7573          It is us
+00010520: 6564 2074 6f20 6d61 7463 6820 7468 6520  ed to match the 
+00010530: 6372 7320 696e 666f 2066 6f75 6e64 2069  crs info found i
+00010540: 6e20 7468 6520 6669 6c65 2074 6f20 6120  n the file to a 
+00010550: 6372 7320 6465 6669 6e65 6420 6279 0a20  crs defined by. 
+00010560: 2020 2020 2020 2020 2020 2045 5053 472e             EPSG.
+00010570: 0a0a 2020 2020 5265 7475 726e 733a 0a20  ..    Returns:. 
+00010580: 2020 2020 2020 2070 7970 726f 6a2e 4352         pyproj.CR
+00010590: 533a 2054 6865 2070 726f 6a65 6374 696f  S: The projectio
+000105a0: 6e20 6f66 2074 6865 2066 696c 652e 0a20  n of the file.. 
+000105b0: 2020 2022 2222 0a20 2020 2023 2043 6865     """.    # Che
+000105c0: 636b 2069 6e70 7574 2070 6172 616d 6574  ck input paramet
+000105d0: 6572 730a 2020 2020 7061 7468 203d 2050  ers.    path = P
+000105e0: 6174 6828 7061 7468 290a 2020 2020 6966  ath(path).    if
+000105f0: 206c 6179 6572 2069 7320 4e6f 6e65 3a0a   layer is None:.
+00010600: 2020 2020 2020 2020 6c61 7965 7220 3d20          layer = 
+00010610: 6765 745f 6f6e 6c79 5f6c 6179 6572 2870  get_only_layer(p
+00010620: 6174 6829 0a0a 2020 2020 6372 7320 3d20  ath)..    crs = 
+00010630: 4e6f 6e65 0a20 2020 2074 7279 3a0a 2020  None.    try:.  
+00010640: 2020 2020 2020 6461 7461 736f 7572 6365        datasource
+00010650: 203d 2067 6461 6c2e 4f70 656e 4578 280a   = gdal.OpenEx(.
+00010660: 2020 2020 2020 2020 2020 2020 7374 7228              str(
+00010670: 7061 7468 292c 206e 4f70 656e 466c 6167  path), nOpenFlag
+00010680: 733d 6764 616c 2e4f 465f 5645 4354 4f52  s=gdal.OF_VECTOR
+00010690: 207c 2067 6461 6c2e 4f46 5f52 4541 444f   | gdal.OF_READO
+000106a0: 4e4c 5920 7c20 6764 616c 2e4f 465f 5348  NLY | gdal.OF_SH
+000106b0: 4152 4544 0a20 2020 2020 2020 2029 0a20  ARED.        ). 
+000106c0: 2020 2020 2020 2064 6174 6173 6f75 7263         datasourc
+000106d0: 655f 6c61 7965 7220 3d20 6461 7461 736f  e_layer = dataso
+000106e0: 7572 6365 2e47 6574 4c61 7965 7228 6c61  urce.GetLayer(la
+000106f0: 7965 7229 0a0a 2020 2020 2020 2020 2320  yer)..        # 
+00010700: 4966 2074 6865 206c 6179 6572 2064 6f65  If the layer doe
+00010710: 736e 2774 2065 7869 7374 2c20 7261 6973  sn't exist, rais
+00010720: 650a 2020 2020 2020 2020 6966 2064 6174  e.        if dat
+00010730: 6173 6f75 7263 655f 6c61 7965 7220 6973  asource_layer is
+00010740: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00010750: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+00010760: 726f 7228 6622 4c61 7965 7220 7b6c 6179  ror(f"Layer {lay
+00010770: 6572 7d20 6e6f 7420 666f 756e 6420 696e  er} not found in
+00010780: 2066 696c 653a 207b 7061 7468 7d22 290a   file: {path}").
+00010790: 0a20 2020 2020 2020 2023 2047 6574 2074  .        # Get t
+000107a0: 6865 2063 7273 0a20 2020 2020 2020 2073  he crs.        s
+000107b0: 7061 7469 616c 7265 6620 3d20 6461 7461  patialref = data
+000107c0: 736f 7572 6365 5f6c 6179 6572 2e47 6574  source_layer.Get
+000107d0: 5370 6174 6961 6c52 6566 2829 0a20 2020  SpatialRef().   
+000107e0: 2020 2020 2069 6620 7370 6174 6961 6c72       if spatialr
+000107f0: 6566 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ef is not None:.
+00010800: 2020 2020 2020 2020 2020 2020 6372 7320              crs 
+00010810: 3d20 7079 7072 6f6a 2e43 5253 2873 7061  = pyproj.CRS(spa
+00010820: 7469 616c 7265 662e 4578 706f 7274 546f  tialref.ExportTo
+00010830: 576b 7428 2929 0a0a 2020 2020 2020 2020  Wkt())..        
+00010840: 2020 2020 2320 4966 2073 7061 7469 616c      # If spatial
+00010850: 2072 6566 2068 6173 206e 6f20 6570 7367   ref has no epsg
+00010860: 2c20 7472 7920 746f 2066 696e 6420 636f  , try to find co
+00010870: 7272 6573 706f 6e64 696e 6720 6f6e 650a  rresponding one.
+00010880: 2020 2020 2020 2020 2020 2020 6966 2063              if c
+00010890: 7273 2e74 6f5f 6570 7367 286d 696e 5f63  rs.to_epsg(min_c
+000108a0: 6f6e 6669 6465 6e63 653d 6d69 6e5f 636f  onfidence=min_co
+000108b0: 6e66 6964 656e 6365 2920 6973 204e 6f6e  nfidence) is Non
+000108c0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+000108d0: 2020 2063 7273 203d 205f 6372 735f 6375     crs = _crs_cu
+000108e0: 7374 6f6d 5f6d 6174 6368 2863 7273 2c20  stom_match(crs, 
+000108f0: 7061 7468 290a 0a20 2020 2065 7863 6570  path)..    excep
+00010900: 7420 5661 6c75 6545 7272 6f72 3a0a 2020  t ValueError:.  
+00010910: 2020 2020 2020 7261 6973 650a 2020 2020        raise.    
+00010920: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
+00010930: 2061 7320 6578 3a0a 2020 2020 2020 2020   as ex:.        
+00010940: 6578 2e61 7267 7320 3d20 2866 2267 6574  ex.args = (f"get
+00010950: 5f63 7273 2065 7272 6f72 3a20 7b65 787d  _crs error: {ex}
+00010960: 2066 6f72 207b 7061 7468 7d2e 7b6c 6179   for {path}.{lay
+00010970: 6572 7d22 2c29 0a20 2020 2020 2020 2072  er}",).        r
+00010980: 6169 7365 0a20 2020 2066 696e 616c 6c79  aise.    finally
+00010990: 3a0a 2020 2020 2020 2020 6461 7461 736f  :.        dataso
+000109a0: 7572 6365 203d 204e 6f6e 650a 0a20 2020  urce = None..   
+000109b0: 2072 6574 7572 6e20 6372 730a 0a0a 6465   return crs...de
+000109c0: 6620 5f63 7273 5f63 7573 746f 6d5f 6d61  f _crs_custom_ma
+000109d0: 7463 6828 6372 733a 2070 7970 726f 6a2e  tch(crs: pyproj.
+000109e0: 4352 532c 2070 6174 685f 746f 5f66 6978  CRS, path_to_fix
+000109f0: 3a20 4f70 7469 6f6e 616c 5b50 6174 685d  : Optional[Path]
+00010a00: 2920 2d3e 2070 7970 726f 6a2e 4352 533a  ) -> pyproj.CRS:
+00010a10: 0a20 2020 2022 2222 0a20 2020 2043 7573  .    """.    Cus
+00010a20: 746f 6d20 6d61 7463 6869 6e67 206f 6620  tom matching of 
+00010a30: 6372 7327 7320 6e6f 7420 6d61 7463 6865  crs's not matche
+00010a40: 6420 6175 746f 6d61 7469 6361 6c6c 792c  d automatically,
+00010a50: 2062 6173 6564 206f 6e20 6e61 6d65 2e0a   based on name..
+00010a60: 0a20 2020 2049 6620 7061 7468 5f74 6f5f  .    If path_to_
+00010a70: 6669 7820 6973 2073 7065 6369 6669 6564  fix is specified
+00010a80: 2c20 7468 6520 636f 7272 6573 706f 6e64  , the correspond
+00010a90: 696e 6720 2e70 726a 2066 696c 6520 6c6f  ing .prj file lo
+00010aa0: 6361 7465 6420 6f6e 2074 6865 2070 6174  cated on the pat
+00010ab0: 6820 7769 6c6c 2062 650a 2020 2020 7265  h will be.    re
+00010ac0: 706c 6163 6564 2062 7920 6120 636f 6e66  placed by a conf
+00010ad0: 6f72 6d69 6e67 202e 7072 6a20 6669 6c65  orming .prj file
+00010ae0: 2069 6620 6120 6d61 7463 6820 6973 2066   if a match is f
+00010af0: 6f75 6e64 2e0a 0a20 2020 2041 7267 733a  ound...    Args:
+00010b00: 0a20 2020 2020 2020 2063 7273 2028 7079  .        crs (py
+00010b10: 7072 6f6a 2e43 5253 293a 2074 6865 2063  proj.CRS): the c
+00010b20: 7273 2074 6f20 6669 6e64 2061 206d 6174  rs to find a mat
+00010b30: 6368 2066 6f72 2e0a 2020 2020 2020 2020  ch for..        
+00010b40: 7061 7468 5f74 6f5f 6669 7820 284f 7074  path_to_fix (Opt
+00010b50: 696f 6e61 6c5b 5061 7468 5d29 3a20 7061  ional[Path]): pa
+00010b60: 7468 2074 6f20 7468 6520 6765 6f66 696c  th to the geofil
+00010b70: 652e 2049 6620 7468 6520 6669 6c65 2069  e. If the file i
+00010b80: 7320 6120 7368 6170 6566 696c 650a 2020  s a shapefile.  
+00010b90: 2020 2020 2020 2020 2020 616e 6420 6120            and a 
+00010ba0: 6372 7320 6973 2066 6f75 6e64 2c20 7468  crs is found, th
+00010bb0: 6520 7072 6a20 6669 6c65 2077 696c 6c20  e prj file will 
+00010bc0: 6265 2072 6570 6c61 6365 6420 6279 206f  be replaced by o
+00010bd0: 6e65 206f 6620 7468 6520 6372 7320 666f  ne of the crs fo
+00010be0: 756e 642e 0a0a 2020 2020 5265 7475 726e  und...    Return
+00010bf0: 733a 0a20 2020 2020 2020 2070 7970 726f  s:.        pypro
+00010c00: 6a2e 4352 533a 2074 6865 2063 7273 2066  j.CRS: the crs f
+00010c10: 6f75 6e64 2e0a 2020 2020 2222 220a 2020  ound..    """.  
+00010c20: 2020 6966 2063 7273 2e6e 616d 6520 696e    if crs.name in
+00010c30: 205b 0a20 2020 2020 2020 2022 4265 6c67   [.        "Belg
+00010c40: 6520 3139 3732 202f 2042 656c 6769 616e  e 1972 / Belgian
+00010c50: 204c 616d 6265 7274 2037 3222 2c0a 2020   Lambert 72",.  
+00010c60: 2020 2020 2020 2242 656c 6765 5f31 3937        "Belge_197
+00010c70: 325f 4265 6c67 6961 6e5f 4c61 6d62 6572  2_Belgian_Lamber
+00010c80: 745f 3732 222c 0a20 2020 2020 2020 2022  t_72",.        "
+00010c90: 4265 6c67 655f 4c61 6d62 6572 745f 3139  Belge_Lambert_19
+00010ca0: 3732 222c 0a20 2020 2020 2020 2022 4244  72",.        "BD
+00010cb0: 3732 202f 2042 656c 6769 616e 204c 616d  72 / Belgian Lam
+00010cc0: 6265 7274 2037 3222 2c0a 2020 2020 5d3a  bert 72",.    ]:
+00010cd0: 0a20 2020 2020 2020 2023 2042 656c 6769  .        # Belgi
+00010ce0: 616e 204c 616d 6265 7274 2069 6e20 6e61  an Lambert in na
+00010cf0: 6d65 2c20 736f 2061 7373 756d 6520 3331  me, so assume 31
+00010d00: 3337 300a 2020 2020 2020 2020 6372 7320  370.        crs 
+00010d10: 3d20 7079 7072 6f6a 2e43 5253 2e66 726f  = pyproj.CRS.fro
+00010d20: 6d5f 6570 7367 2833 3133 3730 290a 0a20  m_epsg(31370).. 
+00010d30: 2020 2020 2020 2023 2049 6620 7061 7468         # If path
+00010d40: 2069 7320 7370 6563 6966 6965 6420 616e   is specified an
+00010d50: 6420 6974 2069 7320 6120 7368 6170 6566  d it is a shapef
+00010d60: 696c 652c 2061 6464 2063 6f72 7265 6374  ile, add correct
+00010d70: 2033 3133 3730 202e 7072 6a20 6669 6c65   31370 .prj file
+00010d80: 0a20 2020 2020 2020 2069 6620 7061 7468  .        if path
+00010d90: 5f74 6f5f 6669 7820 6973 206e 6f74 204e  _to_fix is not N
+00010da0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00010db0: 2064 7269 7665 7220 3d20 5f67 656f 6669   driver = _geofi
+00010dc0: 6c65 696e 666f 2e67 6574 5f64 7269 7665  leinfo.get_drive
+00010dd0: 7228 7061 7468 5f74 6f5f 6669 7829 0a20  r(path_to_fix). 
+00010de0: 2020 2020 2020 2020 2020 2069 6620 6472             if dr
+00010df0: 6976 6572 203d 3d20 2245 5352 4920 5368  iver == "ESRI Sh
+00010e00: 6170 6566 696c 6522 3a0a 2020 2020 2020  apefile":.      
+00010e10: 2020 2020 2020 2020 2020 7072 6a5f 7061            prj_pa
+00010e20: 7468 203d 2070 6174 685f 746f 5f66 6978  th = path_to_fix
+00010e30: 2e70 6172 656e 7420 2f20 6622 7b70 6174  .parent / f"{pat
+00010e40: 685f 746f 5f66 6978 2e73 7465 6d7d 2e70  h_to_fix.stem}.p
+00010e50: 726a 220a 2020 2020 2020 2020 2020 2020  rj".            
+00010e60: 2020 2020 6966 2070 726a 5f70 6174 682e      if prj_path.
+00010e70: 6578 6973 7473 2829 3a0a 2020 2020 2020  exists():.      
+00010e80: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+00010e90: 6a5f 7265 6e61 6d65 5f70 6174 6820 3d20  j_rename_path = 
+00010ea0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00010eb0: 2020 2020 2020 2020 2020 7061 7468 5f74            path_t
+00010ec0: 6f5f 6669 782e 7061 7265 6e74 202f 2066  o_fix.parent / f
+00010ed0: 227b 7061 7468 5f74 6f5f 6669 782e 7374  "{path_to_fix.st
+00010ee0: 656d 7d5f 6f72 6967 2e70 726a 220a 2020  em}_orig.prj".  
+00010ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010f00: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00010f10: 2020 2020 2020 2020 6966 206e 6f74 2070          if not p
+00010f20: 726a 5f72 656e 616d 655f 7061 7468 2e65  rj_rename_path.e
+00010f30: 7869 7374 7328 293a 0a20 2020 2020 2020  xists():.       
+00010f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010f50: 2070 726a 5f70 6174 682e 7265 6e61 6d65   prj_path.rename
+00010f60: 2870 726a 5f72 656e 616d 655f 7061 7468  (prj_rename_path
+00010f70: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00010f80: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00010f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010fa0: 2020 2020 7072 6a5f 7061 7468 2e75 6e6c      prj_path.unl
+00010fb0: 696e 6b28 290a 2020 2020 2020 2020 2020  ink().          
+00010fc0: 2020 2020 2020 2020 2020 7072 6a5f 7061            prj_pa
+00010fd0: 7468 2e77 7269 7465 5f74 6578 7428 5052  th.write_text(PR
+00010fe0: 4a5f 4550 5347 5f33 3133 3730 290a 0a20  J_EPSG_31370).. 
+00010ff0: 2020 2072 6574 7572 6e20 6372 730a 0a0a     return crs...
+00011000: 6465 6620 6973 5f67 656f 6669 6c65 2870  def is_geofile(p
+00011010: 6174 683a 2055 6e69 6f6e 5b73 7472 2c20  ath: Union[str, 
+00011020: 226f 732e 5061 7468 4c69 6b65 5b41 6e79  "os.PathLike[Any
+00011030: 5d22 5d29 202d 3e20 626f 6f6c 3a0a 2020  ]"]) -> bool:.  
+00011040: 2020 2222 220a 2020 2020 4465 7465 726d    """.    Determ
+00011050: 696e 6573 2062 6173 6564 206f 6e20 7468  ines based on th
+00011060: 6520 6669 6c65 7061 7468 2069 6620 7468  e filepath if th
+00011070: 6973 2069 7320 6120 6765 6f66 696c 652e  is is a geofile.
+00011080: 0a0a 2020 2020 4445 5052 4543 4154 4544  ..    DEPRECATED
+00011090: 2e0a 0a20 2020 2041 7267 733a 0a20 2020  ...    Args:.   
+000110a0: 2020 2020 2070 6174 6820 2850 6174 684c       path (PathL
+000110b0: 696b 6529 3a20 5468 6520 6669 6c65 2070  ike): The file p
+000110c0: 6174 682e 0a0a 2020 2020 5265 7475 726e  ath...    Return
+000110d0: 733a 0a20 2020 2020 2020 2062 6f6f 6c3a  s:.        bool:
+000110e0: 2054 7275 6520 6966 2069 7420 6973 2061   True if it is a
+000110f0: 2067 656f 2066 696c 652e 0a20 2020 2022   geo file..    "
+00011100: 2222 0a20 2020 2077 6172 6e69 6e67 732e  "".    warnings.
+00011110: 7761 726e 280a 2020 2020 2020 2020 2269  warn(.        "i
+00011120: 735f 6765 6f66 696c 6520 6973 2064 6570  s_geofile is dep
+00011130: 7265 6361 7465 6420 616e 6420 7769 6c6c  recated and will
+00011140: 2062 6520 7265 6d6f 7665 6420 696e 2061   be removed in a
+00011150: 2066 7574 7572 6520 7665 7273 696f 6e22   future version"
+00011160: 2c0a 2020 2020 2020 2020 4675 7475 7265  ,.        Future
+00011170: 5761 726e 696e 672c 0a20 2020 2020 2020  Warning,.       
+00011180: 2073 7461 636b 6c65 7665 6c3d 322c 0a20   stacklevel=2,. 
+00011190: 2020 2029 0a20 2020 2072 6574 7572 6e20     ).    return 
+000111a0: 6973 5f67 656f 6669 6c65 5f65 7874 2850  is_geofile_ext(P
+000111b0: 6174 6828 7061 7468 292e 7375 6666 6978  ath(path).suffix
+000111c0: 290a 0a0a 6465 6620 6973 5f67 656f 6669  )...def is_geofi
+000111d0: 6c65 5f65 7874 2866 696c 655f 6578 743a  le_ext(file_ext:
+000111e0: 2073 7472 2920 2d3e 2062 6f6f 6c3a 0a20   str) -> bool:. 
+000111f0: 2020 2022 2222 0a20 2020 2044 6574 6572     """.    Deter
+00011200: 6d69 6e65 7320 6261 7365 6420 6f6e 2074  mines based on t
+00011210: 6865 2066 696c 6520 6578 7465 6e73 696f  he file extensio
+00011220: 6e20 6966 2074 6869 7320 6973 2061 2067  n if this is a g
+00011230: 656f 6669 6c65 2e0a 0a20 2020 2044 4550  eofile...    DEP
+00011240: 5245 4341 5445 442e 0a0a 2020 2020 4172  RECATED...    Ar
+00011250: 6773 3a0a 2020 2020 2020 2020 6669 6c65  gs:.        file
+00011260: 5f65 7874 2028 7374 7229 3a20 7468 6520  _ext (str): the 
+00011270: 6578 7465 6e73 696f 6e2e 0a0a 2020 2020  extension...    
+00011280: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
+00011290: 2062 6f6f 6c3a 2054 7275 6520 6966 2069   bool: True if i
+000112a0: 7420 6973 2061 2067 656f 6669 6c65 2e0a  t is a geofile..
+000112b0: 2020 2020 2222 220a 2020 2020 7761 726e      """.    warn
+000112c0: 696e 6773 2e77 6172 6e28 0a20 2020 2020  ings.warn(.     
+000112d0: 2020 2022 6973 5f67 656f 6669 6c65 5f65     "is_geofile_e
+000112e0: 7874 2069 7320 6465 7072 6563 6174 6564  xt is deprecated
+000112f0: 2061 6e64 2077 696c 6c20 6265 2072 656d   and will be rem
+00011300: 6f76 6564 2069 6e20 6120 6675 7475 7265  oved in a future
+00011310: 2076 6572 7369 6f6e 222c 0a20 2020 2020   version",.     
+00011320: 2020 2046 7574 7572 6557 6172 6e69 6e67     FutureWarning
+00011330: 2c0a 2020 2020 2020 2020 7374 6163 6b6c  ,.        stackl
+00011340: 6576 656c 3d32 2c0a 2020 2020 290a 2020  evel=2,.    ).  
+00011350: 2020 7472 793a 0a20 2020 2020 2020 2023    try:.        #
+00011360: 2049 6620 7468 6520 6472 6976 6572 2063   If the driver c
+00011370: 616e 2062 6520 6465 7465 726d 696e 6564  an be determined
+00011380: 2c20 6974 2069 7320 6120 2873 7570 706f  , it is a (suppo
+00011390: 7274 6564 2920 6765 6f20 6669 6c65 2e0a  rted) geo file..
+000113a0: 2020 2020 2020 2020 5f20 3d20 5f67 656f          _ = _geo
+000113b0: 6669 6c65 696e 666f 2e47 656f 6669 6c65  fileinfo.Geofile
+000113c0: 5479 7065 2866 696c 655f 6578 7429 0a20  Type(file_ext). 
+000113d0: 2020 2020 2020 2072 6574 7572 6e20 5472         return Tr
+000113e0: 7565 0a20 2020 2065 7863 6570 7420 4578  ue.    except Ex
+000113f0: 6365 7074 696f 6e3a 0a20 2020 2020 2020  ception:.       
+00011400: 2072 6574 7572 6e20 4661 6c73 650a 0a0a   return False...
+00011410: 6465 6620 636d 7028 0a20 2020 2070 6174  def cmp(.    pat
+00011420: 6831 3a20 556e 696f 6e5b 7374 722c 2022  h1: Union[str, "
+00011430: 6f73 2e50 6174 684c 696b 655b 416e 795d  os.PathLike[Any]
+00011440: 225d 2c20 7061 7468 323a 2055 6e69 6f6e  "], path2: Union
+00011450: 5b73 7472 2c20 226f 732e 5061 7468 4c69  [str, "os.PathLi
+00011460: 6b65 5b41 6e79 5d22 5d0a 2920 2d3e 2062  ke[Any]"].) -> b
+00011470: 6f6f 6c3a 0a20 2020 2022 2222 0a20 2020  ool:.    """.   
+00011480: 2043 6f6d 7061 7265 2069 6620 7477 6f20   Compare if two 
+00011490: 6765 6f66 696c 6573 2061 7265 2069 6465  geofiles are ide
+000114a0: 6e74 6963 616c 2e0a 0a20 2020 2046 6f72  ntical...    For
+000114b0: 2067 656f 6669 6c65 7320 7468 6174 2075   geofiles that u
+000114c0: 7365 206d 756c 7469 706c 6520 6669 6c65  se multiple file
+000114d0: 732c 2061 6c6c 2072 656c 6576 616e 7420  s, all relevant 
+000114e0: 6669 6c65 7320 6d75 7374 2062 6520 6964  files must be id
+000114f0: 656e 7469 6361 6c2e 0a20 2020 2045 672e  entical..    Eg.
+00011500: 2066 6f72 2073 6861 7065 6669 6c65 732c   for shapefiles,
+00011510: 2074 6865 202e 7368 702c 202e 7368 7820   the .shp, .shx 
+00011520: 616e 6420 2e64 6266 2066 696c 6520 6d75  and .dbf file mu
+00011530: 7374 2062 6520 6964 656e 7469 6361 6c2e  st be identical.
+00011540: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
+00011550: 2020 2020 7061 7468 3120 2850 6174 684c      path1 (PathL
+00011560: 696b 6529 3a20 7061 7468 2074 6f20 7468  ike): path to th
+00011570: 6520 6669 7273 7420 6669 6c65 2e0a 2020  e first file..  
+00011580: 2020 2020 2020 7061 7468 3220 2850 6174        path2 (Pat
+00011590: 684c 696b 6529 3a20 7061 7468 2074 6f20  hLike): path to 
+000115a0: 7468 6520 7365 636f 6e64 2066 696c 652e  the second file.
+000115b0: 0a0a 2020 2020 5265 7475 726e 733a 0a20  ..    Returns:. 
+000115c0: 2020 2020 2020 2062 6f6f 6c3a 2054 7275         bool: Tru
+000115d0: 6520 6966 2074 6865 2066 696c 6573 2061  e if the files a
+000115e0: 7265 2069 6465 6e74 6963 616c 0a20 2020  re identical.   
+000115f0: 2022 2222 0a20 2020 2023 2043 6865 636b   """.    # Check
+00011600: 2069 6e70 7574 2070 6172 616d 6574 6572   input parameter
+00011610: 730a 2020 2020 7061 7468 3120 3d20 5061  s.    path1 = Pa
+00011620: 7468 2870 6174 6831 290a 2020 2020 7061  th(path1).    pa
+00011630: 7468 3220 3d20 5061 7468 2870 6174 6832  th2 = Path(path2
+00011640: 290a 0a20 2020 2023 2046 6f72 2061 2073  )..    # For a s
+00011650: 6861 7065 6669 6c65 2c20 6d75 6c74 6970  hapefile, multip
+00011660: 6c65 2066 696c 6573 206e 6565 6420 746f  le files need to
+00011670: 2062 6520 636f 6d70 6172 6564 0a20 2020   be compared.   
+00011680: 2069 6620 7061 7468 312e 7375 6666 6978   if path1.suffix
+00011690: 2e6c 6f77 6572 2829 203d 3d20 222e 7368  .lower() == ".sh
+000116a0: 7022 3a0a 2020 2020 2020 2020 7368 6170  p":.        shap
+000116b0: 6566 696c 655f 6261 7365 5f73 7566 6669  efile_base_suffi
+000116c0: 7865 7320 3d20 5b22 2e73 6870 222c 2022  xes = [".shp", "
+000116d0: 2e64 6266 222c 2022 2e73 6878 225d 0a20  .dbf", ".shx"]. 
+000116e0: 2020 2020 2020 2066 6f72 2073 7566 6669         for suffi
+000116f0: 7820 696e 2073 6861 7065 6669 6c65 5f62  x in shapefile_b
+00011700: 6173 655f 7375 6666 6978 6573 3a0a 2020  ase_suffixes:.  
+00011710: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+00011720: 2066 696c 6563 6d70 2e63 6d70 2870 6174   filecmp.cmp(pat
+00011730: 6831 2e77 6974 685f 7375 6666 6978 2873  h1.with_suffix(s
+00011740: 7566 6669 7829 2c20 7061 7468 322e 7769  uffix), path2.wi
+00011750: 7468 5f73 7566 6669 7828 7375 6666 6978  th_suffix(suffix
+00011760: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
+00011770: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
+00011780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011790: 2020 2020 2066 2246 696c 6520 7b70 6174       f"File {pat
+000117a0: 6831 2e77 6974 685f 7375 6666 6978 2873  h1.with_suffix(s
+000117b0: 7566 6669 7829 7d20 6973 2064 6966 6665  uffix)} is diffe
+000117c0: 7265 6e74 2066 726f 6d20 220a 2020 2020  rent from ".    
+000117d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000117e0: 6622 7b70 6174 6832 2e77 6974 685f 7375  f"{path2.with_su
+000117f0: 6666 6978 2873 7566 6669 7829 7d22 0a20  ffix(suffix)}". 
+00011800: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00011810: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011820: 2072 6574 7572 6e20 4661 6c73 650a 2020   return False.  
+00011830: 2020 2020 2020 7265 7475 726e 2054 7275        return Tru
+00011840: 650a 2020 2020 656c 7365 3a0a 2020 2020  e.    else:.    
+00011850: 2020 2020 7265 7475 726e 2066 696c 6563      return filec
+00011860: 6d70 2e63 6d70 2873 7472 2870 6174 6831  mp.cmp(str(path1
+00011870: 292c 2073 7472 2870 6174 6832 2929 0a0a  ), str(path2))..
+00011880: 0a64 6566 2063 6f70 7928 7372 633a 2055  .def copy(src: U
+00011890: 6e69 6f6e 5b73 7472 2c20 226f 732e 5061  nion[str, "os.Pa
+000118a0: 7468 4c69 6b65 5b41 6e79 5d22 5d2c 2064  thLike[Any]"], d
+000118b0: 7374 3a20 556e 696f 6e5b 7374 722c 2022  st: Union[str, "
+000118c0: 6f73 2e50 6174 684c 696b 655b 416e 795d  os.PathLike[Any]
+000118d0: 225d 293a 0a20 2020 2022 2222 0a20 2020  "]):.    """.   
+000118e0: 2043 6f70 6965 7320 7468 6520 6765 6f66   Copies the geof
+000118f0: 696c 6520 6672 6f6d 2073 7263 2074 6f20  ile from src to 
+00011900: 6473 742e 0a0a 2020 2020 4966 2074 6865  dst...    If the
+00011910: 2073 6f75 7263 6520 6669 6c65 2069 7320   source file is 
+00011920: 6120 6765 6f66 696c 6520 636f 6e74 6169  a geofile contai
+00011930: 6e69 6e67 206f 6620 6d75 6c74 6970 6c65  ning of multiple
+00011940: 2066 696c 6573 2028 6567 2e20 2e73 6870   files (eg. .shp
+00011950: 2920 616c 6c20 6669 6c65 730a 2020 2020  ) all files.    
+00011960: 6172 6520 636f 7069 6564 2e0a 0a20 2020  are copied...   
+00011970: 2041 7267 733a 0a20 2020 2020 2020 2073   Args:.        s
+00011980: 7263 2028 5061 7468 4c69 6b65 293a 2074  rc (PathLike): t
+00011990: 6865 2066 696c 6520 746f 2063 6f70 792e  he file to copy.
+000119a0: 0a20 2020 2020 2020 2064 7374 2028 5061  .        dst (Pa
+000119b0: 7468 4c69 6b65 293a 2074 6865 206c 6f63  thLike): the loc
+000119c0: 6174 696f 6e20 746f 2063 6f70 7920 7468  ation to copy th
+000119d0: 6520 6669 6c65 2873 2920 746f 2e0a 2020  e file(s) to..  
+000119e0: 2020 2222 220a 2020 2020 2320 4368 6563    """.    # Chec
+000119f0: 6b20 696e 7075 7420 7061 7261 6d65 7465  k input paramete
+00011a00: 7273 0a20 2020 2073 7263 203d 2050 6174  rs.    src = Pat
+00011a10: 6828 7372 6329 0a20 2020 2064 7374 203d  h(src).    dst =
+00011a20: 2050 6174 6828 6473 7429 0a20 2020 2073   Path(dst).    s
+00011a30: 7263 5f69 6e66 6f20 3d20 5f67 656f 6669  rc_info = _geofi
+00011a40: 6c65 696e 666f 2e67 6574 5f67 656f 6669  leinfo.get_geofi
+00011a50: 6c65 696e 666f 2873 7263 290a 0a20 2020  leinfo(src)..   
+00011a60: 2023 2043 6f70 7920 7468 6520 6d61 696e   # Copy the main
+00011a70: 2066 696c 650a 2020 2020 7368 7574 696c   file.    shutil
+00011a80: 2e63 6f70 7928 7374 7228 7372 6329 2c20  .copy(str(src), 
+00011a90: 6473 7429 0a0a 2020 2020 2320 466f 7220  dst)..    # For 
+00011aa0: 736f 6d65 2066 696c 6520 7479 7065 732c  some file types,
+00011ab0: 2065 7874 7261 2066 696c 6573 206e 6565   extra files nee
+00011ac0: 6420 746f 2062 6520 636f 7069 6564 0a20  d to be copied. 
+00011ad0: 2020 2023 2049 6620 6465 7374 2069 7320     # If dest is 
+00011ae0: 6120 6469 722c 206a 7573 7420 7573 6520  a dir, just use 
+00011af0: 6d6f 7665 2e20 4f74 6865 7277 6973 6520  move. Otherwise 
+00011b00: 636f 6e63 6174 2064 6573 7420 6669 6c65  concat dest file
+00011b10: 7061 7468 730a 2020 2020 6966 2064 7374  paths.    if dst
+00011b20: 2e69 735f 6469 7228 293a 0a20 2020 2020  .is_dir():.     
+00011b30: 2020 2066 6f72 2073 7566 6669 7820 696e     for suffix in
+00011b40: 2073 7263 5f69 6e66 6f2e 7375 6666 6978   src_info.suffix
+00011b50: 6573 5f65 7874 7261 6669 6c65 733a 0a20  es_extrafiles:. 
+00011b60: 2020 2020 2020 2020 2020 2073 7263 6669             srcfi
+00011b70: 6c65 203d 2073 7263 2e70 6172 656e 7420  le = src.parent 
+00011b80: 2f20 6622 7b73 7263 2e73 7465 6d7d 7b73  / f"{src.stem}{s
+00011b90: 7566 6669 787d 220a 2020 2020 2020 2020  uffix}".        
+00011ba0: 2020 2020 6966 2073 7263 6669 6c65 2e65      if srcfile.e
+00011bb0: 7869 7374 7328 293a 0a20 2020 2020 2020  xists():.       
+00011bc0: 2020 2020 2020 2020 2073 6875 7469 6c2e           shutil.
+00011bd0: 636f 7079 2873 7472 2873 7263 6669 6c65  copy(str(srcfile
+00011be0: 292c 2064 7374 290a 2020 2020 656c 7365  ), dst).    else
+00011bf0: 3a0a 2020 2020 2020 2020 666f 7220 7375  :.        for su
+00011c00: 6666 6978 2069 6e20 7372 635f 696e 666f  ffix in src_info
+00011c10: 2e73 7566 6669 7865 735f 6578 7472 6166  .suffixes_extraf
+00011c20: 696c 6573 3a0a 2020 2020 2020 2020 2020  iles:.          
+00011c30: 2020 7372 6366 696c 6520 3d20 7372 632e    srcfile = src.
+00011c40: 7061 7265 6e74 202f 2066 227b 7372 632e  parent / f"{src.
+00011c50: 7374 656d 7d7b 7375 6666 6978 7d22 0a20  stem}{suffix}". 
+00011c60: 2020 2020 2020 2020 2020 2064 7374 6669             dstfi
+00011c70: 6c65 203d 2064 7374 2e70 6172 656e 7420  le = dst.parent 
+00011c80: 2f20 6622 7b64 7374 2e73 7465 6d7d 7b73  / f"{dst.stem}{s
+00011c90: 7566 6669 787d 220a 2020 2020 2020 2020  uffix}".        
+00011ca0: 2020 2020 6966 2073 7263 6669 6c65 2e65      if srcfile.e
+00011cb0: 7869 7374 7328 293a 0a20 2020 2020 2020  xists():.       
+00011cc0: 2020 2020 2020 2020 2073 6875 7469 6c2e           shutil.
+00011cd0: 636f 7079 2873 7472 2873 7263 6669 6c65  copy(str(srcfile
+00011ce0: 292c 2064 7374 6669 6c65 290a 0a0a 6465  ), dstfile)...de
+00011cf0: 6620 6d6f 7665 2873 7263 3a20 556e 696f  f move(src: Unio
+00011d00: 6e5b 7374 722c 2022 6f73 2e50 6174 684c  n[str, "os.PathL
+00011d10: 696b 655b 416e 795d 225d 2c20 6473 743a  ike[Any]"], dst:
+00011d20: 2055 6e69 6f6e 5b73 7472 2c20 226f 732e   Union[str, "os.
+00011d30: 5061 7468 4c69 6b65 5b41 6e79 5d22 5d29  PathLike[Any]"])
+00011d40: 3a0a 2020 2020 2222 220a 2020 2020 4d6f  :.    """.    Mo
+00011d50: 7665 7320 7468 6520 6765 6f66 696c 6520  ves the geofile 
+00011d60: 6672 6f6d 2073 7263 2074 6f20 6473 742e  from src to dst.
+00011d70: 0a0a 2020 2020 4966 2074 6865 2073 6f75  ..    If the sou
+00011d80: 7263 6520 6669 6c65 2069 7320 6120 6765  rce file is a ge
+00011d90: 6f66 696c 6520 636f 6e74 6169 6e69 6e67  ofile containing
+00011da0: 206f 6620 6d75 6c74 6970 6c65 2066 696c   of multiple fil
+00011db0: 6573 2028 6567 2e20 2e73 6870 2920 616c  es (eg. .shp) al
+00011dc0: 6c20 6669 6c65 730a 2020 2020 6172 6520  l files.    are 
+00011dd0: 6d6f 7665 642e 0a0a 2020 2020 4172 6773  moved...    Args
+00011de0: 3a0a 2020 2020 2020 2020 7372 6320 2850  :.        src (P
+00011df0: 6174 684c 696b 6529 3a20 7468 6520 6669  athLike): the fi
+00011e00: 6c65 2074 6f20 6d6f 7665 0a20 2020 2020  le to move.     
+00011e10: 2020 2064 7374 2028 5061 7468 4c69 6b65     dst (PathLike
+00011e20: 293a 2074 6865 206c 6f63 6174 696f 6e20  ): the location 
+00011e30: 746f 206d 6f76 6520 7468 6520 6669 6c65  to move the file
+00011e40: 2873 2920 746f 0a20 2020 2022 2222 0a20  (s) to.    """. 
+00011e50: 2020 2023 2043 6865 636b 2069 6e70 7574     # Check input
+00011e60: 2070 6172 616d 6574 6572 730a 2020 2020   parameters.    
+00011e70: 7372 6320 3d20 5061 7468 2873 7263 290a  src = Path(src).
+00011e80: 2020 2020 6473 7420 3d20 5061 7468 2864      dst = Path(d
+00011e90: 7374 290a 2020 2020 7372 635f 696e 666f  st).    src_info
+00011ea0: 203d 205f 6765 6f66 696c 6569 6e66 6f2e   = _geofileinfo.
+00011eb0: 6765 745f 6765 6f66 696c 6569 6e66 6f28  get_geofileinfo(
+00011ec0: 7372 6329 0a0a 2020 2020 2320 4d6f 7665  src)..    # Move
+00011ed0: 2074 6865 206d 6169 6e20 6669 6c65 0a20   the main file. 
+00011ee0: 2020 2073 6875 7469 6c2e 6d6f 7665 2873     shutil.move(s
+00011ef0: 7472 2873 7263 292c 2064 7374 290a 0a20  tr(src), dst).. 
+00011f00: 2020 2023 2046 6f72 2073 6f6d 6520 6669     # For some fi
+00011f10: 6c65 2074 7970 6573 2c20 6578 7472 6120  le types, extra 
+00011f20: 6669 6c65 7320 6e65 6564 2074 6f20 6265  files need to be
+00011f30: 206d 6f76 6564 0a20 2020 2023 2049 6620   moved.    # If 
+00011f40: 6465 7374 2069 7320 6120 6469 722c 206a  dest is a dir, j
+00011f50: 7573 7420 7573 6520 6d6f 7665 2e20 4f74  ust use move. Ot
+00011f60: 6865 7277 6973 6520 636f 6e63 6174 2064  herwise concat d
+00011f70: 6573 7420 6669 6c65 7061 7468 730a 2020  est filepaths.  
+00011f80: 2020 6966 2064 7374 2e69 735f 6469 7228    if dst.is_dir(
+00011f90: 293a 0a20 2020 2020 2020 2066 6f72 2073  ):.        for s
+00011fa0: 7566 6669 7820 696e 2073 7263 5f69 6e66  uffix in src_inf
+00011fb0: 6f2e 7375 6666 6978 6573 5f65 7874 7261  o.suffixes_extra
+00011fc0: 6669 6c65 733a 0a20 2020 2020 2020 2020  files:.         
+00011fd0: 2020 2073 7263 6669 6c65 203d 2073 7263     srcfile = src
+00011fe0: 2e70 6172 656e 7420 2f20 6622 7b73 7263  .parent / f"{src
+00011ff0: 2e73 7465 6d7d 7b73 7566 6669 787d 220a  .stem}{suffix}".
+00012000: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+00012010: 7263 6669 6c65 2e65 7869 7374 7328 293a  rcfile.exists():
+00012020: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012030: 2073 6875 7469 6c2e 6d6f 7665 2873 7472   shutil.move(str
+00012040: 2873 7263 6669 6c65 292c 2064 7374 290a  (srcfile), dst).
+00012050: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00012060: 2020 666f 7220 7375 6666 6978 2069 6e20    for suffix in 
+00012070: 7372 635f 696e 666f 2e73 7566 6669 7865  src_info.suffixe
+00012080: 735f 6578 7472 6166 696c 6573 3a0a 2020  s_extrafiles:.  
+00012090: 2020 2020 2020 2020 2020 7372 6366 696c            srcfil
+000120a0: 6520 3d20 7372 632e 7061 7265 6e74 202f  e = src.parent /
+000120b0: 2066 227b 7372 632e 7374 656d 7d7b 7375   f"{src.stem}{su
+000120c0: 6666 6978 7d22 0a20 2020 2020 2020 2020  ffix}".         
+000120d0: 2020 2064 7374 6669 6c65 203d 2064 7374     dstfile = dst
+000120e0: 2e70 6172 656e 7420 2f20 6622 7b64 7374  .parent / f"{dst
+000120f0: 2e73 7465 6d7d 7b73 7566 6669 787d 220a  .stem}{suffix}".
+00012100: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+00012110: 7263 6669 6c65 2e65 7869 7374 7328 293a  rcfile.exists():
+00012120: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012130: 2073 6875 7469 6c2e 6d6f 7665 2873 7472   shutil.move(str
+00012140: 2873 7263 6669 6c65 292c 2064 7374 6669  (srcfile), dstfi
+00012150: 6c65 290a 0a0a 6465 6620 7265 6d6f 7665  le)...def remove
+00012160: 2870 6174 683a 2055 6e69 6f6e 5b73 7472  (path: Union[str
+00012170: 2c20 226f 732e 5061 7468 4c69 6b65 5b41  , "os.PathLike[A
+00012180: 6e79 5d22 5d2c 206d 6973 7369 6e67 5f6f  ny]"], missing_o
+00012190: 6b3a 2062 6f6f 6c20 3d20 4661 6c73 6529  k: bool = False)
+000121a0: 3a0a 2020 2020 2222 220a 2020 2020 5265  :.    """.    Re
+000121b0: 6d6f 7665 7320 7468 6520 6765 6f66 696c  moves the geofil
+000121c0: 652e 0a0a 2020 2020 4973 2069 7420 6973  e...    Is it is
+000121d0: 2061 2067 656f 6669 6c65 2063 6f6d 706f   a geofile compo
+000121e0: 7365 6420 6f66 206d 756c 7469 706c 6520  sed of multiple 
+000121f0: 6669 6c65 7320 2865 672e 202e 7368 7029  files (eg. .shp)
+00012200: 2061 6c6c 2066 696c 6573 2061 7265 2072   all files are r
+00012210: 656d 6f76 6564 2e0a 2020 2020 4966 202e  emoved..    If .
+00012220: 6c6f 636b 2066 696c 6573 2061 7265 2070  lock files are p
+00012230: 7265 7365 6e74 2c20 7468 6579 2061 7265  resent, they are
+00012240: 2072 656d 6f76 6564 2061 7320 7765 6c6c   removed as well
+00012250: 2e0a 0a20 2020 2041 7267 733a 0a20 2020  ...    Args:.   
+00012260: 2020 2020 2070 6174 6820 2850 6174 684c       path (PathL
+00012270: 696b 6529 3a20 7468 6520 6669 6c65 2074  ike): the file t
+00012280: 6f20 7265 6d6f 7665 0a20 2020 2020 2020  o remove.       
+00012290: 206d 6973 7369 6e67 5f6f 6b20 2862 6f6f   missing_ok (boo
+000122a0: 6c2c 206f 7074 696f 6e61 6c29 3a20 5472  l, optional): Tr
+000122b0: 7565 206e 6f74 2074 6f20 6769 7665 2061  ue not to give a
+000122c0: 6e20 6572 726f 7220 6966 2074 6865 2066  n error if the f
+000122d0: 696c 6520 746f 2062 6520 7265 6d6f 7665  ile to be remove
+000122e0: 640a 2020 2020 2020 2020 2020 2020 646f  d.            do
+000122f0: 6573 6e27 7420 6578 6973 742e 2044 6566  esn't exist. Def
+00012300: 6175 6c74 7320 746f 2046 616c 7365 2e0a  aults to False..
+00012310: 2020 2020 2222 220a 2020 2020 2320 4368      """.    # Ch
+00012320: 6563 6b20 696e 7075 7420 7061 7261 6d65  eck input parame
+00012330: 7465 7273 0a20 2020 2070 6174 6820 3d20  ters.    path = 
+00012340: 5061 7468 2870 6174 6829 0a20 2020 2070  Path(path).    p
+00012350: 6174 685f 696e 666f 203d 205f 6765 6f66  ath_info = _geof
+00012360: 696c 6569 6e66 6f2e 6765 745f 6765 6f66  ileinfo.get_geof
+00012370: 696c 6569 6e66 6f28 7061 7468 290a 0a20  ileinfo(path).. 
+00012380: 2020 2023 2049 6620 7468 6572 6520 6973     # If there is
+00012390: 2061 206c 6f63 6b20 6669 6c65 2c20 7265   a lock file, re
+000123a0: 6d6f 7665 2069 740a 2020 2020 6c6f 636b  move it.    lock
+000123b0: 6669 6c65 5f70 6174 6820 3d20 7061 7468  file_path = path
+000123c0: 2e70 6172 656e 7420 2f20 6622 7b70 6174  .parent / f"{pat
+000123d0: 682e 6e61 6d65 7d2e 6c6f 636b 220a 2020  h.name}.lock".  
+000123e0: 2020 6c6f 636b 6669 6c65 5f70 6174 682e    lockfile_path.
+000123f0: 756e 6c69 6e6b 286d 6973 7369 6e67 5f6f  unlink(missing_o
+00012400: 6b3d 5472 7565 290a 0a20 2020 2023 2052  k=True)..    # R
+00012410: 656d 6f76 6520 7468 6520 6d61 696e 2066  emove the main f
+00012420: 696c 650a 2020 2020 6966 2070 6174 682e  ile.    if path.
+00012430: 6578 6973 7473 2829 3a0a 2020 2020 2020  exists():.      
+00012440: 2020 7061 7468 2e75 6e6c 696e 6b28 6d69    path.unlink(mi
+00012450: 7373 696e 675f 6f6b 3d6d 6973 7369 6e67  ssing_ok=missing
+00012460: 5f6f 6b29 0a0a 2020 2020 2320 466f 7220  _ok)..    # For 
+00012470: 736f 6d65 2066 696c 6520 7479 7065 732c  some file types,
+00012480: 2065 7874 7261 2066 696c 6573 206e 6565   extra files nee
+00012490: 6420 746f 2062 6520 7265 6d6f 7665 640a  d to be removed.
+000124a0: 2020 2020 666f 7220 7375 6666 6978 2069      for suffix i
+000124b0: 6e20 7061 7468 5f69 6e66 6f2e 7375 6666  n path_info.suff
+000124c0: 6978 6573 5f65 7874 7261 6669 6c65 733a  ixes_extrafiles:
+000124d0: 0a20 2020 2020 2020 2063 7572 725f 7061  .        curr_pa
+000124e0: 7468 203d 2070 6174 682e 7061 7265 6e74  th = path.parent
+000124f0: 202f 2066 227b 7061 7468 2e73 7465 6d7d   / f"{path.stem}
+00012500: 7b73 7566 6669 787d 220a 2020 2020 2020  {suffix}".      
+00012510: 2020 6375 7272 5f70 6174 682e 756e 6c69    curr_path.unli
+00012520: 6e6b 286d 6973 7369 6e67 5f6f 6b3d 5472  nk(missing_ok=Tr
+00012530: 7565 290a 0a0a 6465 6620 6170 7065 6e64  ue)...def append
+00012540: 5f74 6f28 0a20 2020 2073 7263 3a20 556e  _to(.    src: Un
+00012550: 696f 6e5b 7374 722c 2022 6f73 2e50 6174  ion[str, "os.Pat
+00012560: 684c 696b 655b 416e 795d 225d 2c0a 2020  hLike[Any]"],.  
+00012570: 2020 6473 743a 2055 6e69 6f6e 5b73 7472    dst: Union[str
+00012580: 2c20 226f 732e 5061 7468 4c69 6b65 5b41  , "os.PathLike[A
+00012590: 6e79 5d22 5d2c 0a20 2020 2073 7263 5f6c  ny]"],.    src_l
+000125a0: 6179 6572 3a20 4f70 7469 6f6e 616c 5b73  ayer: Optional[s
+000125b0: 7472 5d20 3d20 4e6f 6e65 2c0a 2020 2020  tr] = None,.    
+000125c0: 6473 745f 6c61 7965 723a 204f 7074 696f  dst_layer: Optio
+000125d0: 6e61 6c5b 7374 725d 203d 204e 6f6e 652c  nal[str] = None,
+000125e0: 0a20 2020 2073 7263 5f63 7273 3a20 556e  .    src_crs: Un
+000125f0: 696f 6e5b 696e 742c 2073 7472 2c20 4e6f  ion[int, str, No
+00012600: 6e65 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ne] = None,.    
+00012610: 6473 745f 6372 733a 2055 6e69 6f6e 5b69  dst_crs: Union[i
+00012620: 6e74 2c20 7374 722c 204e 6f6e 655d 203d  nt, str, None] =
+00012630: 204e 6f6e 652c 0a20 2020 2063 6f6c 756d   None,.    colum
+00012640: 6e73 3a20 4f70 7469 6f6e 616c 5b49 7465  ns: Optional[Ite
+00012650: 7261 626c 655b 7374 725d 5d20 3d20 4e6f  rable[str]] = No
+00012660: 6e65 2c0a 2020 2020 7768 6572 653a 204f  ne,.    where: O
+00012670: 7074 696f 6e61 6c5b 7374 725d 203d 204e  ptional[str] = N
+00012680: 6f6e 652c 0a20 2020 2073 716c 5f73 746d  one,.    sql_stm
+00012690: 743a 204f 7074 696f 6e61 6c5b 7374 725d  t: Optional[str]
+000126a0: 203d 204e 6f6e 652c 0a20 2020 2073 716c   = None,.    sql
+000126b0: 5f64 6961 6c65 6374 3a20 4f70 7469 6f6e  _dialect: Option
+000126c0: 616c 5b4c 6974 6572 616c 5b22 5351 4c49  al[Literal["SQLI
+000126d0: 5445 222c 2022 4f47 5253 514c 225d 5d20  TE", "OGRSQL"]] 
+000126e0: 3d20 4e6f 6e65 2c0a 2020 2020 7265 7072  = None,.    repr
+000126f0: 6f6a 6563 743a 2062 6f6f 6c20 3d20 4661  oject: bool = Fa
+00012700: 6c73 652c 0a20 2020 2065 7870 6c6f 6465  lse,.    explode
+00012710: 636f 6c6c 6563 7469 6f6e 733a 2062 6f6f  collections: boo
+00012720: 6c20 3d20 4661 6c73 652c 0a20 2020 2066  l = False,.    f
+00012730: 6f72 6365 5f6f 7574 7075 745f 6765 6f6d  orce_output_geom
+00012740: 6574 7279 7479 7065 3a20 556e 696f 6e5b  etrytype: Union[
+00012750: 4765 6f6d 6574 7279 5479 7065 2c20 7374  GeometryType, st
+00012760: 722c 204e 6f6e 655d 203d 204e 6f6e 652c  r, None] = None,
+00012770: 0a20 2020 2063 7265 6174 655f 7370 6174  .    create_spat
+00012780: 6961 6c5f 696e 6465 783a 204f 7074 696f  ial_index: Optio
+00012790: 6e61 6c5b 626f 6f6c 5d20 3d20 4e6f 6e65  nal[bool] = None
+000127a0: 2c0a 2020 2020 6170 7065 6e64 5f74 696d  ,.    append_tim
+000127b0: 656f 7574 5f73 3a20 696e 7420 3d20 3630  eout_s: int = 60
+000127c0: 302c 0a20 2020 2074 7261 6e73 6163 7469  0,.    transacti
+000127d0: 6f6e 5f73 697a 653a 2069 6e74 203d 2035  on_size: int = 5
+000127e0: 3030 3030 2c0a 2020 2020 7072 6573 6572  0000,.    preser
+000127f0: 7665 5f66 6964 3a20 4f70 7469 6f6e 616c  ve_fid: Optional
+00012800: 5b62 6f6f 6c5d 203d 204e 6f6e 652c 0a20  [bool] = None,. 
+00012810: 2020 2064 7374 5f64 696d 656e 7369 6f6e     dst_dimension
+00012820: 733a 204f 7074 696f 6e61 6c5b 7374 725d  s: Optional[str]
+00012830: 203d 204e 6f6e 652c 0a20 2020 206f 7074   = None,.    opt
+00012840: 696f 6e73 3a20 6469 6374 203d 207b 7d2c  ions: dict = {},
+00012850: 0a29 3a0a 2020 2020 2222 220a 2020 2020  .):.    """.    
+00012860: 4170 7065 6e64 2073 7263 2066 696c 6520  Append src file 
+00012870: 746f 2074 6865 2064 7374 2066 696c 652e  to the dst file.
+00012880: 0a0a 2020 2020 4966 2061 6e20 7371 6c5f  ..    If an sql_
+00012890: 7374 6d74 2069 7320 7370 6563 6966 6965  stmt is specifie
+000128a0: 642c 2074 6865 2073 716c 6974 6520 7175  d, the sqlite qu
+000128b0: 6572 7920 6361 6e20 636f 6e74 6169 6e20  ery can contain 
+000128c0: 666f 6c6c 6f77 696e 6720 706c 6163 6568  following placeh
+000128d0: 6f6c 6465 7273 0a20 2020 2074 6861 7420  olders.    that 
+000128e0: 7769 6c6c 2062 6520 6175 746f 6d61 7469  will be automati
+000128f0: 6361 6c6c 7920 7265 706c 6163 6564 2066  cally replaced f
+00012900: 6f72 2079 6f75 3a0a 0a20 2020 2020 202a  or you:..      *
+00012910: 207b 6765 6f6d 6574 7279 636f 6c75 6d6e   {geometrycolumn
+00012920: 7d3a 2074 6865 2063 6f6c 756d 6e20 7768  }: the column wh
+00012930: 6572 6520 7468 6520 7072 696d 6172 7920  ere the primary 
+00012940: 6765 6f6d 6574 7279 2069 7320 7374 6f72  geometry is stor
+00012950: 6564 2e0a 2020 2020 2020 2a20 7b63 6f6c  ed..      * {col
+00012960: 756d 6e73 5f74 6f5f 7365 6c65 6374 5f73  umns_to_select_s
+00012970: 7472 7d3a 2069 6620 2763 6f6c 756d 6e73  tr}: if 'columns
+00012980: 2720 6973 206e 6f74 204e 6f6e 652c 2074  ' is not None, t
+00012990: 686f 7365 2063 6f6c 756d 6e73 2c0a 2020  hose columns,.  
+000129a0: 2020 2020 2020 6f74 6865 7277 6973 6520        otherwise 
+000129b0: 616c 6c20 636f 6c75 6d6e 7320 6f66 2074  all columns of t
+000129c0: 6865 206c 6179 6572 2e0a 2020 2020 2020  he layer..      
+000129d0: 2a20 7b69 6e70 7574 5f6c 6179 6572 7d3a  * {input_layer}:
+000129e0: 2074 6865 206c 6179 6572 206e 616d 6520   the layer name 
+000129f0: 6f66 2074 6865 2069 6e70 7574 206c 6179  of the input lay
+00012a00: 6572 2e0a 0a20 2020 2045 7861 6d70 6c65  er...    Example
+00012a10: 2053 514c 2073 7461 7465 6d65 6e74 2077   SQL statement w
+00012a20: 6974 6820 706c 6163 6568 6f6c 6465 7273  ith placeholders
+00012a30: 3a0a 2020 2020 3a3a 0a0a 2020 2020 2020  :.    ::..      
+00012a40: 2020 5345 4c45 4354 207b 6765 6f6d 6574    SELECT {geomet
+00012a50: 7279 636f 6c75 6d6e 7d0a 2020 2020 2020  rycolumn}.      
+00012a60: 2020 2020 2020 2020 7b63 6f6c 756d 6e73          {columns
+00012a70: 5f74 6f5f 7365 6c65 6374 5f73 7472 7d0a  _to_select_str}.
+00012a80: 2020 2020 2020 2020 2020 4652 4f4d 2022            FROM "
+00012a90: 7b69 6e70 7574 5f6c 6179 6572 7d22 206c  {input_layer}" l
+00012aa0: 6179 6572 0a0a 2020 2020 5468 6520 6f70  ayer..    The op
+00012ab0: 7469 6f6e 7320 7061 7261 6d65 7465 7220  tions parameter 
+00012ac0: 6361 6e20 6265 2075 7365 6420 746f 2070  can be used to p
+00012ad0: 6173 7320 616e 7920 7479 7065 206f 6620  ass any type of 
+00012ae0: 6f70 7469 6f6e 7320 746f 2047 4441 4c20  options to GDAL 
+00012af0: 696e 0a20 2020 2074 6865 2066 6f6c 6c6f  in.    the follo
+00012b00: 7769 6e67 2066 6f72 6d3a 0a20 2020 2020  wing form:.     
+00012b10: 2020 207b 2022 3c6f 7074 696f 6e5f 7479     { "<option_ty
+00012b20: 7065 3e2e 3c6f 7074 696f 6e5f 6e61 6d65  pe>.<option_name
+00012b30: 3e22 3a20 3c6f 7074 696f 6e5f 7661 6c75  >": <option_valu
+00012b40: 653e 207d 0a0a 2020 2020 5468 6520 6f70  e> }..    The op
+00012b50: 7469 6f6e 2074 7970 6573 2063 616e 2062  tion types can b
+00012b60: 6520 616e 7920 6f66 2074 6865 2066 6f6c  e any of the fol
+00012b70: 6c6f 7769 6e67 3a0a 2020 2020 2020 2020  lowing:.        
+00012b80: 2d20 4c41 5945 525f 4352 4541 5449 4f4e  - LAYER_CREATION
+00012b90: 3a20 6c61 7965 7220 6372 6561 7469 6f6e  : layer creation
+00012ba0: 206f 7074 696f 6e20 286c 636f 290a 2020   option (lco).  
+00012bb0: 2020 2020 2020 2d20 4441 5441 5345 545f        - DATASET_
+00012bc0: 4352 4541 5449 4f4e 3a20 6461 7461 7365  CREATION: datase
+00012bd0: 7420 6372 6561 7469 6f6e 206f 7074 696f  t creation optio
+00012be0: 6e20 2864 7363 6f29 0a20 2020 2020 2020  n (dsco).       
+00012bf0: 202d 2049 4e50 5554 5f4f 5045 4e3a 2069   - INPUT_OPEN: i
+00012c00: 6e70 7574 2064 6174 6173 6574 206f 7065  nput dataset ope
+00012c10: 6e20 6f70 7469 6f6e 2028 6f6f 290a 2020  n option (oo).  
+00012c20: 2020 2020 2020 2d20 4445 5354 494e 4154        - DESTINAT
+00012c30: 494f 4e5f 4f50 454e 3a20 6465 7374 696e  ION_OPEN: destin
+00012c40: 6174 696f 6e20 6461 7461 7365 7420 6f70  ation dataset op
+00012c50: 656e 206f 7074 696f 6e20 2864 6f6f 290a  en option (doo).
+00012c60: 2020 2020 2020 2020 2d20 434f 4e46 4947          - CONFIG
+00012c70: 3a20 636f 6e66 6967 206f 7074 696f 6e20  : config option 
+00012c80: 2863 6f6e 6669 6729 0a0a 2020 2020 5468  (config)..    Th
+00012c90: 6520 6f70 7469 6f6e 7320 6361 6e20 6265  e options can be
+00012ca0: 2066 6f75 6e64 2069 6e20 7468 6520 7c47   found in the |G
+00012cb0: 4441 4c5f 7665 6374 6f72 5f64 7269 7665  DAL_vector_drive
+00012cc0: 725f 646f 6375 6d65 6e74 6174 696f 6e7c  r_documentation|
+00012cd0: 2e0a 0a20 2020 2041 7267 733a 0a20 2020  ...    Args:.   
+00012ce0: 2020 2020 2073 7263 2028 556e 696f 6e5b       src (Union[
+00012cf0: 7374 722c 293a 2073 6f75 7263 6520 6669  str,): source fi
+00012d00: 6c65 2070 6174 682e 0a20 2020 2020 2020  le path..       
+00012d10: 2064 7374 2028 556e 696f 6e5b 7374 722c   dst (Union[str,
+00012d20: 293a 2064 6573 7469 6e61 7469 6f6e 2066  ): destination f
+00012d30: 696c 6520 7061 7468 2e0a 2020 2020 2020  ile path..      
+00012d40: 2020 7372 635f 6c61 7965 7220 2873 7472    src_layer (str
+00012d50: 2c20 6f70 7469 6f6e 616c 293a 2073 6f75  , optional): sou
+00012d60: 7263 6520 6c61 7965 722e 2044 6566 6175  rce layer. Defau
+00012d70: 6c74 7320 746f 204e 6f6e 652e 0a20 2020  lts to None..   
+00012d80: 2020 2020 2064 7374 5f6c 6179 6572 2028       dst_layer (
+00012d90: 7374 722c 206f 7074 696f 6e61 6c29 3a20  str, optional): 
+00012da0: 6465 7374 696e 6174 696f 6e20 6c61 7965  destination laye
+00012db0: 722e 2044 6566 6175 6c74 7320 746f 204e  r. Defaults to N
+00012dc0: 6f6e 652e 0a20 2020 2020 2020 2073 7263  one..        src
+00012dd0: 5f63 7273 2028 7374 722c 206f 7074 696f  _crs (str, optio
+00012de0: 6e61 6c29 3a20 616e 2065 7073 6720 696e  nal): an epsg in
+00012df0: 7420 6f72 2061 6e79 7468 696e 6720 7375  t or anything su
+00012e00: 7070 6f72 7465 640a 2020 2020 2020 2020  pported.        
+00012e10: 2020 2020 6279 2074 6865 204f 4752 5370      by the OGRSp
+00012e20: 6174 6961 6c52 6566 6572 656e 6365 2e53  atialReference.S
+00012e30: 6574 4672 6f6d 5573 6572 496e 7075 7428  etFromUserInput(
+00012e40: 2920 6361 6c6c 2c20 7768 6963 6820 696e  ) call, which in
+00012e50: 636c 7564 6573 0a20 2020 2020 2020 2020  cludes.         
+00012e60: 2020 2061 6e20 4550 5347 2073 7472 696e     an EPSG strin
+00012e70: 6720 2865 672e 2022 4550 5347 3a34 3332  g (eg. "EPSG:432
+00012e80: 3622 292c 2061 2077 656c 6c20 6b6e 6f77  6"), a well know
+00012e90: 6e20 7465 7874 2028 574b 5429 2043 5253  n text (WKT) CRS
+00012ea0: 0a20 2020 2020 2020 2020 2020 2064 6566  .            def
+00012eb0: 696e 6974 696f 6e2c 2e2e 2e20 4465 6661  inition,... Defa
+00012ec0: 756c 7473 2074 6f20 4e6f 6e65 2e0a 2020  ults to None..  
+00012ed0: 2020 2020 2020 6473 745f 6372 7320 2873        dst_crs (s
+00012ee0: 7472 2c20 6f70 7469 6f6e 616c 293a 2061  tr, optional): a
+00012ef0: 6e20 6570 7367 2069 6e74 206f 7220 616e  n epsg int or an
+00012f00: 7974 6869 6e67 2073 7570 706f 7274 6564  ything supported
+00012f10: 0a20 2020 2020 2020 2020 2020 2062 7920  .            by 
+00012f20: 7468 6520 4f47 5253 7061 7469 616c 5265  the OGRSpatialRe
+00012f30: 6665 7265 6e63 652e 5365 7446 726f 6d55  ference.SetFromU
+00012f40: 7365 7249 6e70 7574 2829 2063 616c 6c2c  serInput() call,
+00012f50: 2077 6869 6368 2069 6e63 6c75 6465 730a   which includes.
+00012f60: 2020 2020 2020 2020 2020 2020 616e 2045              an E
+00012f70: 5053 4720 7374 7269 6e67 2028 6567 2e20  PSG string (eg. 
+00012f80: 2245 5053 473a 3433 3236 2229 2c20 6120  "EPSG:4326"), a 
+00012f90: 7765 6c6c 206b 6e6f 776e 2074 6578 7420  well known text 
+00012fa0: 2857 4b54 2920 4352 530a 2020 2020 2020  (WKT) CRS.      
+00012fb0: 2020 2020 2020 6465 6669 6e69 7469 6f6e        definition
+00012fc0: 2c2e 2e2e 2044 6566 6175 6c74 7320 746f  ,... Defaults to
+00012fd0: 204e 6f6e 652e 0a20 2020 2020 2020 2063   None..        c
+00012fe0: 6f6c 756d 6e73 2028 4974 6572 6162 6c65  olumns (Iterable
+00012ff0: 5b73 7472 5d2c 206f 7074 696f 6e61 6c29  [str], optional)
+00013000: 3a20 5468 6520 286e 6f6e 2d67 656f 6d65  : The (non-geome
+00013010: 7472 7929 2063 6f6c 756d 6e73 2074 6f20  try) columns to 
+00013020: 7265 6164 2077 696c 6c0a 2020 2020 2020  read will.      
+00013030: 2020 2020 2020 6265 2072 6574 7572 6e65        be returne
+00013040: 6420 696e 2074 6865 206f 7264 6572 2073  d in the order s
+00013050: 7065 6369 6669 6564 2e20 4966 204e 6f6e  pecified. If Non
+00013060: 652c 2061 6c6c 2073 7461 6e64 6172 6420  e, all standard 
+00013070: 636f 6c75 6d6e 7320 6172 6520 7265 6164  columns are read
+00013080: 2e0a 2020 2020 2020 2020 2020 2020 496e  ..            In
+00013090: 2061 6464 6974 696f 6e20 746f 2073 7461   addition to sta
+000130a0: 6e64 6172 6420 636f 6c75 6d6e 732c 2069  ndard columns, i
+000130b0: 7420 6973 2061 6c73 6f20 706f 7373 6962  t is also possib
+000130c0: 6c65 0a20 2020 2020 2020 2020 2020 2074  le.            t
+000130d0: 6f20 7370 6563 6966 7920 2266 6964 222c  o specify "fid",
+000130e0: 2061 2075 6e69 7175 6520 696e 6465 7820   a unique index 
+000130f0: 6176 6169 6c61 626c 6520 696e 2061 6c6c  available in all
+00013100: 2069 6e70 7574 2066 696c 6573 2e20 4e6f   input files. No
+00013110: 7465 2074 6861 7420 7468 650a 2020 2020  te that the.    
+00013120: 2020 2020 2020 2020 2266 6964 2220 7769          "fid" wi
+00013130: 6c6c 2062 6520 616c 6961 7365 6420 6567  ll be aliased eg
+00013140: 2e20 746f 2022 6669 645f 3122 2e20 4465  . to "fid_1". De
+00013150: 6661 756c 7473 2074 6f20 4e6f 6e65 2e0a  faults to None..
+00013160: 2020 2020 2020 2020 7768 6572 6520 2873          where (s
+00013170: 7472 2c20 6f70 7469 6f6e 616c 293a 206f  tr, optional): o
+00013180: 6e6c 7920 6170 7065 6e64 2074 6865 2072  nly append the r
+00013190: 6f77 7320 6672 6f6d 2073 7263 2074 6861  ows from src tha
+000131a0: 7420 636f 6d70 6c79 2074 6f20 7468 6520  t comply to the 
+000131b0: 6669 6c74 6572 0a20 2020 2020 2020 2020  filter.         
+000131c0: 2020 2073 7065 6369 6669 6564 2e20 4170     specified. Ap
+000131d0: 706c 6965 6420 6265 666f 7265 2065 7870  plied before exp
+000131e0: 6c6f 6465 636f 6c6c 6563 7469 6f6e 732e  lodecollections.
+000131f0: 2046 696c 7465 7220 7368 6f75 6c64 2062   Filter should b
+00013200: 6520 696e 2073 716c 6974 650a 2020 2020  e in sqlite.    
+00013210: 2020 2020 2020 2020 5351 4c20 5748 4552          SQL WHER
+00013220: 4520 7379 6e74 6178 2061 6e64 207c 7370  E syntax and |sp
+00013230: 6174 6961 6c69 7465 5f72 6566 6572 656e  atialite_referen
+00013240: 6365 5f6c 696e 6b7c 2066 756e 6374 696f  ce_link| functio
+00013250: 6e73 2063 616e 2062 6520 7573 6564 2e20  ns can be used. 
+00013260: 4966 0a20 2020 2020 2020 2020 2020 2077  If.            w
+00013270: 6865 7265 2063 6f6e 7461 696e 7320 7468  here contains th
+00013280: 6520 7b67 656f 6d65 7472 7963 6f6c 756d  e {geometrycolum
+00013290: 6e7d 2070 6c61 6365 686f 6c64 6572 2c20  n} placeholder, 
+000132a0: 6974 2069 7320 6669 6c6c 6564 206f 7574  it is filled out
+000132b0: 2077 6974 6820 7468 650a 2020 2020 2020   with the.      
+000132c0: 2020 2020 2020 6765 6f6d 6574 7279 2063        geometry c
+000132d0: 6f6c 756d 6e20 6e61 6d65 206f 6620 7468  olumn name of th
+000132e0: 6520 7372 6320 6669 6c65 2e20 4465 6661  e src file. Defa
+000132f0: 756c 7473 2074 6f20 4e6f 6e65 2e0a 2020  ults to None..  
+00013300: 2020 2020 2020 7371 6c5f 7374 6d74 2028        sql_stmt (
+00013310: 7374 7229 3a20 5351 4c20 7374 6174 656d  str): SQL statem
+00013320: 656e 7420 746f 2075 7365 2e20 4f6e 6c79  ent to use. Only
+00013330: 2073 7570 706f 7274 6564 2077 6974 6820   supported with 
+00013340: 2270 796f 6772 696f 2220 656e 6769 6e65  "pyogrio" engine
+00013350: 2e0a 2020 2020 2020 2020 7371 6c5f 6469  ..        sql_di
+00013360: 616c 6563 7420 2873 7472 2c20 6f70 7469  alect (str, opti
+00013370: 6f6e 616c 293a 2053 514c 2064 6961 6c65  onal): SQL diale
+00013380: 6374 2075 7365 642e 204f 7074 696f 6e73  ct used. Options
+00013390: 2061 7265 204e 6f6e 652c 2022 5351 4c49   are None, "SQLI
+000133a0: 5445 2220 6f72 0a20 2020 2020 2020 2020  TE" or.         
+000133b0: 2020 2022 4f47 5253 514c 222e 2049 6620     "OGRSQL". If 
+000133c0: 4e6f 6e65 2c20 666f 7220 6461 7461 2073  None, for data s
+000133d0: 6f75 7263 6573 2077 6974 6820 6578 706c  ources with expl
+000133e0: 6963 6974 2053 514c 2073 7570 706f 7274  icit SQL support
+000133f0: 2074 6865 2073 7461 7465 6d65 6e74 0a20   the statement. 
+00013400: 2020 2020 2020 2020 2020 2069 7320 7072             is pr
+00013410: 6f63 6573 7365 6420 6279 2074 6865 2064  ocessed by the d
+00013420: 6566 6175 6c74 2053 514c 2065 6e67 696e  efault SQL engin
+00013430: 6520 2865 2e67 2e20 666f 7220 4765 6f70  e (e.g. for Geop
+00013440: 6163 6b61 6765 2061 6e64 2053 7061 7469  ackage and Spati
+00013450: 616c 6974 650a 2020 2020 2020 2020 2020  alite.          
+00013460: 2020 7468 6973 2069 7320 2253 514c 4954    this is "SQLIT
+00013470: 4522 292e 2046 6f72 2064 6174 6120 736f  E"). For data so
+00013480: 7572 6365 7320 7769 7468 6f75 7420 6e61  urces without na
+00013490: 7469 7665 2053 514c 2073 7570 706f 7274  tive SQL support
+000134a0: 2028 652e 672e 202e 7368 7029 2c0a 2020   (e.g. .shp),.  
+000134b0: 2020 2020 2020 2020 2020 7468 6520 224f            the "O
+000134c0: 4752 5351 4c22 2064 6961 6c65 6374 2069  GRSQL" dialect i
+000134d0: 7320 7468 6520 6465 6661 756c 742e 2049  s the default. I
+000134e0: 6620 7468 6520 2253 514c 4954 4522 2064  f the "SQLITE" d
+000134f0: 6961 6c65 6374 2069 7320 7370 6563 6966  ialect is specif
+00013500: 6965 642c 0a20 2020 2020 2020 2020 2020  ied,.           
+00013510: 207c 7370 6174 6961 6c69 7465 5f72 6566   |spatialite_ref
+00013520: 6572 656e 6365 5f6c 696e 6b7c 2066 756e  erence_link| fun
+00013530: 6374 696f 6e73 2063 616e 2061 6c73 6f20  ctions can also 
+00013540: 6265 2075 7365 642e 2044 6566 6175 6c74  be used. Default
+00013550: 7320 746f 204e 6f6e 652e 0a20 2020 2020  s to None..     
+00013560: 2020 2072 6570 726f 6a65 6374 2028 626f     reproject (bo
+00013570: 6f6c 2c20 6f70 7469 6f6e 616c 293a 2054  ol, optional): T
+00013580: 7275 6520 746f 2072 6570 726f 6a65 6374  rue to reproject
+00013590: 2077 6869 6c65 2063 6f6e 7665 7274 696e   while convertin
+000135a0: 6720 7468 650a 2020 2020 2020 2020 2020  g the.          
+000135b0: 2020 6669 6c65 2e20 4465 6661 756c 7473    file. Defaults
+000135c0: 2074 6f20 4661 6c73 652e 0a20 2020 2020   to False..     
+000135d0: 2020 2065 7870 6c6f 6465 636f 6c6c 6563     explodecollec
+000135e0: 7469 6f6e 7320 2862 6f6f 6c29 2c20 6f70  tions (bool), op
+000135f0: 7469 6f6e 616c 293a 2054 7275 6520 746f  tional): True to
+00013600: 206f 7574 7075 7420 6f6e 6c79 2073 696d   output only sim
+00013610: 706c 6520 6765 6f6d 6574 7269 6573 2e0a  ple geometries..
+00013620: 2020 2020 2020 2020 2020 2020 4465 6661              Defa
+00013630: 756c 7473 2074 6f20 4661 6c73 652e 0a20  ults to False.. 
+00013640: 2020 2020 2020 2066 6f72 6365 5f6f 7574         force_out
+00013650: 7075 745f 6765 6f6d 6574 7279 7479 7065  put_geometrytype
+00013660: 2028 556e 696f 6e5b 4765 6f6d 6574 7279   (Union[Geometry
+00013670: 5479 7065 2c20 7374 725d 2c20 6f70 7469  Type, str], opti
+00013680: 6f6e 616c 293a 2047 656f 6d65 7472 7920  onal): Geometry 
+00013690: 7479 7065 2e0a 2020 2020 2020 2020 2020  type..          
+000136a0: 2020 746f 2028 7472 7920 746f 2920 666f    to (try to) fo
+000136b0: 7263 6520 7468 6520 6f75 7470 7574 2074  rce the output t
+000136c0: 6f2e 2044 6566 6175 6c74 7320 746f 204e  o. Defaults to N
+000136d0: 6f6e 652e 0a20 2020 2020 2020 2063 7265  one..        cre
+000136e0: 6174 655f 7370 6174 6961 6c5f 696e 6465  ate_spatial_inde
+000136f0: 7820 2862 6f6f 6c2c 206f 7074 696f 6e61  x (bool, optiona
+00013700: 6c29 3a20 5472 7565 2074 6f20 6372 6561  l): True to crea
+00013710: 7465 2061 2073 7061 7469 616c 2069 6e64  te a spatial ind
+00013720: 6578 0a20 2020 2020 2020 2020 2020 206f  ex.            o
+00013730: 6e20 7468 6520 6465 7374 696e 6174 696f  n the destinatio
+00013740: 6e20 6669 6c65 2f6c 6179 6572 2e20 4966  n file/layer. If
+00013750: 204e 6f6e 652c 2074 6865 2064 6566 6175   None, the defau
+00013760: 6c74 2062 6568 6176 696f 7572 2062 7920  lt behaviour by 
+00013770: 6764 616c 2066 6f72 0a20 2020 2020 2020  gdal for.       
+00013780: 2020 2020 2074 6861 7420 6669 6c65 2074       that file t
+00013790: 7970 6520 6973 2072 6573 7065 6374 6564  ype is respected
+000137a0: 2e20 4966 2074 6865 2060 4c41 5945 525f  . If the `LAYER_
+000137b0: 4352 4541 5449 4f4e 2e53 5041 5449 414c  CREATION.SPATIAL
+000137c0: 5f49 4e44 4558 600a 2020 2020 2020 2020  _INDEX`.        
+000137d0: 2020 2020 7061 7261 6d65 7465 7220 6973      parameter is
+000137e0: 2073 7065 6369 6669 6564 2069 6e20 6f70   specified in op
+000137f0: 7469 6f6e 732c 2060 6372 6561 7465 5f73  tions, `create_s
+00013800: 7061 7469 616c 5f69 6e64 6578 6020 6973  patial_index` is
+00013810: 2069 676e 6f72 6564 2e20 4966 2074 6865   ignored. If the
+00013820: 0a20 2020 2020 2020 2020 2020 2064 6573  .            des
+00013830: 7469 6e61 7469 6f6e 206c 6179 6572 2065  tination layer e
+00013840: 7869 7374 7320 616c 7265 6164 792c 2060  xists already, `
+00013850: 6372 6561 7465 5f73 7061 7469 616c 5f69  create_spatial_i
+00013860: 6e64 6578 6020 6973 2061 6c73 6f20 6967  ndex` is also ig
+00013870: 6e6f 7265 642e 0a20 2020 2020 2020 2020  nored..         
+00013880: 2020 2044 6566 6175 6c74 7320 746f 204e     Defaults to N
+00013890: 6f6e 652e 0a20 2020 2020 2020 2061 7070  one..        app
+000138a0: 656e 645f 7469 6d65 6f75 745f 7320 2869  end_timeout_s (i
+000138b0: 6e74 2c20 6f70 7469 6f6e 616c 293a 2074  nt, optional): t
+000138c0: 696d 656f 7574 2074 6f20 7573 6520 6966  imeout to use if
+000138d0: 2074 6865 206f 7574 7075 7420 6669 6c65   the output file
+000138e0: 2069 730a 2020 2020 2020 2020 2020 2020   is.            
+000138f0: 6265 696e 6720 7772 6974 7465 6e20 746f  being written to
+00013900: 2062 7920 616e 6f74 6865 7220 7072 6f63   by another proc
+00013910: 6573 7320 616c 7265 6164 792e 2044 6566  ess already. Def
+00013920: 6175 6c74 7320 746f 2036 3030 2e0a 2020  aults to 600..  
+00013930: 2020 2020 2020 7472 616e 7361 6374 696f        transactio
+00013940: 6e5f 7369 7a65 2028 696e 742c 206f 7074  n_size (int, opt
+00013950: 696f 6e61 6c29 3a20 5472 616e 7361 6374  ional): Transact
+00013960: 696f 6e20 7369 7a65 2e20 4465 6661 756c  ion size. Defaul
+00013970: 7473 2074 6f20 3530 3030 302e 0a20 2020  ts to 50000..   
+00013980: 2020 2020 2070 7265 7365 7276 655f 6669       preserve_fi
+00013990: 6420 2862 6f6f 6c2c 206f 7074 696f 6e61  d (bool, optiona
+000139a0: 6c29 3a20 5472 7565 2074 6f20 6d61 6b65  l): True to make
+000139b0: 2061 6e20 6578 7472 6120 6566 666f 7274   an extra effort
+000139c0: 2074 6f20 7072 6573 6572 7665 2066 6964   to preserve fid
+000139d0: 2773 206f 660a 2020 2020 2020 2020 2020  's of.          
+000139e0: 2020 7468 6520 736f 7572 6365 206c 6179    the source lay
+000139f0: 6572 2074 6f20 7468 6520 6465 7374 696e  er to the destin
+00013a00: 6174 696f 6e20 6c61 7965 722e 2046 616c  ation layer. Fal
+00013a10: 7365 206e 6f74 2074 6f20 646f 2061 6e79  se not to do any
+00013a20: 2065 6666 6f72 742e 204e 6f6e 650a 2020   effort. None.  
+00013a30: 2020 2020 2020 2020 2020 746f 2075 7365            to use
+00013a40: 2074 6865 2064 6566 6175 6c74 2062 6568   the default beh
+00013a50: 6176 696f 7572 206f 6620 6764 616c 2c20  aviour of gdal, 
+00013a60: 7468 6174 2061 6c72 6561 6479 2070 7265  that already pre
+00013a70: 7365 7276 6573 2069 6e20 736f 6d65 2063  serves in some c
+00013a80: 6173 6573 2e0a 2020 2020 2020 2020 2020  ases..          
+00013a90: 2020 536f 6d65 2066 696c 6520 666f 726d    Some file form
+00013aa0: 6174 7320 646f 6e27 7420 6578 706c 6963  ats don't explic
+00013ab0: 6974 6c79 2073 746f 7265 2074 6865 2066  itly store the f
+00013ac0: 6964 2028 652e 672e 2073 6861 7065 6669  id (e.g. shapefi
+00013ad0: 6c65 292c 2073 6f20 7468 6579 0a20 2020  le), so they.   
+00013ae0: 2020 2020 2020 2020 2077 696c 6c20 6e65           will ne
+00013af0: 7665 7220 6265 2061 626c 6520 746f 2070  ver be able to p
+00013b00: 7265 7365 7276 6520 6669 6473 2e20 4465  reserve fids. De
+00013b10: 6661 756c 7473 2074 6f20 4e6f 6e65 2e0a  faults to None..
+00013b20: 2020 2020 2020 2020 6473 745f 6469 6d65          dst_dime
+00013b30: 6e73 696f 6e73 2028 7374 722c 206f 7074  nsions (str, opt
+00013b40: 696f 6e61 6c29 3a20 466f 7263 6520 7468  ional): Force th
+00013b50: 6520 6469 6d65 6e73 696f 6e73 206f 6620  e dimensions of 
+00013b60: 7468 6520 6465 7374 696e 6174 696f 6e20  the destination 
+00013b70: 6c61 7965 7220 746f 0a20 2020 2020 2020  layer to.       
+00013b80: 2020 2020 2074 6865 2076 616c 7565 2073       the value s
+00013b90: 7065 6369 6669 6564 2e20 5661 6c69 6420  pecified. Valid 
+00013ba0: 7661 6c75 6573 3a20 2258 5922 2c20 2258  values: "XY", "X
+00013bb0: 595a 222c 2022 5859 4d22 206f 7220 2258  YZ", "XYM" or "X
+00013bc0: 595a 4d22 2e0a 2020 2020 2020 2020 2020  YZM"..          
+00013bd0: 2020 4465 6661 756c 7473 2074 6f20 4e6f    Defaults to No
+00013be0: 6e65 2e0a 2020 2020 2020 2020 6f70 7469  ne..        opti
+00013bf0: 6f6e 7320 2864 6963 742c 206f 7074 696f  ons (dict, optio
+00013c00: 6e61 6c29 3a20 6f70 7469 6f6e 7320 746f  nal): options to
+00013c10: 2070 6173 7320 746f 2067 6461 6c2e 0a0a   pass to gdal...
+00013c20: 2020 2020 5261 6973 6573 3a0a 2020 2020      Raises:.    
+00013c30: 2020 2020 5661 6c75 6545 7272 6f72 3a20      ValueError: 
+00013c40: 616e 2069 6e76 616c 6964 2070 6172 616d  an invalid param
+00013c50: 6574 6572 2076 616c 7565 2077 6173 2070  eter value was p
+00013c60: 6173 7365 642e 0a20 2020 2020 2020 2052  assed..        R
+00013c70: 756e 7469 6d65 4572 726f 723a 2074 696d  untimeError: tim
+00013c80: 656f 7574 2077 6173 2072 6561 6368 6564  eout was reached
+00013c90: 2077 6869 6c65 2074 7279 696e 6720 746f   while trying to
+00013ca0: 2061 7070 656e 6420 6461 7461 2074 6f20   append data to 
+00013cb0: 7061 7468 2e0a 0a20 2020 202e 2e20 7c73  path...    .. |s
+00013cc0: 7061 7469 616c 6974 655f 7265 6665 7265  patialite_refere
+00013cd0: 6e63 655f 6c69 6e6b 7c20 7261 773a 3a20  nce_link| raw:: 
+00013ce0: 6874 6d6c 0a0a 2020 2020 2020 2020 3c61  html..        <a
+00013cf0: 2068 7265 663d 2268 7474 7073 3a2f 2f77   href="https://w
+00013d00: 7777 2e67 6169 612d 6769 732e 6974 2f67  ww.gaia-gis.it/g
+00013d10: 6169 612d 7369 6e73 2f73 7061 7469 616c  aia-sins/spatial
+00013d20: 6974 652d 7371 6c2d 6c61 7465 7374 2e68  ite-sql-latest.h
+00013d30: 746d 6c22 2074 6172 6765 743d 225f 626c  tml" target="_bl
+00013d40: 616e 6b22 3e73 7061 7469 616c 6974 6520  ank">spatialite 
+00013d50: 7265 6665 7265 6e63 653c 2f61 3e0a 0a20  reference</a>.. 
+00013d60: 2020 202e 2e20 7c47 4441 4c5f 7665 6374     .. |GDAL_vect
+00013d70: 6f72 5f64 7269 7665 725f 646f 6375 6d65  or_driver_docume
+00013d80: 6e74 6174 696f 6e7c 2072 6177 3a3a 2068  ntation| raw:: h
+00013d90: 746d 6c0a 0a20 2020 2020 2020 203c 6120  tml..        <a 
+00013da0: 6872 6566 3d22 6874 7470 733a 2f2f 6764  href="https://gd
+00013db0: 616c 2e6f 7267 2f64 7269 7665 7273 2f76  al.org/drivers/v
+00013dc0: 6563 746f 722f 696e 6465 782e 6874 6d6c  ector/index.html
+00013dd0: 2220 7461 7267 6574 3d22 5f62 6c61 6e6b  " target="_blank
+00013de0: 223e 4744 414c 2076 6563 746f 7220 6472  ">GDAL vector dr
+00013df0: 6976 6572 2064 6f63 756d 656e 7461 7469  iver documentati
+00013e00: 6f6e 3c2f 613e 0a0a 2020 2020 2222 2220  on</a>..    """ 
+00013e10: 2023 206e 6f71 613a 2045 3530 310a 2020   # noqa: E501.  
+00013e20: 2020 2320 4368 6563 6b2f 636c 6561 6e20    # Check/clean 
+00013e30: 696e 7075 7420 7061 7261 6d73 0a20 2020  input params.   
+00013e40: 2073 7263 203d 2050 6174 6828 7372 6329   src = Path(src)
+00013e50: 0a20 2020 2064 7374 203d 2050 6174 6828  .    dst = Path(
+00013e60: 6473 7429 0a20 2020 2069 6620 666f 7263  dst).    if forc
+00013e70: 655f 6f75 7470 7574 5f67 656f 6d65 7472  e_output_geometr
+00013e80: 7974 7970 6520 6973 206e 6f74 204e 6f6e  ytype is not Non
+00013e90: 653a 0a20 2020 2020 2020 2066 6f72 6365  e:.        force
+00013ea0: 5f6f 7574 7075 745f 6765 6f6d 6574 7279  _output_geometry
+00013eb0: 7479 7065 203d 2047 656f 6d65 7472 7954  type = GeometryT
+00013ec0: 7970 6528 666f 7263 655f 6f75 7470 7574  ype(force_output
+00013ed0: 5f67 656f 6d65 7472 7974 7970 6529 0a0a  _geometrytype)..
+00013ee0: 2020 2020 2320 4669 6c65 7320 646f 6e27      # Files don'
+00013ef0: 7420 7479 7069 6361 6c6c 7920 7375 7070  t typically supp
+00013f00: 6f72 7420 6861 7669 6e67 206d 756c 7469  ort having multi
+00013f10: 706c 6520 7072 6f63 6573 7365 7320 7772  ple processes wr
+00013f20: 6974 696e 670a 2020 2020 2320 7369 6d75  iting.    # simu
+00013f30: 6c74 616e 6f75 736c 7920 746f 2074 6865  ltanously to the
+00013f40: 6d2c 2073 6f20 7573 6520 6c6f 636b 2066  m, so use lock f
+00013f50: 696c 6520 746f 2073 796e 6368 726f 6e69  ile to synchroni
+00013f60: 7a65 2061 6363 6573 732e 0a20 2020 206c  ze access..    l
+00013f70: 6f63 6b66 696c 6520 3d20 5061 7468 2866  ockfile = Path(f
+00013f80: 227b 7374 7228 6473 7429 7d2e 6c6f 636b  "{str(dst)}.lock
+00013f90: 2229 0a0a 2020 2020 2320 4966 2074 6865  ")..    # If the
+00013fa0: 2064 6573 7469 6e61 7469 6f6e 2066 696c   destination fil
+00013fb0: 6520 646f 6573 6e27 7420 6578 6973 7420  e doesn't exist 
+00013fc0: 7965 742c 2062 7574 2074 6865 206c 6f63  yet, but the loc
+00013fd0: 6b66 696c 6520 646f 6573 2c0a 2020 2020  kfile does,.    
+00013fe0: 2320 7472 7920 7265 6d6f 7669 6e67 2074  # try removing t
+00013ff0: 6865 206c 6f63 6b66 696c 6520 6173 2069  he lockfile as i
+00014000: 7420 6d69 6768 7420 6265 2061 2067 686f  t might be a gho
+00014010: 7374 206c 6f63 6b66 696c 652e 0a20 2020  st lockfile..   
+00014020: 2069 6620 6e6f 7420 6473 742e 6578 6973   if not dst.exis
+00014030: 7473 2829 2061 6e64 206c 6f63 6b66 696c  ts() and lockfil
+00014040: 652e 6578 6973 7473 2829 3a0a 2020 2020  e.exists():.    
+00014050: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00014060: 2020 2020 206c 6f63 6b66 696c 652e 756e       lockfile.un
+00014070: 6c69 6e6b 2829 0a20 2020 2020 2020 2065  link().        e
+00014080: 7863 6570 7420 4578 6365 7074 696f 6e3a  xcept Exception:
+00014090: 0a20 2020 2020 2020 2020 2020 205f 203d  .            _ =
+000140a0: 204e 6f6e 650a 0a20 2020 2023 2043 7265   None..    # Cre
+000140b0: 6174 696e 6720 6c6f 636b 6669 6c65 2061  ating lockfile a
+000140c0: 6e64 2061 7070 656e 640a 2020 2020 7374  nd append.    st
+000140d0: 6172 745f 7469 6d65 203d 2064 6174 6574  art_time = datet
+000140e0: 696d 652e 6e6f 7728 290a 2020 2020 7265  ime.now().    re
+000140f0: 6164 7920 3d20 4661 6c73 650a 2020 2020  ady = False.    
+00014100: 7768 696c 6520 6e6f 7420 7265 6164 793a  while not ready:
+00014110: 0a20 2020 2020 2020 2069 6620 5f69 6f5f  .        if _io_
+00014120: 7574 696c 2e63 7265 6174 655f 6669 6c65  util.create_file
+00014130: 5f61 746f 6d69 6328 6c6f 636b 6669 6c65  _atomic(lockfile
+00014140: 2920 6973 2054 7275 653a 0a20 2020 2020  ) is True:.     
+00014150: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+00014160: 2020 2020 2020 2020 2020 2020 2320 6170              # ap
+00014170: 7065 6e64 0a20 2020 2020 2020 2020 2020  pend.           
+00014180: 2020 2020 205f 6170 7065 6e64 5f74 6f5f       _append_to_
+00014190: 6e6f 6c6f 636b 280a 2020 2020 2020 2020  nolock(.        
+000141a0: 2020 2020 2020 2020 2020 2020 7372 633d              src=
+000141b0: 7372 632c 0a20 2020 2020 2020 2020 2020  src,.           
+000141c0: 2020 2020 2020 2020 2064 7374 3d64 7374           dst=dst
+000141d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000141e0: 2020 2020 2020 7372 635f 6c61 7965 723d        src_layer=
+000141f0: 7372 635f 6c61 7965 722c 0a20 2020 2020  src_layer,.     
+00014200: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00014210: 7374 5f6c 6179 6572 3d64 7374 5f6c 6179  st_layer=dst_lay
+00014220: 6572 2c0a 2020 2020 2020 2020 2020 2020  er,.            
+00014230: 2020 2020 2020 2020 7372 635f 6372 733d          src_crs=
+00014240: 7372 635f 6372 732c 0a20 2020 2020 2020  src_crs,.       
+00014250: 2020 2020 2020 2020 2020 2020 2064 7374               dst
+00014260: 5f63 7273 3d64 7374 5f63 7273 2c0a 2020  _crs=dst_crs,.  
+00014270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014280: 2020 636f 6c75 6d6e 733d 636f 6c75 6d6e    columns=column
+00014290: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+000142a0: 2020 2020 2020 2077 6865 7265 3d77 6865         where=whe
+000142b0: 7265 2c0a 2020 2020 2020 2020 2020 2020  re,.            
+000142c0: 2020 2020 2020 2020 7371 6c5f 7374 6d74          sql_stmt
+000142d0: 3d73 716c 5f73 746d 742c 0a20 2020 2020  =sql_stmt,.     
+000142e0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000142f0: 716c 5f64 6961 6c65 6374 3d73 716c 5f64  ql_dialect=sql_d
+00014300: 6961 6c65 6374 2c0a 2020 2020 2020 2020  ialect,.        
+00014310: 2020 2020 2020 2020 2020 2020 7265 7072              repr
+00014320: 6f6a 6563 743d 7265 7072 6f6a 6563 742c  oject=reproject,
+00014330: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014340: 2020 2020 2065 7870 6c6f 6465 636f 6c6c       explodecoll
+00014350: 6563 7469 6f6e 733d 6578 706c 6f64 6563  ections=explodec
+00014360: 6f6c 6c65 6374 696f 6e73 2c0a 2020 2020  ollections,.    
+00014370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014380: 666f 7263 655f 6f75 7470 7574 5f67 656f  force_output_geo
+00014390: 6d65 7472 7974 7970 653d 666f 7263 655f  metrytype=force_
+000143a0: 6f75 7470 7574 5f67 656f 6d65 7472 7974  output_geometryt
+000143b0: 7970 652c 0a20 2020 2020 2020 2020 2020  ype,.           
+000143c0: 2020 2020 2020 2020 2063 7265 6174 655f           create_
+000143d0: 7370 6174 6961 6c5f 696e 6465 783d 6372  spatial_index=cr
+000143e0: 6561 7465 5f73 7061 7469 616c 5f69 6e64  eate_spatial_ind
+000143f0: 6578 2c0a 2020 2020 2020 2020 2020 2020  ex,.            
+00014400: 2020 2020 2020 2020 7472 616e 7361 6374          transact
+00014410: 696f 6e5f 7369 7a65 3d74 7261 6e73 6163  ion_size=transac
+00014420: 7469 6f6e 5f73 697a 652c 0a20 2020 2020  tion_size,.     
+00014430: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00014440: 7265 7365 7276 655f 6669 643d 7072 6573  reserve_fid=pres
+00014450: 6572 7665 5f66 6964 2c0a 2020 2020 2020  erve_fid,.      
+00014460: 2020 2020 2020 2020 2020 2020 2020 6473                ds
+00014470: 745f 6469 6d65 6e73 696f 6e73 3d64 7374  t_dimensions=dst
+00014480: 5f64 696d 656e 7369 6f6e 732c 0a20 2020  _dimensions,.   
+00014490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000144a0: 206f 7074 696f 6e73 3d6f 7074 696f 6e73   options=options
+000144b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000144c0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+000144d0: 6669 6e61 6c6c 793a 0a20 2020 2020 2020  finally:.       
+000144e0: 2020 2020 2020 2020 2072 6561 6479 203d           ready =
+000144f0: 2054 7275 650a 2020 2020 2020 2020 2020   True.          
+00014500: 2020 2020 2020 6c6f 636b 6669 6c65 2e75        lockfile.u
+00014510: 6e6c 696e 6b28 290a 2020 2020 2020 2020  nlink().        
+00014520: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00014530: 2020 7469 6d65 5f77 6169 7469 6e67 203d    time_waiting =
+00014540: 2028 6461 7465 7469 6d65 2e6e 6f77 2829   (datetime.now()
+00014550: 202d 2073 7461 7274 5f74 696d 6529 2e74   - start_time).t
+00014560: 6f74 616c 5f73 6563 6f6e 6473 2829 0a20  otal_seconds(). 
+00014570: 2020 2020 2020 2020 2020 2069 6620 7469             if ti
+00014580: 6d65 5f77 6169 7469 6e67 203e 2061 7070  me_waiting > app
+00014590: 656e 645f 7469 6d65 6f75 745f 733a 0a20  end_timeout_s:. 
+000145a0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000145b0: 6169 7365 2052 756e 7469 6d65 4572 726f  aise RuntimeErro
+000145c0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+000145d0: 2020 2020 2020 2066 2261 7070 656e 645f         f"append_
+000145e0: 746f 2074 696d 656f 7574 206f 6620 7b61  to timeout of {a
+000145f0: 7070 656e 645f 7469 6d65 6f75 745f 737d  ppend_timeout_s}
+00014600: 2072 6561 6368 6564 2c20 736f 2073 746f   reached, so sto
+00014610: 7020 7772 6974 6520 220a 2020 2020 2020  p write ".      
+00014620: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+00014630: 746f 207b 6473 747d 2122 0a20 2020 2020  to {dst}!".     
+00014640: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00014650: 2020 2020 2020 2320 536c 6565 7020 666f        # Sleep fo
+00014660: 7220 6120 7365 636f 6e64 2062 6566 6f72  r a second befor
+00014670: 6520 7472 7969 6e67 2061 6761 696e 0a20  e trying again. 
+00014680: 2020 2020 2020 2074 696d 652e 736c 6565         time.slee
+00014690: 7028 3129 0a0a 0a64 6566 205f 6170 7065  p(1)...def _appe
+000146a0: 6e64 5f74 6f5f 6e6f 6c6f 636b 280a 2020  nd_to_nolock(.  
+000146b0: 2020 7372 633a 2050 6174 682c 0a20 2020    src: Path,.   
+000146c0: 2064 7374 3a20 5061 7468 2c0a 2020 2020   dst: Path,.    
+000146d0: 7372 635f 6c61 7965 723a 204f 7074 696f  src_layer: Optio
+000146e0: 6e61 6c5b 7374 725d 203d 204e 6f6e 652c  nal[str] = None,
+000146f0: 0a20 2020 2064 7374 5f6c 6179 6572 3a20  .    dst_layer: 
+00014700: 4f70 7469 6f6e 616c 5b73 7472 5d20 3d20  Optional[str] = 
+00014710: 4e6f 6e65 2c0a 2020 2020 7372 635f 6372  None,.    src_cr
+00014720: 733a 2055 6e69 6f6e 5b69 6e74 2c20 7374  s: Union[int, st
+00014730: 722c 204e 6f6e 655d 203d 204e 6f6e 652c  r, None] = None,
+00014740: 0a20 2020 2064 7374 5f63 7273 3a20 556e  .    dst_crs: Un
+00014750: 696f 6e5b 696e 742c 2073 7472 2c20 4e6f  ion[int, str, No
+00014760: 6e65 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ne] = None,.    
+00014770: 636f 6c75 6d6e 733a 204f 7074 696f 6e61  columns: Optiona
+00014780: 6c5b 4974 6572 6162 6c65 5b73 7472 5d5d  l[Iterable[str]]
+00014790: 203d 204e 6f6e 652c 0a20 2020 2077 6865   = None,.    whe
+000147a0: 7265 3a20 4f70 7469 6f6e 616c 5b73 7472  re: Optional[str
+000147b0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 7371  ] = None,.    sq
+000147c0: 6c5f 7374 6d74 3a20 4f70 7469 6f6e 616c  l_stmt: Optional
+000147d0: 5b73 7472 5d20 3d20 4e6f 6e65 2c0a 2020  [str] = None,.  
+000147e0: 2020 7371 6c5f 6469 616c 6563 743a 204f    sql_dialect: O
+000147f0: 7074 696f 6e61 6c5b 4c69 7465 7261 6c5b  ptional[Literal[
+00014800: 2253 514c 4954 4522 2c20 224f 4752 5351  "SQLITE", "OGRSQ
+00014810: 4c22 5d5d 203d 204e 6f6e 652c 0a20 2020  L"]] = None,.   
+00014820: 2072 6570 726f 6a65 6374 3a20 626f 6f6c   reproject: bool
+00014830: 203d 2046 616c 7365 2c0a 2020 2020 6578   = False,.    ex
+00014840: 706c 6f64 6563 6f6c 6c65 6374 696f 6e73  plodecollections
+00014850: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
+00014860: 2020 2020 6372 6561 7465 5f73 7061 7469      create_spati
+00014870: 616c 5f69 6e64 6578 3a20 4f70 7469 6f6e  al_index: Option
+00014880: 616c 5b62 6f6f 6c5d 203d 204e 6f6e 652c  al[bool] = None,
+00014890: 0a20 2020 2066 6f72 6365 5f6f 7574 7075  .    force_outpu
+000148a0: 745f 6765 6f6d 6574 7279 7479 7065 3a20  t_geometrytype: 
+000148b0: 556e 696f 6e5b 4765 6f6d 6574 7279 5479  Union[GeometryTy
+000148c0: 7065 2c20 7374 722c 204e 6f6e 655d 203d  pe, str, None] =
+000148d0: 204e 6f6e 652c 0a20 2020 2074 7261 6e73   None,.    trans
+000148e0: 6163 7469 6f6e 5f73 697a 653a 2069 6e74  action_size: int
+000148f0: 203d 2035 3030 3030 2c0a 2020 2020 7072   = 50000,.    pr
+00014900: 6573 6572 7665 5f66 6964 3a20 4f70 7469  eserve_fid: Opti
+00014910: 6f6e 616c 5b62 6f6f 6c5d 203d 204e 6f6e  onal[bool] = Non
+00014920: 652c 0a20 2020 2064 7374 5f64 696d 656e  e,.    dst_dimen
+00014930: 7369 6f6e 733a 204f 7074 696f 6e61 6c5b  sions: Optional[
+00014940: 7374 725d 203d 204e 6f6e 652c 0a20 2020  str] = None,.   
+00014950: 206f 7074 696f 6e73 3a20 6469 6374 203d   options: dict =
+00014960: 207b 7d2c 0a29 3a0a 2020 2020 2320 4368   {},.):.    # Ch
+00014970: 6563 6b2f 636c 6561 6e20 696e 7075 7420  eck/clean input 
+00014980: 7061 7261 6d73 0a20 2020 206f 7074 696f  params.    optio
+00014990: 6e73 203d 205f 6f67 725f 7574 696c 2e5f  ns = _ogr_util._
+000149a0: 7072 6570 6172 655f 6764 616c 5f6f 7074  prepare_gdal_opt
+000149b0: 696f 6e73 286f 7074 696f 6e73 290a 2020  ions(options).  
+000149c0: 2020 6966 2028 0a20 2020 2020 2020 2063    if (.        c
+000149d0: 7265 6174 655f 7370 6174 6961 6c5f 696e  reate_spatial_in
+000149e0: 6465 7820 6973 206e 6f74 204e 6f6e 650a  dex is not None.
+000149f0: 2020 2020 2020 2020 616e 6420 224c 4159          and "LAY
+00014a00: 4552 5f43 5245 4154 494f 4e2e 5350 4154  ER_CREATION.SPAT
+00014a10: 4941 4c5f 494e 4445 5822 206e 6f74 2069  IAL_INDEX" not i
+00014a20: 6e20 6f70 7469 6f6e 730a 2020 2020 293a  n options.    ):
+00014a30: 0a20 2020 2020 2020 206f 7074 696f 6e73  .        options
+00014a40: 5b22 4c41 5945 525f 4352 4541 5449 4f4e  ["LAYER_CREATION
+00014a50: 2e53 5041 5449 414c 5f49 4e44 4558 225d  .SPATIAL_INDEX"]
+00014a60: 203d 2063 7265 6174 655f 7370 6174 6961   = create_spatia
+00014a70: 6c5f 696e 6465 780a 0a20 2020 2073 7263  l_index..    src
+00014a80: 5f6c 6179 6572 203d 2073 7263 5f6c 6179  _layer = src_lay
+00014a90: 6572 2069 6620 7372 635f 6c61 7965 7220  er if src_layer 
+00014aa0: 6973 206e 6f74 204e 6f6e 6520 656c 7365  is not None else
+00014ab0: 2067 6574 5f6f 6e6c 795f 6c61 7965 7228   get_only_layer(
+00014ac0: 7372 6329 0a20 2020 2073 7263 5f6c 6179  src).    src_lay
+00014ad0: 6572 696e 666f 203d 204e 6f6e 650a 2020  erinfo = None.  
+00014ae0: 2020 6966 2077 6865 7265 2069 7320 6e6f    if where is no
+00014af0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00014b00: 7372 635f 6c61 7965 7269 6e66 6f20 3d20  src_layerinfo = 
+00014b10: 6765 745f 6c61 7965 7269 6e66 6f28 7372  get_layerinfo(sr
+00014b20: 632c 2073 7263 5f6c 6179 6572 2c20 7261  c, src_layer, ra
+00014b30: 6973 655f 6f6e 5f6e 6f67 656f 6d3d 4661  ise_on_nogeom=Fa
+00014b40: 6c73 6529 0a20 2020 2020 2020 2077 6865  lse).        whe
+00014b50: 7265 203d 2077 6865 7265 2e66 6f72 6d61  re = where.forma
+00014b60: 7428 6765 6f6d 6574 7279 636f 6c75 6d6e  t(geometrycolumn
+00014b70: 3d73 7263 5f6c 6179 6572 696e 666f 2e67  =src_layerinfo.g
+00014b80: 656f 6d65 7472 7963 6f6c 756d 6e29 0a0a  eometrycolumn)..
+00014b90: 2020 2020 6966 2073 716c 5f73 746d 7420      if sql_stmt 
+00014ba0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00014bb0: 2020 2020 2023 2046 696c 6c20 6f75 7420       # Fill out 
+00014bc0: 706c 6163 6568 6f6c 6465 7273 2e0a 2020  placeholders..  
+00014bd0: 2020 2020 2020 7371 6c5f 7374 6d74 203d        sql_stmt =
+00014be0: 205f 6669 6c6c 5f6f 7574 5f73 716c 5f70   _fill_out_sql_p
+00014bf0: 6c61 6365 686f 6c64 6572 7328 0a20 2020  laceholders(.   
+00014c00: 2020 2020 2020 2020 2070 6174 683d 7372           path=sr
+00014c10: 632c 206c 6179 6572 3d73 7263 5f6c 6179  c, layer=src_lay
+00014c20: 6572 2c20 7371 6c5f 7374 6d74 3d73 716c  er, sql_stmt=sql
+00014c30: 5f73 746d 742c 2063 6f6c 756d 6e73 3d63  _stmt, columns=c
+00014c40: 6f6c 756d 6e73 0a20 2020 2020 2020 2029  olumns.        )
+00014c50: 0a0a 2020 2020 2320 5768 656e 2063 7265  ..    # When cre
+00014c60: 6174 696e 672f 6170 7065 6e64 696e 6720  ating/appending 
+00014c70: 746f 2061 2073 6861 7065 6669 6c65 2c20  to a shapefile, 
+00014c80: 736f 6d65 2065 7874 7261 2074 6869 6e67  some extra thing
+00014c90: 7320 6e65 6564 2074 6f20 6265 2064 6f6e  s need to be don
+00014ca0: 652f 6368 6563 6b65 642e 0a20 2020 2069  e/checked..    i
+00014cb0: 6620 7371 6c5f 7374 6d74 2069 7320 4e6f  f sql_stmt is No
+00014cc0: 6e65 2061 6e64 2064 7374 2e73 7566 6669  ne and dst.suffi
+00014cd0: 782e 6c6f 7765 7228 2920 3d3d 2022 2e73  x.lower() == ".s
+00014ce0: 6870 223a 0a20 2020 2020 2020 2023 2049  hp":.        # I
+00014cf0: 6620 7468 6520 6465 7374 696e 6174 696f  f the destinatio
+00014d00: 6e20 6669 6c65 2064 6f65 736e 2774 2065  n file doesn't e
+00014d10: 7869 7374 2079 6574 2c20 616e 6420 7468  xist yet, and th
+00014d20: 6520 736f 7572 6365 2066 696c 6520 6861  e source file ha
+00014d30: 730a 2020 2020 2020 2020 2320 6765 6f6d  s.        # geom
+00014d40: 6574 7279 7479 7065 2022 4765 6f6d 6574  etrytype "Geomet
+00014d50: 7279 222c 2072 6169 7365 2062 6563 6175  ry", raise becau
+00014d60: 7365 2074 7970 6520 6973 206e 6f74 2073  se type is not s
+00014d70: 7570 706f 7274 6564 2062 7920 7368 7020  upported by shp 
+00014d80: 2861 6e64 2077 696c 6c0a 2020 2020 2020  (and will.      
+00014d90: 2020 2320 6465 6661 756c 7420 746f 206c    # default to l
+00014da0: 696e 6573 7472 696e 6729 2e0a 2020 2020  inestring)..    
+00014db0: 2020 2020 6966 2073 7263 5f6c 6179 6572      if src_layer
+00014dc0: 696e 666f 2069 7320 4e6f 6e65 3a0a 2020  info is None:.  
+00014dd0: 2020 2020 2020 2020 2020 7372 635f 6c61            src_la
+00014de0: 7965 7269 6e66 6f20 3d20 6765 745f 6c61  yerinfo = get_la
+00014df0: 7965 7269 6e66 6f28 7372 632c 2073 7263  yerinfo(src, src
+00014e00: 5f6c 6179 6572 2c20 7261 6973 655f 6f6e  _layer, raise_on
+00014e10: 5f6e 6f67 656f 6d3d 4661 6c73 6529 0a20  _nogeom=False). 
+00014e20: 2020 2020 2020 2069 6620 280a 2020 2020         if (.    
+00014e30: 2020 2020 2020 2020 666f 7263 655f 6f75          force_ou
+00014e40: 7470 7574 5f67 656f 6d65 7472 7974 7970  tput_geometrytyp
+00014e50: 6520 6973 204e 6f6e 650a 2020 2020 2020  e is None.      
+00014e60: 2020 2020 2020 616e 6420 7372 635f 6c61        and src_la
+00014e70: 7965 7269 6e66 6f2e 6765 6f6d 6574 7279  yerinfo.geometry
+00014e80: 7479 7065 0a20 2020 2020 2020 2020 2020  type.           
+00014e90: 2069 6e20 5b47 656f 6d65 7472 7954 7970   in [GeometryTyp
+00014ea0: 652e 4745 4f4d 4554 5259 2c20 4765 6f6d  e.GEOMETRY, Geom
+00014eb0: 6574 7279 5479 7065 2e47 454f 4d45 5452  etryType.GEOMETR
+00014ec0: 5943 4f4c 4c45 4354 494f 4e5d 0a20 2020  YCOLLECTION].   
+00014ed0: 2020 2020 2020 2020 2061 6e64 206e 6f74           and not
+00014ee0: 2064 7374 2e65 7869 7374 7328 290a 2020   dst.exists().  
+00014ef0: 2020 2020 2020 293a 0a20 2020 2020 2020        ):.       
+00014f00: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+00014f10: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+00014f20: 2020 2020 2020 2066 2273 7263 2066 696c         f"src fil
+00014f30: 6520 7b73 7263 7d20 6861 7320 6765 6f6d  e {src} has geom
+00014f40: 6574 7279 7479 7065 207b 7372 635f 6c61  etrytype {src_la
+00014f50: 7965 7269 6e66 6f2e 6765 6f6d 6574 7279  yerinfo.geometry
+00014f60: 7479 7065 6e61 6d65 7d20 220a 2020 2020  typename} ".    
+00014f70: 2020 2020 2020 2020 2020 2020 2277 6869              "whi
+00014f80: 6368 2069 7320 6e6f 7420 7375 7070 6f72  ch is not suppor
+00014f90: 7465 6420 696e 202e 7368 702e 204d 6179  ted in .shp. May
+00014fa0: 6265 2075 7365 2066 6f72 6365 5f6f 7574  be use force_out
+00014fb0: 7075 745f 6765 6f6d 6574 7279 7479 7065  put_geometrytype
+00014fc0: 3f22 0a20 2020 2020 2020 2020 2020 2029  ?".            )
+00014fd0: 0a0a 2020 2020 2020 2020 2320 4c61 756e  ..        # Laun
+00014fe0: 6465 7220 7468 6520 636f 6c75 6d6e 7320  der the columns 
+00014ff0: 6e61 6d65 7320 7669 6120 6120 5351 4c20  names via a SQL 
+00015000: 7374 6174 656d 656e 742c 206f 7468 6572  statement, other
+00015010: 7769 7365 2077 6865 6e20 6170 7065 6e64  wise when append
+00015020: 696e 6720 7468 650a 2020 2020 2020 2020  ing the.        
+00015030: 2320 6c61 756e 6465 7265 6420 636f 6c75  # laundered colu
+00015040: 6d6e 7320 7769 6c6c 2067 6574 204e 554c  mns will get NUL
+00015050: 4c20 7661 6c75 6573 2069 6e73 7465 6164  L values instead
+00015060: 206f 6620 7468 6520 6461 7461 2e0a 2020   of the data..  
+00015070: 2020 2020 2020 6966 2063 6f6c 756d 6e73        if columns
+00015080: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+00015090: 2020 2020 2020 636f 6c75 6d6e 7320 3d20        columns = 
+000150a0: 7372 635f 6c61 7965 7269 6e66 6f2e 636f  src_layerinfo.co
+000150b0: 6c75 6d6e 730a 2020 2020 2020 2020 636f  lumns.        co
+000150c0: 6c75 6d6e 735f 6c61 756e 6465 7265 6420  lumns_laundered 
+000150d0: 3d20 5f6c 6175 6e64 6572 5f63 6f6c 756d  = _launder_colum
+000150e0: 6e5f 6e61 6d65 7328 636f 6c75 6d6e 7329  n_names(columns)
+000150f0: 0a20 2020 2020 2020 2063 6f6c 756d 6e73  .        columns
+00015100: 5f61 6c69 6173 6564 203d 205b 0a20 2020  _aliased = [.   
+00015110: 2020 2020 2020 2020 2066 2722 7b63 6f6c           f'"{col
+00015120: 756d 6e7d 2220 4153 2022 7b6c 6175 6e64  umn}" AS "{laund
+00015130: 6572 6564 7d22 2720 666f 7220 636f 6c75  ered}"' for colu
+00015140: 6d6e 2c20 6c61 756e 6465 7265 6420 696e  mn, laundered in
+00015150: 2063 6f6c 756d 6e73 5f6c 6175 6e64 6572   columns_launder
+00015160: 6564 0a20 2020 2020 2020 205d 0a20 2020  ed.        ].   
+00015170: 2020 2020 2023 2049 6620 7468 6572 6520       # If there 
+00015180: 6973 2061 2077 6865 7265 2073 7065 6369  is a where speci
+00015190: 6669 6564 2c20 696e 7465 6772 6174 6520  fied, integrate 
+000151a0: 6974 2e2e 2e0a 2020 2020 2020 2020 7768  it....        wh
+000151b0: 6572 655f 636c 6175 7365 203d 2022 220a  ere_clause = "".
+000151c0: 2020 2020 2020 2020 6966 2077 6865 7265          if where
+000151d0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+000151e0: 2020 2020 2020 2020 2020 7768 6572 655f            where_
+000151f0: 636c 6175 7365 203d 2066 2257 4845 5245  clause = f"WHERE
+00015200: 207b 7768 6572 657d 220a 2020 2020 2020   {where}".      
+00015210: 2020 2020 2020 7768 6572 6520 3d20 4e6f        where = No
+00015220: 6e65 0a20 2020 2020 2020 2067 656f 6d65  ne.        geome
+00015230: 7472 7963 6f6c 756d 6e20 3d20 2222 0a20  trycolumn = "". 
+00015240: 2020 2020 2020 2069 6620 7372 635f 6c61         if src_la
+00015250: 7965 7269 6e66 6f2e 6765 6f6d 6574 7279  yerinfo.geometry
+00015260: 636f 6c75 6d6e 2069 7320 6e6f 7420 4e6f  column is not No
+00015270: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00015280: 6765 6f6d 6574 7279 636f 6c75 6d6e 203d  geometrycolumn =
+00015290: 2066 227b 7372 635f 6c61 7965 7269 6e66   f"{src_layerinf
+000152a0: 6f2e 6765 6f6d 6574 7279 636f 6c75 6d6e  o.geometrycolumn
+000152b0: 7d2c 2022 0a20 2020 2020 2020 2073 716c  }, ".        sql
+000152c0: 5f73 746d 7420 3d20 6622 2222 0a20 2020  _stmt = f""".   
+000152d0: 2020 2020 2020 2020 2053 454c 4543 5420           SELECT 
+000152e0: 7b67 656f 6d65 7472 7963 6f6c 756d 6e7d  {geometrycolumn}
+000152f0: 7b22 2c20 222e 6a6f 696e 2863 6f6c 756d  {", ".join(colum
+00015300: 6e73 5f61 6c69 6173 6564 297d 0a20 2020  ns_aliased)}.   
+00015310: 2020 2020 2020 2020 2020 2046 524f 4d20             FROM 
+00015320: 227b 7372 635f 6c61 7965 727d 220a 2020  "{src_layer}".  
+00015330: 2020 2020 2020 2020 2020 207b 7768 6572             {wher
+00015340: 655f 636c 6175 7365 7d0a 2020 2020 2020  e_clause}.      
+00015350: 2020 2222 220a 2020 2020 2020 2020 7371    """.        sq
+00015360: 6c5f 6469 616c 6563 7420 3d20 2253 514c  l_dialect = "SQL
+00015370: 4954 4522 0a20 2020 2020 2020 2063 6f6c  ITE".        col
+00015380: 756d 6e73 203d 204e 6f6e 650a 0a20 2020  umns = None..   
+00015390: 2023 2057 6865 6e20 6473 7420 6669 6c65   # When dst file
+000153a0: 2064 6f65 736e 2774 2065 7869 7374 2061   doesn't exist a
+000153b0: 6e64 2073 7263 2069 7320 656d 7074 7920  nd src is empty 
+000153c0: 666f 7263 655f 6f75 7470 7574 5f67 656f  force_output_geo
+000153d0: 6d65 7472 7974 7970 6520 7368 6f75 6c64  metrytype should
+000153e0: 2062 650a 2020 2020 2320 7370 6563 6966   be.    # specif
+000153f0: 6965 642c 206f 7468 6572 7769 7365 2069  ied, otherwise i
+00015400: 6e76 616c 6964 206f 7574 7075 742e 0a20  nvalid output.. 
+00015410: 2020 2069 6620 666f 7263 655f 6f75 7470     if force_outp
+00015420: 7574 5f67 656f 6d65 7472 7974 7970 6520  ut_geometrytype 
+00015430: 6973 204e 6f6e 6520 616e 6420 6e6f 7420  is None and not 
+00015440: 6473 742e 6578 6973 7473 2829 3a0a 2020  dst.exists():.  
+00015450: 2020 2020 2020 6966 2073 7263 5f6c 6179        if src_lay
+00015460: 6572 696e 666f 2069 7320 4e6f 6e65 3a0a  erinfo is None:.
+00015470: 2020 2020 2020 2020 2020 2020 7372 635f              src_
+00015480: 6c61 7965 7269 6e66 6f20 3d20 6765 745f  layerinfo = get_
+00015490: 6c61 7965 7269 6e66 6f28 7372 632c 2073  layerinfo(src, s
+000154a0: 7263 5f6c 6179 6572 2c20 7261 6973 655f  rc_layer, raise_
+000154b0: 6f6e 5f6e 6f67 656f 6d3d 4661 6c73 6529  on_nogeom=False)
+000154c0: 0a20 2020 2020 2020 2066 6f72 6365 5f6f  .        force_o
+000154d0: 7574 7075 745f 6765 6f6d 6574 7279 7479  utput_geometryty
+000154e0: 7065 203d 2073 7263 5f6c 6179 6572 696e  pe = src_layerin
+000154f0: 666f 2e67 656f 6d65 7472 7974 7970 650a  fo.geometrytype.
+00015500: 0a20 2020 2023 2047 6f21 0a20 2020 2074  .    # Go!.    t
+00015510: 7261 6e73 6c61 7465 5f69 6e66 6f20 3d20  ranslate_info = 
+00015520: 5f6f 6772 5f75 7469 6c2e 5665 6374 6f72  _ogr_util.Vector
+00015530: 5472 616e 736c 6174 6549 6e66 6f28 0a20  TranslateInfo(. 
+00015540: 2020 2020 2020 2069 6e70 7574 5f70 6174         input_pat
+00015550: 683d 7372 632c 0a20 2020 2020 2020 206f  h=src,.        o
+00015560: 7574 7075 745f 7061 7468 3d64 7374 2c0a  utput_path=dst,.
+00015570: 2020 2020 2020 2020 696e 7075 745f 6c61          input_la
+00015580: 7965 7273 3d73 7263 5f6c 6179 6572 2c0a  yers=src_layer,.
+00015590: 2020 2020 2020 2020 6f75 7470 7574 5f6c          output_l
+000155a0: 6179 6572 3d64 7374 5f6c 6179 6572 2c0a  ayer=dst_layer,.
+000155b0: 2020 2020 2020 2020 696e 7075 745f 7372          input_sr
+000155c0: 733d 7372 635f 6372 732c 0a20 2020 2020  s=src_crs,.     
+000155d0: 2020 206f 7574 7075 745f 7372 733d 6473     output_srs=ds
+000155e0: 745f 6372 732c 0a20 2020 2020 2020 2063  t_crs,.        c
+000155f0: 6f6c 756d 6e73 3d63 6f6c 756d 6e73 2c0a  olumns=columns,.
+00015600: 2020 2020 2020 2020 7371 6c5f 7374 6d74          sql_stmt
+00015610: 3d73 716c 5f73 746d 742c 0a20 2020 2020  =sql_stmt,.     
+00015620: 2020 2073 716c 5f64 6961 6c65 6374 3d73     sql_dialect=s
+00015630: 716c 5f64 6961 6c65 6374 2c0a 2020 2020  ql_dialect,.    
+00015640: 2020 2020 7768 6572 653d 7768 6572 652c      where=where,
+00015650: 0a20 2020 2020 2020 2072 6570 726f 6a65  .        reproje
+00015660: 6374 3d72 6570 726f 6a65 6374 2c0a 2020  ct=reproject,.  
+00015670: 2020 2020 2020 7472 616e 7361 6374 696f        transactio
+00015680: 6e5f 7369 7a65 3d74 7261 6e73 6163 7469  n_size=transacti
+00015690: 6f6e 5f73 697a 652c 0a20 2020 2020 2020  on_size,.       
+000156a0: 2061 7070 656e 643d 5472 7565 2c0a 2020   append=True,.  
+000156b0: 2020 2020 2020 7570 6461 7465 3d54 7275        update=Tru
+000156c0: 652c 0a20 2020 2020 2020 2065 7870 6c6f  e,.        explo
+000156d0: 6465 636f 6c6c 6563 7469 6f6e 733d 6578  decollections=ex
+000156e0: 706c 6f64 6563 6f6c 6c65 6374 696f 6e73  plodecollections
+000156f0: 2c0a 2020 2020 2020 2020 666f 7263 655f  ,.        force_
+00015700: 6f75 7470 7574 5f67 656f 6d65 7472 7974  output_geometryt
+00015710: 7970 653d 666f 7263 655f 6f75 7470 7574  ype=force_output
+00015720: 5f67 656f 6d65 7472 7974 7970 652c 0a20  _geometrytype,. 
+00015730: 2020 2020 2020 206f 7074 696f 6e73 3d6f         options=o
+00015740: 7074 696f 6e73 2c0a 2020 2020 2020 2020  ptions,.        
+00015750: 7072 6573 6572 7665 5f66 6964 3d70 7265  preserve_fid=pre
+00015760: 7365 7276 655f 6669 642c 0a20 2020 2020  serve_fid,.     
+00015770: 2020 2064 7374 5f64 696d 656e 7369 6f6e     dst_dimension
+00015780: 733d 6473 745f 6469 6d65 6e73 696f 6e73  s=dst_dimensions
+00015790: 2c0a 2020 2020 290a 2020 2020 5f6f 6772  ,.    ).    _ogr
+000157a0: 5f75 7469 6c2e 7665 6374 6f72 5f74 7261  _util.vector_tra
+000157b0: 6e73 6c61 7465 5f62 795f 696e 666f 2869  nslate_by_info(i
+000157c0: 6e66 6f3d 7472 616e 736c 6174 655f 696e  nfo=translate_in
+000157d0: 666f 290a 0a0a 6465 6620 636f 6e76 6572  fo)...def conver
+000157e0: 7428 0a20 2020 2073 7263 3a20 556e 696f  t(.    src: Unio
+000157f0: 6e5b 7374 722c 2022 6f73 2e50 6174 684c  n[str, "os.PathL
+00015800: 696b 655b 416e 795d 225d 2c0a 2020 2020  ike[Any]"],.    
+00015810: 6473 743a 2055 6e69 6f6e 5b73 7472 2c20  dst: Union[str, 
+00015820: 226f 732e 5061 7468 4c69 6b65 5b41 6e79  "os.PathLike[Any
+00015830: 5d22 5d2c 0a20 2020 2073 7263 5f6c 6179  ]"],.    src_lay
+00015840: 6572 3a20 4f70 7469 6f6e 616c 5b73 7472  er: Optional[str
+00015850: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 6473  ] = None,.    ds
+00015860: 745f 6c61 7965 723a 204f 7074 696f 6e61  t_layer: Optiona
+00015870: 6c5b 7374 725d 203d 204e 6f6e 652c 0a20  l[str] = None,. 
+00015880: 2020 2073 7263 5f63 7273 3a20 556e 696f     src_crs: Unio
+00015890: 6e5b 7374 722c 2069 6e74 2c20 4e6f 6e65  n[str, int, None
+000158a0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 6473  ] = None,.    ds
+000158b0: 745f 6372 733a 2055 6e69 6f6e 5b73 7472  t_crs: Union[str
+000158c0: 2c20 696e 742c 204e 6f6e 655d 203d 204e  , int, None] = N
+000158d0: 6f6e 652c 0a20 2020 2077 6865 7265 3a20  one,.    where: 
+000158e0: 4f70 7469 6f6e 616c 5b73 7472 5d20 3d20  Optional[str] = 
+000158f0: 4e6f 6e65 2c0a 2020 2020 7265 7072 6f6a  None,.    reproj
+00015900: 6563 743a 2062 6f6f 6c20 3d20 4661 6c73  ect: bool = Fals
+00015910: 652c 0a20 2020 2065 7870 6c6f 6465 636f  e,.    explodeco
+00015920: 6c6c 6563 7469 6f6e 733a 2062 6f6f 6c20  llections: bool 
+00015930: 3d20 4661 6c73 652c 0a20 2020 2066 6f72  = False,.    for
+00015940: 6365 5f6f 7574 7075 745f 6765 6f6d 6574  ce_output_geomet
+00015950: 7279 7479 7065 3a20 556e 696f 6e5b 4765  rytype: Union[Ge
+00015960: 6f6d 6574 7279 5479 7065 2c20 7374 722c  ometryType, str,
+00015970: 204e 6f6e 655d 203d 204e 6f6e 652c 0a20   None] = None,. 
+00015980: 2020 2063 7265 6174 655f 7370 6174 6961     create_spatia
+00015990: 6c5f 696e 6465 783a 204f 7074 696f 6e61  l_index: Optiona
+000159a0: 6c5b 626f 6f6c 5d20 3d20 4e6f 6e65 2c0a  l[bool] = None,.
+000159b0: 2020 2020 7072 6573 6572 7665 5f66 6964      preserve_fid
+000159c0: 3a20 4f70 7469 6f6e 616c 5b62 6f6f 6c5d  : Optional[bool]
+000159d0: 203d 204e 6f6e 652c 0a20 2020 206f 7074   = None,.    opt
+000159e0: 696f 6e73 3a20 6469 6374 203d 207b 7d2c  ions: dict = {},
+000159f0: 0a20 2020 2061 7070 656e 643a 2062 6f6f  .    append: boo
+00015a00: 6c20 3d20 4661 6c73 652c 0a20 2020 2066  l = False,.    f
+00015a10: 6f72 6365 3a20 626f 6f6c 203d 2046 616c  orce: bool = Fal
+00015a20: 7365 2c0a 293a 0a20 2020 2022 2222 0a20  se,.):.    """. 
+00015a30: 2020 2044 4550 5245 4341 5445 443a 2070     DEPRECATED: p
+00015a40: 6c65 6173 6520 7573 6520 636f 7079 5f6c  lease use copy_l
+00015a50: 6179 6572 2e0a 2020 2020 2222 220a 2020  ayer..    """.  
+00015a60: 2020 7761 726e 696e 6773 2e77 6172 6e28    warnings.warn(
+00015a70: 2263 6f6e 7665 7274 2069 7320 6465 7072  "convert is depr
+00015a80: 6563 6174 6564 3a20 7573 6520 636f 7079  ecated: use copy
+00015a90: 5f6c 6179 6572 2e22 2c20 4675 7475 7265  _layer.", Future
+00015aa0: 5761 726e 696e 672c 2073 7461 636b 6c65  Warning, stackle
+00015ab0: 7665 6c3d 3229 0a20 2020 2072 6574 7572  vel=2).    retur
+00015ac0: 6e20 636f 7079 5f6c 6179 6572 280a 2020  n copy_layer(.  
+00015ad0: 2020 2020 2020 7372 633d 7372 632c 0a20        src=src,. 
+00015ae0: 2020 2020 2020 2064 7374 3d64 7374 2c0a         dst=dst,.
+00015af0: 2020 2020 2020 2020 7372 635f 6c61 7965          src_laye
+00015b00: 723d 7372 635f 6c61 7965 722c 0a20 2020  r=src_layer,.   
+00015b10: 2020 2020 2064 7374 5f6c 6179 6572 3d64       dst_layer=d
+00015b20: 7374 5f6c 6179 6572 2c0a 2020 2020 2020  st_layer,.      
+00015b30: 2020 7372 635f 6372 733d 7372 635f 6372    src_crs=src_cr
+00015b40: 732c 0a20 2020 2020 2020 2064 7374 5f63  s,.        dst_c
+00015b50: 7273 3d64 7374 5f63 7273 2c0a 2020 2020  rs=dst_crs,.    
+00015b60: 2020 2020 7768 6572 653d 7768 6572 652c      where=where,
+00015b70: 0a20 2020 2020 2020 2072 6570 726f 6a65  .        reproje
+00015b80: 6374 3d72 6570 726f 6a65 6374 2c0a 2020  ct=reproject,.  
+00015b90: 2020 2020 2020 6578 706c 6f64 6563 6f6c        explodecol
+00015ba0: 6c65 6374 696f 6e73 3d65 7870 6c6f 6465  lections=explode
+00015bb0: 636f 6c6c 6563 7469 6f6e 732c 0a20 2020  collections,.   
+00015bc0: 2020 2020 2066 6f72 6365 5f6f 7574 7075       force_outpu
+00015bd0: 745f 6765 6f6d 6574 7279 7479 7065 3d66  t_geometrytype=f
+00015be0: 6f72 6365 5f6f 7574 7075 745f 6765 6f6d  orce_output_geom
+00015bf0: 6574 7279 7479 7065 2c0a 2020 2020 2020  etrytype,.      
+00015c00: 2020 6372 6561 7465 5f73 7061 7469 616c    create_spatial
+00015c10: 5f69 6e64 6578 3d63 7265 6174 655f 7370  _index=create_sp
+00015c20: 6174 6961 6c5f 696e 6465 782c 0a20 2020  atial_index,.   
+00015c30: 2020 2020 2070 7265 7365 7276 655f 6669       preserve_fi
+00015c40: 643d 7072 6573 6572 7665 5f66 6964 2c0a  d=preserve_fid,.
+00015c50: 2020 2020 2020 2020 6f70 7469 6f6e 733d          options=
+00015c60: 6f70 7469 6f6e 732c 0a20 2020 2020 2020  options,.       
+00015c70: 2061 7070 656e 643d 6170 7065 6e64 2c0a   append=append,.
+00015c80: 2020 2020 2020 2020 666f 7263 653d 666f          force=fo
+00015c90: 7263 652c 0a20 2020 2029 0a0a 0a64 6566  rce,.    )...def
+00015ca0: 2063 6f70 795f 6c61 7965 7228 0a20 2020   copy_layer(.   
+00015cb0: 2073 7263 3a20 556e 696f 6e5b 7374 722c   src: Union[str,
+00015cc0: 2022 6f73 2e50 6174 684c 696b 655b 416e   "os.PathLike[An
+00015cd0: 795d 225d 2c0a 2020 2020 6473 743a 2055  y]"],.    dst: U
+00015ce0: 6e69 6f6e 5b73 7472 2c20 226f 732e 5061  nion[str, "os.Pa
+00015cf0: 7468 4c69 6b65 5b41 6e79 5d22 5d2c 0a20  thLike[Any]"],. 
+00015d00: 2020 2073 7263 5f6c 6179 6572 3a20 4f70     src_layer: Op
+00015d10: 7469 6f6e 616c 5b73 7472 5d20 3d20 4e6f  tional[str] = No
+00015d20: 6e65 2c0a 2020 2020 6473 745f 6c61 7965  ne,.    dst_laye
+00015d30: 723a 204f 7074 696f 6e61 6c5b 7374 725d  r: Optional[str]
+00015d40: 203d 204e 6f6e 652c 0a20 2020 2073 7263   = None,.    src
+00015d50: 5f63 7273 3a20 556e 696f 6e5b 7374 722c  _crs: Union[str,
+00015d60: 2069 6e74 2c20 4e6f 6e65 5d20 3d20 4e6f   int, None] = No
+00015d70: 6e65 2c0a 2020 2020 6473 745f 6372 733a  ne,.    dst_crs:
+00015d80: 2055 6e69 6f6e 5b73 7472 2c20 696e 742c   Union[str, int,
+00015d90: 204e 6f6e 655d 203d 204e 6f6e 652c 0a20   None] = None,. 
+00015da0: 2020 2063 6f6c 756d 6e73 3a20 4f70 7469     columns: Opti
+00015db0: 6f6e 616c 5b49 7465 7261 626c 655b 7374  onal[Iterable[st
+00015dc0: 725d 5d20 3d20 4e6f 6e65 2c0a 2020 2020  r]] = None,.    
+00015dd0: 7768 6572 653a 204f 7074 696f 6e61 6c5b  where: Optional[
+00015de0: 7374 725d 203d 204e 6f6e 652c 0a20 2020  str] = None,.   
+00015df0: 2073 716c 5f73 746d 743a 204f 7074 696f   sql_stmt: Optio
+00015e00: 6e61 6c5b 7374 725d 203d 204e 6f6e 652c  nal[str] = None,
+00015e10: 0a20 2020 2073 716c 5f64 6961 6c65 6374  .    sql_dialect
+00015e20: 3a20 4f70 7469 6f6e 616c 5b4c 6974 6572  : Optional[Liter
+00015e30: 616c 5b22 5351 4c49 5445 222c 2022 4f47  al["SQLITE", "OG
+00015e40: 5253 514c 225d 5d20 3d20 4e6f 6e65 2c0a  RSQL"]] = None,.
+00015e50: 2020 2020 7265 7072 6f6a 6563 743a 2062      reproject: b
+00015e60: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
+00015e70: 2065 7870 6c6f 6465 636f 6c6c 6563 7469   explodecollecti
+00015e80: 6f6e 733a 2062 6f6f 6c20 3d20 4661 6c73  ons: bool = Fals
+00015e90: 652c 0a20 2020 2066 6f72 6365 5f6f 7574  e,.    force_out
+00015ea0: 7075 745f 6765 6f6d 6574 7279 7479 7065  put_geometrytype
+00015eb0: 3a20 556e 696f 6e5b 4765 6f6d 6574 7279  : Union[Geometry
+00015ec0: 5479 7065 2c20 7374 722c 204e 6f6e 655d  Type, str, None]
+00015ed0: 203d 204e 6f6e 652c 0a20 2020 2063 7265   = None,.    cre
+00015ee0: 6174 655f 7370 6174 6961 6c5f 696e 6465  ate_spatial_inde
+00015ef0: 783a 204f 7074 696f 6e61 6c5b 626f 6f6c  x: Optional[bool
+00015f00: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 7072  ] = None,.    pr
+00015f10: 6573 6572 7665 5f66 6964 3a20 4f70 7469  eserve_fid: Opti
+00015f20: 6f6e 616c 5b62 6f6f 6c5d 203d 204e 6f6e  onal[bool] = Non
+00015f30: 652c 0a20 2020 2064 7374 5f64 696d 656e  e,.    dst_dimen
+00015f40: 7369 6f6e 733a 204f 7074 696f 6e61 6c5b  sions: Optional[
+00015f50: 7374 725d 203d 204e 6f6e 652c 0a20 2020  str] = None,.   
+00015f60: 206f 7074 696f 6e73 3a20 6469 6374 203d   options: dict =
+00015f70: 207b 7d2c 0a20 2020 2061 7070 656e 643a   {},.    append:
+00015f80: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
+00015f90: 2020 2066 6f72 6365 3a20 626f 6f6c 203d     force: bool =
+00015fa0: 2046 616c 7365 2c0a 293a 0a20 2020 2022   False,.):.    "
+00015fb0: 2222 0a20 2020 2052 6561 6420 6120 6c61  "".    Read a la
+00015fc0: 7965 7220 6672 6f6d 2061 2073 6f75 7263  yer from a sourc
+00015fd0: 6520 6669 6c65 2061 6e64 2077 7269 7465  e file and write
+00015fe0: 2069 7420 746f 2061 206e 6577 2064 6573   it to a new des
+00015ff0: 7469 6e61 7469 6f6e 2066 696c 652e 0a0a  tination file...
+00016000: 2020 2020 5479 7069 6361 6c6c 7920 7573      Typically us
+00016010: 6564 2074 6f20 636f 6e76 6572 7420 6672  ed to convert fr
+00016020: 6f6d 206f 6e65 2066 696c 6566 6f72 6d61  om one fileforma
+00016030: 7420 746f 2061 6e6f 7468 6572 206f 7220  t to another or 
+00016040: 746f 2072 6570 726f 6a65 6374 2e0a 0a20  to reproject... 
+00016050: 2020 2054 6865 206f 7074 696f 6e73 2070     The options p
+00016060: 6172 616d 6574 6572 2063 616e 2062 6520  arameter can be 
+00016070: 7573 6564 2074 6f20 7061 7373 2061 6e79  used to pass any
+00016080: 2074 7970 6520 6f66 206f 7074 696f 6e73   type of options
+00016090: 2074 6f20 4744 414c 2069 6e0a 2020 2020   to GDAL in.    
+000160a0: 7468 6520 666f 6c6c 6f77 696e 6720 666f  the following fo
+000160b0: 726d 3a0a 2020 2020 2020 2020 7b20 223c  rm:.        { "<
+000160c0: 6f70 7469 6f6e 5f74 7970 653e 2e3c 6f70  option_type>.<op
+000160d0: 7469 6f6e 5f6e 616d 653e 223a 203c 6f70  tion_name>": <op
+000160e0: 7469 6f6e 5f76 616c 7565 3e20 7d0a 0a20  tion_value> }.. 
+000160f0: 2020 2054 6865 206f 7074 696f 6e20 7479     The option ty
+00016100: 7065 7320 6361 6e20 6265 2061 6e79 206f  pes can be any o
+00016110: 6620 7468 6520 666f 6c6c 6f77 696e 673a  f the following:
+00016120: 0a20 2020 2020 2020 202d 204c 4159 4552  .        - LAYER
+00016130: 5f43 5245 4154 494f 4e3a 206c 6179 6572  _CREATION: layer
+00016140: 2063 7265 6174 696f 6e20 6f70 7469 6f6e   creation option
+00016150: 2028 6c63 6f29 0a20 2020 2020 2020 202d   (lco).        -
+00016160: 2044 4154 4153 4554 5f43 5245 4154 494f   DATASET_CREATIO
+00016170: 4e3a 2064 6174 6173 6574 2063 7265 6174  N: dataset creat
+00016180: 696f 6e20 6f70 7469 6f6e 2028 6473 636f  ion option (dsco
+00016190: 290a 2020 2020 2020 2020 2d20 494e 5055  ).        - INPU
+000161a0: 545f 4f50 454e 3a20 696e 7075 7420 6461  T_OPEN: input da
+000161b0: 7461 7365 7420 6f70 656e 206f 7074 696f  taset open optio
+000161c0: 6e20 286f 6f29 0a20 2020 2020 2020 202d  n (oo).        -
+000161d0: 2044 4553 5449 4e41 5449 4f4e 5f4f 5045   DESTINATION_OPE
+000161e0: 4e3a 2064 6573 7469 6e61 7469 6f6e 2064  N: destination d
+000161f0: 6174 6173 6574 206f 7065 6e20 6f70 7469  ataset open opti
+00016200: 6f6e 2028 646f 6f29 0a20 2020 2020 2020  on (doo).       
+00016210: 202d 2043 4f4e 4649 473a 2063 6f6e 6669   - CONFIG: confi
+00016220: 6720 6f70 7469 6f6e 2028 636f 6e66 6967  g option (config
+00016230: 290a 0a20 2020 2054 6865 206f 7074 696f  )..    The optio
+00016240: 6e73 2063 616e 2062 6520 666f 756e 6420  ns can be found 
+00016250: 696e 2074 6865 207c 4744 414c 5f76 6563  in the |GDAL_vec
+00016260: 746f 725f 6472 6976 6572 5f64 6f63 756d  tor_driver_docum
+00016270: 656e 7461 7469 6f6e 7c2e 0a0a 2020 2020  entation|...    
+00016280: 4172 6773 3a0a 2020 2020 2020 2020 7372  Args:.        sr
+00016290: 6320 2850 6174 684c 696b 6529 3a20 5468  c (PathLike): Th
+000162a0: 6520 736f 7572 6365 2066 696c 6520 7061  e source file pa
+000162b0: 7468 2e0a 2020 2020 2020 2020 6473 7420  th..        dst 
+000162c0: 2850 6174 684c 696b 6529 3a20 5468 6520  (PathLike): The 
+000162d0: 6465 7374 696e 6174 696f 6e20 6669 6c65  destination file
+000162e0: 2070 6174 682e 0a20 2020 2020 2020 2073   path..        s
+000162f0: 7263 5f6c 6179 6572 2028 7374 722c 206f  rc_layer (str, o
+00016300: 7074 696f 6e61 6c29 3a20 5468 6520 736f  ptional): The so
+00016310: 7572 6365 206c 6179 6572 2e20 4966 204e  urce layer. If N
+00016320: 6f6e 6520 616e 6420 7468 6572 6520 6973  one and there is
+00016330: 206f 6e6c 790a 2020 2020 2020 2020 2020   only.          
+00016340: 2020 6f6e 6520 6c61 7965 7220 696e 2074    one layer in t
+00016350: 6865 2073 7263 2066 696c 652c 2074 6861  he src file, tha
+00016360: 7420 6c61 7965 7220 6973 2074 616b 656e  t layer is taken
+00016370: 2e20 4465 6661 756c 7473 2074 6f20 4e6f  . Defaults to No
+00016380: 6e65 2e0a 2020 2020 2020 2020 6473 745f  ne..        dst_
+00016390: 6c61 7965 7220 2873 7472 2c20 6f70 7469  layer (str, opti
+000163a0: 6f6e 616c 293a 2054 6865 2064 6573 7469  onal): The desti
+000163b0: 6e61 7469 6f6e 206c 6179 6572 2e20 4966  nation layer. If
+000163c0: 204e 6f6e 652c 2074 6865 2066 696c 650a   None, the file.
+000163d0: 2020 2020 2020 2020 2020 2020 7374 656d              stem
+000163e0: 2069 7320 7461 6b65 6e20 6173 206c 6179   is taken as lay
+000163f0: 6572 206e 616d 652e 2044 6566 6175 6c74  er name. Default
+00016400: 7320 746f 204e 6f6e 652e 0a20 2020 2020  s to None..     
+00016410: 2020 2073 7263 5f63 7273 2028 556e 696f     src_crs (Unio
+00016420: 6e5b 7374 722c 2069 6e74 5d2c 206f 7074  n[str, int], opt
+00016430: 696f 6e61 6c29 3a20 616e 2065 7073 6720  ional): an epsg 
+00016440: 696e 7420 6f72 2061 6e79 7468 696e 6720  int or anything 
+00016450: 7375 7070 6f72 7465 640a 2020 2020 2020  supported.      
+00016460: 2020 2020 2020 6279 2074 6865 204f 4752        by the OGR
+00016470: 5370 6174 6961 6c52 6566 6572 656e 6365  SpatialReference
+00016480: 2e53 6574 4672 6f6d 5573 6572 496e 7075  .SetFromUserInpu
+00016490: 7428 2920 6361 6c6c 2c20 7768 6963 6820  t() call, which 
+000164a0: 696e 636c 7564 6573 0a20 2020 2020 2020  includes.       
+000164b0: 2020 2020 2061 6e20 4550 5347 2073 7472       an EPSG str
+000164c0: 696e 6720 2865 672e 2022 4550 5347 3a34  ing (eg. "EPSG:4
+000164d0: 3332 3622 292c 2061 2077 656c 6c20 6b6e  326"), a well kn
+000164e0: 6f77 6e20 7465 7874 2028 574b 5429 2043  own text (WKT) C
+000164f0: 5253 0a20 2020 2020 2020 2020 2020 2064  RS.            d
+00016500: 6566 696e 6974 696f 6e2c 2e2e 2e20 4465  efinition,... De
+00016510: 6661 756c 7473 2074 6f20 4e6f 6e65 2e0a  faults to None..
+00016520: 2020 2020 2020 2020 6473 745f 6372 7320          dst_crs 
+00016530: 2855 6e69 6f6e 5b73 7472 2c20 696e 745d  (Union[str, int]
+00016540: 2c20 6f70 7469 6f6e 616c 293a 2061 6e20  , optional): an 
+00016550: 6570 7367 2069 6e74 206f 7220 616e 7974  epsg int or anyt
+00016560: 6869 6e67 2073 7570 706f 7274 6564 0a20  hing supported. 
+00016570: 2020 2020 2020 2020 2020 2062 7920 7468             by th
+00016580: 6520 4f47 5253 7061 7469 616c 5265 6665  e OGRSpatialRefe
+00016590: 7265 6e63 652e 5365 7446 726f 6d55 7365  rence.SetFromUse
+000165a0: 7249 6e70 7574 2829 2063 616c 6c2c 2077  rInput() call, w
+000165b0: 6869 6368 2069 6e63 6c75 6465 730a 2020  hich includes.  
+000165c0: 2020 2020 2020 2020 2020 616e 2045 5053            an EPS
+000165d0: 4720 7374 7269 6e67 2028 6567 2e20 2245  G string (eg. "E
+000165e0: 5053 473a 3433 3236 2229 2c20 6120 7765  PSG:4326"), a we
+000165f0: 6c6c 206b 6e6f 776e 2074 6578 7420 2857  ll known text (W
+00016600: 4b54 2920 4352 530a 2020 2020 2020 2020  KT) CRS.        
+00016610: 2020 2020 6465 6669 6e69 7469 6f6e 2c2e      definition,.
+00016620: 2e2e 2044 6566 6175 6c74 7320 746f 204e  .. Defaults to N
+00016630: 6f6e 652e 0a20 2020 2020 2020 2063 6f6c  one..        col
+00016640: 756d 6e73 2028 4974 6572 6162 6c65 5b73  umns (Iterable[s
+00016650: 7472 5d2c 206f 7074 696f 6e61 6c29 3a20  tr], optional): 
+00016660: 5468 6520 286e 6f6e 2d67 656f 6d65 7472  The (non-geometr
+00016670: 7929 2063 6f6c 756d 6e73 2074 6f20 7265  y) columns to re
+00016680: 6164 2077 696c 6c0a 2020 2020 2020 2020  ad will.        
+00016690: 2020 2020 6265 2072 6574 7572 6e65 6420      be returned 
+000166a0: 696e 2074 6865 206f 7264 6572 2073 7065  in the order spe
+000166b0: 6369 6669 6564 2e20 4966 204e 6f6e 652c  cified. If None,
+000166c0: 2061 6c6c 2073 7461 6e64 6172 6420 636f   all standard co
+000166d0: 6c75 6d6e 7320 6172 6520 7265 6164 2e0a  lumns are read..
+000166e0: 2020 2020 2020 2020 2020 2020 496e 2061              In a
+000166f0: 6464 6974 696f 6e20 746f 2073 7461 6e64  ddition to stand
+00016700: 6172 6420 636f 6c75 6d6e 732c 2069 7420  ard columns, it 
+00016710: 6973 2061 6c73 6f20 706f 7373 6962 6c65  is also possible
+00016720: 0a20 2020 2020 2020 2020 2020 2074 6f20  .            to 
+00016730: 7370 6563 6966 7920 2266 6964 222c 2061  specify "fid", a
+00016740: 2075 6e69 7175 6520 696e 6465 7820 6176   unique index av
+00016750: 6169 6c61 626c 6520 696e 2061 6c6c 2069  ailable in all i
+00016760: 6e70 7574 2066 696c 6573 2e20 4e6f 7465  nput files. Note
+00016770: 2074 6861 7420 7468 650a 2020 2020 2020   that the.      
+00016780: 2020 2020 2020 2266 6964 2220 7769 6c6c        "fid" will
+00016790: 2062 6520 616c 6961 7365 6420 6567 2e20   be aliased eg. 
+000167a0: 746f 2022 6669 645f 3122 2e20 4465 6661  to "fid_1". Defa
+000167b0: 756c 7473 2074 6f20 4e6f 6e65 2e0a 2020  ults to None..  
+000167c0: 2020 2020 2020 7768 6572 6520 2873 7472        where (str
+000167d0: 2c20 6f70 7469 6f6e 616c 293a 206f 6e6c  , optional): onl
+000167e0: 7920 6170 7065 6e64 2074 6865 2072 6f77  y append the row
+000167f0: 7320 6672 6f6d 2073 7263 2074 6861 7420  s from src that 
+00016800: 636f 6d70 6c79 2074 6f20 7468 6520 6669  comply to the fi
+00016810: 6c74 6572 0a20 2020 2020 2020 2020 2020  lter.           
+00016820: 2073 7065 6369 6669 6564 2e20 4170 706c   specified. Appl
+00016830: 6965 6420 6265 666f 7265 2060 6065 7870  ied before ``exp
+00016840: 6c6f 6465 636f 6c6c 6563 7469 6f6e 7360  lodecollections`
+00016850: 602e 2046 696c 7465 7220 7368 6f75 6c64  `. Filter should
+00016860: 2062 6520 696e 2073 716c 6974 650a 2020   be in sqlite.  
+00016870: 2020 2020 2020 2020 2020 5351 4c20 5748            SQL WH
+00016880: 4552 4520 7379 6e74 6178 2061 6e64 207c  ERE syntax and |
+00016890: 7370 6174 6961 6c69 7465 5f72 6566 6572  spatialite_refer
+000168a0: 656e 6365 5f6c 696e 6b7c 2066 756e 6374  ence_link| funct
+000168b0: 696f 6e73 2063 616e 2062 6520 7573 6564  ions can be used
+000168c0: 2e20 4966 0a20 2020 2020 2020 2020 2020  . If.           
+000168d0: 2077 6865 7265 2063 6f6e 7461 696e 7320   where contains 
+000168e0: 7468 6520 7b67 656f 6d65 7472 7963 6f6c  the {geometrycol
+000168f0: 756d 6e7d 2070 6c61 6365 686f 6c64 6572  umn} placeholder
+00016900: 2c20 6974 2069 7320 6669 6c6c 6564 206f  , it is filled o
+00016910: 7574 2077 6974 6820 7468 650a 2020 2020  ut with the.    
+00016920: 2020 2020 2020 2020 6765 6f6d 6574 7279          geometry
+00016930: 2063 6f6c 756d 6e20 6e61 6d65 206f 6620   column name of 
+00016940: 7468 6520 7372 6320 6669 6c65 2e20 4465  the src file. De
+00016950: 6661 756c 7473 2074 6f20 4e6f 6e65 2e0a  faults to None..
+00016960: 2020 2020 2020 2020 7371 6c5f 7374 6d74          sql_stmt
+00016970: 2028 7374 7229 3a20 5351 4c20 7374 6174   (str): SQL stat
+00016980: 656d 656e 7420 746f 2075 7365 2e20 4f6e  ement to use. On
+00016990: 6c79 2073 7570 706f 7274 6564 2077 6974  ly supported wit
+000169a0: 6820 2270 796f 6772 696f 2220 656e 6769  h "pyogrio" engi
+000169b0: 6e65 2e0a 2020 2020 2020 2020 7371 6c5f  ne..        sql_
+000169c0: 6469 616c 6563 7420 2873 7472 2c20 6f70  dialect (str, op
+000169d0: 7469 6f6e 616c 293a 2053 514c 2064 6961  tional): SQL dia
+000169e0: 6c65 6374 2075 7365 642e 204f 7074 696f  lect used. Optio
+000169f0: 6e73 2061 7265 204e 6f6e 652c 2022 5351  ns are None, "SQ
+00016a00: 4c49 5445 2220 6f72 0a20 2020 2020 2020  LITE" or.       
+00016a10: 2020 2020 2022 4f47 5253 514c 222e 2049       "OGRSQL". I
+00016a20: 6620 4e6f 6e65 2c20 666f 7220 6461 7461  f None, for data
+00016a30: 2073 6f75 7263 6573 2077 6974 6820 6578   sources with ex
+00016a40: 706c 6963 6974 2053 514c 2073 7570 706f  plicit SQL suppo
+00016a50: 7274 2074 6865 2073 7461 7465 6d65 6e74  rt the statement
+00016a60: 0a20 2020 2020 2020 2020 2020 2069 7320  .            is 
+00016a70: 7072 6f63 6573 7365 6420 6279 2074 6865  processed by the
+00016a80: 2064 6566 6175 6c74 2053 514c 2065 6e67   default SQL eng
+00016a90: 696e 6520 2865 2e67 2e20 666f 7220 4765  ine (e.g. for Ge
+00016aa0: 6f70 6163 6b61 6765 2061 6e64 2053 7061  opackage and Spa
+00016ab0: 7469 616c 6974 650a 2020 2020 2020 2020  tialite.        
+00016ac0: 2020 2020 7468 6973 2069 7320 2253 514c      this is "SQL
+00016ad0: 4954 4522 292e 2046 6f72 2064 6174 6120  ITE"). For data 
+00016ae0: 736f 7572 6365 7320 7769 7468 6f75 7420  sources without 
+00016af0: 6e61 7469 7665 2053 514c 2073 7570 706f  native SQL suppo
+00016b00: 7274 2028 652e 672e 202e 7368 7029 2c0a  rt (e.g. .shp),.
+00016b10: 2020 2020 2020 2020 2020 2020 7468 6520              the 
+00016b20: 224f 4752 5351 4c22 2064 6961 6c65 6374  "OGRSQL" dialect
+00016b30: 2069 7320 7468 6520 6465 6661 756c 742e   is the default.
+00016b40: 2049 6620 7468 6520 2253 514c 4954 4522   If the "SQLITE"
+00016b50: 2064 6961 6c65 6374 2069 7320 7370 6563   dialect is spec
+00016b60: 6966 6965 642c 0a20 2020 2020 2020 2020  ified,.         
+00016b70: 2020 207c 7370 6174 6961 6c69 7465 5f72     |spatialite_r
+00016b80: 6566 6572 656e 6365 5f6c 696e 6b7c 2066  eference_link| f
+00016b90: 756e 6374 696f 6e73 2063 616e 2061 6c73  unctions can als
+00016ba0: 6f20 6265 2075 7365 642e 2044 6566 6175  o be used. Defau
+00016bb0: 6c74 7320 746f 204e 6f6e 652e 0a20 2020  lts to None..   
+00016bc0: 2020 2020 2072 6570 726f 6a65 6374 2028       reproject (
+00016bd0: 626f 6f6c 2c20 6f70 7469 6f6e 616c 293a  bool, optional):
+00016be0: 2054 7275 6520 746f 2072 6570 726f 6a65   True to reproje
+00016bf0: 6374 2077 6869 6c65 2063 6f6e 7665 7274  ct while convert
+00016c00: 696e 6720 7468 650a 2020 2020 2020 2020  ing the.        
+00016c10: 2020 2020 6669 6c65 2e20 4465 6661 756c      file. Defaul
+00016c20: 7473 2074 6f20 4661 6c73 652e 0a20 2020  ts to False..   
+00016c30: 2020 2020 2065 7870 6c6f 6465 636f 6c6c       explodecoll
+00016c40: 6563 7469 6f6e 7320 2862 6f6f 6c2c 206f  ections (bool, o
+00016c50: 7074 696f 6e61 6c29 3a20 5472 7565 2074  ptional): True t
+00016c60: 6f20 6f75 7470 7574 206f 6e6c 7920 7369  o output only si
+00016c70: 6d70 6c65 0a20 2020 2020 2020 2020 2020  mple.           
+00016c80: 2067 656f 6d65 7472 6965 732e 2044 6566   geometries. Def
+00016c90: 6175 6c74 7320 746f 2046 616c 7365 2e0a  aults to False..
+00016ca0: 2020 2020 2020 2020 666f 7263 655f 6f75          force_ou
+00016cb0: 7470 7574 5f67 656f 6d65 7472 7974 7970  tput_geometrytyp
+00016cc0: 6520 2855 6e69 6f6e 5b47 656f 6d65 7472  e (Union[Geometr
+00016cd0: 7954 7970 652c 2073 7472 5d2c 206f 7074  yType, str], opt
+00016ce0: 696f 6e61 6c29 3a20 4765 6f6d 6574 7279  ional): Geometry
+00016cf0: 2074 7970 652e 0a20 2020 2020 2020 2020   type..         
+00016d00: 2020 2074 6f20 2874 7279 2074 6f29 2066     to (try to) f
+00016d10: 6f72 6365 2074 6865 206f 7574 7075 7420  orce the output 
+00016d20: 746f 2e20 4465 6661 756c 7473 2074 6f20  to. Defaults to 
+00016d30: 4e6f 6e65 2e0a 2020 2020 2020 2020 6372  None..        cr
+00016d40: 6561 7465 5f73 7061 7469 616c 5f69 6e64  eate_spatial_ind
+00016d50: 6578 2028 626f 6f6c 2c20 6f70 7469 6f6e  ex (bool, option
+00016d60: 616c 293a 2054 7275 6520 746f 2063 7265  al): True to cre
+00016d70: 6174 6520 6120 7370 6174 6961 6c20 696e  ate a spatial in
+00016d80: 6465 780a 2020 2020 2020 2020 2020 2020  dex.            
+00016d90: 6f6e 2074 6865 2064 6573 7469 6e61 7469  on the destinati
+00016da0: 6f6e 2066 696c 652f 6c61 7965 722e 2049  on file/layer. I
+00016db0: 6620 4e6f 6e65 2c20 7468 6520 6465 6661  f None, the defa
+00016dc0: 756c 7420 6265 6861 7669 6f75 7220 6279  ult behaviour by
+00016dd0: 2067 6461 6c20 666f 720a 2020 2020 2020   gdal for.      
+00016de0: 2020 2020 2020 7468 6174 2066 696c 6520        that file 
+00016df0: 7479 7065 2069 7320 7265 7370 6563 7465  type is respecte
+00016e00: 642e 2049 6620 7468 6520 4c41 5945 525f  d. If the LAYER_
+00016e10: 4352 4541 5449 4f4e 2e53 5041 5449 414c  CREATION.SPATIAL
+00016e20: 5f49 4e44 4558 0a20 2020 2020 2020 2020  _INDEX.         
+00016e30: 2020 2070 6172 616d 6574 6572 2069 7320     parameter is 
+00016e40: 7370 6563 6966 6965 6420 696e 206f 7074  specified in opt
+00016e50: 696f 6e73 2c20 6372 6561 7465 5f73 7061  ions, create_spa
+00016e60: 7469 616c 5f69 6e64 6578 2069 7320 6967  tial_index is ig
+00016e70: 6e6f 7265 642e 0a20 2020 2020 2020 2020  nored..         
+00016e80: 2020 2044 6566 6175 6c74 7320 746f 204e     Defaults to N
+00016e90: 6f6e 652e 0a20 2020 2020 2020 2070 7265  one..        pre
+00016ea0: 7365 7276 655f 6669 6420 2862 6f6f 6c2c  serve_fid (bool,
+00016eb0: 206f 7074 696f 6e61 6c29 3a20 5472 7565   optional): True
+00016ec0: 2074 6f20 6d61 6b65 2061 6e20 6578 7472   to make an extr
+00016ed0: 6120 6566 666f 7274 2074 6f20 7072 6573  a effort to pres
+00016ee0: 6572 7665 2066 6964 2773 206f 660a 2020  erve fid's of.  
+00016ef0: 2020 2020 2020 2020 2020 7468 6520 736f            the so
+00016f00: 7572 6365 206c 6179 6572 2074 6f20 7468  urce layer to th
+00016f10: 6520 6465 7374 696e 6174 696f 6e20 6c61  e destination la
+00016f20: 7965 722e 2046 616c 7365 206e 6f74 2074  yer. False not t
+00016f30: 6f20 646f 2061 6e79 2065 6666 6f72 742e  o do any effort.
+00016f40: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
+00016f50: 2020 746f 2075 7365 2074 6865 2064 6566    to use the def
+00016f60: 6175 6c74 2062 6568 6176 696f 7572 206f  ault behaviour o
+00016f70: 6620 6764 616c 2c20 7468 6174 2061 6c72  f gdal, that alr
+00016f80: 6561 6479 2070 7265 7365 7276 6573 2069  eady preserves i
+00016f90: 6e20 736f 6d65 2063 6173 6573 2e0a 2020  n some cases..  
+00016fa0: 2020 2020 2020 2020 2020 536f 6d65 2066            Some f
+00016fb0: 696c 6520 666f 726d 6174 7320 646f 6e27  ile formats don'
+00016fc0: 7420 6578 706c 6963 6974 6c79 2073 746f  t explicitly sto
+00016fd0: 7265 2074 6865 2066 6964 2028 652e 672e  re the fid (e.g.
+00016fe0: 2073 6861 7065 6669 6c65 292c 2073 6f20   shapefile), so 
+00016ff0: 7468 6579 0a20 2020 2020 2020 2020 2020  they.           
+00017000: 2077 696c 6c20 6e65 7665 7220 6265 2061   will never be a
+00017010: 626c 6520 746f 2070 7265 7365 7276 6520  ble to preserve 
+00017020: 6669 6473 2e20 4465 6661 756c 7473 2074  fids. Defaults t
+00017030: 6f20 4e6f 6e65 2e0a 2020 2020 2020 2020  o None..        
+00017040: 6473 745f 6469 6d65 6e73 696f 6e73 2028  dst_dimensions (
+00017050: 7374 722c 206f 7074 696f 6e61 6c29 3a20  str, optional): 
+00017060: 466f 7263 6520 7468 6520 6469 6d65 6e73  Force the dimens
+00017070: 696f 6e73 206f 6620 7468 6520 6465 7374  ions of the dest
+00017080: 696e 6174 696f 6e20 6c61 7965 7220 746f  ination layer to
+00017090: 0a20 2020 2020 2020 2020 2020 2074 6865  .            the
+000170a0: 2076 616c 7565 2073 7065 6369 6669 6564   value specified
+000170b0: 2e20 5661 6c69 6420 7661 6c75 6573 3a20  . Valid values: 
+000170c0: 2258 5922 2c20 2258 595a 222c 2022 5859  "XY", "XYZ", "XY
+000170d0: 4d22 206f 7220 2258 595a 4d22 2e0a 2020  M" or "XYZM"..  
+000170e0: 2020 2020 2020 2020 2020 4465 6661 756c            Defaul
+000170f0: 7473 2074 6f20 4e6f 6e65 2e0a 2020 2020  ts to None..    
+00017100: 2020 2020 6f70 7469 6f6e 7320 2864 6963      options (dic
+00017110: 742c 206f 7074 696f 6e61 6c29 3a20 6f70  t, optional): op
+00017120: 7469 6f6e 7320 746f 2070 6173 7320 746f  tions to pass to
+00017130: 2067 6461 6c2e 0a20 2020 2020 2020 2061   gdal..        a
+00017140: 7070 656e 6420 2862 6f6f 6c2c 206f 7074  ppend (bool, opt
+00017150: 696f 6e61 6c29 3a20 5472 7565 2074 6f20  ional): True to 
+00017160: 6170 7065 6e64 2074 6f20 7468 6520 6f75  append to the ou
+00017170: 7470 7574 2066 696c 6520 6966 2069 7420  tput file if it 
+00017180: 6578 6973 7473 2e0a 2020 2020 2020 2020  exists..        
+00017190: 2020 2020 4465 6661 756c 7473 2074 6f20      Defaults to 
+000171a0: 4661 6c73 652e 0a20 2020 2020 2020 2066  False..        f
+000171b0: 6f72 6365 2028 626f 6f6c 2c20 6f70 7469  orce (bool, opti
+000171c0: 6f6e 616c 293a 206f 7665 7277 7269 7465  onal): overwrite
+000171d0: 2065 7869 7374 696e 6720 6f75 7470 7574   existing output
+000171e0: 2066 696c 6528 7329 0a20 2020 2020 2020   file(s).       
+000171f0: 2020 2020 2044 6566 6175 6c74 7320 746f       Defaults to
+00017200: 2046 616c 7365 2e0a 0a20 2020 202e 2e20   False...    .. 
+00017210: 7c73 7061 7469 616c 6974 655f 7265 6665  |spatialite_refe
+00017220: 7265 6e63 655f 6c69 6e6b 7c20 7261 773a  rence_link| raw:
+00017230: 3a20 6874 6d6c 0a0a 2020 2020 2020 2020  : html..        
+00017240: 3c61 2068 7265 663d 2268 7474 7073 3a2f  <a href="https:/
+00017250: 2f77 7777 2e67 6169 612d 6769 732e 6974  /www.gaia-gis.it
+00017260: 2f67 6169 612d 7369 6e73 2f73 7061 7469  /gaia-sins/spati
+00017270: 616c 6974 652d 7371 6c2d 6c61 7465 7374  alite-sql-latest
+00017280: 2e68 746d 6c22 2074 6172 6765 743d 225f  .html" target="_
+00017290: 626c 616e 6b22 3e73 7061 7469 616c 6974  blank">spatialit
+000172a0: 6520 7265 6665 7265 6e63 653c 2f61 3e0a  e reference</a>.
+000172b0: 0a20 2020 202e 2e20 7c47 4441 4c5f 7665  .    .. |GDAL_ve
+000172c0: 6374 6f72 5f64 7269 7665 725f 646f 6375  ctor_driver_docu
+000172d0: 6d65 6e74 6174 696f 6e7c 2072 6177 3a3a  mentation| raw::
+000172e0: 2068 746d 6c0a 0a20 2020 2020 2020 203c   html..        <
+000172f0: 6120 6872 6566 3d22 6874 7470 733a 2f2f  a href="https://
+00017300: 6764 616c 2e6f 7267 2f64 7269 7665 7273  gdal.org/drivers
+00017310: 2f76 6563 746f 722f 696e 6465 782e 6874  /vector/index.ht
+00017320: 6d6c 2220 7461 7267 6574 3d22 5f62 6c61  ml" target="_bla
+00017330: 6e6b 223e 4744 414c 2076 6563 746f 7220  nk">GDAL vector 
+00017340: 6472 6976 6572 2064 6f63 756d 656e 7461  driver documenta
+00017350: 7469 6f6e 3c2f 613e 0a0a 2020 2020 2222  tion</a>..    ""
+00017360: 2220 2023 206e 6f71 613a 2045 3530 310a  "  # noqa: E501.
+00017370: 2020 2020 2320 496e 6974 0a20 2020 2073      # Init.    s
+00017380: 7263 203d 2050 6174 6828 7372 6329 0a20  rc = Path(src). 
+00017390: 2020 2064 7374 203d 2050 6174 6828 6473     dst = Path(ds
+000173a0: 7429 0a0a 2020 2020 2320 4966 2073 6f75  t)..    # If sou
+000173b0: 7263 6520 6669 6c65 2064 6f65 736e 2774  rce file doesn't
+000173c0: 2065 7869 7374 2c20 7261 6973 6520 6572   exist, raise er
+000173d0: 726f 720a 2020 2020 6966 206e 6f74 2073  ror.    if not s
+000173e0: 7263 2e65 7869 7374 7328 293a 0a20 2020  rc.exists():.   
+000173f0: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+00017400: 4572 726f 7228 6622 7372 6320 6669 6c65  Error(f"src file
+00017410: 2064 6f65 736e 2774 2065 7869 7374 3a20   doesn't exist: 
+00017420: 7b73 7263 7d22 290a 2020 2020 2320 4966  {src}").    # If
+00017430: 2064 6573 7420 6669 6c65 2065 7869 7374   dest file exist
+00017440: 7320 616c 7265 6164 7920 616e 6420 6e6f  s already and no
+00017450: 2061 7070 656e 640a 2020 2020 6966 206e   append.    if n
+00017460: 6f74 2061 7070 656e 6420 616e 6420 6473  ot append and ds
+00017470: 742e 6578 6973 7473 2829 3a0a 2020 2020  t.exists():.    
+00017480: 2020 2020 6966 2066 6f72 6365 2069 7320      if force is 
+00017490: 5472 7565 3a0a 2020 2020 2020 2020 2020  True:.          
+000174a0: 2020 7265 6d6f 7665 2864 7374 290a 2020    remove(dst).  
+000174b0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000174c0: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
+000174d0: 6e66 6f28 6622 4f75 7470 7574 2066 696c  nfo(f"Output fil
+000174e0: 6520 6578 6973 7473 2061 6c72 6561 6479  e exists already
+000174f0: 2c20 736f 2073 746f 703a 207b 6473 747d  , so stop: {dst}
+00017500: 2229 0a20 2020 2020 2020 2020 2020 2072  ").            r
+00017510: 6574 7572 6e0a 0a20 2020 2023 2043 6f6e  eturn..    # Con
+00017520: 7665 7274 0a20 2020 206c 6f67 6765 722e  vert.    logger.
+00017530: 696e 666f 2866 2243 6f70 7920 6c61 7965  info(f"Copy laye
+00017540: 7220 6672 6f6d 207b 7372 637d 2074 6f20  r from {src} to 
+00017550: 7b64 7374 7d22 290a 2020 2020 5f61 7070  {dst}").    _app
+00017560: 656e 645f 746f 5f6e 6f6c 6f63 6b28 0a20  end_to_nolock(. 
+00017570: 2020 2020 2020 2073 7263 2c0a 2020 2020         src,.    
+00017580: 2020 2020 6473 742c 0a20 2020 2020 2020      dst,.       
+00017590: 2073 7263 5f6c 6179 6572 2c0a 2020 2020   src_layer,.    
+000175a0: 2020 2020 6473 745f 6c61 7965 722c 0a20      dst_layer,. 
+000175b0: 2020 2020 2020 2073 7263 5f63 7273 3d73         src_crs=s
+000175c0: 7263 5f63 7273 2c0a 2020 2020 2020 2020  rc_crs,.        
+000175d0: 6473 745f 6372 733d 6473 745f 6372 732c  dst_crs=dst_crs,
+000175e0: 0a20 2020 2020 2020 2063 6f6c 756d 6e73  .        columns
+000175f0: 3d63 6f6c 756d 6e73 2c0a 2020 2020 2020  =columns,.      
+00017600: 2020 7768 6572 653d 7768 6572 652c 0a20    where=where,. 
+00017610: 2020 2020 2020 2073 716c 5f73 746d 743d         sql_stmt=
+00017620: 7371 6c5f 7374 6d74 2c0a 2020 2020 2020  sql_stmt,.      
+00017630: 2020 7371 6c5f 6469 616c 6563 743d 7371    sql_dialect=sq
+00017640: 6c5f 6469 616c 6563 742c 0a20 2020 2020  l_dialect,.     
+00017650: 2020 2072 6570 726f 6a65 6374 3d72 6570     reproject=rep
+00017660: 726f 6a65 6374 2c0a 2020 2020 2020 2020  roject,.        
+00017670: 6578 706c 6f64 6563 6f6c 6c65 6374 696f  explodecollectio
+00017680: 6e73 3d65 7870 6c6f 6465 636f 6c6c 6563  ns=explodecollec
+00017690: 7469 6f6e 732c 0a20 2020 2020 2020 2066  tions,.        f
+000176a0: 6f72 6365 5f6f 7574 7075 745f 6765 6f6d  orce_output_geom
+000176b0: 6574 7279 7479 7065 3d66 6f72 6365 5f6f  etrytype=force_o
+000176c0: 7574 7075 745f 6765 6f6d 6574 7279 7479  utput_geometryty
+000176d0: 7065 2c0a 2020 2020 2020 2020 6372 6561  pe,.        crea
+000176e0: 7465 5f73 7061 7469 616c 5f69 6e64 6578  te_spatial_index
+000176f0: 3d63 7265 6174 655f 7370 6174 6961 6c5f  =create_spatial_
+00017700: 696e 6465 782c 0a20 2020 2020 2020 2070  index,.        p
+00017710: 7265 7365 7276 655f 6669 643d 7072 6573  reserve_fid=pres
+00017720: 6572 7665 5f66 6964 2c0a 2020 2020 2020  erve_fid,.      
+00017730: 2020 6473 745f 6469 6d65 6e73 696f 6e73    dst_dimensions
+00017740: 3d64 7374 5f64 696d 656e 7369 6f6e 732c  =dst_dimensions,
+00017750: 0a20 2020 2020 2020 206f 7074 696f 6e73  .        options
+00017760: 3d6f 7074 696f 6e73 2c0a 2020 2020 290a  =options,.    ).
+00017770: 0a0a 6465 6620 5f6c 6175 6e64 6572 5f63  ..def _launder_c
+00017780: 6f6c 756d 6e5f 6e61 6d65 7328 636f 6c75  olumn_names(colu
+00017790: 6d6e 733a 2049 7465 7261 626c 6529 202d  mns: Iterable) -
+000177a0: 3e20 6c69 7374 5b74 7570 6c65 5b73 7472  > list[tuple[str
+000177b0: 2c20 7374 725d 5d3a 0a20 2020 2022 2222  , str]]:.    """
+000177c0: 0a20 2020 204c 6175 6e64 6572 7320 7468  .    Launders th
+000177d0: 6520 636f 6c75 6d6e 206e 616d 6573 2070  e column names p
+000177e0: 6173 7365 6420 746f 2063 6f6d 706c 7920  assed to comply 
+000177f0: 7769 7468 2073 6861 7065 6669 6c65 2072  with shapefile r
+00017800: 6573 7472 6963 7469 6f6e 732e 0a0a 2020  estrictions...  
+00017810: 2020 5261 7469 6f6e 616c 653a 206e 6f72    Rationale: nor
+00017820: 6d61 6c6c 7920 6764 616c 206c 6175 6e64  mally gdal laund
+00017830: 6572 7320 7468 656d 2069 6620 6e65 6564  ers them if need
+00017840: 6564 2c20 6275 7420 7768 656e 2079 6f75  ed, but when you
+00017850: 2061 7070 656e 640a 2020 2020 6d75 6c74   append.    mult
+00017860: 6970 6c65 2066 696c 6573 2074 6f20 6120  iple files to a 
+00017870: 7368 6170 6566 696c 6520 7769 7468 2063  shapefile with c
+00017880: 6f6c 756d 6e73 2074 6861 7420 6e65 6564  olumns that need
+00017890: 2074 6f20 6265 206c 6175 6e64 6572 6564   to be laundered
+000178a0: 0a20 2020 2074 6865 7920 6172 6520 6e6f  .    they are no
+000178b0: 7420 6d61 7463 6865 6420 616e 6420 736f  t matched and so
+000178c0: 2061 7265 2061 7070 656e 6465 6420 7769   are appended wi
+000178d0: 7468 204e 554c 4c20 7661 6c75 6573 2066  th NULL values f
+000178e0: 6f72 2074 6865 7365 0a20 2020 2063 6f6c  or these.    col
+000178f0: 756d 6e73 2e20 4e6f 726d 616c 6c79 2074  umns. Normally t
+00017900: 6865 202d 7265 6c61 7865 6446 6965 6c64  he -relaxedField
+00017910: 4e61 6d65 4d61 7463 6820 7061 7261 6d65  NameMatch parame
+00017920: 7465 7220 696e 206f 6772 326f 6772 0a20  ter in ogr2ogr. 
+00017930: 2020 2073 686f 756c 6420 6669 7820 7468     should fix th
+00017940: 6973 2c20 6275 7420 6974 2073 6565 6d73  is, but it seems
+00017950: 2074 6861 7420 7468 6973 2069 736e 2774   that this isn't
+00017960: 2073 7570 706f 7274 6564 2066 6f72 2073   supported for s
+00017970: 6861 7065 6669 6c65 732e 0a0a 2020 2020  hapefiles...    
+00017980: 4c61 756e 6465 7269 6e67 2069 7320 6261  Laundering is ba
+00017990: 7365 6420 6f6e 2074 6869 7320 7465 7874  sed on this text
+000179a0: 2066 726f 6d20 7468 6520 6764 616c 2073   from the gdal s
+000179b0: 6861 7065 6669 6c65 2064 7269 7665 720a  hapefile driver.
+000179c0: 2020 2020 646f 6375 6d65 6e74 6174 696f      documentatio
+000179d0: 6e3a 0a0a 2020 2020 5368 6170 6566 696c  n:..    Shapefil
+000179e0: 6520 6665 6174 7572 6520 6174 7472 6962  e feature attrib
+000179f0: 7574 6573 2061 7265 2073 746f 7265 6420  utes are stored 
+00017a00: 696e 2061 6e20 6173 736f 6369 6174 6564  in an associated
+00017a10: 202e 6462 6620 6669 6c65 2c20 616e 640a   .dbf file, and.
+00017a20: 2020 2020 736f 2061 7474 7269 6275 7465      so attribute
+00017a30: 7320 7375 6666 6572 2061 206e 756d 6265  s suffer a numbe
+00017a40: 7220 6f66 206c 696d 6974 6174 696f 6e73  r of limitations
+00017a50: 3a0a 2020 2020 2d20 2020 4174 7472 6962  :.    -   Attrib
+00017a60: 7574 6520 6e61 6d65 7320 6361 6e20 6f6e  ute names can on
+00017a70: 6c79 2062 6520 7570 2074 6f20 3130 2063  ly be up to 10 c
+00017a80: 6861 7261 6374 6572 7320 6c6f 6e67 2e0a  haracters long..
+00017a90: 2020 2020 2020 2020 5468 6520 4f47 5220          The OGR 
+00017aa0: 5368 6170 6566 696c 6520 6472 6976 6572  Shapefile driver
+00017ab0: 2074 7269 6573 2074 6f20 6765 6e65 7261   tries to genera
+00017ac0: 7465 2075 6e69 7175 6520 6669 656c 640a  te unique field.
+00017ad0: 2020 2020 2020 2020 6e61 6d65 732e 2053          names. S
+00017ae0: 7563 6365 7373 6976 6520 6475 706c 6963  uccessive duplic
+00017af0: 6174 6520 6669 656c 6420 6e61 6d65 732c  ate field names,
+00017b00: 2069 6e63 6c75 6469 6e67 2074 686f 7365   including those
+00017b10: 2063 7265 6174 6564 2062 790a 2020 2020   created by.    
+00017b20: 2020 2020 7472 756e 6361 7469 6f6e 2074      truncation t
+00017b30: 6f20 3130 2063 6861 7261 6374 6572 732c  o 10 characters,
+00017b40: 2077 696c 6c20 6265 2074 7275 6e63 6174   will be truncat
+00017b50: 6564 2074 6f20 3820 6368 6172 6163 7465  ed to 8 characte
+00017b60: 7273 2061 6e64 0a20 2020 2020 2020 2061  rs and.        a
+00017b70: 7070 656e 6465 6420 7769 7468 2061 2073  ppended with a s
+00017b80: 6572 6961 6c20 6e75 6d62 6572 2066 726f  erial number fro
+00017b90: 6d20 3120 746f 2039 392e 0a0a 2020 2020  m 1 to 99...    
+00017ba0: 2020 2020 466f 7220 6578 616d 706c 653a      For example:
+00017bb0: 0a0a 2020 2020 2020 2020 2d20 2061 20e2  ..        -  a .
+00017bc0: 8692 2061 2c20 6120 e286 9220 615f 312c  .. a, a ... a_1,
+00017bd0: 2041 20e2 8692 2041 5f32 3b0a 2020 2020   A ... A_2;.    
+00017be0: 2020 2020 2d20 2061 6263 6465 6667 6869      -  abcdefghi
+00017bf0: 6a6b 20e2 8692 2061 6263 6465 6667 6869  jk ... abcdefghi
+00017c00: 6a2c 2061 6263 6465 6667 6869 6a6b 6c20  j, abcdefghijkl 
+00017c10: e286 9220 6162 6364 6566 6768 5f31 0a0a  ... abcdefgh_1..
+00017c20: 2020 2020 2d20 2020 4f6e 6c79 2049 6e74      -   Only Int
+00017c30: 6567 6572 2c20 496e 7465 6765 7236 342c  eger, Integer64,
+00017c40: 2052 6561 6c2c 2053 7472 696e 6720 616e   Real, String an
+00017c50: 6420 4461 7465 2028 6e6f 7420 4461 7465  d Date (not Date
+00017c60: 5469 6d65 2c20 6a75 7374 0a20 2020 2020  Time, just.     
+00017c70: 2020 2079 6561 722f 6d6f 6e74 682f 6461     year/month/da
+00017c80: 7929 2066 6965 6c64 2074 7970 6573 2061  y) field types a
+00017c90: 7265 2073 7570 706f 7274 6564 2e20 5468  re supported. Th
+00017ca0: 6520 7661 7269 6f75 7320 6c69 7374 2c20  e various list, 
+00017cb0: 616e 640a 2020 2020 2020 2020 6269 6e61  and.        bina
+00017cc0: 7279 2066 6965 6c64 2074 7970 6573 2063  ry field types c
+00017cd0: 616e 6e6f 7420 6265 2063 7265 6174 6564  annot be created
+00017ce0: 2e0a 2020 2020 2d20 2020 5468 6520 6669  ..    -   The fi
+00017cf0: 656c 6420 7769 6474 6820 616e 6420 7072  eld width and pr
+00017d00: 6563 6973 696f 6e20 6172 6520 6469 7265  ecision are dire
+00017d10: 6374 6c79 2075 7365 6420 746f 2065 7374  ctly used to est
+00017d20: 6162 6c69 7368 2073 746f 7261 6765 0a20  ablish storage. 
+00017d30: 2020 2020 2020 2073 697a 6520 696e 2074         size in t
+00017d40: 6865 202e 6462 6620 6669 6c65 2e20 5468  he .dbf file. Th
+00017d50: 6973 206d 6561 6e73 2074 6861 7420 7374  is means that st
+00017d60: 7269 6e67 7320 6c6f 6e67 6572 2074 6861  rings longer tha
+00017d70: 6e20 7468 6520 6669 656c 640a 2020 2020  n the field.    
+00017d80: 2020 2020 7769 6474 682c 206f 7220 6e75      width, or nu
+00017d90: 6d62 6572 7320 7468 6174 2064 6f6e 2774  mbers that don't
+00017da0: 2066 6974 2069 6e74 6f20 7468 6520 696e   fit into the in
+00017db0: 6469 6361 7465 6420 6669 656c 6420 666f  dicated field fo
+00017dc0: 726d 6174 2077 696c 6c0a 2020 2020 2020  rmat will.      
+00017dd0: 2020 7375 6666 6572 2074 7275 6e63 6174    suffer truncat
+00017de0: 696f 6e2e 0a20 2020 202d 2020 2049 6e74  ion..    -   Int
+00017df0: 6567 6572 2066 6965 6c64 7320 7769 7468  eger fields with
+00017e00: 6f75 7420 616e 2065 7870 6c69 6369 7420  out an explicit 
+00017e10: 7769 6474 6820 6172 6520 7472 6561 7465  width are treate
+00017e20: 6420 6173 2077 6964 7468 2039 2c20 616e  d as width 9, an
+00017e30: 640a 2020 2020 2020 2020 6578 7465 6e64  d.        extend
+00017e40: 6564 2074 6f20 3130 206f 7220 3131 2069  ed to 10 or 11 i
+00017e50: 6620 6e65 6564 6564 2e0a 2020 2020 2d20  f needed..    - 
+00017e60: 2020 496e 7465 6765 7236 3420 6669 656c    Integer64 fiel
+00017e70: 6473 2077 6974 686f 7574 2061 6e20 6578  ds without an ex
+00017e80: 706c 6963 6974 2077 6964 7468 2061 7265  plicit width are
+00017e90: 2074 7265 6174 6564 2061 7320 7769 6474   treated as widt
+00017ea0: 6820 3138 2c0a 2020 2020 2020 2020 616e  h 18,.        an
+00017eb0: 6420 6578 7465 6e64 6564 2074 6f20 3139  d extended to 19
+00017ec0: 206f 7220 3230 2069 6620 6e65 6564 6564   or 20 if needed
+00017ed0: 2e0a 2020 2020 2d20 2020 5265 616c 2028  ..    -   Real (
+00017ee0: 666c 6f61 7469 6e67 2070 6f69 6e74 2920  floating point) 
+00017ef0: 6669 656c 6473 2077 6974 686f 7574 2061  fields without a
+00017f00: 6e20 6578 706c 6963 6974 2077 6964 7468  n explicit width
+00017f10: 2061 7265 2074 7265 6174 6564 2061 730a   are treated as.
+00017f20: 2020 2020 2020 2020 7769 6474 6820 3234          width 24
+00017f30: 2077 6974 6820 3135 2064 6563 696d 616c   with 15 decimal
+00017f40: 2070 6c61 6365 7320 6f66 2070 7265 6369   places of preci
+00017f50: 7369 6f6e 2e0a 2020 2020 2d20 2020 5374  sion..    -   St
+00017f60: 7269 6e67 2066 6965 6c64 7320 7769 7468  ring fields with
+00017f70: 6f75 7420 616e 2061 7373 6967 6e65 6420  out an assigned 
+00017f80: 7769 6474 6820 6172 6520 7472 6561 7465  width are treate
+00017f90: 6420 6173 2038 3020 6368 6172 6163 7465  d as 80 characte
+00017fa0: 7273 2e0a 0a20 2020 2041 7267 733a 0a20  rs...    Args:. 
+00017fb0: 2020 2020 2020 2063 6f6c 756d 6e73 2028         columns (
+00017fc0: 4974 6572 6162 6c65 293a 2074 6865 2063  Iterable): the c
+00017fd0: 6f6c 756d 6e73 2074 6f20 6c61 756e 6465  olumns to launde
+00017fe0: 722e 0a0a 2020 2020 5265 7475 726e 733a  r...    Returns:
+00017ff0: 2061 204c 6973 7420 6f66 2074 7570 706c   a List of tuppl
+00018000: 6573 2077 6974 6820 7468 6520 6f72 6967  es with the orig
+00018010: 696e 616c 2061 6e64 206c 6175 6e64 6572  inal and launder
+00018020: 6564 2063 6f6c 756d 6e20 6e61 6d65 732e  ed column names.
+00018030: 0a20 2020 2022 2222 0a20 2020 206c 6175  .    """.    lau
+00018040: 6e64 6572 6564 203d 205b 5d0a 2020 2020  ndered = [].    
+00018050: 6c61 756e 6465 7265 645f 7570 7065 7220  laundered_upper 
+00018060: 3d20 5b5d 0a20 2020 2066 6f72 2063 6f6c  = [].    for col
+00018070: 756d 6e20 696e 2063 6f6c 756d 6e73 3a0a  umn in columns:.
+00018080: 2020 2020 2020 2020 2320 446f 7562 6c65          # Double
+00018090: 7320 696e 2063 6173 696e 6720 6172 6565  s in casing aree
+000180a0: 206e 6f74 2061 6c6c 6f77 6564 2065 6974   not allowed eit
+000180b0: 6865 720a 2020 2020 2020 2020 6966 206c  her.        if l
+000180c0: 656e 2863 6f6c 756d 6e29 203c 3d20 3130  en(column) <= 10
+000180d0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+000180e0: 2063 6f6c 756d 6e2e 7570 7065 7228 2920   column.upper() 
+000180f0: 6e6f 7420 696e 206c 6175 6e64 6572 6564  not in laundered
+00018100: 5f75 7070 6572 3a0a 2020 2020 2020 2020  _upper:.        
+00018110: 2020 2020 2020 2020 6c61 756e 6465 7265          laundere
+00018120: 645f 7570 7065 722e 6170 7065 6e64 2863  d_upper.append(c
+00018130: 6f6c 756d 6e2e 7570 7065 7228 2929 0a20  olumn.upper()). 
+00018140: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00018150: 6175 6e64 6572 6564 2e61 7070 656e 6428  aundered.append(
+00018160: 2863 6f6c 756d 6e2c 2063 6f6c 756d 6e29  (column, column)
+00018170: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00018180: 2020 636f 6e74 696e 7565 0a0a 2020 2020    continue..    
+00018190: 2020 2020 2320 4c61 756e 6465 7269 6e67      # Laundering
+000181a0: 2069 7320 6e65 6564 6564 0a20 2020 2020   is needed.     
+000181b0: 2020 2063 6f6c 756d 6e5f 6c61 756e 6465     column_launde
+000181c0: 7265 6420 3d20 636f 6c75 6d6e 5b3a 3130  red = column[:10
+000181d0: 5d0a 2020 2020 2020 2020 6966 2063 6f6c  ].        if col
+000181e0: 756d 6e5f 6c61 756e 6465 7265 642e 7570  umn_laundered.up
+000181f0: 7065 7228 2920 6e6f 7420 696e 206c 6175  per() not in lau
+00018200: 6e64 6572 6564 5f75 7070 6572 3a0a 2020  ndered_upper:.  
+00018210: 2020 2020 2020 2020 2020 6c61 756e 6465            launde
+00018220: 7265 645f 7570 7065 722e 6170 7065 6e64  red_upper.append
+00018230: 2863 6f6c 756d 6e5f 6c61 756e 6465 7265  (column_laundere
+00018240: 642e 7570 7065 7228 2929 0a20 2020 2020  d.upper()).     
+00018250: 2020 2020 2020 206c 6175 6e64 6572 6564         laundered
+00018260: 2e61 7070 656e 6428 2863 6f6c 756d 6e2c  .append((column,
+00018270: 2063 6f6c 756d 6e5f 6c61 756e 6465 7265   column_laundere
+00018280: 6429 290a 2020 2020 2020 2020 656c 7365  d)).        else
+00018290: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+000182a0: 4a75 7374 2074 616b 696e 6720 6669 7273  Just taking firs
+000182b0: 7420 3130 2063 6861 7261 6374 6572 7320  t 10 characters 
+000182c0: 6469 646e 2774 2068 656c 700a 2020 2020  didn't help.    
+000182d0: 2020 2020 2020 2020 666f 7220 696e 6465          for inde
+000182e0: 7820 696e 2072 616e 6765 2831 2c20 3130  x in range(1, 10
+000182f0: 3129 3a0a 2020 2020 2020 2020 2020 2020  1):.            
+00018300: 2020 2020 6966 2069 6e64 6578 203e 3d20      if index >= 
+00018310: 3130 303a 0a20 2020 2020 2020 2020 2020  100:.           
+00018320: 2020 2020 2020 2020 2072 6169 7365 204e           raise N
+00018330: 6f74 496d 706c 656d 656e 7465 6445 7272  otImplementedErr
+00018340: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+00018350: 2020 2020 2020 2020 2020 2020 224e 6f74              "Not
+00018360: 2073 7570 706f 7274 6564 2074 6f20 6c61   supported to la
+00018370: 756e 6465 7220 3e20 3939 2063 6f6c 756d  under > 99 colum
+00018380: 6e73 2073 7461 7274 696e 6720 220a 2020  ns starting ".  
+00018390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000183a0: 2020 2020 2020 6622 7769 7468 207b 636f        f"with {co
+000183b0: 6c75 6d6e 5f6c 6175 6e64 6572 6564 5b3a  lumn_laundered[:
+000183c0: 385d 7d22 0a20 2020 2020 2020 2020 2020  8]}".           
+000183d0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+000183e0: 2020 2020 2020 2020 2020 2069 6620 696e             if in
+000183f0: 6465 7820 3c3d 2039 3a0a 2020 2020 2020  dex <= 9:.      
+00018400: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00018410: 6c75 6d6e 5f6c 6175 6e64 6572 6564 203d  lumn_laundered =
+00018420: 2066 227b 636f 6c75 6d6e 5f6c 6175 6e64   f"{column_laund
+00018430: 6572 6564 5b3a 385d 7d5f 7b69 6e64 6578  ered[:8]}_{index
+00018440: 7d22 0a20 2020 2020 2020 2020 2020 2020  }".             
+00018450: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00018460: 2020 2020 2020 2020 2020 2020 2063 6f6c               col
+00018470: 756d 6e5f 6c61 756e 6465 7265 6420 3d20  umn_laundered = 
+00018480: 6622 7b63 6f6c 756d 6e5f 6c61 756e 6465  f"{column_launde
+00018490: 7265 645b 3a38 5d7d 7b69 6e64 6578 7d22  red[:8]}{index}"
+000184a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000184b0: 2069 6620 636f 6c75 6d6e 5f6c 6175 6e64   if column_laund
+000184c0: 6572 6564 2e75 7070 6572 2829 206e 6f74  ered.upper() not
+000184d0: 2069 6e20 6c61 756e 6465 7265 645f 7570   in laundered_up
+000184e0: 7065 723a 0a20 2020 2020 2020 2020 2020  per:.           
+000184f0: 2020 2020 2020 2020 206c 6175 6e64 6572           launder
+00018500: 6564 5f75 7070 6572 2e61 7070 656e 6428  ed_upper.append(
+00018510: 636f 6c75 6d6e 5f6c 6175 6e64 6572 6564  column_laundered
+00018520: 2e75 7070 6572 2829 290a 2020 2020 2020  .upper()).      
+00018530: 2020 2020 2020 2020 2020 2020 2020 6c61                la
+00018540: 756e 6465 7265 642e 6170 7065 6e64 2828  undered.append((
+00018550: 636f 6c75 6d6e 2c20 636f 6c75 6d6e 5f6c  column, column_l
+00018560: 6175 6e64 6572 6564 2929 0a20 2020 2020  aundered)).     
+00018570: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+00018580: 7265 616b 0a0a 2020 2020 7265 7475 726e  reak..    return
+00018590: 206c 6175 6e64 6572 6564 0a               laundered.
```

### Comparing `geofileops-0.8.2/geofileops/geoops.py` & `geofileops-0.9.0/geofileops/geoops.py`

 * *Files 3% similar despite different names*

```diff
@@ -1,29 +1,32 @@
 """
 Module exposing all supported operations on geometries in geofiles.
 """
 
-from datetime import datetime
 import logging
 import logging.config
-from pathlib import Path
 import shutil
-from typing import Any, Callable, List, Literal, Optional, Tuple, Union, TYPE_CHECKING
 import warnings
+from datetime import datetime
+from pathlib import Path
+from typing import TYPE_CHECKING, Any, Callable, Literal, Optional, Union
 
 from pygeoops import GeometryType
 
-from geofileops._compat import SPATIALITE_GTE_51
 from geofileops import fileops
-from geofileops.util import _geofileinfo
-from geofileops.util import _geoops_gpd
-from geofileops.util import _geoops_sql
-from geofileops.util import _geoops_ogr
-from geofileops.util import _io_util
-from geofileops.util import _sqlite_util
+from geofileops._compat import SPATIALITE_GTE_51
+from geofileops.helpers._configoptions_helper import ConfigOptions
+from geofileops.util import (
+    _geofileinfo,
+    _geoops_gpd,
+    _geoops_ogr,
+    _geoops_sql,
+    _io_util,
+    _sqlite_util,
+)
 from geofileops.util._geometry_util import (
     BufferEndCapStyle,
     BufferJoinStyle,
     SimplifyAlgorithm,
 )
 
 if TYPE_CHECKING:
@@ -92,156 +95,184 @@
     """
     input_path = Path(input_path)
     output_path = Path(output_path)
 
     start_time = datetime.now()
     operation_name = "dissolve_within_distance"
     logger = logging.getLogger(f"geofileops.{operation_name}")
-    nb_steps = 4
-    if not close_internal_gaps:
-        # 3 extra steps if boundary gaps not to be closed.
-        nb_steps += 3
+    nb_steps = 9
 
     # Already check here if it is useful to continue
-    if output_path.exists():
-        if force is False:
-            logger.info(f"Stop, output exists already {output_path}")
-            return
-        else:
-            fileops.remove(output_path)
+    if _io_util.output_exists(path=output_path, remove_if_exists=force):
+        return
 
     tempdir = _io_util.create_tempdir(f"geofileops/{operation_name}")
     try:
         # First dissolve the input.
         #
         # Note: this reduces the complexity of operations to be executed later on.
         # Note2: this already applies the gridsize, which needs to be applied anyway to
         # avoid issues when determining the addedpieces_1neighbour later on.
+        # Note2: don' apply gridsize yet
         logger.info(f"Start, with input file {input_path}")
         step = 1
         logger.info(f"Step {step} of {nb_steps}")
         diss_path = tempdir / "100_diss.gpkg"
         _geoops_gpd.dissolve(
             input_path=input_path,
             output_path=diss_path,
             explodecollections=True,
             input_layer=input_layer,
-            gridsize=gridsize,
+            gridsize=0.0,
             nb_parallel=nb_parallel,
             batchsize=batchsize,
             operation_prefix=f"{operation_name}-",
         )
 
         # Positive buffer of distance / 2 to close all gaps.
         #
-        # Note: gridsize is not applied to preserve all possible accuracy for these
+        # Note: no gridsize is applied to preserve all possible accuracy for these
         # temporary boundaries, otherwise the polygons are sometimes enlarged slightly,
         # which isn't wanted + creates issues when determining the
         # addedpieces_1neighbour later on.
         step += 1
         logger.info(f"Step {step} of {nb_steps}")
-        buff_path = tempdir / "110_diss_bufp.gpkg"
+        bufp_path = tempdir / "110_diss_bufp.gpkg"
         _geoops_gpd.buffer(
             input_path=diss_path,
-            output_path=buff_path,
+            output_path=bufp_path,
             distance=distance / 2,
             endcap_style=BufferEndCapStyle.SQUARE,
             join_style=BufferJoinStyle.MITRE,
             mitre_limit=1.25,
-            # gridsize=gridsize,
+            gridsize=0.0,
             nb_parallel=nb_parallel,
             batchsize=batchsize,
             operation_prefix=f"{operation_name}-",
         )
 
-        # Dissolve the buffered input
+        # Dissolve the buffered input.
         #
-        # Note: gridsize is not applied to preserve all possible accuracy for these
+        # Note: no gridsize is applied to preserve all possible accuracy for these
         # temporary boundaries, otherwise the polygons are sometimes enlarged slightly,
         # which isn't wanted + creates issues when determining the
         # addedpieces_1neighbour later on.
         step += 1
         logger.info(f"Step {step} of {nb_steps}")
         buff_diss_path = tempdir / "120_diss_bufp_diss.gpkg"
         _geoops_gpd.dissolve(
-            input_path=buff_path,
+            input_path=bufp_path,
             output_path=buff_diss_path,
             explodecollections=True,
-            # gridsize=gridsize,
+            gridsize=0.0,
             nb_parallel=nb_parallel,
             batchsize=batchsize,
             operation_prefix=f"{operation_name}-",
         )
 
         # Negative buffer to get back to the borders of the input geometries
         # Use a larger mitre limit, otherwise there are a lot of small triangles that
         # don't dissappear again.
         step += 1
         logger.info(f"Step {step} of {nb_steps}")
-        buff_diss_bufm_path = tempdir / "130_diss_bufp_diss_bufm.gpkg"
+        bufp_diss_bufm_path = tempdir / "130_diss_bufp_diss_bufm.gpkg"
         _geoops_gpd.buffer(
             input_path=buff_diss_path,
-            output_path=buff_diss_bufm_path,
+            output_path=bufp_diss_bufm_path,
             distance=-(distance / 2),
             endcap_style=BufferEndCapStyle.SQUARE,
             join_style=BufferJoinStyle.MITRE,
             mitre_limit=2,
-            gridsize=gridsize,
+            explodecollections=True,
+            gridsize=0.0,
             nb_parallel=nb_parallel,
             batchsize=batchsize,
             operation_prefix=f"{operation_name}-",
         )
 
-        # Determine which parts that were added were actually gaps within 'distance' in
-        # the original polygons, so they can be removed again.
-
-        # Determine all pieces added to the input in the process above.
-        step += 1
+        # We want to keep the original boundaries as identical as possible. However,
+        # when the same positive and negative buffer is applied on a polygon, even if no
+        # dissolve is happening with neighbouring polygons, the result won't be exactly
+        # the same as the input. Small differences will appear, e.g.:
+        #   - with a "standard" buffer, internal corners will be rounded afterwards
+        #   - with a "mitre" buffer the internal corners will in many cases stay the
+        #     same, but for external corners where the mitre kicks in, the boundaries of
+        #     the result will move slightly so the end result is smaller.
+        #
+        # To minimize changes to original boundaries, determine which parts are actually
+        # gaps "within distance" between original features that need to be filled. Then,
+        # those features can be added and dissolved into the original polygons.
+        # Note: no gridsize is applied to preserve all possible accuracy for these
+        # temporary boundariesstep += 1
         logger.info(f"Step {step} of {nb_steps}")
-        added_pieces_path = tempdir / "200_addedpieces.gpkg"
+        parts_to_add_path = tempdir / "200_parts_to_add.gpkg"
         _geoops_sql.erase(
-            input_path=buff_diss_bufm_path,
+            input_path=bufp_diss_bufm_path,
             erase_path=diss_path,
-            output_path=added_pieces_path,
+            output_path=parts_to_add_path,
+            overlay_self=False,
             explodecollections=True,
-            gridsize=gridsize,
+            gridsize=0.0,
+            nb_parallel=nb_parallel,
+            batchsize=batchsize,
+            operation_prefix=f"{operation_name}-",
+        )
+
+        # To avoid parts not being detected as touching to 2 neighbours because of
+        # rounding issues, apply a small buffer to them.
+        if gridsize > 0.0:
+            distance_parts_to_add = gridsize / 10
+        else:
+            distance_parts_to_add = 0.0000000001
+        step += 1
+        logger.info(f"Step {step} of {nb_steps}")
+        parts_to_add_bufp_path = tempdir / "200_parts_to_add_bufp.gpkg"
+        bufp_path = tempdir / "110_diss_bufp.gpkg"
+        _geoops_gpd.buffer(
+            input_path=parts_to_add_path,
+            output_path=parts_to_add_bufp_path,
+            distance=distance_parts_to_add,
+            endcap_style=BufferEndCapStyle.SQUARE,
+            join_style=BufferJoinStyle.MITRE,
+            mitre_limit=1.25,
+            gridsize=0.0,
             nb_parallel=nb_parallel,
             batchsize=batchsize,
             operation_prefix=f"{operation_name}-",
         )
 
-        # Build a filter to select the pieces that we want to erase again from the
-        # result because they were incorrectly added.
+        # Build a filter to only keep the pieces that actually need to be added to the
+        # input layer.
         # The filter will depend on input parameters.
         if close_internal_gaps:
             # True, so also gaps in the original input boundaries should be closed.
             # This means that in theory all pieces can be retained, but in practice
-            # there are some cases where the above algorithm adds unwanted area, so that
-            # needs to be erased again.
+            # there are some cases where unwanted area would be added anyway, so remove
+            # it from the area to be added.
             #
-            # Parameters that indicate that added pieces won't need to be erased:
+            # Parameters that indicate that added pieces should be added:
             #   - large areas (>= distance) seem OK.
             #   - if > 1 neighbour, seems OK.
             #
             # For all pieces that don't comply to the above, the following parameters
             # indicate that they need to be selected to erase them:
             #   - pieces can be very narrow slivers. E.g. alongside a long boundary with
             #     a small bend, probably due to rounding side effects in the +/- buffer.
             #   - pieces can be spikes. E.g. when a "road" of ~ 'distance' width is not
             #     filled up between two input geometries has a bend. Depending on the
             #     angle, the mitre of the negative buffer can leave a spike in place.
-            pieces_to_erase_filter = f"""
-                neighbours_count_distinct <= 1
-                AND geom_area < {distance} * {distance}
-                AND neighbours_perimeter/2 + neighbours_length <= 0.8 * geom_perimeter
+            parts_to_add_filter = f"""
+                neighbours_count_distinct > 1
+                OR geom_area > {distance} * {distance}
+                OR neighbours_perimeter/2 + neighbours_length > 0.8 * geom_perimeter
             """
         else:
-            # False, so we want to keep all pieces that intersect with only 1 neighbour
-            # in the input, so they can be remove again from the result.
-            pieces_to_erase_filter = "neighbours_count_distinct <= 1"
+            # False, so we only want to add yhe pieces that intersect with > 1 neighbour
+            # in the input.
+            parts_to_add_filter = "neighbours_count_distinct > 1"
 
         # Notes:
         # - The conversion to json followed by extraction from json allows to use a
         #   correlated subquery to return multiple columns. Joining the subquery gives
         #   very bad performance.
         # - Every level of nesting of SQL queries is needed to get good performance, in
         #   combination with "LIMIT -1 OFFSET 0" to avoid the subquery flattening.
@@ -296,65 +327,77 @@
                    WHERE 1=1
                      {{batch_filter}}
                    LIMIT -1 OFFSET 0
                   )
                   LIMIT -1 OFFSET 0
                )
              WHERE geom IS NOT NULL
-               AND ({pieces_to_erase_filter})
+               AND ({parts_to_add_filter})
         """
 
+        # Note: no gridsize is applied to preserve all possible accuracy for these
+        # temporary boundariesstep += 1
         step += 1
         logger.info(f"Step {step} of {nb_steps}")
-        added_pieces_to_be_erased_input = tempdir / "210_addedpieces_to_be_erased.gpkg"
+        parts_to_add_filtered_path = tempdir / "210_parts_to_add_filtered.gpkg"
         _geoops_sql.select_two_layers(
-            input1_path=added_pieces_path,
+            input1_path=parts_to_add_bufp_path,
             input2_path=input_path,
-            output_path=added_pieces_to_be_erased_input,
+            output_path=parts_to_add_filtered_path,
             sql_stmt=sql_stmt,
             input2_layer=input_layer,
-            # gridsize=gridsize,
+            gridsize=0.0,
             nb_parallel=nb_parallel,
             batchsize=batchsize,
             operation_prefix=f"{operation_name}-",
+            output_with_spatial_index=False,
         )
 
+        # Note: no gridsize is applied to preserve all possible accuracy for these
+        # temporary boundariesstep += 1
         step += 1
         logger.info(f"Step {step} of {nb_steps}")
-        _geoops_sql.erase(
-            input_path=buff_diss_bufm_path,
-            erase_path=added_pieces_to_be_erased_input,
+        dst_layer = fileops.get_only_layer(diss_path)
+        fileops.append_to(
+            src=parts_to_add_filtered_path, dst=diss_path, dst_layer=dst_layer
+        )
+
+        step += 1
+        logger.info(f"Step {step} of {nb_steps}")
+        # Apply gridsize for output
+        _geoops_gpd.dissolve(
+            input_path=diss_path,
             output_path=output_path,
-            output_layer=output_layer,
             explodecollections=True,
+            output_layer=output_layer,
             gridsize=gridsize,
             nb_parallel=nb_parallel,
             batchsize=batchsize,
-            force=force,
             operation_prefix=f"{operation_name}-",
         )
 
     finally:
-        shutil.rmtree(tempdir, ignore_errors=True)
+        if ConfigOptions.remove_temp_files:
+            shutil.rmtree(tempdir, ignore_errors=True)
 
     logger.info(f"Ready, took {datetime.now()-start_time}")
 
 
 def apply(
     input_path: Union[str, "os.PathLike[Any]"],
     output_path: Union[str, "os.PathLike[Any]"],
     func: Callable[[Any], Any],
     only_geom_input: bool = True,
     input_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
-    columns: Optional[List[str]] = None,
+    columns: Optional[list[str]] = None,
     explodecollections: bool = False,
     force_output_geometrytype: Union[GeometryType, str, None] = None,
     gridsize: float = 0.0,
-    keep_empty_geoms: Optional[bool] = None,
+    keep_empty_geoms: bool = False,
     where_post: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
 ):
     """
     Apply a python lambda function on the geometry column of the input file.
@@ -465,18 +508,18 @@
     quadrantsegments: int = 5,
     endcap_style: BufferEndCapStyle = BufferEndCapStyle.ROUND,
     join_style: BufferJoinStyle = BufferJoinStyle.ROUND,
     mitre_limit: float = 5.0,
     single_sided: bool = False,
     input_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
-    columns: Optional[List[str]] = None,
+    columns: Optional[list[str]] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
-    keep_empty_geoms: Optional[bool] = None,
+    keep_empty_geoms: bool = False,
     where_post: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
 ):
     """
     Applies a buffer operation on geometry column of the input file.
@@ -676,18 +719,18 @@
             force=force,
         )
 
 
 def clip_by_geometry(
     input_path: Union[str, "os.PathLike[Any]"],
     output_path: Union[str, "os.PathLike[Any]"],
-    clip_geometry: Union[Tuple[float, float, float, float], str],
+    clip_geometry: Union[tuple[float, float, float, float], str],
     input_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
-    columns: Optional[List[str]] = None,
+    columns: Optional[list[str]] = None,
     explodecollections: bool = False,
     force: bool = False,
 ):
     """
     Clip all geometries in the imput file by the geometry provided.
 
     If ``explodecollections`` is False and the input and output file type is GeoPackage,
@@ -726,18 +769,18 @@
 
 
 def convexhull(
     input_path: Union[str, "os.PathLike[Any]"],
     output_path: Union[str, "os.PathLike[Any]"],
     input_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
-    columns: Optional[List[str]] = None,
+    columns: Optional[list[str]] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
-    keep_empty_geoms: Optional[bool] = None,
+    keep_empty_geoms: bool = False,
     where_post: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
 ):
     """
     Applies a convexhull operation on the input file.
@@ -802,17 +845,17 @@
 
 
 def delete_duplicate_geometries(
     input_path: Union[str, "os.PathLike[Any]"],
     output_path: Union[str, "os.PathLike[Any]"],
     input_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
-    columns: Optional[List[str]] = None,
+    columns: Optional[list[str]] = None,
     explodecollections: bool = False,
-    keep_empty_geoms: Optional[bool] = None,
+    keep_empty_geoms: bool = False,
     where_post: Optional[str] = None,
     force: bool = False,
 ):
     """
     Copy all rows to the output file, except for duplicate geometries.
 
     If ``explodecollections`` is False and the input and output file type is GeoPackage,
@@ -860,15 +903,15 @@
     )
 
 
 def dissolve(
     input_path: Union[str, "os.PathLike[Any]"],
     output_path: Union[str, "os.PathLike[Any]"],
     explodecollections: bool,
-    groupby_columns: Union[List[str], str, None] = None,
+    groupby_columns: Union[list[str], str, None] = None,
     agg_columns: Optional[dict] = None,
     tiles_path: Union[str, "os.PathLike[Any]", None] = None,
     nb_squarish_tiles: int = 1,
     input_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
     gridsize: float = 0.0,
     where_post: Optional[str] = None,
@@ -1054,18 +1097,18 @@
         force=force,
     )
 
 
 def export_by_bounds(
     input_path: Union[str, "os.PathLike[Any]"],
     output_path: Union[str, "os.PathLike[Any]"],
-    bounds: Tuple[float, float, float, float],
+    bounds: tuple[float, float, float, float],
     input_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
-    columns: Optional[List[str]] = None,
+    columns: Optional[list[str]] = None,
     explodecollections: bool = False,
     force: bool = False,
 ):
     """
     Export the rows that intersect with the bounds specified.
 
     If ``explodecollections`` is False and the input and output file type is GeoPackage,
@@ -1104,15 +1147,15 @@
 
 def isvalid(
     input_path: Union[str, "os.PathLike[Any]"],
     output_path: Union[str, "os.PathLike[Any]", None] = None,
     only_invalid: bool = True,
     input_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
-    columns: Optional[List[str]] = None,
+    columns: Optional[list[str]] = None,
     explodecollections: bool = False,
     validate_attribute_data: bool = False,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
 ) -> bool:
     """
@@ -1181,19 +1224,19 @@
 
 
 def makevalid(
     input_path: Union[str, "os.PathLike[Any]"],
     output_path: Union[str, "os.PathLike[Any]"],
     input_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
-    columns: Optional[List[str]] = None,
+    columns: Optional[list[str]] = None,
     explodecollections: bool = False,
     force_output_geometrytype: Union[str, None, GeometryType] = None,
     gridsize: float = 0.0,
-    keep_empty_geoms: Optional[bool] = None,
+    keep_empty_geoms: bool = False,
     where_post: Optional[str] = None,
     precision: Optional[float] = None,
     validate_attribute_data: bool = False,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
 ):
@@ -1249,14 +1292,16 @@
     .. |spatialite_reference_link| raw:: html
 
         <a href="https://www.gaia-gis.it/gaia-sins/spatialite-sql-latest.html" target="_blank">spatialite reference</a>
 
     """  # noqa: E501
     logger = logging.getLogger("geofileops.makevalid")
     logger.info(f"Start, on {input_path}")
+    input_path = Path(input_path)
+    output_path = Path(output_path)
 
     if gridsize is None:
         gridsize = 0.0
     if precision is not None and gridsize != 0.0:
         raise ValueError(
             "the precision parameter is deprecated and cannot be combined with gridsize"
         )
@@ -1270,32 +1315,32 @@
         )
 
     if SPATIALITE_GTE_51 and gridsize == 0.0:
         # If spatialite >= 5.1 available use faster/less memory using SQL implementation
         # Only use this version if gridsize is 0.0, because when gridsize applied it is
         # less robust than the gpd implementation.
         _geoops_sql.makevalid(
-            input_path=Path(input_path),
-            output_path=Path(output_path),
+            input_path=input_path,
+            output_path=output_path,
             input_layer=input_layer,
             output_layer=output_layer,
             columns=columns,
             explodecollections=explodecollections,
             force_output_geometrytype=force_output_geometrytype,
             gridsize=gridsize,
             keep_empty_geoms=keep_empty_geoms,
             where_post=where_post,
             nb_parallel=nb_parallel,
             batchsize=batchsize,
             force=force,
         )
     else:
         _geoops_gpd.makevalid(
-            input_path=Path(input_path),
-            output_path=Path(output_path),
+            input_path=input_path,
+            output_path=output_path,
             input_layer=input_layer,
             output_layer=output_layer,
             columns=columns,
             explodecollections=explodecollections,
             force_output_geometrytype=force_output_geometrytype,
             gridsize=gridsize,
             keep_empty_geoms=keep_empty_geoms,
@@ -1311,20 +1356,20 @@
         if output_geofileinfo.is_spatialite_based:
             _sqlite_util.test_data_integrity(path=input_path)
 
 
 def warp(
     input_path: Union[str, "os.PathLike[Any]"],
     output_path: Union[str, "os.PathLike[Any]"],
-    gcps: List[Tuple[float, float, float, float, Optional[float]]],
+    gcps: list[tuple[float, float, float, float, Optional[float]]],
     algorithm: str = "polynomial",
     order: Optional[int] = None,
     input_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
-    columns: Optional[List[str]] = None,
+    columns: Optional[list[str]] = None,
     explodecollections: bool = False,
     force: bool = False,
 ):
     """
     Warp all input features to the output file according to the gcps specified.
 
     Alternative names:
@@ -1374,15 +1419,15 @@
 def select(
     input_path: Union[str, "os.PathLike[Any]"],
     output_path: Union[str, "os.PathLike[Any]"],
     sql_stmt: str,
     sql_dialect: Optional[Literal["SQLITE", "OGRSQL"]] = "SQLITE",
     input_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
-    columns: Optional[List[str]] = None,
+    columns: Optional[list[str]] = None,
     explodecollections: bool = False,
     force_output_geometrytype: Union[GeometryType, str, None] = None,
     gridsize: float = 0.0,
     keep_empty_geoms: bool = True,
     nb_parallel: int = 1,
     batchsize: int = -1,
     force: bool = False,
@@ -1539,18 +1584,18 @@
     input_path: Union[str, "os.PathLike[Any]"],
     output_path: Union[str, "os.PathLike[Any]"],
     tolerance: float,
     algorithm: Union[str, SimplifyAlgorithm] = "rdp",
     lookahead: int = 8,
     input_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
-    columns: Optional[List[str]] = None,
+    columns: Optional[list[str]] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
-    keep_empty_geoms: Optional[bool] = None,
+    keep_empty_geoms: bool = False,
     where_post: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
 ):
     """
     Applies a simplify operation on geometry column of the input file.
@@ -1656,15 +1701,15 @@
 
 
 def clip(
     input_path: Union[str, "os.PathLike[Any]"],
     clip_path: Union[str, "os.PathLike[Any]"],
     output_path: Union[str, "os.PathLike[Any]"],
     input_layer: Optional[str] = None,
-    input_columns: Optional[List[str]] = None,
+    input_columns: Optional[list[str]] = None,
     clip_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
     where_post: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
@@ -1672,15 +1717,15 @@
 ):
     """
     Clip the input layer with the clip layer.
 
     The resulting layer will contain the parts of the geometries in the
     input layer that overlap with the dissolved geometries in the clip layer.
 
-    Clarifications:
+    Notes:
         - every row in the input layer will result in maximum one row in the
           output layer.
         - geometries in the input layer that overlap with multiple adjacent
           geometries in the clip layer won't result in the input geometries
           getting split.
 
     This is the result you can expect when clipping a polygon layer (yellow)
@@ -1751,43 +1796,53 @@
         batchsize=batchsize,
         force=force,
     )
 
 
 def erase(
     input_path: Union[str, "os.PathLike[Any]"],
-    erase_path: Union[str, "os.PathLike[Any]"],
+    erase_path: Union[str, "os.PathLike[Any]", None],
     output_path: Union[str, "os.PathLike[Any]"],
     input_layer: Optional[str] = None,
-    input_columns: Optional[List[str]] = None,
+    input_columns: Optional[list[str]] = None,
     erase_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
     where_post: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     subdivide_coords: int = 2000,
     force: bool = False,
 ):
     """
-    Erase all geometries in the erase layer from the input layer.
+    Erase all features in the erase layer from the features in the input layer.
 
-    Clarifications:
-        - every row in the input layer will result in maximum one row in the
+    Notes:
+        - Every row in the input layer will result in maximum one row in the
           output layer.
-        - columns from the erase layer cannot be retained.
+        - The output will contain the columns from the input layer, no columns from the
+          erase layer. The attribute values wont't be changed, so columns like area,...
+          will have to be recalculated manually.
+        - If ``erase_path`` is None, the 1st input layer is used for both inputs but
+          interactions between the same rows in this layer will be ignored. The output
+          will be the (pieces of) features in this layer that don't have any
+          intersections with other features in this layer.
 
     Alternative names:
         - QGIS: difference
 
     Args:
         input_path (PathLike): The file to erase from.
-        erase_path (PathLike): The file with the geometries to erase with.
-        output_path (PathLike): the file to write the result to
+        erase_path (PathLike, optional): The file with the geometries to erase with. If
+            None, the 1st input layer is used for both inputs but interactions between
+            the same rows in this layer will be ignored. The output will be the (pieces
+            of) features in this layer that don't have any intersections with other
+            features in this layer.
+        output_path (PathLike): the file to write the result to.
         input_layer (str, optional): input layer name. Optional if the
             file only contains one layer.
         input_columns (List[str], optional): list of columns to retain. If None, all
             standard columns are retained. In addition to standard columns, it is also
             possible to specify "fid", a unique index available in all input files. Note
             that the "fid" will be aliased eg. to "fid_1". Defaults to None.
         erase_layer (str, optional): erase layer name. Optional if the
@@ -1819,18 +1874,29 @@
     .. |spatialite_reference_link| raw:: html
 
         <a href="https://www.gaia-gis.it/gaia-sins/spatialite-sql-latest.html" target="_blank">spatialite reference</a>
 
     """  # noqa: E501
     logger = logging.getLogger("geofileops.erase")
     logger.info(f"Start, on {input_path} with {erase_path} to {output_path}")
+
+    # In erase_path is None, we are doing a self-overlay
+    overlay_self = False
+    if erase_path is None:
+        if erase_layer is not None:
+            raise ValueError("erase_layer must be None if erase_path is None")
+        erase_path = input_path
+        erase_layer = input_layer
+        overlay_self = True
+
     return _geoops_sql.erase(
         input_path=Path(input_path),
         erase_path=Path(erase_path),
         output_path=Path(output_path),
+        overlay_self=overlay_self,
         input_layer=input_layer,
         input_columns=input_columns,
         erase_layer=erase_layer,
         output_layer=output_layer,
         explodecollections=explodecollections,
         gridsize=gridsize,
         where_post=where_post,
@@ -1841,39 +1907,57 @@
     )
 
 
 def export_by_location(
     input_to_select_from_path: Union[str, "os.PathLike[Any]"],
     input_to_compare_with_path: Union[str, "os.PathLike[Any]"],
     output_path: Union[str, "os.PathLike[Any]"],
+    spatial_relations_query: str = "intersects is True",
     min_area_intersect: Optional[float] = None,
     area_inters_column_name: Optional[str] = None,
     input1_layer: Optional[str] = None,
-    input1_columns: Optional[List[str]] = None,
+    input1_columns: Optional[list[str]] = None,
     input2_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
     gridsize: float = 0.0,
     where_post: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
+    subdivide_coords: int = 7500,
     force: bool = False,
 ):
     """
-    Exports all intersecting features.
+    Exports all features filtered by the specified spatial query.
 
-    All features in ``input_to_select_from_path`` that intersect with any features in
+    All features in ``input_to_select_from_path`` that comply to the
+    ``spatial_relations_query`` compared with the features in
     ``input_to_compare_with_path`` are exported.
 
+    The ``spatial_relations_query`` has a specific format. For most cases can use the
+    following "named spatial predicates": contains, coveredby, covers, crosses,
+    disjoint, equals, intersects, overlaps, touches and within.
+    If you want even more control, you can also use "spatial masks" as defined by the
+    |DE-9IM| model.
+
+    Some examples of valid ``spatial_relations_query`` values:
+
+        - "touches is True or within is True"
+        - "intersect is True and touches is False"
+        - "(T*T***T** is True or 1*T***T** is True) and T*****FF* is False"
+
+
     Alternative names:
         - QGIS: extract by location
 
     Args:
         input_to_select_from_path (PathLike): the 1st input file
         input_to_compare_with_path (PathLike): the 2nd input file
         output_path (PathLike): the file to write the result to
+        spatial_relations_query (str, optional): a query that specifies the spatial
+            relations to match between the 2 layers. Defaults to "intersects is True".
         min_area_intersect (float, optional): minimum area of the intersection.
             Defaults to None.
         area_inters_column_name (str, optional): column name of the intersect
             area. If None, no area column is added. Defaults to None.
         input1_layer (str, optional): input layer name. Optional if the
             file only contains one layer.
         input1_columns (List[str], optional): list of columns to retain. If None, all
@@ -1893,52 +1977,62 @@
             |spatialite_reference_link| functions can be used. Defaults to None.
         nb_parallel (int, optional): the number of parallel processes to use.
             Defaults to -1: use all available CPUs.
         batchsize (int, optional): indicative number of rows to process per
             batch. A smaller batch size, possibly in combination with a
             smaller ``nb_parallel``, will reduce the memory usage.
             Defaults to -1: (try to) determine optimal size automatically.
+        subdivide_coords (int, optional): the input geometries in the input to compare
+            with layer will be subdivided to parts with about ``subdivide_coords``
+            coordinates during processing which can offer a large speed up for complex
+            geometries. If 0, no subdividing is applied. Defaults to 7.500.
         force (bool, optional): overwrite existing output file(s).
             Defaults to False.
 
     .. |spatialite_reference_link| raw:: html
 
         <a href="https://www.gaia-gis.it/gaia-sins/spatialite-sql-latest.html" target="_blank">spatialite reference</a>
 
+    .. |DE-9IM| raw:: html
+
+        <a href="https://en.wikipedia.org/wiki/DE-9IM" target="_blank">DE-9IM</a>
+
     """  # noqa: E501
     logger = logging.getLogger("geofileops.export_by_location")
     logger.info(
         f"export_by_location: select from {input_to_select_from_path} "
         f"interacting with {input_to_compare_with_path} to {output_path}"
     )
     return _geoops_sql.export_by_location(
         input_path=Path(input_to_select_from_path),
         input_to_compare_with_path=Path(input_to_compare_with_path),
         output_path=Path(output_path),
+        spatial_relations_query=spatial_relations_query,
         min_area_intersect=min_area_intersect,
         area_inters_column_name=area_inters_column_name,
         input_layer=input1_layer,
         input_columns=input1_columns,
         input_to_compare_with_layer=input2_layer,
         output_layer=output_layer,
         gridsize=gridsize,
         where_post=where_post,
         nb_parallel=nb_parallel,
         batchsize=batchsize,
+        subdivide_coords=subdivide_coords,
         force=force,
     )
 
 
 def export_by_distance(
     input_to_select_from_path: Union[str, "os.PathLike[Any]"],
     input_to_compare_with_path: Union[str, "os.PathLike[Any]"],
     output_path: Union[str, "os.PathLike[Any]"],
     max_distance: float,
     input1_layer: Optional[str] = None,
-    input1_columns: Optional[List[str]] = None,
+    input1_columns: Optional[list[str]] = None,
     input2_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
     gridsize: float = 0.0,
     where_post: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
@@ -2005,40 +2099,49 @@
         batchsize=batchsize,
         force=force,
     )
 
 
 def identity(
     input1_path: Union[str, "os.PathLike[Any]"],
-    input2_path: Union[str, "os.PathLike[Any]"],
+    input2_path: Union[str, "os.PathLike[Any]", None],
     output_path: Union[str, "os.PathLike[Any]"],
     input1_layer: Optional[str] = None,
-    input1_columns: Optional[List[str]] = None,
+    input1_columns: Optional[list[str]] = None,
     input1_columns_prefix: str = "l1_",
     input2_layer: Optional[str] = None,
-    input2_columns: Optional[List[str]] = None,
+    input2_columns: Optional[list[str]] = None,
     input2_columns_prefix: str = "l2_",
     output_layer: Optional[str] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
     where_post: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     subdivide_coords: int = 2000,
     force: bool = False,
 ):
     r"""
-    Intersection of the input layers, but retain the non-intersecting parts of input1.
+    Calculates the pairwise identity of the two input layers.
 
-    The result is the equivalent of an intersect between the two layers + layer
-    1 erased with layer 2.
+    The result is the equivalent of the intersection between the two layers + layer 1
+    erased with layer 2.
+
+    Notes:
+        - The result will contain the attribute columns from both input layers. The
+          attribute values wont't be changed, so columns like area,... will have to be
+          recalculated manually if this is wanted.
+        - If ``input2_path`` is None, the 1st input layer is used for both inputs but
+          interactions between the same rows in this layer will be ignored.
 
     Args:
-        input1_path (PathLike): the 1st input file
-        input2_path (PathLike): the 2nd input file
+        input1_path (PathLike): the 1st input file.
+        input2_path (PathLike, optional): the 2nd input file. If None, the 1st input
+            layer is used for both inputs but interactions between the same rows in this
+            layer will be ignored.
         output_path (PathLike): the file to write the result to
         input1_layer (str, optional): input layer name. Optional if the
             file only contains one layer. Defaults to None.
         input1_columns (List[str], optional): list of columns to retain. If None, all
             standard columns are retained. In addition to standard columns, it is also
             possible to specify "fid", a unique index available in all input files. Note
             that the "fid" will be aliased even if ``input1_columns_prefix`` is "", eg.
@@ -2079,18 +2182,29 @@
     .. |spatialite_reference_link| raw:: html
 
         <a href="https://www.gaia-gis.it/gaia-sins/spatialite-sql-latest.html" target="_blank">spatialite reference</a>
 
     """  # noqa: E501
     logger = logging.getLogger("geofileops.identity")
     logger.info(f"Start, between {input1_path} and {input2_path} to {output_path}")
+
+    # In input2_path is None, we are doing a self-overlay
+    overlay_self = False
+    if input2_path is None:
+        if input2_layer is not None:
+            raise ValueError("input2_layer must be None if input2_path is None")
+        input2_path = input1_path
+        input2_layer = input1_layer
+        overlay_self = True
+
     return _geoops_sql.identity(
         input1_path=Path(input1_path),
         input2_path=Path(input2_path),
         output_path=Path(output_path),
+        overlay_self=overlay_self,
         input1_layer=input1_layer,
         input1_columns=input1_columns,
         input1_columns_prefix=input1_columns_prefix,
         input2_layer=input2_layer,
         input2_columns=input2_columns,
         input2_columns_prefix=input2_columns_prefix,
         output_layer=output_layer,
@@ -2105,18 +2219,18 @@
 
 
 def split(
     input1_path: Union[str, "os.PathLike[Any]"],
     input2_path: Union[str, "os.PathLike[Any]"],
     output_path: Union[str, "os.PathLike[Any]"],
     input1_layer: Optional[str] = None,
-    input1_columns: Optional[List[str]] = None,
+    input1_columns: Optional[list[str]] = None,
     input1_columns_prefix: str = "l1_",
     input2_layer: Optional[str] = None,
-    input2_columns: Optional[List[str]] = None,
+    input2_columns: Optional[list[str]] = None,
     input2_columns_prefix: str = "l2_",
     output_layer: Optional[str] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
     where_post: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
@@ -2134,14 +2248,15 @@
     )
     logger = logging.getLogger("geofileops.identity")
     logger.info(f"Start,  between {input1_path} and {input2_path} to {output_path}")
     return _geoops_sql.identity(
         input1_path=Path(input1_path),
         input2_path=Path(input2_path),
         output_path=Path(output_path),
+        overlay_self=False,
         input1_layer=input1_layer,
         input1_columns=input1_columns,
         input1_columns_prefix=input1_columns_prefix,
         input2_layer=input2_layer,
         input2_columns=input2_columns,
         input2_columns_prefix=input2_columns_prefix,
         output_layer=output_layer,
@@ -2156,18 +2271,18 @@
 
 
 def intersect(
     input1_path: Union[str, "os.PathLike[Any]"],
     input2_path: Union[str, "os.PathLike[Any]"],
     output_path: Union[str, "os.PathLike[Any]"],
     input1_layer: Optional[str] = None,
-    input1_columns: Optional[List[str]] = None,
+    input1_columns: Optional[list[str]] = None,
     input1_columns_prefix: str = "l1_",
     input2_layer: Optional[str] = None,
-    input2_columns: Optional[List[str]] = None,
+    input2_columns: Optional[list[str]] = None,
     input2_columns_prefix: str = "l2_",
     output_layer: Optional[str] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
@@ -2198,39 +2313,49 @@
         batchsize=batchsize,
         force=force,
     )
 
 
 def intersection(
     input1_path: Union[str, "os.PathLike[Any]"],
-    input2_path: Union[str, "os.PathLike[Any]"],
+    input2_path: Union[str, "os.PathLike[Any]", None],
     output_path: Union[str, "os.PathLike[Any]"],
     input1_layer: Optional[str] = None,
-    input1_columns: Optional[List[str]] = None,
+    input1_columns: Optional[list[str]] = None,
     input1_columns_prefix: str = "l1_",
     input2_layer: Optional[str] = None,
-    input2_columns: Optional[List[str]] = None,
+    input2_columns: Optional[list[str]] = None,
     input2_columns_prefix: str = "l2_",
     output_layer: Optional[str] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
     where_post: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
 ):
     r"""
-    Calculate the pairwise intersection of alle features.
+    Calculates the pairwise intersection of the two input layers.
+
+    Notes:
+        - The result will contain the attribute columns from both input layers. The
+          attribute values wont't be changed, so columns like area,... will have to be
+          recalculated manually if this is wanted.
+        - If ``input2_path`` is None, the 1st input layer is used for both inputs but
+          intersections between the same rows in this layer will be omitted from the
+          result.
 
     Alternative names:
         - GeoPandas: overlay(how="intersection")
 
     Args:
         input1_path (PathLike): the 1st input file
-        input2_path (PathLike): the 2nd input file
+        input2_path (PathLike): the 2nd input file. If None, the 1st input layer is used
+            for both inputs but intersections between the same rows in this layer will
+            be omitted from the result.
         output_path (PathLike): the file to write the result to
         input1_layer (str, optional): input layer name. Optional if the
             file only contains one layer. Defaults to None.
         input1_columns (List[str], optional): list of columns to retain. If None, all
             standard columns are retained. In addition to standard columns, it is also
             possible to specify "fid", a unique index available in all input files. Note
             that the "fid" will be aliased even if ``input1_columns_prefix`` is "", eg.
@@ -2266,18 +2391,29 @@
     .. |spatialite_reference_link| raw:: html
 
         <a href="https://www.gaia-gis.it/gaia-sins/spatialite-sql-latest.html" target="_blank">spatialite reference</a>
 
     """  # noqa: E501
     logger = logging.getLogger("geofileops.intersection")
     logger.info(f"Start, between {input1_path} and {input2_path} to {output_path}")
+
+    # In input2_path is None, we are doing a self-overlay
+    overlay_self = False
+    if input2_path is None:
+        if input2_layer is not None:
+            raise ValueError("input2_layer must be None if input2_path is None")
+        input2_path = input1_path
+        input2_layer = input1_layer
+        overlay_self = True
+
     return _geoops_sql.intersection(
         input1_path=Path(input1_path),
         input2_path=Path(input2_path),
         output_path=Path(output_path),
+        overlay_self=overlay_self,
         input1_layer=input1_layer,
         input1_columns=input1_columns,
         input1_columns_prefix=input1_columns_prefix,
         input2_layer=input2_layer,
         input2_columns=input2_columns,
         input2_columns_prefix=input2_columns_prefix,
         output_layer=output_layer,
@@ -2295,18 +2431,18 @@
     input2_path: Union[str, "os.PathLike[Any]"],
     output_path: Union[str, "os.PathLike[Any]"],
     spatial_relations_query: str = "intersects is True",
     discard_nonmatching: bool = True,
     min_area_intersect: Optional[float] = None,
     area_inters_column_name: Optional[str] = None,
     input1_layer: Optional[str] = None,
-    input1_columns: Optional[List[str]] = None,
+    input1_columns: Optional[list[str]] = None,
     input1_columns_prefix: str = "l1_",
     input2_layer: Optional[str] = None,
-    input2_columns: Optional[List[str]] = None,
+    input2_columns: Optional[list[str]] = None,
     input2_columns_prefix: str = "l2_",
     output_layer: Optional[str] = None,
     gridsize: float = 0.0,
     where_post: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
@@ -2314,42 +2450,45 @@
     r"""
     Joins all features in input1 with all features in input2.
 
     The output will contain the geometries of input1. The ``spatial_relations_query``
     and ``min_area_intersect`` parameters will determine which geometries of input1 will
     be matched with input2.
 
-    The ``spatial_relations_query`` is a filter string where you can use the following
-    "named spatial predicates": equals, touches, within, overlaps, crosses, intersects,
-    contains, covers, coveredby.
-
+    The ``spatial_relations_query`` has a specific format. Most cases can be covered
+    using the following "named spatial predicates": contains, coveredby, covers,
+    crosses, equals, intersects, overlaps, touches and within.
     If you want even more control, you can also use "spatial masks" as defined by the
     |DE-9IM| model.
+    It is important to note that the query is used as the matching criterium for the
+    join. Hence, it should not evaluate to True for disjoint features, as this would
+    lead to a cartesian product of both layers. If it does, a warning will be triggered
+    and "intersects is True" is added to the query.
 
-    Examples for valid ``spatial_relations_query`` values:
+    Some examples of valid ``spatial_relations_query`` values:
 
-        - "overlaps is True and contains is False"
+        - "intersects is True and touches is False"
+        - "within is True or contains is True"
         - "(T*T***T** is True or 1*T***T** is True) and T*****FF* is False"
 
 
     Alternative names:
         - GeoPandas: sjoin
         - ArcGIS: spatial join
 
     Args:
         input1_path (PathLike): the 1st input file
         input2_path (PathLike): the 2nd input file
         output_path (PathLike): the file to write the result to
         spatial_relations_query (str, optional): a query that specifies the
             spatial relations to match between the 2 layers.
             Defaults to "intersects is True".
-        discard_nonmatching (bool, optional): True to only keep rows that
-            match with the spatial_relations_query. False to keep rows all
-            rows in the ``input1_layer`` (=left outer join). Defaults to True
-            (=inner join).
+        discard_nonmatching (bool, optional): True to only keep rows that match with the
+            spatial_relations_query. False to keep rows all rows in the ``input1_layer``
+            (=left outer join). Defaults to True (=inner join).
         min_area_intersect (float, optional): minimum area of the intersection
             to match. Defaults to None.
         area_inters_column_name (str, optional): column name of the intersect
             area. If None no area column is added. Defaults to None.
         input1_layer (str, optional): input layer name. Optional if the
             file only contains one layer. Defaults to None.
         input1_columns (List[str], optional): list of columns to retain. If None, all
@@ -2422,18 +2561,18 @@
     input1_path: Union[str, "os.PathLike[Any]"],
     input2_path: Union[str, "os.PathLike[Any]"],
     output_path: Union[str, "os.PathLike[Any]"],
     nb_nearest: int,
     distance: Optional[float] = None,
     expand: Optional[bool] = None,
     input1_layer: Optional[str] = None,
-    input1_columns: Optional[List[str]] = None,
+    input1_columns: Optional[list[str]] = None,
     input1_columns_prefix: str = "l1_",
     input2_layer: Optional[str] = None,
-    input2_columns: Optional[List[str]] = None,
+    input2_columns: Optional[list[str]] = None,
     input2_columns_prefix: str = "l2_",
     output_layer: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
 ):
     r"""
@@ -2523,18 +2662,18 @@
 
 def select_two_layers(
     input1_path: Union[str, "os.PathLike[Any]"],
     input2_path: Union[str, "os.PathLike[Any]"],
     output_path: Union[str, "os.PathLike[Any]"],
     sql_stmt: str,
     input1_layer: Optional[str] = None,
-    input1_columns: Optional[List[str]] = None,
+    input1_columns: Optional[list[str]] = None,
     input1_columns_prefix: str = "l1_",
     input2_layer: Optional[str] = None,
-    input2_columns: Optional[List[str]] = None,
+    input2_columns: Optional[list[str]] = None,
     input2_columns_prefix: str = "l2_",
     output_layer: Optional[str] = None,
     explodecollections: bool = False,
     force_output_geometrytype: Optional[GeometryType] = None,
     gridsize: float = 0.0,
     where_post: Optional[str] = None,
     nb_parallel: int = 1,
@@ -2750,41 +2889,54 @@
         batchsize=batchsize,
         force=force,
     )
 
 
 def symmetric_difference(
     input1_path: Union[str, "os.PathLike[Any]"],
-    input2_path: Union[str, "os.PathLike[Any]"],
+    input2_path: Union[str, "os.PathLike[Any]", None],
     output_path: Union[str, "os.PathLike[Any]"],
     input1_layer: Optional[str] = None,
-    input1_columns: Optional[List[str]] = None,
+    input1_columns: Optional[list[str]] = None,
     input1_columns_prefix: str = "l1_",
     input2_layer: Optional[str] = None,
-    input2_columns: Optional[List[str]] = None,
+    input2_columns: Optional[list[str]] = None,
     input2_columns_prefix: str = "l2_",
     output_layer: Optional[str] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
     where_post: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     subdivide_coords: int = 2000,
     force: bool = False,
 ):
     r"""
-    Calculates the "symmetric difference" of the two input layers.
+    Calculates the pairwise symmetric difference of the two input layers.
+
+    The result will be a layer containing features from both the input and overlay
+    layers but with the overlapping areas between the two layers removed.
+
+    Notes:
+        - The result will contain the attribute columns from both input layers. The
+          attribute values wont't be changed, so columns like area,... will have to be
+          recalculated manually if this is wanted.
+        - If ``input2_path`` is None, the 1st input layer is used for both inputs but
+          interactions between the same rows in this layer will be ignored.
+
 
     Alternative names:
         - GeoPandas: overlay(how="symmetric_difference")
         - QGIS, ArcMap: symmetrical difference
 
     Args:
-        input1_path (PathLike): the 1st input file
-        input2_path (PathLike): the 2nd input file
+        input1_path (PathLike): the 1st input file.
+        input2_path (PathLike): the 2nd input file. If None, the 1st input layer is used
+          for both inputs but interactions between the same rows in this layer will be
+          ignored.
         output_path (PathLike): the file to write the result to
         input1_layer (str, optional): input layer name. Optional if the
             file only contains one layer. Defaults to None.
         input1_columns (List[str], optional): list of columns to retain. If None, all
             standard columns are retained. In addition to standard columns, it is also
             possible to specify "fid", a unique index available in all input files. Note
             that the "fid" will be aliased even if ``input1_columns_prefix`` is "", eg. to
@@ -2828,18 +2980,29 @@
 
     """  # noqa: E501
     logger = logging.getLogger("geofileops.symmetric_difference")
     logger.info(
         f"Start, with input1: {input1_path}, "
         f"input2 {input2_path}, output: {output_path}"
     )
+
+    # In input2_path is None, we are doing a self-overlay
+    overlay_self = False
+    if input2_path is None:
+        if input2_layer is not None:
+            raise ValueError("input2_layer must be None if input2_path is None")
+        input2_path = input1_path
+        input2_layer = input1_layer
+        overlay_self = True
+
     return _geoops_sql.symmetric_difference(
         input1_path=Path(input1_path),
         input2_path=Path(input2_path),
         output_path=Path(output_path),
+        overlay_self=overlay_self,
         input1_layer=input1_layer,
         input1_columns=input1_columns,
         input1_columns_prefix=input1_columns_prefix,
         input2_layer=input2_layer,
         input2_columns=input2_columns,
         input2_columns_prefix=input2_columns_prefix,
         output_layer=output_layer,
@@ -2851,40 +3014,58 @@
         subdivide_coords=subdivide_coords,
         force=force,
     )
 
 
 def union(
     input1_path: Union[str, "os.PathLike[Any]"],
-    input2_path: Union[str, "os.PathLike[Any]"],
+    input2_path: Union[str, "os.PathLike[Any]", None],
     output_path: Union[str, "os.PathLike[Any]"],
     input1_layer: Optional[str] = None,
-    input1_columns: Optional[List[str]] = None,
+    input1_columns: Optional[list[str]] = None,
     input1_columns_prefix: str = "l1_",
     input2_layer: Optional[str] = None,
-    input2_columns: Optional[List[str]] = None,
+    input2_columns: Optional[list[str]] = None,
     input2_columns_prefix: str = "l2_",
     output_layer: Optional[str] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
     where_post: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     subdivide_coords: int = 2000,
     force: bool = False,
 ):
     r"""
-    Calculates the pairwise "union" of the two input layers.
+    Calculates the pairwise union of the two input layers.
+
+    Union needs to be interpreted here as such: the output layer will contain the
+    combination of all of the following operations:
+        - The pairwise intersection between the two layers.
+        - The (parts of) features of layer 1 that don't have any intersection with layer
+          2.
+        - The (parts of) features of layer 2 that don't have any intersection with layer
+          1.
+
+    Notes:
+        - The result will contain the attribute columns from both input layers. The
+          attribute values wont't be changed, so columns like area,... will have to be
+          recalculated manually if this is wanted.
+        - If ``input2_path`` is None, the 1st input layer is used for both inputs but
+          interactions between the same rows in this layer will be ignored.
+
 
     Alternative names:
         - GeoPandas: overlay(how="union")
 
     Args:
-        input1_path (PathLike): the 1st input file
-        input2_path (PathLike): the 2nd input file
+        input1_path (PathLike): the 1st input file.
+        input2_path (PathLike, optional): the 2nd input file. If None, the 1st input
+            layer is used for both inputs but interactions between the same rows in this
+            layer will be ignored.
         output_path (PathLike): the file to write the result to
         input1_layer (str, optional): input layer name. Optional if the
             file only contains one layer. Defaults to None.
         input1_columns (List[str], optional): list of columns to retain. If None, all
             standard columns are retained. In addition to standard columns, it is also
             possible to specify "fid", a unique index available in all input files. Note
             that the "fid" will be aliased even if ``input1_columns_prefix`` is "", eg.
@@ -2928,18 +3109,29 @@
 
     """  # noqa: E501
     logger = logging.getLogger("geofileops.union")
     logger.info(
         f"Start, with input1: {input1_path}, input2: {input2_path}, output: "
         f"{output_path}"
     )
+
+    # In input2_path is None, we are doing a self-overlay
+    overlay_self = False
+    if input2_path is None:
+        if input2_layer is not None:
+            raise ValueError("input2_layer must be None if input2_path is None")
+        input2_path = input1_path
+        input2_layer = input1_layer
+        overlay_self = True
+
     return _geoops_sql.union(
         input1_path=Path(input1_path),
         input2_path=Path(input2_path),
         output_path=Path(output_path),
+        overlay_self=overlay_self,
         input1_layer=input1_layer,
         input1_columns=input1_columns,
         input1_columns_prefix=input1_columns_prefix,
         input2_layer=input2_layer,
         input2_columns=input2_columns,
         input2_columns_prefix=input2_columns_prefix,
         output_layer=output_layer,
```

### Comparing `geofileops-0.8.2/geofileops/helpers/_parameter_helper.py` & `geofileops-0.9.0/geofileops/helpers/_parameter_helper.py`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.2/geofileops/helpers/layerstyles.py` & `geofileops-0.9.0/geofileops/helpers/layerstyles.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,18 +1,17 @@
 """
 Module to save layer styles in Geopackage files.
 """
 
-from pathlib import Path
 import sqlite3
+from pathlib import Path
 from typing import Optional
 
-from osgeo import gdal
-from osgeo import ogr
 import pandas as pd
+from osgeo import gdal, ogr
 
 from geofileops import fileops
 
 gdal.UseExceptions()
 ogr.UseExceptions()
```

### Comparing `geofileops-0.8.2/geofileops/util/_geofileinfo.py` & `geofileops-0.9.0/geofileops/util/_geofileinfo.py`

 * *Files 9% similar despite different names*

```diff
@@ -1,17 +1,17 @@
 """
 Module with information about geofile types.
 """
 
 import ast
 import csv
-from dataclasses import dataclass
 import enum
+from dataclasses import dataclass
 from pathlib import Path
-from typing import Any, Dict, List, Optional, Union, TYPE_CHECKING
+from typing import TYPE_CHECKING, Any, Union
 
 from osgeo import gdal
 from osgeo_utils.auxiliary.util import GetOutputDriversFor
 
 if TYPE_CHECKING:
     import os
 
@@ -24,49 +24,55 @@
 class GeofileTypeInfo:
     """
     Class with properties of a GeofileType.
     """
 
     geofiletype: str
     ogrdriver: str
-    suffixes: Optional[List[str]]
+    suffixes: list[str]
     is_fid_zerobased: bool
     is_spatialite_based: bool
-    suffixes_extrafiles: Optional[List[str]]
+    default_spatial_index: bool
+    suffixes_extrafiles: list[str]
 
 
-geofiletypes: Dict[str, GeofileTypeInfo] = {}
+geofiletypes: dict[str, GeofileTypeInfo] = {}
 
 
 def _init_geofiletypes():
     geofiletypes_path = Path(__file__).resolve().parent / "geofiletypes.csv"
     with open(geofiletypes_path) as file:
         # Set skipinitialspace to True so the csv can be formatted for readability
         csv.register_dialect("geofiletype_dialect", skipinitialspace=True, strict=True)
         reader = csv.DictReader(file, dialect="geofiletype_dialect")
 
         for row in reader:
-            # Prepare optional values that need eval first
-            suffixes = None
+            # Determine suffixes
             if row["suffixes"] is not None and row["suffixes"] != "":
                 suffixes = ast.literal_eval(row["suffixes"])
-            suffixes_extrafiles = None
+            else:
+                suffixes = []
+
+            # Determine suffixes_extrafiles
             if (
                 row["suffixes_extrafiles"] is not None
                 and row["suffixes_extrafiles"] != ""
             ):
                 suffixes_extrafiles = ast.literal_eval(row["suffixes_extrafiles"])
+            else:
+                suffixes_extrafiles = []
 
             # Add geofiletype
             geofiletypes[row["geofiletype"]] = GeofileTypeInfo(
                 geofiletype=row["geofiletype"],
                 ogrdriver=row["ogrdriver"],
                 suffixes=suffixes,
                 is_fid_zerobased=ast.literal_eval(row["is_fid_zerobased"]),
                 is_spatialite_based=ast.literal_eval(row["is_spatialite_based"]),
+                default_spatial_index=ast.literal_eval(row["default_spatial_index"]),
                 suffixes_extrafiles=suffixes_extrafiles,
             )
 
 
 class GeofileType(enum.Enum):
     """
     DEPRECATED Enumeration of relevant geo file types and their properties.
@@ -93,16 +99,15 @@
         Returns:
             [GeofileType]: The corresponding GeometryType.
         """
 
         def get_geofiletype_for_suffix(suffix: str):
             suffix_lower = suffix.lower()
             for geofiletype in geofiletypes:
-                suffixes = geofiletypes[geofiletype].suffixes
-                if suffixes is not None and suffix_lower in suffixes:
+                if suffix_lower in geofiletypes[geofiletype].suffixes:
                     return GeofileType[geofiletype]
             raise ValueError(f"Unknown extension {suffix}")
 
         def get_geofiletype_for_ogrdriver(ogrdriver: str):
             for geofiletype in geofiletypes:
                 driver = geofiletypes[geofiletype].ogrdriver
                 if driver is not None and driver == ogrdriver:
@@ -140,20 +145,17 @@
 
     @property
     def ogrdriver(self) -> str:
         """Returns the ogr driver for this GeofileType."""
         return geofiletypes[self.name].ogrdriver
 
     @property
-    def suffixes_extrafiles(self) -> List[str]:
+    def suffixes_extrafiles(self) -> list[str]:
         """Returns a list of suffixes for the extra files for this GeofileType."""
-        suffixes = geofiletypes[self.name].suffixes_extrafiles
-        if suffixes is None:
-            return []
-        return suffixes
+        return geofiletypes[self.name].suffixes_extrafiles
 
     @property
     def is_singlelayer(self) -> bool:
         """Returns True if a file of this GeofileType can only have one layer."""
         if self.is_spatialite_based:
             return False
         else:
@@ -212,15 +214,23 @@
             and self.geofiletype_info.is_spatialite_based
         ):
             return False
         else:
             return True
 
     @property
-    def suffixes_extrafiles(self) -> List[str]:
+    def default_spatial_index(self) -> bool:
+        """Returns True if this geofile can only have one layer."""
+        if self.geofiletype_info is not None:
+            return self.geofiletype_info.default_spatial_index
+        else:
+            return False
+
+    @property
+    def suffixes_extrafiles(self) -> list[str]:
         """Returns a list of suffixes for the extra files for this GeofileType."""
         if self.geofiletype_info is not None:
             return self.geofiletype_info.suffixes_extrafiles
         else:
             return []
 
 
@@ -282,8 +292,8 @@
 
     Args:
         path (Union[str, PathLike): the path to the file.
 
     Returns:
         GeofileInfo: _description_
     """
-    return GeofileInfo(path=path)
+    return GeofileInfo(path=Path(path))
```

### Comparing `geofileops-0.8.2/geofileops/util/_geometry_util.py` & `geofileops-0.9.0/geofileops/util/_geometry_util.py`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.2/geofileops/util/_geoops_gpd.py` & `geofileops-0.9.0/geofileops/util/_geoops_gpd.py`

 * *Files 1% similar despite different names*

```diff
@@ -1,5637 +1,5622 @@
 00000000: 2222 220a 4d6f 6475 6c65 2063 6f6e 7461  """.Module conta
 00000010: 696e 696e 6720 7468 6520 696d 706c 656d  ining the implem
 00000020: 656e 7461 7469 6f6e 206f 6620 4765 6f66  entation of Geof
 00000030: 696c 6520 6f70 6572 6174 696f 6e73 2075  ile operations u
 00000040: 7369 6e67 2047 656f 5061 6e64 6173 2e0a  sing GeoPandas..
-00000050: 2222 220a 0a66 726f 6d20 636f 6e63 7572  """..from concur
-00000060: 7265 6e74 2069 6d70 6f72 7420 6675 7475  rent import futu
-00000070: 7265 730a 696d 706f 7274 2063 6f70 790a  res.import copy.
-00000080: 6672 6f6d 2064 6174 6574 696d 6520 696d  from datetime im
-00000090: 706f 7274 2064 6174 6574 696d 650a 696d  port datetime.im
-000000a0: 706f 7274 2065 6e75 6d0a 696d 706f 7274  port enum.import
-000000b0: 206a 736f 6e0a 696d 706f 7274 206c 6f67   json.import log
-000000c0: 6769 6e67 0a69 6d70 6f72 7420 6c6f 6767  ging.import logg
-000000d0: 696e 672e 636f 6e66 6967 0a69 6d70 6f72  ing.config.impor
-000000e0: 7420 6d61 7468 0a69 6d70 6f72 7420 6d75  t math.import mu
-000000f0: 6c74 6970 726f 6365 7373 696e 670a 6672  ltiprocessing.fr
-00000100: 6f6d 2070 6174 686c 6962 2069 6d70 6f72  om pathlib impor
-00000110: 7420 5061 7468 0a69 6d70 6f72 7420 7069  t Path.import pi
-00000120: 636b 6c65 0a69 6d70 6f72 7420 7265 0a69  ckle.import re.i
-00000130: 6d70 6f72 7420 7368 7574 696c 0a69 6d70  mport shutil.imp
-00000140: 6f72 7420 7469 6d65 0a66 726f 6d20 7479  ort time.from ty
-00000150: 7069 6e67 2069 6d70 6f72 7420 416e 792c  ping import Any,
-00000160: 2043 616c 6c61 626c 652c 2044 6963 742c   Callable, Dict,
-00000170: 2049 7465 7261 626c 652c 204c 6973 742c   Iterable, List,
-00000180: 204f 7074 696f 6e61 6c2c 2053 6574 2c20   Optional, Set, 
-00000190: 5475 706c 652c 2055 6e69 6f6e 0a69 6d70  Tuple, Union.imp
-000001a0: 6f72 7420 7761 726e 696e 6773 0a0a 696d  ort warnings..im
-000001b0: 706f 7274 2063 6c6f 7564 7069 636b 6c65  port cloudpickle
-000001c0: 0a69 6d70 6f72 7420 6765 6f70 616e 6461  .import geopanda
-000001d0: 7320 6173 2067 7064 0a69 6d70 6f72 7420  s as gpd.import 
-000001e0: 6e75 6d70 7920 6173 206e 700a 696d 706f  numpy as np.impo
-000001f0: 7274 2070 616e 6461 7320 6173 2070 640a  rt pandas as pd.
-00000200: 696d 706f 7274 2070 7967 656f 6f70 730a  import pygeoops.
-00000210: 696d 706f 7274 2070 7375 7469 6c0a 0a66  import psutil..f
-00000220: 726f 6d20 7079 6765 6f6f 7073 2069 6d70  rom pygeoops imp
-00000230: 6f72 7420 4765 6f6d 6574 7279 5479 7065  ort GeometryType
-00000240: 2c20 5072 696d 6974 6976 6554 7970 650a  , PrimitiveType.
-00000250: 696d 706f 7274 2073 6861 7065 6c79 0a69  import shapely.i
-00000260: 6d70 6f72 7420 7368 6170 656c 792e 6765  mport shapely.ge
-00000270: 6f6d 6574 7279 2061 7320 7368 5f67 656f  ometry as sh_geo
-00000280: 6d0a 0a69 6d70 6f72 7420 6765 6f66 696c  m..import geofil
-00000290: 656f 7073 2061 7320 6766 6f0a 6672 6f6d  eops as gfo.from
-000002a0: 2067 656f 6669 6c65 6f70 7320 696d 706f   geofileops impo
-000002b0: 7274 2066 696c 656f 7073 0a66 726f 6d20  rt fileops.from 
-000002c0: 6765 6f66 696c 656f 7073 2e68 656c 7065  geofileops.helpe
-000002d0: 7273 2069 6d70 6f72 7420 5f70 6172 616d  rs import _param
-000002e0: 6574 6572 5f68 656c 7065 720a 6672 6f6d  eter_helper.from
-000002f0: 2067 656f 6669 6c65 6f70 732e 7574 696c   geofileops.util
-00000300: 2069 6d70 6f72 7420 5f67 656e 6572 616c   import _general
-00000310: 5f75 7469 6c0a 6672 6f6d 2067 656f 6669  _util.from geofi
-00000320: 6c65 6f70 732e 7574 696c 2069 6d70 6f72  leops.util impor
-00000330: 7420 5f67 656f 6f70 735f 7371 6c0a 6672  t _geoops_sql.fr
-00000340: 6f6d 2067 656f 6669 6c65 6f70 732e 7574  om geofileops.ut
-00000350: 696c 2069 6d70 6f72 7420 5f67 656f 7365  il import _geose
-00000360: 7269 6573 5f75 7469 6c0a 6672 6f6d 2067  ries_util.from g
-00000370: 656f 6669 6c65 6f70 732e 7574 696c 2069  eofileops.util i
-00000380: 6d70 6f72 7420 5f69 6f5f 7574 696c 0a66  mport _io_util.f
-00000390: 726f 6d20 6765 6f66 696c 656f 7073 2e75  rom geofileops.u
-000003a0: 7469 6c20 696d 706f 7274 205f 6f67 725f  til import _ogr_
-000003b0: 7574 696c 0a66 726f 6d20 6765 6f66 696c  util.from geofil
-000003c0: 656f 7073 2e75 7469 6c20 696d 706f 7274  eops.util import
-000003d0: 205f 7072 6f63 6573 7369 6e67 5f75 7469   _processing_uti
-000003e0: 6c0a 6672 6f6d 2067 656f 6669 6c65 6f70  l.from geofileop
-000003f0: 732e 7574 696c 2e5f 6765 6f6d 6574 7279  s.util._geometry
-00000400: 5f75 7469 6c20 696d 706f 7274 2053 696d  _util import Sim
-00000410: 706c 6966 7941 6c67 6f72 6974 686d 0a66  plifyAlgorithm.f
-00000420: 726f 6d20 6765 6f66 696c 656f 7073 2e75  rom geofileops.u
-00000430: 7469 6c2e 5f67 656f 6d65 7472 795f 7574  til._geometry_ut
-00000440: 696c 2069 6d70 6f72 7420 4275 6666 6572  il import Buffer
-00000450: 456e 6443 6170 5374 796c 652c 2042 7566  EndCapStyle, Buf
-00000460: 6665 724a 6f69 6e53 7479 6c65 0a0a 2320  ferJoinStyle..# 
-00000470: 446f 6e27 7420 7368 6f77 2074 6869 7320  Don't show this 
-00000480: 6765 6f70 616e 6461 7320 7761 726e 696e  geopandas warnin
-00000490: 672e 2e2e 0a77 6172 6e69 6e67 732e 6669  g....warnings.fi
-000004a0: 6c74 6572 7761 726e 696e 6773 2822 6967  lterwarnings("ig
-000004b0: 6e6f 7265 222c 2022 4765 6f53 6572 6965  nore", "GeoSerie
-000004c0: 732e 6973 6e61 222c 2055 7365 7257 6172  s.isna", UserWar
-000004d0: 6e69 6e67 290a 0a6c 6f67 6765 7220 3d20  ning)..logger = 
-000004e0: 6c6f 6767 696e 672e 6765 744c 6f67 6765  logging.getLogge
-000004f0: 7228 5f5f 6e61 6d65 5f5f 290a 0a0a 636c  r(__name__)...cl
-00000500: 6173 7320 5061 7261 6c6c 656c 697a 6174  ass Parallelizat
-00000510: 696f 6e43 6f6e 6669 673a 0a20 2020 2022  ionConfig:.    "
-00000520: 2222 0a20 2020 2048 6575 7269 7374 6963  "".    Heuristic
-00000530: 7320 666f 7220 6765 6f70 616e 6461 7320  s for geopandas 
-00000540: 6261 7365 6420 6765 6f20 6f70 6572 6174  based geo operat
-00000550: 696f 6e73 2e0a 0a20 2020 2048 6575 7269  ions...    Heuri
-00000560: 7374 6963 7320 6d65 616e 7420 746f 2062  stics meant to b
-00000570: 6520 6162 6c65 2074 6f20 6f70 7469 6d69  e able to optimi
-00000580: 7a65 2074 6865 2070 6172 616c 6c65 6c69  ze the paralleli
-00000590: 7361 7469 6f6e 2070 6172 616d 6574 6572  sation parameter
-000005a0: 7320 666f 720a 2020 2020 6765 6f70 616e  s for.    geopan
-000005b0: 6461 7320 6261 7365 6420 6765 6f20 6f70  das based geo op
-000005c0: 6572 6174 696f 6e2e 0a20 2020 2022 2222  eration..    """
-000005d0: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
-000005e0: 5f5f 280a 2020 2020 2020 2020 7365 6c66  __(.        self
-000005f0: 2c0a 2020 2020 2020 2020 6279 7465 735f  ,.        bytes_
-00000600: 6261 7365 666f 6f74 7072 696e 743a 2069  basefootprint: i
-00000610: 6e74 203d 2035 3020 2a20 3130 3234 202a  nt = 50 * 1024 *
-00000620: 2031 3032 342c 0a20 2020 2020 2020 2062   1024,.        b
-00000630: 7974 6573 5f70 6572 5f72 6f77 3a20 696e  ytes_per_row: in
-00000640: 7420 3d20 3130 3030 2c0a 2020 2020 2020  t = 1000,.      
-00000650: 2020 6d69 6e5f 726f 7773 5f70 6572 5f62    min_rows_per_b
-00000660: 6174 6368 3a20 696e 7420 3d20 3130 3030  atch: int = 1000
-00000670: 2c0a 2020 2020 2020 2020 6d61 785f 726f  ,.        max_ro
-00000680: 7773 5f70 6572 5f62 6174 6368 3a20 696e  ws_per_batch: in
-00000690: 7420 3d20 3130 3030 3030 2c0a 2020 2020  t = 100000,.    
-000006a0: 2020 2020 6279 7465 735f 6d69 6e5f 7065      bytes_min_pe
-000006b0: 725f 7072 6f63 6573 733a 204f 7074 696f  r_process: Optio
-000006c0: 6e61 6c5b 696e 745d 203d 204e 6f6e 652c  nal[int] = None,
-000006d0: 0a20 2020 2020 2020 2062 7974 6573 5f75  .        bytes_u
-000006e0: 7361 626c 653a 204f 7074 696f 6e61 6c5b  sable: Optional[
-000006f0: 696e 745d 203d 204e 6f6e 652c 0a20 2020  int] = None,.   
-00000700: 2020 2020 2063 7075 5f63 6f75 6e74 3a20       cpu_count: 
-00000710: 696e 7420 3d20 2d31 2c0a 2020 2020 293a  int = -1,.    ):
-00000720: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00000730: 2020 2020 2048 6575 7269 7374 6963 7320       Heuristics 
-00000740: 666f 7220 6765 6f70 616e 6461 7320 6261  for geopandas ba
-00000750: 7365 6420 6765 6f20 6f70 6572 6174 696f  sed geo operatio
-00000760: 6e73 2e0a 0a20 2020 2020 2020 2048 6575  ns...        Heu
-00000770: 7269 7374 6963 7320 6d65 616e 7420 746f  ristics meant to
-00000780: 2062 6520 6162 6c65 2074 6f20 6f70 7469   be able to opti
-00000790: 6d69 7a65 2074 6865 2070 6172 616c 6c65  mize the paralle
-000007a0: 6c69 7361 7469 6f6e 2070 6172 616d 6574  lisation paramet
-000007b0: 6572 7320 666f 720a 2020 2020 2020 2020  ers for.        
-000007c0: 6765 6f70 616e 6461 7320 6261 7365 6420  geopandas based 
-000007d0: 6765 6f20 6f70 6572 6174 696f 6e2e 0a0a  geo operation...
-000007e0: 2020 2020 2020 2020 4172 6773 3a0a 2020          Args:.  
-000007f0: 2020 2020 2020 2020 2020 6279 7465 735f            bytes_
-00000800: 6261 7365 666f 6f74 7072 696e 7420 2869  basefootprint (i
-00000810: 6e74 2c20 6f70 7469 6f6e 616c 293a 2054  nt, optional): T
-00000820: 6865 2062 6173 6520 6d65 6d6f 7279 2075  he base memory u
-00000830: 7361 6765 206f 6620 6120 6765 6f66 696c  sage of a geofil
-00000840: 656f 7073 0a20 2020 2020 2020 2020 2020  eops.           
-00000850: 2020 2020 2077 6f72 6b65 7220 7072 6f63       worker proc
-00000860: 6573 732e 2044 6566 6175 6c74 7320 746f  ess. Defaults to
-00000870: 2035 3020 4d42 2e0a 2020 2020 2020 2020   50 MB..        
-00000880: 2020 2020 6279 7465 735f 7065 725f 726f      bytes_per_ro
-00000890: 7720 2869 6e74 2c20 6f70 7469 6f6e 616c  w (int, optional
-000008a0: 293a 2054 6865 206e 756d 6265 7220 6966  ): The number if
-000008b0: 2062 7974 6573 206e 6565 6465 6420 746f   bytes needed to
-000008c0: 2073 746f 7265 2f70 726f 6365 7373 0a20   store/process. 
-000008d0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-000008e0: 6e65 2072 6f77 206f 6620 6461 7461 2e20  ne row of data. 
-000008f0: 4465 6661 756c 7473 2074 6f20 3130 3030  Defaults to 1000
-00000900: 2e0a 2020 2020 2020 2020 2020 2020 6d69  ..            mi
-00000910: 6e5f 726f 7773 5f70 6572 5f62 6174 6368  n_rows_per_batch
-00000920: 2028 696e 742c 206f 7074 696f 6e61 6c29   (int, optional)
-00000930: 3a20 5468 6520 6d69 6e69 6d75 6d20 6e75  : The minimum nu
-00000940: 6d62 6572 206f 6620 726f 7773 2074 6f20  mber of rows to 
-00000950: 6169 6d20 666f 7220 696e 0a20 2020 2020  aim for in.     
-00000960: 2020 2020 2020 2020 2020 206f 6e65 2062             one b
-00000970: 6174 6368 2e20 4465 6661 756c 7473 2074  atch. Defaults t
-00000980: 6f20 3130 3030 2e0a 2020 2020 2020 2020  o 1000..        
-00000990: 2020 2020 6d61 785f 726f 7773 5f70 6572      max_rows_per
-000009a0: 5f62 6174 6368 2028 696e 742c 206f 7074  _batch (int, opt
-000009b0: 696f 6e61 6c29 3a20 5468 6520 6d61 7869  ional): The maxi
-000009c0: 6d75 6d20 6e75 6d62 6572 206f 6620 726f  mum number of ro
-000009d0: 7773 2074 6f20 6169 6d20 666f 7220 696e  ws to aim for in
-000009e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000009f0: 2061 2062 6174 6368 2e20 4465 6661 756c   a batch. Defaul
-00000a00: 7473 2074 6f20 3130 3030 3030 2e0a 2020  ts to 100000..  
-00000a10: 2020 2020 2020 2020 2020 6279 7465 735f            bytes_
-00000a20: 6d69 6e5f 7065 725f 7072 6f63 6573 7320  min_per_process 
-00000a30: 284f 7074 696f 6e61 6c5b 696e 745d 2c20  (Optional[int], 
-00000a40: 6f70 7469 6f6e 616c 293a 2054 6865 206d  optional): The m
-00000a50: 696e 696d 756d 206e 756d 6265 7220 6f66  inimum number of
-00000a60: 2062 7974 6573 0a20 2020 2020 2020 2020   bytes.         
-00000a70: 2020 2020 2020 206e 6565 6465 6420 666f         needed fo
-00000a80: 7220 6120 6765 6f66 696c 656f 7073 2077  r a geofileops w
-00000a90: 6f72 6b65 7220 7072 6f63 6573 732e 2044  orker process. D
-00000aa0: 6566 6175 6c74 7320 746f 204e 6f6e 652e  efaults to None.
-00000ab0: 0a20 2020 2020 2020 2020 2020 2062 7974  .            byt
-00000ac0: 6573 5f75 7361 626c 6520 284f 7074 696f  es_usable (Optio
-00000ad0: 6e61 6c5b 696e 745d 2c20 6f70 7469 6f6e  nal[int], option
-00000ae0: 616c 293a 2074 6865 206d 656d 6f72 7920  al): the memory 
-00000af0: 6176 6169 6c61 626c 6520 666f 7220 7072  available for pr
-00000b00: 6f63 6573 7369 6e67 2e0a 2020 2020 2020  ocessing..      
-00000b10: 2020 2020 2020 2020 2020 4465 6661 756c            Defaul
-00000b20: 7473 2074 6f20 4e6f 6e65 2c20 7468 656e  ts to None, then
-00000b30: 2074 6865 2066 7265 6520 6d65 6d6f 7279   the free memory
-00000b40: 2069 7320 6175 746f 6d61 7469 6361 6c6c   is automaticall
-00000b50: 7920 6465 7465 726d 696e 6564 2e0a 2020  y determined..  
-00000b60: 2020 2020 2020 2020 2020 6370 755f 636f            cpu_co
-00000b70: 756e 7420 2869 6e74 2c20 6f70 7469 6f6e  unt (int, option
-00000b80: 616c 293a 2074 6865 206e 756d 6265 7220  al): the number 
-00000b90: 6f66 2043 5055 2773 2061 7661 696c 6162  of CPU's availab
-00000ba0: 6c65 2e20 4465 6661 756c 7473 2074 6f20  le. Defaults to 
-00000bb0: 2d31 2c0a 2020 2020 2020 2020 2020 2020  -1,.            
-00000bc0: 2020 2020 7468 656e 2074 6865 2063 7075      then the cpu
-00000bd0: 5f63 6f75 6e74 2069 7320 6465 7465 726d  _count is determ
-00000be0: 696e 6564 2061 7574 6f6d 6174 6963 616c  ined automatical
-00000bf0: 6c79 2e0a 2020 2020 2020 2020 2222 220a  ly..        """.
-00000c00: 2020 2020 2020 2020 7365 6c66 2e62 7974          self.byt
-00000c10: 6573 5f62 6173 6566 6f6f 7470 7269 6e74  es_basefootprint
-00000c20: 203d 2062 7974 6573 5f62 6173 6566 6f6f   = bytes_basefoo
-00000c30: 7470 7269 6e74 0a20 2020 2020 2020 2073  tprint.        s
-00000c40: 656c 662e 6279 7465 735f 7065 725f 726f  elf.bytes_per_ro
-00000c50: 7720 3d20 6279 7465 735f 7065 725f 726f  w = bytes_per_ro
-00000c60: 770a 2020 2020 2020 2020 7365 6c66 2e6d  w.        self.m
-00000c70: 696e 5f72 6f77 735f 7065 725f 6261 7463  in_rows_per_batc
-00000c80: 6820 3d20 6d69 6e5f 726f 7773 5f70 6572  h = min_rows_per
-00000c90: 5f62 6174 6368 0a20 2020 2020 2020 2073  _batch.        s
-00000ca0: 656c 662e 6d61 785f 726f 7773 5f70 6572  elf.max_rows_per
-00000cb0: 5f62 6174 6368 203d 206d 6178 5f72 6f77  _batch = max_row
-00000cc0: 735f 7065 725f 6261 7463 680a 0a20 2020  s_per_batch..   
-00000cd0: 2020 2020 2023 204e 6565 6473 2073 6f6d       # Needs som
-00000ce0: 6520 6c6f 6769 6320 746f 2067 6574 2076  e logic to get v
-00000cf0: 616c 7565 2069 6620 6e6f 7420 7365 7420  alue if not set 
-00000d00: 6578 706c 6963 6974 6c79 2e2e 2e0a 2020  explicitly....  
-00000d10: 2020 2020 2020 7365 6c66 2e5f 6279 7465        self._byte
-00000d20: 735f 6d69 6e5f 7065 725f 7072 6f63 6573  s_min_per_proces
-00000d30: 7320 3d20 6279 7465 735f 6d69 6e5f 7065  s = bytes_min_pe
-00000d40: 725f 7072 6f63 6573 730a 2020 2020 2020  r_process.      
-00000d50: 2020 2320 4966 206e 6f74 2073 7065 6369    # If not speci
-00000d60: 6669 6564 2c20 6465 7465 726d 696e 6520  fied, determine 
-00000d70: 796f 7572 7365 6c66 0a20 2020 2020 2020  yourself.       
-00000d80: 2073 656c 662e 6279 7465 735f 7573 6162   self.bytes_usab
-00000d90: 6c65 203d 2028 0a20 2020 2020 2020 2020  le = (.         
-00000da0: 2020 2062 7974 6573 5f75 7361 626c 650a     bytes_usable.
-00000db0: 2020 2020 2020 2020 2020 2020 6966 2062              if b
-00000dc0: 7974 6573 5f75 7361 626c 6520 6973 206e  ytes_usable is n
-00000dd0: 6f74 204e 6f6e 650a 2020 2020 2020 2020  ot None.        
-00000de0: 2020 2020 656c 7365 2069 6e74 2870 7375      else int(psu
-00000df0: 7469 6c2e 7669 7274 7561 6c5f 6d65 6d6f  til.virtual_memo
-00000e00: 7279 2829 2e61 7661 696c 6162 6c65 202a  ry().available *
-00000e10: 2030 2e39 290a 2020 2020 2020 2020 290a   0.9).        ).
-00000e20: 2020 2020 2020 2020 2320 4966 206e 6f74          # If not
-00000e30: 2073 7065 6369 6669 6564 2c20 6465 7465   specified, dete
-00000e40: 726d 696e 6520 796f 7572 7365 6c66 0a20  rmine yourself. 
-00000e50: 2020 2020 2020 2073 656c 662e 6370 755f         self.cpu_
-00000e60: 636f 756e 7420 3d20 6370 755f 636f 756e  count = cpu_coun
-00000e70: 7420 6966 2063 7075 5f63 6f75 6e74 203e  t if cpu_count >
-00000e80: 2030 2065 6c73 6520 6d75 6c74 6970 726f   0 else multipro
-00000e90: 6365 7373 696e 672e 6370 755f 636f 756e  cessing.cpu_coun
-00000ea0: 7428 290a 0a20 2020 2040 7072 6f70 6572  t()..    @proper
-00000eb0: 7479 0a20 2020 2064 6566 2062 7974 6573  ty.    def bytes
-00000ec0: 5f6d 696e 5f70 6572 5f70 726f 6365 7373  _min_per_process
-00000ed0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00000ee0: 6966 2073 656c 662e 5f62 7974 6573 5f6d  if self._bytes_m
-00000ef0: 696e 5f70 6572 5f70 726f 6365 7373 2069  in_per_process i
-00000f00: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00000f10: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00000f20: 656c 662e 5f62 7974 6573 5f6d 696e 5f70  elf._bytes_min_p
-00000f30: 6572 5f70 726f 6365 7373 0a20 2020 2020  er_process.     
-00000f40: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00000f50: 2020 2020 2072 6574 7572 6e20 280a 2020       return (.  
-00000f60: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00000f70: 6c66 2e62 7974 6573 5f62 6173 6566 6f6f  lf.bytes_basefoo
-00000f80: 7470 7269 6e74 202b 2073 656c 662e 6279  tprint + self.by
-00000f90: 7465 735f 7065 725f 726f 7720 2a20 7365  tes_per_row * se
-00000fa0: 6c66 2e6d 696e 5f72 6f77 735f 7065 725f  lf.min_rows_per_
-00000fb0: 6261 7463 680a 2020 2020 2020 2020 2020  batch.          
-00000fc0: 2020 290a 0a20 2020 2040 6279 7465 735f    )..    @bytes_
-00000fd0: 6d69 6e5f 7065 725f 7072 6f63 6573 732e  min_per_process.
-00000fe0: 7365 7474 6572 0a20 2020 2064 6566 2062  setter.    def b
-00000ff0: 7974 6573 5f6d 696e 5f70 6572 5f70 726f  ytes_min_per_pro
-00001000: 6365 7373 2873 656c 662c 2076 616c 7565  cess(self, value
-00001010: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-00001020: 5f62 7974 6573 5f6d 696e 5f70 6572 5f70  _bytes_min_per_p
-00001030: 726f 6365 7373 203d 2076 616c 7565 0a0a  rocess = value..
-00001040: 0a64 6566 205f 6465 7465 726d 696e 655f  .def _determine_
-00001050: 6e62 5f62 6174 6368 6573 280a 2020 2020  nb_batches(.    
-00001060: 6e62 5f72 6f77 735f 746f 7461 6c3a 2069  nb_rows_total: i
-00001070: 6e74 2c0a 2020 2020 6e62 5f70 6172 616c  nt,.    nb_paral
-00001080: 6c65 6c3a 2069 6e74 203d 202d 312c 0a20  lel: int = -1,. 
-00001090: 2020 2062 6174 6368 7369 7a65 3a20 696e     batchsize: in
-000010a0: 7420 3d20 2d31 2c0a 2020 2020 7061 7261  t = -1,.    para
-000010b0: 6c6c 656c 697a 6174 696f 6e5f 636f 6e66  llelization_conf
-000010c0: 6967 3a20 4f70 7469 6f6e 616c 5b50 6172  ig: Optional[Par
-000010d0: 616c 6c65 6c69 7a61 7469 6f6e 436f 6e66  allelizationConf
-000010e0: 6967 5d20 3d20 4e6f 6e65 2c0a 2920 2d3e  ig] = None,.) ->
-000010f0: 2054 7570 6c65 5b69 6e74 2c20 696e 745d   Tuple[int, int]
-00001100: 3a0a 2020 2020 2222 220a 2020 2020 4465  :.    """.    De
-00001110: 7465 726d 696e 6573 2072 6563 6f6d 6d65  termines recomme
-00001120: 6e64 6564 2070 6172 616c 6c65 6c69 7a61  nded paralleliza
-00001130: 7469 6f6e 2070 6172 616d 732e 0a0a 2020  tion params...  
-00001140: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
-00001150: 6e62 5f72 6f77 735f 746f 7461 6c20 2869  nb_rows_total (i
-00001160: 6e74 293a 2054 6865 2074 6f74 616c 206e  nt): The total n
-00001170: 756d 6265 7220 6f66 2072 6f77 7320 7468  umber of rows th
-00001180: 6174 2077 696c 6c20 6265 2070 726f 6365  at will be proce
-00001190: 7373 6564 0a20 2020 2020 2020 206e 625f  ssed.        nb_
-000011a0: 7061 7261 6c6c 656c 2028 696e 7429 3a20  parallel (int): 
-000011b0: 5468 6520 6c65 7665 6c20 6f66 2070 6172  The level of par
-000011c0: 616c 6c65 6c69 7a61 7469 6f6e 2072 6571  allelization req
-000011d0: 7565 7374 6564 2e0a 2020 2020 2020 2020  uested..        
-000011e0: 2020 2020 4966 202d 312c 2074 7269 6573      If -1, tries
-000011f0: 2074 6f20 7573 6520 616c 6c20 7265 736f   to use all reso
-00001200: 7572 6365 7320 6176 6169 6c61 626c 652e  urces available.
-00001210: 0a20 2020 2020 2020 2062 6174 6368 7369  .        batchsi
-00001220: 7a65 2028 696e 7429 3a20 696e 6469 6361  ze (int): indica
-00001230: 7469 7665 206e 756d 6265 7220 6f66 2072  tive number of r
-00001240: 6f77 7320 746f 2070 726f 6365 7373 2070  ows to process p
-00001250: 6572 2062 6174 6368 2e0a 2020 2020 2020  er batch..      
-00001260: 2020 2020 2020 4966 202d 313a 2028 7472        If -1: (tr
-00001270: 7920 746f 2920 6465 7465 726d 696e 6520  y to) determine 
-00001280: 6f70 7469 6d61 6c20 7369 7a65 2061 7574  optimal size aut
-00001290: 6f6d 6174 6963 616c 6c79 2075 7369 6e67  omatically using
-000012a0: 2074 6865 2068 6575 7269 7374 6963 7320   the heuristics 
-000012b0: 696e 0a20 2020 2020 2020 2020 2020 2027  in.            '
-000012c0: 7061 7261 6c6c 656c 697a 6174 696f 6e5f  parallelization_
-000012d0: 636f 6e66 6967 272e 0a20 2020 2020 2020  config'..       
-000012e0: 2070 6172 616c 6c65 6c69 7a61 7469 6f6e   parallelization
-000012f0: 5f63 6f6e 6669 6720 2850 6172 616c 6c65  _config (Paralle
-00001300: 6c69 7a61 7469 6f6e 436f 6e66 6967 2c20  lizationConfig, 
-00001310: 6f70 7469 6f6e 616c 293a 2043 6f6e 6669  optional): Confi
-00001320: 6775 7261 7469 6f6e 0a20 2020 2020 2020  guration.       
-00001330: 2020 2020 2070 6172 616d 6574 6572 7320       parameters 
-00001340: 746f 2075 7365 2074 6f20 7375 6767 6573  to use to sugges
-00001350: 7420 7061 7261 6c6c 656c 6973 6174 696f  t parallelisatio
-00001360: 6e20 7061 7261 6d65 7465 7273 2e0a 0a20  n parameters... 
-00001370: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
-00001380: 2020 2020 5475 706c 655b 696e 742c 2069      Tuple[int, i
-00001390: 6e74 5d3a 2054 7570 6c65 206f 6620 286e  nt]: Tuple of (n
-000013a0: 625f 7061 7261 6c6c 656c 2c20 6e62 5f62  b_parallel, nb_b
-000013b0: 6174 6368 6573 290a 2020 2020 2222 220a  atches).    """.
-000013c0: 2020 2020 2320 4966 2030 206f 7220 3120      # If 0 or 1 
-000013d0: 726f 7773 2074 6f20 7072 6f63 6573 732c  rows to process,
-000013e0: 206f 6e65 2062 6174 6368 0a20 2020 2069   one batch.    i
-000013f0: 6620 6e62 5f72 6f77 735f 746f 7461 6c20  f nb_rows_total 
-00001400: 3c3d 2031 3a0a 2020 2020 2020 2020 7265  <= 1:.        re
-00001410: 7475 726e 2028 312c 2031 290a 0a20 2020  turn (1, 1)..   
-00001420: 2023 2049 6620 636f 6e66 6967 2069 7320   # If config is 
-00001430: 4e6f 6e65 2c20 7573 6520 6465 6661 756c  None, use defaul
-00001440: 7420 636f 6e66 6967 0a20 2020 2069 6620  t config.    if 
-00001450: 7061 7261 6c6c 656c 697a 6174 696f 6e5f  parallelization_
-00001460: 636f 6e66 6967 2069 7320 4e6f 6e65 3a0a  config is None:.
-00001470: 2020 2020 2020 2020 636f 6e66 6967 5f6c          config_l
-00001480: 6f63 616c 203d 2050 6172 616c 6c65 6c69  ocal = Paralleli
-00001490: 7a61 7469 6f6e 436f 6e66 6967 2829 0a20  zationConfig(). 
-000014a0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000014b0: 2063 6f6e 6669 675f 6c6f 6361 6c20 3d20   config_local = 
-000014c0: 636f 7079 2e64 6565 7063 6f70 7928 7061  copy.deepcopy(pa
-000014d0: 7261 6c6c 656c 697a 6174 696f 6e5f 636f  rallelization_co
-000014e0: 6e66 6967 290a 0a20 2020 2023 2049 6620  nfig)..    # If 
-000014f0: 7468 6520 6e75 6d62 6572 206f 6620 726f  the number of ro
-00001500: 7773 2069 7320 7265 616c 6c79 206c 6f77  ws is really low
-00001510: 2c20 6a75 7374 2075 7365 206f 6e65 2062  , just use one b
-00001520: 6174 6368 0a20 2020 2069 6620 6e62 5f70  atch.    if nb_p
-00001530: 6172 616c 6c65 6c20 3c20 3120 616e 6420  arallel < 1 and 
-00001540: 6261 7463 6873 697a 6520 3c20 313a 0a20  batchsize < 1:. 
-00001550: 2020 2020 2020 2069 6620 6e62 5f72 6f77         if nb_row
-00001560: 735f 746f 7461 6c20 3c3d 2063 6f6e 6669  s_total <= confi
-00001570: 675f 6c6f 6361 6c2e 6d69 6e5f 726f 7773  g_local.min_rows
-00001580: 5f70 6572 5f62 6174 6368 3a0a 2020 2020  _per_batch:.    
-00001590: 2020 2020 2020 2020 7265 7475 726e 2028          return (
-000015a0: 312c 2031 290a 0a20 2020 2069 6620 6e62  1, 1)..    if nb
-000015b0: 5f70 6172 616c 6c65 6c20 3c3d 2030 3a0a  _parallel <= 0:.
-000015c0: 2020 2020 2020 2020 6e62 5f70 6172 616c          nb_paral
-000015d0: 6c65 6c20 3d20 636f 6e66 6967 5f6c 6f63  lel = config_loc
-000015e0: 616c 2e63 7075 5f63 6f75 6e74 0a0a 2020  al.cpu_count..  
-000015f0: 2020 6966 206c 6f67 6765 722e 6973 456e    if logger.isEn
-00001600: 6162 6c65 6446 6f72 286c 6f67 6769 6e67  abledFor(logging
-00001610: 2e44 4542 5547 293a 0a20 2020 2020 2020  .DEBUG):.       
-00001620: 206d 656d 5f75 7361 626c 6520 3d20 5f67   mem_usable = _g
-00001630: 656e 6572 616c 5f75 7469 6c2e 666f 726d  eneral_util.form
-00001640: 6174 6279 7465 7328 636f 6e66 6967 5f6c  atbytes(config_l
-00001650: 6f63 616c 2e62 7974 6573 5f75 7361 626c  ocal.bytes_usabl
-00001660: 6529 0a20 2020 2020 2020 206c 6f67 6765  e).        logge
-00001670: 722e 6465 6275 6728 6622 6d65 6d6f 7279  r.debug(f"memory
-00001680: 5f75 7361 626c 653a 207b 6d65 6d5f 7573  _usable: {mem_us
-00001690: 6162 6c65 7d2c 2077 6974 683a 2229 0a20  able}, with:"). 
-000016a0: 2020 2020 2020 206d 656d 5f61 7661 696c         mem_avail
-000016b0: 6162 6c65 203d 205f 6765 6e65 7261 6c5f  able = _general_
-000016c0: 7574 696c 2e66 6f72 6d61 7462 7974 6573  util.formatbytes
-000016d0: 2870 7375 7469 6c2e 7669 7274 7561 6c5f  (psutil.virtual_
-000016e0: 6d65 6d6f 7279 2829 2e61 7661 696c 6162  memory().availab
-000016f0: 6c65 290a 2020 2020 2020 2020 6c6f 6767  le).        logg
-00001700: 6572 2e64 6562 7567 2866 2220 202d 3e20  er.debug(f"  -> 
-00001710: 6d65 6d2e 6176 6169 6c61 626c 653a 207b  mem.available: {
-00001720: 6d65 6d5f 6176 6169 6c61 626c 657d 2229  mem_available}")
-00001730: 0a20 2020 2020 2020 2073 7761 705f 6672  .        swap_fr
-00001740: 6565 203d 205f 6765 6e65 7261 6c5f 7574  ee = _general_ut
-00001750: 696c 2e66 6f72 6d61 7462 7974 6573 2870  il.formatbytes(p
-00001760: 7375 7469 6c2e 7377 6170 5f6d 656d 6f72  sutil.swap_memor
-00001770: 7928 292e 6672 6565 290a 2020 2020 2020  y().free).      
-00001780: 2020 6c6f 6767 6572 2e64 6562 7567 2866    logger.debug(f
-00001790: 2220 202d 3e20 7377 6170 2e66 7265 653a  "  -> swap.free:
-000017a0: 207b 7377 6170 5f66 7265 657d 2229 0a0a   {swap_free}")..
-000017b0: 2020 2020 2320 4966 206e 6f74 2065 6e6f      # If not eno
-000017c0: 7567 6820 6d65 6d6f 7279 2066 6f72 2074  ugh memory for t
-000017d0: 6865 2061 6d6f 756e 7420 6f66 2070 6172  he amount of par
-000017e0: 616c 6c65 6c6c 6973 6d20 6173 6b65 642c  allellism asked,
-000017f0: 2072 6564 7563 650a 2020 2020 6966 2028   reduce.    if (
-00001800: 6e62 5f70 6172 616c 6c65 6c20 2a20 636f  nb_parallel * co
-00001810: 6e66 6967 5f6c 6f63 616c 2e62 7974 6573  nfig_local.bytes
-00001820: 5f6d 696e 5f70 6572 5f70 726f 6365 7373  _min_per_process
-00001830: 2920 3e20 636f 6e66 6967 5f6c 6f63 616c  ) > config_local
-00001840: 2e62 7974 6573 5f75 7361 626c 653a 0a20  .bytes_usable:. 
-00001850: 2020 2020 2020 206e 625f 7061 7261 6c6c         nb_parall
-00001860: 656c 203d 2069 6e74 280a 2020 2020 2020  el = int(.      
-00001870: 2020 2020 2020 636f 6e66 6967 5f6c 6f63        config_loc
-00001880: 616c 2e62 7974 6573 5f75 7361 626c 6520  al.bytes_usable 
-00001890: 2f20 636f 6e66 6967 5f6c 6f63 616c 2e62  / config_local.b
-000018a0: 7974 6573 5f6d 696e 5f70 6572 5f70 726f  ytes_min_per_pro
-000018b0: 6365 7373 0a20 2020 2020 2020 2029 0a20  cess.        ). 
-000018c0: 2020 2020 2020 206c 6f67 6765 722e 6465         logger.de
-000018d0: 6275 6728 6622 4e62 5f70 6172 616c 6c65  bug(f"Nb_paralle
-000018e0: 6c20 7265 6475 6365 6420 746f 207b 6e62  l reduced to {nb
-000018f0: 5f70 6172 616c 6c65 6c7d 2074 6f20 7265  _parallel} to re
-00001900: 6475 6365 206d 656d 6f72 7920 7573 6167  duce memory usag
-00001910: 6522 290a 0a20 2020 2023 2048 6176 696e  e")..    # Havin
-00001920: 6720 6d6f 7265 2077 6f72 6b65 7273 2074  g more workers t
-00001930: 6861 6e20 726f 7773 2064 6f65 736e 2774  han rows doesn't
-00001940: 206d 616b 6520 7365 6e73 650a 2020 2020   make sense.    
-00001950: 6966 206e 625f 7061 7261 6c6c 656c 203e  if nb_parallel >
-00001960: 206e 625f 726f 7773 5f74 6f74 616c 3a0a   nb_rows_total:.
-00001970: 2020 2020 2020 2020 6e62 5f70 6172 616c          nb_paral
-00001980: 6c65 6c20 3d20 6e62 5f72 6f77 735f 746f  lel = nb_rows_to
-00001990: 7461 6c0a 0a20 2020 2023 2049 6620 6261  tal..    # If ba
-000019a0: 7463 6873 697a 6520 6973 2073 7065 6369  tchsize is speci
-000019b0: 6669 6564 2c20 7573 6520 6974 2074 6f20  fied, use it to 
-000019c0: 6465 7465 726d 696e 6520 6e75 6d62 6572  determine number
-000019d0: 206f 6620 6261 7463 6865 732e 0a20 2020   of batches..   
-000019e0: 2069 6620 6261 7463 6873 697a 6520 3e20   if batchsize > 
-000019f0: 303a 0a20 2020 2020 2020 206e 625f 6261  0:.        nb_ba
-00001a00: 7463 6865 7320 3d20 6d61 7468 2e63 6569  tches = math.cei
-00001a10: 6c28 6e62 5f72 6f77 735f 746f 7461 6c20  l(nb_rows_total 
-00001a20: 2f20 6261 7463 6873 697a 6529 0a0a 2020  / batchsize)..  
-00001a30: 2020 2020 2020 2320 4e6f 2075 7365 2074        # No use t
-00001a40: 6f20 6861 7665 206d 6f72 6520 776f 726b  o have more work
-00001a50: 6572 7320 7468 616e 206e 756d 6265 7220  ers than number 
-00001a60: 6f66 2062 6174 6368 6573 0a20 2020 2020  of batches.     
-00001a70: 2020 2069 6620 6e62 5f70 6172 616c 6c65     if nb_paralle
-00001a80: 6c20 3e20 6e62 5f62 6174 6368 6573 3a0a  l > nb_batches:.
-00001a90: 2020 2020 2020 2020 2020 2020 6e62 5f70              nb_p
-00001aa0: 6172 616c 6c65 6c20 3d20 6e62 5f62 6174  arallel = nb_bat
-00001ab0: 6368 6573 0a0a 2020 2020 2020 2020 7265  ches..        re
-00001ac0: 7475 726e 2028 6e62 5f70 6172 616c 6c65  turn (nb_paralle
-00001ad0: 6c2c 206e 625f 6261 7463 6865 7329 0a0a  l, nb_batches)..
-00001ae0: 2020 2020 2320 4e6f 2062 6174 6368 7369      # No batchsi
-00001af0: 7a65 2073 7065 6369 6669 6564 2c20 736f  ze specified, so
-00001b00: 2075 7365 2068 6575 7269 7374 6963 732e   use heuristics.
-00001b10: 0a20 2020 2023 2053 7461 7274 2077 6974  .    # Start wit
-00001b20: 6820 3120 6261 7463 6820 7065 7220 776f  h 1 batch per wo
-00001b30: 726b 6572 0a20 2020 206e 625f 6261 7463  rker.    nb_batc
-00001b40: 6865 7320 3d20 6e62 5f70 6172 616c 6c65  hes = nb_paralle
-00001b50: 6c0a 0a20 2020 2023 2049 6620 7468 6520  l..    # If the 
-00001b60: 6261 7463 6865 7320 3c20 6d69 6e5f 726f  batches < min_ro
-00001b70: 7773 5f70 6572 5f62 6174 6368 2c20 6465  ws_per_batch, de
-00001b80: 6372 6561 7365 206e 756d 6265 7220 6261  crease number ba
-00001b90: 7463 6865 730a 2020 2020 6966 206e 625f  tches.    if nb_
-00001ba0: 726f 7773 5f74 6f74 616c 202f 206e 625f  rows_total / nb_
-00001bb0: 6261 7463 6865 7320 3c20 636f 6e66 6967  batches < config
-00001bc0: 5f6c 6f63 616c 2e6d 696e 5f72 6f77 735f  _local.min_rows_
-00001bd0: 7065 725f 6261 7463 683a 0a20 2020 2020  per_batch:.     
-00001be0: 2020 206e 625f 6261 7463 6865 7320 3d20     nb_batches = 
-00001bf0: 6d61 7468 2e63 6569 6c28 6e62 5f72 6f77  math.ceil(nb_row
-00001c00: 735f 746f 7461 6c20 2f20 636f 6e66 6967  s_total / config
-00001c10: 5f6c 6f63 616c 2e6d 696e 5f72 6f77 735f  _local.min_rows_
-00001c20: 7065 725f 6261 7463 6829 0a0a 2020 2020  per_batch)..    
-00001c30: 2320 4966 2074 6865 2062 6174 6368 6573  # If the batches
-00001c40: 203e 206d 6178 5f72 6f77 735f 7065 725f   > max_rows_per_
-00001c50: 6261 7463 682c 2069 6e63 7265 6173 6520  batch, increase 
-00001c60: 6e75 6d62 6572 2062 6174 6368 6573 0a20  number batches. 
-00001c70: 2020 2069 6620 6e62 5f72 6f77 735f 746f     if nb_rows_to
-00001c80: 7461 6c20 2f20 6e62 5f62 6174 6368 6573  tal / nb_batches
-00001c90: 203e 2063 6f6e 6669 675f 6c6f 6361 6c2e   > config_local.
-00001ca0: 6d61 785f 726f 7773 5f70 6572 5f62 6174  max_rows_per_bat
-00001cb0: 6368 3a0a 2020 2020 2020 2020 6e62 5f62  ch:.        nb_b
-00001cc0: 6174 6368 6573 203d 206d 6174 682e 6365  atches = math.ce
-00001cd0: 696c 286e 625f 726f 7773 5f74 6f74 616c  il(nb_rows_total
-00001ce0: 202f 2063 6f6e 6669 675f 6c6f 6361 6c2e   / config_local.
-00001cf0: 6d61 785f 726f 7773 5f70 6572 5f62 6174  max_rows_per_bat
-00001d00: 6368 290a 2020 2020 2020 2020 2320 526f  ch).        # Ro
-00001d10: 756e 6420 6e62 5f62 6174 6368 6573 2075  und nb_batches u
-00001d20: 7020 746f 2074 6865 206e 6561 7265 7374  p to the nearest
-00001d30: 206d 756c 7469 706c 6520 6f66 206e 625f   multiple of nb_
-00001d40: 7061 7261 6c6c 656c 0a20 2020 2020 2020  parallel.       
-00001d50: 206e 625f 6261 7463 6865 7320 3d20 6d61   nb_batches = ma
-00001d60: 7468 2e63 6569 6c28 6e62 5f62 6174 6368  th.ceil(nb_batch
-00001d70: 6573 202f 206e 625f 7061 7261 6c6c 656c  es / nb_parallel
-00001d80: 2920 2a20 6e62 5f70 6172 616c 6c65 6c0a  ) * nb_parallel.
-00001d90: 0a20 2020 2023 2048 6176 696e 6720 6d6f  .    # Having mo
-00001da0: 7265 2077 6f72 6b65 7273 2074 6861 6e20  re workers than 
-00001db0: 6261 7463 6865 7320 6973 6e27 7420 6c6f  batches isn't lo
-00001dc0: 6769 6361 6c2e 2e2e 0a20 2020 2069 6620  gical....    if 
-00001dd0: 6e62 5f70 6172 616c 6c65 6c20 3e20 6e62  nb_parallel > nb
-00001de0: 5f62 6174 6368 6573 3a0a 2020 2020 2020  _batches:.      
-00001df0: 2020 6e62 5f70 6172 616c 6c65 6c20 3d20    nb_parallel = 
-00001e00: 6e62 5f62 6174 6368 6573 0a0a 2020 2020  nb_batches..    
-00001e10: 2320 4669 6e61 6c6c 792c 206d 616b 6520  # Finally, make 
-00001e20: 7375 7265 2074 6865 7265 2061 7265 2065  sure there are e
-00001e30: 6e6f 7567 6820 6261 7463 6865 7320 746f  nough batches to
-00001e40: 2061 766f 6964 206d 656d 6f72 7920 6973   avoid memory is
-00001e50: 7375 6573 3a0a 2020 2020 2320 2020 3d20  sues:.    #   = 
-00001e60: 746f 7461 6c20 6d65 6d6f 7279 2075 7361  total memory usa
-00001e70: 6765 2066 6f72 2061 6c6c 2072 6f77 7320  ge for all rows 
-00001e80: 2f0a 2020 2020 2320 2020 2020 2866 7265  /.    #     (fre
-00001e90: 6520 6d65 6d6f 7279 202d 2062 6173 6520  e memory - base 
-00001ea0: 6d65 6d6f 7279 2075 7365 6420 6279 2061  memory used by a
-00001eb0: 6c6c 2070 6172 616c 6c65 6c20 7072 6f63  ll parallel proc
-00001ec0: 6573 7365 7329 0a20 2020 206e 625f 6261  esses).    nb_ba
-00001ed0: 7463 6865 735f 6d69 6e20 3d20 6d61 7468  tches_min = math
-00001ee0: 2e63 6569 6c28 0a20 2020 2020 2020 2028  .ceil(.        (
-00001ef0: 6e62 5f72 6f77 735f 746f 7461 6c20 2a20  nb_rows_total * 
-00001f00: 636f 6e66 6967 5f6c 6f63 616c 2e62 7974  config_local.byt
-00001f10: 6573 5f70 6572 5f72 6f77 290a 2020 2020  es_per_row).    
-00001f20: 2020 2020 2f20 2863 6f6e 6669 675f 6c6f      / (config_lo
-00001f30: 6361 6c2e 6279 7465 735f 7573 6162 6c65  cal.bytes_usable
-00001f40: 202d 2063 6f6e 6669 675f 6c6f 6361 6c2e   - config_local.
-00001f50: 6279 7465 735f 6261 7365 666f 6f74 7072  bytes_basefootpr
-00001f60: 696e 7420 2a20 6e62 5f70 6172 616c 6c65  int * nb_paralle
-00001f70: 6c29 0a20 2020 2029 0a20 2020 2069 6620  l).    ).    if 
-00001f80: 6e62 5f62 6174 6368 6573 203c 206e 625f  nb_batches < nb_
-00001f90: 6261 7463 6865 735f 6d69 6e3a 0a20 2020  batches_min:.   
-00001fa0: 2020 2020 2023 2052 6f75 6e64 206e 625f       # Round nb_
-00001fb0: 6261 7463 6865 7320 7570 2074 6f20 7468  batches up to th
-00001fc0: 6520 6e65 6172 6573 7420 6d75 6c74 6970  e nearest multip
-00001fd0: 6c65 206f 6620 6e62 5f70 6172 616c 6c65  le of nb_paralle
-00001fe0: 6c0a 2020 2020 2020 2020 6e62 5f62 6174  l.        nb_bat
-00001ff0: 6368 6573 203d 206d 6174 682e 6365 696c  ches = math.ceil
-00002000: 286e 625f 6261 7463 6865 735f 6d69 6e20  (nb_batches_min 
-00002010: 2f20 6e62 5f70 6172 616c 6c65 6c29 202a  / nb_parallel) *
-00002020: 206e 625f 7061 7261 6c6c 656c 0a0a 2020   nb_parallel..  
-00002030: 2020 2320 4c6f 6720 7265 7375 6c74 0a20    # Log result. 
-00002040: 2020 2069 6620 6c6f 6767 6572 2e69 7345     if logger.isE
-00002050: 6e61 626c 6564 466f 7228 6c6f 6767 696e  nabledFor(loggin
-00002060: 672e 4445 4255 4729 3a0a 2020 2020 2020  g.DEBUG):.      
-00002070: 2020 6261 7463 6873 697a 6520 3d20 6d61    batchsize = ma
-00002080: 7468 2e63 6569 6c28 6e62 5f72 6f77 735f  th.ceil(nb_rows_
-00002090: 746f 7461 6c20 2f20 6e62 5f62 6174 6368  total / nb_batch
-000020a0: 6573 290a 2020 2020 2020 2020 6d65 6d5f  es).        mem_
-000020b0: 7072 6564 6963 7465 6420 3d20 280a 2020  predicted = (.  
-000020c0: 2020 2020 2020 2020 2020 636f 6e66 6967            config
-000020d0: 5f6c 6f63 616c 2e62 7974 6573 5f62 6173  _local.bytes_bas
-000020e0: 6566 6f6f 7470 7269 6e74 202b 2062 6174  efootprint + bat
-000020f0: 6368 7369 7a65 202a 2063 6f6e 6669 675f  chsize * config_
-00002100: 6c6f 6361 6c2e 6279 7465 735f 7065 725f  local.bytes_per_
-00002110: 726f 770a 2020 2020 2020 2020 2920 2a20  row.        ) * 
-00002120: 6e62 5f62 6174 6368 6573 0a0a 2020 2020  nb_batches..    
-00002130: 2020 2020 6c6f 6767 6572 2e64 6562 7567      logger.debug
-00002140: 280a 2020 2020 2020 2020 2020 2020 6622  (.            f"
-00002150: 6e62 5f62 6174 6368 6573 5f72 6563 6f6d  nb_batches_recom
-00002160: 6d65 6e64 6564 3a20 7b6e 625f 6261 7463  mended: {nb_batc
-00002170: 6865 737d 2c20 726f 7773 5f70 6572 5f62  hes}, rows_per_b
-00002180: 6174 6368 3a20 7b62 6174 6368 7369 7a65  atch: {batchsize
-00002190: 7d22 0a20 2020 2020 2020 2029 0a20 2020  }".        ).   
-000021a0: 2020 2020 206c 6f67 6765 722e 6465 6275       logger.debu
-000021b0: 6728 6622 202d 3e20 6e62 5f72 6f77 735f  g(f" -> nb_rows_
-000021c0: 696e 7075 745f 6c61 7965 723a 207b 6e62  input_layer: {nb
-000021d0: 5f72 6f77 735f 746f 7461 6c7d 2229 0a20  _rows_total}"). 
-000021e0: 2020 2020 2020 206c 6f67 6765 722e 6465         logger.de
-000021f0: 6275 6728 6622 202d 3e20 6d65 6d5f 7072  bug(f" -> mem_pr
-00002200: 6564 6963 7465 643a 207b 5f67 656e 6572  edicted: {_gener
-00002210: 616c 5f75 7469 6c2e 666f 726d 6174 6279  al_util.formatby
-00002220: 7465 7328 6d65 6d5f 7072 6564 6963 7465  tes(mem_predicte
-00002230: 6429 7d22 290a 0a20 2020 2072 6574 7572  d)}")..    retur
-00002240: 6e20 286e 625f 7061 7261 6c6c 656c 2c20  n (nb_parallel, 
-00002250: 6e62 5f62 6174 6368 6573 290a 0a0a 636c  nb_batches)...cl
-00002260: 6173 7320 5072 6f63 6573 7369 6e67 5061  ass ProcessingPa
-00002270: 7261 6d73 3a0a 2020 2020 6465 6620 5f5f  rams:.    def __
-00002280: 696e 6974 5f5f 280a 2020 2020 2020 2020  init__(.        
-00002290: 7365 6c66 2c0a 2020 2020 2020 2020 6e62  self,.        nb
-000022a0: 5f72 6f77 735f 746f 5f70 726f 6365 7373  _rows_to_process
-000022b0: 3a20 696e 742c 0a20 2020 2020 2020 206e  : int,.        n
-000022c0: 625f 7061 7261 6c6c 656c 3a20 696e 742c  b_parallel: int,
-000022d0: 0a20 2020 2020 2020 2062 6174 6368 6573  .        batches
-000022e0: 3a20 4c69 7374 5b73 7472 5d2c 0a20 2020  : List[str],.   
-000022f0: 2020 2020 2062 6174 6368 7369 7a65 3a20       batchsize: 
-00002300: 696e 742c 0a20 2020 2029 3a0a 2020 2020  int,.    ):.    
-00002310: 2020 2020 7365 6c66 2e6e 625f 726f 7773      self.nb_rows
-00002320: 5f74 6f5f 7072 6f63 6573 7320 3d20 6e62  _to_process = nb
-00002330: 5f72 6f77 735f 746f 5f70 726f 6365 7373  _rows_to_process
-00002340: 0a20 2020 2020 2020 2073 656c 662e 6e62  .        self.nb
-00002350: 5f70 6172 616c 6c65 6c20 3d20 6e62 5f70  _parallel = nb_p
-00002360: 6172 616c 6c65 6c0a 2020 2020 2020 2020  arallel.        
-00002370: 7365 6c66 2e62 6174 6368 6573 203d 2062  self.batches = b
-00002380: 6174 6368 6573 0a20 2020 2020 2020 2073  atches.        s
-00002390: 656c 662e 6261 7463 6873 697a 6520 3d20  elf.batchsize = 
-000023a0: 6261 7463 6873 697a 650a 0a20 2020 2064  batchsize..    d
-000023b0: 6566 2074 6f5f 6a73 6f6e 2873 656c 662c  ef to_json(self,
-000023c0: 2070 6174 683a 2050 6174 6829 3a0a 2020   path: Path):.  
-000023d0: 2020 2020 2020 7072 6570 6172 6564 203d        prepared =
-000023e0: 205f 6765 6e65 7261 6c5f 7574 696c 2e70   _general_util.p
-000023f0: 7265 7061 7265 5f66 6f72 5f73 6572 6961  repare_for_seria
-00002400: 6c69 7a65 2876 6172 7328 7365 6c66 2929  lize(vars(self))
-00002410: 0a20 2020 2020 2020 2077 6974 6820 6f70  .        with op
-00002420: 656e 2870 6174 682c 2022 7722 2920 6173  en(path, "w") as
-00002430: 2066 696c 653a 0a20 2020 2020 2020 2020   file:.         
-00002440: 2020 2066 696c 652e 7772 6974 6528 6a73     file.write(js
-00002450: 6f6e 2e64 756d 7073 2870 7265 7061 7265  on.dumps(prepare
-00002460: 642c 2069 6e64 656e 743d 342c 2073 6f72  d, indent=4, sor
-00002470: 745f 6b65 7973 3d54 7275 6529 290a 0a0a  t_keys=True))...
-00002480: 6465 6620 5f70 7265 7061 7265 5f70 726f  def _prepare_pro
-00002490: 6365 7373 696e 675f 7061 7261 6d73 280a  cessing_params(.
-000024a0: 2020 2020 696e 7075 745f 7061 7468 3a20      input_path: 
-000024b0: 5061 7468 2c0a 2020 2020 696e 7075 745f  Path,.    input_
-000024c0: 6c61 7965 723a 2073 7472 2c0a 2020 2020  layer: str,.    
-000024d0: 6e62 5f70 6172 616c 6c65 6c3a 2069 6e74  nb_parallel: int
-000024e0: 2c0a 2020 2020 6261 7463 6873 697a 653a  ,.    batchsize:
-000024f0: 2069 6e74 2c0a 2020 2020 7061 7261 6c6c   int,.    parall
-00002500: 656c 697a 6174 696f 6e5f 636f 6e66 6967  elization_config
-00002510: 3a20 4f70 7469 6f6e 616c 5b50 6172 616c  : Optional[Paral
-00002520: 6c65 6c69 7a61 7469 6f6e 436f 6e66 6967  lelizationConfig
-00002530: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 746d  ] = None,.    tm
-00002540: 705f 6469 723a 204f 7074 696f 6e61 6c5b  p_dir: Optional[
-00002550: 5061 7468 5d20 3d20 4e6f 6e65 2c0a 2920  Path] = None,.) 
-00002560: 2d3e 2050 726f 6365 7373 696e 6750 6172  -> ProcessingPar
-00002570: 616d 733a 0a20 2020 2069 6e70 7574 5f69  ams:.    input_i
-00002580: 6e66 6f20 3d20 6766 6f2e 6765 745f 6c61  nfo = gfo.get_la
-00002590: 7965 7269 6e66 6f28 696e 7075 745f 7061  yerinfo(input_pa
-000025a0: 7468 2c20 696e 7075 745f 6c61 7965 7229  th, input_layer)
-000025b0: 0a20 2020 2066 6964 5f63 6f6c 756d 6e20  .    fid_column 
-000025c0: 3d20 696e 7075 745f 696e 666f 2e66 6964  = input_info.fid
-000025d0: 5f63 6f6c 756d 6e20 6966 2069 6e70 7574  _column if input
-000025e0: 5f69 6e66 6f2e 6669 645f 636f 6c75 6d6e  _info.fid_column
-000025f0: 2021 3d20 2222 2065 6c73 6520 2266 6964   != "" else "fid
-00002600: 220a 2020 2020 6e62 5f70 6172 616c 6c65  ".    nb_paralle
-00002610: 6c2c 206e 625f 6261 7463 6865 7320 3d20  l, nb_batches = 
-00002620: 5f64 6574 6572 6d69 6e65 5f6e 625f 6261  _determine_nb_ba
-00002630: 7463 6865 7328 0a20 2020 2020 2020 206e  tches(.        n
-00002640: 625f 726f 7773 5f74 6f74 616c 3d69 6e70  b_rows_total=inp
-00002650: 7574 5f69 6e66 6f2e 6665 6174 7572 6563  ut_info.featurec
-00002660: 6f75 6e74 2c0a 2020 2020 2020 2020 6e62  ount,.        nb
-00002670: 5f70 6172 616c 6c65 6c3d 6e62 5f70 6172  _parallel=nb_par
-00002680: 616c 6c65 6c2c 0a20 2020 2020 2020 2062  allel,.        b
-00002690: 6174 6368 7369 7a65 3d62 6174 6368 7369  atchsize=batchsi
-000026a0: 7a65 2c0a 2020 2020 2020 2020 7061 7261  ze,.        para
-000026b0: 6c6c 656c 697a 6174 696f 6e5f 636f 6e66  llelization_conf
-000026c0: 6967 3d70 6172 616c 6c65 6c69 7a61 7469  ig=parallelizati
-000026d0: 6f6e 5f63 6f6e 6669 672c 0a20 2020 2029  on_config,.    )
-000026e0: 0a0a 2020 2020 2320 5072 6570 6172 6520  ..    # Prepare 
-000026f0: 6261 7463 6865 7320 746f 2070 726f 6365  batches to proce
-00002700: 7373 0a20 2020 2062 6174 6368 6573 3a20  ss.    batches: 
-00002710: 4c69 7374 5b73 7472 5d20 3d20 5b5d 0a20  List[str] = []. 
-00002720: 2020 2069 6620 6e62 5f62 6174 6368 6573     if nb_batches
-00002730: 203d 3d20 313a 0a20 2020 2020 2020 2023   == 1:.        #
-00002740: 2049 6620 6f6e 6c79 206f 6e65 2062 6174   If only one bat
-00002750: 6368 2c20 6e6f 2066 696c 7465 7269 6e67  ch, no filtering
-00002760: 2069 7320 6e65 6564 6564 0a20 2020 2020   is needed.     
-00002770: 2020 2062 6174 6368 6573 2e61 7070 656e     batches.appen
-00002780: 6428 2222 290a 2020 2020 656c 7365 3a0a  d("").    else:.
-00002790: 2020 2020 2020 2020 2320 4465 7465 726d          # Determ
-000027a0: 696e 6520 7468 6520 6d69 6e5f 6669 6420  ine the min_fid 
-000027b0: 616e 6420 6d61 785f 6669 640a 2020 2020  and max_fid.    
-000027c0: 2020 2020 2320 5265 6d61 726b 3a20 5345      # Remark: SE
-000027d0: 4c45 4354 204d 494e 2866 6964 292c 204d  LECT MIN(fid), M
-000027e0: 4158 2866 6964 2920 4652 4f4d 202e 2e2e  AX(fid) FROM ...
-000027f0: 2069 7320 6120 6c6f 7420 736c 6f77 6572   is a lot slower
-00002800: 2074 6861 6e20 554e 494f 4e20 414c 4c21   than UNION ALL!
-00002810: 0a20 2020 2020 2020 2073 716c 5f73 746d  .        sql_stm
-00002820: 7420 3d20 6622 2222 0a20 2020 2020 2020  t = f""".       
-00002830: 2020 2020 2053 454c 4543 5420 4d49 4e28       SELECT MIN(
-00002840: 7b66 6964 5f63 6f6c 756d 6e7d 2920 6d69  {fid_column}) mi
-00002850: 6e6d 6178 5f66 6964 2046 524f 4d20 227b  nmax_fid FROM "{
-00002860: 696e 7075 745f 696e 666f 2e6e 616d 657d  input_info.name}
-00002870: 220a 2020 2020 2020 2020 2020 2020 554e  ".            UN
-00002880: 494f 4e20 414c 4c0a 2020 2020 2020 2020  ION ALL.        
-00002890: 2020 2020 5345 4c45 4354 204d 4158 287b      SELECT MAX({
-000028a0: 6669 645f 636f 6c75 6d6e 7d29 206d 696e  fid_column}) min
-000028b0: 6d61 785f 6669 6420 4652 4f4d 2022 7b69  max_fid FROM "{i
-000028c0: 6e70 7574 5f69 6e66 6f2e 6e61 6d65 7d22  nput_info.name}"
-000028d0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-000028e0: 2020 2020 2062 6174 6368 5f69 6e66 6f5f       batch_info_
-000028f0: 6466 203d 2067 666f 2e72 6561 645f 6669  df = gfo.read_fi
-00002900: 6c65 2870 6174 683d 696e 7075 745f 7061  le(path=input_pa
-00002910: 7468 2c20 7371 6c5f 7374 6d74 3d73 716c  th, sql_stmt=sql
-00002920: 5f73 746d 7429 0a20 2020 2020 2020 206d  _stmt).        m
-00002930: 696e 5f66 6964 203d 2070 642e 746f 5f6e  in_fid = pd.to_n
-00002940: 756d 6572 6963 2862 6174 6368 5f69 6e66  umeric(batch_inf
-00002950: 6f5f 6466 5b22 6d69 6e6d 6178 5f66 6964  o_df["minmax_fid
-00002960: 225d 5b30 5d29 2e69 7465 6d28 290a 2020  "][0]).item().  
-00002970: 2020 2020 2020 6d61 785f 6669 6420 3d20        max_fid = 
-00002980: 7064 2e74 6f5f 6e75 6d65 7269 6328 6261  pd.to_numeric(ba
-00002990: 7463 685f 696e 666f 5f64 665b 226d 696e  tch_info_df["min
-000029a0: 6d61 785f 6669 6422 5d5b 315d 292e 6974  max_fid"][1]).it
-000029b0: 656d 2829 0a0a 2020 2020 2020 2020 2320  em()..        # 
-000029c0: 4465 7465 726d 696e 6520 7468 6520 6578  Determine the ex
-000029d0: 6163 7420 6261 7463 6865 7320 746f 2075  act batches to u
-000029e0: 7365 0a20 2020 2020 2020 2069 6620 2828  se.        if ((
-000029f0: 6d61 785f 6669 6420 2d20 6d69 6e5f 6669  max_fid - min_fi
-00002a00: 6429 202f 2069 6e70 7574 5f69 6e66 6f2e  d) / input_info.
-00002a10: 6665 6174 7572 6563 6f75 6e74 2920 3c20  featurecount) < 
-00002a20: 312e 313a 0a20 2020 2020 2020 2020 2020  1.1:.           
-00002a30: 2023 2049 6620 7468 6520 6669 6427 7320   # If the fid's 
-00002a40: 6172 6520 7175 6974 6520 636f 6e73 6563  are quite consec
-00002a50: 7574 6976 652c 2075 7365 2061 6e20 696d  utive, use an im
-00002a60: 7065 7266 6563 742c 2062 7574 0a20 2020  perfect, but.   
-00002a70: 2020 2020 2020 2020 2023 2066 6173 7420           # fast 
-00002a80: 6469 7374 7269 6275 7469 6f6e 2069 6e20  distribution in 
-00002a90: 6261 7463 6865 730a 2020 2020 2020 2020  batches.        
-00002aa0: 2020 2020 6261 7463 685f 696e 666f 5f6c      batch_info_l
-00002ab0: 6973 7420 3d20 5b5d 0a20 2020 2020 2020  ist = [].       
-00002ac0: 2020 2020 206e 625f 726f 7773 5f70 6572       nb_rows_per
-00002ad0: 5f62 6174 6368 203d 2072 6f75 6e64 2869  _batch = round(i
-00002ae0: 6e70 7574 5f69 6e66 6f2e 6665 6174 7572  nput_info.featur
-00002af0: 6563 6f75 6e74 202f 206e 625f 6261 7463  ecount / nb_batc
-00002b00: 6865 7329 0a20 2020 2020 2020 2020 2020  hes).           
-00002b10: 206f 6666 7365 7420 3d20 300a 2020 2020   offset = 0.    
-00002b20: 2020 2020 2020 2020 6f66 6673 6574 5f70          offset_p
-00002b30: 6572 5f62 6174 6368 203d 2072 6f75 6e64  er_batch = round
-00002b40: 2828 6d61 785f 6669 6420 2d20 6d69 6e5f  ((max_fid - min_
-00002b50: 6669 6429 202f 206e 625f 6261 7463 6865  fid) / nb_batche
-00002b60: 7329 0a20 2020 2020 2020 2020 2020 2066  s).            f
-00002b70: 6f72 2062 6174 6368 5f69 6420 696e 2072  or batch_id in r
-00002b80: 616e 6765 286e 625f 6261 7463 6865 7329  ange(nb_batches)
-00002b90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00002ba0: 2020 7374 6172 745f 6669 6420 3d20 6f66    start_fid = of
-00002bb0: 6673 6574 0a20 2020 2020 2020 2020 2020  fset.           
-00002bc0: 2020 2020 2069 6620 6261 7463 685f 6964       if batch_id
-00002bd0: 203c 2028 6e62 5f62 6174 6368 6573 202d   < (nb_batches -
-00002be0: 2031 293a 0a20 2020 2020 2020 2020 2020   1):.           
-00002bf0: 2020 2020 2020 2020 2023 2045 6e64 2066           # End f
-00002c00: 6964 2066 6f72 2074 6869 7320 6261 7463  id for this batc
-00002c10: 6820 6973 2074 6865 206e 6578 7420 7374  h is the next st
-00002c20: 6172 745f 6669 6420 2d20 310a 2020 2020  art_fid - 1.    
-00002c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002c40: 656e 645f 6669 6420 3d20 6f66 6673 6574  end_fid = offset
-00002c50: 202b 206f 6666 7365 745f 7065 725f 6261   + offset_per_ba
-00002c60: 7463 6820 2d20 310a 2020 2020 2020 2020  tch - 1.        
-00002c70: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00002c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002c90: 2020 2320 466f 7220 7468 6520 6c61 7374    # For the last
-00002ca0: 2062 6174 6368 2c20 7461 6b65 2074 6865   batch, take the
-00002cb0: 206d 6178 5f66 6964 2073 6f20 6e6f 2066   max_fid so no f
-00002cc0: 6964 2773 2061 7265 0a20 2020 2020 2020  id's are.       
-00002cd0: 2020 2020 2020 2020 2020 2020 2023 2027               # '
-00002ce0: 6c6f 7374 2720 6475 6520 746f 2072 6f75  lost' due to rou
-00002cf0: 6e64 696e 6720 6572 726f 7273 0a20 2020  nding errors.   
-00002d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002d10: 2065 6e64 5f66 6964 203d 206d 6178 5f66   end_fid = max_f
-00002d20: 6964 0a20 2020 2020 2020 2020 2020 2020  id.             
-00002d30: 2020 2062 6174 6368 5f69 6e66 6f5f 6c69     batch_info_li
-00002d40: 7374 2e61 7070 656e 6428 0a20 2020 2020  st.append(.     
-00002d50: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00002d60: 6261 7463 685f 6964 2c20 6e62 5f72 6f77  batch_id, nb_row
-00002d70: 735f 7065 725f 6261 7463 682c 2073 7461  s_per_batch, sta
-00002d80: 7274 5f66 6964 2c20 656e 645f 6669 6429  rt_fid, end_fid)
-00002d90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002da0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00002db0: 2020 206f 6666 7365 7420 2b3d 206f 6666     offset += off
-00002dc0: 7365 745f 7065 725f 6261 7463 680a 2020  set_per_batch.  
-00002dd0: 2020 2020 2020 2020 2020 6261 7463 685f            batch_
-00002de0: 696e 666f 5f64 6620 3d20 7064 2e44 6174  info_df = pd.Dat
-00002df0: 6146 7261 6d65 280a 2020 2020 2020 2020  aFrame(.        
-00002e00: 2020 2020 2020 2020 6261 7463 685f 696e          batch_in
-00002e10: 666f 5f6c 6973 742c 2063 6f6c 756d 6e73  fo_list, columns
-00002e20: 3d5b 2262 6174 6368 5f69 6422 2c20 226e  =["batch_id", "n
-00002e30: 625f 726f 7773 222c 2022 7374 6172 745f  b_rows", "start_
-00002e40: 6669 6422 2c20 2265 6e64 5f66 6964 225d  fid", "end_fid"]
-00002e50: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00002e60: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00002e70: 2020 2020 2020 2020 2023 2054 6865 2066           # The f
-00002e80: 6964 7320 6172 6520 6e6f 7420 636f 6e73  ids are not cons
-00002e90: 6563 7574 6976 652c 2073 6f20 6465 7465  ecutive, so dete
-00002ea0: 726d 696e 6520 7468 6520 6f70 7469 6d61  rmine the optima
-00002eb0: 6c20 6669 640a 2020 2020 2020 2020 2020  l fid.          
-00002ec0: 2020 2320 7261 6e67 6573 2066 6f72 2065    # ranges for e
-00002ed0: 6163 6820 6261 7463 6820 736f 2065 6163  ach batch so eac
-00002ee0: 6820 6261 7463 6820 6861 7320 7361 6d65  h batch has same
-00002ef0: 206e 756d 6265 7220 6f66 2065 6c65 6d65   number of eleme
-00002f00: 6e74 730a 2020 2020 2020 2020 2020 2020  nts.            
-00002f10: 2320 5265 6d61 726b 3a20 2d20 7468 6973  # Remark: - this
-00002f20: 206d 6967 6874 2074 616b 6520 736f 6d65   might take some
-00002f30: 2073 6563 6f6e 6473 2066 6f72 206c 6172   seconds for lar
-00002f40: 6765 7220 6461 7461 7365 7473 210a 2020  ger datasets!.  
-00002f50: 2020 2020 2020 2020 2020 2320 2020 2020            #     
-00002f60: 2020 2020 2d20 2862 6174 6368 5f69 6420      - (batch_id 
-00002f70: 2d20 3129 2041 5320 6964 2074 6f20 6d61  - 1) AS id to ma
-00002f80: 6b65 2074 6865 2069 6420 7a65 726f 2d62  ke the id zero-b
-00002f90: 6173 6564 0a20 2020 2020 2020 2020 2020  ased.           
-00002fa0: 2073 716c 5f73 746d 7420 3d20 6622 2222   sql_stmt = f"""
-00002fb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002fc0: 2053 454c 4543 5420 2862 6174 6368 5f69   SELECT (batch_i
-00002fd0: 645f 3120 2d20 3129 2041 5320 6261 7463  d_1 - 1) AS batc
-00002fe0: 685f 6964 0a20 2020 2020 2020 2020 2020  h_id.           
-00002ff0: 2020 2020 2020 2020 2020 202c 434f 554e             ,COUN
-00003000: 5428 2a29 2041 5320 6e62 5f72 6f77 730a  T(*) AS nb_rows.
-00003010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003020: 2020 2020 2020 2c4d 494e 287b 6669 645f        ,MIN({fid_
-00003030: 636f 6c75 6d6e 7d29 2041 5320 7374 6172  column}) AS star
-00003040: 745f 6669 640a 2020 2020 2020 2020 2020  t_fid.          
-00003050: 2020 2020 2020 2020 2020 2020 2c4d 4158              ,MAX
-00003060: 287b 6669 645f 636f 6c75 6d6e 7d29 2041  ({fid_column}) A
-00003070: 5320 656e 645f 6669 640a 2020 2020 2020  S end_fid.      
-00003080: 2020 2020 2020 2020 2020 2020 4652 4f4d              FROM
-00003090: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000030a0: 2020 2020 2028 2053 454c 4543 5420 7b66       ( SELECT {f
-000030b0: 6964 5f63 6f6c 756d 6e7d 0a20 2020 2020  id_column}.     
-000030c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000030d0: 2020 2020 2020 202c 4e54 494c 4528 7b6e         ,NTILE({n
-000030e0: 625f 6261 7463 6865 737d 2920 4f56 4552  b_batches}) OVER
-000030f0: 2028 4f52 4445 5220 4259 207b 6669 645f   (ORDER BY {fid_
-00003100: 636f 6c75 6d6e 7d29 2062 6174 6368 5f69  column}) batch_i
-00003110: 645f 310a 2020 2020 2020 2020 2020 2020  d_1.            
-00003120: 2020 2020 2020 2020 2020 2020 4652 4f4d              FROM
-00003130: 2022 7b69 6e70 7574 5f69 6e66 6f2e 6e61   "{input_info.na
-00003140: 6d65 7d22 0a20 2020 2020 2020 2020 2020  me}".           
-00003150: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00003160: 2020 2020 2020 2020 2020 2020 4752 4f55              GROU
-00003170: 5020 4259 2062 6174 6368 5f69 645f 313b  P BY batch_id_1;
-00003180: 0a20 2020 2020 2020 2020 2020 2022 2222  .            """
-00003190: 0a20 2020 2020 2020 2020 2020 2062 6174  .            bat
-000031a0: 6368 5f69 6e66 6f5f 6466 203d 2067 666f  ch_info_df = gfo
-000031b0: 2e72 6561 645f 6669 6c65 2870 6174 683d  .read_file(path=
-000031c0: 696e 7075 745f 7061 7468 2c20 7371 6c5f  input_path, sql_
-000031d0: 7374 6d74 3d73 716c 5f73 746d 7429 0a0a  stmt=sql_stmt)..
-000031e0: 2020 2020 2020 2020 2320 4e6f 7720 6c6f          # Now lo
-000031f0: 6f70 206f 7665 7220 616c 6c20 6261 7463  op over all batc
-00003200: 6820 7261 6e67 6573 2074 6f20 6275 696c  h ranges to buil
-00003210: 6420 7570 2074 6865 206e 6563 6573 7361  d up the necessa
-00003220: 7279 2066 696c 7465 7273 0a20 2020 2020  ry filters.     
-00003230: 2020 2066 6f72 2062 6174 6368 5f69 6e66     for batch_inf
-00003240: 6f20 696e 2062 6174 6368 5f69 6e66 6f5f  o in batch_info_
-00003250: 6466 2e69 7465 7274 7570 6c65 7328 293a  df.itertuples():
-00003260: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
-00003270: 6865 2062 6174 6368 2066 696c 7465 720a  he batch filter.
-00003280: 2020 2020 2020 2020 2020 2020 6966 2062              if b
-00003290: 6174 6368 5f69 6e66 6f2e 6261 7463 685f  atch_info.batch_
-000032a0: 6964 203c 206e 625f 6261 7463 6865 7320  id < nb_batches 
-000032b0: 2d20 313a 0a20 2020 2020 2020 2020 2020  - 1:.           
-000032c0: 2020 2020 2062 6174 6368 6573 2e61 7070       batches.app
-000032d0: 656e 6428 0a20 2020 2020 2020 2020 2020  end(.           
-000032e0: 2020 2020 2020 2020 2066 2228 7b66 6964           f"({fid
-000032f0: 5f63 6f6c 756d 6e7d 203e 3d20 7b62 6174  _column} >= {bat
-00003300: 6368 5f69 6e66 6f2e 7374 6172 745f 6669  ch_info.start_fi
-00003310: 647d 2022 0a20 2020 2020 2020 2020 2020  d} ".           
-00003320: 2020 2020 2020 2020 2066 2241 4e44 207b           f"AND {
-00003330: 6669 645f 636f 6c75 6d6e 7d20 3c3d 207b  fid_column} <= {
-00003340: 6261 7463 685f 696e 666f 2e65 6e64 5f66  batch_info.end_f
-00003350: 6964 7d29 2022 0a20 2020 2020 2020 2020  id}) ".         
-00003360: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00003370: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00003380: 2020 2020 2020 2020 2020 2062 6174 6368             batch
-00003390: 6573 2e61 7070 656e 6428 6622 7b66 6964  es.append(f"{fid
-000033a0: 5f63 6f6c 756d 6e7d 203e 3d20 7b62 6174  _column} >= {bat
-000033b0: 6368 5f69 6e66 6f2e 7374 6172 745f 6669  ch_info.start_fi
-000033c0: 647d 2022 290a 0a20 2020 2023 204e 6f20  d} ")..    # No 
-000033d0: 7573 6520 7374 6172 7469 6e67 206d 6f72  use starting mor
-000033e0: 6520 7072 6f63 6573 7365 7320 7468 616e  e processes than
-000033f0: 2074 6865 206e 756d 6265 7220 6f66 2062   the number of b
-00003400: 6174 6368 6573 2e2e 2e0a 2020 2020 6966  atches....    if
-00003410: 206c 656e 2862 6174 6368 6573 2920 3c20   len(batches) < 
-00003420: 6e62 5f70 6172 616c 6c65 6c3a 0a20 2020  nb_parallel:.   
-00003430: 2020 2020 206e 625f 7061 7261 6c6c 656c       nb_parallel
-00003440: 203d 206c 656e 2862 6174 6368 6573 290a   = len(batches).
-00003450: 0a20 2020 2072 6574 7572 6e76 616c 7565  .    returnvalue
-00003460: 203d 2050 726f 6365 7373 696e 6750 6172   = ProcessingPar
-00003470: 616d 7328 0a20 2020 2020 2020 206e 625f  ams(.        nb_
-00003480: 726f 7773 5f74 6f5f 7072 6f63 6573 733d  rows_to_process=
-00003490: 696e 7075 745f 696e 666f 2e66 6561 7475  input_info.featu
-000034a0: 7265 636f 756e 742c 0a20 2020 2020 2020  recount,.       
-000034b0: 206e 625f 7061 7261 6c6c 656c 3d6e 625f   nb_parallel=nb_
-000034c0: 7061 7261 6c6c 656c 2c0a 2020 2020 2020  parallel,.      
-000034d0: 2020 6261 7463 6865 733d 6261 7463 6865    batches=batche
-000034e0: 732c 0a20 2020 2020 2020 2062 6174 6368  s,.        batch
-000034f0: 7369 7a65 3d69 6e74 2869 6e70 7574 5f69  size=int(input_i
-00003500: 6e66 6f2e 6665 6174 7572 6563 6f75 6e74  nfo.featurecount
-00003510: 202f 206c 656e 2862 6174 6368 6573 2929   / len(batches))
-00003520: 2c0a 2020 2020 290a 0a20 2020 2069 6620  ,.    )..    if 
-00003530: 746d 705f 6469 7220 6973 206e 6f74 204e  tmp_dir is not N
-00003540: 6f6e 653a 0a20 2020 2020 2020 2072 6574  one:.        ret
-00003550: 7572 6e76 616c 7565 2e74 6f5f 6a73 6f6e  urnvalue.to_json
-00003560: 2874 6d70 5f64 6972 202f 2022 7072 6f63  (tmp_dir / "proc
-00003570: 6573 7369 6e67 5f70 6172 616d 732e 6a73  essing_params.js
-00003580: 6f6e 2229 0a20 2020 2072 6574 7572 6e20  on").    return 
-00003590: 7265 7475 726e 7661 6c75 650a 0a0a 636c  returnvalue...cl
-000035a0: 6173 7320 4765 6f4f 7065 7261 7469 6f6e  ass GeoOperation
-000035b0: 2865 6e75 6d2e 456e 756d 293a 0a20 2020  (enum.Enum):.   
-000035c0: 2053 494d 504c 4946 5920 3d20 2273 696d   SIMPLIFY = "sim
-000035d0: 706c 6966 7922 0a20 2020 2042 5546 4645  plify".    BUFFE
-000035e0: 5220 3d20 2262 7566 6665 7222 0a20 2020  R = "buffer".   
-000035f0: 2043 4f4e 5645 5848 554c 4c20 3d20 2263   CONVEXHULL = "c
-00003600: 6f6e 7665 7868 756c 6c22 0a20 2020 2041  onvexhull".    A
-00003610: 5050 4c59 203d 2022 6170 706c 7922 0a0a  PPLY = "apply"..
-00003620: 0a64 6566 2061 7070 6c79 280a 2020 2020  .def apply(.    
-00003630: 696e 7075 745f 7061 7468 3a20 5061 7468  input_path: Path
-00003640: 2c0a 2020 2020 6f75 7470 7574 5f70 6174  ,.    output_pat
-00003650: 683a 2050 6174 682c 0a20 2020 2066 756e  h: Path,.    fun
-00003660: 633a 2043 616c 6c61 626c 655b 5b41 6e79  c: Callable[[Any
-00003670: 5d2c 2041 6e79 5d2c 0a20 2020 206f 7065  ], Any],.    ope
-00003680: 7261 7469 6f6e 5f6e 616d 653a 204f 7074  ration_name: Opt
-00003690: 696f 6e61 6c5b 7374 725d 203d 204e 6f6e  ional[str] = Non
-000036a0: 652c 0a20 2020 206f 6e6c 795f 6765 6f6d  e,.    only_geom
-000036b0: 5f69 6e70 7574 3a20 626f 6f6c 203d 2054  _input: bool = T
-000036c0: 7275 652c 0a20 2020 2069 6e70 7574 5f6c  rue,.    input_l
-000036d0: 6179 6572 3a20 4f70 7469 6f6e 616c 5b73  ayer: Optional[s
-000036e0: 7472 5d20 3d20 4e6f 6e65 2c0a 2020 2020  tr] = None,.    
-000036f0: 6f75 7470 7574 5f6c 6179 6572 3a20 4f70  output_layer: Op
-00003700: 7469 6f6e 616c 5b73 7472 5d20 3d20 4e6f  tional[str] = No
-00003710: 6e65 2c0a 2020 2020 636f 6c75 6d6e 733a  ne,.    columns:
-00003720: 204f 7074 696f 6e61 6c5b 4c69 7374 5b73   Optional[List[s
-00003730: 7472 5d5d 203d 204e 6f6e 652c 0a20 2020  tr]] = None,.   
-00003740: 2065 7870 6c6f 6465 636f 6c6c 6563 7469   explodecollecti
-00003750: 6f6e 733a 2062 6f6f 6c20 3d20 4661 6c73  ons: bool = Fals
-00003760: 652c 0a20 2020 2066 6f72 6365 5f6f 7574  e,.    force_out
-00003770: 7075 745f 6765 6f6d 6574 7279 7479 7065  put_geometrytype
-00003780: 3a20 556e 696f 6e5b 4765 6f6d 6574 7279  : Union[Geometry
-00003790: 5479 7065 2c20 7374 722c 204e 6f6e 655d  Type, str, None]
-000037a0: 203d 204e 6f6e 652c 0a20 2020 2067 7269   = None,.    gri
-000037b0: 6473 697a 653a 2066 6c6f 6174 203d 2030  dsize: float = 0
-000037c0: 2e30 2c0a 2020 2020 6b65 6570 5f65 6d70  .0,.    keep_emp
-000037d0: 7479 5f67 656f 6d73 3a20 626f 6f6c 203d  ty_geoms: bool =
-000037e0: 2054 7275 652c 0a20 2020 2077 6865 7265   True,.    where
-000037f0: 5f70 6f73 743a 204f 7074 696f 6e61 6c5b  _post: Optional[
-00003800: 7374 725d 203d 204e 6f6e 652c 0a20 2020  str] = None,.   
-00003810: 206e 625f 7061 7261 6c6c 656c 3a20 696e   nb_parallel: in
-00003820: 7420 3d20 2d31 2c0a 2020 2020 6261 7463  t = -1,.    batc
-00003830: 6873 697a 653a 2069 6e74 203d 202d 312c  hsize: int = -1,
-00003840: 0a20 2020 2066 6f72 6365 3a20 626f 6f6c  .    force: bool
-00003850: 203d 2046 616c 7365 2c0a 2020 2020 7061   = False,.    pa
-00003860: 7261 6c6c 656c 697a 6174 696f 6e5f 636f  rallelization_co
-00003870: 6e66 6967 3a20 5061 7261 6c6c 656c 697a  nfig: Paralleliz
-00003880: 6174 696f 6e43 6f6e 6669 6720 3d20 4e6f  ationConfig = No
-00003890: 6e65 2c0a 293a 0a20 2020 2023 2049 6e69  ne,.):.    # Ini
-000038a0: 740a 2020 2020 6f70 6572 6174 696f 6e5f  t.    operation_
-000038b0: 7061 7261 6d73 203d 207b 0a20 2020 2020  params = {.     
-000038c0: 2020 2022 6f6e 6c79 5f67 656f 6d5f 696e     "only_geom_in
-000038d0: 7075 7422 3a20 6f6e 6c79 5f67 656f 6d5f  put": only_geom_
-000038e0: 696e 7075 742c 0a20 2020 2020 2020 2022  input,.        "
-000038f0: 7069 636b 6c65 645f 6675 6e63 223a 2063  pickled_func": c
-00003900: 6c6f 7564 7069 636b 6c65 2e64 756d 7073  loudpickle.dumps
-00003910: 2866 756e 6329 2c0a 2020 2020 7d0a 2020  (func),.    }.  
-00003920: 2020 6966 206f 7065 7261 7469 6f6e 5f6e    if operation_n
-00003930: 616d 6520 6973 206e 6f74 204e 6f6e 653a  ame is not None:
-00003940: 0a20 2020 2020 2020 206f 7065 7261 7469  .        operati
-00003950: 6f6e 5f70 6172 616d 735b 226f 7065 7261  on_params["opera
-00003960: 7469 6f6e 5f6e 616d 6522 5d20 3d20 6f70  tion_name"] = op
-00003970: 6572 6174 696f 6e5f 6e61 6d65 0a0a 2020  eration_name..  
-00003980: 2020 2320 476f 210a 2020 2020 7265 7475    # Go!.    retu
-00003990: 726e 205f 6170 706c 795f 6765 6f6f 7065  rn _apply_geoope
-000039a0: 7261 7469 6f6e 5f74 6f5f 6c61 7965 7228  ration_to_layer(
-000039b0: 0a20 2020 2020 2020 2069 6e70 7574 5f70  .        input_p
-000039c0: 6174 683d 696e 7075 745f 7061 7468 2c0a  ath=input_path,.
-000039d0: 2020 2020 2020 2020 6f75 7470 7574 5f70          output_p
-000039e0: 6174 683d 6f75 7470 7574 5f70 6174 682c  ath=output_path,
-000039f0: 0a20 2020 2020 2020 206f 7065 7261 7469  .        operati
-00003a00: 6f6e 3d47 656f 4f70 6572 6174 696f 6e2e  on=GeoOperation.
-00003a10: 4150 504c 592c 0a20 2020 2020 2020 206f  APPLY,.        o
-00003a20: 7065 7261 7469 6f6e 5f70 6172 616d 733d  peration_params=
-00003a30: 6f70 6572 6174 696f 6e5f 7061 7261 6d73  operation_params
-00003a40: 2c0a 2020 2020 2020 2020 696e 7075 745f  ,.        input_
-00003a50: 6c61 7965 723d 696e 7075 745f 6c61 7965  layer=input_laye
-00003a60: 722c 0a20 2020 2020 2020 206f 7574 7075  r,.        outpu
-00003a70: 745f 6c61 7965 723d 6f75 7470 7574 5f6c  t_layer=output_l
-00003a80: 6179 6572 2c0a 2020 2020 2020 2020 636f  ayer,.        co
-00003a90: 6c75 6d6e 733d 636f 6c75 6d6e 732c 0a20  lumns=columns,. 
-00003aa0: 2020 2020 2020 2065 7870 6c6f 6465 636f         explodeco
-00003ab0: 6c6c 6563 7469 6f6e 733d 6578 706c 6f64  llections=explod
-00003ac0: 6563 6f6c 6c65 6374 696f 6e73 2c0a 2020  ecollections,.  
-00003ad0: 2020 2020 2020 666f 7263 655f 6f75 7470        force_outp
-00003ae0: 7574 5f67 656f 6d65 7472 7974 7970 653d  ut_geometrytype=
-00003af0: 666f 7263 655f 6f75 7470 7574 5f67 656f  force_output_geo
-00003b00: 6d65 7472 7974 7970 652c 0a20 2020 2020  metrytype,.     
-00003b10: 2020 2067 7269 6473 697a 653d 6772 6964     gridsize=grid
-00003b20: 7369 7a65 2c0a 2020 2020 2020 2020 6b65  size,.        ke
-00003b30: 6570 5f65 6d70 7479 5f67 656f 6d73 3d6b  ep_empty_geoms=k
-00003b40: 6565 705f 656d 7074 795f 6765 6f6d 732c  eep_empty_geoms,
-00003b50: 0a20 2020 2020 2020 2077 6865 7265 5f70  .        where_p
-00003b60: 6f73 743d 7768 6572 655f 706f 7374 2c0a  ost=where_post,.
-00003b70: 2020 2020 2020 2020 6e62 5f70 6172 616c          nb_paral
-00003b80: 6c65 6c3d 6e62 5f70 6172 616c 6c65 6c2c  lel=nb_parallel,
-00003b90: 0a20 2020 2020 2020 2062 6174 6368 7369  .        batchsi
-00003ba0: 7a65 3d62 6174 6368 7369 7a65 2c0a 2020  ze=batchsize,.  
-00003bb0: 2020 2020 2020 666f 7263 653d 666f 7263        force=forc
-00003bc0: 652c 0a20 2020 2020 2020 2070 6172 616c  e,.        paral
-00003bd0: 6c65 6c69 7a61 7469 6f6e 5f63 6f6e 6669  lelization_confi
-00003be0: 673d 7061 7261 6c6c 656c 697a 6174 696f  g=parallelizatio
-00003bf0: 6e5f 636f 6e66 6967 2c0a 2020 2020 290a  n_config,.    ).
-00003c00: 0a0a 6465 6620 6275 6666 6572 280a 2020  ..def buffer(.  
-00003c10: 2020 696e 7075 745f 7061 7468 3a20 5061    input_path: Pa
-00003c20: 7468 2c0a 2020 2020 6f75 7470 7574 5f70  th,.    output_p
-00003c30: 6174 683a 2050 6174 682c 0a20 2020 2064  ath: Path,.    d
-00003c40: 6973 7461 6e63 653a 2066 6c6f 6174 2c0a  istance: float,.
-00003c50: 2020 2020 7175 6164 7261 6e74 7365 676d      quadrantsegm
-00003c60: 656e 7473 3a20 696e 7420 3d20 352c 0a20  ents: int = 5,. 
-00003c70: 2020 2065 6e64 6361 705f 7374 796c 653a     endcap_style:
-00003c80: 2042 7566 6665 7245 6e64 4361 7053 7479   BufferEndCapSty
-00003c90: 6c65 203d 2042 7566 6665 7245 6e64 4361  le = BufferEndCa
-00003ca0: 7053 7479 6c65 2e52 4f55 4e44 2c0a 2020  pStyle.ROUND,.  
-00003cb0: 2020 6a6f 696e 5f73 7479 6c65 3a20 4275    join_style: Bu
-00003cc0: 6666 6572 4a6f 696e 5374 796c 6520 3d20  fferJoinStyle = 
-00003cd0: 4275 6666 6572 4a6f 696e 5374 796c 652e  BufferJoinStyle.
-00003ce0: 524f 554e 442c 0a20 2020 206d 6974 7265  ROUND,.    mitre
-00003cf0: 5f6c 696d 6974 3a20 666c 6f61 7420 3d20  _limit: float = 
-00003d00: 352e 302c 0a20 2020 2073 696e 676c 655f  5.0,.    single_
-00003d10: 7369 6465 643a 2062 6f6f 6c20 3d20 4661  sided: bool = Fa
-00003d20: 6c73 652c 0a20 2020 2069 6e70 7574 5f6c  lse,.    input_l
-00003d30: 6179 6572 3a20 4f70 7469 6f6e 616c 5b73  ayer: Optional[s
-00003d40: 7472 5d20 3d20 4e6f 6e65 2c0a 2020 2020  tr] = None,.    
-00003d50: 6f75 7470 7574 5f6c 6179 6572 3a20 4f70  output_layer: Op
-00003d60: 7469 6f6e 616c 5b73 7472 5d20 3d20 4e6f  tional[str] = No
-00003d70: 6e65 2c0a 2020 2020 636f 6c75 6d6e 733a  ne,.    columns:
-00003d80: 204f 7074 696f 6e61 6c5b 4c69 7374 5b73   Optional[List[s
-00003d90: 7472 5d5d 203d 204e 6f6e 652c 0a20 2020  tr]] = None,.   
-00003da0: 2065 7870 6c6f 6465 636f 6c6c 6563 7469   explodecollecti
-00003db0: 6f6e 733a 2062 6f6f 6c20 3d20 4661 6c73  ons: bool = Fals
-00003dc0: 652c 0a20 2020 2067 7269 6473 697a 653a  e,.    gridsize:
-00003dd0: 2066 6c6f 6174 203d 2030 2e30 2c0a 2020   float = 0.0,.  
-00003de0: 2020 6b65 6570 5f65 6d70 7479 5f67 656f    keep_empty_geo
-00003df0: 6d73 3a20 626f 6f6c 203d 2054 7275 652c  ms: bool = True,
-00003e00: 0a20 2020 2077 6865 7265 5f70 6f73 743a  .    where_post:
-00003e10: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
-00003e20: 204e 6f6e 652c 0a20 2020 206e 625f 7061   None,.    nb_pa
-00003e30: 7261 6c6c 656c 3a20 696e 7420 3d20 2d31  rallel: int = -1
-00003e40: 2c0a 2020 2020 6261 7463 6873 697a 653a  ,.    batchsize:
-00003e50: 2069 6e74 203d 202d 312c 0a20 2020 2066   int = -1,.    f
-00003e60: 6f72 6365 3a20 626f 6f6c 203d 2046 616c  orce: bool = Fal
-00003e70: 7365 2c0a 2020 2020 6f70 6572 6174 696f  se,.    operatio
-00003e80: 6e5f 7072 6566 6978 3a20 7374 7220 3d20  n_prefix: str = 
-00003e90: 2222 2c0a 293a 0a20 2020 2023 2049 6e69  "",.):.    # Ini
-00003ea0: 740a 2020 2020 6f70 6572 6174 696f 6e5f  t.    operation_
-00003eb0: 7061 7261 6d73 203d 207b 0a20 2020 2020  params = {.     
-00003ec0: 2020 2022 6f70 6572 6174 696f 6e5f 6e61     "operation_na
-00003ed0: 6d65 223a 2066 227b 6f70 6572 6174 696f  me": f"{operatio
-00003ee0: 6e5f 7072 6566 6978 7d62 7566 6665 7222  n_prefix}buffer"
-00003ef0: 2c0a 2020 2020 2020 2020 2264 6973 7461  ,.        "dista
-00003f00: 6e63 6522 3a20 6469 7374 616e 6365 2c0a  nce": distance,.
-00003f10: 2020 2020 2020 2020 2271 7561 6472 616e          "quadran
-00003f20: 7473 6567 6d65 6e74 7322 3a20 7175 6164  tsegments": quad
-00003f30: 7261 6e74 7365 676d 656e 7473 2c0a 2020  rantsegments,.  
-00003f40: 2020 2020 2020 2265 6e64 6361 705f 7374        "endcap_st
-00003f50: 796c 6522 3a20 656e 6463 6170 5f73 7479  yle": endcap_sty
-00003f60: 6c65 2c0a 2020 2020 2020 2020 226a 6f69  le,.        "joi
-00003f70: 6e5f 7374 796c 6522 3a20 6a6f 696e 5f73  n_style": join_s
-00003f80: 7479 6c65 2c0a 2020 2020 2020 2020 226d  tyle,.        "m
-00003f90: 6974 7265 5f6c 696d 6974 223a 206d 6974  itre_limit": mit
-00003fa0: 7265 5f6c 696d 6974 2c0a 2020 2020 2020  re_limit,.      
-00003fb0: 2020 2273 696e 676c 655f 7369 6465 6422    "single_sided"
-00003fc0: 3a20 7369 6e67 6c65 5f73 6964 6564 2c0a  : single_sided,.
-00003fd0: 2020 2020 7d0a 0a20 2020 2023 2042 7566      }..    # Buf
-00003fe0: 6665 7220 6f70 6572 6174 696f 6e20 616c  fer operation al
-00003ff0: 7761 7973 2072 6573 756c 7473 2069 6e20  ways results in 
-00004000: 706f 6c79 676f 6e73 2e2e 2e0a 2020 2020  polygons....    
-00004010: 6966 2065 7870 6c6f 6465 636f 6c6c 6563  if explodecollec
-00004020: 7469 6f6e 733a 0a20 2020 2020 2020 2066  tions:.        f
-00004030: 6f72 6365 5f6f 7574 7075 745f 6765 6f6d  orce_output_geom
-00004040: 6574 7279 7479 7065 203d 2047 656f 6d65  etrytype = Geome
-00004050: 7472 7954 7970 652e 504f 4c59 474f 4e2e  tryType.POLYGON.
-00004060: 6e61 6d65 0a20 2020 2065 6c73 653a 0a20  name.    else:. 
-00004070: 2020 2020 2020 2066 6f72 6365 5f6f 7574         force_out
-00004080: 7075 745f 6765 6f6d 6574 7279 7479 7065  put_geometrytype
-00004090: 203d 2047 656f 6d65 7472 7954 7970 652e   = GeometryType.
-000040a0: 4d55 4c54 4950 4f4c 5947 4f4e 2e6e 616d  MULTIPOLYGON.nam
-000040b0: 650a 0a20 2020 2023 2047 6f21 0a20 2020  e..    # Go!.   
-000040c0: 2072 6574 7572 6e20 5f61 7070 6c79 5f67   return _apply_g
-000040d0: 656f 6f70 6572 6174 696f 6e5f 746f 5f6c  eooperation_to_l
-000040e0: 6179 6572 280a 2020 2020 2020 2020 696e  ayer(.        in
-000040f0: 7075 745f 7061 7468 3d69 6e70 7574 5f70  put_path=input_p
-00004100: 6174 682c 0a20 2020 2020 2020 206f 7574  ath,.        out
-00004110: 7075 745f 7061 7468 3d6f 7574 7075 745f  put_path=output_
-00004120: 7061 7468 2c0a 2020 2020 2020 2020 6f70  path,.        op
-00004130: 6572 6174 696f 6e3d 4765 6f4f 7065 7261  eration=GeoOpera
-00004140: 7469 6f6e 2e42 5546 4645 522c 0a20 2020  tion.BUFFER,.   
-00004150: 2020 2020 206f 7065 7261 7469 6f6e 5f70       operation_p
-00004160: 6172 616d 733d 6f70 6572 6174 696f 6e5f  arams=operation_
-00004170: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
-00004180: 696e 7075 745f 6c61 7965 723d 696e 7075  input_layer=inpu
-00004190: 745f 6c61 7965 722c 0a20 2020 2020 2020  t_layer,.       
-000041a0: 206f 7574 7075 745f 6c61 7965 723d 6f75   output_layer=ou
-000041b0: 7470 7574 5f6c 6179 6572 2c0a 2020 2020  tput_layer,.    
-000041c0: 2020 2020 636f 6c75 6d6e 733d 636f 6c75      columns=colu
-000041d0: 6d6e 732c 0a20 2020 2020 2020 2065 7870  mns,.        exp
-000041e0: 6c6f 6465 636f 6c6c 6563 7469 6f6e 733d  lodecollections=
-000041f0: 6578 706c 6f64 6563 6f6c 6c65 6374 696f  explodecollectio
-00004200: 6e73 2c0a 2020 2020 2020 2020 666f 7263  ns,.        forc
-00004210: 655f 6f75 7470 7574 5f67 656f 6d65 7472  e_output_geometr
-00004220: 7974 7970 653d 666f 7263 655f 6f75 7470  ytype=force_outp
-00004230: 7574 5f67 656f 6d65 7472 7974 7970 652c  ut_geometrytype,
-00004240: 0a20 2020 2020 2020 2067 7269 6473 697a  .        gridsiz
-00004250: 653d 6772 6964 7369 7a65 2c0a 2020 2020  e=gridsize,.    
-00004260: 2020 2020 6b65 6570 5f65 6d70 7479 5f67      keep_empty_g
-00004270: 656f 6d73 3d6b 6565 705f 656d 7074 795f  eoms=keep_empty_
-00004280: 6765 6f6d 732c 0a20 2020 2020 2020 2077  geoms,.        w
-00004290: 6865 7265 5f70 6f73 743d 7768 6572 655f  here_post=where_
-000042a0: 706f 7374 2c0a 2020 2020 2020 2020 6e62  post,.        nb
-000042b0: 5f70 6172 616c 6c65 6c3d 6e62 5f70 6172  _parallel=nb_par
-000042c0: 616c 6c65 6c2c 0a20 2020 2020 2020 2062  allel,.        b
-000042d0: 6174 6368 7369 7a65 3d62 6174 6368 7369  atchsize=batchsi
-000042e0: 7a65 2c0a 2020 2020 2020 2020 666f 7263  ze,.        forc
-000042f0: 653d 666f 7263 652c 0a20 2020 2029 0a0a  e=force,.    )..
-00004300: 0a64 6566 2063 6f6e 7665 7868 756c 6c28  .def convexhull(
-00004310: 0a20 2020 2069 6e70 7574 5f70 6174 683a  .    input_path:
-00004320: 2050 6174 682c 0a20 2020 206f 7574 7075   Path,.    outpu
-00004330: 745f 7061 7468 3a20 5061 7468 2c0a 2020  t_path: Path,.  
-00004340: 2020 696e 7075 745f 6c61 7965 723a 204f    input_layer: O
-00004350: 7074 696f 6e61 6c5b 7374 725d 203d 204e  ptional[str] = N
-00004360: 6f6e 652c 0a20 2020 206f 7574 7075 745f  one,.    output_
-00004370: 6c61 7965 723a 204f 7074 696f 6e61 6c5b  layer: Optional[
-00004380: 7374 725d 203d 204e 6f6e 652c 0a20 2020  str] = None,.   
-00004390: 2063 6f6c 756d 6e73 3a20 4f70 7469 6f6e   columns: Option
-000043a0: 616c 5b4c 6973 745b 7374 725d 5d20 3d20  al[List[str]] = 
-000043b0: 4e6f 6e65 2c0a 2020 2020 6578 706c 6f64  None,.    explod
-000043c0: 6563 6f6c 6c65 6374 696f 6e73 3a20 626f  ecollections: bo
-000043d0: 6f6c 203d 2046 616c 7365 2c0a 2020 2020  ol = False,.    
-000043e0: 6772 6964 7369 7a65 3a20 666c 6f61 7420  gridsize: float 
-000043f0: 3d20 302e 302c 0a20 2020 206b 6565 705f  = 0.0,.    keep_
-00004400: 656d 7074 795f 6765 6f6d 733a 2062 6f6f  empty_geoms: boo
-00004410: 6c20 3d20 5472 7565 2c0a 2020 2020 7768  l = True,.    wh
-00004420: 6572 655f 706f 7374 3a20 4f70 7469 6f6e  ere_post: Option
-00004430: 616c 5b73 7472 5d20 3d20 4e6f 6e65 2c0a  al[str] = None,.
-00004440: 2020 2020 6e62 5f70 6172 616c 6c65 6c3a      nb_parallel:
-00004450: 2069 6e74 203d 202d 312c 0a20 2020 2062   int = -1,.    b
-00004460: 6174 6368 7369 7a65 3a20 696e 7420 3d20  atchsize: int = 
-00004470: 2d31 2c0a 2020 2020 666f 7263 653a 2062  -1,.    force: b
-00004480: 6f6f 6c20 3d20 4661 6c73 652c 0a29 3a0a  ool = False,.):.
-00004490: 2020 2020 2320 496e 6974 0a20 2020 206f      # Init.    o
-000044a0: 7065 7261 7469 6f6e 5f70 6172 616d 733a  peration_params:
-000044b0: 2044 6963 745b 7374 722c 2041 6e79 5d20   Dict[str, Any] 
-000044c0: 3d20 7b7d 0a0a 2020 2020 2320 476f 210a  = {}..    # Go!.
-000044d0: 2020 2020 7265 7475 726e 205f 6170 706c      return _appl
-000044e0: 795f 6765 6f6f 7065 7261 7469 6f6e 5f74  y_geooperation_t
-000044f0: 6f5f 6c61 7965 7228 0a20 2020 2020 2020  o_layer(.       
-00004500: 2069 6e70 7574 5f70 6174 683d 696e 7075   input_path=inpu
-00004510: 745f 7061 7468 2c0a 2020 2020 2020 2020  t_path,.        
-00004520: 6f75 7470 7574 5f70 6174 683d 6f75 7470  output_path=outp
-00004530: 7574 5f70 6174 682c 0a20 2020 2020 2020  ut_path,.       
-00004540: 206f 7065 7261 7469 6f6e 3d47 656f 4f70   operation=GeoOp
-00004550: 6572 6174 696f 6e2e 434f 4e56 4558 4855  eration.CONVEXHU
-00004560: 4c4c 2c0a 2020 2020 2020 2020 6f70 6572  LL,.        oper
-00004570: 6174 696f 6e5f 7061 7261 6d73 3d6f 7065  ation_params=ope
-00004580: 7261 7469 6f6e 5f70 6172 616d 732c 0a20  ration_params,. 
-00004590: 2020 2020 2020 2069 6e70 7574 5f6c 6179         input_lay
-000045a0: 6572 3d69 6e70 7574 5f6c 6179 6572 2c0a  er=input_layer,.
-000045b0: 2020 2020 2020 2020 6f75 7470 7574 5f6c          output_l
-000045c0: 6179 6572 3d6f 7574 7075 745f 6c61 7965  ayer=output_laye
-000045d0: 722c 0a20 2020 2020 2020 2063 6f6c 756d  r,.        colum
-000045e0: 6e73 3d63 6f6c 756d 6e73 2c0a 2020 2020  ns=columns,.    
-000045f0: 2020 2020 6578 706c 6f64 6563 6f6c 6c65      explodecolle
-00004600: 6374 696f 6e73 3d65 7870 6c6f 6465 636f  ctions=explodeco
-00004610: 6c6c 6563 7469 6f6e 732c 0a20 2020 2020  llections,.     
-00004620: 2020 2066 6f72 6365 5f6f 7574 7075 745f     force_output_
-00004630: 6765 6f6d 6574 7279 7479 7065 3d4e 6f6e  geometrytype=Non
-00004640: 652c 0a20 2020 2020 2020 2067 7269 6473  e,.        grids
-00004650: 697a 653d 6772 6964 7369 7a65 2c0a 2020  ize=gridsize,.  
-00004660: 2020 2020 2020 6b65 6570 5f65 6d70 7479        keep_empty
-00004670: 5f67 656f 6d73 3d6b 6565 705f 656d 7074  _geoms=keep_empt
-00004680: 795f 6765 6f6d 732c 0a20 2020 2020 2020  y_geoms,.       
-00004690: 2077 6865 7265 5f70 6f73 743d 7768 6572   where_post=wher
-000046a0: 655f 706f 7374 2c0a 2020 2020 2020 2020  e_post,.        
-000046b0: 6e62 5f70 6172 616c 6c65 6c3d 6e62 5f70  nb_parallel=nb_p
-000046c0: 6172 616c 6c65 6c2c 0a20 2020 2020 2020  arallel,.       
-000046d0: 2062 6174 6368 7369 7a65 3d62 6174 6368   batchsize=batch
-000046e0: 7369 7a65 2c0a 2020 2020 2020 2020 666f  size,.        fo
-000046f0: 7263 653d 666f 7263 652c 0a20 2020 2029  rce=force,.    )
-00004700: 0a0a 0a64 6566 206d 616b 6576 616c 6964  ...def makevalid
-00004710: 280a 2020 2020 696e 7075 745f 7061 7468  (.    input_path
-00004720: 3a20 5061 7468 2c0a 2020 2020 6f75 7470  : Path,.    outp
-00004730: 7574 5f70 6174 683a 2050 6174 682c 0a20  ut_path: Path,. 
-00004740: 2020 2069 6e70 7574 5f6c 6179 6572 3a20     input_layer: 
-00004750: 4f70 7469 6f6e 616c 5b73 7472 5d20 3d20  Optional[str] = 
-00004760: 4e6f 6e65 2c0a 2020 2020 6f75 7470 7574  None,.    output
-00004770: 5f6c 6179 6572 3a20 4f70 7469 6f6e 616c  _layer: Optional
-00004780: 5b73 7472 5d20 3d20 4e6f 6e65 2c0a 2020  [str] = None,.  
-00004790: 2020 636f 6c75 6d6e 733a 204f 7074 696f    columns: Optio
-000047a0: 6e61 6c5b 4c69 7374 5b73 7472 5d5d 203d  nal[List[str]] =
-000047b0: 204e 6f6e 652c 0a20 2020 2065 7870 6c6f   None,.    explo
-000047c0: 6465 636f 6c6c 6563 7469 6f6e 733a 2062  decollections: b
-000047d0: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
-000047e0: 2066 6f72 6365 5f6f 7574 7075 745f 6765   force_output_ge
-000047f0: 6f6d 6574 7279 7479 7065 3a20 4f70 7469  ometrytype: Opti
-00004800: 6f6e 616c 5b47 656f 6d65 7472 7954 7970  onal[GeometryTyp
-00004810: 655d 203d 204e 6f6e 652c 0a20 2020 2067  e] = None,.    g
-00004820: 7269 6473 697a 653a 2066 6c6f 6174 203d  ridsize: float =
-00004830: 2030 2e30 2c0a 2020 2020 6b65 6570 5f65   0.0,.    keep_e
-00004840: 6d70 7479 5f67 656f 6d73 3a20 626f 6f6c  mpty_geoms: bool
-00004850: 203d 2054 7275 652c 0a20 2020 2077 6865   = True,.    whe
-00004860: 7265 5f70 6f73 743a 204f 7074 696f 6e61  re_post: Optiona
-00004870: 6c5b 7374 725d 203d 204e 6f6e 652c 0a20  l[str] = None,. 
-00004880: 2020 2076 616c 6964 6174 655f 6174 7472     validate_attr
-00004890: 6962 7574 655f 6461 7461 3a20 626f 6f6c  ibute_data: bool
-000048a0: 203d 2046 616c 7365 2c0a 2020 2020 6e62   = False,.    nb
-000048b0: 5f70 6172 616c 6c65 6c3a 2069 6e74 203d  _parallel: int =
-000048c0: 202d 312c 0a20 2020 2062 6174 6368 7369   -1,.    batchsi
-000048d0: 7a65 3a20 696e 7420 3d20 2d31 2c0a 2020  ze: int = -1,.  
-000048e0: 2020 666f 7263 653a 2062 6f6f 6c20 3d20    force: bool = 
-000048f0: 4661 6c73 652c 0a29 3a0a 2020 2020 2320  False,.):.    # 
-00004900: 4465 7465 726d 696e 6520 6966 2063 6f6c  Determine if col
-00004910: 6c61 7073 6564 2070 6172 7473 206e 6565  lapsed parts nee
-00004920: 6420 746f 2062 6520 6b65 7074 2061 6674  d to be kept aft
-00004930: 6572 206d 616b 6576 616c 6964 206f 7220  er makevalid or 
-00004940: 6e6f 740a 2020 2020 6b65 6570 5f63 6f6c  not.    keep_col
-00004950: 6c61 7073 6564 203d 2054 7275 650a 2020  lapsed = True.  
-00004960: 2020 6966 2066 6f72 6365 5f6f 7574 7075    if force_outpu
-00004970: 745f 6765 6f6d 6574 7279 7479 7065 2069  t_geometrytype i
-00004980: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-00004990: 6b65 6570 5f63 6f6c 6c61 7073 6564 203d  keep_collapsed =
-000049a0: 2046 616c 7365 0a20 2020 2065 6c73 653a   False.    else:
-000049b0: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
-000049c0: 7374 616e 6365 2866 6f72 6365 5f6f 7574  stance(force_out
-000049d0: 7075 745f 6765 6f6d 6574 7279 7479 7065  put_geometrytype
-000049e0: 2c20 4765 6f6d 6574 7279 5479 7065 293a  , GeometryType):
-000049f0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00004a00: 6365 5f6f 7574 7075 745f 6765 6f6d 6574  ce_output_geomet
-00004a10: 7279 7479 7065 203d 2066 6f72 6365 5f6f  rytype = force_o
-00004a20: 7574 7075 745f 6765 6f6d 6574 7279 7479  utput_geometryty
-00004a30: 7065 2e6e 616d 650a 2020 2020 2020 2020  pe.name.        
-00004a40: 696e 666f 203d 2066 696c 656f 7073 2e67  info = fileops.g
-00004a50: 6574 5f6c 6179 6572 696e 666f 2869 6e70  et_layerinfo(inp
-00004a60: 7574 5f70 6174 6829 0a20 2020 2020 2020  ut_path).       
-00004a70: 2069 6620 666f 7263 655f 6f75 7470 7574   if force_output
-00004a80: 5f67 656f 6d65 7472 7974 7970 652e 7374  _geometrytype.st
-00004a90: 6172 7473 7769 7468 280a 2020 2020 2020  artswith(.      
-00004aa0: 2020 2020 2020 696e 666f 2e67 656f 6d65        info.geome
-00004ab0: 7472 7974 7970 656e 616d 650a 2020 2020  trytypename.    
-00004ac0: 2020 2020 2920 6f72 2069 6e66 6f2e 6765      ) or info.ge
-00004ad0: 6f6d 6574 7279 7479 7065 6e61 6d65 2e73  ometrytypename.s
-00004ae0: 7461 7274 7377 6974 6828 666f 7263 655f  tartswith(force_
-00004af0: 6f75 7470 7574 5f67 656f 6d65 7472 7974  output_geometryt
-00004b00: 7970 6529 3a0a 2020 2020 2020 2020 2020  ype):.          
-00004b10: 2020 6b65 6570 5f63 6f6c 6c61 7073 6564    keep_collapsed
-00004b20: 203d 2046 616c 7365 0a0a 2020 2020 6170   = False..    ap
-00004b30: 706c 7928 0a20 2020 2020 2020 2069 6e70  ply(.        inp
-00004b40: 7574 5f70 6174 683d 5061 7468 2869 6e70  ut_path=Path(inp
-00004b50: 7574 5f70 6174 6829 2c0a 2020 2020 2020  ut_path),.      
-00004b60: 2020 6f75 7470 7574 5f70 6174 683d 5061    output_path=Pa
-00004b70: 7468 286f 7574 7075 745f 7061 7468 292c  th(output_path),
-00004b80: 0a20 2020 2020 2020 2066 756e 633d 6c61  .        func=la
-00004b90: 6d62 6461 2067 656f 6d3a 2070 7967 656f  mbda geom: pygeo
-00004ba0: 6f70 732e 6d61 6b65 5f76 616c 6964 280a  ops.make_valid(.
-00004bb0: 2020 2020 2020 2020 2020 2020 6765 6f6d              geom
-00004bc0: 2c20 6b65 6570 5f63 6f6c 6c61 7073 6564  , keep_collapsed
-00004bd0: 3d6b 6565 705f 636f 6c6c 6170 7365 642c  =keep_collapsed,
-00004be0: 206f 6e6c 795f 6966 5f69 6e76 616c 6964   only_if_invalid
-00004bf0: 3d54 7275 650a 2020 2020 2020 2020 292c  =True.        ),
-00004c00: 0a20 2020 2020 2020 206f 7065 7261 7469  .        operati
-00004c10: 6f6e 5f6e 616d 653d 226d 616b 6576 616c  on_name="makeval
-00004c20: 6964 222c 0a20 2020 2020 2020 2069 6e70  id",.        inp
-00004c30: 7574 5f6c 6179 6572 3d69 6e70 7574 5f6c  ut_layer=input_l
-00004c40: 6179 6572 2c0a 2020 2020 2020 2020 6f75  ayer,.        ou
-00004c50: 7470 7574 5f6c 6179 6572 3d6f 7574 7075  tput_layer=outpu
-00004c60: 745f 6c61 7965 722c 0a20 2020 2020 2020  t_layer,.       
-00004c70: 2063 6f6c 756d 6e73 3d63 6f6c 756d 6e73   columns=columns
-00004c80: 2c0a 2020 2020 2020 2020 6578 706c 6f64  ,.        explod
-00004c90: 6563 6f6c 6c65 6374 696f 6e73 3d65 7870  ecollections=exp
-00004ca0: 6c6f 6465 636f 6c6c 6563 7469 6f6e 732c  lodecollections,
-00004cb0: 0a20 2020 2020 2020 2066 6f72 6365 5f6f  .        force_o
-00004cc0: 7574 7075 745f 6765 6f6d 6574 7279 7479  utput_geometryty
-00004cd0: 7065 3d66 6f72 6365 5f6f 7574 7075 745f  pe=force_output_
-00004ce0: 6765 6f6d 6574 7279 7479 7065 2c0a 2020  geometrytype,.  
-00004cf0: 2020 2020 2020 6772 6964 7369 7a65 3d67        gridsize=g
-00004d00: 7269 6473 697a 652c 0a20 2020 2020 2020  ridsize,.       
-00004d10: 206b 6565 705f 656d 7074 795f 6765 6f6d   keep_empty_geom
-00004d20: 733d 6b65 6570 5f65 6d70 7479 5f67 656f  s=keep_empty_geo
-00004d30: 6d73 2c0a 2020 2020 2020 2020 7768 6572  ms,.        wher
-00004d40: 655f 706f 7374 3d77 6865 7265 5f70 6f73  e_post=where_pos
-00004d50: 742c 0a20 2020 2020 2020 206e 625f 7061  t,.        nb_pa
-00004d60: 7261 6c6c 656c 3d6e 625f 7061 7261 6c6c  rallel=nb_parall
-00004d70: 656c 2c0a 2020 2020 2020 2020 6261 7463  el,.        batc
-00004d80: 6873 697a 653d 6261 7463 6873 697a 652c  hsize=batchsize,
-00004d90: 0a20 2020 2020 2020 2066 6f72 6365 3d66  .        force=f
-00004da0: 6f72 6365 2c0a 2020 2020 290a 0a0a 6465  orce,.    )...de
-00004db0: 6620 7369 6d70 6c69 6679 280a 2020 2020  f simplify(.    
-00004dc0: 696e 7075 745f 7061 7468 3a20 5061 7468  input_path: Path
-00004dd0: 2c0a 2020 2020 6f75 7470 7574 5f70 6174  ,.    output_pat
-00004de0: 683a 2050 6174 682c 0a20 2020 2074 6f6c  h: Path,.    tol
-00004df0: 6572 616e 6365 3a20 666c 6f61 742c 0a20  erance: float,. 
-00004e00: 2020 2061 6c67 6f72 6974 686d 3a20 5369     algorithm: Si
-00004e10: 6d70 6c69 6679 416c 676f 7269 7468 6d20  mplifyAlgorithm 
-00004e20: 3d20 5369 6d70 6c69 6679 416c 676f 7269  = SimplifyAlgori
-00004e30: 7468 6d2e 5241 4d45 525f 444f 5547 4c41  thm.RAMER_DOUGLA
-00004e40: 535f 5045 5543 4b45 522c 0a20 2020 206c  S_PEUCKER,.    l
-00004e50: 6f6f 6b61 6865 6164 3a20 696e 7420 3d20  ookahead: int = 
-00004e60: 382c 0a20 2020 2069 6e70 7574 5f6c 6179  8,.    input_lay
-00004e70: 6572 3a20 4f70 7469 6f6e 616c 5b73 7472  er: Optional[str
-00004e80: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 6f75  ] = None,.    ou
-00004e90: 7470 7574 5f6c 6179 6572 3a20 4f70 7469  tput_layer: Opti
-00004ea0: 6f6e 616c 5b73 7472 5d20 3d20 4e6f 6e65  onal[str] = None
-00004eb0: 2c0a 2020 2020 636f 6c75 6d6e 733a 204f  ,.    columns: O
-00004ec0: 7074 696f 6e61 6c5b 4c69 7374 5b73 7472  ptional[List[str
-00004ed0: 5d5d 203d 204e 6f6e 652c 0a20 2020 2065  ]] = None,.    e
-00004ee0: 7870 6c6f 6465 636f 6c6c 6563 7469 6f6e  xplodecollection
-00004ef0: 733a 2062 6f6f 6c20 3d20 4661 6c73 652c  s: bool = False,
-00004f00: 0a20 2020 2067 7269 6473 697a 653a 2066  .    gridsize: f
-00004f10: 6c6f 6174 203d 2030 2e30 2c0a 2020 2020  loat = 0.0,.    
-00004f20: 6b65 6570 5f65 6d70 7479 5f67 656f 6d73  keep_empty_geoms
-00004f30: 3a20 626f 6f6c 203d 2054 7275 652c 0a20  : bool = True,. 
-00004f40: 2020 2077 6865 7265 5f70 6f73 743a 204f     where_post: O
-00004f50: 7074 696f 6e61 6c5b 7374 725d 203d 204e  ptional[str] = N
-00004f60: 6f6e 652c 0a20 2020 206e 625f 7061 7261  one,.    nb_para
-00004f70: 6c6c 656c 3a20 696e 7420 3d20 2d31 2c0a  llel: int = -1,.
-00004f80: 2020 2020 6261 7463 6873 697a 653a 2069      batchsize: i
-00004f90: 6e74 203d 202d 312c 0a20 2020 2066 6f72  nt = -1,.    for
-00004fa0: 6365 3a20 626f 6f6c 203d 2046 616c 7365  ce: bool = False
-00004fb0: 2c0a 293a 0a20 2020 2023 2049 6e69 740a  ,.):.    # Init.
-00004fc0: 2020 2020 6f70 6572 6174 696f 6e5f 7061      operation_pa
-00004fd0: 7261 6d73 203d 207b 0a20 2020 2020 2020  rams = {.       
-00004fe0: 2022 746f 6c65 7261 6e63 6522 3a20 746f   "tolerance": to
-00004ff0: 6c65 7261 6e63 652c 0a20 2020 2020 2020  lerance,.       
-00005000: 2022 616c 676f 7269 7468 6d22 3a20 616c   "algorithm": al
-00005010: 676f 7269 7468 6d2c 0a20 2020 2020 2020  gorithm,.       
-00005020: 2022 7374 6570 223a 206c 6f6f 6b61 6865   "step": lookahe
-00005030: 6164 2c0a 2020 2020 7d0a 0a20 2020 2023  ad,.    }..    #
-00005040: 2047 6f21 0a20 2020 2072 6574 7572 6e20   Go!.    return 
-00005050: 5f61 7070 6c79 5f67 656f 6f70 6572 6174  _apply_geooperat
-00005060: 696f 6e5f 746f 5f6c 6179 6572 280a 2020  ion_to_layer(.  
-00005070: 2020 2020 2020 696e 7075 745f 7061 7468        input_path
-00005080: 3d69 6e70 7574 5f70 6174 682c 0a20 2020  =input_path,.   
-00005090: 2020 2020 206f 7574 7075 745f 7061 7468       output_path
-000050a0: 3d6f 7574 7075 745f 7061 7468 2c0a 2020  =output_path,.  
-000050b0: 2020 2020 2020 6f70 6572 6174 696f 6e3d        operation=
-000050c0: 4765 6f4f 7065 7261 7469 6f6e 2e53 494d  GeoOperation.SIM
-000050d0: 504c 4946 592c 0a20 2020 2020 2020 206f  PLIFY,.        o
-000050e0: 7065 7261 7469 6f6e 5f70 6172 616d 733d  peration_params=
-000050f0: 6f70 6572 6174 696f 6e5f 7061 7261 6d73  operation_params
-00005100: 2c0a 2020 2020 2020 2020 696e 7075 745f  ,.        input_
-00005110: 6c61 7965 723d 696e 7075 745f 6c61 7965  layer=input_laye
-00005120: 722c 0a20 2020 2020 2020 206f 7574 7075  r,.        outpu
-00005130: 745f 6c61 7965 723d 6f75 7470 7574 5f6c  t_layer=output_l
-00005140: 6179 6572 2c0a 2020 2020 2020 2020 636f  ayer,.        co
-00005150: 6c75 6d6e 733d 636f 6c75 6d6e 732c 0a20  lumns=columns,. 
-00005160: 2020 2020 2020 2065 7870 6c6f 6465 636f         explodeco
-00005170: 6c6c 6563 7469 6f6e 733d 6578 706c 6f64  llections=explod
-00005180: 6563 6f6c 6c65 6374 696f 6e73 2c0a 2020  ecollections,.  
-00005190: 2020 2020 2020 666f 7263 655f 6f75 7470        force_outp
-000051a0: 7574 5f67 656f 6d65 7472 7974 7970 653d  ut_geometrytype=
-000051b0: 4e6f 6e65 2c0a 2020 2020 2020 2020 6772  None,.        gr
-000051c0: 6964 7369 7a65 3d67 7269 6473 697a 652c  idsize=gridsize,
-000051d0: 0a20 2020 2020 2020 206b 6565 705f 656d  .        keep_em
-000051e0: 7074 795f 6765 6f6d 733d 6b65 6570 5f65  pty_geoms=keep_e
-000051f0: 6d70 7479 5f67 656f 6d73 2c0a 2020 2020  mpty_geoms,.    
-00005200: 2020 2020 7768 6572 655f 706f 7374 3d77      where_post=w
-00005210: 6865 7265 5f70 6f73 742c 0a20 2020 2020  here_post,.     
-00005220: 2020 206e 625f 7061 7261 6c6c 656c 3d6e     nb_parallel=n
-00005230: 625f 7061 7261 6c6c 656c 2c0a 2020 2020  b_parallel,.    
-00005240: 2020 2020 6261 7463 6873 697a 653d 6261      batchsize=ba
-00005250: 7463 6873 697a 652c 0a20 2020 2020 2020  tchsize,.       
-00005260: 2066 6f72 6365 3d66 6f72 6365 2c0a 2020   force=force,.  
-00005270: 2020 290a 0a0a 6465 6620 5f61 7070 6c79    )...def _apply
-00005280: 5f67 656f 6f70 6572 6174 696f 6e5f 746f  _geooperation_to
-00005290: 5f6c 6179 6572 280a 2020 2020 696e 7075  _layer(.    inpu
-000052a0: 745f 7061 7468 3a20 5061 7468 2c0a 2020  t_path: Path,.  
-000052b0: 2020 6f75 7470 7574 5f70 6174 683a 2050    output_path: P
-000052c0: 6174 682c 0a20 2020 206f 7065 7261 7469  ath,.    operati
-000052d0: 6f6e 3a20 4765 6f4f 7065 7261 7469 6f6e  on: GeoOperation
-000052e0: 2c0a 2020 2020 6f70 6572 6174 696f 6e5f  ,.    operation_
-000052f0: 7061 7261 6d73 3a20 6469 6374 2c0a 2020  params: dict,.  
-00005300: 2020 696e 7075 745f 6c61 7965 723a 204f    input_layer: O
-00005310: 7074 696f 6e61 6c5b 7374 725d 2c20 2023  ptional[str],  #
-00005320: 203d 204e 6f6e 650a 2020 2020 636f 6c75   = None.    colu
-00005330: 6d6e 733a 204f 7074 696f 6e61 6c5b 4c69  mns: Optional[Li
-00005340: 7374 5b73 7472 5d5d 2c20 2023 203d 204e  st[str]],  # = N
-00005350: 6f6e 650a 2020 2020 6f75 7470 7574 5f6c  one.    output_l
-00005360: 6179 6572 3a20 4f70 7469 6f6e 616c 5b73  ayer: Optional[s
-00005370: 7472 5d2c 2020 2320 3d20 4e6f 6e65 0a20  tr],  # = None. 
-00005380: 2020 2065 7870 6c6f 6465 636f 6c6c 6563     explodecollec
-00005390: 7469 6f6e 733a 2062 6f6f 6c2c 2020 2320  tions: bool,  # 
-000053a0: 3d20 4661 6c73 650a 2020 2020 666f 7263  = False.    forc
-000053b0: 655f 6f75 7470 7574 5f67 656f 6d65 7472  e_output_geometr
-000053c0: 7974 7970 653a 2055 6e69 6f6e 5b47 656f  ytype: Union[Geo
-000053d0: 6d65 7472 7954 7970 652c 2073 7472 2c20  metryType, str, 
-000053e0: 4e6f 6e65 5d2c 2020 2320 3d20 4e6f 6e65  None],  # = None
-000053f0: 0a20 2020 2067 7269 6473 697a 653a 2066  .    gridsize: f
-00005400: 6c6f 6174 2c20 2023 203d 2030 2e30 0a20  loat,  # = 0.0. 
-00005410: 2020 206b 6565 705f 656d 7074 795f 6765     keep_empty_ge
-00005420: 6f6d 733a 2062 6f6f 6c2c 2020 2320 3d20  oms: bool,  # = 
-00005430: 5472 7565 0a20 2020 2077 6865 7265 5f70  True.    where_p
-00005440: 6f73 743a 204f 7074 696f 6e61 6c5b 7374  ost: Optional[st
-00005450: 725d 2c20 2023 203d 204e 6f6e 650a 2020  r],  # = None.  
-00005460: 2020 6e62 5f70 6172 616c 6c65 6c3a 2069    nb_parallel: i
-00005470: 6e74 2c20 2023 203d 202d 310a 2020 2020  nt,  # = -1.    
-00005480: 6261 7463 6873 697a 653a 2069 6e74 2c20  batchsize: int, 
-00005490: 2023 203d 202d 310a 2020 2020 666f 7263   # = -1.    forc
-000054a0: 653a 2062 6f6f 6c2c 2020 2320 3d20 4661  e: bool,  # = Fa
-000054b0: 6c73 650a 2020 2020 7061 7261 6c6c 656c  lse.    parallel
-000054c0: 697a 6174 696f 6e5f 636f 6e66 6967 3a20  ization_config: 
-000054d0: 5061 7261 6c6c 656c 697a 6174 696f 6e43  ParallelizationC
-000054e0: 6f6e 6669 6720 3d20 4e6f 6e65 2c0a 293a  onfig = None,.):
-000054f0: 0a20 2020 2022 2222 0a20 2020 2041 7070  .    """.    App
-00005500: 6c69 6573 2061 2067 656f 206f 7065 7261  lies a geo opera
-00005510: 7469 6f6e 206f 6e20 6120 6c61 7965 722e  tion on a layer.
-00005520: 0a0a 2020 2020 5468 6520 6f70 6572 6174  ..    The operat
-00005530: 696f 6e20 746f 2061 7070 6c79 2063 616e  ion to apply can
-00005540: 2062 6520 6f6e 6520 6f66 2074 6865 2074   be one of the t
-00005550: 6865 2066 6f6c 6c6f 7769 6e67 3a0a 2020  he following:.  
-00005560: 2020 2020 2d20 4255 4646 4552 3a20 6170      - BUFFER: ap
-00005570: 706c 7920 6120 6275 6666 6572 2e20 4f70  ply a buffer. Op
-00005580: 6572 6174 696f 6e20 7061 7261 6d65 7465  eration paramete
-00005590: 7273 3a0a 2020 2020 2020 2020 2020 2d20  rs:.          - 
-000055a0: 6469 7374 616e 6365 3a20 6469 7374 616e  distance: distan
-000055b0: 6365 2074 6f20 6275 6666 6572 0a20 2020  ce to buffer.   
-000055c0: 2020 2020 2020 202d 2071 7561 6472 616e         - quadran
-000055d0: 7473 6567 6d65 6e74 733a 206e 756d 6265  tsegments: numbe
-000055e0: 7220 6f66 2070 6f69 6e74 7320 7573 6564  r of points used
-000055f0: 2074 6f20 7265 7072 6573 656e 7420 312f   to represent 1/
-00005600: 3420 6f66 2061 2063 6972 636c 650a 2020  4 of a circle.  
-00005610: 2020 2020 2020 2020 2d20 656e 6463 6170          - endcap
-00005620: 5f73 7479 6c65 3a20 6275 6666 6572 2073  _style: buffer s
-00005630: 7479 6c65 2074 6f20 7573 6520 666f 7220  tyle to use for 
-00005640: 6120 706f 696e 7420 6f72 2074 6865 2065  a point or the e
-00005650: 6e64 2070 6f69 6e74 7320 6f66 0a20 2020  nd points of.   
-00005660: 2020 2020 2020 2020 2061 206c 696e 653a           a line:
-00005670: 0a20 2020 2020 2020 2020 2020 202d 2052  .            - R
-00005680: 4f55 4e44 3a20 666f 7220 706f 696e 7473  OUND: for points
-00005690: 2061 6e64 206c 696e 6573 2074 6865 2065   and lines the e
-000056a0: 6e64 7320 6172 6520 6275 6666 6572 6564  nds are buffered
-000056b0: 2072 6f75 6e64 6564 2e0a 2020 2020 2020   rounded..      
-000056c0: 2020 2020 2020 2d20 464c 4154 3a20 6120        - FLAT: a 
-000056d0: 706f 696e 7420 7374 6179 7320 6120 706f  point stays a po
-000056e0: 696e 742c 2061 2062 7566 6665 7265 6420  int, a buffered 
-000056f0: 6c69 6e65 2077 696c 6c20 656e 6420 666c  line will end fl
-00005700: 6174 0a20 2020 2020 2020 2020 2020 2020  at.             
-00005710: 2061 7420 7468 6520 656e 6420 706f 696e   at the end poin
-00005720: 7473 0a20 2020 2020 2020 2020 2020 202d  ts.            -
-00005730: 2053 5155 4152 453a 2061 2070 6f69 6e74   SQUARE: a point
-00005740: 2062 6563 6f6d 6573 2061 2073 7175 6172   becomes a squar
-00005750: 652c 2061 2062 7566 6665 7265 6420 6c69  e, a buffered li
-00005760: 6e65 2077 696c 6c20 656e 640a 2020 2020  ne will end.    
-00005770: 2020 2020 2020 2020 2020 666c 6174 2061            flat a
-00005780: 7420 7468 6520 656e 6420 706f 696e 7473  t the end points
-00005790: 2c20 6275 7420 656c 6f6e 6761 7465 6420  , but elongated 
-000057a0: 6279 2022 6469 7374 616e 6365 220a 2020  by "distance".  
-000057b0: 2020 2020 2020 2d20 6a6f 696e 5f73 7479        - join_sty
-000057c0: 6c65 3a20 6275 6666 6572 2073 7479 6c65  le: buffer style
-000057d0: 2074 6f20 7573 6520 666f 7220 636f 726e   to use for corn
-000057e0: 6572 7320 696e 2061 206c 696e 6520 6f72  ers in a line or
-000057f0: 2061 2070 6f6c 7967 6f6e 0a20 2020 2020   a polygon.     
-00005800: 2020 2020 2062 6f75 6e64 6172 793a 0a20       boundary:. 
-00005810: 2020 2020 2020 2020 2020 202d 2052 4f55             - ROU
-00005820: 4e44 3a20 636f 726e 6572 7320 696e 2074  ND: corners in t
-00005830: 6865 2072 6573 756c 7420 6172 6520 726f  he result are ro
-00005840: 756e 6465 640a 2020 2020 2020 2020 2020  unded.          
-00005850: 2020 2d20 4d49 5452 453a 2063 6f72 6e65    - MITRE: corne
-00005860: 7273 2069 6e20 7468 6520 7265 7375 6c74  rs in the result
-00005870: 2061 7265 2073 6861 7270 0a20 2020 2020   are sharp.     
-00005880: 2020 2020 2020 202d 2042 4556 454c 3a20         - BEVEL: 
-00005890: 6172 6520 666c 6174 7465 6e65 640a 2020  are flattened.  
-000058a0: 2020 2020 2020 2d20 6d69 7472 655f 6c69        - mitre_li
-000058b0: 6d69 743a 2069 6e20 6361 7365 206f 6620  mit: in case of 
-000058c0: 6a6f 696e 5f73 7479 6c65 204d 4954 5245  join_style MITRE
-000058d0: 2c20 6966 2074 6865 0a20 2020 2020 2020  , if the.       
-000058e0: 2020 2020 2073 7069 6b79 2072 6573 756c       spiky resul
-000058f0: 7420 666f 7220 6120 7368 6172 7020 616e  t for a sharp an
-00005900: 676c 6520 6265 636f 6d65 7320 6c6f 6e67  gle becomes long
-00005910: 6572 2074 6861 6e20 7468 6973 206c 696d  er than this lim
-00005920: 6974 2c20 6974 0a20 2020 2020 2020 2020  it, it.         
-00005930: 2020 2069 7320 2262 6576 656c 6564 2220     is "beveled" 
-00005940: 6174 2074 6869 7320 6469 7374 616e 6365  at this distance
-00005950: 2e20 4465 6661 756c 7473 2074 6f20 352e  . Defaults to 5.
-00005960: 302e 0a20 2020 2020 2020 202d 2073 696e  0..        - sin
-00005970: 676c 655f 7369 6465 643a 206f 6e6c 7920  gle_sided: only 
-00005980: 6f6e 6520 7369 6465 206f 6620 7468 6520  one side of the 
-00005990: 6c69 6e65 2069 7320 6275 6666 6572 6564  line is buffered
-000059a0: 2c0a 2020 2020 2020 2020 2020 2020 6966  ,.            if
-000059b0: 2064 6973 7461 6e63 6520 6973 206e 6567   distance is neg
-000059c0: 6174 6976 652c 2074 6865 206c 6566 7420  ative, the left 
-000059d0: 7369 6465 2c20 6966 2064 6973 7461 6e63  side, if distanc
-000059e0: 6520 6973 2070 6f73 6974 6976 652c 0a20  e is positive,. 
-000059f0: 2020 2020 2020 2020 2020 2074 6865 2072             the r
-00005a00: 6967 6874 2068 616e 6420 7369 6465 2e20  ight hand side. 
-00005a10: 4f6e 6c79 2072 656c 6576 616e 7420 666f  Only relevant fo
-00005a20: 7220 6c69 6e65 2067 656f 6d65 7472 6965  r line geometrie
-00005a30: 732e 0a20 2020 2020 202d 2043 4f4e 5645  s..      - CONVE
-00005a40: 5848 554c 4c3a 2061 7070 7920 6120 636f  XHULL: appy a co
-00005a50: 6e76 6578 2068 756c 6c2e 0a20 2020 2020  nvex hull..     
-00005a60: 202d 2053 494d 504c 4946 593a 2073 696d   - SIMPLIFY: sim
-00005a70: 706c 6966 7920 7468 6520 6765 6f6d 6574  plify the geomet
-00005a80: 7279 2e20 4f70 6572 6174 696f 6e20 7061  ry. Operation pa
-00005a90: 7261 6d65 7465 7273 3a0a 2020 2020 2020  rameters:.      
-00005aa0: 2020 2020 2d20 616c 676f 7269 7468 6d3a      - algorithm:
-00005ab0: 2076 6563 746f 725f 7574 696c 2e53 696d   vector_util.Sim
-00005ac0: 706c 6966 7941 6c67 6f72 6974 686d 0a20  plifyAlgorithm. 
-00005ad0: 2020 2020 2020 2020 202d 2074 6f6c 6572           - toler
-00005ae0: 616e 6365 3a20 6d61 7869 6d75 6d20 6469  ance: maximum di
-00005af0: 7374 616e 6365 2074 6f20 7369 6d70 6c69  stance to simpli
-00005b00: 6679 2e0a 2020 2020 2020 2020 2020 2d20  fy..          - 
-00005b10: 6c6f 6f6b 6168 6561 643a 2066 6f72 204c  lookahead: for L
-00005b20: 414e 472c 2074 6865 206e 756d 6265 7220  ANG, the number 
-00005b30: 6f66 2070 6f69 6e74 7320 746f 2066 6f72  of points to for
-00005b40: 7761 7264 2d6c 6f6f 6b0a 2020 2020 2020  ward-look.      
-00005b50: 2d20 4150 504c 593a 2061 7070 6c79 2061  - APPLY: apply a
-00005b60: 206c 616d 6264 6120 6675 6e63 7469 6f6e   lambda function
-00005b70: 2e20 4f70 6572 6174 696f 6e20 7061 7261  . Operation para
-00005b80: 6d65 7465 723a 0a20 2020 2020 2020 2020  meter:.         
-00005b90: 202d 2070 6963 6b6c 6564 5f66 756e 633a   - pickled_func:
-00005ba0: 206c 616d 6264 6120 6675 6e63 7469 6f6e   lambda function
-00005bb0: 2074 6f20 6170 706c 792c 2070 6963 6b6c   to apply, pickl
-00005bc0: 6564 2074 6f20 6279 7465 732e 0a20 2020  ed to bytes..   
-00005bd0: 2020 2020 2020 202d 206f 6e6c 795f 6765         - only_ge
-00005be0: 6f6d 5f69 6e70 7574 3a20 6966 2054 7275  om_input: if Tru
-00005bf0: 652c 206f 6e6c 7920 7468 6520 6765 6f6d  e, only the geom
-00005c00: 6574 7279 2069 7320 6176 6169 6c61 626c  etry is availabl
-00005c10: 6520 6173 0a20 2020 2020 2020 2020 2020  e as.           
-00005c20: 2069 6e70 7574 2066 6f72 2074 6865 206c   input for the l
-00005c30: 616d 6264 6120 6675 6e63 7469 6f6e 2e20  ambda function. 
-00005c40: 4966 2066 616c 7365 2c20 7468 6520 726f  If false, the ro
-00005c50: 7720 6973 2074 6865 2069 6e70 7574 2e0a  w is the input..
-00005c60: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
-00005c70: 2020 2069 6e70 7574 5f70 6174 6820 2850     input_path (P
-00005c80: 6174 6829 3a20 5b64 6573 6372 6970 7469  ath): [descripti
-00005c90: 6f6e 5d0a 2020 2020 2020 2020 6f75 7470  on].        outp
-00005ca0: 7574 5f70 6174 6820 2850 6174 6829 3a20  ut_path (Path): 
-00005cb0: 5b64 6573 6372 6970 7469 6f6e 5d0a 2020  [description].  
-00005cc0: 2020 2020 2020 6f70 6572 6174 696f 6e20        operation 
-00005cd0: 2847 656f 4f70 6572 6174 696f 6e29 3a20  (GeoOperation): 
-00005ce0: 7468 6520 6765 6f20 6f70 6572 6174 696f  the geo operatio
-00005cf0: 6e20 746f 2061 7070 6c79 2e0a 2020 2020  n to apply..    
-00005d00: 2020 2020 6f70 6572 6174 696f 6e5f 7061      operation_pa
-00005d10: 7261 6d73 2028 6469 6374 2c20 6f70 7469  rams (dict, opti
-00005d20: 6f6e 616c 293a 2074 6865 2070 6172 616d  onal): the param
-00005d30: 6574 6572 7320 666f 7220 7468 6520 6765  eters for the ge
-00005d40: 6f20 6f70 6572 6174 696f 6e2e 0a20 2020  o operation..   
-00005d50: 2020 2020 2020 2020 2044 6566 6175 6c74           Default
-00005d60: 7320 746f 204e 6f6e 652e 0a20 2020 2020  s to None..     
-00005d70: 2020 2069 6e70 7574 5f6c 6179 6572 2028     input_layer (
-00005d80: 7374 722c 206f 7074 696f 6e61 6c29 3a20  str, optional): 
-00005d90: 5b64 6573 6372 6970 7469 6f6e 5d2e 2044  [description]. D
-00005da0: 6566 6175 6c74 7320 746f 204e 6f6e 652e  efaults to None.
-00005db0: 0a20 2020 2020 2020 206f 7574 7075 745f  .        output_
-00005dc0: 6c61 7965 7220 2873 7472 2c20 6f70 7469  layer (str, opti
-00005dd0: 6f6e 616c 293a 205b 6465 7363 7269 7074  onal): [descript
-00005de0: 696f 6e5d 2e20 4465 6661 756c 7473 2074  ion]. Defaults t
-00005df0: 6f20 4e6f 6e65 2e0a 2020 2020 2020 2020  o None..        
-00005e00: 636f 6c75 6d6e 7320 284c 6973 745b 7374  columns (List[st
-00005e10: 725d 2c20 6f70 7469 6f6e 616c 293a 2049  r], optional): I
-00005e20: 6620 6e6f 7420 4e6f 6e65 2c20 6f6e 6c79  f not None, only
-00005e30: 206f 7574 7075 7420 7468 6520 636f 6c75   output the colu
-00005e40: 6d6e 730a 2020 2020 2020 2020 2020 2020  mns.            
-00005e50: 7370 6563 6966 6965 642e 2044 6566 6175  specified. Defau
-00005e60: 6c74 7320 746f 204e 6f6e 652e 0a20 2020  lts to None..   
-00005e70: 2020 2020 2065 7870 6c6f 6465 636f 6c6c       explodecoll
-00005e80: 6563 7469 6f6e 7320 2862 6f6f 6c2c 206f  ections (bool, o
-00005e90: 7074 696f 6e61 6c29 3a20 5472 7565 2074  ptional): True t
-00005ea0: 6f20 636f 6e76 6572 7420 616c 6c20 6d75  o convert all mu
-00005eb0: 6c74 692d 6765 6f6d 6574 7269 6573 2074  lti-geometries t
-00005ec0: 6f0a 2020 2020 2020 2020 2020 2020 7369  o.            si
-00005ed0: 6e67 756c 6172 206f 6e65 7320 6475 7269  ngular ones duri
-00005ee0: 6e67 2074 6865 2067 656f 6f70 6572 6174  ng the geooperat
-00005ef0: 696f 6e2e 2044 6566 6175 6c74 7320 746f  ion. Defaults to
-00005f00: 2046 616c 7365 2e0a 2020 2020 2020 2020   False..        
-00005f10: 666f 7263 655f 6f75 7470 7574 5f67 656f  force_output_geo
-00005f20: 6d65 7472 7974 7970 6520 2847 656f 6d65  metrytype (Geome
-00005f30: 7472 7954 7970 652c 206f 7074 696f 6e61  tryType, optiona
-00005f40: 6c29 3a20 5468 6520 6f75 7470 7574 2067  l): The output g
-00005f50: 656f 6d65 7472 7920 7479 7065 2074 6f0a  eometry type to.
-00005f60: 2020 2020 2020 2020 2020 2020 666f 7263              forc
-00005f70: 652e 2049 6620 4e6f 6e65 2c20 6120 6265  e. If None, a be
-00005f80: 7374 2d65 6666 6f72 7420 6775 6573 7320  st-effort guess 
-00005f90: 6973 206d 6164 652e 2044 6566 6175 6c74  is made. Default
-00005fa0: 7320 746f 204e 6f6e 652e 0a20 2020 2020  s to None..     
-00005fb0: 2020 2067 7269 6473 697a 6520 2866 6c6f     gridsize (flo
-00005fc0: 6174 2c20 6f70 7469 6f6e 616c 293a 2074  at, optional): t
-00005fd0: 6865 2073 697a 6520 6f66 2074 6865 2067  he size of the g
-00005fe0: 7269 6420 7468 6520 636f 6f72 6469 6e61  rid the coordina
-00005ff0: 7465 7320 6f66 2074 6865 206f 7570 7574  tes of the ouput
-00006000: 0a20 2020 2020 2020 2020 2020 2077 696c  .            wil
-00006010: 6c20 6265 2072 6f75 6e64 6564 2074 6f2e  l be rounded to.
-00006020: 2045 672e 2030 2e30 3031 2074 6f20 6b65   Eg. 0.001 to ke
-00006030: 6570 2033 2064 6563 696d 616c 732e 2056  ep 3 decimals. V
-00006040: 616c 7565 2030 2e30 2064 6f65 736e 2774  alue 0.0 doesn't
-00006050: 2063 6861 6e67 650a 2020 2020 2020 2020   change.        
-00006060: 2020 2020 7468 6520 7072 6563 6973 696f      the precisio
-00006070: 6e2e 2044 6566 6175 6c74 7320 746f 2030  n. Defaults to 0
-00006080: 2e30 2e0a 2020 2020 2020 2020 6b65 6570  .0..        keep
-00006090: 5f65 6d70 7479 5f67 656f 6d73 2028 626f  _empty_geoms (bo
-000060a0: 6f6c 2c20 6f70 7469 6f6e 616c 293a 2054  ol, optional): T
-000060b0: 7275 6520 746f 206b 6565 7020 726f 7773  rue to keep rows
-000060c0: 2077 6974 6820 656d 7074 792f 6e75 6c6c   with empty/null
-000060d0: 2067 656f 6d65 7472 6965 730a 2020 2020   geometries.    
-000060e0: 2020 2020 2020 2020 696e 2074 6865 206f          in the o
-000060f0: 7574 7075 742e 2044 6566 6175 6c74 7320  utput. Defaults 
-00006100: 746f 2054 7275 652e 0a20 2020 2020 2020  to True..       
-00006110: 2077 6865 7265 5f70 6f73 7420 2873 7472   where_post (str
-00006120: 2c20 6f70 7469 6f6e 616c 293a 2073 716c  , optional): sql
-00006130: 2066 696c 7465 7220 746f 2061 7070 6c79   filter to apply
-00006140: 2061 6674 6572 2061 6c6c 206f 7468 6572   after all other
-00006150: 2070 726f 6365 7373 696e 672c 0a20 2020   processing,.   
-00006160: 2020 2020 2020 2020 2069 6e63 6c75 6469           includi
-00006170: 6e67 2065 2e67 2e20 6578 706c 6f64 6563  ng e.g. explodec
-00006180: 6f6c 6c65 6374 696f 6e73 2e20 4974 2073  ollections. It s
-00006190: 686f 756c 6420 6265 2069 6e20 7371 6c69  hould be in sqli
-000061a0: 7465 2073 796e 7461 7820 616e 640a 2020  te syntax and.  
-000061b0: 2020 2020 2020 2020 2020 7c73 7061 7469            |spati
-000061c0: 616c 6974 655f 7265 6665 7265 6e63 655f  alite_reference_
-000061d0: 6c69 6e6b 7c20 6675 6e63 7469 6f6e 7320  link| functions 
-000061e0: 6361 6e20 6265 2075 7365 642e 2044 6566  can be used. Def
-000061f0: 6175 6c74 7320 746f 204e 6f6e 652e 0a20  aults to None.. 
-00006200: 2020 2020 2020 206e 625f 7061 7261 6c6c         nb_parall
-00006210: 656c 2028 696e 742c 206f 7074 696f 6e61  el (int, optiona
-00006220: 6c29 3a20 5b64 6573 6372 6970 7469 6f6e  l): [description
-00006230: 5d2e 2044 6566 6175 6c74 7320 746f 202d  ]. Defaults to -
-00006240: 312e 0a20 2020 2020 2020 2062 6174 6368  1..        batch
-00006250: 7369 7a65 2028 696e 742c 206f 7074 696f  size (int, optio
-00006260: 6e61 6c29 3a20 696e 6469 6361 7469 7665  nal): indicative
-00006270: 206e 756d 6265 7220 6f66 2072 6f77 7320   number of rows 
-00006280: 746f 2070 726f 6365 7373 2070 6572 0a20  to process per. 
-00006290: 2020 2020 2020 2020 2020 2062 6174 6368             batch
-000062a0: 2e20 4120 736d 616c 6c65 7220 6261 7463  . A smaller batc
-000062b0: 6820 7369 7a65 2c20 706f 7373 6962 6c79  h size, possibly
-000062c0: 2069 6e20 636f 6d62 696e 6174 696f 6e20   in combination 
-000062d0: 7769 7468 2061 0a20 2020 2020 2020 2020  with a.         
-000062e0: 2020 2073 6d61 6c6c 6572 206e 625f 7061     smaller nb_pa
-000062f0: 7261 6c6c 656c 2c20 7769 6c6c 2072 6564  rallel, will red
-00006300: 7563 6520 7468 6520 6d65 6d6f 7279 2075  uce the memory u
-00006310: 7361 6765 2e0a 2020 2020 2020 2020 2020  sage..          
-00006320: 2020 4465 6661 756c 7473 2074 6f20 2d31    Defaults to -1
-00006330: 3a20 2874 7279 2074 6f29 2064 6574 6572  : (try to) deter
-00006340: 6d69 6e65 206f 7074 696d 616c 2073 697a  mine optimal siz
-00006350: 6520 6175 746f 6d61 7469 6361 6c6c 792e  e automatically.
-00006360: 0a20 2020 2020 2020 2066 6f72 6365 2028  .        force (
-00006370: 626f 6f6c 2c20 6f70 7469 6f6e 616c 293a  bool, optional):
-00006380: 205b 6465 7363 7269 7074 696f 6e5d 2e20   [description]. 
-00006390: 4465 6661 756c 7473 2074 6f20 4661 6c73  Defaults to Fals
-000063a0: 652e 0a20 2020 2020 2020 2070 6172 616c  e..        paral
-000063b0: 6c65 6c69 7a61 7469 6f6e 5f63 6f6e 6669  lelization_confi
-000063c0: 6720 2850 6172 616c 6c65 6c69 7a61 7469  g (Parallelizati
-000063d0: 6f6e 436f 6e66 6967 2c20 6f70 7469 6f6e  onConfig, option
-000063e0: 616c 293a 2044 6566 6175 6c74 7320 746f  al): Defaults to
-000063f0: 204e 6f6e 652e 0a0a 2020 2020 5465 6368   None...    Tech
-00006400: 6e69 6361 6c20 7265 6d61 726b 733a 0a20  nical remarks:. 
-00006410: 2020 2020 2020 202d 2052 6574 6169 6e69         - Retaini
-00006420: 6e67 204e 6f6e 6520 6765 6f6d 6574 7279  ng None geometry
-00006430: 2076 616c 7565 7320 696e 2074 6865 206f   values in the o
-00006440: 7574 7075 7420 6669 6c65 7320 6973 2068  utput files is h
-00006450: 6172 642c 2062 6563 6175 7365 2077 6865  ard, because whe
-00006460: 6e0a 2020 2020 2020 2020 2020 6361 6c63  n.          calc
-00006470: 756c 6174 696e 6720 7061 7274 6961 6c20  ulating partial 
-00006480: 6669 6c65 732c 2061 2070 6172 7469 616c  files, a partial
-00006490: 2066 696c 6520 6361 6e20 6861 7665 206f   file can have o
-000064a0: 6e6c 7920 4e6f 6e65 2067 656f 6d65 7472  nly None geometr
-000064b0: 6965 7320 7768 6963 680a 2020 2020 2020  ies which.      
-000064c0: 2020 2020 6d61 6b65 7320 6974 2069 6d70      makes it imp
-000064d0: 6f73 7369 626c 6520 746f 206b 6e6f 7720  ossible to know 
-000064e0: 7468 6520 6765 6f6d 6574 7279 2074 7970  the geometry typ
-000064f0: 652e 204f 6e63 6520 616e 206f 7574 7075  e. Once an outpu
-00006500: 7420 6669 6c65 2069 7320 6372 6561 7465  t file is create
-00006510: 642c 0a20 2020 2020 2020 2020 2069 7420  d,.          it 
-00006520: 6973 2061 6c73 6f20 696d 706f 7373 6962  is also impossib
-00006530: 6c65 2074 6f20 6368 616e 6765 2074 6865  le to change the
-00006540: 2074 7970 6520 6166 7465 7277 6172 6473   type afterwards
-00006550: 2028 7769 7468 6f75 7420 6d61 6b69 6e67   (without making
-00006560: 2061 2063 6f70 7929 2e0a 2020 2020 2020   a copy)..      
-00006570: 2020 2020 4966 2066 6f72 6365 5f6f 7574      If force_out
-00006580: 7075 745f 7479 7065 2069 7320 7370 6563  put_type is spec
-00006590: 6966 6965 642c 2074 6865 2070 726f 626c  ified, the probl
-000065a0: 656d 2069 7320 676f 6e65 2e0a 0a20 2020  em is gone...   
-000065b0: 202e 2e20 7c73 7061 7469 616c 6974 655f   .. |spatialite_
-000065c0: 7265 6665 7265 6e63 655f 6c69 6e6b 7c20  reference_link| 
-000065d0: 7261 773a 3a20 6874 6d6c 0a0a 2020 2020  raw:: html..    
-000065e0: 2020 2020 3c61 2068 7265 663d 2268 7474      <a href="htt
-000065f0: 7073 3a2f 2f77 7777 2e67 6169 612d 6769  ps://www.gaia-gi
-00006600: 732e 6974 2f67 6169 612d 7369 6e73 2f73  s.it/gaia-sins/s
-00006610: 7061 7469 616c 6974 652d 7371 6c2d 6c61  patialite-sql-la
-00006620: 7465 7374 2e68 746d 6c22 2074 6172 6765  test.html" targe
-00006630: 743d 225f 626c 616e 6b22 3e73 7061 7469  t="_blank">spati
-00006640: 616c 6974 6520 7265 6665 7265 6e63 653c  alite reference<
-00006650: 2f61 3e0a 0a20 2020 2022 2222 2020 2320  /a>..    """  # 
-00006660: 6e6f 7161 3a20 4535 3031 0a20 2020 2023  noqa: E501.    #
-00006670: 2049 6e69 740a 2020 2020 7374 6172 745f   Init.    start_
-00006680: 7469 6d65 5f67 6c6f 6261 6c20 3d20 6461  time_global = da
-00006690: 7465 7469 6d65 2e6e 6f77 2829 0a20 2020  tetime.now().   
-000066a0: 206f 7065 7261 7469 6f6e 5f6e 616d 6520   operation_name 
-000066b0: 3d20 6f70 6572 6174 696f 6e5f 7061 7261  = operation_para
-000066c0: 6d73 2e67 6574 2822 6f70 6572 6174 696f  ms.get("operatio
-000066d0: 6e5f 6e61 6d65 2229 0a20 2020 2069 6620  n_name").    if 
-000066e0: 6f70 6572 6174 696f 6e5f 6e61 6d65 2069  operation_name i
-000066f0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-00006700: 6f70 6572 6174 696f 6e5f 6e61 6d65 203d  operation_name =
-00006710: 206f 7065 7261 7469 6f6e 2e76 616c 7565   operation.value
-00006720: 0a20 2020 206c 6f67 6765 7220 3d20 6c6f  .    logger = lo
-00006730: 6767 696e 672e 6765 744c 6f67 6765 7228  gging.getLogger(
-00006740: 6622 6765 6f66 696c 656f 7073 2e7b 6f70  f"geofileops.{op
-00006750: 6572 6174 696f 6e5f 6e61 6d65 7d22 290a  eration_name}").
-00006760: 0a20 2020 2023 2043 6865 636b 2069 6e70  .    # Check inp
-00006770: 7574 2070 6172 616d 6574 6572 732e 2e2e  ut parameters...
-00006780: 0a20 2020 2069 6620 6e6f 7420 696e 7075  .    if not inpu
-00006790: 745f 7061 7468 2e65 7869 7374 7328 293a  t_path.exists():
-000067a0: 0a20 2020 2020 2020 2072 6169 7365 2056  .        raise V
-000067b0: 616c 7565 4572 726f 7228 6622 7b6f 7065  alueError(f"{ope
-000067c0: 7261 7469 6f6e 5f6e 616d 657d 3a20 696e  ration_name}: in
-000067d0: 7075 745f 7061 7468 2064 6f65 736e 2774  put_path doesn't
-000067e0: 2065 7869 7374 3a20 7b69 6e70 7574 5f70   exist: {input_p
-000067f0: 6174 687d 2229 0a20 2020 2069 6620 696e  ath}").    if in
-00006800: 7075 745f 7061 7468 203d 3d20 6f75 7470  put_path == outp
-00006810: 7574 5f70 6174 683a 0a20 2020 2020 2020  ut_path:.       
-00006820: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-00006830: 7228 6622 7b6f 7065 7261 7469 6f6e 5f6e  r(f"{operation_n
-00006840: 616d 657d 3a20 6f75 7470 7574 5f70 6174  ame}: output_pat
-00006850: 6820 6d75 7374 206e 6f74 2065 7175 616c  h must not equal
-00006860: 2069 6e70 7574 5f70 6174 6822 290a 2020   input_path").  
-00006870: 2020 6966 2069 6e70 7574 5f6c 6179 6572    if input_layer
-00006880: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-00006890: 2020 696e 7075 745f 6c61 7965 7220 3d20    input_layer = 
-000068a0: 6766 6f2e 6765 745f 6f6e 6c79 5f6c 6179  gfo.get_only_lay
-000068b0: 6572 2869 6e70 7574 5f70 6174 6829 0a20  er(input_path). 
-000068c0: 2020 2069 6620 6f75 7470 7574 5f70 6174     if output_pat
-000068d0: 682e 6578 6973 7473 2829 3a0a 2020 2020  h.exists():.    
-000068e0: 2020 2020 6966 2066 6f72 6365 2069 7320      if force is 
-000068f0: 4661 6c73 653a 0a20 2020 2020 2020 2020  False:.         
-00006900: 2020 206c 6f67 6765 722e 696e 666f 2866     logger.info(f
-00006910: 2253 746f 702c 206f 7574 7075 7420 6578  "Stop, output ex
-00006920: 6973 7473 2061 6c72 6561 6479 207b 6f75  ists already {ou
-00006930: 7470 7574 5f70 6174 687d 2229 0a20 2020  tput_path}").   
-00006940: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
-00006950: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00006960: 2020 2020 2020 2020 2020 6766 6f2e 7265            gfo.re
-00006970: 6d6f 7665 286f 7574 7075 745f 7061 7468  move(output_path
-00006980: 290a 2020 2020 6966 2069 6e70 7574 5f6c  ).    if input_l
-00006990: 6179 6572 2069 7320 4e6f 6e65 3a0a 2020  ayer is None:.  
-000069a0: 2020 2020 2020 696e 7075 745f 6c61 7965        input_laye
-000069b0: 7220 3d20 6766 6f2e 6765 745f 6f6e 6c79  r = gfo.get_only
-000069c0: 5f6c 6179 6572 2869 6e70 7574 5f70 6174  _layer(input_pat
-000069d0: 6829 0a20 2020 2069 6620 6f75 7470 7574  h).    if output
-000069e0: 5f6c 6179 6572 2069 7320 4e6f 6e65 3a0a  _layer is None:.
-000069f0: 2020 2020 2020 2020 6f75 7470 7574 5f6c          output_l
-00006a00: 6179 6572 203d 2067 666f 2e67 6574 5f64  ayer = gfo.get_d
-00006a10: 6566 6175 6c74 5f6c 6179 6572 286f 7574  efault_layer(out
-00006a20: 7075 745f 7061 7468 290a 2020 2020 6966  put_path).    if
-00006a30: 2069 7369 6e73 7461 6e63 6528 666f 7263   isinstance(forc
-00006a40: 655f 6f75 7470 7574 5f67 656f 6d65 7472  e_output_geometr
-00006a50: 7974 7970 652c 2047 656f 6d65 7472 7954  ytype, GeometryT
-00006a60: 7970 6529 3a0a 2020 2020 2020 2020 666f  ype):.        fo
-00006a70: 7263 655f 6f75 7470 7574 5f67 656f 6d65  rce_output_geome
-00006a80: 7472 7974 7970 6520 3d20 666f 7263 655f  trytype = force_
-00006a90: 6f75 7470 7574 5f67 656f 6d65 7472 7974  output_geometryt
-00006aa0: 7970 652e 6e61 6d65 0a0a 2020 2020 2320  ype.name..    # 
-00006ab0: 4368 6563 6b20 6966 2077 6520 7761 6e74  Check if we want
-00006ac0: 2074 6f20 7072 6573 6572 7665 2074 6865   to preserve the
-00006ad0: 2066 6964 2069 6e20 7468 6520 6f75 7470   fid in the outp
-00006ae0: 7574 0a20 2020 2070 7265 7365 7276 655f  ut.    preserve_
-00006af0: 6669 6420 3d20 4661 6c73 650a 2020 2020  fid = False.    
-00006b00: 6966 206e 6f74 2065 7870 6c6f 6465 636f  if not explodeco
-00006b10: 6c6c 6563 7469 6f6e 7320 616e 6420 6766  llections and gf
-00006b20: 6f2e 6765 745f 6472 6976 6572 286f 7574  o.get_driver(out
-00006b30: 7075 745f 7061 7468 2920 3d3d 2022 4750  put_path) == "GP
-00006b40: 4b47 223a 0a20 2020 2020 2020 2070 7265  KG":.        pre
-00006b50: 7365 7276 655f 6669 6420 3d20 5472 7565  serve_fid = True
-00006b60: 0a0a 2020 2020 2320 5072 6570 6172 6520  ..    # Prepare 
-00006b70: 7768 6572 655f 746f 5f61 7070 6c79 2061  where_to_apply a
-00006b80: 6e64 2066 696c 7465 725f 6e75 6c6c 5f67  nd filter_null_g
-00006b90: 656f 6d73 0a20 2020 2069 6620 7768 6572  eoms.    if wher
-00006ba0: 655f 706f 7374 2069 7320 6e6f 7420 4e6f  e_post is not No
-00006bb0: 6e65 3a0a 2020 2020 2020 2020 6966 2077  ne:.        if w
-00006bc0: 6865 7265 5f70 6f73 7420 3d3d 2022 223a  here_post == "":
-00006bd0: 0a20 2020 2020 2020 2020 2020 2077 6865  .            whe
-00006be0: 7265 5f70 6f73 7420 3d20 4e6f 6e65 0a20  re_post = None. 
-00006bf0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00006c00: 2020 2020 2020 2020 2023 2041 6c77 6179           # Alway
-00006c10: 7320 7365 7420 6765 6f6d 6574 7279 636f  s set geometryco
-00006c20: 6c75 6d6e 2074 6f20 2267 656f 6d22 2c20  lumn to "geom", 
-00006c30: 6265 6361 7573 6520 7768 6572 655f 706f  because where_po
-00006c40: 7374 2070 6172 616d 6574 6572 2066 6f72  st parameter for
-00006c50: 2073 6870 0a20 2020 2020 2020 2020 2020   shp.           
-00006c60: 2023 2064 6f65 736e 2774 2073 6565 6d20   # doesn't seem 
-00006c70: 746f 2077 6f72 6b2e 2e2e 2073 6f20 6372  to work... so cr
-00006c80: 6561 7465 2074 656d 7020 7061 7274 6961  eate temp partia
-00006c90: 6c20 6669 6c65 7320 616c 7761 7973 2061  l files always a
-00006ca0: 7320 6770 6b67 2e0a 2020 2020 2020 2020  s gpkg..        
-00006cb0: 2020 2020 7768 6572 655f 706f 7374 203d      where_post =
-00006cc0: 2077 6865 7265 5f70 6f73 742e 666f 726d   where_post.form
-00006cd0: 6174 2867 656f 6d65 7472 7963 6f6c 756d  at(geometrycolum
-00006ce0: 6e3d 2267 656f 6d22 290a 0a20 2020 2023  n="geom")..    #
-00006cf0: 2050 7265 7061 7265 2074 6d70 2066 696c   Prepare tmp fil
-00006d00: 6573 0a20 2020 2074 6d70 5f64 6972 203d  es.    tmp_dir =
-00006d10: 205f 696f 5f75 7469 6c2e 6372 6561 7465   _io_util.create
-00006d20: 5f74 656d 7064 6972 2866 2267 656f 6669  _tempdir(f"geofi
-00006d30: 6c65 6f70 732f 7b6f 7065 7261 7469 6f6e  leops/{operation
-00006d40: 2e76 616c 7565 7d22 290a 2020 2020 6c6f  .value}").    lo
-00006d50: 6767 6572 2e64 6562 7567 2866 2253 7461  gger.debug(f"Sta
-00006d60: 7274 2063 616c 6375 6c61 7469 6f6e 2074  rt calculation t
-00006d70: 6f20 7465 6d70 2066 696c 6573 2069 6e20  o temp files in 
-00006d80: 7b74 6d70 5f64 6972 7d22 290a 0a20 2020  {tmp_dir}")..   
-00006d90: 2074 7279 3a0a 2020 2020 2020 2020 2320   try:.        # 
-00006da0: 4361 6c63 756c 6174 6520 7468 6520 6265  Calculate the be
-00006db0: 7374 206e 756d 6265 7220 6f66 2070 6172  st number of par
-00006dc0: 616c 6c65 6c20 7072 6f63 6573 7365 7320  allel processes 
-00006dd0: 616e 6420 6261 7463 6865 7320 666f 720a  and batches for.
-00006de0: 2020 2020 2020 2020 2320 7468 6520 6176          # the av
-00006df0: 6169 6c61 626c 6520 7265 736f 7572 6365  ailable resource
-00006e00: 730a 2020 2020 2020 2020 7072 6f63 6573  s.        proces
-00006e10: 7369 6e67 5f70 6172 616d 7320 3d20 5f70  sing_params = _p
-00006e20: 7265 7061 7265 5f70 726f 6365 7373 696e  repare_processin
-00006e30: 675f 7061 7261 6d73 280a 2020 2020 2020  g_params(.      
-00006e40: 2020 2020 2020 696e 7075 745f 7061 7468        input_path
-00006e50: 3d69 6e70 7574 5f70 6174 682c 0a20 2020  =input_path,.   
-00006e60: 2020 2020 2020 2020 2069 6e70 7574 5f6c           input_l
-00006e70: 6179 6572 3d69 6e70 7574 5f6c 6179 6572  ayer=input_layer
-00006e80: 2c0a 2020 2020 2020 2020 2020 2020 6e62  ,.            nb
-00006e90: 5f70 6172 616c 6c65 6c3d 6e62 5f70 6172  _parallel=nb_par
-00006ea0: 616c 6c65 6c2c 0a20 2020 2020 2020 2020  allel,.         
-00006eb0: 2020 2062 6174 6368 7369 7a65 3d62 6174     batchsize=bat
-00006ec0: 6368 7369 7a65 2c0a 2020 2020 2020 2020  chsize,.        
-00006ed0: 2020 2020 7061 7261 6c6c 656c 697a 6174      parallelizat
-00006ee0: 696f 6e5f 636f 6e66 6967 3d70 6172 616c  ion_config=paral
-00006ef0: 6c65 6c69 7a61 7469 6f6e 5f63 6f6e 6669  lelization_confi
-00006f00: 672c 0a20 2020 2020 2020 2020 2020 2074  g,.            t
-00006f10: 6d70 5f64 6972 3d74 6d70 5f64 6972 2c0a  mp_dir=tmp_dir,.
-00006f20: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00006f30: 2020 6173 7365 7274 2070 726f 6365 7373    assert process
-00006f40: 696e 675f 7061 7261 6d73 2e62 6174 6368  ing_params.batch
-00006f50: 6573 2069 7320 6e6f 7420 4e6f 6e65 0a0a  es is not None..
-00006f60: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
-00006f70: 6e66 6f28 0a20 2020 2020 2020 2020 2020  nfo(.           
-00006f80: 2066 2253 7461 7274 2070 726f 6365 7373   f"Start process
-00006f90: 696e 6720 287b 7072 6f63 6573 7369 6e67  ing ({processing
-00006fa0: 5f70 6172 616d 732e 6e62 5f70 6172 616c  _params.nb_paral
-00006fb0: 6c65 6c7d 2022 0a20 2020 2020 2020 2020  lel} ".         
-00006fc0: 2020 2066 2270 6172 616c 6c65 6c20 776f     f"parallel wo
-00006fd0: 726b 6572 732c 2062 6174 6368 2073 697a  rkers, batch siz
-00006fe0: 653a 207b 7072 6f63 6573 7369 6e67 5f70  e: {processing_p
-00006ff0: 6172 616d 732e 6261 7463 6873 697a 657d  arams.batchsize}
-00007000: 2922 0a20 2020 2020 2020 2029 0a20 2020  )".        ).   
-00007010: 2020 2020 2023 2050 726f 6365 7373 696e       # Processin
-00007020: 6720 696e 2074 6872 6561 6473 2069 7320  g in threads is 
-00007030: 3278 2066 6173 7465 7220 666f 7220 736d  2x faster for sm
-00007040: 616c 6c20 6461 7461 7365 7473 2028 6f6e  all datasets (on
-00007050: 2057 696e 646f 7773 290a 2020 2020 2020   Windows).      
-00007060: 2020 6361 6c63 756c 6174 655f 696e 5f74    calculate_in_t
-00007070: 6872 6561 6473 203d 2028 0a20 2020 2020  hreads = (.     
-00007080: 2020 2020 2020 2054 7275 6520 6966 2070         True if p
-00007090: 726f 6365 7373 696e 675f 7061 7261 6d73  rocessing_params
-000070a0: 2e6e 625f 726f 7773 5f74 6f5f 7072 6f63  .nb_rows_to_proc
-000070b0: 6573 7320 3c3d 2031 3030 2065 6c73 6520  ess <= 100 else 
-000070c0: 4661 6c73 650a 2020 2020 2020 2020 290a  False.        ).
-000070d0: 2020 2020 2020 2020 7769 7468 205f 7072          with _pr
-000070e0: 6f63 6573 7369 6e67 5f75 7469 6c2e 506f  ocessing_util.Po
-000070f0: 6f6c 6564 4578 6563 7574 6f72 4661 6374  oledExecutorFact
-00007100: 6f72 7928 0a20 2020 2020 2020 2020 2020  ory(.           
-00007110: 2074 6872 6561 6470 6f6f 6c3d 6361 6c63   threadpool=calc
-00007120: 756c 6174 655f 696e 5f74 6872 6561 6473  ulate_in_threads
-00007130: 2c0a 2020 2020 2020 2020 2020 2020 6d61  ,.            ma
-00007140: 785f 776f 726b 6572 733d 7072 6f63 6573  x_workers=proces
-00007150: 7369 6e67 5f70 6172 616d 732e 6e62 5f70  sing_params.nb_p
-00007160: 6172 616c 6c65 6c2c 0a20 2020 2020 2020  arallel,.       
-00007170: 2020 2020 2069 6e69 7469 616c 697a 6572       initializer
-00007180: 3d5f 7072 6f63 6573 7369 6e67 5f75 7469  =_processing_uti
-00007190: 6c2e 696e 6974 6961 6c69 7a65 5f77 6f72  l.initialize_wor
-000071a0: 6b65 7228 292c 0a20 2020 2020 2020 2029  ker(),.        )
-000071b0: 2061 7320 6361 6c63 756c 6174 655f 706f   as calculate_po
-000071c0: 6f6c 3a0a 2020 2020 2020 2020 2020 2020  ol:.            
-000071d0: 2320 5072 6570 6172 6520 6f75 7470 7574  # Prepare output
-000071e0: 2066 696c 656e 616d 650a 2020 2020 2020   filename.      
-000071f0: 2020 2020 2020 746d 705f 6f75 7470 7574        tmp_output
-00007200: 5f70 6174 6820 3d20 746d 705f 6469 7220  _path = tmp_dir 
-00007210: 2f20 6f75 7470 7574 5f70 6174 682e 6e61  / output_path.na
-00007220: 6d65 0a0a 2020 2020 2020 2020 2020 2020  me..            
-00007230: 6261 7463 6865 733a 2044 6963 745b 696e  batches: Dict[in
-00007240: 742c 2064 6963 745d 203d 207b 7d0a 2020  t, dict] = {}.  
-00007250: 2020 2020 2020 2020 2020 6675 7475 7265            future
-00007260: 5f74 6f5f 6261 7463 685f 6964 203d 207b  _to_batch_id = {
-00007270: 7d0a 0a20 2020 2020 2020 2020 2020 2066  }..            f
-00007280: 6f72 2062 6174 6368 5f69 642c 2062 6174  or batch_id, bat
-00007290: 6368 5f66 696c 7465 7220 696e 2065 6e75  ch_filter in enu
-000072a0: 6d65 7261 7465 2870 726f 6365 7373 696e  merate(processin
-000072b0: 675f 7061 7261 6d73 2e62 6174 6368 6573  g_params.batches
-000072c0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-000072d0: 2020 2062 6174 6368 6573 5b62 6174 6368     batches[batch
-000072e0: 5f69 645d 203d 207b 7d0a 2020 2020 2020  _id] = {}.      
-000072f0: 2020 2020 2020 2020 2020 6261 7463 6865            batche
-00007300: 735b 6261 7463 685f 6964 5d5b 226c 6179  s[batch_id]["lay
-00007310: 6572 225d 203d 206f 7574 7075 745f 6c61  er"] = output_la
-00007320: 7965 720a 0a20 2020 2020 2020 2020 2020  yer..           
-00007330: 2020 2020 2023 204f 7574 7075 7420 6561       # Output ea
-00007340: 6368 2062 6174 6368 2074 6f20 6120 7365  ch batch to a se
-00007350: 7065 7261 7465 2074 656d 706f 7261 7279  perate temporary
-00007360: 2066 696c 652c 206f 7468 6572 7769 7365   file, otherwise
-00007370: 2074 6865 7265 0a20 2020 2020 2020 2020   there.         
-00007380: 2020 2020 2020 2023 2061 7265 2074 696d         # are tim
-00007390: 656f 7574 2069 7373 7565 7320 7768 656e  eout issues when
-000073a0: 2070 726f 6365 7373 696e 6720 6c61 7267   processing larg
-000073b0: 6520 6669 6c65 730a 2020 2020 2020 2020  e files.        
-000073c0: 2020 2020 2020 2020 6f75 7470 7574 5f74          output_t
-000073d0: 6d70 5f70 6172 7469 616c 5f70 6174 6820  mp_partial_path 
-000073e0: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
-000073f0: 2020 2020 2020 2020 746d 705f 6469 7220          tmp_dir 
-00007400: 2f20 6622 7b6f 7574 7075 745f 7061 7468  / f"{output_path
-00007410: 2e73 7465 6d7d 5f7b 6261 7463 685f 6964  .stem}_{batch_id
-00007420: 7d2e 6770 6b67 220a 2020 2020 2020 2020  }.gpkg".        
-00007430: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00007440: 2020 2020 2020 2020 2020 6261 7463 6865            batche
-00007450: 735b 6261 7463 685f 6964 5d5b 2274 6d70  s[batch_id]["tmp
-00007460: 5f70 6172 7469 616c 5f6f 7574 7075 745f  _partial_output_
-00007470: 7061 7468 225d 203d 206f 7574 7075 745f  path"] = output_
-00007480: 746d 705f 7061 7274 6961 6c5f 7061 7468  tmp_partial_path
-00007490: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000074a0: 2062 6174 6368 6573 5b62 6174 6368 5f69   batches[batch_i
-000074b0: 645d 5b22 6669 6c74 6572 225d 203d 2062  d]["filter"] = b
-000074c0: 6174 6368 5f66 696c 7465 720a 0a20 2020  atch_filter..   
-000074d0: 2020 2020 2020 2020 2020 2020 2023 2052               # R
-000074e0: 656d 6172 6b3a 2074 6869 7320 7465 6d70  emark: this temp
-000074f0: 2066 696c 6520 646f 6573 6e27 7420 6e65   file doesn't ne
-00007500: 6564 2073 7061 7469 616c 2069 6e64 6578  ed spatial index
-00007510: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007520: 2023 2052 656d 6172 6b3a 2062 6563 6175   # Remark: becau
-00007530: 7365 2066 6f72 6365 5f6f 7574 7075 745f  se force_output_
-00007540: 6765 6f6d 6574 7279 7479 7065 2066 6f72  geometrytype for
-00007550: 2047 656f 4461 7461 4672 616d 650a 2020   GeoDataFrame.  
-00007560: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00007570: 6f70 6572 6174 696f 6e73 2069 7320 2861  operations is (a
-00007580: 206c 6f74 2920 6d6f 7265 206c 696d 6974   lot) more limit
-00007590: 6564 2074 6861 6e20 6764 616c 2d62 6173  ed than gdal-bas
-000075a0: 6564 2c20 7468 6520 6764 616c 2076 6572  ed, the gdal ver
-000075b0: 7369 6f6e 0a20 2020 2020 2020 2020 2020  sion.           
-000075c0: 2020 2020 2023 2069 7320 7573 6564 206c       # is used l
-000075d0: 6174 6572 206f 6e20 7768 656e 2074 6865  ater on when the
-000075e0: 2072 6573 756c 7473 2061 7265 206d 6572   results are mer
-000075f0: 6765 6420 746f 2074 6865 2072 6573 756c  ged to the resul
-00007600: 7420 6669 6c65 2e0a 2020 2020 2020 2020  t file..        
-00007610: 2020 2020 2020 2020 6675 7475 7265 203d          future =
-00007620: 2063 616c 6375 6c61 7465 5f70 6f6f 6c2e   calculate_pool.
-00007630: 7375 626d 6974 280a 2020 2020 2020 2020  submit(.        
-00007640: 2020 2020 2020 2020 2020 2020 5f61 7070              _app
-00007650: 6c79 5f67 656f 6f70 6572 6174 696f 6e2c  ly_geooperation,
-00007660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007670: 2020 2020 2069 6e70 7574 5f70 6174 683d       input_path=
-00007680: 696e 7075 745f 7061 7468 2c0a 2020 2020  input_path,.    
-00007690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000076a0: 6f75 7470 7574 5f70 6174 683d 6f75 7470  output_path=outp
-000076b0: 7574 5f74 6d70 5f70 6172 7469 616c 5f70  ut_tmp_partial_p
-000076c0: 6174 682c 0a20 2020 2020 2020 2020 2020  ath,.           
-000076d0: 2020 2020 2020 2020 206f 7065 7261 7469           operati
-000076e0: 6f6e 3d6f 7065 7261 7469 6f6e 2c0a 2020  on=operation,.  
-000076f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007700: 2020 6f70 6572 6174 696f 6e5f 7061 7261    operation_para
-00007710: 6d73 3d6f 7065 7261 7469 6f6e 5f70 6172  ms=operation_par
-00007720: 616d 732c 0a20 2020 2020 2020 2020 2020  ams,.           
-00007730: 2020 2020 2020 2020 2069 6e70 7574 5f6c           input_l
-00007740: 6179 6572 3d69 6e70 7574 5f6c 6179 6572  ayer=input_layer
-00007750: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00007760: 2020 2020 2020 636f 6c75 6d6e 733d 636f        columns=co
-00007770: 6c75 6d6e 732c 0a20 2020 2020 2020 2020  lumns,.         
-00007780: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
-00007790: 745f 6c61 7965 723d 6f75 7470 7574 5f6c  t_layer=output_l
-000077a0: 6179 6572 2c0a 2020 2020 2020 2020 2020  ayer,.          
-000077b0: 2020 2020 2020 2020 2020 7768 6572 653d            where=
-000077c0: 6261 7463 685f 6669 6c74 6572 2c0a 2020  batch_filter,.  
-000077d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000077e0: 2020 6578 706c 6f64 6563 6f6c 6c65 6374    explodecollect
-000077f0: 696f 6e73 3d65 7870 6c6f 6465 636f 6c6c  ions=explodecoll
-00007800: 6563 7469 6f6e 732c 0a20 2020 2020 2020  ections,.       
-00007810: 2020 2020 2020 2020 2020 2020 2067 7269               gri
-00007820: 6473 697a 653d 6772 6964 7369 7a65 2c0a  dsize=gridsize,.
-00007830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007840: 2020 2020 6b65 6570 5f65 6d70 7479 5f67      keep_empty_g
-00007850: 656f 6d73 3d6b 6565 705f 656d 7074 795f  eoms=keep_empty_
-00007860: 6765 6f6d 732c 0a20 2020 2020 2020 2020  geoms,.         
-00007870: 2020 2020 2020 2020 2020 2070 7265 7365             prese
-00007880: 7276 655f 6669 643d 7072 6573 6572 7665  rve_fid=preserve
-00007890: 5f66 6964 2c0a 2020 2020 2020 2020 2020  _fid,.          
-000078a0: 2020 2020 2020 2020 2020 666f 7263 653d            force=
-000078b0: 666f 7263 652c 0a20 2020 2020 2020 2020  force,.         
-000078c0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-000078d0: 2020 2020 2020 2020 2066 7574 7572 655f           future_
-000078e0: 746f 5f62 6174 6368 5f69 645b 6675 7475  to_batch_id[futu
-000078f0: 7265 5d20 3d20 6261 7463 685f 6964 0a0a  re] = batch_id..
-00007900: 2020 2020 2020 2020 2020 2020 2320 4c6f              # Lo
-00007910: 6f70 2074 696c 6c20 616c 6c20 7061 7261  op till all para
-00007920: 6c6c 656c 2070 726f 6365 7373 6573 2061  llel processes a
-00007930: 7265 2072 6561 6479 2c20 6275 7420 7072  re ready, but pr
-00007940: 6f63 6573 7320 6561 6368 206f 6e65 0a20  ocess each one. 
-00007950: 2020 2020 2020 2020 2020 2023 2074 6861             # tha
-00007960: 7420 6973 2072 6561 6479 2061 6c72 6561  t is ready alrea
-00007970: 6479 0a20 2020 2020 2020 2020 2020 2023  dy.            #
-00007980: 2052 656d 6172 6b3a 2063 616c 6375 6c61   Remark: calcula
-00007990: 7469 6e67 2063 616e 2062 6520 646f 6e65  ting can be done
-000079a0: 2069 6e20 7061 7261 6c6c 656c 2c20 6275   in parallel, bu
-000079b0: 7420 6f6e 6c79 206f 6e65 2070 726f 6365  t only one proce
-000079c0: 7373 0a20 2020 2020 2020 2020 2020 2023  ss.            #
-000079d0: 2063 616e 2077 7269 7465 2074 6f20 7468   can write to th
-000079e0: 6520 7361 6d65 206f 7574 7075 7420 6669  e same output fi
-000079f0: 6c65 2061 7420 7468 6520 7469 6d65 2e2e  le at the time..
-00007a00: 2e0a 2020 2020 2020 2020 2020 2020 7374  ..            st
-00007a10: 6172 745f 7469 6d65 203d 2064 6174 6574  art_time = datet
-00007a20: 696d 652e 6e6f 7728 290a 2020 2020 2020  ime.now().      
-00007a30: 2020 2020 2020 6e62 5f64 6f6e 6520 3d20        nb_done = 
-00007a40: 300a 2020 2020 2020 2020 2020 2020 6e62  0.            nb
-00007a50: 5f62 6174 6368 6573 203d 206c 656e 2870  _batches = len(p
-00007a60: 726f 6365 7373 696e 675f 7061 7261 6d73  rocessing_params
-00007a70: 2e62 6174 6368 6573 290a 2020 2020 2020  .batches).      
-00007a80: 2020 2020 2020 5f67 656e 6572 616c 5f75        _general_u
-00007a90: 7469 6c2e 7265 706f 7274 5f70 726f 6772  til.report_progr
-00007aa0: 6573 7328 0a20 2020 2020 2020 2020 2020  ess(.           
-00007ab0: 2020 2020 2073 7461 7274 5f74 696d 652c       start_time,
-00007ac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007ad0: 206e 625f 646f 6e65 2c0a 2020 2020 2020   nb_done,.      
-00007ae0: 2020 2020 2020 2020 2020 6e62 5f74 6f64            nb_tod
-00007af0: 6f3d 6e62 5f62 6174 6368 6573 2c0a 2020  o=nb_batches,.  
-00007b00: 2020 2020 2020 2020 2020 2020 2020 6f70                op
-00007b10: 6572 6174 696f 6e3d 6f70 6572 6174 696f  eration=operatio
-00007b20: 6e2e 7661 6c75 652c 0a20 2020 2020 2020  n.value,.       
-00007b30: 2020 2020 2020 2020 206e 625f 7061 7261           nb_para
-00007b40: 6c6c 656c 3d70 726f 6365 7373 696e 675f  llel=processing_
-00007b50: 7061 7261 6d73 2e6e 625f 7061 7261 6c6c  params.nb_parall
-00007b60: 656c 2c0a 2020 2020 2020 2020 2020 2020  el,.            
-00007b70: 290a 2020 2020 2020 2020 2020 2020 666f  ).            fo
-00007b80: 7220 6675 7475 7265 2069 6e20 6675 7475  r future in futu
-00007b90: 7265 732e 6173 5f63 6f6d 706c 6574 6564  res.as_completed
-00007ba0: 2866 7574 7572 655f 746f 5f62 6174 6368  (future_to_batch
-00007bb0: 5f69 6429 3a0a 2020 2020 2020 2020 2020  _id):.          
-00007bc0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-00007bd0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00007be0: 6573 7361 6765 203d 2066 7574 7572 652e  essage = future.
-00007bf0: 7265 7375 6c74 2829 0a20 2020 2020 2020  result().       
-00007c00: 2020 2020 2020 2020 2020 2020 206c 6f67               log
-00007c10: 6765 722e 6465 6275 6728 6d65 7373 6167  ger.debug(messag
-00007c20: 6529 0a0a 2020 2020 2020 2020 2020 2020  e)..            
-00007c30: 2020 2020 2020 2020 2320 4966 2074 6865          # If the
-00007c40: 2063 616c 6375 6c61 7465 2067 6176 6520   calculate gave 
-00007c50: 7265 7375 6c74 732c 2063 6f70 7920 746f  results, copy to
-00007c60: 206f 7574 7075 740a 2020 2020 2020 2020   output.        
-00007c70: 2020 2020 2020 2020 2020 2020 6261 7463              batc
-00007c80: 685f 6964 203d 2066 7574 7572 655f 746f  h_id = future_to
-00007c90: 5f62 6174 6368 5f69 645b 6675 7475 7265  _batch_id[future
-00007ca0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00007cb0: 2020 2020 2020 746d 705f 7061 7274 6961        tmp_partia
-00007cc0: 6c5f 6f75 7470 7574 5f70 6174 6820 3d20  l_output_path = 
-00007cd0: 6261 7463 6865 735b 6261 7463 685f 6964  batches[batch_id
-00007ce0: 5d5b 0a20 2020 2020 2020 2020 2020 2020  ][.             
-00007cf0: 2020 2020 2020 2020 2020 2022 746d 705f             "tmp_
-00007d00: 7061 7274 6961 6c5f 6f75 7470 7574 5f70  partial_output_p
-00007d10: 6174 6822 0a20 2020 2020 2020 2020 2020  ath".           
-00007d20: 2020 2020 2020 2020 205d 0a20 2020 2020           ].     
-00007d30: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00007d40: 6620 280a 2020 2020 2020 2020 2020 2020  f (.            
-00007d50: 2020 2020 2020 2020 2020 2020 746d 705f              tmp_
-00007d60: 7061 7274 6961 6c5f 6f75 7470 7574 5f70  partial_output_p
-00007d70: 6174 682e 6578 6973 7473 2829 0a20 2020  ath.exists().   
-00007d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007d90: 2020 2020 2061 6e64 2074 6d70 5f70 6172       and tmp_par
-00007da0: 7469 616c 5f6f 7574 7075 745f 7061 7468  tial_output_path
-00007db0: 2e73 7461 7428 292e 7374 5f73 697a 6520  .stat().st_size 
-00007dc0: 3e20 300a 2020 2020 2020 2020 2020 2020  > 0.            
-00007dd0: 2020 2020 2020 2020 293a 0a20 2020 2020          ):.     
+00000050: 2222 220a 0a69 6d70 6f72 7420 636f 7079  """..import copy
+00000060: 0a69 6d70 6f72 7420 656e 756d 0a69 6d70  .import enum.imp
+00000070: 6f72 7420 6a73 6f6e 0a69 6d70 6f72 7420  ort json.import 
+00000080: 6c6f 6767 696e 670a 696d 706f 7274 206c  logging.import l
+00000090: 6f67 6769 6e67 2e63 6f6e 6669 670a 696d  ogging.config.im
+000000a0: 706f 7274 206d 6174 680a 696d 706f 7274  port math.import
+000000b0: 206d 756c 7469 7072 6f63 6573 7369 6e67   multiprocessing
+000000c0: 0a69 6d70 6f72 7420 7069 636b 6c65 0a69  .import pickle.i
+000000d0: 6d70 6f72 7420 7265 0a69 6d70 6f72 7420  mport re.import 
+000000e0: 7368 7574 696c 0a69 6d70 6f72 7420 7469  shutil.import ti
+000000f0: 6d65 0a69 6d70 6f72 7420 7761 726e 696e  me.import warnin
+00000100: 6773 0a66 726f 6d20 636f 6c6c 6563 7469  gs.from collecti
+00000110: 6f6e 732e 6162 6320 696d 706f 7274 2049  ons.abc import I
+00000120: 7465 7261 626c 650a 6672 6f6d 2063 6f6e  terable.from con
+00000130: 6375 7272 656e 7420 696d 706f 7274 2066  current import f
+00000140: 7574 7572 6573 0a66 726f 6d20 6461 7465  utures.from date
+00000150: 7469 6d65 2069 6d70 6f72 7420 6461 7465  time import date
+00000160: 7469 6d65 0a66 726f 6d20 7061 7468 6c69  time.from pathli
+00000170: 6220 696d 706f 7274 2050 6174 680a 6672  b import Path.fr
+00000180: 6f6d 2074 7970 696e 6720 696d 706f 7274  om typing import
+00000190: 2041 6e79 2c20 4361 6c6c 6162 6c65 2c20   Any, Callable, 
+000001a0: 4f70 7469 6f6e 616c 2c20 556e 696f 6e0a  Optional, Union.
+000001b0: 0a69 6d70 6f72 7420 636c 6f75 6470 6963  .import cloudpic
+000001c0: 6b6c 650a 696d 706f 7274 2067 656f 7061  kle.import geopa
+000001d0: 6e64 6173 2061 7320 6770 640a 696d 706f  ndas as gpd.impo
+000001e0: 7274 206e 756d 7079 2061 7320 6e70 0a69  rt numpy as np.i
+000001f0: 6d70 6f72 7420 7061 6e64 6173 2061 7320  mport pandas as 
+00000200: 7064 0a69 6d70 6f72 7420 7073 7574 696c  pd.import psutil
+00000210: 0a69 6d70 6f72 7420 7079 6765 6f6f 7073  .import pygeoops
+00000220: 0a69 6d70 6f72 7420 7368 6170 656c 790a  .import shapely.
+00000230: 696d 706f 7274 2073 6861 7065 6c79 2e67  import shapely.g
+00000240: 656f 6d65 7472 7920 6173 2073 685f 6765  eometry as sh_ge
+00000250: 6f6d 0a66 726f 6d20 7079 6765 6f6f 7073  om.from pygeoops
+00000260: 2069 6d70 6f72 7420 4765 6f6d 6574 7279   import Geometry
+00000270: 5479 7065 2c20 5072 696d 6974 6976 6554  Type, PrimitiveT
+00000280: 7970 650a 0a69 6d70 6f72 7420 6765 6f66  ype..import geof
+00000290: 696c 656f 7073 2061 7320 6766 6f0a 6672  ileops as gfo.fr
+000002a0: 6f6d 2067 656f 6669 6c65 6f70 7320 696d  om geofileops im
+000002b0: 706f 7274 2066 696c 656f 7073 0a66 726f  port fileops.fro
+000002c0: 6d20 6765 6f66 696c 656f 7073 2e68 656c  m geofileops.hel
+000002d0: 7065 7273 2069 6d70 6f72 7420 5f70 6172  pers import _par
+000002e0: 616d 6574 6572 5f68 656c 7065 720a 6672  ameter_helper.fr
+000002f0: 6f6d 2067 656f 6669 6c65 6f70 732e 6865  om geofileops.he
+00000300: 6c70 6572 732e 5f63 6f6e 6669 676f 7074  lpers._configopt
+00000310: 696f 6e73 5f68 656c 7065 7220 696d 706f  ions_helper impo
+00000320: 7274 2043 6f6e 6669 674f 7074 696f 6e73  rt ConfigOptions
+00000330: 0a66 726f 6d20 6765 6f66 696c 656f 7073  .from geofileops
+00000340: 2e75 7469 6c20 696d 706f 7274 2028 0a20  .util import (. 
+00000350: 2020 205f 6765 6e65 7261 6c5f 7574 696c     _general_util
+00000360: 2c0a 2020 2020 5f67 656f 6f70 735f 7371  ,.    _geoops_sq
+00000370: 6c2c 0a20 2020 205f 6765 6f73 6572 6965  l,.    _geoserie
+00000380: 735f 7574 696c 2c0a 2020 2020 5f69 6f5f  s_util,.    _io_
+00000390: 7574 696c 2c0a 2020 2020 5f6f 6772 5f75  util,.    _ogr_u
+000003a0: 7469 6c2c 0a20 2020 205f 7072 6f63 6573  til,.    _proces
+000003b0: 7369 6e67 5f75 7469 6c2c 0a29 0a66 726f  sing_util,.).fro
+000003c0: 6d20 6765 6f66 696c 656f 7073 2e75 7469  m geofileops.uti
+000003d0: 6c2e 5f67 656f 6669 6c65 696e 666f 2069  l._geofileinfo i
+000003e0: 6d70 6f72 7420 4765 6f66 696c 6549 6e66  mport GeofileInf
+000003f0: 6f0a 6672 6f6d 2067 656f 6669 6c65 6f70  o.from geofileop
+00000400: 732e 7574 696c 2e5f 6765 6f6d 6574 7279  s.util._geometry
+00000410: 5f75 7469 6c20 696d 706f 7274 2028 0a20  _util import (. 
+00000420: 2020 2042 7566 6665 7245 6e64 4361 7053     BufferEndCapS
+00000430: 7479 6c65 2c0a 2020 2020 4275 6666 6572  tyle,.    Buffer
+00000440: 4a6f 696e 5374 796c 652c 0a20 2020 2053  JoinStyle,.    S
+00000450: 696d 706c 6966 7941 6c67 6f72 6974 686d  implifyAlgorithm
+00000460: 2c0a 290a 0a23 2044 6f6e 2774 2073 686f  ,.)..# Don't sho
+00000470: 7720 7468 6973 2067 656f 7061 6e64 6173  w this geopandas
+00000480: 2077 6172 6e69 6e67 2e2e 2e0a 7761 726e   warning....warn
+00000490: 696e 6773 2e66 696c 7465 7277 6172 6e69  ings.filterwarni
+000004a0: 6e67 7328 2269 676e 6f72 6522 2c20 2247  ngs("ignore", "G
+000004b0: 656f 5365 7269 6573 2e69 736e 6122 2c20  eoSeries.isna", 
+000004c0: 5573 6572 5761 726e 696e 6729 0a0a 6c6f  UserWarning)..lo
+000004d0: 6767 6572 203d 206c 6f67 6769 6e67 2e67  gger = logging.g
+000004e0: 6574 4c6f 6767 6572 285f 5f6e 616d 655f  etLogger(__name_
+000004f0: 5f29 0a0a 0a63 6c61 7373 2050 6172 616c  _)...class Paral
+00000500: 6c65 6c69 7a61 7469 6f6e 436f 6e66 6967  lelizationConfig
+00000510: 3a0a 2020 2020 2222 220a 2020 2020 4865  :.    """.    He
+00000520: 7572 6973 7469 6373 2066 6f72 2067 656f  uristics for geo
+00000530: 7061 6e64 6173 2062 6173 6564 2067 656f  pandas based geo
+00000540: 206f 7065 7261 7469 6f6e 732e 0a0a 2020   operations...  
+00000550: 2020 4865 7572 6973 7469 6373 206d 6561    Heuristics mea
+00000560: 6e74 2074 6f20 6265 2061 626c 6520 746f  nt to be able to
+00000570: 206f 7074 696d 697a 6520 7468 6520 7061   optimize the pa
+00000580: 7261 6c6c 656c 6973 6174 696f 6e20 7061  rallelisation pa
+00000590: 7261 6d65 7465 7273 2066 6f72 0a20 2020  rameters for.   
+000005a0: 2067 656f 7061 6e64 6173 2062 6173 6564   geopandas based
+000005b0: 2067 656f 206f 7065 7261 7469 6f6e 2e0a   geo operation..
+000005c0: 2020 2020 2222 220a 0a20 2020 2064 6566      """..    def
+000005d0: 205f 5f69 6e69 745f 5f28 0a20 2020 2020   __init__(.     
+000005e0: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+000005f0: 2062 7974 6573 5f62 6173 6566 6f6f 7470   bytes_basefootp
+00000600: 7269 6e74 3a20 696e 7420 3d20 3530 202a  rint: int = 50 *
+00000610: 2031 3032 3420 2a20 3130 3234 2c0a 2020   1024 * 1024,.  
+00000620: 2020 2020 2020 6279 7465 735f 7065 725f        bytes_per_
+00000630: 726f 773a 2069 6e74 203d 2031 3030 302c  row: int = 1000,
+00000640: 0a20 2020 2020 2020 206d 696e 5f72 6f77  .        min_row
+00000650: 735f 7065 725f 6261 7463 683a 2069 6e74  s_per_batch: int
+00000660: 203d 2031 3030 302c 0a20 2020 2020 2020   = 1000,.       
+00000670: 206d 6178 5f72 6f77 735f 7065 725f 6261   max_rows_per_ba
+00000680: 7463 683a 2069 6e74 203d 2031 3030 3030  tch: int = 10000
+00000690: 302c 0a20 2020 2020 2020 2062 7974 6573  0,.        bytes
+000006a0: 5f6d 696e 5f70 6572 5f70 726f 6365 7373  _min_per_process
+000006b0: 3a20 4f70 7469 6f6e 616c 5b69 6e74 5d20  : Optional[int] 
+000006c0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+000006d0: 6279 7465 735f 7573 6162 6c65 3a20 4f70  bytes_usable: Op
+000006e0: 7469 6f6e 616c 5b69 6e74 5d20 3d20 4e6f  tional[int] = No
+000006f0: 6e65 2c0a 2020 2020 2020 2020 6370 755f  ne,.        cpu_
+00000700: 636f 756e 743a 2069 6e74 203d 202d 312c  count: int = -1,
+00000710: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
+00000720: 2222 220a 2020 2020 2020 2020 4865 7572  """.        Heur
+00000730: 6973 7469 6373 2066 6f72 2067 656f 7061  istics for geopa
+00000740: 6e64 6173 2062 6173 6564 2067 656f 206f  ndas based geo o
+00000750: 7065 7261 7469 6f6e 732e 0a0a 2020 2020  perations...    
+00000760: 2020 2020 4865 7572 6973 7469 6373 206d      Heuristics m
+00000770: 6561 6e74 2074 6f20 6265 2061 626c 6520  eant to be able 
+00000780: 746f 206f 7074 696d 697a 6520 7468 6520  to optimize the 
+00000790: 7061 7261 6c6c 656c 6973 6174 696f 6e20  parallelisation 
+000007a0: 7061 7261 6d65 7465 7273 2066 6f72 0a20  parameters for. 
+000007b0: 2020 2020 2020 2067 656f 7061 6e64 6173         geopandas
+000007c0: 2062 6173 6564 2067 656f 206f 7065 7261   based geo opera
+000007d0: 7469 6f6e 2e0a 0a20 2020 2020 2020 2041  tion...        A
+000007e0: 7267 733a 0a20 2020 2020 2020 2020 2020  rgs:.           
+000007f0: 2062 7974 6573 5f62 6173 6566 6f6f 7470   bytes_basefootp
+00000800: 7269 6e74 2028 696e 742c 206f 7074 696f  rint (int, optio
+00000810: 6e61 6c29 3a20 5468 6520 6261 7365 206d  nal): The base m
+00000820: 656d 6f72 7920 7573 6167 6520 6f66 2061  emory usage of a
+00000830: 2067 656f 6669 6c65 6f70 730a 2020 2020   geofileops.    
+00000840: 2020 2020 2020 2020 2020 2020 776f 726b              work
+00000850: 6572 2070 726f 6365 7373 2e20 4465 6661  er process. Defa
+00000860: 756c 7473 2074 6f20 3530 204d 422e 0a20  ults to 50 MB.. 
+00000870: 2020 2020 2020 2020 2020 2062 7974 6573             bytes
+00000880: 5f70 6572 5f72 6f77 2028 696e 742c 206f  _per_row (int, o
+00000890: 7074 696f 6e61 6c29 3a20 5468 6520 6e75  ptional): The nu
+000008a0: 6d62 6572 2069 6620 6279 7465 7320 6e65  mber if bytes ne
+000008b0: 6564 6564 2074 6f20 7374 6f72 652f 7072  eded to store/pr
+000008c0: 6f63 6573 730a 2020 2020 2020 2020 2020  ocess.          
+000008d0: 2020 2020 2020 6f6e 6520 726f 7720 6f66        one row of
+000008e0: 2064 6174 612e 2044 6566 6175 6c74 7320   data. Defaults 
+000008f0: 746f 2031 3030 302e 0a20 2020 2020 2020  to 1000..       
+00000900: 2020 2020 206d 696e 5f72 6f77 735f 7065       min_rows_pe
+00000910: 725f 6261 7463 6820 2869 6e74 2c20 6f70  r_batch (int, op
+00000920: 7469 6f6e 616c 293a 2054 6865 206d 696e  tional): The min
+00000930: 696d 756d 206e 756d 6265 7220 6f66 2072  imum number of r
+00000940: 6f77 7320 746f 2061 696d 2066 6f72 2069  ows to aim for i
+00000950: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
+00000960: 2020 6f6e 6520 6261 7463 682e 2044 6566    one batch. Def
+00000970: 6175 6c74 7320 746f 2031 3030 302e 0a20  aults to 1000.. 
+00000980: 2020 2020 2020 2020 2020 206d 6178 5f72             max_r
+00000990: 6f77 735f 7065 725f 6261 7463 6820 2869  ows_per_batch (i
+000009a0: 6e74 2c20 6f70 7469 6f6e 616c 293a 2054  nt, optional): T
+000009b0: 6865 206d 6178 696d 756d 206e 756d 6265  he maximum numbe
+000009c0: 7220 6f66 2072 6f77 7320 746f 2061 696d  r of rows to aim
+000009d0: 2066 6f72 2069 6e0a 2020 2020 2020 2020   for in.        
+000009e0: 2020 2020 2020 2020 6120 6261 7463 682e          a batch.
+000009f0: 2044 6566 6175 6c74 7320 746f 2031 3030   Defaults to 100
+00000a00: 3030 302e 0a20 2020 2020 2020 2020 2020  000..           
+00000a10: 2062 7974 6573 5f6d 696e 5f70 6572 5f70   bytes_min_per_p
+00000a20: 726f 6365 7373 2028 4f70 7469 6f6e 616c  rocess (Optional
+00000a30: 5b69 6e74 5d2c 206f 7074 696f 6e61 6c29  [int], optional)
+00000a40: 3a20 5468 6520 6d69 6e69 6d75 6d20 6e75  : The minimum nu
+00000a50: 6d62 6572 206f 6620 6279 7465 730a 2020  mber of bytes.  
+00000a60: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
+00000a70: 6564 6564 2066 6f72 2061 2067 656f 6669  eded for a geofi
+00000a80: 6c65 6f70 7320 776f 726b 6572 2070 726f  leops worker pro
+00000a90: 6365 7373 2e20 4465 6661 756c 7473 2074  cess. Defaults t
+00000aa0: 6f20 4e6f 6e65 2e0a 2020 2020 2020 2020  o None..        
+00000ab0: 2020 2020 6279 7465 735f 7573 6162 6c65      bytes_usable
+00000ac0: 2028 4f70 7469 6f6e 616c 5b69 6e74 5d2c   (Optional[int],
+00000ad0: 206f 7074 696f 6e61 6c29 3a20 7468 6520   optional): the 
+00000ae0: 6d65 6d6f 7279 2061 7661 696c 6162 6c65  memory available
+00000af0: 2066 6f72 2070 726f 6365 7373 696e 672e   for processing.
+00000b00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00000b10: 2044 6566 6175 6c74 7320 746f 204e 6f6e   Defaults to Non
+00000b20: 652c 2074 6865 6e20 7468 6520 6672 6565  e, then the free
+00000b30: 206d 656d 6f72 7920 6973 2061 7574 6f6d   memory is autom
+00000b40: 6174 6963 616c 6c79 2064 6574 6572 6d69  atically determi
+00000b50: 6e65 642e 0a20 2020 2020 2020 2020 2020  ned..           
+00000b60: 2063 7075 5f63 6f75 6e74 2028 696e 742c   cpu_count (int,
+00000b70: 206f 7074 696f 6e61 6c29 3a20 7468 6520   optional): the 
+00000b80: 6e75 6d62 6572 206f 6620 4350 5527 7320  number of CPU's 
+00000b90: 6176 6169 6c61 626c 652e 2044 6566 6175  available. Defau
+00000ba0: 6c74 7320 746f 202d 312c 0a20 2020 2020  lts to -1,.     
+00000bb0: 2020 2020 2020 2020 2020 2074 6865 6e20             then 
+00000bc0: 7468 6520 6370 755f 636f 756e 7420 6973  the cpu_count is
+00000bd0: 2064 6574 6572 6d69 6e65 6420 6175 746f   determined auto
+00000be0: 6d61 7469 6361 6c6c 792e 0a20 2020 2020  matically..     
+00000bf0: 2020 2022 2222 0a20 2020 2020 2020 2073     """.        s
+00000c00: 656c 662e 6279 7465 735f 6261 7365 666f  elf.bytes_basefo
+00000c10: 6f74 7072 696e 7420 3d20 6279 7465 735f  otprint = bytes_
+00000c20: 6261 7365 666f 6f74 7072 696e 740a 2020  basefootprint.  
+00000c30: 2020 2020 2020 7365 6c66 2e62 7974 6573        self.bytes
+00000c40: 5f70 6572 5f72 6f77 203d 2062 7974 6573  _per_row = bytes
+00000c50: 5f70 6572 5f72 6f77 0a20 2020 2020 2020  _per_row.       
+00000c60: 2073 656c 662e 6d69 6e5f 726f 7773 5f70   self.min_rows_p
+00000c70: 6572 5f62 6174 6368 203d 206d 696e 5f72  er_batch = min_r
+00000c80: 6f77 735f 7065 725f 6261 7463 680a 2020  ows_per_batch.  
+00000c90: 2020 2020 2020 7365 6c66 2e6d 6178 5f72        self.max_r
+00000ca0: 6f77 735f 7065 725f 6261 7463 6820 3d20  ows_per_batch = 
+00000cb0: 6d61 785f 726f 7773 5f70 6572 5f62 6174  max_rows_per_bat
+00000cc0: 6368 0a0a 2020 2020 2020 2020 2320 4e65  ch..        # Ne
+00000cd0: 6564 7320 736f 6d65 206c 6f67 6963 2074  eds some logic t
+00000ce0: 6f20 6765 7420 7661 6c75 6520 6966 206e  o get value if n
+00000cf0: 6f74 2073 6574 2065 7870 6c69 6369 746c  ot set explicitl
+00000d00: 792e 2e2e 0a20 2020 2020 2020 2073 656c  y....        sel
+00000d10: 662e 5f62 7974 6573 5f6d 696e 5f70 6572  f._bytes_min_per
+00000d20: 5f70 726f 6365 7373 203d 2062 7974 6573  _process = bytes
+00000d30: 5f6d 696e 5f70 6572 5f70 726f 6365 7373  _min_per_process
+00000d40: 0a20 2020 2020 2020 2023 2049 6620 6e6f  .        # If no
+00000d50: 7420 7370 6563 6966 6965 642c 2064 6574  t specified, det
+00000d60: 6572 6d69 6e65 2079 6f75 7273 656c 660a  ermine yourself.
+00000d70: 2020 2020 2020 2020 7365 6c66 2e62 7974          self.byt
+00000d80: 6573 5f75 7361 626c 6520 3d20 280a 2020  es_usable = (.  
+00000d90: 2020 2020 2020 2020 2020 6279 7465 735f            bytes_
+00000da0: 7573 6162 6c65 0a20 2020 2020 2020 2020  usable.         
+00000db0: 2020 2069 6620 6279 7465 735f 7573 6162     if bytes_usab
+00000dc0: 6c65 2069 7320 6e6f 7420 4e6f 6e65 0a20  le is not None. 
+00000dd0: 2020 2020 2020 2020 2020 2065 6c73 6520             else 
+00000de0: 696e 7428 7073 7574 696c 2e76 6972 7475  int(psutil.virtu
+00000df0: 616c 5f6d 656d 6f72 7928 292e 6176 6169  al_memory().avai
+00000e00: 6c61 626c 6520 2a20 302e 3929 0a20 2020  lable * 0.9).   
+00000e10: 2020 2020 2029 0a20 2020 2020 2020 2023       ).        #
+00000e20: 2049 6620 6e6f 7420 7370 6563 6966 6965   If not specifie
+00000e30: 642c 2064 6574 6572 6d69 6e65 2079 6f75  d, determine you
+00000e40: 7273 656c 660a 2020 2020 2020 2020 7365  rself.        se
+00000e50: 6c66 2e63 7075 5f63 6f75 6e74 203d 2063  lf.cpu_count = c
+00000e60: 7075 5f63 6f75 6e74 2069 6620 6370 755f  pu_count if cpu_
+00000e70: 636f 756e 7420 3e20 3020 656c 7365 206d  count > 0 else m
+00000e80: 756c 7469 7072 6f63 6573 7369 6e67 2e63  ultiprocessing.c
+00000e90: 7075 5f63 6f75 6e74 2829 0a0a 2020 2020  pu_count()..    
+00000ea0: 4070 726f 7065 7274 790a 2020 2020 6465  @property.    de
+00000eb0: 6620 6279 7465 735f 6d69 6e5f 7065 725f  f bytes_min_per_
+00000ec0: 7072 6f63 6573 7328 7365 6c66 293a 0a20  process(self):. 
+00000ed0: 2020 2020 2020 2069 6620 7365 6c66 2e5f         if self._
+00000ee0: 6279 7465 735f 6d69 6e5f 7065 725f 7072  bytes_min_per_pr
+00000ef0: 6f63 6573 7320 6973 206e 6f74 204e 6f6e  ocess is not Non
+00000f00: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+00000f10: 6574 7572 6e20 7365 6c66 2e5f 6279 7465  eturn self._byte
+00000f20: 735f 6d69 6e5f 7065 725f 7072 6f63 6573  s_min_per_proces
+00000f30: 730a 2020 2020 2020 2020 656c 7365 3a0a  s.        else:.
+00000f40: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00000f50: 726e 2028 0a20 2020 2020 2020 2020 2020  rn (.           
+00000f60: 2020 2020 2073 656c 662e 6279 7465 735f       self.bytes_
+00000f70: 6261 7365 666f 6f74 7072 696e 7420 2b20  basefootprint + 
+00000f80: 7365 6c66 2e62 7974 6573 5f70 6572 5f72  self.bytes_per_r
+00000f90: 6f77 202a 2073 656c 662e 6d69 6e5f 726f  ow * self.min_ro
+00000fa0: 7773 5f70 6572 5f62 6174 6368 0a20 2020  ws_per_batch.   
+00000fb0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+00000fc0: 4062 7974 6573 5f6d 696e 5f70 6572 5f70  @bytes_min_per_p
+00000fd0: 726f 6365 7373 2e73 6574 7465 720a 2020  rocess.setter.  
+00000fe0: 2020 6465 6620 6279 7465 735f 6d69 6e5f    def bytes_min_
+00000ff0: 7065 725f 7072 6f63 6573 7328 7365 6c66  per_process(self
+00001000: 2c20 7661 6c75 6529 3a0a 2020 2020 2020  , value):.      
+00001010: 2020 7365 6c66 2e5f 6279 7465 735f 6d69    self._bytes_mi
+00001020: 6e5f 7065 725f 7072 6f63 6573 7320 3d20  n_per_process = 
+00001030: 7661 6c75 650a 0a0a 6465 6620 5f64 6574  value...def _det
+00001040: 6572 6d69 6e65 5f6e 625f 6261 7463 6865  ermine_nb_batche
+00001050: 7328 0a20 2020 206e 625f 726f 7773 5f74  s(.    nb_rows_t
+00001060: 6f74 616c 3a20 696e 742c 0a20 2020 206e  otal: int,.    n
+00001070: 625f 7061 7261 6c6c 656c 3a20 696e 7420  b_parallel: int 
+00001080: 3d20 2d31 2c0a 2020 2020 6261 7463 6873  = -1,.    batchs
+00001090: 697a 653a 2069 6e74 203d 202d 312c 0a20  ize: int = -1,. 
+000010a0: 2020 2070 6172 616c 6c65 6c69 7a61 7469     parallelizati
+000010b0: 6f6e 5f63 6f6e 6669 673a 204f 7074 696f  on_config: Optio
+000010c0: 6e61 6c5b 5061 7261 6c6c 656c 697a 6174  nal[Parallelizat
+000010d0: 696f 6e43 6f6e 6669 675d 203d 204e 6f6e  ionConfig] = Non
+000010e0: 652c 0a29 202d 3e20 7475 706c 655b 696e  e,.) -> tuple[in
+000010f0: 742c 2069 6e74 5d3a 0a20 2020 2022 2222  t, int]:.    """
+00001100: 0a20 2020 2044 6574 6572 6d69 6e65 7320  .    Determines 
+00001110: 7265 636f 6d6d 656e 6465 6420 7061 7261  recommended para
+00001120: 6c6c 656c 697a 6174 696f 6e20 7061 7261  llelization para
+00001130: 6d73 2e0a 0a20 2020 2041 7267 733a 0a20  ms...    Args:. 
+00001140: 2020 2020 2020 206e 625f 726f 7773 5f74         nb_rows_t
+00001150: 6f74 616c 2028 696e 7429 3a20 5468 6520  otal (int): The 
+00001160: 746f 7461 6c20 6e75 6d62 6572 206f 6620  total number of 
+00001170: 726f 7773 2074 6861 7420 7769 6c6c 2062  rows that will b
+00001180: 6520 7072 6f63 6573 7365 640a 2020 2020  e processed.    
+00001190: 2020 2020 6e62 5f70 6172 616c 6c65 6c20      nb_parallel 
+000011a0: 2869 6e74 293a 2054 6865 206c 6576 656c  (int): The level
+000011b0: 206f 6620 7061 7261 6c6c 656c 697a 6174   of parallelizat
+000011c0: 696f 6e20 7265 7175 6573 7465 642e 0a20  ion requested.. 
+000011d0: 2020 2020 2020 2020 2020 2049 6620 2d31             If -1
+000011e0: 2c20 7472 6965 7320 746f 2075 7365 2061  , tries to use a
+000011f0: 6c6c 2072 6573 6f75 7263 6573 2061 7661  ll resources ava
+00001200: 696c 6162 6c65 2e0a 2020 2020 2020 2020  ilable..        
+00001210: 6261 7463 6873 697a 6520 2869 6e74 293a  batchsize (int):
+00001220: 2069 6e64 6963 6174 6976 6520 6e75 6d62   indicative numb
+00001230: 6572 206f 6620 726f 7773 2074 6f20 7072  er of rows to pr
+00001240: 6f63 6573 7320 7065 7220 6261 7463 682e  ocess per batch.
+00001250: 0a20 2020 2020 2020 2020 2020 2049 6620  .            If 
+00001260: 2d31 3a20 2874 7279 2074 6f29 2064 6574  -1: (try to) det
+00001270: 6572 6d69 6e65 206f 7074 696d 616c 2073  ermine optimal s
+00001280: 697a 6520 6175 746f 6d61 7469 6361 6c6c  ize automaticall
+00001290: 7920 7573 696e 6720 7468 6520 6865 7572  y using the heur
+000012a0: 6973 7469 6373 2069 6e0a 2020 2020 2020  istics in.      
+000012b0: 2020 2020 2020 2770 6172 616c 6c65 6c69        'paralleli
+000012c0: 7a61 7469 6f6e 5f63 6f6e 6669 6727 2e0a  zation_config'..
+000012d0: 2020 2020 2020 2020 7061 7261 6c6c 656c          parallel
+000012e0: 697a 6174 696f 6e5f 636f 6e66 6967 2028  ization_config (
+000012f0: 5061 7261 6c6c 656c 697a 6174 696f 6e43  ParallelizationC
+00001300: 6f6e 6669 672c 206f 7074 696f 6e61 6c29  onfig, optional)
+00001310: 3a20 436f 6e66 6967 7572 6174 696f 6e0a  : Configuration.
+00001320: 2020 2020 2020 2020 2020 2020 7061 7261              para
+00001330: 6d65 7465 7273 2074 6f20 7573 6520 746f  meters to use to
+00001340: 2073 7567 6765 7374 2070 6172 616c 6c65   suggest paralle
+00001350: 6c69 7361 7469 6f6e 2070 6172 616d 6574  lisation paramet
+00001360: 6572 732e 0a0a 2020 2020 5265 7475 726e  ers...    Return
+00001370: 733a 0a20 2020 2020 2020 2054 7570 6c65  s:.        Tuple
+00001380: 5b69 6e74 2c20 696e 745d 3a20 5475 706c  [int, int]: Tupl
+00001390: 6520 6f66 2028 6e62 5f70 6172 616c 6c65  e of (nb_paralle
+000013a0: 6c2c 206e 625f 6261 7463 6865 7329 0a20  l, nb_batches). 
+000013b0: 2020 2022 2222 0a20 2020 2023 2049 6620     """.    # If 
+000013c0: 3020 6f72 2031 2072 6f77 7320 746f 2070  0 or 1 rows to p
+000013d0: 726f 6365 7373 2c20 6f6e 6520 6261 7463  rocess, one batc
+000013e0: 680a 2020 2020 6966 206e 625f 726f 7773  h.    if nb_rows
+000013f0: 5f74 6f74 616c 203c 3d20 313a 0a20 2020  _total <= 1:.   
+00001400: 2020 2020 2072 6574 7572 6e20 2831 2c20       return (1, 
+00001410: 3129 0a0a 2020 2020 2320 4966 2063 6f6e  1)..    # If con
+00001420: 6669 6720 6973 204e 6f6e 652c 2075 7365  fig is None, use
+00001430: 2064 6566 6175 6c74 2063 6f6e 6669 670a   default config.
+00001440: 2020 2020 6966 2070 6172 616c 6c65 6c69      if paralleli
+00001450: 7a61 7469 6f6e 5f63 6f6e 6669 6720 6973  zation_config is
+00001460: 204e 6f6e 653a 0a20 2020 2020 2020 2063   None:.        c
+00001470: 6f6e 6669 675f 6c6f 6361 6c20 3d20 5061  onfig_local = Pa
+00001480: 7261 6c6c 656c 697a 6174 696f 6e43 6f6e  rallelizationCon
+00001490: 6669 6728 290a 2020 2020 656c 7365 3a0a  fig().    else:.
+000014a0: 2020 2020 2020 2020 636f 6e66 6967 5f6c          config_l
+000014b0: 6f63 616c 203d 2063 6f70 792e 6465 6570  ocal = copy.deep
+000014c0: 636f 7079 2870 6172 616c 6c65 6c69 7a61  copy(paralleliza
+000014d0: 7469 6f6e 5f63 6f6e 6669 6729 0a0a 2020  tion_config)..  
+000014e0: 2020 2320 4966 2074 6865 206e 756d 6265    # If the numbe
+000014f0: 7220 6f66 2072 6f77 7320 6973 2072 6561  r of rows is rea
+00001500: 6c6c 7920 6c6f 772c 206a 7573 7420 7573  lly low, just us
+00001510: 6520 6f6e 6520 6261 7463 680a 2020 2020  e one batch.    
+00001520: 6966 206e 625f 7061 7261 6c6c 656c 203c  if nb_parallel <
+00001530: 2031 2061 6e64 2062 6174 6368 7369 7a65   1 and batchsize
+00001540: 203c 2031 3a0a 2020 2020 2020 2020 6966   < 1:.        if
+00001550: 206e 625f 726f 7773 5f74 6f74 616c 203c   nb_rows_total <
+00001560: 3d20 636f 6e66 6967 5f6c 6f63 616c 2e6d  = config_local.m
+00001570: 696e 5f72 6f77 735f 7065 725f 6261 7463  in_rows_per_batc
+00001580: 683a 0a20 2020 2020 2020 2020 2020 2072  h:.            r
+00001590: 6574 7572 6e20 2831 2c20 3129 0a0a 2020  eturn (1, 1)..  
+000015a0: 2020 6966 206e 625f 7061 7261 6c6c 656c    if nb_parallel
+000015b0: 203c 3d20 303a 0a20 2020 2020 2020 206e   <= 0:.        n
+000015c0: 625f 7061 7261 6c6c 656c 203d 2063 6f6e  b_parallel = con
+000015d0: 6669 675f 6c6f 6361 6c2e 6370 755f 636f  fig_local.cpu_co
+000015e0: 756e 740a 0a20 2020 2069 6620 6c6f 6767  unt..    if logg
+000015f0: 6572 2e69 7345 6e61 626c 6564 466f 7228  er.isEnabledFor(
+00001600: 6c6f 6767 696e 672e 4445 4255 4729 3a0a  logging.DEBUG):.
+00001610: 2020 2020 2020 2020 6d65 6d5f 7573 6162          mem_usab
+00001620: 6c65 203d 205f 6765 6e65 7261 6c5f 7574  le = _general_ut
+00001630: 696c 2e66 6f72 6d61 7462 7974 6573 2863  il.formatbytes(c
+00001640: 6f6e 6669 675f 6c6f 6361 6c2e 6279 7465  onfig_local.byte
+00001650: 735f 7573 6162 6c65 290a 2020 2020 2020  s_usable).      
+00001660: 2020 6c6f 6767 6572 2e64 6562 7567 2866    logger.debug(f
+00001670: 226d 656d 6f72 795f 7573 6162 6c65 3a20  "memory_usable: 
+00001680: 7b6d 656d 5f75 7361 626c 657d 2c20 7769  {mem_usable}, wi
+00001690: 7468 3a22 290a 2020 2020 2020 2020 6d65  th:").        me
+000016a0: 6d5f 6176 6169 6c61 626c 6520 3d20 5f67  m_available = _g
+000016b0: 656e 6572 616c 5f75 7469 6c2e 666f 726d  eneral_util.form
+000016c0: 6174 6279 7465 7328 7073 7574 696c 2e76  atbytes(psutil.v
+000016d0: 6972 7475 616c 5f6d 656d 6f72 7928 292e  irtual_memory().
+000016e0: 6176 6169 6c61 626c 6529 0a20 2020 2020  available).     
+000016f0: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
+00001700: 6622 2020 2d3e 206d 656d 2e61 7661 696c  f"  -> mem.avail
+00001710: 6162 6c65 3a20 7b6d 656d 5f61 7661 696c  able: {mem_avail
+00001720: 6162 6c65 7d22 290a 2020 2020 2020 2020  able}").        
+00001730: 7377 6170 5f66 7265 6520 3d20 5f67 656e  swap_free = _gen
+00001740: 6572 616c 5f75 7469 6c2e 666f 726d 6174  eral_util.format
+00001750: 6279 7465 7328 7073 7574 696c 2e73 7761  bytes(psutil.swa
+00001760: 705f 6d65 6d6f 7279 2829 2e66 7265 6529  p_memory().free)
+00001770: 0a20 2020 2020 2020 206c 6f67 6765 722e  .        logger.
+00001780: 6465 6275 6728 6622 2020 2d3e 2073 7761  debug(f"  -> swa
+00001790: 702e 6672 6565 3a20 7b73 7761 705f 6672  p.free: {swap_fr
+000017a0: 6565 7d22 290a 0a20 2020 2023 2049 6620  ee}")..    # If 
+000017b0: 6e6f 7420 656e 6f75 6768 206d 656d 6f72  not enough memor
+000017c0: 7920 666f 7220 7468 6520 616d 6f75 6e74  y for the amount
+000017d0: 206f 6620 7061 7261 6c6c 656c 6c69 736d   of parallellism
+000017e0: 2061 736b 6564 2c20 7265 6475 6365 0a20   asked, reduce. 
+000017f0: 2020 2069 6620 286e 625f 7061 7261 6c6c     if (nb_parall
+00001800: 656c 202a 2063 6f6e 6669 675f 6c6f 6361  el * config_loca
+00001810: 6c2e 6279 7465 735f 6d69 6e5f 7065 725f  l.bytes_min_per_
+00001820: 7072 6f63 6573 7329 203e 2063 6f6e 6669  process) > confi
+00001830: 675f 6c6f 6361 6c2e 6279 7465 735f 7573  g_local.bytes_us
+00001840: 6162 6c65 3a0a 2020 2020 2020 2020 6e62  able:.        nb
+00001850: 5f70 6172 616c 6c65 6c20 3d20 696e 7428  _parallel = int(
+00001860: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+00001870: 6669 675f 6c6f 6361 6c2e 6279 7465 735f  fig_local.bytes_
+00001880: 7573 6162 6c65 202f 2063 6f6e 6669 675f  usable / config_
+00001890: 6c6f 6361 6c2e 6279 7465 735f 6d69 6e5f  local.bytes_min_
+000018a0: 7065 725f 7072 6f63 6573 730a 2020 2020  per_process.    
+000018b0: 2020 2020 290a 2020 2020 2020 2020 6c6f      ).        lo
+000018c0: 6767 6572 2e64 6562 7567 2866 224e 625f  gger.debug(f"Nb_
+000018d0: 7061 7261 6c6c 656c 2072 6564 7563 6564  parallel reduced
+000018e0: 2074 6f20 7b6e 625f 7061 7261 6c6c 656c   to {nb_parallel
+000018f0: 7d20 746f 2072 6564 7563 6520 6d65 6d6f  } to reduce memo
+00001900: 7279 2075 7361 6765 2229 0a0a 2020 2020  ry usage")..    
+00001910: 2320 4861 7669 6e67 206d 6f72 6520 776f  # Having more wo
+00001920: 726b 6572 7320 7468 616e 2072 6f77 7320  rkers than rows 
+00001930: 646f 6573 6e27 7420 6d61 6b65 2073 656e  doesn't make sen
+00001940: 7365 0a20 2020 2069 6620 6e62 5f70 6172  se.    if nb_par
+00001950: 616c 6c65 6c20 3e20 6e62 5f72 6f77 735f  allel > nb_rows_
+00001960: 746f 7461 6c3a 0a20 2020 2020 2020 206e  total:.        n
+00001970: 625f 7061 7261 6c6c 656c 203d 206e 625f  b_parallel = nb_
+00001980: 726f 7773 5f74 6f74 616c 0a0a 2020 2020  rows_total..    
+00001990: 2320 4966 2062 6174 6368 7369 7a65 2069  # If batchsize i
+000019a0: 7320 7370 6563 6966 6965 642c 2075 7365  s specified, use
+000019b0: 2069 7420 746f 2064 6574 6572 6d69 6e65   it to determine
+000019c0: 206e 756d 6265 7220 6f66 2062 6174 6368   number of batch
+000019d0: 6573 2e0a 2020 2020 6966 2062 6174 6368  es..    if batch
+000019e0: 7369 7a65 203e 2030 3a0a 2020 2020 2020  size > 0:.      
+000019f0: 2020 6e62 5f62 6174 6368 6573 203d 206d    nb_batches = m
+00001a00: 6174 682e 6365 696c 286e 625f 726f 7773  ath.ceil(nb_rows
+00001a10: 5f74 6f74 616c 202f 2062 6174 6368 7369  _total / batchsi
+00001a20: 7a65 290a 0a20 2020 2020 2020 2023 204e  ze)..        # N
+00001a30: 6f20 7573 6520 746f 2068 6176 6520 6d6f  o use to have mo
+00001a40: 7265 2077 6f72 6b65 7273 2074 6861 6e20  re workers than 
+00001a50: 6e75 6d62 6572 206f 6620 6261 7463 6865  number of batche
+00001a60: 730a 2020 2020 2020 2020 6966 206e 625f  s.        if nb_
+00001a70: 7061 7261 6c6c 656c 203e 206e 625f 6261  parallel > nb_ba
+00001a80: 7463 6865 733a 0a20 2020 2020 2020 2020  tches:.         
+00001a90: 2020 206e 625f 7061 7261 6c6c 656c 203d     nb_parallel =
+00001aa0: 206e 625f 6261 7463 6865 730a 0a20 2020   nb_batches..   
+00001ab0: 2020 2020 2072 6574 7572 6e20 286e 625f       return (nb_
+00001ac0: 7061 7261 6c6c 656c 2c20 6e62 5f62 6174  parallel, nb_bat
+00001ad0: 6368 6573 290a 0a20 2020 2023 204e 6f20  ches)..    # No 
+00001ae0: 6261 7463 6873 697a 6520 7370 6563 6966  batchsize specif
+00001af0: 6965 642c 2073 6f20 7573 6520 6865 7572  ied, so use heur
+00001b00: 6973 7469 6373 2e0a 2020 2020 2320 5374  istics..    # St
+00001b10: 6172 7420 7769 7468 2031 2062 6174 6368  art with 1 batch
+00001b20: 2070 6572 2077 6f72 6b65 720a 2020 2020   per worker.    
+00001b30: 6e62 5f62 6174 6368 6573 203d 206e 625f  nb_batches = nb_
+00001b40: 7061 7261 6c6c 656c 0a0a 2020 2020 2320  parallel..    # 
+00001b50: 4966 2074 6865 2062 6174 6368 6573 203c  If the batches <
+00001b60: 206d 696e 5f72 6f77 735f 7065 725f 6261   min_rows_per_ba
+00001b70: 7463 682c 2064 6563 7265 6173 6520 6e75  tch, decrease nu
+00001b80: 6d62 6572 2062 6174 6368 6573 0a20 2020  mber batches.   
+00001b90: 2069 6620 6e62 5f72 6f77 735f 746f 7461   if nb_rows_tota
+00001ba0: 6c20 2f20 6e62 5f62 6174 6368 6573 203c  l / nb_batches <
+00001bb0: 2063 6f6e 6669 675f 6c6f 6361 6c2e 6d69   config_local.mi
+00001bc0: 6e5f 726f 7773 5f70 6572 5f62 6174 6368  n_rows_per_batch
+00001bd0: 3a0a 2020 2020 2020 2020 6e62 5f62 6174  :.        nb_bat
+00001be0: 6368 6573 203d 206d 6174 682e 6365 696c  ches = math.ceil
+00001bf0: 286e 625f 726f 7773 5f74 6f74 616c 202f  (nb_rows_total /
+00001c00: 2063 6f6e 6669 675f 6c6f 6361 6c2e 6d69   config_local.mi
+00001c10: 6e5f 726f 7773 5f70 6572 5f62 6174 6368  n_rows_per_batch
+00001c20: 290a 0a20 2020 2023 2049 6620 7468 6520  )..    # If the 
+00001c30: 6261 7463 6865 7320 3e20 6d61 785f 726f  batches > max_ro
+00001c40: 7773 5f70 6572 5f62 6174 6368 2c20 696e  ws_per_batch, in
+00001c50: 6372 6561 7365 206e 756d 6265 7220 6261  crease number ba
+00001c60: 7463 6865 730a 2020 2020 6966 206e 625f  tches.    if nb_
+00001c70: 726f 7773 5f74 6f74 616c 202f 206e 625f  rows_total / nb_
+00001c80: 6261 7463 6865 7320 3e20 636f 6e66 6967  batches > config
+00001c90: 5f6c 6f63 616c 2e6d 6178 5f72 6f77 735f  _local.max_rows_
+00001ca0: 7065 725f 6261 7463 683a 0a20 2020 2020  per_batch:.     
+00001cb0: 2020 206e 625f 6261 7463 6865 7320 3d20     nb_batches = 
+00001cc0: 6d61 7468 2e63 6569 6c28 6e62 5f72 6f77  math.ceil(nb_row
+00001cd0: 735f 746f 7461 6c20 2f20 636f 6e66 6967  s_total / config
+00001ce0: 5f6c 6f63 616c 2e6d 6178 5f72 6f77 735f  _local.max_rows_
+00001cf0: 7065 725f 6261 7463 6829 0a20 2020 2020  per_batch).     
+00001d00: 2020 2023 2052 6f75 6e64 206e 625f 6261     # Round nb_ba
+00001d10: 7463 6865 7320 7570 2074 6f20 7468 6520  tches up to the 
+00001d20: 6e65 6172 6573 7420 6d75 6c74 6970 6c65  nearest multiple
+00001d30: 206f 6620 6e62 5f70 6172 616c 6c65 6c0a   of nb_parallel.
+00001d40: 2020 2020 2020 2020 6e62 5f62 6174 6368          nb_batch
+00001d50: 6573 203d 206d 6174 682e 6365 696c 286e  es = math.ceil(n
+00001d60: 625f 6261 7463 6865 7320 2f20 6e62 5f70  b_batches / nb_p
+00001d70: 6172 616c 6c65 6c29 202a 206e 625f 7061  arallel) * nb_pa
+00001d80: 7261 6c6c 656c 0a0a 2020 2020 2320 4861  rallel..    # Ha
+00001d90: 7669 6e67 206d 6f72 6520 776f 726b 6572  ving more worker
+00001da0: 7320 7468 616e 2062 6174 6368 6573 2069  s than batches i
+00001db0: 736e 2774 206c 6f67 6963 616c 2e2e 2e0a  sn't logical....
+00001dc0: 2020 2020 6966 206e 625f 7061 7261 6c6c      if nb_parall
+00001dd0: 656c 203e 206e 625f 6261 7463 6865 733a  el > nb_batches:
+00001de0: 0a20 2020 2020 2020 206e 625f 7061 7261  .        nb_para
+00001df0: 6c6c 656c 203d 206e 625f 6261 7463 6865  llel = nb_batche
+00001e00: 730a 0a20 2020 2023 2046 696e 616c 6c79  s..    # Finally
+00001e10: 2c20 6d61 6b65 2073 7572 6520 7468 6572  , make sure ther
+00001e20: 6520 6172 6520 656e 6f75 6768 2062 6174  e are enough bat
+00001e30: 6368 6573 2074 6f20 6176 6f69 6420 6d65  ches to avoid me
+00001e40: 6d6f 7279 2069 7373 7565 733a 0a20 2020  mory issues:.   
+00001e50: 2023 2020 203d 2074 6f74 616c 206d 656d   #   = total mem
+00001e60: 6f72 7920 7573 6167 6520 666f 7220 616c  ory usage for al
+00001e70: 6c20 726f 7773 202f 0a20 2020 2023 2020  l rows /.    #  
+00001e80: 2020 2028 6672 6565 206d 656d 6f72 7920     (free memory 
+00001e90: 2d20 6261 7365 206d 656d 6f72 7920 7573  - base memory us
+00001ea0: 6564 2062 7920 616c 6c20 7061 7261 6c6c  ed by all parall
+00001eb0: 656c 2070 726f 6365 7373 6573 290a 2020  el processes).  
+00001ec0: 2020 6e62 5f62 6174 6368 6573 5f6d 696e    nb_batches_min
+00001ed0: 203d 206d 6174 682e 6365 696c 280a 2020   = math.ceil(.  
+00001ee0: 2020 2020 2020 286e 625f 726f 7773 5f74        (nb_rows_t
+00001ef0: 6f74 616c 202a 2063 6f6e 6669 675f 6c6f  otal * config_lo
+00001f00: 6361 6c2e 6279 7465 735f 7065 725f 726f  cal.bytes_per_ro
+00001f10: 7729 0a20 2020 2020 2020 202f 2028 636f  w).        / (co
+00001f20: 6e66 6967 5f6c 6f63 616c 2e62 7974 6573  nfig_local.bytes
+00001f30: 5f75 7361 626c 6520 2d20 636f 6e66 6967  _usable - config
+00001f40: 5f6c 6f63 616c 2e62 7974 6573 5f62 6173  _local.bytes_bas
+00001f50: 6566 6f6f 7470 7269 6e74 202a 206e 625f  efootprint * nb_
+00001f60: 7061 7261 6c6c 656c 290a 2020 2020 290a  parallel).    ).
+00001f70: 2020 2020 6966 206e 625f 6261 7463 6865      if nb_batche
+00001f80: 7320 3c20 6e62 5f62 6174 6368 6573 5f6d  s < nb_batches_m
+00001f90: 696e 3a0a 2020 2020 2020 2020 2320 526f  in:.        # Ro
+00001fa0: 756e 6420 6e62 5f62 6174 6368 6573 2075  und nb_batches u
+00001fb0: 7020 746f 2074 6865 206e 6561 7265 7374  p to the nearest
+00001fc0: 206d 756c 7469 706c 6520 6f66 206e 625f   multiple of nb_
+00001fd0: 7061 7261 6c6c 656c 0a20 2020 2020 2020  parallel.       
+00001fe0: 206e 625f 6261 7463 6865 7320 3d20 6d61   nb_batches = ma
+00001ff0: 7468 2e63 6569 6c28 6e62 5f62 6174 6368  th.ceil(nb_batch
+00002000: 6573 5f6d 696e 202f 206e 625f 7061 7261  es_min / nb_para
+00002010: 6c6c 656c 2920 2a20 6e62 5f70 6172 616c  llel) * nb_paral
+00002020: 6c65 6c0a 0a20 2020 2023 204c 6f67 2072  lel..    # Log r
+00002030: 6573 756c 740a 2020 2020 6966 206c 6f67  esult.    if log
+00002040: 6765 722e 6973 456e 6162 6c65 6446 6f72  ger.isEnabledFor
+00002050: 286c 6f67 6769 6e67 2e44 4542 5547 293a  (logging.DEBUG):
+00002060: 0a20 2020 2020 2020 2062 6174 6368 7369  .        batchsi
+00002070: 7a65 203d 206d 6174 682e 6365 696c 286e  ze = math.ceil(n
+00002080: 625f 726f 7773 5f74 6f74 616c 202f 206e  b_rows_total / n
+00002090: 625f 6261 7463 6865 7329 0a20 2020 2020  b_batches).     
+000020a0: 2020 206d 656d 5f70 7265 6469 6374 6564     mem_predicted
+000020b0: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
+000020c0: 2063 6f6e 6669 675f 6c6f 6361 6c2e 6279   config_local.by
+000020d0: 7465 735f 6261 7365 666f 6f74 7072 696e  tes_basefootprin
+000020e0: 7420 2b20 6261 7463 6873 697a 6520 2a20  t + batchsize * 
+000020f0: 636f 6e66 6967 5f6c 6f63 616c 2e62 7974  config_local.byt
+00002100: 6573 5f70 6572 5f72 6f77 0a20 2020 2020  es_per_row.     
+00002110: 2020 2029 202a 206e 625f 6261 7463 6865     ) * nb_batche
+00002120: 730a 0a20 2020 2020 2020 206c 6f67 6765  s..        logge
+00002130: 722e 6465 6275 6728 0a20 2020 2020 2020  r.debug(.       
+00002140: 2020 2020 2066 226e 625f 6261 7463 6865       f"nb_batche
+00002150: 735f 7265 636f 6d6d 656e 6465 643a 207b  s_recommended: {
+00002160: 6e62 5f62 6174 6368 6573 7d2c 2072 6f77  nb_batches}, row
+00002170: 735f 7065 725f 6261 7463 683a 207b 6261  s_per_batch: {ba
+00002180: 7463 6873 697a 657d 220a 2020 2020 2020  tchsize}".      
+00002190: 2020 290a 2020 2020 2020 2020 6c6f 6767    ).        logg
+000021a0: 6572 2e64 6562 7567 2866 2220 2d3e 206e  er.debug(f" -> n
+000021b0: 625f 726f 7773 5f69 6e70 7574 5f6c 6179  b_rows_input_lay
+000021c0: 6572 3a20 7b6e 625f 726f 7773 5f74 6f74  er: {nb_rows_tot
+000021d0: 616c 7d22 290a 2020 2020 2020 2020 6c6f  al}").        lo
+000021e0: 6767 6572 2e64 6562 7567 2866 2220 2d3e  gger.debug(f" ->
+000021f0: 206d 656d 5f70 7265 6469 6374 6564 3a20   mem_predicted: 
+00002200: 7b5f 6765 6e65 7261 6c5f 7574 696c 2e66  {_general_util.f
+00002210: 6f72 6d61 7462 7974 6573 286d 656d 5f70  ormatbytes(mem_p
+00002220: 7265 6469 6374 6564 297d 2229 0a0a 2020  redicted)}")..  
+00002230: 2020 7265 7475 726e 2028 6e62 5f70 6172    return (nb_par
+00002240: 616c 6c65 6c2c 206e 625f 6261 7463 6865  allel, nb_batche
+00002250: 7329 0a0a 0a63 6c61 7373 2050 726f 6365  s)...class Proce
+00002260: 7373 696e 6750 6172 616d 733a 0a20 2020  ssingParams:.   
+00002270: 2064 6566 205f 5f69 6e69 745f 5f28 0a20   def __init__(. 
+00002280: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+00002290: 2020 2020 206e 625f 726f 7773 5f74 6f5f       nb_rows_to_
+000022a0: 7072 6f63 6573 733a 2069 6e74 2c0a 2020  process: int,.  
+000022b0: 2020 2020 2020 6e62 5f70 6172 616c 6c65        nb_paralle
+000022c0: 6c3a 2069 6e74 2c0a 2020 2020 2020 2020  l: int,.        
+000022d0: 6261 7463 6865 733a 206c 6973 745b 7374  batches: list[st
+000022e0: 725d 2c0a 2020 2020 2020 2020 6261 7463  r],.        batc
+000022f0: 6873 697a 653a 2069 6e74 2c0a 2020 2020  hsize: int,.    
+00002300: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+00002310: 6e62 5f72 6f77 735f 746f 5f70 726f 6365  nb_rows_to_proce
+00002320: 7373 203d 206e 625f 726f 7773 5f74 6f5f  ss = nb_rows_to_
+00002330: 7072 6f63 6573 730a 2020 2020 2020 2020  process.        
+00002340: 7365 6c66 2e6e 625f 7061 7261 6c6c 656c  self.nb_parallel
+00002350: 203d 206e 625f 7061 7261 6c6c 656c 0a20   = nb_parallel. 
+00002360: 2020 2020 2020 2073 656c 662e 6261 7463         self.batc
+00002370: 6865 7320 3d20 6261 7463 6865 730a 2020  hes = batches.  
+00002380: 2020 2020 2020 7365 6c66 2e62 6174 6368        self.batch
+00002390: 7369 7a65 203d 2062 6174 6368 7369 7a65  size = batchsize
+000023a0: 0a0a 2020 2020 6465 6620 746f 5f6a 736f  ..    def to_jso
+000023b0: 6e28 7365 6c66 2c20 7061 7468 3a20 5061  n(self, path: Pa
+000023c0: 7468 293a 0a20 2020 2020 2020 2070 7265  th):.        pre
+000023d0: 7061 7265 6420 3d20 5f67 656e 6572 616c  pared = _general
+000023e0: 5f75 7469 6c2e 7072 6570 6172 655f 666f  _util.prepare_fo
+000023f0: 725f 7365 7269 616c 697a 6528 7661 7273  r_serialize(vars
+00002400: 2873 656c 6629 290a 2020 2020 2020 2020  (self)).        
+00002410: 7769 7468 206f 7065 6e28 7061 7468 2c20  with open(path, 
+00002420: 2277 2229 2061 7320 6669 6c65 3a0a 2020  "w") as file:.  
+00002430: 2020 2020 2020 2020 2020 6669 6c65 2e77            file.w
+00002440: 7269 7465 286a 736f 6e2e 6475 6d70 7328  rite(json.dumps(
+00002450: 7072 6570 6172 6564 2c20 696e 6465 6e74  prepared, indent
+00002460: 3d34 2c20 736f 7274 5f6b 6579 733d 5472  =4, sort_keys=Tr
+00002470: 7565 2929 0a0a 0a64 6566 205f 7072 6570  ue))...def _prep
+00002480: 6172 655f 7072 6f63 6573 7369 6e67 5f70  are_processing_p
+00002490: 6172 616d 7328 0a20 2020 2069 6e70 7574  arams(.    input
+000024a0: 5f70 6174 683a 2050 6174 682c 0a20 2020  _path: Path,.   
+000024b0: 2069 6e70 7574 5f6c 6179 6572 3a20 7374   input_layer: st
+000024c0: 722c 0a20 2020 206e 625f 7061 7261 6c6c  r,.    nb_parall
+000024d0: 656c 3a20 696e 742c 0a20 2020 2062 6174  el: int,.    bat
+000024e0: 6368 7369 7a65 3a20 696e 742c 0a20 2020  chsize: int,.   
+000024f0: 2070 6172 616c 6c65 6c69 7a61 7469 6f6e   parallelization
+00002500: 5f63 6f6e 6669 673a 204f 7074 696f 6e61  _config: Optiona
+00002510: 6c5b 5061 7261 6c6c 656c 697a 6174 696f  l[Parallelizatio
+00002520: 6e43 6f6e 6669 675d 203d 204e 6f6e 652c  nConfig] = None,
+00002530: 0a20 2020 2074 6d70 5f64 6972 3a20 4f70  .    tmp_dir: Op
+00002540: 7469 6f6e 616c 5b50 6174 685d 203d 204e  tional[Path] = N
+00002550: 6f6e 652c 0a29 202d 3e20 5072 6f63 6573  one,.) -> Proces
+00002560: 7369 6e67 5061 7261 6d73 3a0a 2020 2020  singParams:.    
+00002570: 696e 7075 745f 696e 666f 203d 2067 666f  input_info = gfo
+00002580: 2e67 6574 5f6c 6179 6572 696e 666f 2869  .get_layerinfo(i
+00002590: 6e70 7574 5f70 6174 682c 2069 6e70 7574  nput_path, input
+000025a0: 5f6c 6179 6572 290a 2020 2020 6669 645f  _layer).    fid_
+000025b0: 636f 6c75 6d6e 203d 2069 6e70 7574 5f69  column = input_i
+000025c0: 6e66 6f2e 6669 645f 636f 6c75 6d6e 2069  nfo.fid_column i
+000025d0: 6620 696e 7075 745f 696e 666f 2e66 6964  f input_info.fid
+000025e0: 5f63 6f6c 756d 6e20 213d 2022 2220 656c  _column != "" el
+000025f0: 7365 2022 6669 6422 0a20 2020 206e 625f  se "fid".    nb_
+00002600: 7061 7261 6c6c 656c 2c20 6e62 5f62 6174  parallel, nb_bat
+00002610: 6368 6573 203d 205f 6465 7465 726d 696e  ches = _determin
+00002620: 655f 6e62 5f62 6174 6368 6573 280a 2020  e_nb_batches(.  
+00002630: 2020 2020 2020 6e62 5f72 6f77 735f 746f        nb_rows_to
+00002640: 7461 6c3d 696e 7075 745f 696e 666f 2e66  tal=input_info.f
+00002650: 6561 7475 7265 636f 756e 742c 0a20 2020  eaturecount,.   
+00002660: 2020 2020 206e 625f 7061 7261 6c6c 656c       nb_parallel
+00002670: 3d6e 625f 7061 7261 6c6c 656c 2c0a 2020  =nb_parallel,.  
+00002680: 2020 2020 2020 6261 7463 6873 697a 653d        batchsize=
+00002690: 6261 7463 6873 697a 652c 0a20 2020 2020  batchsize,.     
+000026a0: 2020 2070 6172 616c 6c65 6c69 7a61 7469     parallelizati
+000026b0: 6f6e 5f63 6f6e 6669 673d 7061 7261 6c6c  on_config=parall
+000026c0: 656c 697a 6174 696f 6e5f 636f 6e66 6967  elization_config
+000026d0: 2c0a 2020 2020 290a 0a20 2020 2023 2050  ,.    )..    # P
+000026e0: 7265 7061 7265 2062 6174 6368 6573 2074  repare batches t
+000026f0: 6f20 7072 6f63 6573 730a 2020 2020 6261  o process.    ba
+00002700: 7463 6865 733a 206c 6973 745b 7374 725d  tches: list[str]
+00002710: 203d 205b 5d0a 2020 2020 6966 206e 625f   = [].    if nb_
+00002720: 6261 7463 6865 7320 3d3d 2031 3a0a 2020  batches == 1:.  
+00002730: 2020 2020 2020 2320 4966 206f 6e6c 7920        # If only 
+00002740: 6f6e 6520 6261 7463 682c 206e 6f20 6669  one batch, no fi
+00002750: 6c74 6572 696e 6720 6973 206e 6565 6465  ltering is neede
+00002760: 640a 2020 2020 2020 2020 6261 7463 6865  d.        batche
+00002770: 732e 6170 7065 6e64 2822 2229 0a20 2020  s.append("").   
+00002780: 2065 6c73 653a 0a20 2020 2020 2020 2023   else:.        #
+00002790: 2044 6574 6572 6d69 6e65 2074 6865 206d   Determine the m
+000027a0: 696e 5f66 6964 2061 6e64 206d 6178 5f66  in_fid and max_f
+000027b0: 6964 0a20 2020 2020 2020 2023 2052 656d  id.        # Rem
+000027c0: 6172 6b3a 2053 454c 4543 5420 4d49 4e28  ark: SELECT MIN(
+000027d0: 6669 6429 2c20 4d41 5828 6669 6429 2046  fid), MAX(fid) F
+000027e0: 524f 4d20 2e2e 2e20 6973 2061 206c 6f74  ROM ... is a lot
+000027f0: 2073 6c6f 7765 7220 7468 616e 2055 4e49   slower than UNI
+00002800: 4f4e 2041 4c4c 210a 2020 2020 2020 2020  ON ALL!.        
+00002810: 7371 6c5f 7374 6d74 203d 2066 2222 220a  sql_stmt = f""".
+00002820: 2020 2020 2020 2020 2020 2020 5345 4c45              SELE
+00002830: 4354 204d 494e 287b 6669 645f 636f 6c75  CT MIN({fid_colu
+00002840: 6d6e 7d29 206d 696e 6d61 785f 6669 6420  mn}) minmax_fid 
+00002850: 4652 4f4d 2022 7b69 6e70 7574 5f69 6e66  FROM "{input_inf
+00002860: 6f2e 6e61 6d65 7d22 0a20 2020 2020 2020  o.name}".       
+00002870: 2020 2020 2055 4e49 4f4e 2041 4c4c 0a20       UNION ALL. 
+00002880: 2020 2020 2020 2020 2020 2053 454c 4543             SELEC
+00002890: 5420 4d41 5828 7b66 6964 5f63 6f6c 756d  T MAX({fid_colum
+000028a0: 6e7d 2920 6d69 6e6d 6178 5f66 6964 2046  n}) minmax_fid F
+000028b0: 524f 4d20 227b 696e 7075 745f 696e 666f  ROM "{input_info
+000028c0: 2e6e 616d 657d 220a 2020 2020 2020 2020  .name}".        
+000028d0: 2222 220a 2020 2020 2020 2020 6261 7463  """.        batc
+000028e0: 685f 696e 666f 5f64 6620 3d20 6766 6f2e  h_info_df = gfo.
+000028f0: 7265 6164 5f66 696c 6528 7061 7468 3d69  read_file(path=i
+00002900: 6e70 7574 5f70 6174 682c 2073 716c 5f73  nput_path, sql_s
+00002910: 746d 743d 7371 6c5f 7374 6d74 290a 2020  tmt=sql_stmt).  
+00002920: 2020 2020 2020 6d69 6e5f 6669 6420 3d20        min_fid = 
+00002930: 7064 2e74 6f5f 6e75 6d65 7269 6328 6261  pd.to_numeric(ba
+00002940: 7463 685f 696e 666f 5f64 665b 226d 696e  tch_info_df["min
+00002950: 6d61 785f 6669 6422 5d5b 305d 292e 6974  max_fid"][0]).it
+00002960: 656d 2829 0a20 2020 2020 2020 206d 6178  em().        max
+00002970: 5f66 6964 203d 2070 642e 746f 5f6e 756d  _fid = pd.to_num
+00002980: 6572 6963 2862 6174 6368 5f69 6e66 6f5f  eric(batch_info_
+00002990: 6466 5b22 6d69 6e6d 6178 5f66 6964 225d  df["minmax_fid"]
+000029a0: 5b31 5d29 2e69 7465 6d28 290a 0a20 2020  [1]).item()..   
+000029b0: 2020 2020 2023 2044 6574 6572 6d69 6e65       # Determine
+000029c0: 2074 6865 2065 7861 6374 2062 6174 6368   the exact batch
+000029d0: 6573 2074 6f20 7573 650a 2020 2020 2020  es to use.      
+000029e0: 2020 6966 2028 286d 6178 5f66 6964 202d    if ((max_fid -
+000029f0: 206d 696e 5f66 6964 2920 2f20 696e 7075   min_fid) / inpu
+00002a00: 745f 696e 666f 2e66 6561 7475 7265 636f  t_info.featureco
+00002a10: 756e 7429 203c 2031 2e31 3a0a 2020 2020  unt) < 1.1:.    
+00002a20: 2020 2020 2020 2020 2320 4966 2074 6865          # If the
+00002a30: 2066 6964 2773 2061 7265 2071 7569 7465   fid's are quite
+00002a40: 2063 6f6e 7365 6375 7469 7665 2c20 7573   consecutive, us
+00002a50: 6520 616e 2069 6d70 6572 6665 6374 2c20  e an imperfect, 
+00002a60: 6275 740a 2020 2020 2020 2020 2020 2020  but.            
+00002a70: 2320 6661 7374 2064 6973 7472 6962 7574  # fast distribut
+00002a80: 696f 6e20 696e 2062 6174 6368 6573 0a20  ion in batches. 
+00002a90: 2020 2020 2020 2020 2020 2062 6174 6368             batch
+00002aa0: 5f69 6e66 6f5f 6c69 7374 203d 205b 5d0a  _info_list = [].
+00002ab0: 2020 2020 2020 2020 2020 2020 6e62 5f72              nb_r
+00002ac0: 6f77 735f 7065 725f 6261 7463 6820 3d20  ows_per_batch = 
+00002ad0: 726f 756e 6428 696e 7075 745f 696e 666f  round(input_info
+00002ae0: 2e66 6561 7475 7265 636f 756e 7420 2f20  .featurecount / 
+00002af0: 6e62 5f62 6174 6368 6573 290a 2020 2020  nb_batches).    
+00002b00: 2020 2020 2020 2020 6f66 6673 6574 203d          offset =
+00002b10: 2030 0a20 2020 2020 2020 2020 2020 206f   0.            o
+00002b20: 6666 7365 745f 7065 725f 6261 7463 6820  ffset_per_batch 
+00002b30: 3d20 726f 756e 6428 286d 6178 5f66 6964  = round((max_fid
+00002b40: 202d 206d 696e 5f66 6964 2920 2f20 6e62   - min_fid) / nb
+00002b50: 5f62 6174 6368 6573 290a 2020 2020 2020  _batches).      
+00002b60: 2020 2020 2020 666f 7220 6261 7463 685f        for batch_
+00002b70: 6964 2069 6e20 7261 6e67 6528 6e62 5f62  id in range(nb_b
+00002b80: 6174 6368 6573 293a 0a20 2020 2020 2020  atches):.       
+00002b90: 2020 2020 2020 2020 2073 7461 7274 5f66           start_f
+00002ba0: 6964 203d 206f 6666 7365 740a 2020 2020  id = offset.    
+00002bb0: 2020 2020 2020 2020 2020 2020 6966 2062              if b
+00002bc0: 6174 6368 5f69 6420 3c20 286e 625f 6261  atch_id < (nb_ba
+00002bd0: 7463 6865 7320 2d20 3129 3a0a 2020 2020  tches - 1):.    
+00002be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002bf0: 2320 456e 6420 6669 6420 666f 7220 7468  # End fid for th
+00002c00: 6973 2062 6174 6368 2069 7320 7468 6520  is batch is the 
+00002c10: 6e65 7874 2073 7461 7274 5f66 6964 202d  next start_fid -
+00002c20: 2031 0a20 2020 2020 2020 2020 2020 2020   1.             
+00002c30: 2020 2020 2020 2065 6e64 5f66 6964 203d         end_fid =
+00002c40: 206f 6666 7365 7420 2b20 6f66 6673 6574   offset + offset
+00002c50: 5f70 6572 5f62 6174 6368 202d 2031 0a20  _per_batch - 1. 
+00002c60: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00002c70: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00002c80: 2020 2020 2020 2020 2023 2046 6f72 2074           # For t
+00002c90: 6865 206c 6173 7420 6261 7463 682c 2074  he last batch, t
+00002ca0: 616b 6520 7468 6520 6d61 785f 6669 6420  ake the max_fid 
+00002cb0: 736f 206e 6f20 6669 6427 7320 6172 650a  so no fid's are.
+00002cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002cd0: 2020 2020 2320 276c 6f73 7427 2064 7565      # 'lost' due
+00002ce0: 2074 6f20 726f 756e 6469 6e67 2065 7272   to rounding err
+00002cf0: 6f72 730a 2020 2020 2020 2020 2020 2020  ors.            
+00002d00: 2020 2020 2020 2020 656e 645f 6669 6420          end_fid 
+00002d10: 3d20 6d61 785f 6669 640a 2020 2020 2020  = max_fid.      
+00002d20: 2020 2020 2020 2020 2020 6261 7463 685f            batch_
+00002d30: 696e 666f 5f6c 6973 742e 6170 7065 6e64  info_list.append
+00002d40: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00002d50: 2020 2020 2020 2862 6174 6368 5f69 642c        (batch_id,
+00002d60: 206e 625f 726f 7773 5f70 6572 5f62 6174   nb_rows_per_bat
+00002d70: 6368 2c20 7374 6172 745f 6669 642c 2065  ch, start_fid, e
+00002d80: 6e64 5f66 6964 290a 2020 2020 2020 2020  nd_fid).        
+00002d90: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00002da0: 2020 2020 2020 2020 2020 6f66 6673 6574            offset
+00002db0: 202b 3d20 6f66 6673 6574 5f70 6572 5f62   += offset_per_b
+00002dc0: 6174 6368 0a20 2020 2020 2020 2020 2020  atch.           
+00002dd0: 2062 6174 6368 5f69 6e66 6f5f 6466 203d   batch_info_df =
+00002de0: 2070 642e 4461 7461 4672 616d 6528 0a20   pd.DataFrame(. 
+00002df0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+00002e00: 6174 6368 5f69 6e66 6f5f 6c69 7374 2c20  atch_info_list, 
+00002e10: 636f 6c75 6d6e 733d 5b22 6261 7463 685f  columns=["batch_
+00002e20: 6964 222c 2022 6e62 5f72 6f77 7322 2c20  id", "nb_rows", 
+00002e30: 2273 7461 7274 5f66 6964 222c 2022 656e  "start_fid", "en
+00002e40: 645f 6669 6422 5d0a 2020 2020 2020 2020  d_fid"].        
+00002e50: 2020 2020 290a 2020 2020 2020 2020 656c      ).        el
+00002e60: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00002e70: 2320 5468 6520 6669 6473 2061 7265 206e  # The fids are n
+00002e80: 6f74 2063 6f6e 7365 6375 7469 7665 2c20  ot consecutive, 
+00002e90: 736f 2064 6574 6572 6d69 6e65 2074 6865  so determine the
+00002ea0: 206f 7074 696d 616c 2066 6964 0a20 2020   optimal fid.   
+00002eb0: 2020 2020 2020 2020 2023 2072 616e 6765           # range
+00002ec0: 7320 666f 7220 6561 6368 2062 6174 6368  s for each batch
+00002ed0: 2073 6f20 6561 6368 2062 6174 6368 2068   so each batch h
+00002ee0: 6173 2073 616d 6520 6e75 6d62 6572 206f  as same number o
+00002ef0: 6620 656c 656d 656e 7473 0a20 2020 2020  f elements.     
+00002f00: 2020 2020 2020 2023 2052 656d 6172 6b3a         # Remark:
+00002f10: 202d 2074 6869 7320 6d69 6768 7420 7461   - this might ta
+00002f20: 6b65 2073 6f6d 6520 7365 636f 6e64 7320  ke some seconds 
+00002f30: 666f 7220 6c61 7267 6572 2064 6174 6173  for larger datas
+00002f40: 6574 7321 0a20 2020 2020 2020 2020 2020  ets!.           
+00002f50: 2023 2020 2020 2020 2020 202d 2028 6261   #         - (ba
+00002f60: 7463 685f 6964 202d 2031 2920 4153 2069  tch_id - 1) AS i
+00002f70: 6420 746f 206d 616b 6520 7468 6520 6964  d to make the id
+00002f80: 207a 6572 6f2d 6261 7365 640a 2020 2020   zero-based.    
+00002f90: 2020 2020 2020 2020 7371 6c5f 7374 6d74          sql_stmt
+00002fa0: 203d 2066 2222 220a 2020 2020 2020 2020   = f""".        
+00002fb0: 2020 2020 2020 2020 5345 4c45 4354 2028          SELECT (
+00002fc0: 6261 7463 685f 6964 5f31 202d 2031 2920  batch_id_1 - 1) 
+00002fd0: 4153 2062 6174 6368 5f69 640a 2020 2020  AS batch_id.    
+00002fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002ff0: 2020 2c43 4f55 4e54 282a 2920 4153 206e    ,COUNT(*) AS n
+00003000: 625f 726f 7773 0a20 2020 2020 2020 2020  b_rows.         
+00003010: 2020 2020 2020 2020 2020 2020 202c 4d49               ,MI
+00003020: 4e28 7b66 6964 5f63 6f6c 756d 6e7d 2920  N({fid_column}) 
+00003030: 4153 2073 7461 7274 5f66 6964 0a20 2020  AS start_fid.   
+00003040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003050: 2020 202c 4d41 5828 7b66 6964 5f63 6f6c     ,MAX({fid_col
+00003060: 756d 6e7d 2920 4153 2065 6e64 5f66 6964  umn}) AS end_fid
+00003070: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003080: 2020 2046 524f 4d0a 2020 2020 2020 2020     FROM.        
+00003090: 2020 2020 2020 2020 2020 2020 2820 5345              ( SE
+000030a0: 4c45 4354 207b 6669 645f 636f 6c75 6d6e  LECT {fid_column
+000030b0: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+000030c0: 2020 2020 2020 2020 2020 2020 2020 2c4e                ,N
+000030d0: 5449 4c45 287b 6e62 5f62 6174 6368 6573  TILE({nb_batches
+000030e0: 7d29 204f 5645 5220 284f 5244 4552 2042  }) OVER (ORDER B
+000030f0: 5920 7b66 6964 5f63 6f6c 756d 6e7d 2920  Y {fid_column}) 
+00003100: 6261 7463 685f 6964 5f31 0a20 2020 2020  batch_id_1.     
+00003110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003120: 2020 2046 524f 4d20 227b 696e 7075 745f     FROM "{input_
+00003130: 696e 666f 2e6e 616d 657d 220a 2020 2020  info.name}".    
+00003140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003150: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00003160: 2020 2047 524f 5550 2042 5920 6261 7463     GROUP BY batc
+00003170: 685f 6964 5f31 3b0a 2020 2020 2020 2020  h_id_1;.        
+00003180: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00003190: 2020 2020 6261 7463 685f 696e 666f 5f64      batch_info_d
+000031a0: 6620 3d20 6766 6f2e 7265 6164 5f66 696c  f = gfo.read_fil
+000031b0: 6528 7061 7468 3d69 6e70 7574 5f70 6174  e(path=input_pat
+000031c0: 682c 2073 716c 5f73 746d 743d 7371 6c5f  h, sql_stmt=sql_
+000031d0: 7374 6d74 290a 0a20 2020 2020 2020 2023  stmt)..        #
+000031e0: 204e 6f77 206c 6f6f 7020 6f76 6572 2061   Now loop over a
+000031f0: 6c6c 2062 6174 6368 2072 616e 6765 7320  ll batch ranges 
+00003200: 746f 2062 7569 6c64 2075 7020 7468 6520  to build up the 
+00003210: 6e65 6365 7373 6172 7920 6669 6c74 6572  necessary filter
+00003220: 730a 2020 2020 2020 2020 666f 7220 6261  s.        for ba
+00003230: 7463 685f 696e 666f 2069 6e20 6261 7463  tch_info in batc
+00003240: 685f 696e 666f 5f64 662e 6974 6572 7475  h_info_df.itertu
+00003250: 706c 6573 2829 3a0a 2020 2020 2020 2020  ples():.        
+00003260: 2020 2020 2320 5468 6520 6261 7463 6820      # The batch 
+00003270: 6669 6c74 6572 0a20 2020 2020 2020 2020  filter.         
+00003280: 2020 2069 6620 6261 7463 685f 696e 666f     if batch_info
+00003290: 2e62 6174 6368 5f69 6420 3c20 6e62 5f62  .batch_id < nb_b
+000032a0: 6174 6368 6573 202d 2031 3a0a 2020 2020  atches - 1:.    
+000032b0: 2020 2020 2020 2020 2020 2020 6261 7463              batc
+000032c0: 6865 732e 6170 7065 6e64 280a 2020 2020  hes.append(.    
+000032d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000032e0: 6622 287b 6669 645f 636f 6c75 6d6e 7d20  f"({fid_column} 
+000032f0: 3e3d 207b 6261 7463 685f 696e 666f 2e73  >= {batch_info.s
+00003300: 7461 7274 5f66 6964 7d20 220a 2020 2020  tart_fid} ".    
+00003310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003320: 6622 414e 4420 7b66 6964 5f63 6f6c 756d  f"AND {fid_colum
+00003330: 6e7d 203c 3d20 7b62 6174 6368 5f69 6e66  n} <= {batch_inf
+00003340: 6f2e 656e 645f 6669 647d 2920 220a 2020  o.end_fid}) ".  
+00003350: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00003360: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00003370: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00003380: 2020 6261 7463 6865 732e 6170 7065 6e64    batches.append
+00003390: 2866 227b 6669 645f 636f 6c75 6d6e 7d20  (f"{fid_column} 
+000033a0: 3e3d 207b 6261 7463 685f 696e 666f 2e73  >= {batch_info.s
+000033b0: 7461 7274 5f66 6964 7d20 2229 0a0a 2020  tart_fid} ")..  
+000033c0: 2020 2320 4e6f 2075 7365 2073 7461 7274    # No use start
+000033d0: 696e 6720 6d6f 7265 2070 726f 6365 7373  ing more process
+000033e0: 6573 2074 6861 6e20 7468 6520 6e75 6d62  es than the numb
+000033f0: 6572 206f 6620 6261 7463 6865 732e 2e2e  er of batches...
+00003400: 0a20 2020 2069 6620 6c65 6e28 6261 7463  .    if len(batc
+00003410: 6865 7329 203c 206e 625f 7061 7261 6c6c  hes) < nb_parall
+00003420: 656c 3a0a 2020 2020 2020 2020 6e62 5f70  el:.        nb_p
+00003430: 6172 616c 6c65 6c20 3d20 6c65 6e28 6261  arallel = len(ba
+00003440: 7463 6865 7329 0a0a 2020 2020 7265 7475  tches)..    retu
+00003450: 726e 7661 6c75 6520 3d20 5072 6f63 6573  rnvalue = Proces
+00003460: 7369 6e67 5061 7261 6d73 280a 2020 2020  singParams(.    
+00003470: 2020 2020 6e62 5f72 6f77 735f 746f 5f70      nb_rows_to_p
+00003480: 726f 6365 7373 3d69 6e70 7574 5f69 6e66  rocess=input_inf
+00003490: 6f2e 6665 6174 7572 6563 6f75 6e74 2c0a  o.featurecount,.
+000034a0: 2020 2020 2020 2020 6e62 5f70 6172 616c          nb_paral
+000034b0: 6c65 6c3d 6e62 5f70 6172 616c 6c65 6c2c  lel=nb_parallel,
+000034c0: 0a20 2020 2020 2020 2062 6174 6368 6573  .        batches
+000034d0: 3d62 6174 6368 6573 2c0a 2020 2020 2020  =batches,.      
+000034e0: 2020 6261 7463 6873 697a 653d 696e 7428    batchsize=int(
+000034f0: 696e 7075 745f 696e 666f 2e66 6561 7475  input_info.featu
+00003500: 7265 636f 756e 7420 2f20 6c65 6e28 6261  recount / len(ba
+00003510: 7463 6865 7329 292c 0a20 2020 2029 0a0a  tches)),.    )..
+00003520: 2020 2020 6966 2074 6d70 5f64 6972 2069      if tmp_dir i
+00003530: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00003540: 2020 2020 7265 7475 726e 7661 6c75 652e      returnvalue.
+00003550: 746f 5f6a 736f 6e28 746d 705f 6469 7220  to_json(tmp_dir 
+00003560: 2f20 2270 726f 6365 7373 696e 675f 7061  / "processing_pa
+00003570: 7261 6d73 2e6a 736f 6e22 290a 2020 2020  rams.json").    
+00003580: 7265 7475 726e 2072 6574 7572 6e76 616c  return returnval
+00003590: 7565 0a0a 0a63 6c61 7373 2047 656f 4f70  ue...class GeoOp
+000035a0: 6572 6174 696f 6e28 656e 756d 2e45 6e75  eration(enum.Enu
+000035b0: 6d29 3a0a 2020 2020 5349 4d50 4c49 4659  m):.    SIMPLIFY
+000035c0: 203d 2022 7369 6d70 6c69 6679 220a 2020   = "simplify".  
+000035d0: 2020 4255 4646 4552 203d 2022 6275 6666    BUFFER = "buff
+000035e0: 6572 220a 2020 2020 434f 4e56 4558 4855  er".    CONVEXHU
+000035f0: 4c4c 203d 2022 636f 6e76 6578 6875 6c6c  LL = "convexhull
+00003600: 220a 2020 2020 4150 504c 5920 3d20 2261  ".    APPLY = "a
+00003610: 7070 6c79 220a 0a0a 6465 6620 6170 706c  pply"...def appl
+00003620: 7928 0a20 2020 2069 6e70 7574 5f70 6174  y(.    input_pat
+00003630: 683a 2050 6174 682c 0a20 2020 206f 7574  h: Path,.    out
+00003640: 7075 745f 7061 7468 3a20 5061 7468 2c0a  put_path: Path,.
+00003650: 2020 2020 6675 6e63 3a20 4361 6c6c 6162      func: Callab
+00003660: 6c65 5b5b 416e 795d 2c20 416e 795d 2c0a  le[[Any], Any],.
+00003670: 2020 2020 6f70 6572 6174 696f 6e5f 6e61      operation_na
+00003680: 6d65 3a20 4f70 7469 6f6e 616c 5b73 7472  me: Optional[str
+00003690: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 6f6e  ] = None,.    on
+000036a0: 6c79 5f67 656f 6d5f 696e 7075 743a 2062  ly_geom_input: b
+000036b0: 6f6f 6c20 3d20 5472 7565 2c0a 2020 2020  ool = True,.    
+000036c0: 696e 7075 745f 6c61 7965 723a 204f 7074  input_layer: Opt
+000036d0: 696f 6e61 6c5b 7374 725d 203d 204e 6f6e  ional[str] = Non
+000036e0: 652c 0a20 2020 206f 7574 7075 745f 6c61  e,.    output_la
+000036f0: 7965 723a 204f 7074 696f 6e61 6c5b 7374  yer: Optional[st
+00003700: 725d 203d 204e 6f6e 652c 0a20 2020 2063  r] = None,.    c
+00003710: 6f6c 756d 6e73 3a20 4f70 7469 6f6e 616c  olumns: Optional
+00003720: 5b6c 6973 745b 7374 725d 5d20 3d20 4e6f  [list[str]] = No
+00003730: 6e65 2c0a 2020 2020 6578 706c 6f64 6563  ne,.    explodec
+00003740: 6f6c 6c65 6374 696f 6e73 3a20 626f 6f6c  ollections: bool
+00003750: 203d 2046 616c 7365 2c0a 2020 2020 666f   = False,.    fo
+00003760: 7263 655f 6f75 7470 7574 5f67 656f 6d65  rce_output_geome
+00003770: 7472 7974 7970 653a 2055 6e69 6f6e 5b47  trytype: Union[G
+00003780: 656f 6d65 7472 7954 7970 652c 2073 7472  eometryType, str
+00003790: 2c20 4e6f 6e65 5d20 3d20 4e6f 6e65 2c0a  , None] = None,.
+000037a0: 2020 2020 6772 6964 7369 7a65 3a20 666c      gridsize: fl
+000037b0: 6f61 7420 3d20 302e 302c 0a20 2020 206b  oat = 0.0,.    k
+000037c0: 6565 705f 656d 7074 795f 6765 6f6d 733a  eep_empty_geoms:
+000037d0: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
+000037e0: 2020 2077 6865 7265 5f70 6f73 743a 204f     where_post: O
+000037f0: 7074 696f 6e61 6c5b 7374 725d 203d 204e  ptional[str] = N
+00003800: 6f6e 652c 0a20 2020 206e 625f 7061 7261  one,.    nb_para
+00003810: 6c6c 656c 3a20 696e 7420 3d20 2d31 2c0a  llel: int = -1,.
+00003820: 2020 2020 6261 7463 6873 697a 653a 2069      batchsize: i
+00003830: 6e74 203d 202d 312c 0a20 2020 2066 6f72  nt = -1,.    for
+00003840: 6365 3a20 626f 6f6c 203d 2046 616c 7365  ce: bool = False
+00003850: 2c0a 2020 2020 7061 7261 6c6c 656c 697a  ,.    paralleliz
+00003860: 6174 696f 6e5f 636f 6e66 6967 3a20 4f70  ation_config: Op
+00003870: 7469 6f6e 616c 5b50 6172 616c 6c65 6c69  tional[Paralleli
+00003880: 7a61 7469 6f6e 436f 6e66 6967 5d20 3d20  zationConfig] = 
+00003890: 4e6f 6e65 2c0a 293a 0a20 2020 2023 2049  None,.):.    # I
+000038a0: 6e69 740a 2020 2020 6f70 6572 6174 696f  nit.    operatio
+000038b0: 6e5f 7061 7261 6d73 203d 207b 0a20 2020  n_params = {.   
+000038c0: 2020 2020 2022 6f6e 6c79 5f67 656f 6d5f       "only_geom_
+000038d0: 696e 7075 7422 3a20 6f6e 6c79 5f67 656f  input": only_geo
+000038e0: 6d5f 696e 7075 742c 0a20 2020 2020 2020  m_input,.       
+000038f0: 2022 7069 636b 6c65 645f 6675 6e63 223a   "pickled_func":
+00003900: 2063 6c6f 7564 7069 636b 6c65 2e64 756d   cloudpickle.dum
+00003910: 7073 2866 756e 6329 2c0a 2020 2020 7d0a  ps(func),.    }.
+00003920: 2020 2020 6966 206f 7065 7261 7469 6f6e      if operation
+00003930: 5f6e 616d 6520 6973 206e 6f74 204e 6f6e  _name is not Non
+00003940: 653a 0a20 2020 2020 2020 206f 7065 7261  e:.        opera
+00003950: 7469 6f6e 5f70 6172 616d 735b 226f 7065  tion_params["ope
+00003960: 7261 7469 6f6e 5f6e 616d 6522 5d20 3d20  ration_name"] = 
+00003970: 6f70 6572 6174 696f 6e5f 6e61 6d65 0a0a  operation_name..
+00003980: 2020 2020 2320 476f 210a 2020 2020 7265      # Go!.    re
+00003990: 7475 726e 205f 6170 706c 795f 6765 6f6f  turn _apply_geoo
+000039a0: 7065 7261 7469 6f6e 5f74 6f5f 6c61 7965  peration_to_laye
+000039b0: 7228 0a20 2020 2020 2020 2069 6e70 7574  r(.        input
+000039c0: 5f70 6174 683d 696e 7075 745f 7061 7468  _path=input_path
+000039d0: 2c0a 2020 2020 2020 2020 6f75 7470 7574  ,.        output
+000039e0: 5f70 6174 683d 6f75 7470 7574 5f70 6174  _path=output_pat
+000039f0: 682c 0a20 2020 2020 2020 206f 7065 7261  h,.        opera
+00003a00: 7469 6f6e 3d47 656f 4f70 6572 6174 696f  tion=GeoOperatio
+00003a10: 6e2e 4150 504c 592c 0a20 2020 2020 2020  n.APPLY,.       
+00003a20: 206f 7065 7261 7469 6f6e 5f70 6172 616d   operation_param
+00003a30: 733d 6f70 6572 6174 696f 6e5f 7061 7261  s=operation_para
+00003a40: 6d73 2c0a 2020 2020 2020 2020 696e 7075  ms,.        inpu
+00003a50: 745f 6c61 7965 723d 696e 7075 745f 6c61  t_layer=input_la
+00003a60: 7965 722c 0a20 2020 2020 2020 206f 7574  yer,.        out
+00003a70: 7075 745f 6c61 7965 723d 6f75 7470 7574  put_layer=output
+00003a80: 5f6c 6179 6572 2c0a 2020 2020 2020 2020  _layer,.        
+00003a90: 636f 6c75 6d6e 733d 636f 6c75 6d6e 732c  columns=columns,
+00003aa0: 0a20 2020 2020 2020 2065 7870 6c6f 6465  .        explode
+00003ab0: 636f 6c6c 6563 7469 6f6e 733d 6578 706c  collections=expl
+00003ac0: 6f64 6563 6f6c 6c65 6374 696f 6e73 2c0a  odecollections,.
+00003ad0: 2020 2020 2020 2020 666f 7263 655f 6f75          force_ou
+00003ae0: 7470 7574 5f67 656f 6d65 7472 7974 7970  tput_geometrytyp
+00003af0: 653d 666f 7263 655f 6f75 7470 7574 5f67  e=force_output_g
+00003b00: 656f 6d65 7472 7974 7970 652c 0a20 2020  eometrytype,.   
+00003b10: 2020 2020 2067 7269 6473 697a 653d 6772       gridsize=gr
+00003b20: 6964 7369 7a65 2c0a 2020 2020 2020 2020  idsize,.        
+00003b30: 6b65 6570 5f65 6d70 7479 5f67 656f 6d73  keep_empty_geoms
+00003b40: 3d6b 6565 705f 656d 7074 795f 6765 6f6d  =keep_empty_geom
+00003b50: 732c 0a20 2020 2020 2020 2077 6865 7265  s,.        where
+00003b60: 5f70 6f73 743d 7768 6572 655f 706f 7374  _post=where_post
+00003b70: 2c0a 2020 2020 2020 2020 6e62 5f70 6172  ,.        nb_par
+00003b80: 616c 6c65 6c3d 6e62 5f70 6172 616c 6c65  allel=nb_paralle
+00003b90: 6c2c 0a20 2020 2020 2020 2062 6174 6368  l,.        batch
+00003ba0: 7369 7a65 3d62 6174 6368 7369 7a65 2c0a  size=batchsize,.
+00003bb0: 2020 2020 2020 2020 666f 7263 653d 666f          force=fo
+00003bc0: 7263 652c 0a20 2020 2020 2020 2070 6172  rce,.        par
+00003bd0: 616c 6c65 6c69 7a61 7469 6f6e 5f63 6f6e  allelization_con
+00003be0: 6669 673d 7061 7261 6c6c 656c 697a 6174  fig=parallelizat
+00003bf0: 696f 6e5f 636f 6e66 6967 2c0a 2020 2020  ion_config,.    
+00003c00: 290a 0a0a 6465 6620 6275 6666 6572 280a  )...def buffer(.
+00003c10: 2020 2020 696e 7075 745f 7061 7468 3a20      input_path: 
+00003c20: 5061 7468 2c0a 2020 2020 6f75 7470 7574  Path,.    output
+00003c30: 5f70 6174 683a 2050 6174 682c 0a20 2020  _path: Path,.   
+00003c40: 2064 6973 7461 6e63 653a 2066 6c6f 6174   distance: float
+00003c50: 2c0a 2020 2020 7175 6164 7261 6e74 7365  ,.    quadrantse
+00003c60: 676d 656e 7473 3a20 696e 7420 3d20 352c  gments: int = 5,
+00003c70: 0a20 2020 2065 6e64 6361 705f 7374 796c  .    endcap_styl
+00003c80: 653a 2042 7566 6665 7245 6e64 4361 7053  e: BufferEndCapS
+00003c90: 7479 6c65 203d 2042 7566 6665 7245 6e64  tyle = BufferEnd
+00003ca0: 4361 7053 7479 6c65 2e52 4f55 4e44 2c0a  CapStyle.ROUND,.
+00003cb0: 2020 2020 6a6f 696e 5f73 7479 6c65 3a20      join_style: 
+00003cc0: 4275 6666 6572 4a6f 696e 5374 796c 6520  BufferJoinStyle 
+00003cd0: 3d20 4275 6666 6572 4a6f 696e 5374 796c  = BufferJoinStyl
+00003ce0: 652e 524f 554e 442c 0a20 2020 206d 6974  e.ROUND,.    mit
+00003cf0: 7265 5f6c 696d 6974 3a20 666c 6f61 7420  re_limit: float 
+00003d00: 3d20 352e 302c 0a20 2020 2073 696e 676c  = 5.0,.    singl
+00003d10: 655f 7369 6465 643a 2062 6f6f 6c20 3d20  e_sided: bool = 
+00003d20: 4661 6c73 652c 0a20 2020 2069 6e70 7574  False,.    input
+00003d30: 5f6c 6179 6572 3a20 4f70 7469 6f6e 616c  _layer: Optional
+00003d40: 5b73 7472 5d20 3d20 4e6f 6e65 2c0a 2020  [str] = None,.  
+00003d50: 2020 6f75 7470 7574 5f6c 6179 6572 3a20    output_layer: 
+00003d60: 4f70 7469 6f6e 616c 5b73 7472 5d20 3d20  Optional[str] = 
+00003d70: 4e6f 6e65 2c0a 2020 2020 636f 6c75 6d6e  None,.    column
+00003d80: 733a 204f 7074 696f 6e61 6c5b 6c69 7374  s: Optional[list
+00003d90: 5b73 7472 5d5d 203d 204e 6f6e 652c 0a20  [str]] = None,. 
+00003da0: 2020 2065 7870 6c6f 6465 636f 6c6c 6563     explodecollec
+00003db0: 7469 6f6e 733a 2062 6f6f 6c20 3d20 4661  tions: bool = Fa
+00003dc0: 6c73 652c 0a20 2020 2067 7269 6473 697a  lse,.    gridsiz
+00003dd0: 653a 2066 6c6f 6174 203d 2030 2e30 2c0a  e: float = 0.0,.
+00003de0: 2020 2020 6b65 6570 5f65 6d70 7479 5f67      keep_empty_g
+00003df0: 656f 6d73 3a20 626f 6f6c 203d 2046 616c  eoms: bool = Fal
+00003e00: 7365 2c0a 2020 2020 7768 6572 655f 706f  se,.    where_po
+00003e10: 7374 3a20 4f70 7469 6f6e 616c 5b73 7472  st: Optional[str
+00003e20: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 6e62  ] = None,.    nb
+00003e30: 5f70 6172 616c 6c65 6c3a 2069 6e74 203d  _parallel: int =
+00003e40: 202d 312c 0a20 2020 2062 6174 6368 7369   -1,.    batchsi
+00003e50: 7a65 3a20 696e 7420 3d20 2d31 2c0a 2020  ze: int = -1,.  
+00003e60: 2020 666f 7263 653a 2062 6f6f 6c20 3d20    force: bool = 
+00003e70: 4661 6c73 652c 0a20 2020 206f 7065 7261  False,.    opera
+00003e80: 7469 6f6e 5f70 7265 6669 783a 2073 7472  tion_prefix: str
+00003e90: 203d 2022 222c 0a29 3a0a 2020 2020 2320   = "",.):.    # 
+00003ea0: 496e 6974 0a20 2020 206f 7065 7261 7469  Init.    operati
+00003eb0: 6f6e 5f70 6172 616d 7320 3d20 7b0a 2020  on_params = {.  
+00003ec0: 2020 2020 2020 226f 7065 7261 7469 6f6e        "operation
+00003ed0: 5f6e 616d 6522 3a20 6622 7b6f 7065 7261  _name": f"{opera
+00003ee0: 7469 6f6e 5f70 7265 6669 787d 6275 6666  tion_prefix}buff
+00003ef0: 6572 222c 0a20 2020 2020 2020 2022 6469  er",.        "di
+00003f00: 7374 616e 6365 223a 2064 6973 7461 6e63  stance": distanc
+00003f10: 652c 0a20 2020 2020 2020 2022 7175 6164  e,.        "quad
+00003f20: 7261 6e74 7365 676d 656e 7473 223a 2071  rantsegments": q
+00003f30: 7561 6472 616e 7473 6567 6d65 6e74 732c  uadrantsegments,
+00003f40: 0a20 2020 2020 2020 2022 656e 6463 6170  .        "endcap
+00003f50: 5f73 7479 6c65 223a 2065 6e64 6361 705f  _style": endcap_
+00003f60: 7374 796c 652c 0a20 2020 2020 2020 2022  style,.        "
+00003f70: 6a6f 696e 5f73 7479 6c65 223a 206a 6f69  join_style": joi
+00003f80: 6e5f 7374 796c 652c 0a20 2020 2020 2020  n_style,.       
+00003f90: 2022 6d69 7472 655f 6c69 6d69 7422 3a20   "mitre_limit": 
+00003fa0: 6d69 7472 655f 6c69 6d69 742c 0a20 2020  mitre_limit,.   
+00003fb0: 2020 2020 2022 7369 6e67 6c65 5f73 6964       "single_sid
+00003fc0: 6564 223a 2073 696e 676c 655f 7369 6465  ed": single_side
+00003fd0: 642c 0a20 2020 207d 0a0a 2020 2020 2320  d,.    }..    # 
+00003fe0: 4275 6666 6572 206f 7065 7261 7469 6f6e  Buffer operation
+00003ff0: 2061 6c77 6179 7320 7265 7375 6c74 7320   always results 
+00004000: 696e 2070 6f6c 7967 6f6e 732e 2e2e 0a20  in polygons.... 
+00004010: 2020 2069 6620 6578 706c 6f64 6563 6f6c     if explodecol
+00004020: 6c65 6374 696f 6e73 3a0a 2020 2020 2020  lections:.      
+00004030: 2020 666f 7263 655f 6f75 7470 7574 5f67    force_output_g
+00004040: 656f 6d65 7472 7974 7970 6520 3d20 4765  eometrytype = Ge
+00004050: 6f6d 6574 7279 5479 7065 2e50 4f4c 5947  ometryType.POLYG
+00004060: 4f4e 2e6e 616d 650a 2020 2020 656c 7365  ON.name.    else
+00004070: 3a0a 2020 2020 2020 2020 666f 7263 655f  :.        force_
+00004080: 6f75 7470 7574 5f67 656f 6d65 7472 7974  output_geometryt
+00004090: 7970 6520 3d20 4765 6f6d 6574 7279 5479  ype = GeometryTy
+000040a0: 7065 2e4d 554c 5449 504f 4c59 474f 4e2e  pe.MULTIPOLYGON.
+000040b0: 6e61 6d65 0a0a 2020 2020 2320 476f 210a  name..    # Go!.
+000040c0: 2020 2020 7265 7475 726e 205f 6170 706c      return _appl
+000040d0: 795f 6765 6f6f 7065 7261 7469 6f6e 5f74  y_geooperation_t
+000040e0: 6f5f 6c61 7965 7228 0a20 2020 2020 2020  o_layer(.       
+000040f0: 2069 6e70 7574 5f70 6174 683d 696e 7075   input_path=inpu
+00004100: 745f 7061 7468 2c0a 2020 2020 2020 2020  t_path,.        
+00004110: 6f75 7470 7574 5f70 6174 683d 6f75 7470  output_path=outp
+00004120: 7574 5f70 6174 682c 0a20 2020 2020 2020  ut_path,.       
+00004130: 206f 7065 7261 7469 6f6e 3d47 656f 4f70   operation=GeoOp
+00004140: 6572 6174 696f 6e2e 4255 4646 4552 2c0a  eration.BUFFER,.
+00004150: 2020 2020 2020 2020 6f70 6572 6174 696f          operatio
+00004160: 6e5f 7061 7261 6d73 3d6f 7065 7261 7469  n_params=operati
+00004170: 6f6e 5f70 6172 616d 732c 0a20 2020 2020  on_params,.     
+00004180: 2020 2069 6e70 7574 5f6c 6179 6572 3d69     input_layer=i
+00004190: 6e70 7574 5f6c 6179 6572 2c0a 2020 2020  nput_layer,.    
+000041a0: 2020 2020 6f75 7470 7574 5f6c 6179 6572      output_layer
+000041b0: 3d6f 7574 7075 745f 6c61 7965 722c 0a20  =output_layer,. 
+000041c0: 2020 2020 2020 2063 6f6c 756d 6e73 3d63         columns=c
+000041d0: 6f6c 756d 6e73 2c0a 2020 2020 2020 2020  olumns,.        
+000041e0: 6578 706c 6f64 6563 6f6c 6c65 6374 696f  explodecollectio
+000041f0: 6e73 3d65 7870 6c6f 6465 636f 6c6c 6563  ns=explodecollec
+00004200: 7469 6f6e 732c 0a20 2020 2020 2020 2066  tions,.        f
+00004210: 6f72 6365 5f6f 7574 7075 745f 6765 6f6d  orce_output_geom
+00004220: 6574 7279 7479 7065 3d66 6f72 6365 5f6f  etrytype=force_o
+00004230: 7574 7075 745f 6765 6f6d 6574 7279 7479  utput_geometryty
+00004240: 7065 2c0a 2020 2020 2020 2020 6772 6964  pe,.        grid
+00004250: 7369 7a65 3d67 7269 6473 697a 652c 0a20  size=gridsize,. 
+00004260: 2020 2020 2020 206b 6565 705f 656d 7074         keep_empt
+00004270: 795f 6765 6f6d 733d 6b65 6570 5f65 6d70  y_geoms=keep_emp
+00004280: 7479 5f67 656f 6d73 2c0a 2020 2020 2020  ty_geoms,.      
+00004290: 2020 7768 6572 655f 706f 7374 3d77 6865    where_post=whe
+000042a0: 7265 5f70 6f73 742c 0a20 2020 2020 2020  re_post,.       
+000042b0: 206e 625f 7061 7261 6c6c 656c 3d6e 625f   nb_parallel=nb_
+000042c0: 7061 7261 6c6c 656c 2c0a 2020 2020 2020  parallel,.      
+000042d0: 2020 6261 7463 6873 697a 653d 6261 7463    batchsize=batc
+000042e0: 6873 697a 652c 0a20 2020 2020 2020 2066  hsize,.        f
+000042f0: 6f72 6365 3d66 6f72 6365 2c0a 2020 2020  orce=force,.    
+00004300: 290a 0a0a 6465 6620 636f 6e76 6578 6875  )...def convexhu
+00004310: 6c6c 280a 2020 2020 696e 7075 745f 7061  ll(.    input_pa
+00004320: 7468 3a20 5061 7468 2c0a 2020 2020 6f75  th: Path,.    ou
+00004330: 7470 7574 5f70 6174 683a 2050 6174 682c  tput_path: Path,
+00004340: 0a20 2020 2069 6e70 7574 5f6c 6179 6572  .    input_layer
+00004350: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
+00004360: 3d20 4e6f 6e65 2c0a 2020 2020 6f75 7470  = None,.    outp
+00004370: 7574 5f6c 6179 6572 3a20 4f70 7469 6f6e  ut_layer: Option
+00004380: 616c 5b73 7472 5d20 3d20 4e6f 6e65 2c0a  al[str] = None,.
+00004390: 2020 2020 636f 6c75 6d6e 733a 204f 7074      columns: Opt
+000043a0: 696f 6e61 6c5b 6c69 7374 5b73 7472 5d5d  ional[list[str]]
+000043b0: 203d 204e 6f6e 652c 0a20 2020 2065 7870   = None,.    exp
+000043c0: 6c6f 6465 636f 6c6c 6563 7469 6f6e 733a  lodecollections:
+000043d0: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
+000043e0: 2020 2067 7269 6473 697a 653a 2066 6c6f     gridsize: flo
+000043f0: 6174 203d 2030 2e30 2c0a 2020 2020 6b65  at = 0.0,.    ke
+00004400: 6570 5f65 6d70 7479 5f67 656f 6d73 3a20  ep_empty_geoms: 
+00004410: 626f 6f6c 203d 2046 616c 7365 2c0a 2020  bool = False,.  
+00004420: 2020 7768 6572 655f 706f 7374 3a20 4f70    where_post: Op
+00004430: 7469 6f6e 616c 5b73 7472 5d20 3d20 4e6f  tional[str] = No
+00004440: 6e65 2c0a 2020 2020 6e62 5f70 6172 616c  ne,.    nb_paral
+00004450: 6c65 6c3a 2069 6e74 203d 202d 312c 0a20  lel: int = -1,. 
+00004460: 2020 2062 6174 6368 7369 7a65 3a20 696e     batchsize: in
+00004470: 7420 3d20 2d31 2c0a 2020 2020 666f 7263  t = -1,.    forc
+00004480: 653a 2062 6f6f 6c20 3d20 4661 6c73 652c  e: bool = False,
+00004490: 0a29 3a0a 2020 2020 2320 496e 6974 0a20  .):.    # Init. 
+000044a0: 2020 206f 7065 7261 7469 6f6e 5f70 6172     operation_par
+000044b0: 616d 733a 2064 6963 745b 7374 722c 2041  ams: dict[str, A
+000044c0: 6e79 5d20 3d20 7b7d 0a0a 2020 2020 2320  ny] = {}..    # 
+000044d0: 476f 210a 2020 2020 7265 7475 726e 205f  Go!.    return _
+000044e0: 6170 706c 795f 6765 6f6f 7065 7261 7469  apply_geooperati
+000044f0: 6f6e 5f74 6f5f 6c61 7965 7228 0a20 2020  on_to_layer(.   
+00004500: 2020 2020 2069 6e70 7574 5f70 6174 683d       input_path=
+00004510: 696e 7075 745f 7061 7468 2c0a 2020 2020  input_path,.    
+00004520: 2020 2020 6f75 7470 7574 5f70 6174 683d      output_path=
+00004530: 6f75 7470 7574 5f70 6174 682c 0a20 2020  output_path,.   
+00004540: 2020 2020 206f 7065 7261 7469 6f6e 3d47       operation=G
+00004550: 656f 4f70 6572 6174 696f 6e2e 434f 4e56  eoOperation.CONV
+00004560: 4558 4855 4c4c 2c0a 2020 2020 2020 2020  EXHULL,.        
+00004570: 6f70 6572 6174 696f 6e5f 7061 7261 6d73  operation_params
+00004580: 3d6f 7065 7261 7469 6f6e 5f70 6172 616d  =operation_param
+00004590: 732c 0a20 2020 2020 2020 2069 6e70 7574  s,.        input
+000045a0: 5f6c 6179 6572 3d69 6e70 7574 5f6c 6179  _layer=input_lay
+000045b0: 6572 2c0a 2020 2020 2020 2020 6f75 7470  er,.        outp
+000045c0: 7574 5f6c 6179 6572 3d6f 7574 7075 745f  ut_layer=output_
+000045d0: 6c61 7965 722c 0a20 2020 2020 2020 2063  layer,.        c
+000045e0: 6f6c 756d 6e73 3d63 6f6c 756d 6e73 2c0a  olumns=columns,.
+000045f0: 2020 2020 2020 2020 6578 706c 6f64 6563          explodec
+00004600: 6f6c 6c65 6374 696f 6e73 3d65 7870 6c6f  ollections=explo
+00004610: 6465 636f 6c6c 6563 7469 6f6e 732c 0a20  decollections,. 
+00004620: 2020 2020 2020 2066 6f72 6365 5f6f 7574         force_out
+00004630: 7075 745f 6765 6f6d 6574 7279 7479 7065  put_geometrytype
+00004640: 3d4e 6f6e 652c 0a20 2020 2020 2020 2067  =None,.        g
+00004650: 7269 6473 697a 653d 6772 6964 7369 7a65  ridsize=gridsize
+00004660: 2c0a 2020 2020 2020 2020 6b65 6570 5f65  ,.        keep_e
+00004670: 6d70 7479 5f67 656f 6d73 3d6b 6565 705f  mpty_geoms=keep_
+00004680: 656d 7074 795f 6765 6f6d 732c 0a20 2020  empty_geoms,.   
+00004690: 2020 2020 2077 6865 7265 5f70 6f73 743d       where_post=
+000046a0: 7768 6572 655f 706f 7374 2c0a 2020 2020  where_post,.    
+000046b0: 2020 2020 6e62 5f70 6172 616c 6c65 6c3d      nb_parallel=
+000046c0: 6e62 5f70 6172 616c 6c65 6c2c 0a20 2020  nb_parallel,.   
+000046d0: 2020 2020 2062 6174 6368 7369 7a65 3d62       batchsize=b
+000046e0: 6174 6368 7369 7a65 2c0a 2020 2020 2020  atchsize,.      
+000046f0: 2020 666f 7263 653d 666f 7263 652c 0a20    force=force,. 
+00004700: 2020 2029 0a0a 0a64 6566 206d 616b 6576     )...def makev
+00004710: 616c 6964 280a 2020 2020 696e 7075 745f  alid(.    input_
+00004720: 7061 7468 3a20 5061 7468 2c0a 2020 2020  path: Path,.    
+00004730: 6f75 7470 7574 5f70 6174 683a 2050 6174  output_path: Pat
+00004740: 682c 0a20 2020 2069 6e70 7574 5f6c 6179  h,.    input_lay
+00004750: 6572 3a20 4f70 7469 6f6e 616c 5b73 7472  er: Optional[str
+00004760: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 6f75  ] = None,.    ou
+00004770: 7470 7574 5f6c 6179 6572 3a20 4f70 7469  tput_layer: Opti
+00004780: 6f6e 616c 5b73 7472 5d20 3d20 4e6f 6e65  onal[str] = None
+00004790: 2c0a 2020 2020 636f 6c75 6d6e 733a 204f  ,.    columns: O
+000047a0: 7074 696f 6e61 6c5b 6c69 7374 5b73 7472  ptional[list[str
+000047b0: 5d5d 203d 204e 6f6e 652c 0a20 2020 2065  ]] = None,.    e
+000047c0: 7870 6c6f 6465 636f 6c6c 6563 7469 6f6e  xplodecollection
+000047d0: 733a 2062 6f6f 6c20 3d20 4661 6c73 652c  s: bool = False,
+000047e0: 0a20 2020 2066 6f72 6365 5f6f 7574 7075  .    force_outpu
+000047f0: 745f 6765 6f6d 6574 7279 7479 7065 3a20  t_geometrytype: 
+00004800: 556e 696f 6e5b 7374 722c 204e 6f6e 652c  Union[str, None,
+00004810: 2047 656f 6d65 7472 7954 7970 655d 203d   GeometryType] =
+00004820: 204e 6f6e 652c 0a20 2020 2067 7269 6473   None,.    grids
+00004830: 697a 653a 2066 6c6f 6174 203d 2030 2e30  ize: float = 0.0
+00004840: 2c0a 2020 2020 6b65 6570 5f65 6d70 7479  ,.    keep_empty
+00004850: 5f67 656f 6d73 3a20 626f 6f6c 203d 2046  _geoms: bool = F
+00004860: 616c 7365 2c0a 2020 2020 7768 6572 655f  alse,.    where_
+00004870: 706f 7374 3a20 4f70 7469 6f6e 616c 5b73  post: Optional[s
+00004880: 7472 5d20 3d20 4e6f 6e65 2c0a 2020 2020  tr] = None,.    
+00004890: 7661 6c69 6461 7465 5f61 7474 7269 6275  validate_attribu
+000048a0: 7465 5f64 6174 613a 2062 6f6f 6c20 3d20  te_data: bool = 
+000048b0: 4661 6c73 652c 0a20 2020 206e 625f 7061  False,.    nb_pa
+000048c0: 7261 6c6c 656c 3a20 696e 7420 3d20 2d31  rallel: int = -1
+000048d0: 2c0a 2020 2020 6261 7463 6873 697a 653a  ,.    batchsize:
+000048e0: 2069 6e74 203d 202d 312c 0a20 2020 2066   int = -1,.    f
+000048f0: 6f72 6365 3a20 626f 6f6c 203d 2046 616c  orce: bool = Fal
+00004900: 7365 2c0a 293a 0a20 2020 2023 2044 6574  se,.):.    # Det
+00004910: 6572 6d69 6e65 2069 6620 636f 6c6c 6170  ermine if collap
+00004920: 7365 6420 7061 7274 7320 6e65 6564 2074  sed parts need t
+00004930: 6f20 6265 206b 6570 7420 6166 7465 7220  o be kept after 
+00004940: 6d61 6b65 7661 6c69 6420 6f72 206e 6f74  makevalid or not
+00004950: 0a20 2020 206b 6565 705f 636f 6c6c 6170  .    keep_collap
+00004960: 7365 6420 3d20 5472 7565 0a20 2020 2069  sed = True.    i
+00004970: 6620 666f 7263 655f 6f75 7470 7574 5f67  f force_output_g
+00004980: 656f 6d65 7472 7974 7970 6520 6973 204e  eometrytype is N
+00004990: 6f6e 653a 0a20 2020 2020 2020 206b 6565  one:.        kee
+000049a0: 705f 636f 6c6c 6170 7365 6420 3d20 4661  p_collapsed = Fa
+000049b0: 6c73 650a 2020 2020 656c 7365 3a0a 2020  lse.    else:.  
+000049c0: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
+000049d0: 6e63 6528 666f 7263 655f 6f75 7470 7574  nce(force_output
+000049e0: 5f67 656f 6d65 7472 7974 7970 652c 2047  _geometrytype, G
+000049f0: 656f 6d65 7472 7954 7970 6529 3a0a 2020  eometryType):.  
+00004a00: 2020 2020 2020 2020 2020 666f 7263 655f            force_
+00004a10: 6f75 7470 7574 5f67 656f 6d65 7472 7974  output_geometryt
+00004a20: 7970 6520 3d20 666f 7263 655f 6f75 7470  ype = force_outp
+00004a30: 7574 5f67 656f 6d65 7472 7974 7970 652e  ut_geometrytype.
+00004a40: 6e61 6d65 0a20 2020 2020 2020 2069 6e66  name.        inf
+00004a50: 6f20 3d20 6669 6c65 6f70 732e 6765 745f  o = fileops.get_
+00004a60: 6c61 7965 7269 6e66 6f28 696e 7075 745f  layerinfo(input_
+00004a70: 7061 7468 290a 2020 2020 2020 2020 6966  path).        if
+00004a80: 2066 6f72 6365 5f6f 7574 7075 745f 6765   force_output_ge
+00004a90: 6f6d 6574 7279 7479 7065 2e73 7461 7274  ometrytype.start
+00004aa0: 7377 6974 6828 0a20 2020 2020 2020 2020  swith(.         
+00004ab0: 2020 2069 6e66 6f2e 6765 6f6d 6574 7279     info.geometry
+00004ac0: 7479 7065 6e61 6d65 0a20 2020 2020 2020  typename.       
+00004ad0: 2029 206f 7220 696e 666f 2e67 656f 6d65   ) or info.geome
+00004ae0: 7472 7974 7970 656e 616d 652e 7374 6172  trytypename.star
+00004af0: 7473 7769 7468 2866 6f72 6365 5f6f 7574  tswith(force_out
+00004b00: 7075 745f 6765 6f6d 6574 7279 7479 7065  put_geometrytype
+00004b10: 293a 0a20 2020 2020 2020 2020 2020 206b  ):.            k
+00004b20: 6565 705f 636f 6c6c 6170 7365 6420 3d20  eep_collapsed = 
+00004b30: 4661 6c73 650a 0a20 2020 2061 7070 6c79  False..    apply
+00004b40: 280a 2020 2020 2020 2020 696e 7075 745f  (.        input_
+00004b50: 7061 7468 3d50 6174 6828 696e 7075 745f  path=Path(input_
+00004b60: 7061 7468 292c 0a20 2020 2020 2020 206f  path),.        o
+00004b70: 7574 7075 745f 7061 7468 3d50 6174 6828  utput_path=Path(
+00004b80: 6f75 7470 7574 5f70 6174 6829 2c0a 2020  output_path),.  
+00004b90: 2020 2020 2020 6675 6e63 3d6c 616d 6264        func=lambd
+00004ba0: 6120 6765 6f6d 3a20 7079 6765 6f6f 7073  a geom: pygeoops
+00004bb0: 2e6d 616b 655f 7661 6c69 6428 0a20 2020  .make_valid(.   
+00004bc0: 2020 2020 2020 2020 2067 656f 6d2c 206b           geom, k
+00004bd0: 6565 705f 636f 6c6c 6170 7365 643d 6b65  eep_collapsed=ke
+00004be0: 6570 5f63 6f6c 6c61 7073 6564 2c20 6f6e  ep_collapsed, on
+00004bf0: 6c79 5f69 665f 696e 7661 6c69 643d 5472  ly_if_invalid=Tr
+00004c00: 7565 0a20 2020 2020 2020 2029 2c0a 2020  ue.        ),.  
+00004c10: 2020 2020 2020 6f70 6572 6174 696f 6e5f        operation_
+00004c20: 6e61 6d65 3d22 6d61 6b65 7661 6c69 6422  name="makevalid"
+00004c30: 2c0a 2020 2020 2020 2020 696e 7075 745f  ,.        input_
+00004c40: 6c61 7965 723d 696e 7075 745f 6c61 7965  layer=input_laye
+00004c50: 722c 0a20 2020 2020 2020 206f 7574 7075  r,.        outpu
+00004c60: 745f 6c61 7965 723d 6f75 7470 7574 5f6c  t_layer=output_l
+00004c70: 6179 6572 2c0a 2020 2020 2020 2020 636f  ayer,.        co
+00004c80: 6c75 6d6e 733d 636f 6c75 6d6e 732c 0a20  lumns=columns,. 
+00004c90: 2020 2020 2020 2065 7870 6c6f 6465 636f         explodeco
+00004ca0: 6c6c 6563 7469 6f6e 733d 6578 706c 6f64  llections=explod
+00004cb0: 6563 6f6c 6c65 6374 696f 6e73 2c0a 2020  ecollections,.  
+00004cc0: 2020 2020 2020 666f 7263 655f 6f75 7470        force_outp
+00004cd0: 7574 5f67 656f 6d65 7472 7974 7970 653d  ut_geometrytype=
+00004ce0: 666f 7263 655f 6f75 7470 7574 5f67 656f  force_output_geo
+00004cf0: 6d65 7472 7974 7970 652c 0a20 2020 2020  metrytype,.     
+00004d00: 2020 2067 7269 6473 697a 653d 6772 6964     gridsize=grid
+00004d10: 7369 7a65 2c0a 2020 2020 2020 2020 6b65  size,.        ke
+00004d20: 6570 5f65 6d70 7479 5f67 656f 6d73 3d6b  ep_empty_geoms=k
+00004d30: 6565 705f 656d 7074 795f 6765 6f6d 732c  eep_empty_geoms,
+00004d40: 0a20 2020 2020 2020 2077 6865 7265 5f70  .        where_p
+00004d50: 6f73 743d 7768 6572 655f 706f 7374 2c0a  ost=where_post,.
+00004d60: 2020 2020 2020 2020 6e62 5f70 6172 616c          nb_paral
+00004d70: 6c65 6c3d 6e62 5f70 6172 616c 6c65 6c2c  lel=nb_parallel,
+00004d80: 0a20 2020 2020 2020 2062 6174 6368 7369  .        batchsi
+00004d90: 7a65 3d62 6174 6368 7369 7a65 2c0a 2020  ze=batchsize,.  
+00004da0: 2020 2020 2020 666f 7263 653d 666f 7263        force=forc
+00004db0: 652c 0a20 2020 2029 0a0a 0a64 6566 2073  e,.    )...def s
+00004dc0: 696d 706c 6966 7928 0a20 2020 2069 6e70  implify(.    inp
+00004dd0: 7574 5f70 6174 683a 2050 6174 682c 0a20  ut_path: Path,. 
+00004de0: 2020 206f 7574 7075 745f 7061 7468 3a20     output_path: 
+00004df0: 5061 7468 2c0a 2020 2020 746f 6c65 7261  Path,.    tolera
+00004e00: 6e63 653a 2066 6c6f 6174 2c0a 2020 2020  nce: float,.    
+00004e10: 616c 676f 7269 7468 6d3a 2053 696d 706c  algorithm: Simpl
+00004e20: 6966 7941 6c67 6f72 6974 686d 203d 2053  ifyAlgorithm = S
+00004e30: 696d 706c 6966 7941 6c67 6f72 6974 686d  implifyAlgorithm
+00004e40: 2e52 414d 4552 5f44 4f55 474c 4153 5f50  .RAMER_DOUGLAS_P
+00004e50: 4555 434b 4552 2c0a 2020 2020 6c6f 6f6b  EUCKER,.    look
+00004e60: 6168 6561 643a 2069 6e74 203d 2038 2c0a  ahead: int = 8,.
+00004e70: 2020 2020 696e 7075 745f 6c61 7965 723a      input_layer:
+00004e80: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
+00004e90: 204e 6f6e 652c 0a20 2020 206f 7574 7075   None,.    outpu
+00004ea0: 745f 6c61 7965 723a 204f 7074 696f 6e61  t_layer: Optiona
+00004eb0: 6c5b 7374 725d 203d 204e 6f6e 652c 0a20  l[str] = None,. 
+00004ec0: 2020 2063 6f6c 756d 6e73 3a20 4f70 7469     columns: Opti
+00004ed0: 6f6e 616c 5b6c 6973 745b 7374 725d 5d20  onal[list[str]] 
+00004ee0: 3d20 4e6f 6e65 2c0a 2020 2020 6578 706c  = None,.    expl
+00004ef0: 6f64 6563 6f6c 6c65 6374 696f 6e73 3a20  odecollections: 
+00004f00: 626f 6f6c 203d 2046 616c 7365 2c0a 2020  bool = False,.  
+00004f10: 2020 6772 6964 7369 7a65 3a20 666c 6f61    gridsize: floa
+00004f20: 7420 3d20 302e 302c 0a20 2020 206b 6565  t = 0.0,.    kee
+00004f30: 705f 656d 7074 795f 6765 6f6d 733a 2062  p_empty_geoms: b
+00004f40: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
+00004f50: 2077 6865 7265 5f70 6f73 743a 204f 7074   where_post: Opt
+00004f60: 696f 6e61 6c5b 7374 725d 203d 204e 6f6e  ional[str] = Non
+00004f70: 652c 0a20 2020 206e 625f 7061 7261 6c6c  e,.    nb_parall
+00004f80: 656c 3a20 696e 7420 3d20 2d31 2c0a 2020  el: int = -1,.  
+00004f90: 2020 6261 7463 6873 697a 653a 2069 6e74    batchsize: int
+00004fa0: 203d 202d 312c 0a20 2020 2066 6f72 6365   = -1,.    force
+00004fb0: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
+00004fc0: 293a 0a20 2020 2023 2049 6e69 740a 2020  ):.    # Init.  
+00004fd0: 2020 6f70 6572 6174 696f 6e5f 7061 7261    operation_para
+00004fe0: 6d73 203d 207b 0a20 2020 2020 2020 2022  ms = {.        "
+00004ff0: 746f 6c65 7261 6e63 6522 3a20 746f 6c65  tolerance": tole
+00005000: 7261 6e63 652c 0a20 2020 2020 2020 2022  rance,.        "
+00005010: 616c 676f 7269 7468 6d22 3a20 616c 676f  algorithm": algo
+00005020: 7269 7468 6d2c 0a20 2020 2020 2020 2022  rithm,.        "
+00005030: 7374 6570 223a 206c 6f6f 6b61 6865 6164  step": lookahead
+00005040: 2c0a 2020 2020 7d0a 0a20 2020 2023 2047  ,.    }..    # G
+00005050: 6f21 0a20 2020 2072 6574 7572 6e20 5f61  o!.    return _a
+00005060: 7070 6c79 5f67 656f 6f70 6572 6174 696f  pply_geooperatio
+00005070: 6e5f 746f 5f6c 6179 6572 280a 2020 2020  n_to_layer(.    
+00005080: 2020 2020 696e 7075 745f 7061 7468 3d69      input_path=i
+00005090: 6e70 7574 5f70 6174 682c 0a20 2020 2020  nput_path,.     
+000050a0: 2020 206f 7574 7075 745f 7061 7468 3d6f     output_path=o
+000050b0: 7574 7075 745f 7061 7468 2c0a 2020 2020  utput_path,.    
+000050c0: 2020 2020 6f70 6572 6174 696f 6e3d 4765      operation=Ge
+000050d0: 6f4f 7065 7261 7469 6f6e 2e53 494d 504c  oOperation.SIMPL
+000050e0: 4946 592c 0a20 2020 2020 2020 206f 7065  IFY,.        ope
+000050f0: 7261 7469 6f6e 5f70 6172 616d 733d 6f70  ration_params=op
+00005100: 6572 6174 696f 6e5f 7061 7261 6d73 2c0a  eration_params,.
+00005110: 2020 2020 2020 2020 696e 7075 745f 6c61          input_la
+00005120: 7965 723d 696e 7075 745f 6c61 7965 722c  yer=input_layer,
+00005130: 0a20 2020 2020 2020 206f 7574 7075 745f  .        output_
+00005140: 6c61 7965 723d 6f75 7470 7574 5f6c 6179  layer=output_lay
+00005150: 6572 2c0a 2020 2020 2020 2020 636f 6c75  er,.        colu
+00005160: 6d6e 733d 636f 6c75 6d6e 732c 0a20 2020  mns=columns,.   
+00005170: 2020 2020 2065 7870 6c6f 6465 636f 6c6c       explodecoll
+00005180: 6563 7469 6f6e 733d 6578 706c 6f64 6563  ections=explodec
+00005190: 6f6c 6c65 6374 696f 6e73 2c0a 2020 2020  ollections,.    
+000051a0: 2020 2020 666f 7263 655f 6f75 7470 7574      force_output
+000051b0: 5f67 656f 6d65 7472 7974 7970 653d 4e6f  _geometrytype=No
+000051c0: 6e65 2c0a 2020 2020 2020 2020 6772 6964  ne,.        grid
+000051d0: 7369 7a65 3d67 7269 6473 697a 652c 0a20  size=gridsize,. 
+000051e0: 2020 2020 2020 206b 6565 705f 656d 7074         keep_empt
+000051f0: 795f 6765 6f6d 733d 6b65 6570 5f65 6d70  y_geoms=keep_emp
+00005200: 7479 5f67 656f 6d73 2c0a 2020 2020 2020  ty_geoms,.      
+00005210: 2020 7768 6572 655f 706f 7374 3d77 6865    where_post=whe
+00005220: 7265 5f70 6f73 742c 0a20 2020 2020 2020  re_post,.       
+00005230: 206e 625f 7061 7261 6c6c 656c 3d6e 625f   nb_parallel=nb_
+00005240: 7061 7261 6c6c 656c 2c0a 2020 2020 2020  parallel,.      
+00005250: 2020 6261 7463 6873 697a 653d 6261 7463    batchsize=batc
+00005260: 6873 697a 652c 0a20 2020 2020 2020 2066  hsize,.        f
+00005270: 6f72 6365 3d66 6f72 6365 2c0a 2020 2020  orce=force,.    
+00005280: 290a 0a0a 6465 6620 5f61 7070 6c79 5f67  )...def _apply_g
+00005290: 656f 6f70 6572 6174 696f 6e5f 746f 5f6c  eooperation_to_l
+000052a0: 6179 6572 280a 2020 2020 696e 7075 745f  ayer(.    input_
+000052b0: 7061 7468 3a20 5061 7468 2c0a 2020 2020  path: Path,.    
+000052c0: 6f75 7470 7574 5f70 6174 683a 2050 6174  output_path: Pat
+000052d0: 682c 0a20 2020 206f 7065 7261 7469 6f6e  h,.    operation
+000052e0: 3a20 4765 6f4f 7065 7261 7469 6f6e 2c0a  : GeoOperation,.
+000052f0: 2020 2020 6f70 6572 6174 696f 6e5f 7061      operation_pa
+00005300: 7261 6d73 3a20 6469 6374 2c0a 2020 2020  rams: dict,.    
+00005310: 696e 7075 745f 6c61 7965 723a 204f 7074  input_layer: Opt
+00005320: 696f 6e61 6c5b 7374 725d 2c20 2023 203d  ional[str],  # =
+00005330: 204e 6f6e 650a 2020 2020 636f 6c75 6d6e   None.    column
+00005340: 733a 204f 7074 696f 6e61 6c5b 6c69 7374  s: Optional[list
+00005350: 5b73 7472 5d5d 2c20 2023 203d 204e 6f6e  [str]],  # = Non
+00005360: 650a 2020 2020 6f75 7470 7574 5f6c 6179  e.    output_lay
+00005370: 6572 3a20 4f70 7469 6f6e 616c 5b73 7472  er: Optional[str
+00005380: 5d2c 2020 2320 3d20 4e6f 6e65 0a20 2020  ],  # = None.   
+00005390: 2065 7870 6c6f 6465 636f 6c6c 6563 7469   explodecollecti
+000053a0: 6f6e 733a 2062 6f6f 6c2c 2020 2320 3d20  ons: bool,  # = 
+000053b0: 4661 6c73 650a 2020 2020 666f 7263 655f  False.    force_
+000053c0: 6f75 7470 7574 5f67 656f 6d65 7472 7974  output_geometryt
+000053d0: 7970 653a 2055 6e69 6f6e 5b47 656f 6d65  ype: Union[Geome
+000053e0: 7472 7954 7970 652c 2073 7472 2c20 4e6f  tryType, str, No
+000053f0: 6e65 5d2c 2020 2320 3d20 4e6f 6e65 0a20  ne],  # = None. 
+00005400: 2020 2067 7269 6473 697a 653a 2066 6c6f     gridsize: flo
+00005410: 6174 2c20 2023 203d 2030 2e30 0a20 2020  at,  # = 0.0.   
+00005420: 206b 6565 705f 656d 7074 795f 6765 6f6d   keep_empty_geom
+00005430: 733a 2062 6f6f 6c2c 2020 2320 3d20 4661  s: bool,  # = Fa
+00005440: 6c73 650a 2020 2020 7768 6572 655f 706f  lse.    where_po
+00005450: 7374 3a20 4f70 7469 6f6e 616c 5b73 7472  st: Optional[str
+00005460: 5d2c 2020 2320 3d20 4e6f 6e65 0a20 2020  ],  # = None.   
+00005470: 206e 625f 7061 7261 6c6c 656c 3a20 696e   nb_parallel: in
+00005480: 742c 2020 2320 3d20 2d31 0a20 2020 2062  t,  # = -1.    b
+00005490: 6174 6368 7369 7a65 3a20 696e 742c 2020  atchsize: int,  
+000054a0: 2320 3d20 2d31 0a20 2020 2066 6f72 6365  # = -1.    force
+000054b0: 3a20 626f 6f6c 2c20 2023 203d 2046 616c  : bool,  # = Fal
+000054c0: 7365 0a20 2020 2070 6172 616c 6c65 6c69  se.    paralleli
+000054d0: 7a61 7469 6f6e 5f63 6f6e 6669 673a 204f  zation_config: O
+000054e0: 7074 696f 6e61 6c5b 5061 7261 6c6c 656c  ptional[Parallel
+000054f0: 697a 6174 696f 6e43 6f6e 6669 675d 203d  izationConfig] =
+00005500: 204e 6f6e 652c 0a29 3a0a 2020 2020 2222   None,.):.    ""
+00005510: 220a 2020 2020 4170 706c 6965 7320 6120  ".    Applies a 
+00005520: 6765 6f20 6f70 6572 6174 696f 6e20 6f6e  geo operation on
+00005530: 2061 206c 6179 6572 2e0a 0a20 2020 2054   a layer...    T
+00005540: 6865 206f 7065 7261 7469 6f6e 2074 6f20  he operation to 
+00005550: 6170 706c 7920 6361 6e20 6265 206f 6e65  apply can be one
+00005560: 206f 6620 7468 6520 7468 6520 666f 6c6c   of the the foll
+00005570: 6f77 696e 673a 0a20 2020 2020 202d 2042  owing:.      - B
+00005580: 5546 4645 523a 2061 7070 6c79 2061 2062  UFFER: apply a b
+00005590: 7566 6665 722e 204f 7065 7261 7469 6f6e  uffer. Operation
+000055a0: 2070 6172 616d 6574 6572 733a 0a20 2020   parameters:.   
+000055b0: 2020 2020 2020 202d 2064 6973 7461 6e63         - distanc
+000055c0: 653a 2064 6973 7461 6e63 6520 746f 2062  e: distance to b
+000055d0: 7566 6665 720a 2020 2020 2020 2020 2020  uffer.          
+000055e0: 2d20 7175 6164 7261 6e74 7365 676d 656e  - quadrantsegmen
+000055f0: 7473 3a20 6e75 6d62 6572 206f 6620 706f  ts: number of po
+00005600: 696e 7473 2075 7365 6420 746f 2072 6570  ints used to rep
+00005610: 7265 7365 6e74 2031 2f34 206f 6620 6120  resent 1/4 of a 
+00005620: 6369 7263 6c65 0a20 2020 2020 2020 2020  circle.         
+00005630: 202d 2065 6e64 6361 705f 7374 796c 653a   - endcap_style:
+00005640: 2062 7566 6665 7220 7374 796c 6520 746f   buffer style to
+00005650: 2075 7365 2066 6f72 2061 2070 6f69 6e74   use for a point
+00005660: 206f 7220 7468 6520 656e 6420 706f 696e   or the end poin
+00005670: 7473 206f 660a 2020 2020 2020 2020 2020  ts of.          
+00005680: 2020 6120 6c69 6e65 3a0a 2020 2020 2020    a line:.      
+00005690: 2020 2020 2020 2d20 524f 554e 443a 2066        - ROUND: f
+000056a0: 6f72 2070 6f69 6e74 7320 616e 6420 6c69  or points and li
+000056b0: 6e65 7320 7468 6520 656e 6473 2061 7265  nes the ends are
+000056c0: 2062 7566 6665 7265 6420 726f 756e 6465   buffered rounde
+000056d0: 642e 0a20 2020 2020 2020 2020 2020 202d  d..            -
+000056e0: 2046 4c41 543a 2061 2070 6f69 6e74 2073   FLAT: a point s
+000056f0: 7461 7973 2061 2070 6f69 6e74 2c20 6120  tays a point, a 
+00005700: 6275 6666 6572 6564 206c 696e 6520 7769  buffered line wi
+00005710: 6c6c 2065 6e64 2066 6c61 740a 2020 2020  ll end flat.    
+00005720: 2020 2020 2020 2020 2020 6174 2074 6865            at the
+00005730: 2065 6e64 2070 6f69 6e74 730a 2020 2020   end points.    
+00005740: 2020 2020 2020 2020 2d20 5351 5541 5245          - SQUARE
+00005750: 3a20 6120 706f 696e 7420 6265 636f 6d65  : a point become
+00005760: 7320 6120 7371 7561 7265 2c20 6120 6275  s a square, a bu
+00005770: 6666 6572 6564 206c 696e 6520 7769 6c6c  ffered line will
+00005780: 2065 6e64 0a20 2020 2020 2020 2020 2020   end.           
+00005790: 2020 2066 6c61 7420 6174 2074 6865 2065     flat at the e
+000057a0: 6e64 2070 6f69 6e74 732c 2062 7574 2065  nd points, but e
+000057b0: 6c6f 6e67 6174 6564 2062 7920 2264 6973  longated by "dis
+000057c0: 7461 6e63 6522 0a20 2020 2020 2020 202d  tance".        -
+000057d0: 206a 6f69 6e5f 7374 796c 653a 2062 7566   join_style: buf
+000057e0: 6665 7220 7374 796c 6520 746f 2075 7365  fer style to use
+000057f0: 2066 6f72 2063 6f72 6e65 7273 2069 6e20   for corners in 
+00005800: 6120 6c69 6e65 206f 7220 6120 706f 6c79  a line or a poly
+00005810: 676f 6e0a 2020 2020 2020 2020 2020 626f  gon.          bo
+00005820: 756e 6461 7279 3a0a 2020 2020 2020 2020  undary:.        
+00005830: 2020 2020 2d20 524f 554e 443a 2063 6f72      - ROUND: cor
+00005840: 6e65 7273 2069 6e20 7468 6520 7265 7375  ners in the resu
+00005850: 6c74 2061 7265 2072 6f75 6e64 6564 0a20  lt are rounded. 
+00005860: 2020 2020 2020 2020 2020 202d 204d 4954             - MIT
+00005870: 5245 3a20 636f 726e 6572 7320 696e 2074  RE: corners in t
+00005880: 6865 2072 6573 756c 7420 6172 6520 7368  he result are sh
+00005890: 6172 700a 2020 2020 2020 2020 2020 2020  arp.            
+000058a0: 2d20 4245 5645 4c3a 2061 7265 2066 6c61  - BEVEL: are fla
+000058b0: 7474 656e 6564 0a20 2020 2020 2020 202d  ttened.        -
+000058c0: 206d 6974 7265 5f6c 696d 6974 3a20 696e   mitre_limit: in
+000058d0: 2063 6173 6520 6f66 206a 6f69 6e5f 7374   case of join_st
+000058e0: 796c 6520 4d49 5452 452c 2069 6620 7468  yle MITRE, if th
+000058f0: 650a 2020 2020 2020 2020 2020 2020 7370  e.            sp
+00005900: 696b 7920 7265 7375 6c74 2066 6f72 2061  iky result for a
+00005910: 2073 6861 7270 2061 6e67 6c65 2062 6563   sharp angle bec
+00005920: 6f6d 6573 206c 6f6e 6765 7220 7468 616e  omes longer than
+00005930: 2074 6869 7320 6c69 6d69 742c 2069 740a   this limit, it.
+00005940: 2020 2020 2020 2020 2020 2020 6973 2022              is "
+00005950: 6265 7665 6c65 6422 2061 7420 7468 6973  beveled" at this
+00005960: 2064 6973 7461 6e63 652e 2044 6566 6175   distance. Defau
+00005970: 6c74 7320 746f 2035 2e30 2e0a 2020 2020  lts to 5.0..    
+00005980: 2020 2020 2d20 7369 6e67 6c65 5f73 6964      - single_sid
+00005990: 6564 3a20 6f6e 6c79 206f 6e65 2073 6964  ed: only one sid
+000059a0: 6520 6f66 2074 6865 206c 696e 6520 6973  e of the line is
+000059b0: 2062 7566 6665 7265 642c 0a20 2020 2020   buffered,.     
+000059c0: 2020 2020 2020 2069 6620 6469 7374 616e         if distan
+000059d0: 6365 2069 7320 6e65 6761 7469 7665 2c20  ce is negative, 
+000059e0: 7468 6520 6c65 6674 2073 6964 652c 2069  the left side, i
+000059f0: 6620 6469 7374 616e 6365 2069 7320 706f  f distance is po
+00005a00: 7369 7469 7665 2c0a 2020 2020 2020 2020  sitive,.        
+00005a10: 2020 2020 7468 6520 7269 6768 7420 6861      the right ha
+00005a20: 6e64 2073 6964 652e 204f 6e6c 7920 7265  nd side. Only re
+00005a30: 6c65 7661 6e74 2066 6f72 206c 696e 6520  levant for line 
+00005a40: 6765 6f6d 6574 7269 6573 2e0a 2020 2020  geometries..    
+00005a50: 2020 2d20 434f 4e56 4558 4855 4c4c 3a20    - CONVEXHULL: 
+00005a60: 6170 7079 2061 2063 6f6e 7665 7820 6875  appy a convex hu
+00005a70: 6c6c 2e0a 2020 2020 2020 2d20 5349 4d50  ll..      - SIMP
+00005a80: 4c49 4659 3a20 7369 6d70 6c69 6679 2074  LIFY: simplify t
+00005a90: 6865 2067 656f 6d65 7472 792e 204f 7065  he geometry. Ope
+00005aa0: 7261 7469 6f6e 2070 6172 616d 6574 6572  ration parameter
+00005ab0: 733a 0a20 2020 2020 2020 2020 202d 2061  s:.          - a
+00005ac0: 6c67 6f72 6974 686d 3a20 7665 6374 6f72  lgorithm: vector
+00005ad0: 5f75 7469 6c2e 5369 6d70 6c69 6679 416c  _util.SimplifyAl
+00005ae0: 676f 7269 7468 6d0a 2020 2020 2020 2020  gorithm.        
+00005af0: 2020 2d20 746f 6c65 7261 6e63 653a 206d    - tolerance: m
+00005b00: 6178 696d 756d 2064 6973 7461 6e63 6520  aximum distance 
+00005b10: 746f 2073 696d 706c 6966 792e 0a20 2020  to simplify..   
+00005b20: 2020 2020 2020 202d 206c 6f6f 6b61 6865         - lookahe
+00005b30: 6164 3a20 666f 7220 4c41 4e47 2c20 7468  ad: for LANG, th
+00005b40: 6520 6e75 6d62 6572 206f 6620 706f 696e  e number of poin
+00005b50: 7473 2074 6f20 666f 7277 6172 642d 6c6f  ts to forward-lo
+00005b60: 6f6b 0a20 2020 2020 202d 2041 5050 4c59  ok.      - APPLY
+00005b70: 3a20 6170 706c 7920 6120 6c61 6d62 6461  : apply a lambda
+00005b80: 2066 756e 6374 696f 6e2e 204f 7065 7261   function. Opera
+00005b90: 7469 6f6e 2070 6172 616d 6574 6572 3a0a  tion parameter:.
+00005ba0: 2020 2020 2020 2020 2020 2d20 7069 636b            - pick
+00005bb0: 6c65 645f 6675 6e63 3a20 6c61 6d62 6461  led_func: lambda
+00005bc0: 2066 756e 6374 696f 6e20 746f 2061 7070   function to app
+00005bd0: 6c79 2c20 7069 636b 6c65 6420 746f 2062  ly, pickled to b
+00005be0: 7974 6573 2e0a 2020 2020 2020 2020 2020  ytes..          
+00005bf0: 2d20 6f6e 6c79 5f67 656f 6d5f 696e 7075  - only_geom_inpu
+00005c00: 743a 2069 6620 5472 7565 2c20 6f6e 6c79  t: if True, only
+00005c10: 2074 6865 2067 656f 6d65 7472 7920 6973   the geometry is
+00005c20: 2061 7661 696c 6162 6c65 2061 730a 2020   available as.  
+00005c30: 2020 2020 2020 2020 2020 696e 7075 7420            input 
+00005c40: 666f 7220 7468 6520 6c61 6d62 6461 2066  for the lambda f
+00005c50: 756e 6374 696f 6e2e 2049 6620 6661 6c73  unction. If fals
+00005c60: 652c 2074 6865 2072 6f77 2069 7320 7468  e, the row is th
+00005c70: 6520 696e 7075 742e 0a0a 2020 2020 4172  e input...    Ar
+00005c80: 6773 3a0a 2020 2020 2020 2020 696e 7075  gs:.        inpu
+00005c90: 745f 7061 7468 2028 5061 7468 293a 205b  t_path (Path): [
+00005ca0: 6465 7363 7269 7074 696f 6e5d 0a20 2020  description].   
+00005cb0: 2020 2020 206f 7574 7075 745f 7061 7468       output_path
+00005cc0: 2028 5061 7468 293a 205b 6465 7363 7269   (Path): [descri
+00005cd0: 7074 696f 6e5d 0a20 2020 2020 2020 206f  ption].        o
+00005ce0: 7065 7261 7469 6f6e 2028 4765 6f4f 7065  peration (GeoOpe
+00005cf0: 7261 7469 6f6e 293a 2074 6865 2067 656f  ration): the geo
+00005d00: 206f 7065 7261 7469 6f6e 2074 6f20 6170   operation to ap
+00005d10: 706c 792e 0a20 2020 2020 2020 206f 7065  ply..        ope
+00005d20: 7261 7469 6f6e 5f70 6172 616d 7320 2864  ration_params (d
+00005d30: 6963 742c 206f 7074 696f 6e61 6c29 3a20  ict, optional): 
+00005d40: 7468 6520 7061 7261 6d65 7465 7273 2066  the parameters f
+00005d50: 6f72 2074 6865 2067 656f 206f 7065 7261  or the geo opera
+00005d60: 7469 6f6e 2e0a 2020 2020 2020 2020 2020  tion..          
+00005d70: 2020 4465 6661 756c 7473 2074 6f20 4e6f    Defaults to No
+00005d80: 6e65 2e0a 2020 2020 2020 2020 696e 7075  ne..        inpu
+00005d90: 745f 6c61 7965 7220 2873 7472 2c20 6f70  t_layer (str, op
+00005da0: 7469 6f6e 616c 293a 205b 6465 7363 7269  tional): [descri
+00005db0: 7074 696f 6e5d 2e20 4465 6661 756c 7473  ption]. Defaults
+00005dc0: 2074 6f20 4e6f 6e65 2e0a 2020 2020 2020   to None..      
+00005dd0: 2020 6f75 7470 7574 5f6c 6179 6572 2028    output_layer (
+00005de0: 7374 722c 206f 7074 696f 6e61 6c29 3a20  str, optional): 
+00005df0: 5b64 6573 6372 6970 7469 6f6e 5d2e 2044  [description]. D
+00005e00: 6566 6175 6c74 7320 746f 204e 6f6e 652e  efaults to None.
+00005e10: 0a20 2020 2020 2020 2063 6f6c 756d 6e73  .        columns
+00005e20: 2028 4c69 7374 5b73 7472 5d2c 206f 7074   (List[str], opt
+00005e30: 696f 6e61 6c29 3a20 4966 206e 6f74 204e  ional): If not N
+00005e40: 6f6e 652c 206f 6e6c 7920 6f75 7470 7574  one, only output
+00005e50: 2074 6865 2063 6f6c 756d 6e73 0a20 2020   the columns.   
+00005e60: 2020 2020 2020 2020 2073 7065 6369 6669           specifi
+00005e70: 6564 2e20 4465 6661 756c 7473 2074 6f20  ed. Defaults to 
+00005e80: 4e6f 6e65 2e0a 2020 2020 2020 2020 6578  None..        ex
+00005e90: 706c 6f64 6563 6f6c 6c65 6374 696f 6e73  plodecollections
+00005ea0: 2028 626f 6f6c 2c20 6f70 7469 6f6e 616c   (bool, optional
+00005eb0: 293a 2054 7275 6520 746f 2063 6f6e 7665  ): True to conve
+00005ec0: 7274 2061 6c6c 206d 756c 7469 2d67 656f  rt all multi-geo
+00005ed0: 6d65 7472 6965 7320 746f 0a20 2020 2020  metries to.     
+00005ee0: 2020 2020 2020 2073 696e 6775 6c61 7220         singular 
+00005ef0: 6f6e 6573 2064 7572 696e 6720 7468 6520  ones during the 
+00005f00: 6765 6f6f 7065 7261 7469 6f6e 2e20 4465  geooperation. De
+00005f10: 6661 756c 7473 2074 6f20 4661 6c73 652e  faults to False.
+00005f20: 0a20 2020 2020 2020 2066 6f72 6365 5f6f  .        force_o
+00005f30: 7574 7075 745f 6765 6f6d 6574 7279 7479  utput_geometryty
+00005f40: 7065 2028 4765 6f6d 6574 7279 5479 7065  pe (GeometryType
+00005f50: 2c20 6f70 7469 6f6e 616c 293a 2054 6865  , optional): The
+00005f60: 206f 7574 7075 7420 6765 6f6d 6574 7279   output geometry
+00005f70: 2074 7970 6520 746f 0a20 2020 2020 2020   type to.       
+00005f80: 2020 2020 2066 6f72 6365 2e20 4966 204e       force. If N
+00005f90: 6f6e 652c 2061 2062 6573 742d 6566 666f  one, a best-effo
+00005fa0: 7274 2067 7565 7373 2069 7320 6d61 6465  rt guess is made
+00005fb0: 2e20 4465 6661 756c 7473 2074 6f20 4e6f  . Defaults to No
+00005fc0: 6e65 2e0a 2020 2020 2020 2020 6772 6964  ne..        grid
+00005fd0: 7369 7a65 2028 666c 6f61 742c 206f 7074  size (float, opt
+00005fe0: 696f 6e61 6c29 3a20 7468 6520 7369 7a65  ional): the size
+00005ff0: 206f 6620 7468 6520 6772 6964 2074 6865   of the grid the
+00006000: 2063 6f6f 7264 696e 6174 6573 206f 6620   coordinates of 
+00006010: 7468 6520 6f75 7075 740a 2020 2020 2020  the ouput.      
+00006020: 2020 2020 2020 7769 6c6c 2062 6520 726f        will be ro
+00006030: 756e 6465 6420 746f 2e20 4567 2e20 302e  unded to. Eg. 0.
+00006040: 3030 3120 746f 206b 6565 7020 3320 6465  001 to keep 3 de
+00006050: 6369 6d61 6c73 2e20 5661 6c75 6520 302e  cimals. Value 0.
+00006060: 3020 646f 6573 6e27 7420 6368 616e 6765  0 doesn't change
+00006070: 0a20 2020 2020 2020 2020 2020 2074 6865  .            the
+00006080: 2070 7265 6369 7369 6f6e 2e20 4465 6661   precision. Defa
+00006090: 756c 7473 2074 6f20 302e 302e 0a20 2020  ults to 0.0..   
+000060a0: 2020 2020 206b 6565 705f 656d 7074 795f       keep_empty_
+000060b0: 6765 6f6d 7320 2862 6f6f 6c2c 206f 7074  geoms (bool, opt
+000060c0: 696f 6e61 6c29 3a20 5472 7565 2074 6f20  ional): True to 
+000060d0: 6b65 6570 2072 6f77 7320 7769 7468 2065  keep rows with e
+000060e0: 6d70 7479 2f6e 756c 6c20 6765 6f6d 6574  mpty/null geomet
+000060f0: 7269 6573 0a20 2020 2020 2020 2020 2020  ries.           
+00006100: 2069 6e20 7468 6520 6f75 7470 7574 2e20   in the output. 
+00006110: 4465 6661 756c 7473 2074 6f20 4661 6c73  Defaults to Fals
+00006120: 652e 0a20 2020 2020 2020 2077 6865 7265  e..        where
+00006130: 5f70 6f73 7420 2873 7472 2c20 6f70 7469  _post (str, opti
+00006140: 6f6e 616c 293a 2073 716c 2066 696c 7465  onal): sql filte
+00006150: 7220 746f 2061 7070 6c79 2061 6674 6572  r to apply after
+00006160: 2061 6c6c 206f 7468 6572 2070 726f 6365   all other proce
+00006170: 7373 696e 672c 0a20 2020 2020 2020 2020  ssing,.         
+00006180: 2020 2069 6e63 6c75 6469 6e67 2065 2e67     including e.g
+00006190: 2e20 6578 706c 6f64 6563 6f6c 6c65 6374  . explodecollect
+000061a0: 696f 6e73 2e20 4974 2073 686f 756c 6420  ions. It should 
+000061b0: 6265 2069 6e20 7371 6c69 7465 2073 796e  be in sqlite syn
+000061c0: 7461 7820 616e 640a 2020 2020 2020 2020  tax and.        
+000061d0: 2020 2020 7c73 7061 7469 616c 6974 655f      |spatialite_
+000061e0: 7265 6665 7265 6e63 655f 6c69 6e6b 7c20  reference_link| 
+000061f0: 6675 6e63 7469 6f6e 7320 6361 6e20 6265  functions can be
+00006200: 2075 7365 642e 2044 6566 6175 6c74 7320   used. Defaults 
+00006210: 746f 204e 6f6e 652e 0a20 2020 2020 2020  to None..       
+00006220: 206e 625f 7061 7261 6c6c 656c 2028 696e   nb_parallel (in
+00006230: 742c 206f 7074 696f 6e61 6c29 3a20 5b64  t, optional): [d
+00006240: 6573 6372 6970 7469 6f6e 5d2e 2044 6566  escription]. Def
+00006250: 6175 6c74 7320 746f 202d 312e 0a20 2020  aults to -1..   
+00006260: 2020 2020 2062 6174 6368 7369 7a65 2028       batchsize (
+00006270: 696e 742c 206f 7074 696f 6e61 6c29 3a20  int, optional): 
+00006280: 696e 6469 6361 7469 7665 206e 756d 6265  indicative numbe
+00006290: 7220 6f66 2072 6f77 7320 746f 2070 726f  r of rows to pro
+000062a0: 6365 7373 2070 6572 0a20 2020 2020 2020  cess per.       
+000062b0: 2020 2020 2062 6174 6368 2e20 4120 736d       batch. A sm
+000062c0: 616c 6c65 7220 6261 7463 6820 7369 7a65  aller batch size
+000062d0: 2c20 706f 7373 6962 6c79 2069 6e20 636f  , possibly in co
+000062e0: 6d62 696e 6174 696f 6e20 7769 7468 2061  mbination with a
+000062f0: 0a20 2020 2020 2020 2020 2020 2073 6d61  .            sma
+00006300: 6c6c 6572 206e 625f 7061 7261 6c6c 656c  ller nb_parallel
+00006310: 2c20 7769 6c6c 2072 6564 7563 6520 7468  , will reduce th
+00006320: 6520 6d65 6d6f 7279 2075 7361 6765 2e0a  e memory usage..
+00006330: 2020 2020 2020 2020 2020 2020 4465 6661              Defa
+00006340: 756c 7473 2074 6f20 2d31 3a20 2874 7279  ults to -1: (try
+00006350: 2074 6f29 2064 6574 6572 6d69 6e65 206f   to) determine o
+00006360: 7074 696d 616c 2073 697a 6520 6175 746f  ptimal size auto
+00006370: 6d61 7469 6361 6c6c 792e 0a20 2020 2020  matically..     
+00006380: 2020 2066 6f72 6365 2028 626f 6f6c 2c20     force (bool, 
+00006390: 6f70 7469 6f6e 616c 293a 205b 6465 7363  optional): [desc
+000063a0: 7269 7074 696f 6e5d 2e20 4465 6661 756c  ription]. Defaul
+000063b0: 7473 2074 6f20 4661 6c73 652e 0a20 2020  ts to False..   
+000063c0: 2020 2020 2070 6172 616c 6c65 6c69 7a61       paralleliza
+000063d0: 7469 6f6e 5f63 6f6e 6669 6720 2850 6172  tion_config (Par
+000063e0: 616c 6c65 6c69 7a61 7469 6f6e 436f 6e66  allelizationConf
+000063f0: 6967 2c20 6f70 7469 6f6e 616c 293a 2044  ig, optional): D
+00006400: 6566 6175 6c74 7320 746f 204e 6f6e 652e  efaults to None.
+00006410: 0a0a 2020 2020 5465 6368 6e69 6361 6c20  ..    Technical 
+00006420: 7265 6d61 726b 733a 0a20 2020 2020 2020  remarks:.       
+00006430: 202d 2052 6574 6169 6e69 6e67 204e 6f6e   - Retaining Non
+00006440: 6520 6765 6f6d 6574 7279 2076 616c 7565  e geometry value
+00006450: 7320 696e 2074 6865 206f 7574 7075 7420  s in the output 
+00006460: 6669 6c65 7320 6973 2068 6172 642c 2062  files is hard, b
+00006470: 6563 6175 7365 2077 6865 6e0a 2020 2020  ecause when.    
+00006480: 2020 2020 2020 6361 6c63 756c 6174 696e        calculatin
+00006490: 6720 7061 7274 6961 6c20 6669 6c65 732c  g partial files,
+000064a0: 2061 2070 6172 7469 616c 2066 696c 6520   a partial file 
+000064b0: 6361 6e20 6861 7665 206f 6e6c 7920 4e6f  can have only No
+000064c0: 6e65 2067 656f 6d65 7472 6965 7320 7768  ne geometries wh
+000064d0: 6963 680a 2020 2020 2020 2020 2020 6d61  ich.          ma
+000064e0: 6b65 7320 6974 2069 6d70 6f73 7369 626c  kes it impossibl
+000064f0: 6520 746f 206b 6e6f 7720 7468 6520 6765  e to know the ge
+00006500: 6f6d 6574 7279 2074 7970 652e 204f 6e63  ometry type. Onc
+00006510: 6520 616e 206f 7574 7075 7420 6669 6c65  e an output file
+00006520: 2069 7320 6372 6561 7465 642c 0a20 2020   is created,.   
+00006530: 2020 2020 2020 2069 7420 6973 2061 6c73         it is als
+00006540: 6f20 696d 706f 7373 6962 6c65 2074 6f20  o impossible to 
+00006550: 6368 616e 6765 2074 6865 2074 7970 6520  change the type 
+00006560: 6166 7465 7277 6172 6473 2028 7769 7468  afterwards (with
+00006570: 6f75 7420 6d61 6b69 6e67 2061 2063 6f70  out making a cop
+00006580: 7929 2e0a 2020 2020 2020 2020 2020 4966  y)..          If
+00006590: 2066 6f72 6365 5f6f 7574 7075 745f 7479   force_output_ty
+000065a0: 7065 2069 7320 7370 6563 6966 6965 642c  pe is specified,
+000065b0: 2074 6865 2070 726f 626c 656d 2069 7320   the problem is 
+000065c0: 676f 6e65 2e0a 0a20 2020 202e 2e20 7c73  gone...    .. |s
+000065d0: 7061 7469 616c 6974 655f 7265 6665 7265  patialite_refere
+000065e0: 6e63 655f 6c69 6e6b 7c20 7261 773a 3a20  nce_link| raw:: 
+000065f0: 6874 6d6c 0a0a 2020 2020 2020 2020 3c61  html..        <a
+00006600: 2068 7265 663d 2268 7474 7073 3a2f 2f77   href="https://w
+00006610: 7777 2e67 6169 612d 6769 732e 6974 2f67  ww.gaia-gis.it/g
+00006620: 6169 612d 7369 6e73 2f73 7061 7469 616c  aia-sins/spatial
+00006630: 6974 652d 7371 6c2d 6c61 7465 7374 2e68  ite-sql-latest.h
+00006640: 746d 6c22 2074 6172 6765 743d 225f 626c  tml" target="_bl
+00006650: 616e 6b22 3e73 7061 7469 616c 6974 6520  ank">spatialite 
+00006660: 7265 6665 7265 6e63 653c 2f61 3e0a 0a20  reference</a>.. 
+00006670: 2020 2022 2222 2020 2320 6e6f 7161 3a20     """  # noqa: 
+00006680: 4535 3031 0a20 2020 2023 2049 6e69 740a  E501.    # Init.
+00006690: 2020 2020 7374 6172 745f 7469 6d65 5f67      start_time_g
+000066a0: 6c6f 6261 6c20 3d20 6461 7465 7469 6d65  lobal = datetime
+000066b0: 2e6e 6f77 2829 0a20 2020 206f 7065 7261  .now().    opera
+000066c0: 7469 6f6e 5f6e 616d 6520 3d20 6f70 6572  tion_name = oper
+000066d0: 6174 696f 6e5f 7061 7261 6d73 2e67 6574  ation_params.get
+000066e0: 2822 6f70 6572 6174 696f 6e5f 6e61 6d65  ("operation_name
+000066f0: 2229 0a20 2020 2069 6620 6f70 6572 6174  ").    if operat
+00006700: 696f 6e5f 6e61 6d65 2069 7320 4e6f 6e65  ion_name is None
+00006710: 3a0a 2020 2020 2020 2020 6f70 6572 6174  :.        operat
+00006720: 696f 6e5f 6e61 6d65 203d 206f 7065 7261  ion_name = opera
+00006730: 7469 6f6e 2e76 616c 7565 0a20 2020 206c  tion.value.    l
+00006740: 6f67 6765 7220 3d20 6c6f 6767 696e 672e  ogger = logging.
+00006750: 6765 744c 6f67 6765 7228 6622 6765 6f66  getLogger(f"geof
+00006760: 696c 656f 7073 2e7b 6f70 6572 6174 696f  ileops.{operatio
+00006770: 6e5f 6e61 6d65 7d22 290a 0a20 2020 2023  n_name}")..    #
+00006780: 2043 6865 636b 2069 6e70 7574 2070 6172   Check input par
+00006790: 616d 6574 6572 732e 2e2e 0a20 2020 2069  ameters....    i
+000067a0: 6620 6e6f 7420 696e 7075 745f 7061 7468  f not input_path
+000067b0: 2e65 7869 7374 7328 293a 0a20 2020 2020  .exists():.     
+000067c0: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+000067d0: 726f 7228 6622 7b6f 7065 7261 7469 6f6e  ror(f"{operation
+000067e0: 5f6e 616d 657d 3a20 696e 7075 745f 7061  _name}: input_pa
+000067f0: 7468 2064 6f65 736e 2774 2065 7869 7374  th doesn't exist
+00006800: 3a20 7b69 6e70 7574 5f70 6174 687d 2229  : {input_path}")
+00006810: 0a20 2020 2069 6620 696e 7075 745f 7061  .    if input_pa
+00006820: 7468 203d 3d20 6f75 7470 7574 5f70 6174  th == output_pat
+00006830: 683a 0a20 2020 2020 2020 2072 6169 7365  h:.        raise
+00006840: 2056 616c 7565 4572 726f 7228 6622 7b6f   ValueError(f"{o
+00006850: 7065 7261 7469 6f6e 5f6e 616d 657d 3a20  peration_name}: 
+00006860: 6f75 7470 7574 5f70 6174 6820 6d75 7374  output_path must
+00006870: 206e 6f74 2065 7175 616c 2069 6e70 7574   not equal input
+00006880: 5f70 6174 6822 290a 2020 2020 6966 2069  _path").    if i
+00006890: 6e70 7574 5f6c 6179 6572 2069 7320 4e6f  nput_layer is No
+000068a0: 6e65 3a0a 2020 2020 2020 2020 696e 7075  ne:.        inpu
+000068b0: 745f 6c61 7965 7220 3d20 6766 6f2e 6765  t_layer = gfo.ge
+000068c0: 745f 6f6e 6c79 5f6c 6179 6572 2869 6e70  t_only_layer(inp
+000068d0: 7574 5f70 6174 6829 0a20 2020 2069 6620  ut_path).    if 
+000068e0: 5f69 6f5f 7574 696c 2e6f 7574 7075 745f  _io_util.output_
+000068f0: 6578 6973 7473 2870 6174 683d 6f75 7470  exists(path=outp
+00006900: 7574 5f70 6174 682c 2072 656d 6f76 655f  ut_path, remove_
+00006910: 6966 5f65 7869 7374 733d 666f 7263 6529  if_exists=force)
+00006920: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+00006930: 0a20 2020 2069 6620 696e 7075 745f 6c61  .    if input_la
+00006940: 7965 7220 6973 204e 6f6e 653a 0a20 2020  yer is None:.   
+00006950: 2020 2020 2069 6e70 7574 5f6c 6179 6572       input_layer
+00006960: 203d 2067 666f 2e67 6574 5f6f 6e6c 795f   = gfo.get_only_
+00006970: 6c61 7965 7228 696e 7075 745f 7061 7468  layer(input_path
+00006980: 290a 2020 2020 6966 206f 7574 7075 745f  ).    if output_
+00006990: 6c61 7965 7220 6973 204e 6f6e 653a 0a20  layer is None:. 
+000069a0: 2020 2020 2020 206f 7574 7075 745f 6c61         output_la
+000069b0: 7965 7220 3d20 6766 6f2e 6765 745f 6465  yer = gfo.get_de
+000069c0: 6661 756c 745f 6c61 7965 7228 6f75 7470  fault_layer(outp
+000069d0: 7574 5f70 6174 6829 0a20 2020 2069 6620  ut_path).    if 
+000069e0: 6973 696e 7374 616e 6365 2866 6f72 6365  isinstance(force
+000069f0: 5f6f 7574 7075 745f 6765 6f6d 6574 7279  _output_geometry
+00006a00: 7479 7065 2c20 4765 6f6d 6574 7279 5479  type, GeometryTy
+00006a10: 7065 293a 0a20 2020 2020 2020 2066 6f72  pe):.        for
+00006a20: 6365 5f6f 7574 7075 745f 6765 6f6d 6574  ce_output_geomet
+00006a30: 7279 7479 7065 203d 2066 6f72 6365 5f6f  rytype = force_o
+00006a40: 7574 7075 745f 6765 6f6d 6574 7279 7479  utput_geometryty
+00006a50: 7065 2e6e 616d 650a 0a20 2020 2023 2043  pe.name..    # C
+00006a60: 6865 636b 2069 6620 7765 2077 616e 7420  heck if we want 
+00006a70: 746f 2070 7265 7365 7276 6520 7468 6520  to preserve the 
+00006a80: 6669 6420 696e 2074 6865 206f 7574 7075  fid in the outpu
+00006a90: 740a 2020 2020 7072 6573 6572 7665 5f66  t.    preserve_f
+00006aa0: 6964 203d 2046 616c 7365 0a20 2020 2069  id = False.    i
+00006ab0: 6620 6e6f 7420 6578 706c 6f64 6563 6f6c  f not explodecol
+00006ac0: 6c65 6374 696f 6e73 2061 6e64 2067 666f  lections and gfo
+00006ad0: 2e67 6574 5f64 7269 7665 7228 6f75 7470  .get_driver(outp
+00006ae0: 7574 5f70 6174 6829 203d 3d20 2247 504b  ut_path) == "GPK
+00006af0: 4722 3a0a 2020 2020 2020 2020 7072 6573  G":.        pres
+00006b00: 6572 7665 5f66 6964 203d 2054 7275 650a  erve_fid = True.
+00006b10: 0a20 2020 2023 2050 7265 7061 7265 2077  .    # Prepare w
+00006b20: 6865 7265 5f74 6f5f 6170 706c 7920 616e  here_to_apply an
+00006b30: 6420 6669 6c74 6572 5f6e 756c 6c5f 6765  d filter_null_ge
+00006b40: 6f6d 730a 2020 2020 6966 2077 6865 7265  oms.    if where
+00006b50: 5f70 6f73 7420 6973 206e 6f74 204e 6f6e  _post is not Non
+00006b60: 653a 0a20 2020 2020 2020 2069 6620 7768  e:.        if wh
+00006b70: 6572 655f 706f 7374 203d 3d20 2222 3a0a  ere_post == "":.
+00006b80: 2020 2020 2020 2020 2020 2020 7768 6572              wher
+00006b90: 655f 706f 7374 203d 204e 6f6e 650a 2020  e_post = None.  
+00006ba0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00006bb0: 2020 2020 2020 2020 2320 416c 7761 7973          # Always
+00006bc0: 2073 6574 2067 656f 6d65 7472 7963 6f6c   set geometrycol
+00006bd0: 756d 6e20 746f 2022 6765 6f6d 222c 2062  umn to "geom", b
+00006be0: 6563 6175 7365 2077 6865 7265 5f70 6f73  ecause where_pos
+00006bf0: 7420 7061 7261 6d65 7465 7220 666f 7220  t parameter for 
+00006c00: 7368 700a 2020 2020 2020 2020 2020 2020  shp.            
+00006c10: 2320 646f 6573 6e27 7420 7365 656d 2074  # doesn't seem t
+00006c20: 6f20 776f 726b 2e2e 2e20 736f 2063 7265  o work... so cre
+00006c30: 6174 6520 7465 6d70 2070 6172 7469 616c  ate temp partial
+00006c40: 2066 696c 6573 2061 6c77 6179 7320 6173   files always as
+00006c50: 2067 706b 672e 0a20 2020 2020 2020 2020   gpkg..         
+00006c60: 2020 2077 6865 7265 5f70 6f73 7420 3d20     where_post = 
+00006c70: 7768 6572 655f 706f 7374 2e66 6f72 6d61  where_post.forma
+00006c80: 7428 6765 6f6d 6574 7279 636f 6c75 6d6e  t(geometrycolumn
+00006c90: 3d22 6765 6f6d 2229 0a0a 2020 2020 2320  ="geom")..    # 
+00006ca0: 5072 6570 6172 6520 746d 7020 6669 6c65  Prepare tmp file
+00006cb0: 730a 2020 2020 746d 705f 6469 7220 3d20  s.    tmp_dir = 
+00006cc0: 5f69 6f5f 7574 696c 2e63 7265 6174 655f  _io_util.create_
+00006cd0: 7465 6d70 6469 7228 6622 6765 6f66 696c  tempdir(f"geofil
+00006ce0: 656f 7073 2f7b 6f70 6572 6174 696f 6e2e  eops/{operation.
+00006cf0: 7661 6c75 657d 2229 0a20 2020 206c 6f67  value}").    log
+00006d00: 6765 722e 6465 6275 6728 6622 5374 6172  ger.debug(f"Star
+00006d10: 7420 6361 6c63 756c 6174 696f 6e20 746f  t calculation to
+00006d20: 2074 656d 7020 6669 6c65 7320 696e 207b   temp files in {
+00006d30: 746d 705f 6469 727d 2229 0a0a 2020 2020  tmp_dir}")..    
+00006d40: 7472 793a 0a20 2020 2020 2020 2023 2043  try:.        # C
+00006d50: 616c 6375 6c61 7465 2074 6865 2062 6573  alculate the bes
+00006d60: 7420 6e75 6d62 6572 206f 6620 7061 7261  t number of para
+00006d70: 6c6c 656c 2070 726f 6365 7373 6573 2061  llel processes a
+00006d80: 6e64 2062 6174 6368 6573 2066 6f72 0a20  nd batches for. 
+00006d90: 2020 2020 2020 2023 2074 6865 2061 7661         # the ava
+00006da0: 696c 6162 6c65 2072 6573 6f75 7263 6573  ilable resources
+00006db0: 0a20 2020 2020 2020 2070 726f 6365 7373  .        process
+00006dc0: 696e 675f 7061 7261 6d73 203d 205f 7072  ing_params = _pr
+00006dd0: 6570 6172 655f 7072 6f63 6573 7369 6e67  epare_processing
+00006de0: 5f70 6172 616d 7328 0a20 2020 2020 2020  _params(.       
+00006df0: 2020 2020 2069 6e70 7574 5f70 6174 683d       input_path=
+00006e00: 696e 7075 745f 7061 7468 2c0a 2020 2020  input_path,.    
+00006e10: 2020 2020 2020 2020 696e 7075 745f 6c61          input_la
+00006e20: 7965 723d 696e 7075 745f 6c61 7965 722c  yer=input_layer,
+00006e30: 0a20 2020 2020 2020 2020 2020 206e 625f  .            nb_
+00006e40: 7061 7261 6c6c 656c 3d6e 625f 7061 7261  parallel=nb_para
+00006e50: 6c6c 656c 2c0a 2020 2020 2020 2020 2020  llel,.          
+00006e60: 2020 6261 7463 6873 697a 653d 6261 7463    batchsize=batc
+00006e70: 6873 697a 652c 0a20 2020 2020 2020 2020  hsize,.         
+00006e80: 2020 2070 6172 616c 6c65 6c69 7a61 7469     parallelizati
+00006e90: 6f6e 5f63 6f6e 6669 673d 7061 7261 6c6c  on_config=parall
+00006ea0: 656c 697a 6174 696f 6e5f 636f 6e66 6967  elization_config
+00006eb0: 2c0a 2020 2020 2020 2020 2020 2020 746d  ,.            tm
+00006ec0: 705f 6469 723d 746d 705f 6469 722c 0a20  p_dir=tmp_dir,. 
+00006ed0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00006ee0: 2061 7373 6572 7420 7072 6f63 6573 7369   assert processi
+00006ef0: 6e67 5f70 6172 616d 732e 6261 7463 6865  ng_params.batche
+00006f00: 7320 6973 206e 6f74 204e 6f6e 650a 0a20  s is not None.. 
+00006f10: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
+00006f20: 666f 280a 2020 2020 2020 2020 2020 2020  fo(.            
+00006f30: 6622 5374 6172 7420 7072 6f63 6573 7369  f"Start processi
+00006f40: 6e67 2028 7b70 726f 6365 7373 696e 675f  ng ({processing_
+00006f50: 7061 7261 6d73 2e6e 625f 7061 7261 6c6c  params.nb_parall
+00006f60: 656c 7d20 220a 2020 2020 2020 2020 2020  el} ".          
+00006f70: 2020 6622 7061 7261 6c6c 656c 2077 6f72    f"parallel wor
+00006f80: 6b65 7273 2c20 6261 7463 6820 7369 7a65  kers, batch size
+00006f90: 3a20 7b70 726f 6365 7373 696e 675f 7061  : {processing_pa
+00006fa0: 7261 6d73 2e62 6174 6368 7369 7a65 7d29  rams.batchsize})
+00006fb0: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
+00006fc0: 2020 2020 2320 5072 6f63 6573 7369 6e67      # Processing
+00006fd0: 2069 6e20 7468 7265 6164 7320 6973 2032   in threads is 2
+00006fe0: 7820 6661 7374 6572 2066 6f72 2073 6d61  x faster for sma
+00006ff0: 6c6c 2064 6174 6173 6574 7320 286f 6e20  ll datasets (on 
+00007000: 5769 6e64 6f77 7329 0a20 2020 2020 2020  Windows).       
+00007010: 2063 616c 6375 6c61 7465 5f69 6e5f 7468   calculate_in_th
+00007020: 7265 6164 7320 3d20 280a 2020 2020 2020  reads = (.      
+00007030: 2020 2020 2020 5472 7565 2069 6620 7072        True if pr
+00007040: 6f63 6573 7369 6e67 5f70 6172 616d 732e  ocessing_params.
+00007050: 6e62 5f72 6f77 735f 746f 5f70 726f 6365  nb_rows_to_proce
+00007060: 7373 203c 3d20 3130 3020 656c 7365 2046  ss <= 100 else F
+00007070: 616c 7365 0a20 2020 2020 2020 2029 0a20  alse.        ). 
+00007080: 2020 2020 2020 2077 6974 6820 5f70 726f         with _pro
+00007090: 6365 7373 696e 675f 7574 696c 2e50 6f6f  cessing_util.Poo
+000070a0: 6c65 6445 7865 6375 746f 7246 6163 746f  ledExecutorFacto
+000070b0: 7279 280a 2020 2020 2020 2020 2020 2020  ry(.            
+000070c0: 7468 7265 6164 706f 6f6c 3d63 616c 6375  threadpool=calcu
+000070d0: 6c61 7465 5f69 6e5f 7468 7265 6164 732c  late_in_threads,
+000070e0: 0a20 2020 2020 2020 2020 2020 206d 6178  .            max
+000070f0: 5f77 6f72 6b65 7273 3d70 726f 6365 7373  _workers=process
+00007100: 696e 675f 7061 7261 6d73 2e6e 625f 7061  ing_params.nb_pa
+00007110: 7261 6c6c 656c 2c0a 2020 2020 2020 2020  rallel,.        
+00007120: 2020 2020 696e 6974 6961 6c69 7a65 723d      initializer=
+00007130: 5f70 726f 6365 7373 696e 675f 7574 696c  _processing_util
+00007140: 2e69 6e69 7469 616c 697a 655f 776f 726b  .initialize_work
+00007150: 6572 2829 2c0a 2020 2020 2020 2020 2920  er(),.        ) 
+00007160: 6173 2063 616c 6375 6c61 7465 5f70 6f6f  as calculate_poo
+00007170: 6c3a 0a20 2020 2020 2020 2020 2020 2023  l:.            #
+00007180: 2050 7265 7061 7265 206f 7574 7075 7420   Prepare output 
+00007190: 6669 6c65 6e61 6d65 0a20 2020 2020 2020  filename.       
+000071a0: 2020 2020 2074 6d70 5f6f 7574 7075 745f       tmp_output_
+000071b0: 7061 7468 203d 2074 6d70 5f64 6972 202f  path = tmp_dir /
+000071c0: 206f 7574 7075 745f 7061 7468 2e6e 616d   output_path.nam
+000071d0: 650a 0a20 2020 2020 2020 2020 2020 2062  e..            b
+000071e0: 6174 6368 6573 3a20 6469 6374 5b69 6e74  atches: dict[int
+000071f0: 2c20 6469 6374 5d20 3d20 7b7d 0a20 2020  , dict] = {}.   
+00007200: 2020 2020 2020 2020 2066 7574 7572 655f           future_
+00007210: 746f 5f62 6174 6368 5f69 6420 3d20 7b7d  to_batch_id = {}
+00007220: 0a0a 2020 2020 2020 2020 2020 2020 666f  ..            fo
+00007230: 7220 6261 7463 685f 6964 2c20 6261 7463  r batch_id, batc
+00007240: 685f 6669 6c74 6572 2069 6e20 656e 756d  h_filter in enum
+00007250: 6572 6174 6528 7072 6f63 6573 7369 6e67  erate(processing
+00007260: 5f70 6172 616d 732e 6261 7463 6865 7329  _params.batches)
+00007270: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00007280: 2020 6261 7463 6865 735b 6261 7463 685f    batches[batch_
+00007290: 6964 5d20 3d20 7b7d 0a20 2020 2020 2020  id] = {}.       
+000072a0: 2020 2020 2020 2020 2062 6174 6368 6573           batches
+000072b0: 5b62 6174 6368 5f69 645d 5b22 6c61 7965  [batch_id]["laye
+000072c0: 7222 5d20 3d20 6f75 7470 7574 5f6c 6179  r"] = output_lay
+000072d0: 6572 0a0a 2020 2020 2020 2020 2020 2020  er..            
+000072e0: 2020 2020 2320 4f75 7470 7574 2065 6163      # Output eac
+000072f0: 6820 6261 7463 6820 746f 2061 2073 6570  h batch to a sep
+00007300: 6572 6174 6520 7465 6d70 6f72 6172 7920  erate temporary 
+00007310: 6669 6c65 2c20 6f74 6865 7277 6973 6520  file, otherwise 
+00007320: 7468 6572 650a 2020 2020 2020 2020 2020  there.          
+00007330: 2020 2020 2020 2320 6172 6520 7469 6d65        # are time
+00007340: 6f75 7420 6973 7375 6573 2077 6865 6e20  out issues when 
+00007350: 7072 6f63 6573 7369 6e67 206c 6172 6765  processing large
+00007360: 2066 696c 6573 0a20 2020 2020 2020 2020   files.         
+00007370: 2020 2020 2020 206f 7574 7075 745f 746d         output_tm
+00007380: 705f 7061 7274 6961 6c5f 7061 7468 203d  p_partial_path =
+00007390: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+000073a0: 2020 2020 2020 2074 6d70 5f64 6972 202f         tmp_dir /
+000073b0: 2066 227b 6f75 7470 7574 5f70 6174 682e   f"{output_path.
+000073c0: 7374 656d 7d5f 7b62 6174 6368 5f69 647d  stem}_{batch_id}
+000073d0: 2e67 706b 6722 0a20 2020 2020 2020 2020  .gpkg".         
+000073e0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+000073f0: 2020 2020 2020 2020 2062 6174 6368 6573           batches
+00007400: 5b62 6174 6368 5f69 645d 5b22 746d 705f  [batch_id]["tmp_
+00007410: 7061 7274 6961 6c5f 6f75 7470 7574 5f70  partial_output_p
+00007420: 6174 6822 5d20 3d20 6f75 7470 7574 5f74  ath"] = output_t
+00007430: 6d70 5f70 6172 7469 616c 5f70 6174 680a  mp_partial_path.
+00007440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007450: 6261 7463 6865 735b 6261 7463 685f 6964  batches[batch_id
+00007460: 5d5b 2266 696c 7465 7222 5d20 3d20 6261  ]["filter"] = ba
+00007470: 7463 685f 6669 6c74 6572 0a0a 2020 2020  tch_filter..    
+00007480: 2020 2020 2020 2020 2020 2020 2320 5265              # Re
+00007490: 6d61 726b 3a20 7468 6973 2074 656d 7020  mark: this temp 
+000074a0: 6669 6c65 2064 6f65 736e 2774 206e 6565  file doesn't nee
+000074b0: 6420 7370 6174 6961 6c20 696e 6465 780a  d spatial index.
+000074c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000074d0: 2320 5265 6d61 726b 3a20 6265 6361 7573  # Remark: becaus
+000074e0: 6520 666f 7263 655f 6f75 7470 7574 5f67  e force_output_g
+000074f0: 656f 6d65 7472 7974 7970 6520 666f 7220  eometrytype for 
+00007500: 4765 6f44 6174 6146 7261 6d65 0a20 2020  GeoDataFrame.   
+00007510: 2020 2020 2020 2020 2020 2020 2023 206f               # o
+00007520: 7065 7261 7469 6f6e 7320 6973 2028 6120  perations is (a 
+00007530: 6c6f 7429 206d 6f72 6520 6c69 6d69 7465  lot) more limite
+00007540: 6420 7468 616e 2067 6461 6c2d 6261 7365  d than gdal-base
+00007550: 642c 2074 6865 2067 6461 6c20 7665 7273  d, the gdal vers
+00007560: 696f 6e0a 2020 2020 2020 2020 2020 2020  ion.            
+00007570: 2020 2020 2320 6973 2075 7365 6420 6c61      # is used la
+00007580: 7465 7220 6f6e 2077 6865 6e20 7468 6520  ter on when the 
+00007590: 7265 7375 6c74 7320 6172 6520 6d65 7267  results are merg
+000075a0: 6564 2074 6f20 7468 6520 7265 7375 6c74  ed to the result
+000075b0: 2066 696c 652e 0a20 2020 2020 2020 2020   file..         
+000075c0: 2020 2020 2020 2066 7574 7572 6520 3d20         future = 
+000075d0: 6361 6c63 756c 6174 655f 706f 6f6c 2e73  calculate_pool.s
+000075e0: 7562 6d69 7428 0a20 2020 2020 2020 2020  ubmit(.         
+000075f0: 2020 2020 2020 2020 2020 205f 6170 706c             _appl
+00007600: 795f 6765 6f6f 7065 7261 7469 6f6e 2c0a  y_geooperation,.
+00007610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007620: 2020 2020 696e 7075 745f 7061 7468 3d69      input_path=i
+00007630: 6e70 7574 5f70 6174 682c 0a20 2020 2020  nput_path,.     
+00007640: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+00007650: 7574 7075 745f 7061 7468 3d6f 7574 7075  utput_path=outpu
+00007660: 745f 746d 705f 7061 7274 6961 6c5f 7061  t_tmp_partial_pa
+00007670: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
+00007680: 2020 2020 2020 2020 6f70 6572 6174 696f          operatio
+00007690: 6e3d 6f70 6572 6174 696f 6e2c 0a20 2020  n=operation,.   
+000076a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000076b0: 206f 7065 7261 7469 6f6e 5f70 6172 616d   operation_param
+000076c0: 733d 6f70 6572 6174 696f 6e5f 7061 7261  s=operation_para
+000076d0: 6d73 2c0a 2020 2020 2020 2020 2020 2020  ms,.            
+000076e0: 2020 2020 2020 2020 696e 7075 745f 6c61          input_la
+000076f0: 7965 723d 696e 7075 745f 6c61 7965 722c  yer=input_layer,
+00007700: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007710: 2020 2020 2063 6f6c 756d 6e73 3d63 6f6c       columns=col
+00007720: 756d 6e73 2c0a 2020 2020 2020 2020 2020  umns,.          
+00007730: 2020 2020 2020 2020 2020 6f75 7470 7574            output
+00007740: 5f6c 6179 6572 3d6f 7574 7075 745f 6c61  _layer=output_la
+00007750: 7965 722c 0a20 2020 2020 2020 2020 2020  yer,.           
+00007760: 2020 2020 2020 2020 2077 6865 7265 3d62           where=b
+00007770: 6174 6368 5f66 696c 7465 722c 0a20 2020  atch_filter,.   
+00007780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007790: 2065 7870 6c6f 6465 636f 6c6c 6563 7469   explodecollecti
+000077a0: 6f6e 733d 6578 706c 6f64 6563 6f6c 6c65  ons=explodecolle
+000077b0: 6374 696f 6e73 2c0a 2020 2020 2020 2020  ctions,.        
+000077c0: 2020 2020 2020 2020 2020 2020 6772 6964              grid
+000077d0: 7369 7a65 3d67 7269 6473 697a 652c 0a20  size=gridsize,. 
+000077e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000077f0: 2020 206b 6565 705f 656d 7074 795f 6765     keep_empty_ge
+00007800: 6f6d 733d 6b65 6570 5f65 6d70 7479 5f67  oms=keep_empty_g
+00007810: 656f 6d73 2c0a 2020 2020 2020 2020 2020  eoms,.          
+00007820: 2020 2020 2020 2020 2020 7072 6573 6572            preser
+00007830: 7665 5f66 6964 3d70 7265 7365 7276 655f  ve_fid=preserve_
+00007840: 6669 642c 0a20 2020 2020 2020 2020 2020  fid,.           
+00007850: 2020 2020 2020 2020 2066 6f72 6365 3d66           force=f
+00007860: 6f72 6365 2c0a 2020 2020 2020 2020 2020  orce,.          
+00007870: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00007880: 2020 2020 2020 2020 6675 7475 7265 5f74          future_t
+00007890: 6f5f 6261 7463 685f 6964 5b66 7574 7572  o_batch_id[futur
+000078a0: 655d 203d 2062 6174 6368 5f69 640a 0a20  e] = batch_id.. 
+000078b0: 2020 2020 2020 2020 2020 2023 204c 6f6f             # Loo
+000078c0: 7020 7469 6c6c 2061 6c6c 2070 6172 616c  p till all paral
+000078d0: 6c65 6c20 7072 6f63 6573 7365 7320 6172  lel processes ar
+000078e0: 6520 7265 6164 792c 2062 7574 2070 726f  e ready, but pro
+000078f0: 6365 7373 2065 6163 6820 6f6e 650a 2020  cess each one.  
+00007900: 2020 2020 2020 2020 2020 2320 7468 6174            # that
+00007910: 2069 7320 7265 6164 7920 616c 7265 6164   is ready alread
+00007920: 790a 2020 2020 2020 2020 2020 2020 2320  y.            # 
+00007930: 5265 6d61 726b 3a20 6361 6c63 756c 6174  Remark: calculat
+00007940: 696e 6720 6361 6e20 6265 2064 6f6e 6520  ing can be done 
+00007950: 696e 2070 6172 616c 6c65 6c2c 2062 7574  in parallel, but
+00007960: 206f 6e6c 7920 6f6e 6520 7072 6f63 6573   only one proces
+00007970: 730a 2020 2020 2020 2020 2020 2020 2320  s.            # 
+00007980: 6361 6e20 7772 6974 6520 746f 2074 6865  can write to the
+00007990: 2073 616d 6520 6f75 7470 7574 2066 696c   same output fil
+000079a0: 6520 6174 2074 6865 2074 696d 652e 2e2e  e at the time...
+000079b0: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
+000079c0: 7274 5f74 696d 6520 3d20 6461 7465 7469  rt_time = dateti
+000079d0: 6d65 2e6e 6f77 2829 0a20 2020 2020 2020  me.now().       
+000079e0: 2020 2020 206e 625f 646f 6e65 203d 2030       nb_done = 0
+000079f0: 0a20 2020 2020 2020 2020 2020 206e 625f  .            nb_
+00007a00: 6261 7463 6865 7320 3d20 6c65 6e28 7072  batches = len(pr
+00007a10: 6f63 6573 7369 6e67 5f70 6172 616d 732e  ocessing_params.
+00007a20: 6261 7463 6865 7329 0a20 2020 2020 2020  batches).       
+00007a30: 2020 2020 205f 6765 6e65 7261 6c5f 7574       _general_ut
+00007a40: 696c 2e72 6570 6f72 745f 7072 6f67 7265  il.report_progre
+00007a50: 7373 280a 2020 2020 2020 2020 2020 2020  ss(.            
+00007a60: 2020 2020 7374 6172 745f 7469 6d65 2c0a      start_time,.
+00007a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007a80: 6e62 5f64 6f6e 652c 0a20 2020 2020 2020  nb_done,.       
+00007a90: 2020 2020 2020 2020 206e 625f 746f 646f           nb_todo
+00007aa0: 3d6e 625f 6261 7463 6865 732c 0a20 2020  =nb_batches,.   
+00007ab0: 2020 2020 2020 2020 2020 2020 206f 7065               ope
+00007ac0: 7261 7469 6f6e 3d6f 7065 7261 7469 6f6e  ration=operation
+00007ad0: 2e76 616c 7565 2c0a 2020 2020 2020 2020  .value,.        
+00007ae0: 2020 2020 2020 2020 6e62 5f70 6172 616c          nb_paral
+00007af0: 6c65 6c3d 7072 6f63 6573 7369 6e67 5f70  lel=processing_p
+00007b00: 6172 616d 732e 6e62 5f70 6172 616c 6c65  arams.nb_paralle
+00007b10: 6c2c 0a20 2020 2020 2020 2020 2020 2029  l,.            )
+00007b20: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+00007b30: 2066 7574 7572 6520 696e 2066 7574 7572   future in futur
+00007b40: 6573 2e61 735f 636f 6d70 6c65 7465 6428  es.as_completed(
+00007b50: 6675 7475 7265 5f74 6f5f 6261 7463 685f  future_to_batch_
+00007b60: 6964 293a 0a20 2020 2020 2020 2020 2020  id):.           
+00007b70: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00007b80: 2020 2020 2020 2020 2020 2020 2020 6d65                me
+00007b90: 7373 6167 6520 3d20 6675 7475 7265 2e72  ssage = future.r
+00007ba0: 6573 756c 7428 290a 2020 2020 2020 2020  esult().        
+00007bb0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+00007bc0: 6572 2e64 6562 7567 286d 6573 7361 6765  er.debug(message
+00007bd0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+00007be0: 2020 2020 2020 2023 2049 6620 7468 6520         # If the 
+00007bf0: 6361 6c63 756c 6174 6520 6761 7665 2072  calculate gave r
+00007c00: 6573 756c 7473 2c20 636f 7079 2074 6f20  esults, copy to 
+00007c10: 6f75 7470 7574 0a20 2020 2020 2020 2020  output.         
+00007c20: 2020 2020 2020 2020 2020 2062 6174 6368             batch
+00007c30: 5f69 6420 3d20 6675 7475 7265 5f74 6f5f  _id = future_to_
+00007c40: 6261 7463 685f 6964 5b66 7574 7572 655d  batch_id[future]
+00007c50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007c60: 2020 2020 2074 6d70 5f70 6172 7469 616c       tmp_partial
+00007c70: 5f6f 7574 7075 745f 7061 7468 203d 2062  _output_path = b
+00007c80: 6174 6368 6573 5b62 6174 6368 5f69 645d  atches[batch_id]
+00007c90: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+00007ca0: 2020 2020 2020 2020 2020 2274 6d70 5f70            "tmp_p
+00007cb0: 6172 7469 616c 5f6f 7574 7075 745f 7061  artial_output_pa
+00007cc0: 7468 220a 2020 2020 2020 2020 2020 2020  th".            
+00007cd0: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
+00007ce0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00007cf0: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+00007d00: 2020 2020 2020 2020 2020 2074 6d70 5f70             tmp_p
+00007d10: 6172 7469 616c 5f6f 7574 7075 745f 7061  artial_output_pa
+00007d20: 7468 2e65 7869 7374 7328 290a 2020 2020  th.exists().    
+00007d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007d40: 2020 2020 616e 6420 746d 705f 7061 7274      and tmp_part
+00007d50: 6961 6c5f 6f75 7470 7574 5f70 6174 682e  ial_output_path.
+00007d60: 7374 6174 2829 2e73 745f 7369 7a65 203e  stat().st_size >
+00007d70: 2030 0a20 2020 2020 2020 2020 2020 2020   0.             
+00007d80: 2020 2020 2020 2029 3a0a 2020 2020 2020         ):.      
+00007d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007da0: 2020 2320 5265 6d61 726b 3a20 6265 6361    # Remark: beca
+00007db0: 7573 6520 666f 7263 655f 6f75 7470 7574  use force_output
+00007dc0: 5f67 656f 6d65 7472 7974 7970 6520 666f  _geometrytype fo
+00007dd0: 7220 4765 6f44 6174 6146 7261 6d65 0a20  r GeoDataFrame. 
 00007de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007df0: 2020 2023 2052 656d 6172 6b3a 2062 6563     # Remark: bec
-00007e00: 6175 7365 2066 6f72 6365 5f6f 7574 7075  ause force_outpu
-00007e10: 745f 6765 6f6d 6574 7279 7479 7065 2066  t_geometrytype f
-00007e20: 6f72 2047 656f 4461 7461 4672 616d 650a  or GeoDataFrame.
-00007e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007e40: 2020 2020 2020 2020 2320 6f70 6572 6174          # operat
-00007e50: 696f 6e73 2069 7320 2861 206c 6f74 2920  ions is (a lot) 
-00007e60: 6d6f 7265 206c 696d 6974 6564 2074 6861  more limited tha
-00007e70: 6e20 6764 616c 2d62 6173 6564 2c20 7573  n gdal-based, us
-00007e80: 6520 7468 650a 2020 2020 2020 2020 2020  e the.          
-00007e90: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00007ea0: 6764 616c 2076 6572 7369 6f6e 2076 6961  gdal version via
-00007eb0: 205f 6170 7065 6e64 5f74 6f5f 6e6f 6c6f   _append_to_nolo
-00007ec0: 636b 2e0a 2020 2020 2020 2020 2020 2020  ck..            
-00007ed0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-00007ee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007ef0: 2020 2020 2020 2020 2020 2020 206e 625f               nb_
-00007f00: 6261 7463 6865 7320 3d3d 2031 0a20 2020  batches == 1.   
-00007f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007f20: 2020 2020 2020 2020 2061 6e64 2066 6f72           and for
-00007f30: 6365 5f6f 7574 7075 745f 6765 6f6d 6574  ce_output_geomet
-00007f40: 7279 7479 7065 2069 7320 4e6f 6e65 0a20  rytype is None. 
-00007f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007f60: 2020 2020 2020 2020 2020 2061 6e64 2074             and t
-00007f70: 6d70 5f70 6172 7469 616c 5f6f 7574 7075  mp_partial_outpu
-00007f80: 745f 7061 7468 2e73 7566 6669 7820 3d3d  t_path.suffix ==
-00007f90: 2074 6d70 5f6f 7574 7075 745f 7061 7468   tmp_output_path
-00007fa0: 2e73 7566 6669 780a 2020 2020 2020 2020  .suffix.        
+00007df0: 2020 2020 2020 2023 206f 7065 7261 7469         # operati
+00007e00: 6f6e 7320 6973 2028 6120 6c6f 7429 206d  ons is (a lot) m
+00007e10: 6f72 6520 6c69 6d69 7465 6420 7468 616e  ore limited than
+00007e20: 2067 6461 6c2d 6261 7365 642c 2075 7365   gdal-based, use
+00007e30: 2074 6865 0a20 2020 2020 2020 2020 2020   the.           
+00007e40: 2020 2020 2020 2020 2020 2020 2023 2067               # g
+00007e50: 6461 6c20 7665 7273 696f 6e20 7669 6120  dal version via 
+00007e60: 5f61 7070 656e 645f 746f 5f6e 6f6c 6f63  _append_to_noloc
+00007e70: 6b2e 0a20 2020 2020 2020 2020 2020 2020  k..             
+00007e80: 2020 2020 2020 2020 2020 2069 6620 280a             if (.
+00007e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007ea0: 2020 2020 2020 2020 2020 2020 6e62 5f62              nb_b
+00007eb0: 6174 6368 6573 203d 3d20 310a 2020 2020  atches == 1.    
+00007ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007ed0: 2020 2020 2020 2020 616e 6420 666f 7263          and forc
+00007ee0: 655f 6f75 7470 7574 5f67 656f 6d65 7472  e_output_geometr
+00007ef0: 7974 7970 6520 6973 204e 6f6e 650a 2020  ytype is None.  
+00007f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007f10: 2020 2020 2020 2020 2020 616e 6420 746d            and tm
+00007f20: 705f 7061 7274 6961 6c5f 6f75 7470 7574  p_partial_output
+00007f30: 5f70 6174 682e 7375 6666 6978 203d 3d20  _path.suffix == 
+00007f40: 746d 705f 6f75 7470 7574 5f70 6174 682e  tmp_output_path.
+00007f50: 7375 6666 6978 0a20 2020 2020 2020 2020  suffix.         
+00007f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007f70: 2020 2061 6e64 2077 6865 7265 5f70 6f73     and where_pos
+00007f80: 7420 6973 204e 6f6e 650a 2020 2020 2020  t is None.      
+00007f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007fa0: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
 00007fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007fc0: 2020 2020 616e 6420 7768 6572 655f 706f      and where_po
-00007fd0: 7374 2069 7320 4e6f 6e65 0a20 2020 2020  st is None.     
-00007fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007ff0: 2020 2029 3a0a 2020 2020 2020 2020 2020     ):.          
-00008000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008010: 2020 6766 6f2e 6d6f 7665 2874 6d70 5f70    gfo.move(tmp_p
-00008020: 6172 7469 616c 5f6f 7574 7075 745f 7061  artial_output_pa
-00008030: 7468 2c20 746d 705f 6f75 7470 7574 5f70  th, tmp_output_p
-00008040: 6174 6829 0a20 2020 2020 2020 2020 2020  ath).           
-00008050: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-00008060: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00008070: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00008080: 696c 656f 7073 2e5f 6170 7065 6e64 5f74  ileops._append_t
-00008090: 6f5f 6e6f 6c6f 636b 280a 2020 2020 2020  o_nolock(.      
-000080a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000080b0: 2020 2020 2020 2020 2020 7372 633d 746d            src=tm
-000080c0: 705f 7061 7274 6961 6c5f 6f75 7470 7574  p_partial_output
-000080d0: 5f70 6174 682c 0a20 2020 2020 2020 2020  _path,.         
-000080e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000080f0: 2020 2020 2020 2064 7374 3d74 6d70 5f6f         dst=tmp_o
-00008100: 7574 7075 745f 7061 7468 2c0a 2020 2020  utput_path,.    
+00007fc0: 2067 666f 2e6d 6f76 6528 746d 705f 7061   gfo.move(tmp_pa
+00007fd0: 7274 6961 6c5f 6f75 7470 7574 5f70 6174  rtial_output_pat
+00007fe0: 682c 2074 6d70 5f6f 7574 7075 745f 7061  h, tmp_output_pa
+00007ff0: 7468 290a 2020 2020 2020 2020 2020 2020  th).            
+00008000: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00008010: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00008020: 2020 2020 2020 2020 2020 2020 2020 6669                fi
+00008030: 6c65 6f70 732e 5f61 7070 656e 645f 746f  leops._append_to
+00008040: 5f6e 6f6c 6f63 6b28 0a20 2020 2020 2020  _nolock(.       
+00008050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008060: 2020 2020 2020 2020 2073 7263 3d74 6d70           src=tmp
+00008070: 5f70 6172 7469 616c 5f6f 7574 7075 745f  _partial_output_
+00008080: 7061 7468 2c0a 2020 2020 2020 2020 2020  path,.          
+00008090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000080a0: 2020 2020 2020 6473 743d 746d 705f 6f75        dst=tmp_ou
+000080b0: 7470 7574 5f70 6174 682c 0a20 2020 2020  tput_path,.     
+000080c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000080d0: 2020 2020 2020 2020 2020 2065 7870 6c6f             explo
+000080e0: 6465 636f 6c6c 6563 7469 6f6e 733d 6578  decollections=ex
+000080f0: 706c 6f64 6563 6f6c 6c65 6374 696f 6e73  plodecollections
+00008100: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 00008110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008120: 2020 2020 2020 2020 2020 2020 6578 706c              expl
-00008130: 6f64 6563 6f6c 6c65 6374 696f 6e73 3d65  odecollections=e
-00008140: 7870 6c6f 6465 636f 6c6c 6563 7469 6f6e  xplodecollection
-00008150: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-00008160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008170: 2020 2063 7265 6174 655f 7370 6174 6961     create_spatia
-00008180: 6c5f 696e 6465 783d 4661 6c73 652c 0a20  l_index=False,. 
-00008190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000081a0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000081b0: 6f72 6365 5f6f 7574 7075 745f 6765 6f6d  orce_output_geom
-000081c0: 6574 7279 7479 7065 3d66 6f72 6365 5f6f  etrytype=force_o
-000081d0: 7574 7075 745f 6765 6f6d 6574 7279 7479  utput_geometryty
-000081e0: 7065 2c0a 2020 2020 2020 2020 2020 2020  pe,.            
-000081f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008200: 2020 2020 7768 6572 653d 7768 6572 655f      where=where_
-00008210: 706f 7374 2c0a 2020 2020 2020 2020 2020  post,.          
+00008120: 2020 6372 6561 7465 5f73 7061 7469 616c    create_spatial
+00008130: 5f69 6e64 6578 3d46 616c 7365 2c0a 2020  _index=False,.  
+00008140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008150: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00008160: 7263 655f 6f75 7470 7574 5f67 656f 6d65  rce_output_geome
+00008170: 7472 7974 7970 653d 666f 7263 655f 6f75  trytype=force_ou
+00008180: 7470 7574 5f67 656f 6d65 7472 7974 7970  tput_geometrytyp
+00008190: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+000081a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000081b0: 2020 2077 6865 7265 3d77 6865 7265 5f70     where=where_p
+000081c0: 6f73 742c 0a20 2020 2020 2020 2020 2020  ost,.           
+000081d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000081e0: 2020 2020 2070 7265 7365 7276 655f 6669       preserve_fi
+000081f0: 643d 7072 6573 6572 7665 5f66 6964 2c0a  d=preserve_fid,.
+00008200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008210: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
 00008220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008230: 2020 2020 2020 7072 6573 6572 7665 5f66        preserve_f
-00008240: 6964 3d70 7265 7365 7276 655f 6669 642c  id=preserve_fid,
-00008250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008260: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-00008270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008280: 2020 2020 2020 2020 2020 2067 666f 2e72             gfo.r
-00008290: 656d 6f76 6528 746d 705f 7061 7274 6961  emove(tmp_partia
-000082a0: 6c5f 6f75 7470 7574 5f70 6174 6829 0a0a  l_output_path)..
-000082b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000082c0: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-000082d0: 2061 7320 6578 3a0a 2020 2020 2020 2020   as ex:.        
-000082e0: 2020 2020 2020 2020 2020 2020 6261 7463              batc
-000082f0: 685f 6964 203d 2066 7574 7572 655f 746f  h_id = future_to
-00008300: 5f62 6174 6368 5f69 645b 6675 7475 7265  _batch_id[future
-00008310: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00008320: 2020 2020 2020 6d65 7373 6167 6520 3d20        message = 
-00008330: 6622 4572 726f 7220 7b65 787d 2065 7865  f"Error {ex} exe
-00008340: 6375 7469 6e67 207b 6261 7463 6865 735b  cuting {batches[
-00008350: 6261 7463 685f 6964 5d7d 220a 2020 2020  batch_id]}".    
-00008360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008370: 6c6f 6767 6572 2e65 7863 6570 7469 6f6e  logger.exception
-00008380: 286d 6573 7361 6765 290a 2020 2020 2020  (message).      
-00008390: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-000083a0: 6973 6520 5275 6e74 696d 6545 7272 6f72  ise RuntimeError
-000083b0: 286d 6573 7361 6765 2920 6672 6f6d 2065  (message) from e
-000083c0: 780a 0a20 2020 2020 2020 2020 2020 2020  x..             
-000083d0: 2020 2023 204c 6f67 2074 6865 2070 726f     # Log the pro
-000083e0: 6772 6573 7320 616e 6420 7072 6564 6963  gress and predic
-000083f0: 7469 6f6e 2073 7065 6564 0a20 2020 2020  tion speed.     
-00008400: 2020 2020 2020 2020 2020 206e 625f 646f             nb_do
-00008410: 6e65 202b 3d20 310a 2020 2020 2020 2020  ne += 1.        
-00008420: 2020 2020 2020 2020 5f67 656e 6572 616c          _general
-00008430: 5f75 7469 6c2e 7265 706f 7274 5f70 726f  _util.report_pro
-00008440: 6772 6573 7328 0a20 2020 2020 2020 2020  gress(.         
-00008450: 2020 2020 2020 2020 2020 2073 7461 7274             start
-00008460: 5f74 696d 652c 0a20 2020 2020 2020 2020  _time,.         
-00008470: 2020 2020 2020 2020 2020 206e 625f 646f             nb_do
-00008480: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
-00008490: 2020 2020 2020 2020 6e62 5f74 6f64 6f3d          nb_todo=
-000084a0: 6e62 5f62 6174 6368 6573 2c0a 2020 2020  nb_batches,.    
-000084b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000084c0: 6f70 6572 6174 696f 6e3d 6f70 6572 6174  operation=operat
-000084d0: 696f 6e2e 7661 6c75 652c 0a20 2020 2020  ion.value,.     
-000084e0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-000084f0: 625f 7061 7261 6c6c 656c 3d70 726f 6365  b_parallel=proce
-00008500: 7373 696e 675f 7061 7261 6d73 2e6e 625f  ssing_params.nb_
-00008510: 7061 7261 6c6c 656c 2c0a 2020 2020 2020  parallel,.      
-00008520: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-00008530: 2020 2020 2023 2052 6f75 6e64 2075 7020       # Round up 
-00008540: 616e 6420 636c 6561 6e20 7570 0a20 2020  and clean up.   
-00008550: 2020 2020 2023 204e 6f77 2063 7265 6174       # Now creat
-00008560: 6520 7370 6174 6961 6c20 696e 6465 7820  e spatial index 
-00008570: 616e 6420 6d6f 7665 2074 6f20 6f75 7470  and move to outp
-00008580: 7574 206c 6f63 6174 696f 6e0a 2020 2020  ut location.    
-00008590: 2020 2020 6966 2074 6d70 5f6f 7574 7075      if tmp_outpu
-000085a0: 745f 7061 7468 2e65 7869 7374 7328 293a  t_path.exists():
-000085b0: 0a20 2020 2020 2020 2020 2020 2067 666f  .            gfo
-000085c0: 2e63 7265 6174 655f 7370 6174 6961 6c5f  .create_spatial_
-000085d0: 696e 6465 7828 7061 7468 3d74 6d70 5f6f  index(path=tmp_o
-000085e0: 7574 7075 745f 7061 7468 2c20 6c61 7965  utput_path, laye
-000085f0: 723d 6f75 7470 7574 5f6c 6179 6572 290a  r=output_layer).
-00008600: 2020 2020 2020 2020 2020 2020 6766 6f2e              gfo.
-00008610: 6d6f 7665 2874 6d70 5f6f 7574 7075 745f  move(tmp_output_
-00008620: 7061 7468 2c20 6f75 7470 7574 5f70 6174  path, output_pat
-00008630: 6829 0a20 2020 2020 2020 2065 6c73 653a  h).        else:
-00008640: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
-00008650: 6765 722e 6465 6275 6728 2252 6573 756c  ger.debug("Resul
-00008660: 7420 7761 7320 656d 7074 7922 290a 0a20  t was empty").. 
-00008670: 2020 2066 696e 616c 6c79 3a0a 2020 2020     finally:.    
-00008680: 2020 2020 7368 7574 696c 2e72 6d74 7265      shutil.rmtre
-00008690: 6528 746d 705f 6469 722c 2069 676e 6f72  e(tmp_dir, ignor
-000086a0: 655f 6572 726f 7273 3d54 7275 6529 0a0a  e_errors=True)..
-000086b0: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
-000086c0: 6622 5265 6164 792c 2074 6f6f 6b20 7b64  f"Ready, took {d
-000086d0: 6174 6574 696d 652e 6e6f 7728 292d 7374  atetime.now()-st
-000086e0: 6172 745f 7469 6d65 5f67 6c6f 6261 6c7d  art_time_global}
-000086f0: 2229 0a0a 0a64 6566 205f 6170 706c 795f  ")...def _apply_
-00008700: 6765 6f6f 7065 7261 7469 6f6e 280a 2020  geooperation(.  
-00008710: 2020 696e 7075 745f 7061 7468 3a20 5061    input_path: Pa
-00008720: 7468 2c0a 2020 2020 6f75 7470 7574 5f70  th,.    output_p
-00008730: 6174 683a 2050 6174 682c 0a20 2020 206f  ath: Path,.    o
-00008740: 7065 7261 7469 6f6e 3a20 4765 6f4f 7065  peration: GeoOpe
-00008750: 7261 7469 6f6e 2c0a 2020 2020 6f70 6572  ration,.    oper
-00008760: 6174 696f 6e5f 7061 7261 6d73 3a20 6469  ation_params: di
-00008770: 6374 2c0a 2020 2020 696e 7075 745f 6c61  ct,.    input_la
-00008780: 7965 723a 204f 7074 696f 6e61 6c5b 7374  yer: Optional[st
-00008790: 725d 203d 204e 6f6e 652c 0a20 2020 206f  r] = None,.    o
-000087a0: 7574 7075 745f 6c61 7965 723a 204f 7074  utput_layer: Opt
-000087b0: 696f 6e61 6c5b 7374 725d 203d 204e 6f6e  ional[str] = Non
-000087c0: 652c 0a20 2020 2063 6f6c 756d 6e73 3a20  e,.    columns: 
-000087d0: 4f70 7469 6f6e 616c 5b4c 6973 745b 7374  Optional[List[st
-000087e0: 725d 5d20 3d20 4e6f 6e65 2c0a 2020 2020  r]] = None,.    
-000087f0: 7768 6572 653d 4e6f 6e65 2c0a 2020 2020  where=None,.    
-00008800: 6578 706c 6f64 6563 6f6c 6c65 6374 696f  explodecollectio
-00008810: 6e73 3a20 626f 6f6c 203d 2046 616c 7365  ns: bool = False
-00008820: 2c0a 2020 2020 6772 6964 7369 7a65 3a20  ,.    gridsize: 
-00008830: 666c 6f61 7420 3d20 302e 302c 0a20 2020  float = 0.0,.   
-00008840: 206b 6565 705f 656d 7074 795f 6765 6f6d   keep_empty_geom
-00008850: 733a 2062 6f6f 6c20 3d20 5472 7565 2c0a  s: bool = True,.
-00008860: 2020 2020 7072 6573 6572 7665 5f66 6964      preserve_fid
-00008870: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
-00008880: 2020 2020 666f 7263 653a 2062 6f6f 6c20      force: bool 
-00008890: 3d20 4661 6c73 652c 0a29 202d 3e20 7374  = False,.) -> st
-000088a0: 723a 0a20 2020 2023 2049 6e69 740a 2020  r:.    # Init.  
-000088b0: 2020 6966 206f 7574 7075 745f 7061 7468    if output_path
-000088c0: 2e65 7869 7374 7328 293a 0a20 2020 2020  .exists():.     
-000088d0: 2020 2069 6620 666f 7263 6520 6973 2046     if force is F
-000088e0: 616c 7365 3a0a 2020 2020 2020 2020 2020  alse:.          
-000088f0: 2020 6d65 7373 6167 6520 3d20 6622 5374    message = f"St
-00008900: 6f70 2c20 6f75 7470 7574 2065 7869 7374  op, output exist
-00008910: 7320 616c 7265 6164 7920 7b6f 7574 7075  s already {outpu
-00008920: 745f 7061 7468 7d22 0a20 2020 2020 2020  t_path}".       
-00008930: 2020 2020 2072 6574 7572 6e20 6d65 7373       return mess
-00008940: 6167 650a 2020 2020 2020 2020 656c 7365  age.        else
-00008950: 3a0a 2020 2020 2020 2020 2020 2020 6766  :.            gf
-00008960: 6f2e 7265 6d6f 7665 286f 7574 7075 745f  o.remove(output_
-00008970: 7061 7468 290a 0a20 2020 2023 204e 6f77  path)..    # Now
-00008980: 2067 6f21 0a20 2020 2073 7461 7274 5f74   go!.    start_t
-00008990: 696d 6520 3d20 6461 7465 7469 6d65 2e6e  ime = datetime.n
-000089a0: 6f77 2829 0a20 2020 2064 6174 615f 6764  ow().    data_gd
-000089b0: 6620 3d20 6766 6f2e 7265 6164 5f66 696c  f = gfo.read_fil
-000089c0: 6528 0a20 2020 2020 2020 2070 6174 683d  e(.        path=
-000089d0: 696e 7075 745f 7061 7468 2c0a 2020 2020  input_path,.    
-000089e0: 2020 2020 6c61 7965 723d 696e 7075 745f      layer=input_
-000089f0: 6c61 7965 722c 0a20 2020 2020 2020 2063  layer,.        c
-00008a00: 6f6c 756d 6e73 3d63 6f6c 756d 6e73 2c0a  olumns=columns,.
-00008a10: 2020 2020 2020 2020 7768 6572 653d 7768          where=wh
-00008a20: 6572 652c 0a20 2020 2020 2020 2066 6964  ere,.        fid
-00008a30: 5f61 735f 696e 6465 783d 7072 6573 6572  _as_index=preser
-00008a40: 7665 5f66 6964 2c0a 2020 2020 290a 0a20  ve_fid,.    ).. 
-00008a50: 2020 2023 2052 756e 206f 7065 7261 7469     # Run operati
-00008a60: 6f6e 2069 6620 6461 7461 2072 6561 640a  on if data read.
-00008a70: 2020 2020 6966 206c 656e 2864 6174 615f      if len(data_
-00008a80: 6764 6629 203e 2030 3a0a 2020 2020 2020  gdf) > 0:.      
-00008a90: 2020 6966 206f 7065 7261 7469 6f6e 2069    if operation i
-00008aa0: 7320 4765 6f4f 7065 7261 7469 6f6e 2e42  s GeoOperation.B
-00008ab0: 5546 4645 523a 0a20 2020 2020 2020 2020  UFFER:.         
-00008ac0: 2020 2064 6174 615f 6764 662e 6765 6f6d     data_gdf.geom
-00008ad0: 6574 7279 203d 2064 6174 615f 6764 662e  etry = data_gdf.
-00008ae0: 6765 6f6d 6574 7279 2e62 7566 6665 7228  geometry.buffer(
-00008af0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008b00: 2064 6973 7461 6e63 653d 6f70 6572 6174   distance=operat
-00008b10: 696f 6e5f 7061 7261 6d73 5b22 6469 7374  ion_params["dist
-00008b20: 616e 6365 225d 2c0a 2020 2020 2020 2020  ance"],.        
-00008b30: 2020 2020 2020 2020 7265 736f 6c75 7469          resoluti
-00008b40: 6f6e 3d6f 7065 7261 7469 6f6e 5f70 6172  on=operation_par
-00008b50: 616d 735b 2271 7561 6472 616e 7473 6567  ams["quadrantseg
-00008b60: 6d65 6e74 7322 5d2c 0a20 2020 2020 2020  ments"],.       
-00008b70: 2020 2020 2020 2020 2063 6170 5f73 7479           cap_sty
-00008b80: 6c65 3d6f 7065 7261 7469 6f6e 5f70 6172  le=operation_par
-00008b90: 616d 735b 2265 6e64 6361 705f 7374 796c  ams["endcap_styl
-00008ba0: 6522 5d2e 7661 6c75 652c 0a20 2020 2020  e"].value,.     
-00008bb0: 2020 2020 2020 2020 2020 206a 6f69 6e5f             join_
-00008bc0: 7374 796c 653d 6f70 6572 6174 696f 6e5f  style=operation_
-00008bd0: 7061 7261 6d73 5b22 6a6f 696e 5f73 7479  params["join_sty
-00008be0: 6c65 225d 2e76 616c 7565 2c0a 2020 2020  le"].value,.    
-00008bf0: 2020 2020 2020 2020 2020 2020 6d69 7472              mitr
-00008c00: 655f 6c69 6d69 743d 6f70 6572 6174 696f  e_limit=operatio
-00008c10: 6e5f 7061 7261 6d73 5b22 6d69 7472 655f  n_params["mitre_
-00008c20: 6c69 6d69 7422 5d2c 0a20 2020 2020 2020  limit"],.       
-00008c30: 2020 2020 2020 2020 2073 696e 676c 655f           single_
-00008c40: 7369 6465 643d 6f70 6572 6174 696f 6e5f  sided=operation_
-00008c50: 7061 7261 6d73 5b22 7369 6e67 6c65 5f73  params["single_s
-00008c60: 6964 6564 225d 2c0a 2020 2020 2020 2020  ided"],.        
-00008c70: 2020 2020 290a 2020 2020 2020 2020 656c      ).        el
-00008c80: 6966 206f 7065 7261 7469 6f6e 2069 7320  if operation is 
-00008c90: 4765 6f4f 7065 7261 7469 6f6e 2e43 4f4e  GeoOperation.CON
-00008ca0: 5645 5848 554c 4c3a 0a20 2020 2020 2020  VEXHULL:.       
-00008cb0: 2020 2020 2064 6174 615f 6764 662e 6765       data_gdf.ge
-00008cc0: 6f6d 6574 7279 203d 2064 6174 615f 6764  ometry = data_gd
-00008cd0: 662e 6765 6f6d 6574 7279 2e63 6f6e 7665  f.geometry.conve
-00008ce0: 785f 6875 6c6c 0a20 2020 2020 2020 2065  x_hull.        e
-00008cf0: 6c69 6620 6f70 6572 6174 696f 6e20 6973  lif operation is
-00008d00: 2047 656f 4f70 6572 6174 696f 6e2e 5349   GeoOperation.SI
-00008d10: 4d50 4c49 4659 3a0a 2020 2020 2020 2020  MPLIFY:.        
-00008d20: 2020 2020 6461 7461 5f67 6466 2e67 656f      data_gdf.geo
-00008d30: 6d65 7472 7920 3d20 7079 6765 6f6f 7073  metry = pygeoops
-00008d40: 2e73 696d 706c 6966 7928 0a20 2020 2020  .simplify(.     
-00008d50: 2020 2020 2020 2020 2020 2064 6174 615f             data_
-00008d60: 6764 662e 6765 6f6d 6574 7279 2c0a 2020  gdf.geometry,.  
-00008d70: 2020 2020 2020 2020 2020 2020 2020 616c                al
-00008d80: 676f 7269 7468 6d3d 6f70 6572 6174 696f  gorithm=operatio
-00008d90: 6e5f 7061 7261 6d73 5b22 616c 676f 7269  n_params["algori
-00008da0: 7468 6d22 5d2e 7661 6c75 652c 0a20 2020  thm"].value,.   
-00008db0: 2020 2020 2020 2020 2020 2020 2074 6f6c               tol
-00008dc0: 6572 616e 6365 3d6f 7065 7261 7469 6f6e  erance=operation
-00008dd0: 5f70 6172 616d 735b 2274 6f6c 6572 616e  _params["toleran
-00008de0: 6365 225d 2c0a 2020 2020 2020 2020 2020  ce"],.          
-00008df0: 2020 2020 2020 6c6f 6f6b 6168 6561 643d        lookahead=
-00008e00: 6f70 6572 6174 696f 6e5f 7061 7261 6d73  operation_params
-00008e10: 5b22 7374 6570 225d 2c0a 2020 2020 2020  ["step"],.      
-00008e20: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00008e30: 656c 6966 206f 7065 7261 7469 6f6e 2069  elif operation i
-00008e40: 7320 4765 6f4f 7065 7261 7469 6f6e 2e41  s GeoOperation.A
-00008e50: 5050 4c59 3a0a 2020 2020 2020 2020 2020  PPLY:.          
-00008e60: 2020 6675 6e63 203d 2070 6963 6b6c 652e    func = pickle.
-00008e70: 6c6f 6164 7328 6f70 6572 6174 696f 6e5f  loads(operation_
-00008e80: 7061 7261 6d73 5b22 7069 636b 6c65 645f  params["pickled_
-00008e90: 6675 6e63 225d 290a 2020 2020 2020 2020  func"]).        
-00008ea0: 2020 2020 6966 206f 7065 7261 7469 6f6e      if operation
-00008eb0: 5f70 6172 616d 735b 226f 6e6c 795f 6765  _params["only_ge
-00008ec0: 6f6d 5f69 6e70 7574 225d 2069 7320 5472  om_input"] is Tr
-00008ed0: 7565 3a0a 2020 2020 2020 2020 2020 2020  ue:.            
-00008ee0: 2020 2020 6461 7461 5f67 6466 2e67 656f      data_gdf.geo
-00008ef0: 6d65 7472 7920 3d20 6461 7461 5f67 6466  metry = data_gdf
-00008f00: 2e67 656f 6d65 7472 792e 6170 706c 7928  .geometry.apply(
-00008f10: 6675 6e63 290a 2020 2020 2020 2020 2020  func).          
-00008f20: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00008f30: 2020 2020 2020 2020 6461 7461 5f67 6466          data_gdf
-00008f40: 2e67 656f 6d65 7472 7920 3d20 6461 7461  .geometry = data
-00008f50: 5f67 6466 2e61 7070 6c79 2866 756e 632c  _gdf.apply(func,
-00008f60: 2061 7869 733d 3129 0a20 2020 2020 2020   axis=1).       
-00008f70: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00008f80: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-00008f90: 726f 7228 6622 6f70 6572 6174 696f 6e20  ror(f"operation 
-00008fa0: 6e6f 7420 7375 7070 6f72 7465 643a 207b  not supported: {
-00008fb0: 6f70 6572 6174 696f 6e7d 2229 0a0a 2020  operation}")..  
-00008fc0: 2020 2320 4966 2074 6865 7265 2069 7320    # If there is 
-00008fd0: 616e 2066 6964 2063 6f6c 756d 6e20 696e  an fid column in
-00008fe0: 2074 6865 2064 6174 6173 6574 2c20 7265   the dataset, re
-00008ff0: 6e61 6d65 2069 742c 2062 6563 6175 7365  name it, because
-00009000: 2074 6865 2066 6964 2063 6f6c 756d 6e20   the fid column 
-00009010: 6973 2061 0a20 2020 2023 2022 7370 6563  is a.    # "spec
-00009020: 6961 6c20 6361 7365 2220 696e 2067 6461  ial case" in gda
-00009030: 6c20 7468 6174 2073 686f 756c 6420 6e6f  l that should no
-00009040: 7420 6265 2077 7269 7474 656e 2e0a 2020  t be written..  
-00009050: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
-00009060: 6e63 6528 6461 7461 5f67 6466 2c20 6770  nce(data_gdf, gp
-00009070: 642e 4765 6f44 6174 6146 7261 6d65 290a  d.GeoDataFrame).
-00009080: 2020 2020 636f 6c75 6d6e 735f 6c6f 7765      columns_lowe
-00009090: 725f 6c6f 6f6b 7570 203d 207b 636f 6c75  r_lookup = {colu
-000090a0: 6d6e 2e6c 6f77 6572 2829 3a20 636f 6c75  mn.lower(): colu
-000090b0: 6d6e 2066 6f72 2063 6f6c 756d 6e20 696e  mn for column in
-000090c0: 2064 6174 615f 6764 662e 636f 6c75 6d6e   data_gdf.column
-000090d0: 737d 0a20 2020 2069 6620 2266 6964 2220  s}.    if "fid" 
-000090e0: 696e 2063 6f6c 756d 6e73 5f6c 6f77 6572  in columns_lower
-000090f0: 5f6c 6f6f 6b75 703a 0a20 2020 2020 2020  _lookup:.       
-00009100: 2066 6964 5f63 6f6c 756d 6e20 3d20 636f   fid_column = co
-00009110: 6c75 6d6e 735f 6c6f 7765 725f 6c6f 6f6b  lumns_lower_look
-00009120: 7570 5b22 6669 6422 5d0a 2020 2020 2020  up["fid"].      
-00009130: 2020 666f 7220 6669 645f 6e75 6d62 6572    for fid_number
-00009140: 2069 6e20 7261 6e67 6528 312c 2031 3030   in range(1, 100
-00009150: 293a 0a20 2020 2020 2020 2020 2020 206e  ):.            n
-00009160: 6577 5f6e 616d 6520 3d20 6622 7b66 6964  ew_name = f"{fid
-00009170: 5f63 6f6c 756d 6e7d 5f7b 6669 645f 6e75  _column}_{fid_nu
-00009180: 6d62 6572 7d22 0a20 2020 2020 2020 2020  mber}".         
-00009190: 2020 2069 6620 6e65 775f 6e61 6d65 206e     if new_name n
-000091a0: 6f74 2069 6e20 636f 6c75 6d6e 735f 6c6f  ot in columns_lo
-000091b0: 7765 725f 6c6f 6f6b 7570 3a0a 2020 2020  wer_lookup:.    
-000091c0: 2020 2020 2020 2020 2020 2020 6461 7461              data
-000091d0: 5f67 6466 203d 2064 6174 615f 6764 662e  _gdf = data_gdf.
-000091e0: 7265 6e61 6d65 2863 6f6c 756d 6e73 3d7b  rename(columns={
-000091f0: 6669 645f 636f 6c75 6d6e 3a20 6e65 775f  fid_column: new_
-00009200: 6e61 6d65 7d2c 2063 6f70 793d 4661 6c73  name}, copy=Fals
-00009210: 6529 0a0a 2020 2020 6966 2067 7269 6473  e)..    if grids
-00009220: 697a 6520 213d 2030 2e30 3a0a 2020 2020  ize != 0.0:.    
-00009230: 2020 2020 6461 7461 5f67 6466 2e67 656f      data_gdf.geo
-00009240: 6d65 7472 7920 3d20 5f67 656f 7365 7269  metry = _geoseri
-00009250: 6573 5f75 7469 6c2e 7365 745f 7072 6563  es_util.set_prec
-00009260: 6973 696f 6e28 0a20 2020 2020 2020 2020  ision(.         
-00009270: 2020 2064 6174 615f 6764 662e 6765 6f6d     data_gdf.geom
-00009280: 6574 7279 2c20 6772 6964 5f73 697a 653d  etry, grid_size=
-00009290: 6772 6964 7369 7a65 2c20 7261 6973 655f  gridsize, raise_
-000092a0: 6f6e 5f74 6f70 6f65 7272 6f72 3d46 616c  on_topoerror=Fal
-000092b0: 7365 0a20 2020 2020 2020 2029 0a0a 2020  se.        )..  
-000092c0: 2020 6966 2065 7870 6c6f 6465 636f 6c6c    if explodecoll
-000092d0: 6563 7469 6f6e 733a 0a20 2020 2020 2020  ections:.       
-000092e0: 2064 6174 615f 6764 6620 3d20 6461 7461   data_gdf = data
-000092f0: 5f67 6466 2e65 7870 6c6f 6465 2869 676e  _gdf.explode(ign
-00009300: 6f72 655f 696e 6465 783d 5472 7565 290a  ore_index=True).
-00009310: 0a20 2020 2023 2053 6574 2065 6d70 7479  .    # Set empty
-00009320: 2067 656f 6d65 7472 6965 7320 746f 204e   geometries to N
-00009330: 6f6e 650a 2020 2020 6461 7461 5f67 6466  one.    data_gdf
-00009340: 2e6c 6f63 5b64 6174 615f 6764 662e 6765  .loc[data_gdf.ge
-00009350: 6f6d 6574 7279 2e69 735f 656d 7074 792c  ometry.is_empty,
-00009360: 2064 6174 615f 6764 662e 6765 6f6d 6574   data_gdf.geomet
-00009370: 7279 2e6e 616d 655d 203d 204e 6f6e 650a  ry.name] = None.
-00009380: 0a20 2020 2069 6620 6e6f 7420 6b65 6570  .    if not keep
-00009390: 5f65 6d70 7479 5f67 656f 6d73 3a0a 2020  _empty_geoms:.  
-000093a0: 2020 2020 2020 2320 5265 6d6f 7665 2072        # Remove r
-000093b0: 6f77 7320 7768 6572 6520 6765 6f6d 6574  ows where geomet
-000093c0: 7279 2069 7320 4e6f 6e65 0a20 2020 2020  ry is None.     
-000093d0: 2020 2064 6174 615f 6764 6620 3d20 6461     data_gdf = da
-000093e0: 7461 5f67 6466 5b7e 6461 7461 5f67 6466  ta_gdf[~data_gdf
-000093f0: 2e67 656f 6d65 7472 792e 6973 6e61 2829  .geometry.isna()
-00009400: 5d0a 0a20 2020 2023 2049 6620 7468 6520  ]..    # If the 
-00009410: 7265 7375 6c74 2069 7320 656d 7074 792c  result is empty,
-00009420: 2061 6e64 206e 6f20 6f75 7470 7574 2067   and no output g
-00009430: 656f 6d65 7472 7974 7970 6520 7370 6563  eometrytype spec
-00009440: 6966 6965 642c 2075 7365 2069 6e70 7574  ified, use input
-00009450: 0a20 2020 2023 2067 656f 6d65 7472 7974  .    # geometryt
-00009460: 7970 650a 2020 2020 666f 7263 655f 6f75  ype.    force_ou
-00009470: 7470 7574 5f67 656f 6d65 7472 7974 7970  tput_geometrytyp
-00009480: 6520 3d20 4e6f 6e65 0a20 2020 2069 6620  e = None.    if 
-00009490: 6c65 6e28 6461 7461 5f67 6466 2920 3d3d  len(data_gdf) ==
-000094a0: 2030 3a0a 2020 2020 2020 2020 696e 7075   0:.        inpu
-000094b0: 745f 6c61 7965 7269 6e66 6f20 3d20 6766  t_layerinfo = gf
-000094c0: 6f2e 6765 745f 6c61 7965 7269 6e66 6f28  o.get_layerinfo(
-000094d0: 696e 7075 745f 7061 7468 2c20 696e 7075  input_path, inpu
-000094e0: 745f 6c61 7965 7229 0a20 2020 2020 2020  t_layer).       
-000094f0: 2066 6f72 6365 5f6f 7574 7075 745f 6765   force_output_ge
-00009500: 6f6d 6574 7279 7479 7065 203d 2069 6e70  ometrytype = inp
-00009510: 7574 5f6c 6179 6572 696e 666f 2e67 656f  ut_layerinfo.geo
-00009520: 6d65 7472 7974 7970 650a 2020 2020 2020  metrytype.      
-00009530: 2020 6966 206e 6f74 2065 7870 6c6f 6465    if not explode
-00009540: 636f 6c6c 6563 7469 6f6e 733a 0a20 2020  collections:.   
-00009550: 2020 2020 2020 2020 2066 6f72 6365 5f6f           force_o
-00009560: 7574 7075 745f 6765 6f6d 6574 7279 7479  utput_geometryty
-00009570: 7065 203d 2066 6f72 6365 5f6f 7574 7075  pe = force_outpu
-00009580: 745f 6765 6f6d 6574 7279 7479 7065 2e74  t_geometrytype.t
-00009590: 6f5f 6d75 6c74 6974 7970 650a 2020 2020  o_multitype.    
-000095a0: 2020 2020 666f 7263 655f 6f75 7470 7574      force_output
-000095b0: 5f67 656f 6d65 7472 7974 7970 6520 3d20  _geometrytype = 
-000095c0: 666f 7263 655f 6f75 7470 7574 5f67 656f  force_output_geo
-000095d0: 6d65 7472 7974 7970 652e 6e61 6d65 0a0a  metrytype.name..
-000095e0: 2020 2020 2320 4966 2074 6865 2069 6e64      # If the ind
-000095f0: 6578 2069 7320 7374 696c 6c20 756e 6971  ex is still uniq
-00009600: 7565 2c20 7361 7665 2069 7420 746f 2066  ue, save it to f
-00009610: 6964 2063 6f6c 756d 6e20 736f 2074 6f5f  id column so to_
-00009620: 6669 6c65 2063 616e 2073 6176 6520 6974  file can save it
-00009630: 0a20 2020 2069 6620 7072 6573 6572 7665  .    if preserve
-00009640: 5f66 6964 3a0a 2020 2020 2020 2020 6461  _fid:.        da
-00009650: 7461 5f67 6466 203d 2064 6174 615f 6764  ta_gdf = data_gd
-00009660: 662e 7265 7365 745f 696e 6465 7828 6472  f.reset_index(dr
-00009670: 6f70 3d46 616c 7365 290a 0a20 2020 2023  op=False)..    #
-00009680: 2055 7365 2066 6f72 6365 5f6d 756c 7469   Use force_multi
-00009690: 7479 7065 2069 6620 6578 706c 6f64 6563  type if explodec
-000096a0: 6f6c 6c65 6374 696f 6e73 3d46 616c 7365  ollections=False
-000096b0: 2074 6f20 6176 6f69 6420 7761 726e 696e   to avoid warnin
-000096c0: 6773 2f69 7373 7565 7320 7768 656e 2073  gs/issues when s
-000096d0: 6f6d 650a 2020 2020 2320 6261 7463 6865  ome.    # batche
-000096e0: 7320 636f 6e74 6169 6e20 7369 6e67 6c65  s contain single
-000096f0: 7479 7065 2061 6e64 2073 6f6d 6520 636f  type and some co
-00009700: 6e74 6169 6e20 6d75 6c74 6974 7970 6520  ntain multitype 
-00009710: 6765 6f6d 6574 7269 6573 0a20 2020 2067  geometries.    g
-00009720: 666f 2e74 6f5f 6669 6c65 280a 2020 2020  fo.to_file(.    
-00009730: 2020 2020 6764 663d 6461 7461 5f67 6466      gdf=data_gdf
-00009740: 2c0a 2020 2020 2020 2020 7061 7468 3d6f  ,.        path=o
-00009750: 7574 7075 745f 7061 7468 2c0a 2020 2020  utput_path,.    
-00009760: 2020 2020 6c61 7965 723d 6f75 7470 7574      layer=output
-00009770: 5f6c 6179 6572 2c0a 2020 2020 2020 2020  _layer,.        
-00009780: 696e 6465 783d 4661 6c73 652c 0a20 2020  index=False,.   
-00009790: 2020 2020 2066 6f72 6365 5f6f 7574 7075       force_outpu
-000097a0: 745f 6765 6f6d 6574 7279 7479 7065 3d66  t_geometrytype=f
-000097b0: 6f72 6365 5f6f 7574 7075 745f 6765 6f6d  orce_output_geom
-000097c0: 6574 7279 7479 7065 2c0a 2020 2020 2020  etrytype,.      
-000097d0: 2020 666f 7263 655f 6d75 6c74 6974 7970    force_multityp
-000097e0: 653d 6e6f 7420 6578 706c 6f64 6563 6f6c  e=not explodecol
-000097f0: 6c65 6374 696f 6e73 2c0a 2020 2020 2020  lections,.      
-00009800: 2020 6372 6561 7465 5f73 7061 7469 616c    create_spatial
-00009810: 5f69 6e64 6578 3d46 616c 7365 2c0a 2020  _index=False,.  
-00009820: 2020 290a 0a20 2020 206d 6573 7361 6765    )..    message
-00009830: 203d 2066 2254 6f6f 6b20 7b64 6174 6574   = f"Took {datet
-00009840: 696d 652e 6e6f 7728 292d 7374 6172 745f  ime.now()-start_
-00009850: 7469 6d65 7d20 666f 7220 7b6c 656e 2864  time} for {len(d
-00009860: 6174 615f 6764 6629 7d20 726f 7773 2028  ata_gdf)} rows (
-00009870: 7b77 6865 7265 7d29 220a 2020 2020 7265  {where})".    re
-00009880: 7475 726e 206d 6573 7361 6765 0a0a 0a64  turn message...d
-00009890: 6566 2064 6973 736f 6c76 6528 0a20 2020  ef dissolve(.   
-000098a0: 2069 6e70 7574 5f70 6174 683a 2050 6174   input_path: Pat
-000098b0: 682c 0a20 2020 206f 7574 7075 745f 7061  h,.    output_pa
-000098c0: 7468 3a20 5061 7468 2c0a 2020 2020 6772  th: Path,.    gr
-000098d0: 6f75 7062 795f 636f 6c75 6d6e 733a 204f  oupby_columns: O
-000098e0: 7074 696f 6e61 6c5b 4974 6572 6162 6c65  ptional[Iterable
-000098f0: 5b73 7472 5d5d 203d 204e 6f6e 652c 0a20  [str]] = None,. 
-00009900: 2020 2061 6767 5f63 6f6c 756d 6e73 3a20     agg_columns: 
-00009910: 4f70 7469 6f6e 616c 5b64 6963 745d 203d  Optional[dict] =
-00009920: 204e 6f6e 652c 0a20 2020 2065 7870 6c6f   None,.    explo
-00009930: 6465 636f 6c6c 6563 7469 6f6e 733a 2062  decollections: b
-00009940: 6f6f 6c20 3d20 5472 7565 2c0a 2020 2020  ool = True,.    
-00009950: 7469 6c65 735f 7061 7468 3a20 4f70 7469  tiles_path: Opti
-00009960: 6f6e 616c 5b50 6174 685d 203d 204e 6f6e  onal[Path] = Non
-00009970: 652c 0a20 2020 206e 625f 7371 7561 7269  e,.    nb_squari
-00009980: 7368 5f74 696c 6573 3a20 696e 7420 3d20  sh_tiles: int = 
-00009990: 312c 0a20 2020 2069 6e70 7574 5f6c 6179  1,.    input_lay
-000099a0: 6572 3a20 4f70 7469 6f6e 616c 5b73 7472  er: Optional[str
-000099b0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 6f75  ] = None,.    ou
-000099c0: 7470 7574 5f6c 6179 6572 3a20 4f70 7469  tput_layer: Opti
-000099d0: 6f6e 616c 5b73 7472 5d20 3d20 4e6f 6e65  onal[str] = None
-000099e0: 2c0a 2020 2020 6772 6964 7369 7a65 3a20  ,.    gridsize: 
-000099f0: 666c 6f61 7420 3d20 302e 302c 0a20 2020  float = 0.0,.   
-00009a00: 2077 6865 7265 5f70 6f73 743a 204f 7074   where_post: Opt
-00009a10: 696f 6e61 6c5b 7374 725d 203d 204e 6f6e  ional[str] = Non
-00009a20: 652c 0a20 2020 206e 625f 7061 7261 6c6c  e,.    nb_parall
-00009a30: 656c 3a20 696e 7420 3d20 2d31 2c0a 2020  el: int = -1,.  
-00009a40: 2020 6261 7463 6873 697a 653a 2069 6e74    batchsize: int
-00009a50: 203d 202d 312c 0a20 2020 2066 6f72 6365   = -1,.    force
-00009a60: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
-00009a70: 2020 2020 6f70 6572 6174 696f 6e5f 7072      operation_pr
-00009a80: 6566 6978 3a20 7374 7220 3d20 2222 2c0a  efix: str = "",.
-00009a90: 2920 2d3e 2064 6963 743a 0a20 2020 2022  ) -> dict:.    "
-00009aa0: 2222 0a20 2020 2046 756e 6374 696f 6e20  "".    Function 
-00009ab0: 7468 6174 2061 7070 6c69 6573 2061 2064  that applies a d
-00009ac0: 6973 736f 6c76 652e 0a0a 2020 2020 4d6f  issolve...    Mo
-00009ad0: 7265 2064 6574 6169 6c65 6420 646f 6375  re detailed docu
-00009ae0: 6d65 6e74 6174 696f 6e20 696e 206d 6f64  mentation in mod
-00009af0: 756c 6520 6765 6f6f 7073 210a 0a20 2020  ule geoops!..   
-00009b00: 2052 656d 6172 6b3a 206b 6565 705f 656d   Remark: keep_em
-00009b10: 7074 795f 6765 6f6d 7320 6973 206e 6f74  pty_geoms is not
-00009b20: 2069 6d70 6c65 6d65 6e74 6564 2062 6563   implemented bec
-00009b30: 6175 7365 2074 6869 7320 6973 206e 6f74  ause this is not
-00009b40: 2073 6f20 6561 7379 2062 6563 6175 7365   so easy because
-00009b50: 0a20 2020 2028 666f 7220 706f 6c79 676f  .    (for polygo
-00009b60: 6e20 6469 7373 6f6c 7665 2920 7468 6520  n dissolve) the 
-00009b70: 6261 7463 6865 7320 6172 6520 6c6f 6361  batches are loca
-00009b80: 7469 6f6e 2062 6173 6564 2c20 616e 6420  tion based, and 
-00009b90: 6e75 6c6c 2f65 6d70 7479 2067 656f 6d65  null/empty geome
-00009ba0: 7472 6965 730a 2020 2020 646f 6e27 7420  tries.    don't 
-00009bb0: 6861 7665 2061 206c 6f63 6174 696f 6e2e  have a location.
-00009bc0: 2049 7420 636f 756c 6420 6265 2069 6d70   It could be imp
-00009bd0: 6c65 6d65 6e74 6564 2c20 6275 7420 6173  lemented, but as
-00009be0: 206c 6f6e 6720 6173 206e 6f62 6f64 7920   long as nobody 
-00009bf0: 6e65 6564 7320 6974 2e2e 2e0a 2020 2020  needs it....    
-00009c00: 2222 220a 2020 2020 2320 496e 6974 2061  """.    # Init a
-00009c10: 6e64 2076 616c 6964 6174 6520 696e 7075  nd validate inpu
-00009c20: 7420 7061 7261 6d65 7465 7273 0a20 2020  t parameters.   
-00009c30: 2023 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   # -------------
-00009c40: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00009c50: 2d2d 2d2d 2d0a 2020 2020 7374 6172 745f  -----.    start_
-00009c60: 7469 6d65 203d 2064 6174 6574 696d 652e  time = datetime.
-00009c70: 6e6f 7728 290a 2020 2020 6f70 6572 6174  now().    operat
-00009c80: 696f 6e5f 6e61 6d65 203d 2066 227b 6f70  ion_name = f"{op
-00009c90: 6572 6174 696f 6e5f 7072 6566 6978 7d64  eration_prefix}d
-00009ca0: 6973 736f 6c76 6522 0a20 2020 206c 6f67  issolve".    log
-00009cb0: 6765 7220 3d20 6c6f 6767 696e 672e 6765  ger = logging.ge
-00009cc0: 744c 6f67 6765 7228 6622 6765 6f66 696c  tLogger(f"geofil
-00009cd0: 656f 7073 2e7b 6f70 6572 6174 696f 6e5f  eops.{operation_
-00009ce0: 6e61 6d65 7d22 290a 2020 2020 7265 7375  name}").    resu
-00009cf0: 6c74 5f69 6e66 6f20 3d20 7b7d 0a0a 2020  lt_info = {}..  
-00009d00: 2020 2320 4368 6563 6b20 696e 7075 7420    # Check input 
-00009d10: 7061 7261 6d65 7465 7273 0a20 2020 2069  parameters.    i
-00009d20: 6620 6772 6f75 7062 795f 636f 6c75 6d6e  f groupby_column
-00009d30: 7320 6973 206e 6f74 204e 6f6e 6520 616e  s is not None an
-00009d40: 6420 6c65 6e28 6c69 7374 2867 726f 7570  d len(list(group
-00009d50: 6279 5f63 6f6c 756d 6e73 2929 203d 3d20  by_columns)) == 
-00009d60: 303a 0a20 2020 2020 2020 2072 6169 7365  0:.        raise
-00009d70: 2056 616c 7565 4572 726f 7228 2267 726f   ValueError("gro
-00009d80: 7570 6279 5f63 6f6c 756d 6e73 3d5b 5d20  upby_columns=[] 
-00009d90: 6973 206e 6f74 2073 7570 706f 7274 6564  is not supported
-00009da0: 2e20 5573 6520 4e6f 6e65 2e22 290a 2020  . Use None.").  
-00009db0: 2020 6966 206e 6f74 2069 6e70 7574 5f70    if not input_p
-00009dc0: 6174 682e 6578 6973 7473 2829 3a0a 2020  ath.exists():.  
-00009dd0: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
-00009de0: 6545 7272 6f72 2866 2269 6e70 7574 5f70  eError(f"input_p
-00009df0: 6174 6820 646f 6573 6e27 7420 6578 6973  ath doesn't exis
-00009e00: 743a 207b 696e 7075 745f 7061 7468 7d22  t: {input_path}"
-00009e10: 290a 2020 2020 6966 2069 6e70 7574 5f70  ).    if input_p
-00009e20: 6174 6820 3d3d 206f 7574 7075 745f 7061  ath == output_pa
-00009e30: 7468 3a0a 2020 2020 2020 2020 7261 6973  th:.        rais
-00009e40: 6520 5661 6c75 6545 7272 6f72 2822 6f75  e ValueError("ou
-00009e50: 7470 7574 5f70 6174 6820 6d75 7374 206e  tput_path must n
-00009e60: 6f74 2065 7175 616c 2069 6e70 7574 5f70  ot equal input_p
-00009e70: 6174 6822 290a 0a20 2020 2069 6e70 7574  ath")..    input
-00009e80: 5f6c 6179 6572 696e 666f 203d 2067 666f  _layerinfo = gfo
-00009e90: 2e67 6574 5f6c 6179 6572 696e 666f 2869  .get_layerinfo(i
-00009ea0: 6e70 7574 5f70 6174 682c 2069 6e70 7574  nput_path, input
-00009eb0: 5f6c 6179 6572 290a 2020 2020 6966 2069  _layer).    if i
-00009ec0: 6e70 7574 5f6c 6179 6572 696e 666f 2e67  nput_layerinfo.g
-00009ed0: 656f 6d65 7472 7974 7970 652e 746f 5f70  eometrytype.to_p
-00009ee0: 7269 6d69 7469 7665 7479 7065 2069 6e20  rimitivetype in 
-00009ef0: 5b0a 2020 2020 2020 2020 5072 696d 6974  [.        Primit
-00009f00: 6976 6554 7970 652e 504f 494e 542c 0a20  iveType.POINT,. 
-00009f10: 2020 2020 2020 2050 7269 6d69 7469 7665         Primitive
-00009f20: 5479 7065 2e4c 494e 4553 5452 494e 472c  Type.LINESTRING,
-00009f30: 0a20 2020 205d 3a0a 2020 2020 2020 2020  .    ]:.        
-00009f40: 6966 2074 696c 6573 5f70 6174 6820 6973  if tiles_path is
-00009f50: 206e 6f74 204e 6f6e 6520 6f72 206e 625f   not None or nb_
-00009f60: 7371 7561 7269 7368 5f74 696c 6573 203e  squarish_tiles >
-00009f70: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
-00009f80: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-00009f90: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00009fa0: 2020 6622 4469 7373 6f6c 7665 2074 6f20    f"Dissolve to 
-00009fb0: 7469 6c65 7320 6973 206e 6f74 2073 7570  tiles is not sup
-00009fc0: 706f 7274 6564 2066 6f72 207b 696e 7075  ported for {inpu
-00009fd0: 745f 6c61 7965 7269 6e66 6f2e 6765 6f6d  t_layerinfo.geom
-00009fe0: 6574 7279 7479 7065 7d22 0a20 2020 2020  etrytype}".     
-00009ff0: 2020 2020 2020 2020 2020 2022 2c20 736f             ", so
-0000a000: 2074 696c 6573 5f70 6174 6820 7368 6f75   tiles_path shou
-0000a010: 6c64 2062 6520 4e6f 6e65 2061 6e64 206e  ld be None and n
-0000a020: 625f 7371 7561 7269 7368 5f74 696c 6573  b_squarish_tiles
-0000a030: 2073 686f 756c 6420 6265 2031 2922 0a20   should be 1)". 
-0000a040: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-0000a050: 2020 6966 2069 6e70 7574 5f6c 6179 6572    if input_layer
-0000a060: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0000a070: 2020 696e 7075 745f 6c61 7965 7220 3d20    input_layer = 
-0000a080: 6766 6f2e 6765 745f 6f6e 6c79 5f6c 6179  gfo.get_only_lay
-0000a090: 6572 2869 6e70 7574 5f70 6174 6829 0a20  er(input_path). 
-0000a0a0: 2020 2069 6620 6f75 7470 7574 5f6c 6179     if output_lay
-0000a0b0: 6572 2069 7320 4e6f 6e65 3a0a 2020 2020  er is None:.    
-0000a0c0: 2020 2020 6f75 7470 7574 5f6c 6179 6572      output_layer
-0000a0d0: 203d 2067 666f 2e67 6574 5f64 6566 6175   = gfo.get_defau
-0000a0e0: 6c74 5f6c 6179 6572 286f 7574 7075 745f  lt_layer(output_
-0000a0f0: 7061 7468 290a 0a20 2020 2023 2043 6865  path)..    # Che
-0000a100: 636b 2063 6f6c 756d 6e73 2069 6e20 6772  ck columns in gr
-0000a110: 6f75 7062 795f 636f 6c75 6d6e 730a 2020  oupby_columns.  
-0000a120: 2020 636f 6c75 6d6e 735f 6176 6169 6c61    columns_availa
-0000a130: 626c 6520 3d20 6c69 7374 2869 6e70 7574  ble = list(input
-0000a140: 5f6c 6179 6572 696e 666f 2e63 6f6c 756d  _layerinfo.colum
-0000a150: 6e73 2920 2b20 5b22 6669 6422 5d0a 2020  ns) + ["fid"].  
-0000a160: 2020 6966 2067 726f 7570 6279 5f63 6f6c    if groupby_col
-0000a170: 756d 6e73 2069 7320 6e6f 7420 4e6f 6e65  umns is not None
-0000a180: 3a0a 2020 2020 2020 2020 636f 6c75 6d6e  :.        column
-0000a190: 735f 696e 5f6c 6179 6572 5f75 7070 6572  s_in_layer_upper
-0000a1a0: 203d 205b 636f 6c75 6d6e 2e75 7070 6572   = [column.upper
-0000a1b0: 2829 2066 6f72 2063 6f6c 756d 6e20 696e  () for column in
-0000a1c0: 2063 6f6c 756d 6e73 5f61 7661 696c 6162   columns_availab
-0000a1d0: 6c65 5d0a 2020 2020 2020 2020 666f 7220  le].        for 
-0000a1e0: 636f 6c75 6d6e 2069 6e20 6772 6f75 7062  column in groupb
-0000a1f0: 795f 636f 6c75 6d6e 733a 0a20 2020 2020  y_columns:.     
-0000a200: 2020 2020 2020 2069 6620 636f 6c75 6d6e         if column
-0000a210: 2e75 7070 6572 2829 206e 6f74 2069 6e20  .upper() not in 
-0000a220: 636f 6c75 6d6e 735f 696e 5f6c 6179 6572  columns_in_layer
-0000a230: 5f75 7070 6572 3a0a 2020 2020 2020 2020  _upper:.        
-0000a240: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
-0000a250: 6c75 6545 7272 6f72 280a 2020 2020 2020  lueError(.      
-0000a260: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-0000a270: 636f 6c75 6d6e 2069 6e20 6772 6f75 7062  column in groupb
-0000a280: 795f 636f 6c75 6d6e 7320 6e6f 7420 6176  y_columns not av
-0000a290: 6169 6c61 626c 6520 696e 206c 6179 6572  ailable in layer
-0000a2a0: 3a20 7b63 6f6c 756d 6e7d 220a 2020 2020  : {column}".    
-0000a2b0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0000a2c0: 2020 2020 2020 636f 6c75 6d6e 735f 6176        columns_av
-0000a2d0: 6169 6c61 626c 6520 3d20 5f67 656e 6572  ailable = _gener
-0000a2e0: 616c 5f75 7469 6c2e 616c 6967 6e5f 6361  al_util.align_ca
-0000a2f0: 7369 6e67 5f6c 6973 7428 0a20 2020 2020  sing_list(.     
-0000a300: 2020 2020 2020 2063 6f6c 756d 6e73 5f61         columns_a
-0000a310: 7661 696c 6162 6c65 2c20 6772 6f75 7062  vailable, groupb
-0000a320: 795f 636f 6c75 6d6e 732c 2072 6169 7365  y_columns, raise
-0000a330: 5f6f 6e5f 6d69 7373 696e 673d 4661 6c73  _on_missing=Fals
-0000a340: 650a 2020 2020 2020 2020 290a 0a20 2020  e.        )..   
-0000a350: 2023 2043 6865 636b 2061 6767 5f63 6f6c   # Check agg_col
-0000a360: 756d 6e73 2070 6172 616d 0a20 2020 2069  umns param.    i
-0000a370: 6620 6167 675f 636f 6c75 6d6e 7320 6973  f agg_columns is
-0000a380: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-0000a390: 2020 2023 2056 616c 6964 6174 6520 7468     # Validate th
-0000a3a0: 6520 6469 6374 2073 7472 7563 7475 7265  e dict structure
-0000a3b0: 2c20 736f 2077 6520 6361 6e20 6173 7375  , so we can assu
-0000a3c0: 6d65 2065 7665 7279 7468 696e 6720 6973  me everything is
-0000a3d0: 204f 4b20 6675 7274 6865 7220 6f6e 0a20   OK further on. 
-0000a3e0: 2020 2020 2020 205f 7061 7261 6d65 7465         _paramete
-0000a3f0: 725f 6865 6c70 6572 2e76 616c 6964 6174  r_helper.validat
-0000a400: 655f 6167 675f 636f 6c75 6d6e 7328 6167  e_agg_columns(ag
-0000a410: 675f 636f 6c75 6d6e 7329 0a0a 2020 2020  g_columns)..    
-0000a420: 2020 2020 2320 4669 7273 7420 7461 6b65      # First take
-0000a430: 2061 2064 6565 7020 636f 7079 2c20 6173   a deep copy, as
-0000a440: 2076 616c 7565 7320 6361 6e20 6265 2063   values can be c
-0000a450: 6861 6e67 6564 2066 7572 7468 6572 206f  hanged further o
-0000a460: 6e20 746f 2074 7265 6174 2063 6f6c 756d  n to treat colum
-0000a470: 6e73 0a20 2020 2020 2020 2023 2063 6173  ns.        # cas
-0000a480: 6520 696e 7365 6e73 6974 6976 650a 2020  e insensitive.  
-0000a490: 2020 2020 2020 6167 675f 636f 6c75 6d6e        agg_column
-0000a4a0: 7320 3d20 6a73 6f6e 2e6c 6f61 6473 286a  s = json.loads(j
-0000a4b0: 736f 6e2e 6475 6d70 7328 6167 675f 636f  son.dumps(agg_co
-0000a4c0: 6c75 6d6e 7329 290a 2020 2020 2020 2020  lumns)).        
-0000a4d0: 6173 7365 7274 2061 6767 5f63 6f6c 756d  assert agg_colum
-0000a4e0: 6e73 2069 7320 6e6f 7420 4e6f 6e65 0a20  ns is not None. 
-0000a4f0: 2020 2020 2020 2069 6620 226a 736f 6e22         if "json"
-0000a500: 2069 6e20 6167 675f 636f 6c75 6d6e 733a   in agg_columns:
-0000a510: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0000a520: 6167 675f 636f 6c75 6d6e 735b 226a 736f  agg_columns["jso
-0000a530: 6e22 5d20 6973 204e 6f6e 653a 0a20 2020  n"] is None:.   
-0000a540: 2020 2020 2020 2020 2020 2020 2061 6767               agg
-0000a550: 5f63 6f6c 756d 6e73 5b22 6a73 6f6e 225d  _columns["json"]
-0000a560: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
-0000a570: 2020 2020 2020 2020 2063 2066 6f72 2063           c for c
-0000a580: 2069 6e20 636f 6c75 6d6e 735f 6176 6169   in columns_avai
-0000a590: 6c61 626c 6520 6966 2063 2e6c 6f77 6572  lable if c.lower
-0000a5a0: 2829 206e 6f74 2069 6e20 2822 696e 6465  () not in ("inde
-0000a5b0: 7822 2c20 2266 6964 2229 0a20 2020 2020  x", "fid").     
-0000a5c0: 2020 2020 2020 2020 2020 205d 0a20 2020             ].   
-0000a5d0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0000a5e0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0000a5f0: 2041 6c69 676e 2063 6173 696e 6720 6f66   Align casing of
-0000a600: 2063 6f6c 756d 6e20 6e61 6d65 7320 746f   column names to
-0000a610: 2064 6174 610a 2020 2020 2020 2020 2020   data.          
-0000a620: 2020 2020 2020 6167 675f 636f 6c75 6d6e        agg_column
-0000a630: 735b 226a 736f 6e22 5d20 3d20 5f67 656e  s["json"] = _gen
-0000a640: 6572 616c 5f75 7469 6c2e 616c 6967 6e5f  eral_util.align_
-0000a650: 6361 7369 6e67 5f6c 6973 7428 0a20 2020  casing_list(.   
-0000a660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a670: 2061 6767 5f63 6f6c 756d 6e73 5b22 6a73   agg_columns["js
-0000a680: 6f6e 225d 2c20 636f 6c75 6d6e 735f 6176  on"], columns_av
-0000a690: 6169 6c61 626c 650a 2020 2020 2020 2020  ailable.        
-0000a6a0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0000a6b0: 2020 656c 6966 2022 636f 6c75 6d6e 7322    elif "columns"
-0000a6c0: 2069 6e20 6167 675f 636f 6c75 6d6e 733a   in agg_columns:
-0000a6d0: 0a20 2020 2020 2020 2020 2020 2023 204c  .            # L
-0000a6e0: 6f6f 7020 7468 726f 7567 6820 616c 6c20  oop through all 
-0000a6f0: 726f 7773 0a20 2020 2020 2020 2020 2020  rows.           
-0000a700: 2066 6f72 2061 6767 5f63 6f6c 756d 6e20   for agg_column 
-0000a710: 696e 2061 6767 5f63 6f6c 756d 6e73 5b22  in agg_columns["
-0000a720: 636f 6c75 6d6e 7322 5d3a 0a20 2020 2020  columns"]:.     
-0000a730: 2020 2020 2020 2020 2020 2023 2043 6865             # Che
-0000a740: 636b 2069 6620 636f 6c75 6d6e 2065 7869  ck if column exi
-0000a750: 7374 7320 2b20 7365 7420 6361 7369 6e67  sts + set casing
-0000a760: 2073 616d 6520 6173 2069 6e20 6461 7461   same as in data
-0000a770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a780: 2061 6767 5f63 6f6c 756d 6e5b 2263 6f6c   agg_column["col
-0000a790: 756d 6e22 5d20 3d20 5f67 656e 6572 616c  umn"] = _general
-0000a7a0: 5f75 7469 6c2e 616c 6967 6e5f 6361 7369  _util.align_casi
-0000a7b0: 6e67 280a 2020 2020 2020 2020 2020 2020  ng(.            
-0000a7c0: 2020 2020 2020 2020 6167 675f 636f 6c75          agg_colu
-0000a7d0: 6d6e 5b22 636f 6c75 6d6e 225d 2c20 636f  mn["column"], co
-0000a7e0: 6c75 6d6e 735f 6176 6169 6c61 626c 650a  lumns_available.
-0000a7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a800: 290a 0a20 2020 2023 204e 6f77 2069 6e70  )..    # Now inp
-0000a810: 7574 2070 6172 616d 6574 6572 7320 6172  ut parameters ar
-0000a820: 6520 6368 6563 6b65 642c 2063 6865 636b  e checked, check
-0000a830: 2069 6620 7765 206e 6565 6420 746f 2063   if we need to c
-0000a840: 616c 6375 6c61 7465 2061 6e79 7761 790a  alculate anyway.
-0000a850: 2020 2020 6966 206f 7574 7075 745f 7061      if output_pa
-0000a860: 7468 2e65 7869 7374 7328 293a 0a20 2020  th.exists():.   
-0000a870: 2020 2020 2069 6620 666f 7263 6520 6973       if force is
-0000a880: 2046 616c 7365 3a0a 2020 2020 2020 2020   False:.        
-0000a890: 2020 2020 7265 7375 6c74 5f69 6e66 6f5b      result_info[
-0000a8a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a8b0: 2022 6d65 7373 6167 6522 0a20 2020 2020   "message".     
-0000a8c0: 2020 2020 2020 205d 203d 2066 2253 746f         ] = f"Sto
-0000a8d0: 702c 206f 7574 7075 7420 6578 6973 7473  p, output exists
-0000a8e0: 2061 6c72 6561 6479 207b 6f75 7470 7574   already {output
-0000a8f0: 5f70 6174 687d 2061 6e64 2066 6f72 6365  _path} and force
-0000a900: 2069 7320 6661 6c73 6522 0a20 2020 2020   is false".     
-0000a910: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
-0000a920: 666f 2872 6573 756c 745f 696e 666f 5b22  fo(result_info["
-0000a930: 6d65 7373 6167 6522 5d29 0a20 2020 2020  message"]).     
-0000a940: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
-0000a950: 7375 6c74 5f69 6e66 6f0a 2020 2020 2020  sult_info.      
-0000a960: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0000a970: 2020 2020 6766 6f2e 7265 6d6f 7665 286f      gfo.remove(o
-0000a980: 7574 7075 745f 7061 7468 290a 0a20 2020  utput_path)..   
-0000a990: 2023 204e 6f77 2073 7461 7274 2064 6973   # Now start dis
-0000a9a0: 736f 6c76 696e 670a 2020 2020 2320 2d2d  solving.    # --
-0000a9b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0000a9c0: 2d2d 0a20 2020 2023 2045 6d70 7479 206f  --.    # Empty o
-0000a9d0: 7220 4c69 6e65 2061 6e64 2070 6f69 6e74  r Line and point
-0000a9e0: 206c 6179 6572 7320 6172 653a 0a20 2020   layers are:.   
-0000a9f0: 2023 2020 202a 206e 6f74 2073 6f20 6c61   #   * not so la
-0000aa00: 7267 6520 286d 656d 6f72 792d 7769 7365  rge (memory-wise
-0000aa10: 290a 2020 2020 2320 2020 2a20 6172 656e  ).    #   * aren
-0000aa20: 2774 2063 6f6d 7075 7461 7469 6f6e 616c  't computational
-0000aa30: 6c79 2068 6561 7679 0a20 2020 2023 2041  ly heavy.    # A
-0000aa40: 6464 6974 696f 6e61 6c6c 7920 6c69 6e65  dditionally line
-0000aa50: 206c 6179 6572 7320 6172 6520 6120 7061   layers are a pa
-0000aa60: 696e 2074 6f20 6861 6e64 6c65 2063 6f72  in to handle cor
-0000aa70: 7265 6374 6c79 2062 6563 6175 7365 206f  rectly because o
-0000aa80: 660a 2020 2020 2320 726f 756e 6469 6e67  f.    # rounding
-0000aa90: 2069 7373 7565 7320 6174 2074 6865 2062   issues at the b
-0000aaa0: 6f72 6465 7273 206f 6620 7469 6c65 732e  orders of tiles.
-0000aab0: 2e2e 2073 6f20 6a75 7374 2064 6973 736f  .. so just disso
-0000aac0: 6c76 6520 7468 656d 2069 6e20 6f6e 6520  lve them in one 
-0000aad0: 676f 2e0a 2020 2020 6966 2028 0a20 2020  go..    if (.   
-0000aae0: 2020 2020 2069 6e70 7574 5f6c 6179 6572       input_layer
-0000aaf0: 696e 666f 2e66 6561 7475 7265 636f 756e  info.featurecoun
-0000ab00: 7420 3d3d 2030 0a20 2020 2020 2020 206f  t == 0.        o
-0000ab10: 7220 696e 7075 745f 6c61 7965 7269 6e66  r input_layerinf
-0000ab20: 6f2e 6765 6f6d 6574 7279 7479 7065 2e74  o.geometrytype.t
-0000ab30: 6f5f 7072 696d 6974 6976 6574 7970 650a  o_primitivetype.
-0000ab40: 2020 2020 2020 2020 696e 205b 0a20 2020          in [.   
-0000ab50: 2020 2020 2020 2020 2050 7269 6d69 7469           Primiti
-0000ab60: 7665 5479 7065 2e50 4f49 4e54 2c0a 2020  veType.POINT,.  
-0000ab70: 2020 2020 2020 2020 2020 5072 696d 6974            Primit
-0000ab80: 6976 6554 7970 652e 4c49 4e45 5354 5249  iveType.LINESTRI
-0000ab90: 4e47 2c0a 2020 2020 2020 2020 5d0a 2020  NG,.        ].  
-0000aba0: 2020 293a 0a20 2020 2020 2020 205f 6765    ):.        _ge
-0000abb0: 6f6f 7073 5f73 716c 2e64 6973 736f 6c76  oops_sql.dissolv
-0000abc0: 655f 7369 6e67 6c65 7468 7265 6164 280a  e_singlethread(.
-0000abd0: 2020 2020 2020 2020 2020 2020 696e 7075              inpu
-0000abe0: 745f 7061 7468 3d69 6e70 7574 5f70 6174  t_path=input_pat
-0000abf0: 682c 0a20 2020 2020 2020 2020 2020 206f  h,.            o
-0000ac00: 7574 7075 745f 7061 7468 3d6f 7574 7075  utput_path=outpu
-0000ac10: 745f 7061 7468 2c0a 2020 2020 2020 2020  t_path,.        
-0000ac20: 2020 2020 6578 706c 6f64 6563 6f6c 6c65      explodecolle
-0000ac30: 6374 696f 6e73 3d65 7870 6c6f 6465 636f  ctions=explodeco
-0000ac40: 6c6c 6563 7469 6f6e 732c 0a20 2020 2020  llections,.     
-0000ac50: 2020 2020 2020 2067 726f 7570 6279 5f63         groupby_c
-0000ac60: 6f6c 756d 6e73 3d67 726f 7570 6279 5f63  olumns=groupby_c
-0000ac70: 6f6c 756d 6e73 2c0a 2020 2020 2020 2020  olumns,.        
-0000ac80: 2020 2020 6167 675f 636f 6c75 6d6e 733d      agg_columns=
-0000ac90: 6167 675f 636f 6c75 6d6e 732c 0a20 2020  agg_columns,.   
-0000aca0: 2020 2020 2020 2020 2069 6e70 7574 5f6c           input_l
-0000acb0: 6179 6572 3d69 6e70 7574 5f6c 6179 6572  ayer=input_layer
-0000acc0: 2c0a 2020 2020 2020 2020 2020 2020 6f75  ,.            ou
-0000acd0: 7470 7574 5f6c 6179 6572 3d6f 7574 7075  tput_layer=outpu
-0000ace0: 745f 6c61 7965 722c 0a20 2020 2020 2020  t_layer,.       
-0000acf0: 2020 2020 2067 7269 6473 697a 653d 6772       gridsize=gr
-0000ad00: 6964 7369 7a65 2c0a 2020 2020 2020 2020  idsize,.        
-0000ad10: 2020 2020 6b65 6570 5f65 6d70 7479 5f67      keep_empty_g
-0000ad20: 656f 6d73 3d46 616c 7365 2c0a 2020 2020  eoms=False,.    
-0000ad30: 2020 2020 2020 2020 7768 6572 655f 706f          where_po
-0000ad40: 7374 3d77 6865 7265 5f70 6f73 742c 0a20  st=where_post,. 
-0000ad50: 2020 2020 2020 2020 2020 2066 6f72 6365             force
-0000ad60: 3d66 6f72 6365 2c0a 2020 2020 2020 2020  =force,.        
-0000ad70: 290a 0a20 2020 2065 6c69 6620 696e 7075  )..    elif inpu
-0000ad80: 745f 6c61 7965 7269 6e66 6f2e 6765 6f6d  t_layerinfo.geom
-0000ad90: 6574 7279 7479 7065 2e74 6f5f 7072 696d  etrytype.to_prim
-0000ada0: 6974 6976 6574 7970 6520 6973 2050 7269  itivetype is Pri
-0000adb0: 6d69 7469 7665 5479 7065 2e50 4f4c 5947  mitiveType.POLYG
-0000adc0: 4f4e 3a0a 2020 2020 2020 2020 2320 5072  ON:.        # Pr
-0000add0: 6570 6172 6520 7768 6572 655f 706f 7374  epare where_post
-0000ade0: 0a20 2020 2020 2020 2069 6620 7768 6572  .        if wher
-0000adf0: 655f 706f 7374 2069 7320 6e6f 7420 4e6f  e_post is not No
-0000ae00: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0000ae10: 6966 2077 6865 7265 5f70 6f73 7420 3d3d  if where_post ==
-0000ae20: 2022 223a 0a20 2020 2020 2020 2020 2020   "":.           
-0000ae30: 2020 2020 2077 6865 7265 5f70 6f73 7420       where_post 
-0000ae40: 3d20 4e6f 6e65 0a20 2020 2020 2020 2020  = None.         
-0000ae50: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0000ae60: 2020 2020 2020 2020 2023 2053 6574 2067           # Set g
-0000ae70: 656f 6d65 7472 7963 6f6c 756d 6e20 746f  eometrycolumn to
-0000ae80: 2022 6765 6f6d 222c 2062 6563 6175 7365   "geom", because
-0000ae90: 2074 656d 7020 6669 6c65 7320 6172 6520   temp files are 
-0000aea0: 7361 7665 6420 6173 2067 706b 672e 0a20  saved as gpkg.. 
-0000aeb0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-0000aec0: 6865 7265 5f70 6f73 7420 3d20 7768 6572  here_post = wher
-0000aed0: 655f 706f 7374 2e66 6f72 6d61 7428 6765  e_post.format(ge
-0000aee0: 6f6d 6574 7279 636f 6c75 6d6e 3d22 6765  ometrycolumn="ge
-0000aef0: 6f6d 2229 0a0a 2020 2020 2020 2020 2320  om")..        # 
-0000af00: 4966 2061 2074 696c 6573 5f70 6174 6820  If a tiles_path 
-0000af10: 6973 2073 7065 6369 6669 6564 2c20 7265  is specified, re
-0000af20: 6164 2074 686f 7365 2074 696c 6573 2e2e  ad those tiles..
-0000af30: 2e0a 2020 2020 2020 2020 7265 7375 6c74  ..        result
-0000af40: 5f74 696c 6573 5f67 6466 203d 204e 6f6e  _tiles_gdf = Non
-0000af50: 650a 2020 2020 2020 2020 6966 2074 696c  e.        if til
-0000af60: 6573 5f70 6174 6820 6973 206e 6f74 204e  es_path is not N
-0000af70: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0000af80: 2072 6573 756c 745f 7469 6c65 735f 6764   result_tiles_gd
-0000af90: 6620 3d20 6766 6f2e 7265 6164 5f66 696c  f = gfo.read_fil
-0000afa0: 6528 7469 6c65 735f 7061 7468 290a 2020  e(tiles_path).  
-0000afb0: 2020 2020 2020 2020 2020 6966 206e 625f            if nb_
-0000afc0: 7061 7261 6c6c 656c 203d 3d20 2d31 3a0a  parallel == -1:.
-0000afd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000afe0: 6e62 5f63 7075 203d 206d 756c 7469 7072  nb_cpu = multipr
-0000aff0: 6f63 6573 7369 6e67 2e63 7075 5f63 6f75  ocessing.cpu_cou
-0000b000: 6e74 2829 0a20 2020 2020 2020 2020 2020  nt().           
-0000b010: 2020 2020 206e 625f 7061 7261 6c6c 656c       nb_parallel
-0000b020: 203d 206e 625f 6370 7520 2023 2069 6e74   = nb_cpu  # int
-0000b030: 2831 2e32 3520 2a20 6e62 5f63 7075 290a  (1.25 * nb_cpu).
-0000b040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b050: 6c6f 6767 6572 2e64 6562 7567 2866 224e  logger.debug(f"N
-0000b060: 6220 6370 7573 2066 6f75 6e64 3a20 7b6e  b cpus found: {n
-0000b070: 625f 6370 757d 2c20 6e62 5f70 6172 616c  b_cpu}, nb_paral
-0000b080: 6c65 6c3a 207b 6e62 5f70 6172 616c 6c65  lel: {nb_paralle
-0000b090: 6c7d 2229 0a20 2020 2020 2020 2065 6c73  l}").        els
-0000b0a0: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
-0000b0b0: 2045 6c73 652c 2063 7265 6174 6520 6120   Else, create a 
-0000b0c0: 6772 6964 2062 6173 6564 206f 6e20 7468  grid based on th
-0000b0d0: 6520 6e75 6d62 6572 206f 6620 7469 6c65  e number of tile
-0000b0e0: 7320 7761 6e74 6564 2061 7320 7265 7375  s wanted as resu
-0000b0f0: 6c74 0a20 2020 2020 2020 2020 2020 2023  lt.            #
-0000b100: 2055 7365 2061 206d 6172 6769 6e20 6f66   Use a margin of
-0000b110: 2031 206d 6574 6572 2061 726f 756e 6420   1 meter around 
-0000b120: 7468 6520 626f 756e 6473 0a20 2020 2020  the bounds.     
-0000b130: 2020 2020 2020 206d 6172 6769 6e20 3d20         margin = 
-0000b140: 312e 300a 2020 2020 2020 2020 2020 2020  1.0.            
-0000b150: 6966 2069 6e70 7574 5f6c 6179 6572 696e  if input_layerin
-0000b160: 666f 2e63 7273 2069 7320 6e6f 7420 4e6f  fo.crs is not No
-0000b170: 6e65 2061 6e64 206e 6f74 2069 6e70 7574  ne and not input
-0000b180: 5f6c 6179 6572 696e 666f 2e63 7273 2e69  _layerinfo.crs.i
-0000b190: 735f 7072 6f6a 6563 7465 643a 0a20 2020  s_projected:.   
-0000b1a0: 2020 2020 2020 2020 2020 2020 2023 2049               # I
-0000b1b0: 6620 6765 6f67 7261 7068 6963 2063 7273  f geographic crs
-0000b1c0: 2c20 3120 6465 6772 6565 203d 2031 3131  , 1 degree = 111
-0000b1d0: 206b 6d20 6f72 2031 3131 3030 3020 6d0a   km or 111000 m.
-0000b1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b1f0: 6d61 7267 696e 202f 3d20 3131 3130 3030  margin /= 111000
-0000b200: 0a20 2020 2020 2020 2020 2020 2062 6f75  .            bou
-0000b210: 6e64 7320 3d20 696e 7075 745f 6c61 7965  nds = input_laye
-0000b220: 7269 6e66 6f2e 746f 7461 6c5f 626f 756e  rinfo.total_boun
-0000b230: 6473 0a20 2020 2020 2020 2020 2020 2062  ds.            b
-0000b240: 6f75 6e64 7320 3d20 280a 2020 2020 2020  ounds = (.      
-0000b250: 2020 2020 2020 2020 2020 626f 756e 6473            bounds
-0000b260: 5b30 5d20 2d20 6d61 7267 696e 2c0a 2020  [0] - margin,.  
-0000b270: 2020 2020 2020 2020 2020 2020 2020 626f                bo
-0000b280: 756e 6473 5b31 5d20 2d20 6d61 7267 696e  unds[1] - margin
-0000b290: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000b2a0: 2020 626f 756e 6473 5b32 5d20 2b20 6d61    bounds[2] + ma
-0000b2b0: 7267 696e 2c0a 2020 2020 2020 2020 2020  rgin,.          
-0000b2c0: 2020 2020 2020 626f 756e 6473 5b33 5d20        bounds[3] 
-0000b2d0: 2b20 6d61 7267 696e 2c0a 2020 2020 2020  + margin,.      
-0000b2e0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0000b2f0: 2020 2020 7265 7375 6c74 5f74 696c 6573      result_tiles
-0000b300: 5f67 6466 203d 2067 7064 2e47 656f 4461  _gdf = gpd.GeoDa
-0000b310: 7461 4672 616d 6528 0a20 2020 2020 2020  taFrame(.       
-0000b320: 2020 2020 2020 2020 2067 656f 6d65 7472           geometr
-0000b330: 793d 7079 6765 6f6f 7073 2e63 7265 6174  y=pygeoops.creat
-0000b340: 655f 6772 6964 3228 626f 756e 6473 2c20  e_grid2(bounds, 
-0000b350: 6e62 5f73 7175 6172 6973 685f 7469 6c65  nb_squarish_tile
-0000b360: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
-0000b370: 2020 2020 6372 733d 696e 7075 745f 6c61      crs=input_la
-0000b380: 7965 7269 6e66 6f2e 6372 732c 0a20 2020  yerinfo.crs,.   
-0000b390: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-0000b3a0: 2020 2020 2320 4170 706c 7920 6772 6964      # Apply grid
-0000b3b0: 7369 7a65 2074 6f6c 6572 616e 6365 206f  size tolerance o
-0000b3c0: 6e20 7469 6c65 732c 206f 7468 6572 7769  n tiles, otherwi
-0000b3d0: 7365 2074 6865 2062 6f72 6465 7220 706f  se the border po
-0000b3e0: 6c79 676f 6e73 2063 616e 2774 2062 650a  lygons can't be.
-0000b3f0: 2020 2020 2020 2020 2320 756e 696f 6e65          # unione
-0000b400: 6420 7072 6f70 6572 6c79 2062 6563 6175  d properly becau
-0000b410: 7365 2067 6170 7320 6170 7065 6172 2061  se gaps appear a
-0000b420: 6674 6572 2072 6f75 6e64 696e 6720 636f  fter rounding co
-0000b430: 6f72 6469 6e61 7465 732e 0a20 2020 2020  ordinates..     
-0000b440: 2020 2069 6620 6772 6964 7369 7a65 2021     if gridsize !
-0000b450: 3d20 302e 303a 0a20 2020 2020 2020 2020  = 0.0:.         
-0000b460: 2020 2072 6573 756c 745f 7469 6c65 735f     result_tiles_
-0000b470: 6764 662e 6765 6f6d 6574 7279 203d 2073  gdf.geometry = s
-0000b480: 6861 7065 6c79 2e73 6574 5f70 7265 6369  hapely.set_preci
-0000b490: 7369 6f6e 280a 2020 2020 2020 2020 2020  sion(.          
-0000b4a0: 2020 2020 2020 7265 7375 6c74 5f74 696c        result_til
-0000b4b0: 6573 5f67 6466 2e67 656f 6d65 7472 792c  es_gdf.geometry,
-0000b4c0: 2067 7269 645f 7369 7a65 3d67 7269 6473   grid_size=grids
-0000b4d0: 697a 650a 2020 2020 2020 2020 2020 2020  ize.            
-0000b4e0: 290a 2020 2020 2020 2020 6966 206c 656e  ).        if len
-0000b4f0: 2872 6573 756c 745f 7469 6c65 735f 6764  (result_tiles_gd
-0000b500: 6629 203e 2031 3a0a 2020 2020 2020 2020  f) > 1:.        
-0000b510: 2020 2020 6766 6f2e 746f 5f66 696c 6528      gfo.to_file(
-0000b520: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b530: 2072 6573 756c 745f 7469 6c65 735f 6764   result_tiles_gd
-0000b540: 662c 0a20 2020 2020 2020 2020 2020 2020  f,.             
-0000b550: 2020 206f 7574 7075 745f 7061 7468 2e70     output_path.p
-0000b560: 6172 656e 7420 2f20 6622 7b6f 7574 7075  arent / f"{outpu
-0000b570: 745f 7061 7468 2e73 7465 6d7d 5f74 696c  t_path.stem}_til
-0000b580: 6573 2e67 706b 6722 2c0a 2020 2020 2020  es.gpkg",.      
-0000b590: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-0000b5a0: 2023 2049 6620 6120 7469 6c65 6420 7265   # If a tiled re
-0000b5b0: 7375 6c74 2069 7320 6173 6b65 642c 2061  sult is asked, a
-0000b5c0: 6464 2074 696c 655f 6964 2074 6f20 6772  dd tile_id to gr
-0000b5d0: 6f75 7020 6f6e 2066 6f72 2074 6865 2072  oup on for the r
-0000b5e0: 6573 756c 740a 2020 2020 2020 2020 6966  esult.        if
-0000b5f0: 206c 656e 2872 6573 756c 745f 7469 6c65   len(result_tile
-0000b600: 735f 6764 6629 203e 2031 3a0a 2020 2020  s_gdf) > 1:.    
-0000b610: 2020 2020 2020 2020 7265 7375 6c74 5f74          result_t
-0000b620: 696c 6573 5f67 6466 5b22 7469 6c65 5f69  iles_gdf["tile_i
-0000b630: 6422 5d20 3d20 7265 7375 6c74 5f74 696c  d"] = result_til
-0000b640: 6573 5f67 6466 2e72 6573 6574 5f69 6e64  es_gdf.reset_ind
-0000b650: 6578 2829 2e69 6e64 6578 0a0a 2020 2020  ex().index..    
-0000b660: 2020 2020 2320 5468 6520 6469 7373 6f6c      # The dissol
-0000b670: 7665 2066 6f72 2070 6f6c 7967 6f6e 7320  ve for polygons 
-0000b680: 6973 2064 6f6e 6520 696e 2073 6576 6572  is done in sever
-0000b690: 616c 2070 6173 7365 732c 2061 6e64 2061  al passes, and a
-0000b6a0: 6674 6572 2074 6865 2066 6972 7374 0a20  fter the first. 
-0000b6b0: 2020 2020 2020 2023 2070 6173 732c 206f         # pass, o
-0000b6c0: 6e6c 7920 7468 6520 276f 6e62 6f72 6465  nly the 'onborde
-0000b6d0: 7227 2066 6561 7475 7265 7320 6172 6520  r' features are 
-0000b6e0: 6675 7274 6865 7220 6469 7373 6f6c 7665  further dissolve
-0000b6f0: 642c 2061 7320 7468 650a 2020 2020 2020  d, as the.      
-0000b700: 2020 2320 276e 6f74 6f6e 626f 7264 6572    # 'notonborder
-0000b710: 2720 6665 6174 7572 6573 2061 7265 2061  ' features are a
-0000b720: 6c72 6561 6479 204f 4b2e 0a20 2020 2020  lready OK..     
-0000b730: 2020 2074 656d 7064 6972 203d 205f 696f     tempdir = _io
-0000b740: 5f75 7469 6c2e 6372 6561 7465 5f74 656d  _util.create_tem
-0000b750: 7064 6972 2866 2267 656f 6669 6c65 6f70  pdir(f"geofileop
-0000b760: 732f 7b6f 7065 7261 7469 6f6e 5f6e 616d  s/{operation_nam
-0000b770: 657d 2229 0a20 2020 2020 2020 2074 7279  e}").        try
-0000b780: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-0000b790: 206f 7574 7075 745f 6c61 7965 7220 6973   output_layer is
-0000b7a0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-0000b7b0: 2020 2020 2020 206f 7574 7075 745f 6c61         output_la
-0000b7c0: 7965 7220 3d20 6766 6f2e 6765 745f 6465  yer = gfo.get_de
-0000b7d0: 6661 756c 745f 6c61 7965 7228 6f75 7470  fault_layer(outp
-0000b7e0: 7574 5f70 6174 6829 0a20 2020 2020 2020  ut_path).       
-0000b7f0: 2020 2020 206f 7574 7075 745f 746d 705f       output_tmp_
-0000b800: 7061 7468 203d 2074 656d 7064 6972 202f  path = tempdir /
-0000b810: 2022 6f75 7470 7574 5f74 6d70 2e67 706b   "output_tmp.gpk
-0000b820: 6722 0a20 2020 2020 2020 2020 2020 2070  g".            p
-0000b830: 7265 765f 6e62 5f62 6174 6368 6573 203d  rev_nb_batches =
-0000b840: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
-0000b850: 2020 6c61 7374 5f70 6173 7320 3d20 4661    last_pass = Fa
-0000b860: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
-0000b870: 7061 7373 5f69 6420 3d20 300a 2020 2020  pass_id = 0.    
-0000b880: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
-0000b890: 6e66 6f28 6622 5374 6172 742c 2077 6974  nfo(f"Start, wit
-0000b8a0: 6820 696e 7075 7420 7b69 6e70 7574 5f70  h input {input_p
-0000b8b0: 6174 687d 2229 0a20 2020 2020 2020 2020  ath}").         
-0000b8c0: 2020 2069 6e70 7574 5f70 6173 735f 6c61     input_pass_la
-0000b8d0: 7965 723a 204f 7074 696f 6e61 6c5b 7374  yer: Optional[st
-0000b8e0: 725d 203d 2069 6e70 7574 5f6c 6179 6572  r] = input_layer
-0000b8f0: 0a20 2020 2020 2020 2020 2020 2077 6869  .            whi
-0000b900: 6c65 2054 7275 653a 0a20 2020 2020 2020  le True:.       
-0000b910: 2020 2020 2020 2020 2023 2049 6620 696e           # If in
-0000b920: 7075 745f 7061 7468 2064 6f65 7320 6e6f  put_path does no
-0000b930: 7420 6578 6973 742c 2074 6865 206c 6173  t exist, the las
-0000b940: 7420 7061 7373 2064 6964 6e27 7420 6861  t pass didn't ha
-0000b950: 7665 2061 6e79 206f 6e62 6f72 6465 720a  ve any onborder.
-0000b960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b970: 2320 706f 6c79 676f 6e73 2061 7320 7265  # polygons as re
-0000b980: 7375 6c74 2c20 736f 2077 6520 6172 6520  sult, so we are 
-0000b990: 7265 6164 7920 6469 7373 6f6c 7669 6e67  ready dissolving
-0000b9a0: 2e2e 2e0a 2020 2020 2020 2020 2020 2020  ....            
-0000b9b0: 2020 2020 6966 206e 6f74 2069 6e70 7574      if not input
-0000b9c0: 5f70 6174 682e 6578 6973 7473 2829 3a0a  _path.exists():.
-0000b9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b9e0: 2020 2020 6272 6561 6b0a 0a20 2020 2020      break..     
-0000b9f0: 2020 2020 2020 2020 2020 2023 2047 6574             # Get
-0000ba00: 2069 6e66 6f20 6f66 2074 6865 2063 7572   info of the cur
-0000ba10: 7265 6e74 2066 696c 6520 7468 6174 206e  rent file that n
-0000ba20: 6565 6473 2074 6f20 6265 2064 6973 736f  eeds to be disso
-0000ba30: 6c76 6564 0a20 2020 2020 2020 2020 2020  lved.           
-0000ba40: 2020 2020 2069 6e70 7574 5f70 6173 735f       input_pass_
-0000ba50: 6c61 7965 7269 6e66 6f20 3d20 6766 6f2e  layerinfo = gfo.
-0000ba60: 6765 745f 6c61 7965 7269 6e66 6f28 696e  get_layerinfo(in
-0000ba70: 7075 745f 7061 7468 2c20 696e 7075 745f  put_path, input_
-0000ba80: 7061 7373 5f6c 6179 6572 290a 2020 2020  pass_layer).    
-0000ba90: 2020 2020 2020 2020 2020 2020 6e62 5f72              nb_r
-0000baa0: 6f77 735f 746f 7461 6c20 3d20 696e 7075  ows_total = inpu
-0000bab0: 745f 7061 7373 5f6c 6179 6572 696e 666f  t_pass_layerinfo
-0000bac0: 2e66 6561 7475 7265 636f 756e 740a 0a20  .featurecount.. 
-0000bad0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0000bae0: 2043 616c 6375 6c61 7465 2074 6865 2062   Calculate the b
-0000baf0: 6573 7420 6e75 6d62 6572 206f 6620 7061  est number of pa
-0000bb00: 7261 6c6c 656c 2070 726f 6365 7373 6573  rallel processes
-0000bb10: 2061 6e64 2062 6174 6368 6573 2066 6f72   and batches for
-0000bb20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000bb30: 2023 2074 6865 2061 7661 696c 6162 6c65   # the available
-0000bb40: 2072 6573 6f75 7263 6573 2066 6f72 2074   resources for t
-0000bb50: 6865 2063 7572 7265 6e74 2070 6173 730a  he current pass.
-0000bb60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bb70: 2320 4c69 6d69 7420 7468 6520 6e62 206f  # Limit the nb o
-0000bb80: 6620 726f 7773 2070 6572 2062 6174 6368  f rows per batch
-0000bb90: 2c20 6173 2064 6973 736f 6c76 6520 736c  , as dissolve sl
-0000bba0: 6f77 7320 646f 776e 2077 6974 6820 6d6f  ows down with mo
-0000bbb0: 7265 2072 6f77 732e 0a20 2020 2020 2020  re rows..       
-0000bbc0: 2020 2020 2020 2020 206e 625f 7061 7261           nb_para
-0000bbd0: 6c6c 656c 2c20 6e62 5f62 6174 6368 6573  llel, nb_batches
-0000bbe0: 203d 205f 6465 7465 726d 696e 655f 6e62   = _determine_nb
-0000bbf0: 5f62 6174 6368 6573 280a 2020 2020 2020  _batches(.      
-0000bc00: 2020 2020 2020 2020 2020 2020 2020 6e62                nb
-0000bc10: 5f72 6f77 735f 746f 7461 6c3d 6e62 5f72  _rows_total=nb_r
-0000bc20: 6f77 735f 746f 7461 6c2c 0a20 2020 2020  ows_total,.     
-0000bc30: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0000bc40: 625f 7061 7261 6c6c 656c 3d6e 625f 7061  b_parallel=nb_pa
-0000bc50: 7261 6c6c 656c 2c0a 2020 2020 2020 2020  rallel,.        
-0000bc60: 2020 2020 2020 2020 2020 2020 6261 7463              batc
-0000bc70: 6873 697a 653d 6261 7463 6873 697a 652c  hsize=batchsize,
-0000bc80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000bc90: 2020 2020 2070 6172 616c 6c65 6c69 7a61       paralleliza
-0000bca0: 7469 6f6e 5f63 6f6e 6669 673d 5061 7261  tion_config=Para
-0000bcb0: 6c6c 656c 697a 6174 696f 6e43 6f6e 6669  llelizationConfi
-0000bcc0: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
-0000bcd0: 2020 2020 2020 2020 2020 206d 6178 5f72             max_r
-0000bce0: 6f77 735f 7065 725f 6261 7463 683d 3130  ows_per_batch=10
-0000bcf0: 3030 300a 2020 2020 2020 2020 2020 2020  000.            
-0000bd00: 2020 2020 2020 2020 292c 0a20 2020 2020          ),.     
-0000bd10: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-0000bd20: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0000bd30: 4966 2074 6865 2069 6465 616c 206e 756d  If the ideal num
-0000bd40: 6265 7220 6f66 2062 6174 6368 6573 2069  ber of batches i
-0000bd50: 7320 636c 6f73 6520 746f 2074 6865 206e  s close to the n
-0000bd60: 622e 2072 6573 756c 7420 7469 6c65 7320  b. result tiles 
-0000bd70: 6173 6b65 642c 0a20 2020 2020 2020 2020  asked,.         
-0000bd80: 2020 2020 2020 2023 2064 6973 736f 6c76         # dissolv
-0000bd90: 6520 746f 7761 7264 7320 7468 6520 6173  e towards the as
-0000bda0: 6b65 6420 7265 7375 6c74 210a 2020 2020  ked result!.    
-0000bdb0: 2020 2020 2020 2020 2020 2020 2320 4966              # If
-0000bdc0: 206e 6f74 2c20 6120 7465 6d70 6f72 6172   not, a temporar
-0000bdd0: 7920 7265 7375 6c74 2069 7320 6372 6561  y result is crea
-0000bde0: 7465 6420 7573 696e 6720 736d 616c 6c65  ted using smalle
-0000bdf0: 7220 7469 6c65 730a 2020 2020 2020 2020  r tiles.        
-0000be00: 2020 2020 2020 2020 6966 206e 625f 6261          if nb_ba
-0000be10: 7463 6865 7320 3c3d 206c 656e 2872 6573  tches <= len(res
-0000be20: 756c 745f 7469 6c65 735f 6764 6629 202a  ult_tiles_gdf) *
-0000be30: 2031 2e31 3a0a 2020 2020 2020 2020 2020   1.1:.          
-0000be40: 2020 2020 2020 2020 2020 7469 6c65 735f            tiles_
-0000be50: 6764 6620 3d20 7265 7375 6c74 5f74 696c  gdf = result_til
-0000be60: 6573 5f67 6466 0a20 2020 2020 2020 2020  es_gdf.         
-0000be70: 2020 2020 2020 2020 2020 206c 6173 745f             last_
-0000be80: 7061 7373 203d 2054 7275 650a 2020 2020  pass = True.    
-0000be90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bea0: 6e62 5f70 6172 616c 6c65 6c20 3d20 6d69  nb_parallel = mi
-0000beb0: 6e28 6c65 6e28 7265 7375 6c74 5f74 696c  n(len(result_til
-0000bec0: 6573 5f67 6466 292c 206e 625f 7061 7261  es_gdf), nb_para
-0000bed0: 6c6c 656c 290a 2020 2020 2020 2020 2020  llel).          
-0000bee0: 2020 2020 2020 656c 6966 206c 656e 2872        elif len(r
-0000bef0: 6573 756c 745f 7469 6c65 735f 6764 6629  esult_tiles_gdf)
-0000bf00: 203d 3d20 313a 0a20 2020 2020 2020 2020   == 1:.         
-0000bf10: 2020 2020 2020 2020 2020 2023 2043 7265             # Cre
-0000bf20: 6174 6520 6120 6772 6964 2062 6173 6564  ate a grid based
-0000bf30: 206f 6e20 7468 6520 6964 6561 6c20 6e75   on the ideal nu
-0000bf40: 6d62 6572 206f 6620 6261 7463 6865 732c  mber of batches,
-0000bf50: 2062 7574 206d 616b 650a 2020 2020 2020   but make.      
-0000bf60: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0000bf70: 7375 7265 2074 6865 206e 756d 6265 7220  sure the number 
-0000bf80: 6973 2073 6d61 6c6c 6572 2074 6861 6e20  is smaller than 
-0000bf90: 7468 6520 6d61 7869 6d75 6d2e 2e2e 0a20  the maximum.... 
-0000bfa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bfb0: 2020 206e 625f 7371 7561 7269 7368 5f74     nb_squarish_t
-0000bfc0: 696c 6573 5f6d 6178 203d 204e 6f6e 650a  iles_max = None.
-0000bfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bfe0: 2020 2020 6966 2070 7265 765f 6e62 5f62      if prev_nb_b
-0000bff0: 6174 6368 6573 2069 7320 6e6f 7420 4e6f  atches is not No
-0000c000: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0000c010: 2020 2020 2020 2020 2020 2020 6e62 5f73              nb_s
-0000c020: 7175 6172 6973 685f 7469 6c65 735f 6d61  quarish_tiles_ma
-0000c030: 7820 3d20 6d61 7828 7072 6576 5f6e 625f  x = max(prev_nb_
-0000c040: 6261 7463 6865 7320 2d20 312c 2031 290a  batches - 1, 1).
+00008230: 2020 2020 2020 2020 2020 6766 6f2e 7265            gfo.re
+00008240: 6d6f 7665 2874 6d70 5f70 6172 7469 616c  move(tmp_partial
+00008250: 5f6f 7574 7075 745f 7061 7468 290a 0a20  _output_path).. 
+00008260: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00008270: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
+00008280: 6173 2065 783a 0a20 2020 2020 2020 2020  as ex:.         
+00008290: 2020 2020 2020 2020 2020 2062 6174 6368             batch
+000082a0: 5f69 6420 3d20 6675 7475 7265 5f74 6f5f  _id = future_to_
+000082b0: 6261 7463 685f 6964 5b66 7574 7572 655d  batch_id[future]
+000082c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000082d0: 2020 2020 206d 6573 7361 6765 203d 2066       message = f
+000082e0: 2245 7272 6f72 207b 6578 7d20 6578 6563  "Error {ex} exec
+000082f0: 7574 696e 6720 7b62 6174 6368 6573 5b62  uting {batches[b
+00008300: 6174 6368 5f69 645d 7d22 0a20 2020 2020  atch_id]}".     
+00008310: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00008320: 6f67 6765 722e 6578 6365 7074 696f 6e28  ogger.exception(
+00008330: 6d65 7373 6167 6529 0a20 2020 2020 2020  message).       
+00008340: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+00008350: 7365 2052 756e 7469 6d65 4572 726f 7228  se RuntimeError(
+00008360: 6d65 7373 6167 6529 2066 726f 6d20 6578  message) from ex
+00008370: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00008380: 2020 2320 4c6f 6720 7468 6520 7072 6f67    # Log the prog
+00008390: 7265 7373 2061 6e64 2070 7265 6469 6374  ress and predict
+000083a0: 696f 6e20 7370 6565 640a 2020 2020 2020  ion speed.      
+000083b0: 2020 2020 2020 2020 2020 6e62 5f64 6f6e            nb_don
+000083c0: 6520 2b3d 2031 0a20 2020 2020 2020 2020  e += 1.         
+000083d0: 2020 2020 2020 205f 6765 6e65 7261 6c5f         _general_
+000083e0: 7574 696c 2e72 6570 6f72 745f 7072 6f67  util.report_prog
+000083f0: 7265 7373 280a 2020 2020 2020 2020 2020  ress(.          
+00008400: 2020 2020 2020 2020 2020 7374 6172 745f            start_
+00008410: 7469 6d65 2c0a 2020 2020 2020 2020 2020  time,.          
+00008420: 2020 2020 2020 2020 2020 6e62 5f64 6f6e            nb_don
+00008430: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00008440: 2020 2020 2020 206e 625f 746f 646f 3d6e         nb_todo=n
+00008450: 625f 6261 7463 6865 732c 0a20 2020 2020  b_batches,.     
+00008460: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+00008470: 7065 7261 7469 6f6e 3d6f 7065 7261 7469  peration=operati
+00008480: 6f6e 2e76 616c 7565 2c0a 2020 2020 2020  on.value,.      
+00008490: 2020 2020 2020 2020 2020 2020 2020 6e62                nb
+000084a0: 5f70 6172 616c 6c65 6c3d 7072 6f63 6573  _parallel=proces
+000084b0: 7369 6e67 5f70 6172 616d 732e 6e62 5f70  sing_params.nb_p
+000084c0: 6172 616c 6c65 6c2c 0a20 2020 2020 2020  arallel,.       
+000084d0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+000084e0: 2020 2020 2320 526f 756e 6420 7570 2061      # Round up a
+000084f0: 6e64 2063 6c65 616e 2075 700a 2020 2020  nd clean up.    
+00008500: 2020 2020 2320 4e6f 7720 6372 6561 7465      # Now create
+00008510: 2073 7061 7469 616c 2069 6e64 6578 2061   spatial index a
+00008520: 6e64 206d 6f76 6520 746f 206f 7574 7075  nd move to outpu
+00008530: 7420 6c6f 6361 7469 6f6e 0a20 2020 2020  t location.     
+00008540: 2020 2069 6620 746d 705f 6f75 7470 7574     if tmp_output
+00008550: 5f70 6174 682e 6578 6973 7473 2829 3a0a  _path.exists():.
+00008560: 2020 2020 2020 2020 2020 2020 6966 2047              if G
+00008570: 656f 6669 6c65 496e 666f 2874 6d70 5f6f  eofileInfo(tmp_o
+00008580: 7574 7075 745f 7061 7468 292e 6465 6661  utput_path).defa
+00008590: 756c 745f 7370 6174 6961 6c5f 696e 6465  ult_spatial_inde
+000085a0: 783a 0a20 2020 2020 2020 2020 2020 2020  x:.             
+000085b0: 2020 2067 666f 2e63 7265 6174 655f 7370     gfo.create_sp
+000085c0: 6174 6961 6c5f 696e 6465 7828 7061 7468  atial_index(path
+000085d0: 3d74 6d70 5f6f 7574 7075 745f 7061 7468  =tmp_output_path
+000085e0: 2c20 6c61 7965 723d 6f75 7470 7574 5f6c  , layer=output_l
+000085f0: 6179 6572 290a 2020 2020 2020 2020 2020  ayer).          
+00008600: 2020 6766 6f2e 6d6f 7665 2874 6d70 5f6f    gfo.move(tmp_o
+00008610: 7574 7075 745f 7061 7468 2c20 6f75 7470  utput_path, outp
+00008620: 7574 5f70 6174 6829 0a20 2020 2020 2020  ut_path).       
+00008630: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00008640: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
+00008650: 2252 6573 756c 7420 7761 7320 656d 7074  "Result was empt
+00008660: 7922 290a 0a20 2020 2066 696e 616c 6c79  y")..    finally
+00008670: 3a0a 2020 2020 2020 2020 6966 2043 6f6e  :.        if Con
+00008680: 6669 674f 7074 696f 6e73 2e72 656d 6f76  figOptions.remov
+00008690: 655f 7465 6d70 5f66 696c 6573 3a0a 2020  e_temp_files:.  
+000086a0: 2020 2020 2020 2020 2020 7368 7574 696c            shutil
+000086b0: 2e72 6d74 7265 6528 746d 705f 6469 722c  .rmtree(tmp_dir,
+000086c0: 2069 676e 6f72 655f 6572 726f 7273 3d54   ignore_errors=T
+000086d0: 7275 6529 0a0a 2020 2020 6c6f 6767 6572  rue)..    logger
+000086e0: 2e69 6e66 6f28 6622 5265 6164 792c 2074  .info(f"Ready, t
+000086f0: 6f6f 6b20 7b64 6174 6574 696d 652e 6e6f  ook {datetime.no
+00008700: 7728 292d 7374 6172 745f 7469 6d65 5f67  w()-start_time_g
+00008710: 6c6f 6261 6c7d 2229 0a0a 0a64 6566 205f  lobal}")...def _
+00008720: 6170 706c 795f 6765 6f6f 7065 7261 7469  apply_geooperati
+00008730: 6f6e 280a 2020 2020 696e 7075 745f 7061  on(.    input_pa
+00008740: 7468 3a20 5061 7468 2c0a 2020 2020 6f75  th: Path,.    ou
+00008750: 7470 7574 5f70 6174 683a 2050 6174 682c  tput_path: Path,
+00008760: 0a20 2020 206f 7065 7261 7469 6f6e 3a20  .    operation: 
+00008770: 4765 6f4f 7065 7261 7469 6f6e 2c0a 2020  GeoOperation,.  
+00008780: 2020 6f70 6572 6174 696f 6e5f 7061 7261    operation_para
+00008790: 6d73 3a20 6469 6374 2c0a 2020 2020 696e  ms: dict,.    in
+000087a0: 7075 745f 6c61 7965 723a 204f 7074 696f  put_layer: Optio
+000087b0: 6e61 6c5b 7374 725d 203d 204e 6f6e 652c  nal[str] = None,
+000087c0: 0a20 2020 206f 7574 7075 745f 6c61 7965  .    output_laye
+000087d0: 723a 204f 7074 696f 6e61 6c5b 7374 725d  r: Optional[str]
+000087e0: 203d 204e 6f6e 652c 0a20 2020 2063 6f6c   = None,.    col
+000087f0: 756d 6e73 3a20 4f70 7469 6f6e 616c 5b6c  umns: Optional[l
+00008800: 6973 745b 7374 725d 5d20 3d20 4e6f 6e65  ist[str]] = None
+00008810: 2c0a 2020 2020 7768 6572 653d 4e6f 6e65  ,.    where=None
+00008820: 2c0a 2020 2020 6578 706c 6f64 6563 6f6c  ,.    explodecol
+00008830: 6c65 6374 696f 6e73 3a20 626f 6f6c 203d  lections: bool =
+00008840: 2046 616c 7365 2c0a 2020 2020 6772 6964   False,.    grid
+00008850: 7369 7a65 3a20 666c 6f61 7420 3d20 302e  size: float = 0.
+00008860: 302c 0a20 2020 206b 6565 705f 656d 7074  0,.    keep_empt
+00008870: 795f 6765 6f6d 733a 2062 6f6f 6c20 3d20  y_geoms: bool = 
+00008880: 4661 6c73 652c 0a20 2020 2070 7265 7365  False,.    prese
+00008890: 7276 655f 6669 643a 2062 6f6f 6c20 3d20  rve_fid: bool = 
+000088a0: 4661 6c73 652c 0a20 2020 2066 6f72 6365  False,.    force
+000088b0: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
+000088c0: 2920 2d3e 2073 7472 3a0a 2020 2020 2320  ) -> str:.    # 
+000088d0: 496e 6974 0a20 2020 2069 6620 6e6f 7420  Init.    if not 
+000088e0: 6f75 7470 7574 5f70 6174 682e 7061 7265  output_path.pare
+000088f0: 6e74 2e65 7869 7374 7328 293a 0a20 2020  nt.exists():.   
+00008900: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+00008910: 4572 726f 7228 6622 4f75 7470 7574 2064  Error(f"Output d
+00008920: 6972 6563 746f 7279 2064 6f65 7320 6e6f  irectory does no
+00008930: 7420 6578 6973 743a 207b 6f75 7470 7574  t exist: {output
+00008940: 5f70 6174 682e 7061 7265 6e74 7d22 290a  _path.parent}").
+00008950: 2020 2020 6966 206f 7574 7075 745f 7061      if output_pa
+00008960: 7468 2e65 7869 7374 7328 293a 0a20 2020  th.exists():.   
+00008970: 2020 2020 2069 6620 666f 7263 6520 6973       if force is
+00008980: 2046 616c 7365 3a0a 2020 2020 2020 2020   False:.        
+00008990: 2020 2020 6d65 7373 6167 6520 3d20 6622      message = f"
+000089a0: 5374 6f70 2c20 6f75 7470 7574 2065 7869  Stop, output exi
+000089b0: 7374 7320 616c 7265 6164 7920 7b6f 7574  sts already {out
+000089c0: 7075 745f 7061 7468 7d22 0a20 2020 2020  put_path}".     
+000089d0: 2020 2020 2020 2072 6574 7572 6e20 6d65         return me
+000089e0: 7373 6167 650a 2020 2020 2020 2020 656c  ssage.        el
+000089f0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00008a00: 6766 6f2e 7265 6d6f 7665 286f 7574 7075  gfo.remove(outpu
+00008a10: 745f 7061 7468 290a 0a20 2020 2023 204e  t_path)..    # N
+00008a20: 6f77 2067 6f21 0a20 2020 2073 7461 7274  ow go!.    start
+00008a30: 5f74 696d 6520 3d20 6461 7465 7469 6d65  _time = datetime
+00008a40: 2e6e 6f77 2829 0a20 2020 2064 6174 615f  .now().    data_
+00008a50: 6764 6620 3d20 6766 6f2e 7265 6164 5f66  gdf = gfo.read_f
+00008a60: 696c 6528 0a20 2020 2020 2020 2070 6174  ile(.        pat
+00008a70: 683d 696e 7075 745f 7061 7468 2c0a 2020  h=input_path,.  
+00008a80: 2020 2020 2020 6c61 7965 723d 696e 7075        layer=inpu
+00008a90: 745f 6c61 7965 722c 0a20 2020 2020 2020  t_layer,.       
+00008aa0: 2063 6f6c 756d 6e73 3d63 6f6c 756d 6e73   columns=columns
+00008ab0: 2c0a 2020 2020 2020 2020 7768 6572 653d  ,.        where=
+00008ac0: 7768 6572 652c 0a20 2020 2020 2020 2066  where,.        f
+00008ad0: 6964 5f61 735f 696e 6465 783d 7072 6573  id_as_index=pres
+00008ae0: 6572 7665 5f66 6964 2c0a 2020 2020 290a  erve_fid,.    ).
+00008af0: 0a20 2020 2023 2052 756e 206f 7065 7261  .    # Run opera
+00008b00: 7469 6f6e 2069 6620 6461 7461 2072 6561  tion if data rea
+00008b10: 640a 2020 2020 6966 206c 656e 2864 6174  d.    if len(dat
+00008b20: 615f 6764 6629 203e 2030 3a0a 2020 2020  a_gdf) > 0:.    
+00008b30: 2020 2020 6966 206f 7065 7261 7469 6f6e      if operation
+00008b40: 2069 7320 4765 6f4f 7065 7261 7469 6f6e   is GeoOperation
+00008b50: 2e42 5546 4645 523a 0a20 2020 2020 2020  .BUFFER:.       
+00008b60: 2020 2020 2064 6174 615f 6764 662e 6765       data_gdf.ge
+00008b70: 6f6d 6574 7279 203d 2064 6174 615f 6764  ometry = data_gd
+00008b80: 662e 6765 6f6d 6574 7279 2e62 7566 6665  f.geometry.buffe
+00008b90: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+00008ba0: 2020 2064 6973 7461 6e63 653d 6f70 6572     distance=oper
+00008bb0: 6174 696f 6e5f 7061 7261 6d73 5b22 6469  ation_params["di
+00008bc0: 7374 616e 6365 225d 2c0a 2020 2020 2020  stance"],.      
+00008bd0: 2020 2020 2020 2020 2020 7265 736f 6c75            resolu
+00008be0: 7469 6f6e 3d6f 7065 7261 7469 6f6e 5f70  tion=operation_p
+00008bf0: 6172 616d 735b 2271 7561 6472 616e 7473  arams["quadrants
+00008c00: 6567 6d65 6e74 7322 5d2c 0a20 2020 2020  egments"],.     
+00008c10: 2020 2020 2020 2020 2020 2063 6170 5f73             cap_s
+00008c20: 7479 6c65 3d6f 7065 7261 7469 6f6e 5f70  tyle=operation_p
+00008c30: 6172 616d 735b 2265 6e64 6361 705f 7374  arams["endcap_st
+00008c40: 796c 6522 5d2e 7661 6c75 652c 0a20 2020  yle"].value,.   
+00008c50: 2020 2020 2020 2020 2020 2020 206a 6f69               joi
+00008c60: 6e5f 7374 796c 653d 6f70 6572 6174 696f  n_style=operatio
+00008c70: 6e5f 7061 7261 6d73 5b22 6a6f 696e 5f73  n_params["join_s
+00008c80: 7479 6c65 225d 2e76 616c 7565 2c0a 2020  tyle"].value,.  
+00008c90: 2020 2020 2020 2020 2020 2020 2020 6d69                mi
+00008ca0: 7472 655f 6c69 6d69 743d 6f70 6572 6174  tre_limit=operat
+00008cb0: 696f 6e5f 7061 7261 6d73 5b22 6d69 7472  ion_params["mitr
+00008cc0: 655f 6c69 6d69 7422 5d2c 0a20 2020 2020  e_limit"],.     
+00008cd0: 2020 2020 2020 2020 2020 2073 696e 676c             singl
+00008ce0: 655f 7369 6465 643d 6f70 6572 6174 696f  e_sided=operatio
+00008cf0: 6e5f 7061 7261 6d73 5b22 7369 6e67 6c65  n_params["single
+00008d00: 5f73 6964 6564 225d 2c0a 2020 2020 2020  _sided"],.      
+00008d10: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00008d20: 656c 6966 206f 7065 7261 7469 6f6e 2069  elif operation i
+00008d30: 7320 4765 6f4f 7065 7261 7469 6f6e 2e43  s GeoOperation.C
+00008d40: 4f4e 5645 5848 554c 4c3a 0a20 2020 2020  ONVEXHULL:.     
+00008d50: 2020 2020 2020 2064 6174 615f 6764 662e         data_gdf.
+00008d60: 6765 6f6d 6574 7279 203d 2064 6174 615f  geometry = data_
+00008d70: 6764 662e 6765 6f6d 6574 7279 2e63 6f6e  gdf.geometry.con
+00008d80: 7665 785f 6875 6c6c 0a20 2020 2020 2020  vex_hull.       
+00008d90: 2065 6c69 6620 6f70 6572 6174 696f 6e20   elif operation 
+00008da0: 6973 2047 656f 4f70 6572 6174 696f 6e2e  is GeoOperation.
+00008db0: 5349 4d50 4c49 4659 3a0a 2020 2020 2020  SIMPLIFY:.      
+00008dc0: 2020 2020 2020 6461 7461 5f67 6466 2e67        data_gdf.g
+00008dd0: 656f 6d65 7472 7920 3d20 7079 6765 6f6f  eometry = pygeoo
+00008de0: 7073 2e73 696d 706c 6966 7928 0a20 2020  ps.simplify(.   
+00008df0: 2020 2020 2020 2020 2020 2020 2064 6174               dat
+00008e00: 615f 6764 662e 6765 6f6d 6574 7279 2c0a  a_gdf.geometry,.
+00008e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008e20: 616c 676f 7269 7468 6d3d 6f70 6572 6174  algorithm=operat
+00008e30: 696f 6e5f 7061 7261 6d73 5b22 616c 676f  ion_params["algo
+00008e40: 7269 7468 6d22 5d2e 7661 6c75 652c 0a20  rithm"].value,. 
+00008e50: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00008e60: 6f6c 6572 616e 6365 3d6f 7065 7261 7469  olerance=operati
+00008e70: 6f6e 5f70 6172 616d 735b 2274 6f6c 6572  on_params["toler
+00008e80: 616e 6365 225d 2c0a 2020 2020 2020 2020  ance"],.        
+00008e90: 2020 2020 2020 2020 6c6f 6f6b 6168 6561          lookahea
+00008ea0: 643d 6f70 6572 6174 696f 6e5f 7061 7261  d=operation_para
+00008eb0: 6d73 5b22 7374 6570 225d 2c0a 2020 2020  ms["step"],.    
+00008ec0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00008ed0: 2020 656c 6966 206f 7065 7261 7469 6f6e    elif operation
+00008ee0: 2069 7320 4765 6f4f 7065 7261 7469 6f6e   is GeoOperation
+00008ef0: 2e41 5050 4c59 3a0a 2020 2020 2020 2020  .APPLY:.        
+00008f00: 2020 2020 6675 6e63 203d 2070 6963 6b6c      func = pickl
+00008f10: 652e 6c6f 6164 7328 6f70 6572 6174 696f  e.loads(operatio
+00008f20: 6e5f 7061 7261 6d73 5b22 7069 636b 6c65  n_params["pickle
+00008f30: 645f 6675 6e63 225d 290a 2020 2020 2020  d_func"]).      
+00008f40: 2020 2020 2020 6966 206f 7065 7261 7469        if operati
+00008f50: 6f6e 5f70 6172 616d 735b 226f 6e6c 795f  on_params["only_
+00008f60: 6765 6f6d 5f69 6e70 7574 225d 2069 7320  geom_input"] is 
+00008f70: 5472 7565 3a0a 2020 2020 2020 2020 2020  True:.          
+00008f80: 2020 2020 2020 6461 7461 5f67 6466 2e67        data_gdf.g
+00008f90: 656f 6d65 7472 7920 3d20 6461 7461 5f67  eometry = data_g
+00008fa0: 6466 2e67 656f 6d65 7472 792e 6170 706c  df.geometry.appl
+00008fb0: 7928 6675 6e63 290a 2020 2020 2020 2020  y(func).        
+00008fc0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00008fd0: 2020 2020 2020 2020 2020 6461 7461 5f67            data_g
+00008fe0: 6466 2e67 656f 6d65 7472 7920 3d20 6461  df.geometry = da
+00008ff0: 7461 5f67 6466 2e61 7070 6c79 2866 756e  ta_gdf.apply(fun
+00009000: 632c 2061 7869 733d 3129 0a20 2020 2020  c, axis=1).     
+00009010: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00009020: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+00009030: 4572 726f 7228 6622 6f70 6572 6174 696f  Error(f"operatio
+00009040: 6e20 6e6f 7420 7375 7070 6f72 7465 643a  n not supported:
+00009050: 207b 6f70 6572 6174 696f 6e7d 2229 0a0a   {operation}")..
+00009060: 2020 2020 2320 4966 2074 6865 7265 2069      # If there i
+00009070: 7320 616e 2066 6964 2063 6f6c 756d 6e20  s an fid column 
+00009080: 696e 2074 6865 2064 6174 6173 6574 2c20  in the dataset, 
+00009090: 7265 6e61 6d65 2069 742c 2062 6563 6175  rename it, becau
+000090a0: 7365 2074 6865 2066 6964 2063 6f6c 756d  se the fid colum
+000090b0: 6e20 6973 2061 0a20 2020 2023 2022 7370  n is a.    # "sp
+000090c0: 6563 6961 6c20 6361 7365 2220 696e 2067  ecial case" in g
+000090d0: 6461 6c20 7468 6174 2073 686f 756c 6420  dal that should 
+000090e0: 6e6f 7420 6265 2077 7269 7474 656e 2e0a  not be written..
+000090f0: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
+00009100: 7461 6e63 6528 6461 7461 5f67 6466 2c20  tance(data_gdf, 
+00009110: 6770 642e 4765 6f44 6174 6146 7261 6d65  gpd.GeoDataFrame
+00009120: 290a 2020 2020 636f 6c75 6d6e 735f 6c6f  ).    columns_lo
+00009130: 7765 725f 6c6f 6f6b 7570 203d 207b 636f  wer_lookup = {co
+00009140: 6c75 6d6e 2e6c 6f77 6572 2829 3a20 636f  lumn.lower(): co
+00009150: 6c75 6d6e 2066 6f72 2063 6f6c 756d 6e20  lumn for column 
+00009160: 696e 2064 6174 615f 6764 662e 636f 6c75  in data_gdf.colu
+00009170: 6d6e 737d 0a20 2020 2069 6620 2266 6964  mns}.    if "fid
+00009180: 2220 696e 2063 6f6c 756d 6e73 5f6c 6f77  " in columns_low
+00009190: 6572 5f6c 6f6f 6b75 703a 0a20 2020 2020  er_lookup:.     
+000091a0: 2020 2066 6964 5f63 6f6c 756d 6e20 3d20     fid_column = 
+000091b0: 636f 6c75 6d6e 735f 6c6f 7765 725f 6c6f  columns_lower_lo
+000091c0: 6f6b 7570 5b22 6669 6422 5d0a 2020 2020  okup["fid"].    
+000091d0: 2020 2020 666f 7220 6669 645f 6e75 6d62      for fid_numb
+000091e0: 6572 2069 6e20 7261 6e67 6528 312c 2031  er in range(1, 1
+000091f0: 3030 293a 0a20 2020 2020 2020 2020 2020  00):.           
+00009200: 206e 6577 5f6e 616d 6520 3d20 6622 7b66   new_name = f"{f
+00009210: 6964 5f63 6f6c 756d 6e7d 5f7b 6669 645f  id_column}_{fid_
+00009220: 6e75 6d62 6572 7d22 0a20 2020 2020 2020  number}".       
+00009230: 2020 2020 2069 6620 6e65 775f 6e61 6d65       if new_name
+00009240: 206e 6f74 2069 6e20 636f 6c75 6d6e 735f   not in columns_
+00009250: 6c6f 7765 725f 6c6f 6f6b 7570 3a0a 2020  lower_lookup:.  
+00009260: 2020 2020 2020 2020 2020 2020 2020 6461                da
+00009270: 7461 5f67 6466 203d 2064 6174 615f 6764  ta_gdf = data_gd
+00009280: 662e 7265 6e61 6d65 2863 6f6c 756d 6e73  f.rename(columns
+00009290: 3d7b 6669 645f 636f 6c75 6d6e 3a20 6e65  ={fid_column: ne
+000092a0: 775f 6e61 6d65 7d2c 2063 6f70 793d 4661  w_name}, copy=Fa
+000092b0: 6c73 6529 0a0a 2020 2020 6966 2067 7269  lse)..    if gri
+000092c0: 6473 697a 6520 213d 2030 2e30 3a0a 2020  dsize != 0.0:.  
+000092d0: 2020 2020 2020 6461 7461 5f67 6466 2e67        data_gdf.g
+000092e0: 656f 6d65 7472 7920 3d20 5f67 656f 7365  eometry = _geose
+000092f0: 7269 6573 5f75 7469 6c2e 7365 745f 7072  ries_util.set_pr
+00009300: 6563 6973 696f 6e28 0a20 2020 2020 2020  ecision(.       
+00009310: 2020 2020 2064 6174 615f 6764 662e 6765       data_gdf.ge
+00009320: 6f6d 6574 7279 2c20 6772 6964 5f73 697a  ometry, grid_siz
+00009330: 653d 6772 6964 7369 7a65 2c20 7261 6973  e=gridsize, rais
+00009340: 655f 6f6e 5f74 6f70 6f65 7272 6f72 3d46  e_on_topoerror=F
+00009350: 616c 7365 0a20 2020 2020 2020 2029 0a0a  alse.        )..
+00009360: 2020 2020 6966 2065 7870 6c6f 6465 636f      if explodeco
+00009370: 6c6c 6563 7469 6f6e 733a 0a20 2020 2020  llections:.     
+00009380: 2020 2064 6174 615f 6764 6620 3d20 6461     data_gdf = da
+00009390: 7461 5f67 6466 2e65 7870 6c6f 6465 2869  ta_gdf.explode(i
+000093a0: 676e 6f72 655f 696e 6465 783d 5472 7565  gnore_index=True
+000093b0: 290a 0a20 2020 2023 2053 6574 2065 6d70  )..    # Set emp
+000093c0: 7479 2067 656f 6d65 7472 6965 7320 746f  ty geometries to
+000093d0: 204e 6f6e 650a 2020 2020 6461 7461 5f67   None.    data_g
+000093e0: 6466 2e6c 6f63 5b64 6174 615f 6764 662e  df.loc[data_gdf.
+000093f0: 6765 6f6d 6574 7279 2e69 735f 656d 7074  geometry.is_empt
+00009400: 792c 2064 6174 615f 6764 662e 6765 6f6d  y, data_gdf.geom
+00009410: 6574 7279 2e6e 616d 655d 203d 204e 6f6e  etry.name] = Non
+00009420: 650a 0a20 2020 2069 6620 6e6f 7420 6b65  e..    if not ke
+00009430: 6570 5f65 6d70 7479 5f67 656f 6d73 3a0a  ep_empty_geoms:.
+00009440: 2020 2020 2020 2020 2320 5265 6d6f 7665          # Remove
+00009450: 2072 6f77 7320 7768 6572 6520 6765 6f6d   rows where geom
+00009460: 6574 7279 2069 7320 4e6f 6e65 0a20 2020  etry is None.   
+00009470: 2020 2020 2064 6174 615f 6764 6620 3d20       data_gdf = 
+00009480: 6461 7461 5f67 6466 5b7e 6461 7461 5f67  data_gdf[~data_g
+00009490: 6466 2e67 656f 6d65 7472 792e 6973 6e61  df.geometry.isna
+000094a0: 2829 5d0a 0a20 2020 2023 2049 6620 7468  ()]..    # If th
+000094b0: 6520 7265 7375 6c74 2069 7320 656d 7074  e result is empt
+000094c0: 792c 2061 6e64 206e 6f20 6f75 7470 7574  y, and no output
+000094d0: 2067 656f 6d65 7472 7974 7970 6520 7370   geometrytype sp
+000094e0: 6563 6966 6965 642c 2075 7365 2069 6e70  ecified, use inp
+000094f0: 7574 0a20 2020 2023 2067 656f 6d65 7472  ut.    # geometr
+00009500: 7974 7970 650a 2020 2020 666f 7263 655f  ytype.    force_
+00009510: 6f75 7470 7574 5f67 656f 6d65 7472 7974  output_geometryt
+00009520: 7970 6520 3d20 4e6f 6e65 0a20 2020 2069  ype = None.    i
+00009530: 6620 6c65 6e28 6461 7461 5f67 6466 2920  f len(data_gdf) 
+00009540: 3d3d 2030 3a0a 2020 2020 2020 2020 696e  == 0:.        in
+00009550: 7075 745f 6c61 7965 7269 6e66 6f20 3d20  put_layerinfo = 
+00009560: 6766 6f2e 6765 745f 6c61 7965 7269 6e66  gfo.get_layerinf
+00009570: 6f28 696e 7075 745f 7061 7468 2c20 696e  o(input_path, in
+00009580: 7075 745f 6c61 7965 7229 0a20 2020 2020  put_layer).     
+00009590: 2020 2066 6f72 6365 5f6f 7574 7075 745f     force_output_
+000095a0: 6765 6f6d 6574 7279 7479 7065 203d 2069  geometrytype = i
+000095b0: 6e70 7574 5f6c 6179 6572 696e 666f 2e67  nput_layerinfo.g
+000095c0: 656f 6d65 7472 7974 7970 650a 2020 2020  eometrytype.    
+000095d0: 2020 2020 6966 206e 6f74 2065 7870 6c6f      if not explo
+000095e0: 6465 636f 6c6c 6563 7469 6f6e 733a 0a20  decollections:. 
+000095f0: 2020 2020 2020 2020 2020 2066 6f72 6365             force
+00009600: 5f6f 7574 7075 745f 6765 6f6d 6574 7279  _output_geometry
+00009610: 7479 7065 203d 2066 6f72 6365 5f6f 7574  type = force_out
+00009620: 7075 745f 6765 6f6d 6574 7279 7479 7065  put_geometrytype
+00009630: 2e74 6f5f 6d75 6c74 6974 7970 650a 0a20  .to_multitype.. 
+00009640: 2020 2023 2049 6620 7468 6520 696e 6465     # If the inde
+00009650: 7820 6973 2073 7469 6c6c 2075 6e69 7175  x is still uniqu
+00009660: 652c 2073 6176 6520 6974 2074 6f20 6669  e, save it to fi
+00009670: 6420 636f 6c75 6d6e 2073 6f20 746f 5f66  d column so to_f
+00009680: 696c 6520 6361 6e20 7361 7665 2069 740a  ile can save it.
+00009690: 2020 2020 6966 2070 7265 7365 7276 655f      if preserve_
+000096a0: 6669 643a 0a20 2020 2020 2020 2064 6174  fid:.        dat
+000096b0: 615f 6764 6620 3d20 6461 7461 5f67 6466  a_gdf = data_gdf
+000096c0: 2e72 6573 6574 5f69 6e64 6578 2864 726f  .reset_index(dro
+000096d0: 703d 4661 6c73 6529 0a0a 2020 2020 2320  p=False)..    # 
+000096e0: 5573 6520 666f 7263 655f 6d75 6c74 6974  Use force_multit
+000096f0: 7970 6520 6966 2065 7870 6c6f 6465 636f  ype if explodeco
+00009700: 6c6c 6563 7469 6f6e 733d 4661 6c73 6520  llections=False 
+00009710: 746f 2061 766f 6964 2077 6172 6e69 6e67  to avoid warning
+00009720: 732f 6973 7375 6573 2077 6865 6e20 736f  s/issues when so
+00009730: 6d65 0a20 2020 2023 2062 6174 6368 6573  me.    # batches
+00009740: 2063 6f6e 7461 696e 2073 696e 676c 6574   contain singlet
+00009750: 7970 6520 616e 6420 736f 6d65 2063 6f6e  ype and some con
+00009760: 7461 696e 206d 756c 7469 7479 7065 2067  tain multitype g
+00009770: 656f 6d65 7472 6965 730a 2020 2020 6766  eometries.    gf
+00009780: 6f2e 746f 5f66 696c 6528 0a20 2020 2020  o.to_file(.     
+00009790: 2020 2067 6466 3d64 6174 615f 6764 662c     gdf=data_gdf,
+000097a0: 0a20 2020 2020 2020 2070 6174 683d 6f75  .        path=ou
+000097b0: 7470 7574 5f70 6174 682c 0a20 2020 2020  tput_path,.     
+000097c0: 2020 206c 6179 6572 3d6f 7574 7075 745f     layer=output_
+000097d0: 6c61 7965 722c 0a20 2020 2020 2020 2069  layer,.        i
+000097e0: 6e64 6578 3d46 616c 7365 2c0a 2020 2020  ndex=False,.    
+000097f0: 2020 2020 666f 7263 655f 6f75 7470 7574      force_output
+00009800: 5f67 656f 6d65 7472 7974 7970 653d 666f  _geometrytype=fo
+00009810: 7263 655f 6f75 7470 7574 5f67 656f 6d65  rce_output_geome
+00009820: 7472 7974 7970 652c 0a20 2020 2020 2020  trytype,.       
+00009830: 2066 6f72 6365 5f6d 756c 7469 7479 7065   force_multitype
+00009840: 3d6e 6f74 2065 7870 6c6f 6465 636f 6c6c  =not explodecoll
+00009850: 6563 7469 6f6e 732c 0a20 2020 2020 2020  ections,.       
+00009860: 2063 7265 6174 655f 7370 6174 6961 6c5f   create_spatial_
+00009870: 696e 6465 783d 4661 6c73 652c 0a20 2020  index=False,.   
+00009880: 2029 0a0a 2020 2020 6d65 7373 6167 6520   )..    message 
+00009890: 3d20 6622 546f 6f6b 207b 6461 7465 7469  = f"Took {dateti
+000098a0: 6d65 2e6e 6f77 2829 2d73 7461 7274 5f74  me.now()-start_t
+000098b0: 696d 657d 2066 6f72 207b 6c65 6e28 6461  ime} for {len(da
+000098c0: 7461 5f67 6466 297d 2072 6f77 7320 287b  ta_gdf)} rows ({
+000098d0: 7768 6572 657d 2922 0a20 2020 2072 6574  where})".    ret
+000098e0: 7572 6e20 6d65 7373 6167 650a 0a0a 6465  urn message...de
+000098f0: 6620 6469 7373 6f6c 7665 280a 2020 2020  f dissolve(.    
+00009900: 696e 7075 745f 7061 7468 3a20 5061 7468  input_path: Path
+00009910: 2c0a 2020 2020 6f75 7470 7574 5f70 6174  ,.    output_pat
+00009920: 683a 2050 6174 682c 0a20 2020 2067 726f  h: Path,.    gro
+00009930: 7570 6279 5f63 6f6c 756d 6e73 3a20 4f70  upby_columns: Op
+00009940: 7469 6f6e 616c 5b49 7465 7261 626c 655b  tional[Iterable[
+00009950: 7374 725d 5d20 3d20 4e6f 6e65 2c0a 2020  str]] = None,.  
+00009960: 2020 6167 675f 636f 6c75 6d6e 733a 204f    agg_columns: O
+00009970: 7074 696f 6e61 6c5b 6469 6374 5d20 3d20  ptional[dict] = 
+00009980: 4e6f 6e65 2c0a 2020 2020 6578 706c 6f64  None,.    explod
+00009990: 6563 6f6c 6c65 6374 696f 6e73 3a20 626f  ecollections: bo
+000099a0: 6f6c 203d 2054 7275 652c 0a20 2020 2074  ol = True,.    t
+000099b0: 696c 6573 5f70 6174 683a 204f 7074 696f  iles_path: Optio
+000099c0: 6e61 6c5b 5061 7468 5d20 3d20 4e6f 6e65  nal[Path] = None
+000099d0: 2c0a 2020 2020 6e62 5f73 7175 6172 6973  ,.    nb_squaris
+000099e0: 685f 7469 6c65 733a 2069 6e74 203d 2031  h_tiles: int = 1
+000099f0: 2c0a 2020 2020 696e 7075 745f 6c61 7965  ,.    input_laye
+00009a00: 723a 204f 7074 696f 6e61 6c5b 7374 725d  r: Optional[str]
+00009a10: 203d 204e 6f6e 652c 0a20 2020 206f 7574   = None,.    out
+00009a20: 7075 745f 6c61 7965 723a 204f 7074 696f  put_layer: Optio
+00009a30: 6e61 6c5b 7374 725d 203d 204e 6f6e 652c  nal[str] = None,
+00009a40: 0a20 2020 2067 7269 6473 697a 653a 2066  .    gridsize: f
+00009a50: 6c6f 6174 203d 2030 2e30 2c0a 2020 2020  loat = 0.0,.    
+00009a60: 7768 6572 655f 706f 7374 3a20 4f70 7469  where_post: Opti
+00009a70: 6f6e 616c 5b73 7472 5d20 3d20 4e6f 6e65  onal[str] = None
+00009a80: 2c0a 2020 2020 6e62 5f70 6172 616c 6c65  ,.    nb_paralle
+00009a90: 6c3a 2069 6e74 203d 202d 312c 0a20 2020  l: int = -1,.   
+00009aa0: 2062 6174 6368 7369 7a65 3a20 696e 7420   batchsize: int 
+00009ab0: 3d20 2d31 2c0a 2020 2020 666f 7263 653a  = -1,.    force:
+00009ac0: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
+00009ad0: 2020 206f 7065 7261 7469 6f6e 5f70 7265     operation_pre
+00009ae0: 6669 783a 2073 7472 203d 2022 222c 0a29  fix: str = "",.)
+00009af0: 3a0a 2020 2020 2222 220a 2020 2020 4675  :.    """.    Fu
+00009b00: 6e63 7469 6f6e 2074 6861 7420 6170 706c  nction that appl
+00009b10: 6965 7320 6120 6469 7373 6f6c 7665 2e0a  ies a dissolve..
+00009b20: 0a20 2020 204d 6f72 6520 6465 7461 696c  .    More detail
+00009b30: 6564 2064 6f63 756d 656e 7461 7469 6f6e  ed documentation
+00009b40: 2069 6e20 6d6f 6475 6c65 2067 656f 6f70   in module geoop
+00009b50: 7321 0a0a 2020 2020 5265 6d61 726b 3a20  s!..    Remark: 
+00009b60: 6b65 6570 5f65 6d70 7479 5f67 656f 6d73  keep_empty_geoms
+00009b70: 2069 7320 6e6f 7420 696d 706c 656d 656e   is not implemen
+00009b80: 7465 6420 6265 6361 7573 6520 7468 6973  ted because this
+00009b90: 2069 7320 6e6f 7420 736f 2065 6173 7920   is not so easy 
+00009ba0: 6265 6361 7573 650a 2020 2020 2866 6f72  because.    (for
+00009bb0: 2070 6f6c 7967 6f6e 2064 6973 736f 6c76   polygon dissolv
+00009bc0: 6529 2074 6865 2062 6174 6368 6573 2061  e) the batches a
+00009bd0: 7265 206c 6f63 6174 696f 6e20 6261 7365  re location base
+00009be0: 642c 2061 6e64 206e 756c 6c2f 656d 7074  d, and null/empt
+00009bf0: 7920 6765 6f6d 6574 7269 6573 0a20 2020  y geometries.   
+00009c00: 2064 6f6e 2774 2068 6176 6520 6120 6c6f   don't have a lo
+00009c10: 6361 7469 6f6e 2e20 4974 2063 6f75 6c64  cation. It could
+00009c20: 2062 6520 696d 706c 656d 656e 7465 642c   be implemented,
+00009c30: 2062 7574 2061 7320 6c6f 6e67 2061 7320   but as long as 
+00009c40: 6e6f 626f 6479 206e 6565 6473 2069 742e  nobody needs it.
+00009c50: 2e2e 0a20 2020 2022 2222 0a20 2020 2023  ...    """.    #
+00009c60: 2049 6e69 7420 616e 6420 7661 6c69 6461   Init and valida
+00009c70: 7465 2069 6e70 7574 2070 6172 616d 6574  te input paramet
+00009c80: 6572 730a 2020 2020 2320 2d2d 2d2d 2d2d  ers.    # ------
+00009c90: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009ca0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020  ------------.   
+00009cb0: 206f 7065 7261 7469 6f6e 5f6e 616d 6520   operation_name 
+00009cc0: 3d20 6622 7b6f 7065 7261 7469 6f6e 5f70  = f"{operation_p
+00009cd0: 7265 6669 787d 6469 7373 6f6c 7665 220a  refix}dissolve".
+00009ce0: 2020 2020 6c6f 6767 6572 203d 206c 6f67      logger = log
+00009cf0: 6769 6e67 2e67 6574 4c6f 6767 6572 2866  ging.getLogger(f
+00009d00: 2267 656f 6669 6c65 6f70 732e 7b6f 7065  "geofileops.{ope
+00009d10: 7261 7469 6f6e 5f6e 616d 657d 2229 0a0a  ration_name}")..
+00009d20: 2020 2020 2320 4368 6563 6b20 696e 7075      # Check inpu
+00009d30: 7420 7061 7261 6d65 7465 7273 0a20 2020  t parameters.   
+00009d40: 2069 6620 6772 6f75 7062 795f 636f 6c75   if groupby_colu
+00009d50: 6d6e 7320 6973 206e 6f74 204e 6f6e 6520  mns is not None 
+00009d60: 616e 6420 6c65 6e28 6c69 7374 2867 726f  and len(list(gro
+00009d70: 7570 6279 5f63 6f6c 756d 6e73 2929 203d  upby_columns)) =
+00009d80: 3d20 303a 0a20 2020 2020 2020 2072 6169  = 0:.        rai
+00009d90: 7365 2056 616c 7565 4572 726f 7228 2267  se ValueError("g
+00009da0: 726f 7570 6279 5f63 6f6c 756d 6e73 3d5b  roupby_columns=[
+00009db0: 5d20 6973 206e 6f74 2073 7570 706f 7274  ] is not support
+00009dc0: 6564 2e20 5573 6520 4e6f 6e65 2e22 290a  ed. Use None.").
+00009dd0: 2020 2020 6966 206e 6f74 2069 6e70 7574      if not input
+00009de0: 5f70 6174 682e 6578 6973 7473 2829 3a0a  _path.exists():.
+00009df0: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
+00009e00: 6c75 6545 7272 6f72 2866 2269 6e70 7574  lueError(f"input
+00009e10: 5f70 6174 6820 646f 6573 6e27 7420 6578  _path doesn't ex
+00009e20: 6973 743a 207b 696e 7075 745f 7061 7468  ist: {input_path
+00009e30: 7d22 290a 2020 2020 6966 2069 6e70 7574  }").    if input
+00009e40: 5f70 6174 6820 3d3d 206f 7574 7075 745f  _path == output_
+00009e50: 7061 7468 3a0a 2020 2020 2020 2020 7261  path:.        ra
+00009e60: 6973 6520 5661 6c75 6545 7272 6f72 2822  ise ValueError("
+00009e70: 6f75 7470 7574 5f70 6174 6820 6d75 7374  output_path must
+00009e80: 206e 6f74 2065 7175 616c 2069 6e70 7574   not equal input
+00009e90: 5f70 6174 6822 290a 0a20 2020 2069 6e70  _path")..    inp
+00009ea0: 7574 5f6c 6179 6572 696e 666f 203d 2067  ut_layerinfo = g
+00009eb0: 666f 2e67 6574 5f6c 6179 6572 696e 666f  fo.get_layerinfo
+00009ec0: 2869 6e70 7574 5f70 6174 682c 2069 6e70  (input_path, inp
+00009ed0: 7574 5f6c 6179 6572 290a 2020 2020 6966  ut_layer).    if
+00009ee0: 2069 6e70 7574 5f6c 6179 6572 696e 666f   input_layerinfo
+00009ef0: 2e67 656f 6d65 7472 7974 7970 652e 746f  .geometrytype.to
+00009f00: 5f70 7269 6d69 7469 7665 7479 7065 2069  _primitivetype i
+00009f10: 6e20 5b0a 2020 2020 2020 2020 5072 696d  n [.        Prim
+00009f20: 6974 6976 6554 7970 652e 504f 494e 542c  itiveType.POINT,
+00009f30: 0a20 2020 2020 2020 2050 7269 6d69 7469  .        Primiti
+00009f40: 7665 5479 7065 2e4c 494e 4553 5452 494e  veType.LINESTRIN
+00009f50: 472c 0a20 2020 205d 3a0a 2020 2020 2020  G,.    ]:.      
+00009f60: 2020 6966 2074 696c 6573 5f70 6174 6820    if tiles_path 
+00009f70: 6973 206e 6f74 204e 6f6e 6520 6f72 206e  is not None or n
+00009f80: 625f 7371 7561 7269 7368 5f74 696c 6573  b_squarish_tiles
+00009f90: 203e 2031 3a0a 2020 2020 2020 2020 2020   > 1:.          
+00009fa0: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+00009fb0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+00009fc0: 2020 2020 6622 4469 7373 6f6c 7665 2074      f"Dissolve t
+00009fd0: 6f20 7469 6c65 7320 6973 206e 6f74 2073  o tiles is not s
+00009fe0: 7570 706f 7274 6564 2066 6f72 207b 696e  upported for {in
+00009ff0: 7075 745f 6c61 7965 7269 6e66 6f2e 6765  put_layerinfo.ge
+0000a000: 6f6d 6574 7279 7479 7065 7d22 0a20 2020  ometrytype}".   
+0000a010: 2020 2020 2020 2020 2020 2020 2022 2c20               ", 
+0000a020: 736f 2074 696c 6573 5f70 6174 6820 7368  so tiles_path sh
+0000a030: 6f75 6c64 2062 6520 4e6f 6e65 2061 6e64  ould be None and
+0000a040: 206e 625f 7371 7561 7269 7368 5f74 696c   nb_squarish_til
+0000a050: 6573 2073 686f 756c 6420 6265 2031 2922  es should be 1)"
+0000a060: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
+0000a070: 2020 2020 6966 2069 6e70 7574 5f6c 6179      if input_lay
+0000a080: 6572 2069 7320 4e6f 6e65 3a0a 2020 2020  er is None:.    
+0000a090: 2020 2020 696e 7075 745f 6c61 7965 7220      input_layer 
+0000a0a0: 3d20 6766 6f2e 6765 745f 6f6e 6c79 5f6c  = gfo.get_only_l
+0000a0b0: 6179 6572 2869 6e70 7574 5f70 6174 6829  ayer(input_path)
+0000a0c0: 0a20 2020 2069 6620 6f75 7470 7574 5f6c  .    if output_l
+0000a0d0: 6179 6572 2069 7320 4e6f 6e65 3a0a 2020  ayer is None:.  
+0000a0e0: 2020 2020 2020 6f75 7470 7574 5f6c 6179        output_lay
+0000a0f0: 6572 203d 2067 666f 2e67 6574 5f64 6566  er = gfo.get_def
+0000a100: 6175 6c74 5f6c 6179 6572 286f 7574 7075  ault_layer(outpu
+0000a110: 745f 7061 7468 290a 0a20 2020 2023 2043  t_path)..    # C
+0000a120: 6865 636b 2063 6f6c 756d 6e73 2069 6e20  heck columns in 
+0000a130: 6772 6f75 7062 795f 636f 6c75 6d6e 730a  groupby_columns.
+0000a140: 2020 2020 636f 6c75 6d6e 735f 6176 6169      columns_avai
+0000a150: 6c61 626c 6520 3d20 6c69 7374 2869 6e70  lable = list(inp
+0000a160: 7574 5f6c 6179 6572 696e 666f 2e63 6f6c  ut_layerinfo.col
+0000a170: 756d 6e73 2920 2b20 5b22 6669 6422 5d0a  umns) + ["fid"].
+0000a180: 2020 2020 6966 2067 726f 7570 6279 5f63      if groupby_c
+0000a190: 6f6c 756d 6e73 2069 7320 6e6f 7420 4e6f  olumns is not No
+0000a1a0: 6e65 3a0a 2020 2020 2020 2020 636f 6c75  ne:.        colu
+0000a1b0: 6d6e 735f 696e 5f6c 6179 6572 5f75 7070  mns_in_layer_upp
+0000a1c0: 6572 203d 205b 636f 6c75 6d6e 2e75 7070  er = [column.upp
+0000a1d0: 6572 2829 2066 6f72 2063 6f6c 756d 6e20  er() for column 
+0000a1e0: 696e 2063 6f6c 756d 6e73 5f61 7661 696c  in columns_avail
+0000a1f0: 6162 6c65 5d0a 2020 2020 2020 2020 666f  able].        fo
+0000a200: 7220 636f 6c75 6d6e 2069 6e20 6772 6f75  r column in grou
+0000a210: 7062 795f 636f 6c75 6d6e 733a 0a20 2020  pby_columns:.   
+0000a220: 2020 2020 2020 2020 2069 6620 636f 6c75           if colu
+0000a230: 6d6e 2e75 7070 6572 2829 206e 6f74 2069  mn.upper() not i
+0000a240: 6e20 636f 6c75 6d6e 735f 696e 5f6c 6179  n columns_in_lay
+0000a250: 6572 5f75 7070 6572 3a0a 2020 2020 2020  er_upper:.      
+0000a260: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0000a270: 5661 6c75 6545 7272 6f72 280a 2020 2020  ValueError(.    
+0000a280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a290: 6622 636f 6c75 6d6e 2069 6e20 6772 6f75  f"column in grou
+0000a2a0: 7062 795f 636f 6c75 6d6e 7320 6e6f 7420  pby_columns not 
+0000a2b0: 6176 6169 6c61 626c 6520 696e 206c 6179  available in lay
+0000a2c0: 6572 3a20 7b63 6f6c 756d 6e7d 220a 2020  er: {column}".  
+0000a2d0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+0000a2e0: 2020 2020 2020 2020 636f 6c75 6d6e 735f          columns_
+0000a2f0: 6176 6169 6c61 626c 6520 3d20 5f67 656e  available = _gen
+0000a300: 6572 616c 5f75 7469 6c2e 616c 6967 6e5f  eral_util.align_
+0000a310: 6361 7369 6e67 5f6c 6973 7428 0a20 2020  casing_list(.   
+0000a320: 2020 2020 2020 2020 2063 6f6c 756d 6e73           columns
+0000a330: 5f61 7661 696c 6162 6c65 2c20 6772 6f75  _available, grou
+0000a340: 7062 795f 636f 6c75 6d6e 732c 2072 6169  pby_columns, rai
+0000a350: 7365 5f6f 6e5f 6d69 7373 696e 673d 4661  se_on_missing=Fa
+0000a360: 6c73 650a 2020 2020 2020 2020 290a 0a20  lse.        ).. 
+0000a370: 2020 2023 2043 6865 636b 2061 6767 5f63     # Check agg_c
+0000a380: 6f6c 756d 6e73 2070 6172 616d 0a20 2020  olumns param.   
+0000a390: 2069 6620 6167 675f 636f 6c75 6d6e 7320   if agg_columns 
+0000a3a0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+0000a3b0: 2020 2020 2023 2056 616c 6964 6174 6520       # Validate 
+0000a3c0: 7468 6520 6469 6374 2073 7472 7563 7475  the dict structu
+0000a3d0: 7265 2c20 736f 2077 6520 6361 6e20 6173  re, so we can as
+0000a3e0: 7375 6d65 2065 7665 7279 7468 696e 6720  sume everything 
+0000a3f0: 6973 204f 4b20 6675 7274 6865 7220 6f6e  is OK further on
+0000a400: 0a20 2020 2020 2020 205f 7061 7261 6d65  .        _parame
+0000a410: 7465 725f 6865 6c70 6572 2e76 616c 6964  ter_helper.valid
+0000a420: 6174 655f 6167 675f 636f 6c75 6d6e 7328  ate_agg_columns(
+0000a430: 6167 675f 636f 6c75 6d6e 7329 0a0a 2020  agg_columns)..  
+0000a440: 2020 2020 2020 2320 4669 7273 7420 7461        # First ta
+0000a450: 6b65 2061 2064 6565 7020 636f 7079 2c20  ke a deep copy, 
+0000a460: 6173 2076 616c 7565 7320 6361 6e20 6265  as values can be
+0000a470: 2063 6861 6e67 6564 2066 7572 7468 6572   changed further
+0000a480: 206f 6e20 746f 2074 7265 6174 2063 6f6c   on to treat col
+0000a490: 756d 6e73 0a20 2020 2020 2020 2023 2063  umns.        # c
+0000a4a0: 6173 6520 696e 7365 6e73 6974 6976 650a  ase insensitive.
+0000a4b0: 2020 2020 2020 2020 6167 675f 636f 6c75          agg_colu
+0000a4c0: 6d6e 7320 3d20 6a73 6f6e 2e6c 6f61 6473  mns = json.loads
+0000a4d0: 286a 736f 6e2e 6475 6d70 7328 6167 675f  (json.dumps(agg_
+0000a4e0: 636f 6c75 6d6e 7329 290a 2020 2020 2020  columns)).      
+0000a4f0: 2020 6173 7365 7274 2061 6767 5f63 6f6c    assert agg_col
+0000a500: 756d 6e73 2069 7320 6e6f 7420 4e6f 6e65  umns is not None
+0000a510: 0a20 2020 2020 2020 2069 6620 226a 736f  .        if "jso
+0000a520: 6e22 2069 6e20 6167 675f 636f 6c75 6d6e  n" in agg_column
+0000a530: 733a 0a20 2020 2020 2020 2020 2020 2069  s:.            i
+0000a540: 6620 6167 675f 636f 6c75 6d6e 735b 226a  f agg_columns["j
+0000a550: 736f 6e22 5d20 6973 204e 6f6e 653a 0a20  son"] is None:. 
+0000a560: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0000a570: 6767 5f63 6f6c 756d 6e73 5b22 6a73 6f6e  gg_columns["json
+0000a580: 225d 203d 205b 0a20 2020 2020 2020 2020  "] = [.         
+0000a590: 2020 2020 2020 2020 2020 2063 2066 6f72             c for
+0000a5a0: 2063 2069 6e20 636f 6c75 6d6e 735f 6176   c in columns_av
+0000a5b0: 6169 6c61 626c 6520 6966 2063 2e6c 6f77  ailable if c.low
+0000a5c0: 6572 2829 206e 6f74 2069 6e20 2822 696e  er() not in ("in
+0000a5d0: 6465 7822 2c20 2266 6964 2229 0a20 2020  dex", "fid").   
+0000a5e0: 2020 2020 2020 2020 2020 2020 205d 0a20               ]. 
+0000a5f0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0000a600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a610: 2023 2041 6c69 676e 2063 6173 696e 6720   # Align casing 
+0000a620: 6f66 2063 6f6c 756d 6e20 6e61 6d65 7320  of column names 
+0000a630: 746f 2064 6174 610a 2020 2020 2020 2020  to data.        
+0000a640: 2020 2020 2020 2020 6167 675f 636f 6c75          agg_colu
+0000a650: 6d6e 735b 226a 736f 6e22 5d20 3d20 5f67  mns["json"] = _g
+0000a660: 656e 6572 616c 5f75 7469 6c2e 616c 6967  eneral_util.alig
+0000a670: 6e5f 6361 7369 6e67 5f6c 6973 7428 0a20  n_casing_list(. 
+0000a680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a690: 2020 2061 6767 5f63 6f6c 756d 6e73 5b22     agg_columns["
+0000a6a0: 6a73 6f6e 225d 2c20 636f 6c75 6d6e 735f  json"], columns_
+0000a6b0: 6176 6169 6c61 626c 650a 2020 2020 2020  available.      
+0000a6c0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0000a6d0: 2020 2020 656c 6966 2022 636f 6c75 6d6e      elif "column
+0000a6e0: 7322 2069 6e20 6167 675f 636f 6c75 6d6e  s" in agg_column
+0000a6f0: 733a 0a20 2020 2020 2020 2020 2020 2023  s:.            #
+0000a700: 204c 6f6f 7020 7468 726f 7567 6820 616c   Loop through al
+0000a710: 6c20 726f 7773 0a20 2020 2020 2020 2020  l rows.         
+0000a720: 2020 2066 6f72 2061 6767 5f63 6f6c 756d     for agg_colum
+0000a730: 6e20 696e 2061 6767 5f63 6f6c 756d 6e73  n in agg_columns
+0000a740: 5b22 636f 6c75 6d6e 7322 5d3a 0a20 2020  ["columns"]:.   
+0000a750: 2020 2020 2020 2020 2020 2020 2023 2043               # C
+0000a760: 6865 636b 2069 6620 636f 6c75 6d6e 2065  heck if column e
+0000a770: 7869 7374 7320 2b20 7365 7420 6361 7369  xists + set casi
+0000a780: 6e67 2073 616d 6520 6173 2069 6e20 6461  ng same as in da
+0000a790: 7461 0a20 2020 2020 2020 2020 2020 2020  ta.             
+0000a7a0: 2020 2061 6767 5f63 6f6c 756d 6e5b 2263     agg_column["c
+0000a7b0: 6f6c 756d 6e22 5d20 3d20 5f67 656e 6572  olumn"] = _gener
+0000a7c0: 616c 5f75 7469 6c2e 616c 6967 6e5f 6361  al_util.align_ca
+0000a7d0: 7369 6e67 280a 2020 2020 2020 2020 2020  sing(.          
+0000a7e0: 2020 2020 2020 2020 2020 6167 675f 636f            agg_co
+0000a7f0: 6c75 6d6e 5b22 636f 6c75 6d6e 225d 2c20  lumn["column"], 
+0000a800: 636f 6c75 6d6e 735f 6176 6169 6c61 626c  columns_availabl
+0000a810: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+0000a820: 2020 290a 0a20 2020 2023 204e 6f77 2069    )..    # Now i
+0000a830: 6e70 7574 2070 6172 616d 6574 6572 7320  nput parameters 
+0000a840: 6172 6520 6368 6563 6b65 642c 2063 6865  are checked, che
+0000a850: 636b 2069 6620 7765 206e 6565 6420 746f  ck if we need to
+0000a860: 2063 616c 6375 6c61 7465 2061 6e79 7761   calculate anywa
+0000a870: 790a 2020 2020 6966 205f 696f 5f75 7469  y.    if _io_uti
+0000a880: 6c2e 6f75 7470 7574 5f65 7869 7374 7328  l.output_exists(
+0000a890: 7061 7468 3d6f 7574 7075 745f 7061 7468  path=output_path
+0000a8a0: 2c20 7265 6d6f 7665 5f69 665f 6578 6973  , remove_if_exis
+0000a8b0: 7473 3d66 6f72 6365 293a 0a20 2020 2020  ts=force):.     
+0000a8c0: 2020 2072 6574 7572 6e0a 0a20 2020 2023     return..    #
+0000a8d0: 204e 6f77 2073 7461 7274 2064 6973 736f   Now start disso
+0000a8e0: 6c76 696e 670a 2020 2020 2320 2d2d 2d2d  lving.    # ----
+0000a8f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0000a900: 0a20 2020 2023 2045 6d70 7479 206f 7220  .    # Empty or 
+0000a910: 4c69 6e65 2061 6e64 2070 6f69 6e74 206c  Line and point l
+0000a920: 6179 6572 7320 6172 653a 0a20 2020 2023  ayers are:.    #
+0000a930: 2020 202a 206e 6f74 2073 6f20 6c61 7267     * not so larg
+0000a940: 6520 286d 656d 6f72 792d 7769 7365 290a  e (memory-wise).
+0000a950: 2020 2020 2320 2020 2a20 6172 656e 2774      #   * aren't
+0000a960: 2063 6f6d 7075 7461 7469 6f6e 616c 6c79   computationally
+0000a970: 2068 6561 7679 0a20 2020 2023 2041 6464   heavy.    # Add
+0000a980: 6974 696f 6e61 6c6c 7920 6c69 6e65 206c  itionally line l
+0000a990: 6179 6572 7320 6172 6520 6120 7061 696e  ayers are a pain
+0000a9a0: 2074 6f20 6861 6e64 6c65 2063 6f72 7265   to handle corre
+0000a9b0: 6374 6c79 2062 6563 6175 7365 206f 660a  ctly because of.
+0000a9c0: 2020 2020 2320 726f 756e 6469 6e67 2069      # rounding i
+0000a9d0: 7373 7565 7320 6174 2074 6865 2062 6f72  ssues at the bor
+0000a9e0: 6465 7273 206f 6620 7469 6c65 732e 2e2e  ders of tiles...
+0000a9f0: 2073 6f20 6a75 7374 2064 6973 736f 6c76   so just dissolv
+0000aa00: 6520 7468 656d 2069 6e20 6f6e 6520 676f  e them in one go
+0000aa10: 2e0a 2020 2020 6966 2028 0a20 2020 2020  ..    if (.     
+0000aa20: 2020 2069 6e70 7574 5f6c 6179 6572 696e     input_layerin
+0000aa30: 666f 2e66 6561 7475 7265 636f 756e 7420  fo.featurecount 
+0000aa40: 3d3d 2030 0a20 2020 2020 2020 206f 7220  == 0.        or 
+0000aa50: 696e 7075 745f 6c61 7965 7269 6e66 6f2e  input_layerinfo.
+0000aa60: 6765 6f6d 6574 7279 7479 7065 2e74 6f5f  geometrytype.to_
+0000aa70: 7072 696d 6974 6976 6574 7970 650a 2020  primitivetype.  
+0000aa80: 2020 2020 2020 696e 205b 0a20 2020 2020        in [.     
+0000aa90: 2020 2020 2020 2050 7269 6d69 7469 7665         Primitive
+0000aaa0: 5479 7065 2e50 4f49 4e54 2c0a 2020 2020  Type.POINT,.    
+0000aab0: 2020 2020 2020 2020 5072 696d 6974 6976          Primitiv
+0000aac0: 6554 7970 652e 4c49 4e45 5354 5249 4e47  eType.LINESTRING
+0000aad0: 2c0a 2020 2020 2020 2020 5d0a 2020 2020  ,.        ].    
+0000aae0: 293a 0a20 2020 2020 2020 205f 6765 6f6f  ):.        _geoo
+0000aaf0: 7073 5f73 716c 2e64 6973 736f 6c76 655f  ps_sql.dissolve_
+0000ab00: 7369 6e67 6c65 7468 7265 6164 280a 2020  singlethread(.  
+0000ab10: 2020 2020 2020 2020 2020 696e 7075 745f            input_
+0000ab20: 7061 7468 3d69 6e70 7574 5f70 6174 682c  path=input_path,
+0000ab30: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
+0000ab40: 7075 745f 7061 7468 3d6f 7574 7075 745f  put_path=output_
+0000ab50: 7061 7468 2c0a 2020 2020 2020 2020 2020  path,.          
+0000ab60: 2020 6578 706c 6f64 6563 6f6c 6c65 6374    explodecollect
+0000ab70: 696f 6e73 3d65 7870 6c6f 6465 636f 6c6c  ions=explodecoll
+0000ab80: 6563 7469 6f6e 732c 0a20 2020 2020 2020  ections,.       
+0000ab90: 2020 2020 2067 726f 7570 6279 5f63 6f6c       groupby_col
+0000aba0: 756d 6e73 3d67 726f 7570 6279 5f63 6f6c  umns=groupby_col
+0000abb0: 756d 6e73 2c0a 2020 2020 2020 2020 2020  umns,.          
+0000abc0: 2020 6167 675f 636f 6c75 6d6e 733d 6167    agg_columns=ag
+0000abd0: 675f 636f 6c75 6d6e 732c 0a20 2020 2020  g_columns,.     
+0000abe0: 2020 2020 2020 2069 6e70 7574 5f6c 6179         input_lay
+0000abf0: 6572 3d69 6e70 7574 5f6c 6179 6572 2c0a  er=input_layer,.
+0000ac00: 2020 2020 2020 2020 2020 2020 6f75 7470              outp
+0000ac10: 7574 5f6c 6179 6572 3d6f 7574 7075 745f  ut_layer=output_
+0000ac20: 6c61 7965 722c 0a20 2020 2020 2020 2020  layer,.         
+0000ac30: 2020 2067 7269 6473 697a 653d 6772 6964     gridsize=grid
+0000ac40: 7369 7a65 2c0a 2020 2020 2020 2020 2020  size,.          
+0000ac50: 2020 6b65 6570 5f65 6d70 7479 5f67 656f    keep_empty_geo
+0000ac60: 6d73 3d46 616c 7365 2c0a 2020 2020 2020  ms=False,.      
+0000ac70: 2020 2020 2020 7768 6572 655f 706f 7374        where_post
+0000ac80: 3d77 6865 7265 5f70 6f73 742c 0a20 2020  =where_post,.   
+0000ac90: 2020 2020 2020 2020 2066 6f72 6365 3d66           force=f
+0000aca0: 6f72 6365 2c0a 2020 2020 2020 2020 290a  orce,.        ).
+0000acb0: 0a20 2020 2065 6c69 6620 696e 7075 745f  .    elif input_
+0000acc0: 6c61 7965 7269 6e66 6f2e 6765 6f6d 6574  layerinfo.geomet
+0000acd0: 7279 7479 7065 2e74 6f5f 7072 696d 6974  rytype.to_primit
+0000ace0: 6976 6574 7970 6520 6973 2050 7269 6d69  ivetype is Primi
+0000acf0: 7469 7665 5479 7065 2e50 4f4c 5947 4f4e  tiveType.POLYGON
+0000ad00: 3a0a 2020 2020 2020 2020 2320 5072 6570  :.        # Prep
+0000ad10: 6172 6520 7768 6572 655f 706f 7374 0a20  are where_post. 
+0000ad20: 2020 2020 2020 2069 6620 7768 6572 655f         if where_
+0000ad30: 706f 7374 2069 7320 6e6f 7420 4e6f 6e65  post is not None
+0000ad40: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+0000ad50: 2077 6865 7265 5f70 6f73 7420 3d3d 2022   where_post == "
+0000ad60: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
+0000ad70: 2020 2077 6865 7265 5f70 6f73 7420 3d20     where_post = 
+0000ad80: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+0000ad90: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0000ada0: 2020 2020 2020 2023 2053 6574 2067 656f         # Set geo
+0000adb0: 6d65 7472 7963 6f6c 756d 6e20 746f 2022  metrycolumn to "
+0000adc0: 6765 6f6d 222c 2062 6563 6175 7365 2074  geom", because t
+0000add0: 656d 7020 6669 6c65 7320 6172 6520 7361  emp files are sa
+0000ade0: 7665 6420 6173 2067 706b 672e 0a20 2020  ved as gpkg..   
+0000adf0: 2020 2020 2020 2020 2020 2020 2077 6865               whe
+0000ae00: 7265 5f70 6f73 7420 3d20 7768 6572 655f  re_post = where_
+0000ae10: 706f 7374 2e66 6f72 6d61 7428 6765 6f6d  post.format(geom
+0000ae20: 6574 7279 636f 6c75 6d6e 3d22 6765 6f6d  etrycolumn="geom
+0000ae30: 2229 0a0a 2020 2020 2020 2020 2320 4966  ")..        # If
+0000ae40: 2061 2074 696c 6573 5f70 6174 6820 6973   a tiles_path is
+0000ae50: 2073 7065 6369 6669 6564 2c20 7265 6164   specified, read
+0000ae60: 2074 686f 7365 2074 696c 6573 2e2e 2e0a   those tiles....
+0000ae70: 2020 2020 2020 2020 7265 7375 6c74 5f74          result_t
+0000ae80: 696c 6573 5f67 6466 203d 204e 6f6e 650a  iles_gdf = None.
+0000ae90: 2020 2020 2020 2020 6966 2074 696c 6573          if tiles
+0000aea0: 5f70 6174 6820 6973 206e 6f74 204e 6f6e  _path is not Non
+0000aeb0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+0000aec0: 6573 756c 745f 7469 6c65 735f 6764 6620  esult_tiles_gdf 
+0000aed0: 3d20 6766 6f2e 7265 6164 5f66 696c 6528  = gfo.read_file(
+0000aee0: 7469 6c65 735f 7061 7468 290a 2020 2020  tiles_path).    
+0000aef0: 2020 2020 2020 2020 6966 206e 625f 7061          if nb_pa
+0000af00: 7261 6c6c 656c 203d 3d20 2d31 3a0a 2020  rallel == -1:.  
+0000af10: 2020 2020 2020 2020 2020 2020 2020 6e62                nb
+0000af20: 5f63 7075 203d 206d 756c 7469 7072 6f63  _cpu = multiproc
+0000af30: 6573 7369 6e67 2e63 7075 5f63 6f75 6e74  essing.cpu_count
+0000af40: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+0000af50: 2020 206e 625f 7061 7261 6c6c 656c 203d     nb_parallel =
+0000af60: 206e 625f 6370 7520 2023 2069 6e74 2831   nb_cpu  # int(1
+0000af70: 2e32 3520 2a20 6e62 5f63 7075 290a 2020  .25 * nb_cpu).  
+0000af80: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+0000af90: 6767 6572 2e64 6562 7567 2866 224e 6220  gger.debug(f"Nb 
+0000afa0: 6370 7573 2066 6f75 6e64 3a20 7b6e 625f  cpus found: {nb_
+0000afb0: 6370 757d 2c20 6e62 5f70 6172 616c 6c65  cpu}, nb_paralle
+0000afc0: 6c3a 207b 6e62 5f70 6172 616c 6c65 6c7d  l: {nb_parallel}
+0000afd0: 2229 0a20 2020 2020 2020 2065 6c73 653a  ").        else:
+0000afe0: 0a20 2020 2020 2020 2020 2020 2023 2045  .            # E
+0000aff0: 6c73 652c 2063 7265 6174 6520 6120 6772  lse, create a gr
+0000b000: 6964 2062 6173 6564 206f 6e20 7468 6520  id based on the 
+0000b010: 6e75 6d62 6572 206f 6620 7469 6c65 7320  number of tiles 
+0000b020: 7761 6e74 6564 2061 7320 7265 7375 6c74  wanted as result
+0000b030: 0a20 2020 2020 2020 2020 2020 2023 2055  .            # U
+0000b040: 7365 2061 206d 6172 6769 6e20 6f66 2031  se a margin of 1
+0000b050: 206d 6574 6572 2061 726f 756e 6420 7468   meter around th
+0000b060: 6520 626f 756e 6473 0a20 2020 2020 2020  e bounds.       
+0000b070: 2020 2020 206d 6172 6769 6e20 3d20 312e       margin = 1.
+0000b080: 300a 2020 2020 2020 2020 2020 2020 6966  0.            if
+0000b090: 2069 6e70 7574 5f6c 6179 6572 696e 666f   input_layerinfo
+0000b0a0: 2e63 7273 2069 7320 6e6f 7420 4e6f 6e65  .crs is not None
+0000b0b0: 2061 6e64 206e 6f74 2069 6e70 7574 5f6c   and not input_l
+0000b0c0: 6179 6572 696e 666f 2e63 7273 2e69 735f  ayerinfo.crs.is_
+0000b0d0: 7072 6f6a 6563 7465 643a 0a20 2020 2020  projected:.     
+0000b0e0: 2020 2020 2020 2020 2020 2023 2049 6620             # If 
+0000b0f0: 6765 6f67 7261 7068 6963 2063 7273 2c20  geographic crs, 
+0000b100: 3120 6465 6772 6565 203d 2031 3131 206b  1 degree = 111 k
+0000b110: 6d20 6f72 2031 3131 3030 3020 6d0a 2020  m or 111000 m.  
+0000b120: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
+0000b130: 7267 696e 202f 3d20 3131 3130 3030 0a20  rgin /= 111000. 
+0000b140: 2020 2020 2020 2020 2020 2062 6f75 6e64             bound
+0000b150: 7320 3d20 696e 7075 745f 6c61 7965 7269  s = input_layeri
+0000b160: 6e66 6f2e 746f 7461 6c5f 626f 756e 6473  nfo.total_bounds
+0000b170: 0a20 2020 2020 2020 2020 2020 2062 6f75  .            bou
+0000b180: 6e64 7320 3d20 280a 2020 2020 2020 2020  nds = (.        
+0000b190: 2020 2020 2020 2020 626f 756e 6473 5b30          bounds[0
+0000b1a0: 5d20 2d20 6d61 7267 696e 2c0a 2020 2020  ] - margin,.    
+0000b1b0: 2020 2020 2020 2020 2020 2020 626f 756e              boun
+0000b1c0: 6473 5b31 5d20 2d20 6d61 7267 696e 2c0a  ds[1] - margin,.
+0000b1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b1e0: 626f 756e 6473 5b32 5d20 2b20 6d61 7267  bounds[2] + marg
+0000b1f0: 696e 2c0a 2020 2020 2020 2020 2020 2020  in,.            
+0000b200: 2020 2020 626f 756e 6473 5b33 5d20 2b20      bounds[3] + 
+0000b210: 6d61 7267 696e 2c0a 2020 2020 2020 2020  margin,.        
+0000b220: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+0000b230: 2020 7265 7375 6c74 5f74 696c 6573 5f67    result_tiles_g
+0000b240: 6466 203d 2067 7064 2e47 656f 4461 7461  df = gpd.GeoData
+0000b250: 4672 616d 6528 0a20 2020 2020 2020 2020  Frame(.         
+0000b260: 2020 2020 2020 2067 656f 6d65 7472 793d         geometry=
+0000b270: 7079 6765 6f6f 7073 2e63 7265 6174 655f  pygeoops.create_
+0000b280: 6772 6964 3228 626f 756e 6473 2c20 6e62  grid2(bounds, nb
+0000b290: 5f73 7175 6172 6973 685f 7469 6c65 7329  _squarish_tiles)
+0000b2a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000b2b0: 2020 6372 733d 696e 7075 745f 6c61 7965    crs=input_laye
+0000b2c0: 7269 6e66 6f2e 6372 732c 0a20 2020 2020  rinfo.crs,.     
+0000b2d0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+0000b2e0: 2020 2320 4170 706c 7920 6772 6964 7369    # Apply gridsi
+0000b2f0: 7a65 2074 6f6c 6572 616e 6365 206f 6e20  ze tolerance on 
+0000b300: 7469 6c65 732c 206f 7468 6572 7769 7365  tiles, otherwise
+0000b310: 2074 6865 2062 6f72 6465 7220 706f 6c79   the border poly
+0000b320: 676f 6e73 2063 616e 2774 2062 650a 2020  gons can't be.  
+0000b330: 2020 2020 2020 2320 756e 696f 6e65 6420        # unioned 
+0000b340: 7072 6f70 6572 6c79 2062 6563 6175 7365  properly because
+0000b350: 2067 6170 7320 6170 7065 6172 2061 6674   gaps appear aft
+0000b360: 6572 2072 6f75 6e64 696e 6720 636f 6f72  er rounding coor
+0000b370: 6469 6e61 7465 732e 0a20 2020 2020 2020  dinates..       
+0000b380: 2069 6620 6772 6964 7369 7a65 2021 3d20   if gridsize != 
+0000b390: 302e 303a 0a20 2020 2020 2020 2020 2020  0.0:.           
+0000b3a0: 2072 6573 756c 745f 7469 6c65 735f 6764   result_tiles_gd
+0000b3b0: 662e 6765 6f6d 6574 7279 203d 2073 6861  f.geometry = sha
+0000b3c0: 7065 6c79 2e73 6574 5f70 7265 6369 7369  pely.set_precisi
+0000b3d0: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
+0000b3e0: 2020 2020 7265 7375 6c74 5f74 696c 6573      result_tiles
+0000b3f0: 5f67 6466 2e67 656f 6d65 7472 792c 2067  _gdf.geometry, g
+0000b400: 7269 645f 7369 7a65 3d67 7269 6473 697a  rid_size=gridsiz
+0000b410: 650a 2020 2020 2020 2020 2020 2020 290a  e.            ).
+0000b420: 2020 2020 2020 2020 6966 206c 656e 2872          if len(r
+0000b430: 6573 756c 745f 7469 6c65 735f 6764 6629  esult_tiles_gdf)
+0000b440: 203e 2031 3a0a 2020 2020 2020 2020 2020   > 1:.          
+0000b450: 2020 6766 6f2e 746f 5f66 696c 6528 0a20    gfo.to_file(. 
+0000b460: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0000b470: 6573 756c 745f 7469 6c65 735f 6764 662c  esult_tiles_gdf,
+0000b480: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b490: 206f 7574 7075 745f 7061 7468 2e70 6172   output_path.par
+0000b4a0: 656e 7420 2f20 6622 7b6f 7574 7075 745f  ent / f"{output_
+0000b4b0: 7061 7468 2e73 7465 6d7d 5f74 696c 6573  path.stem}_tiles
+0000b4c0: 2e67 706b 6722 2c0a 2020 2020 2020 2020  .gpkg",.        
+0000b4d0: 2020 2020 290a 0a20 2020 2020 2020 2023      )..        #
+0000b4e0: 2049 6620 6120 7469 6c65 6420 7265 7375   If a tiled resu
+0000b4f0: 6c74 2069 7320 6173 6b65 642c 2061 6464  lt is asked, add
+0000b500: 2074 696c 655f 6964 2074 6f20 6772 6f75   tile_id to grou
+0000b510: 7020 6f6e 2066 6f72 2074 6865 2072 6573  p on for the res
+0000b520: 756c 740a 2020 2020 2020 2020 6966 206c  ult.        if l
+0000b530: 656e 2872 6573 756c 745f 7469 6c65 735f  en(result_tiles_
+0000b540: 6764 6629 203e 2031 3a0a 2020 2020 2020  gdf) > 1:.      
+0000b550: 2020 2020 2020 7265 7375 6c74 5f74 696c        result_til
+0000b560: 6573 5f67 6466 5b22 7469 6c65 5f69 6422  es_gdf["tile_id"
+0000b570: 5d20 3d20 7265 7375 6c74 5f74 696c 6573  ] = result_tiles
+0000b580: 5f67 6466 2e72 6573 6574 5f69 6e64 6578  _gdf.reset_index
+0000b590: 2829 2e69 6e64 6578 0a0a 2020 2020 2020  ().index..      
+0000b5a0: 2020 2320 5468 6520 6469 7373 6f6c 7665    # The dissolve
+0000b5b0: 2066 6f72 2070 6f6c 7967 6f6e 7320 6973   for polygons is
+0000b5c0: 2064 6f6e 6520 696e 2073 6576 6572 616c   done in several
+0000b5d0: 2070 6173 7365 732c 2061 6e64 2061 6674   passes, and aft
+0000b5e0: 6572 2074 6865 2066 6972 7374 0a20 2020  er the first.   
+0000b5f0: 2020 2020 2023 2070 6173 732c 206f 6e6c       # pass, onl
+0000b600: 7920 7468 6520 276f 6e62 6f72 6465 7227  y the 'onborder'
+0000b610: 2066 6561 7475 7265 7320 6172 6520 6675   features are fu
+0000b620: 7274 6865 7220 6469 7373 6f6c 7665 642c  rther dissolved,
+0000b630: 2061 7320 7468 650a 2020 2020 2020 2020   as the.        
+0000b640: 2320 276e 6f74 6f6e 626f 7264 6572 2720  # 'notonborder' 
+0000b650: 6665 6174 7572 6573 2061 7265 2061 6c72  features are alr
+0000b660: 6561 6479 204f 4b2e 0a20 2020 2020 2020  eady OK..       
+0000b670: 2074 656d 7064 6972 203d 205f 696f 5f75   tempdir = _io_u
+0000b680: 7469 6c2e 6372 6561 7465 5f74 656d 7064  til.create_tempd
+0000b690: 6972 2866 2267 656f 6669 6c65 6f70 732f  ir(f"geofileops/
+0000b6a0: 7b6f 7065 7261 7469 6f6e 5f6e 616d 657d  {operation_name}
+0000b6b0: 2229 0a20 2020 2020 2020 2074 7279 3a0a  ").        try:.
+0000b6c0: 2020 2020 2020 2020 2020 2020 6966 206f              if o
+0000b6d0: 7574 7075 745f 6c61 7965 7220 6973 204e  utput_layer is N
+0000b6e0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0000b6f0: 2020 2020 206f 7574 7075 745f 6c61 7965       output_laye
+0000b700: 7220 3d20 6766 6f2e 6765 745f 6465 6661  r = gfo.get_defa
+0000b710: 756c 745f 6c61 7965 7228 6f75 7470 7574  ult_layer(output
+0000b720: 5f70 6174 6829 0a20 2020 2020 2020 2020  _path).         
+0000b730: 2020 206f 7574 7075 745f 746d 705f 7061     output_tmp_pa
+0000b740: 7468 203d 2074 656d 7064 6972 202f 2022  th = tempdir / "
+0000b750: 6f75 7470 7574 5f74 6d70 2e67 706b 6722  output_tmp.gpkg"
+0000b760: 0a20 2020 2020 2020 2020 2020 2070 7265  .            pre
+0000b770: 765f 6e62 5f62 6174 6368 6573 203d 204e  v_nb_batches = N
+0000b780: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+0000b790: 6c61 7374 5f70 6173 7320 3d20 4661 6c73  last_pass = Fals
+0000b7a0: 650a 2020 2020 2020 2020 2020 2020 7061  e.            pa
+0000b7b0: 7373 5f69 6420 3d20 300a 2020 2020 2020  ss_id = 0.      
+0000b7c0: 2020 2020 2020 6c6f 6767 6572 2e69 6e66        logger.inf
+0000b7d0: 6f28 6622 5374 6172 742c 2077 6974 6820  o(f"Start, with 
+0000b7e0: 696e 7075 7420 7b69 6e70 7574 5f70 6174  input {input_pat
+0000b7f0: 687d 2229 0a20 2020 2020 2020 2020 2020  h}").           
+0000b800: 2069 6e70 7574 5f70 6173 735f 6c61 7965   input_pass_laye
+0000b810: 723a 204f 7074 696f 6e61 6c5b 7374 725d  r: Optional[str]
+0000b820: 203d 2069 6e70 7574 5f6c 6179 6572 0a20   = input_layer. 
+0000b830: 2020 2020 2020 2020 2020 2077 6869 6c65             while
+0000b840: 2054 7275 653a 0a20 2020 2020 2020 2020   True:.         
+0000b850: 2020 2020 2020 2023 2049 6620 696e 7075         # If inpu
+0000b860: 745f 7061 7468 2064 6f65 7320 6e6f 7420  t_path does not 
+0000b870: 6578 6973 742c 2074 6865 206c 6173 7420  exist, the last 
+0000b880: 7061 7373 2064 6964 6e27 7420 6861 7665  pass didn't have
+0000b890: 2061 6e79 206f 6e62 6f72 6465 720a 2020   any onborder.  
+0000b8a0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0000b8b0: 706f 6c79 676f 6e73 2061 7320 7265 7375  polygons as resu
+0000b8c0: 6c74 2c20 736f 2077 6520 6172 6520 7265  lt, so we are re
+0000b8d0: 6164 7920 6469 7373 6f6c 7669 6e67 2e2e  ady dissolving..
+0000b8e0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000b8f0: 2020 6966 206e 6f74 2069 6e70 7574 5f70    if not input_p
+0000b900: 6174 682e 6578 6973 7473 2829 3a0a 2020  ath.exists():.  
+0000b910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b920: 2020 6272 6561 6b0a 0a20 2020 2020 2020    break..       
+0000b930: 2020 2020 2020 2020 2023 2047 6574 2069           # Get i
+0000b940: 6e66 6f20 6f66 2074 6865 2063 7572 7265  nfo of the curre
+0000b950: 6e74 2066 696c 6520 7468 6174 206e 6565  nt file that nee
+0000b960: 6473 2074 6f20 6265 2064 6973 736f 6c76  ds to be dissolv
+0000b970: 6564 0a20 2020 2020 2020 2020 2020 2020  ed.             
+0000b980: 2020 2069 6e70 7574 5f70 6173 735f 6c61     input_pass_la
+0000b990: 7965 7269 6e66 6f20 3d20 6766 6f2e 6765  yerinfo = gfo.ge
+0000b9a0: 745f 6c61 7965 7269 6e66 6f28 696e 7075  t_layerinfo(inpu
+0000b9b0: 745f 7061 7468 2c20 696e 7075 745f 7061  t_path, input_pa
+0000b9c0: 7373 5f6c 6179 6572 290a 2020 2020 2020  ss_layer).      
+0000b9d0: 2020 2020 2020 2020 2020 6e62 5f72 6f77            nb_row
+0000b9e0: 735f 746f 7461 6c20 3d20 696e 7075 745f  s_total = input_
+0000b9f0: 7061 7373 5f6c 6179 6572 696e 666f 2e66  pass_layerinfo.f
+0000ba00: 6561 7475 7265 636f 756e 740a 0a20 2020  eaturecount..   
+0000ba10: 2020 2020 2020 2020 2020 2020 2023 2043               # C
+0000ba20: 616c 6375 6c61 7465 2074 6865 2062 6573  alculate the bes
+0000ba30: 7420 6e75 6d62 6572 206f 6620 7061 7261  t number of para
+0000ba40: 6c6c 656c 2070 726f 6365 7373 6573 2061  llel processes a
+0000ba50: 6e64 2062 6174 6368 6573 2066 6f72 0a20  nd batches for. 
+0000ba60: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0000ba70: 2074 6865 2061 7661 696c 6162 6c65 2072   the available r
+0000ba80: 6573 6f75 7263 6573 2066 6f72 2074 6865  esources for the
+0000ba90: 2063 7572 7265 6e74 2070 6173 730a 2020   current pass.  
+0000baa0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0000bab0: 4c69 6d69 7420 7468 6520 6e62 206f 6620  Limit the nb of 
+0000bac0: 726f 7773 2070 6572 2062 6174 6368 2c20  rows per batch, 
+0000bad0: 6173 2064 6973 736f 6c76 6520 736c 6f77  as dissolve slow
+0000bae0: 7320 646f 776e 2077 6974 6820 6d6f 7265  s down with more
+0000baf0: 2072 6f77 732e 0a20 2020 2020 2020 2020   rows..         
+0000bb00: 2020 2020 2020 206e 625f 7061 7261 6c6c         nb_parall
+0000bb10: 656c 2c20 6e62 5f62 6174 6368 6573 203d  el, nb_batches =
+0000bb20: 205f 6465 7465 726d 696e 655f 6e62 5f62   _determine_nb_b
+0000bb30: 6174 6368 6573 280a 2020 2020 2020 2020  atches(.        
+0000bb40: 2020 2020 2020 2020 2020 2020 6e62 5f72              nb_r
+0000bb50: 6f77 735f 746f 7461 6c3d 6e62 5f72 6f77  ows_total=nb_row
+0000bb60: 735f 746f 7461 6c2c 0a20 2020 2020 2020  s_total,.       
+0000bb70: 2020 2020 2020 2020 2020 2020 206e 625f               nb_
+0000bb80: 7061 7261 6c6c 656c 3d6e 625f 7061 7261  parallel=nb_para
+0000bb90: 6c6c 656c 2c0a 2020 2020 2020 2020 2020  llel,.          
+0000bba0: 2020 2020 2020 2020 2020 6261 7463 6873            batchs
+0000bbb0: 697a 653d 6261 7463 6873 697a 652c 0a20  ize=batchsize,. 
+0000bbc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bbd0: 2020 2070 6172 616c 6c65 6c69 7a61 7469     parallelizati
+0000bbe0: 6f6e 5f63 6f6e 6669 673d 5061 7261 6c6c  on_config=Parall
+0000bbf0: 656c 697a 6174 696f 6e43 6f6e 6669 6728  elizationConfig(
+0000bc00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000bc10: 2020 2020 2020 2020 206d 6178 5f72 6f77           max_row
+0000bc20: 735f 7065 725f 6261 7463 683d 3130 3030  s_per_batch=1000
+0000bc30: 300a 2020 2020 2020 2020 2020 2020 2020  0.              
+0000bc40: 2020 2020 2020 292c 0a20 2020 2020 2020        ),.       
+0000bc50: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+0000bc60: 2020 2020 2020 2020 2020 2020 2320 4966              # If
+0000bc70: 2074 6865 2069 6465 616c 206e 756d 6265   the ideal numbe
+0000bc80: 7220 6f66 2062 6174 6368 6573 2069 7320  r of batches is 
+0000bc90: 636c 6f73 6520 746f 2074 6865 206e 622e  close to the nb.
+0000bca0: 2072 6573 756c 7420 7469 6c65 7320 6173   result tiles as
+0000bcb0: 6b65 642c 0a20 2020 2020 2020 2020 2020  ked,.           
+0000bcc0: 2020 2020 2023 2064 6973 736f 6c76 6520       # dissolve 
+0000bcd0: 746f 7761 7264 7320 7468 6520 6173 6b65  towards the aske
+0000bce0: 6420 7265 7375 6c74 210a 2020 2020 2020  d result!.      
+0000bcf0: 2020 2020 2020 2020 2020 2320 4966 206e            # If n
+0000bd00: 6f74 2c20 6120 7465 6d70 6f72 6172 7920  ot, a temporary 
+0000bd10: 7265 7375 6c74 2069 7320 6372 6561 7465  result is create
+0000bd20: 6420 7573 696e 6720 736d 616c 6c65 7220  d using smaller 
+0000bd30: 7469 6c65 730a 2020 2020 2020 2020 2020  tiles.          
+0000bd40: 2020 2020 2020 6966 206e 625f 6261 7463        if nb_batc
+0000bd50: 6865 7320 3c3d 206c 656e 2872 6573 756c  hes <= len(resul
+0000bd60: 745f 7469 6c65 735f 6764 6629 202a 2031  t_tiles_gdf) * 1
+0000bd70: 2e31 3a0a 2020 2020 2020 2020 2020 2020  .1:.            
+0000bd80: 2020 2020 2020 2020 7469 6c65 735f 6764          tiles_gd
+0000bd90: 6620 3d20 7265 7375 6c74 5f74 696c 6573  f = result_tiles
+0000bda0: 5f67 6466 0a20 2020 2020 2020 2020 2020  _gdf.           
+0000bdb0: 2020 2020 2020 2020 206c 6173 745f 7061           last_pa
+0000bdc0: 7373 203d 2054 7275 650a 2020 2020 2020  ss = True.      
+0000bdd0: 2020 2020 2020 2020 2020 2020 2020 6e62                nb
+0000bde0: 5f70 6172 616c 6c65 6c20 3d20 6d69 6e28  _parallel = min(
+0000bdf0: 6c65 6e28 7265 7375 6c74 5f74 696c 6573  len(result_tiles
+0000be00: 5f67 6466 292c 206e 625f 7061 7261 6c6c  _gdf), nb_parall
+0000be10: 656c 290a 2020 2020 2020 2020 2020 2020  el).            
+0000be20: 2020 2020 656c 6966 206c 656e 2872 6573      elif len(res
+0000be30: 756c 745f 7469 6c65 735f 6764 6629 203d  ult_tiles_gdf) =
+0000be40: 3d20 313a 0a20 2020 2020 2020 2020 2020  = 1:.           
+0000be50: 2020 2020 2020 2020 2023 2043 7265 6174           # Creat
+0000be60: 6520 6120 6772 6964 2062 6173 6564 206f  e a grid based o
+0000be70: 6e20 7468 6520 6964 6561 6c20 6e75 6d62  n the ideal numb
+0000be80: 6572 206f 6620 6261 7463 6865 732c 2062  er of batches, b
+0000be90: 7574 206d 616b 650a 2020 2020 2020 2020  ut make.        
+0000bea0: 2020 2020 2020 2020 2020 2020 2320 7375              # su
+0000beb0: 7265 2074 6865 206e 756d 6265 7220 6973  re the number is
+0000bec0: 2073 6d61 6c6c 6572 2074 6861 6e20 7468   smaller than th
+0000bed0: 6520 6d61 7869 6d75 6d2e 2e2e 0a20 2020  e maximum....   
+0000bee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bef0: 206e 625f 7371 7561 7269 7368 5f74 696c   nb_squarish_til
+0000bf00: 6573 5f6d 6178 203d 204e 6f6e 650a 2020  es_max = None.  
+0000bf10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bf20: 2020 6966 2070 7265 765f 6e62 5f62 6174    if prev_nb_bat
+0000bf30: 6368 6573 2069 7320 6e6f 7420 4e6f 6e65  ches is not None
+0000bf40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000bf50: 2020 2020 2020 2020 2020 6e62 5f73 7175            nb_squ
+0000bf60: 6172 6973 685f 7469 6c65 735f 6d61 7820  arish_tiles_max 
+0000bf70: 3d20 6d61 7828 7072 6576 5f6e 625f 6261  = max(prev_nb_ba
+0000bf80: 7463 6865 7320 2d20 312c 2031 290a 2020  tches - 1, 1).  
+0000bf90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bfa0: 2020 2020 2020 6e62 5f62 6174 6368 6573        nb_batches
+0000bfb0: 203d 206d 696e 286e 625f 6261 7463 6865   = min(nb_batche
+0000bfc0: 732c 206e 625f 7371 7561 7269 7368 5f74  s, nb_squarish_t
+0000bfd0: 696c 6573 5f6d 6178 290a 2020 2020 2020  iles_max).      
+0000bfe0: 2020 2020 2020 2020 2020 2020 2020 6772                gr
+0000bff0: 6964 5f74 6f74 616c 5f62 6f75 6e64 7320  id_total_bounds 
+0000c000: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
+0000c010: 2020 2020 2020 2020 2020 2020 696e 7075              inpu
+0000c020: 745f 7061 7373 5f6c 6179 6572 696e 666f  t_pass_layerinfo
+0000c030: 2e74 6f74 616c 5f62 6f75 6e64 735b 305d  .total_bounds[0]
+0000c040: 202d 2030 2e30 3030 3030 312c 0a20 2020   - 0.000001,.   
 0000c050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c060: 2020 2020 2020 2020 6e62 5f62 6174 6368          nb_batch
-0000c070: 6573 203d 206d 696e 286e 625f 6261 7463  es = min(nb_batc
-0000c080: 6865 732c 206e 625f 7371 7561 7269 7368  hes, nb_squarish
-0000c090: 5f74 696c 6573 5f6d 6178 290a 2020 2020  _tiles_max).    
-0000c0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c0b0: 6772 6964 5f74 6f74 616c 5f62 6f75 6e64  grid_total_bound
-0000c0c0: 7320 3d20 280a 2020 2020 2020 2020 2020  s = (.          
-0000c0d0: 2020 2020 2020 2020 2020 2020 2020 696e                in
-0000c0e0: 7075 745f 7061 7373 5f6c 6179 6572 696e  put_pass_layerin
-0000c0f0: 666f 2e74 6f74 616c 5f62 6f75 6e64 735b  fo.total_bounds[
-0000c100: 305d 202d 2030 2e30 3030 3030 312c 0a20  0] - 0.000001,. 
-0000c110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c120: 2020 2020 2020 2069 6e70 7574 5f70 6173         input_pas
-0000c130: 735f 6c61 7965 7269 6e66 6f2e 746f 7461  s_layerinfo.tota
-0000c140: 6c5f 626f 756e 6473 5b31 5d20 2d20 302e  l_bounds[1] - 0.
-0000c150: 3030 3030 3031 2c0a 2020 2020 2020 2020  000001,.        
-0000c160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c170: 696e 7075 745f 7061 7373 5f6c 6179 6572  input_pass_layer
-0000c180: 696e 666f 2e74 6f74 616c 5f62 6f75 6e64  info.total_bound
-0000c190: 735b 325d 202b 2030 2e30 3030 3030 312c  s[2] + 0.000001,
-0000c1a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c1b0: 2020 2020 2020 2020 2069 6e70 7574 5f70           input_p
-0000c1c0: 6173 735f 6c61 7965 7269 6e66 6f2e 746f  ass_layerinfo.to
-0000c1d0: 7461 6c5f 626f 756e 6473 5b33 5d20 2b20  tal_bounds[3] + 
-0000c1e0: 302e 3030 3030 3031 2c0a 2020 2020 2020  0.000001,.      
-0000c1f0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0000c200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c210: 2020 2020 7469 6c65 735f 6764 6620 3d20      tiles_gdf = 
-0000c220: 6770 642e 4765 6f44 6174 6146 7261 6d65  gpd.GeoDataFrame
-0000c230: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000c240: 2020 2020 2020 2020 2020 6765 6f6d 6574            geomet
-0000c250: 7279 3d70 7967 656f 6f70 732e 6372 6561  ry=pygeoops.crea
-0000c260: 7465 5f67 7269 6432 280a 2020 2020 2020  te_grid2(.      
-0000c270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c280: 2020 2020 2020 746f 7461 6c5f 626f 756e        total_boun
-0000c290: 6473 3d67 7269 645f 746f 7461 6c5f 626f  ds=grid_total_bo
-0000c2a0: 756e 6473 2c0a 2020 2020 2020 2020 2020  unds,.          
-0000c2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c2c0: 2020 6e62 5f73 7175 6172 6973 685f 7469    nb_squarish_ti
-0000c2d0: 6c65 733d 6e62 5f62 6174 6368 6573 2c0a  les=nb_batches,.
-0000c2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c2f0: 2020 2020 2020 2020 2020 2020 6e62 5f73              nb_s
-0000c300: 7175 6172 6973 685f 7469 6c65 735f 6d61  quarish_tiles_ma
-0000c310: 783d 6e62 5f73 7175 6172 6973 685f 7469  x=nb_squarish_ti
-0000c320: 6c65 735f 6d61 782c 0a20 2020 2020 2020  les_max,.       
-0000c330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c340: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
-0000c350: 2020 2020 2020 2020 2020 2020 6372 733d              crs=
-0000c360: 696e 7075 745f 7061 7373 5f6c 6179 6572  input_pass_layer
-0000c370: 696e 666f 2e63 7273 2c0a 2020 2020 2020  info.crs,.      
-0000c380: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0000c390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c3a0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0000c3b0: 2020 2020 2020 2020 2020 2320 4966 2061            # If a
-0000c3c0: 2067 7269 6420 6973 2073 7065 6369 6669   grid is specifi
-0000c3d0: 6564 2061 6c72 6561 6479 2c20 6164 6420  ed already, add 
-0000c3e0: 6578 7472 6120 636f 6c75 6d6e 732f 726f  extra columns/ro
-0000c3f0: 7773 2069 6e73 7465 6164 206f 660a 2020  ws instead of.  
-0000c400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c410: 2020 2320 6372 6561 7469 6e67 206e 6577    # creating new
-0000c420: 206f 6e65 2e2e 2e0a 2020 2020 2020 2020   one....        
-0000c430: 2020 2020 2020 2020 2020 2020 7469 6c65              tile
-0000c440: 735f 6764 6620 3d20 7079 6765 6f6f 7073  s_gdf = pygeoops
-0000c450: 2e73 706c 6974 5f74 696c 6573 2872 6573  .split_tiles(res
-0000c460: 756c 745f 7469 6c65 735f 6764 662c 206e  ult_tiles_gdf, n
-0000c470: 625f 6261 7463 6865 7329 0a0a 2020 2020  b_batches)..    
-0000c480: 2020 2020 2020 2020 2020 2020 2320 4170              # Ap
-0000c490: 706c 7920 6772 6964 7369 7a65 2074 6f6c  ply gridsize tol
-0000c4a0: 6572 616e 6365 206f 6e20 7469 6c65 732c  erance on tiles,
-0000c4b0: 206f 7468 6572 7769 7365 2074 6865 2062   otherwise the b
-0000c4c0: 6f72 6465 7220 706f 6c79 676f 6e73 2063  order polygons c
-0000c4d0: 616e 2774 0a20 2020 2020 2020 2020 2020  an't.           
-0000c4e0: 2020 2020 2023 2062 6520 756e 696f 6e65       # be unione
-0000c4f0: 6420 7072 6f70 6572 6c79 2062 6563 6175  d properly becau
-0000c500: 7365 2067 6170 7320 6170 7065 6172 2061  se gaps appear a
-0000c510: 6674 6572 2072 6f75 6e64 696e 6720 636f  fter rounding co
-0000c520: 6f72 6469 6e61 7465 732e 0a20 2020 2020  ordinates..     
-0000c530: 2020 2020 2020 2020 2020 2069 6620 6772             if gr
-0000c540: 6964 7369 7a65 2021 3d20 302e 303a 0a20  idsize != 0.0:. 
-0000c550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c560: 2020 2074 696c 6573 5f67 6466 2e67 656f     tiles_gdf.geo
-0000c570: 6d65 7472 7920 3d20 7368 6170 656c 792e  metry = shapely.
-0000c580: 7365 745f 7072 6563 6973 696f 6e28 0a20  set_precision(. 
-0000c590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c5a0: 2020 2020 2020 2074 696c 6573 5f67 6466         tiles_gdf
-0000c5b0: 2e67 656f 6d65 7472 792c 2067 7269 645f  .geometry, grid_
-0000c5c0: 7369 7a65 3d67 7269 6473 697a 650a 2020  size=gridsize.  
-0000c5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c5e0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0000c5f0: 2020 2020 6766 6f2e 746f 5f66 696c 6528      gfo.to_file(
-0000c600: 7469 6c65 735f 6764 662c 2074 656d 7064  tiles_gdf, tempd
-0000c610: 6972 202f 2066 226f 7574 7075 745f 7b70  ir / f"output_{p
-0000c620: 6173 735f 6964 7d5f 7469 6c65 732e 6770  ass_id}_tiles.gp
-0000c630: 6b67 2229 0a0a 2020 2020 2020 2020 2020  kg")..          
-0000c640: 2020 2020 2020 2320 4966 2074 6865 206e        # If the n
-0000c650: 756d 6265 7220 6f66 2074 696c 6573 2065  umber of tiles e
-0000c660: 6e64 7320 7570 2061 7320 312c 2069 7420  nds up as 1, it 
-0000c670: 6973 2074 6865 206c 6173 7420 7061 7373  is the last pass
-0000c680: 2061 6e79 7761 792e 2e2e 0a20 2020 2020   anyway....     
-0000c690: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
-0000c6a0: 6e28 7469 6c65 735f 6764 6629 203d 3d20  n(tiles_gdf) == 
-0000c6b0: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
-0000c6c0: 2020 2020 2020 206c 6173 745f 7061 7373         last_pass
-0000c6d0: 203d 2054 7275 650a 0a20 2020 2020 2020   = True..       
-0000c6e0: 2020 2020 2020 2020 2023 2049 6620 7765           # If we
-0000c6f0: 2061 7265 206e 6f74 2069 6e20 7468 6520   are not in the 
-0000c700: 6c61 7374 2070 6173 732c 206f 6e62 6f72  last pass, onbor
-0000c710: 6465 7220 7061 7263 656c 7320 7769 6c6c  der parcels will
-0000c720: 206e 6565 6420 6578 7472 610a 2020 2020   need extra.    
-0000c730: 2020 2020 2020 2020 2020 2020 2320 7072              # pr
-0000c740: 6f63 6573 7369 6e67 2073 7469 6c6c 2069  ocessing still i
-0000c750: 6e20 6675 7274 6865 7220 7061 7373 6573  n further passes
-0000c760: 2c20 736f 2061 7265 2073 6176 6564 2069  , so are saved i
-0000c770: 6e20 6120 7365 7065 7261 7465 0a20 2020  n a seperate.   
-0000c780: 2020 2020 2020 2020 2020 2020 2023 2067               # g
-0000c790: 666f 2e20 5468 6520 6e6f 746f 6e62 6f72  fo. The notonbor
-0000c7a0: 6465 7220 726f 7773 2061 7265 2066 696e  der rows are fin
-0000c7b0: 616c 2069 6d6d 6564 6961 7465 6c79 0a20  al immediately. 
-0000c7c0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000c7d0: 6620 6c61 7374 5f70 6173 7320 6973 206e  f last_pass is n
-0000c7e0: 6f74 2054 7275 653a 0a20 2020 2020 2020  ot True:.       
-0000c7f0: 2020 2020 2020 2020 2020 2020 206f 7574               out
-0000c800: 7075 745f 746d 705f 6f6e 626f 7264 6572  put_tmp_onborder
-0000c810: 5f70 6174 6820 3d20 280a 2020 2020 2020  _path = (.      
-0000c820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c830: 2020 7465 6d70 6469 7220 2f20 6622 6f75    tempdir / f"ou
-0000c840: 7470 7574 5f7b 7061 7373 5f69 647d 5f6f  tput_{pass_id}_o
-0000c850: 6e62 6f72 6465 722e 6770 6b67 220a 2020  nborder.gpkg".  
-0000c860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c870: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0000c880: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0000c890: 2020 2020 2020 2020 2020 2020 2020 6f75                ou
-0000c8a0: 7470 7574 5f74 6d70 5f6f 6e62 6f72 6465  tput_tmp_onborde
-0000c8b0: 725f 7061 7468 203d 206f 7574 7075 745f  r_path = output_
-0000c8c0: 746d 705f 7061 7468 0a0a 2020 2020 2020  tmp_path..      
-0000c8d0: 2020 2020 2020 2020 2020 2320 4e6f 7720            # Now 
-0000c8e0: 676f 210a 2020 2020 2020 2020 2020 2020  go!.            
-0000c8f0: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
-0000c900: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c910: 2020 2020 2066 2253 7461 7274 2070 6173       f"Start pas
-0000c920: 7320 7b70 6173 735f 6964 7d20 746f 207b  s {pass_id} to {
-0000c930: 6c65 6e28 7469 6c65 735f 6764 6629 7d20  len(tiles_gdf)} 
-0000c940: 7469 6c65 7320 220a 2020 2020 2020 2020  tiles ".        
-0000c950: 2020 2020 2020 2020 2020 2020 6622 2862              f"(b
-0000c960: 6174 6368 2073 697a 653a 207b 696e 7428  atch size: {int(
-0000c970: 6e62 5f72 6f77 735f 746f 7461 6c2f 6c65  nb_rows_total/le
-0000c980: 6e28 7469 6c65 735f 6764 6629 297d 2922  n(tiles_gdf))})"
-0000c990: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c9a0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-0000c9b0: 2020 2070 6173 735f 7374 6172 7420 3d20     pass_start = 
-0000c9c0: 6461 7465 7469 6d65 2e6e 6f77 2829 0a20  datetime.now(). 
-0000c9d0: 2020 2020 2020 2020 2020 2020 2020 205f                 _
-0000c9e0: 203d 205f 6469 7373 6f6c 7665 5f70 6f6c   = _dissolve_pol
-0000c9f0: 7967 6f6e 735f 7061 7373 280a 2020 2020  ygons_pass(.    
-0000ca00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ca10: 696e 7075 745f 7061 7468 3d69 6e70 7574  input_path=input
-0000ca20: 5f70 6174 682c 0a20 2020 2020 2020 2020  _path,.         
-0000ca30: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
-0000ca40: 745f 6e6f 746f 6e62 6f72 6465 725f 7061  t_notonborder_pa
-0000ca50: 7468 3d6f 7574 7075 745f 746d 705f 7061  th=output_tmp_pa
-0000ca60: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
-0000ca70: 2020 2020 2020 2020 6f75 7470 7574 5f6f          output_o
-0000ca80: 6e62 6f72 6465 725f 7061 7468 3d6f 7574  nborder_path=out
-0000ca90: 7075 745f 746d 705f 6f6e 626f 7264 6572  put_tmp_onborder
-0000caa0: 5f70 6174 682c 0a20 2020 2020 2020 2020  _path,.         
-0000cab0: 2020 2020 2020 2020 2020 2065 7870 6c6f             explo
-0000cac0: 6465 636f 6c6c 6563 7469 6f6e 733d 6578  decollections=ex
-0000cad0: 706c 6f64 6563 6f6c 6c65 6374 696f 6e73  plodecollections
-0000cae0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000caf0: 2020 2020 2020 6772 6f75 7062 795f 636f        groupby_co
-0000cb00: 6c75 6d6e 733d 6772 6f75 7062 795f 636f  lumns=groupby_co
-0000cb10: 6c75 6d6e 732c 0a20 2020 2020 2020 2020  lumns,.         
-0000cb20: 2020 2020 2020 2020 2020 2061 6767 5f63             agg_c
-0000cb30: 6f6c 756d 6e73 3d61 6767 5f63 6f6c 756d  olumns=agg_colum
-0000cb40: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
-0000cb50: 2020 2020 2020 2020 7469 6c65 735f 6764          tiles_gd
-0000cb60: 663d 7469 6c65 735f 6764 662c 0a20 2020  f=tiles_gdf,.   
-0000cb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cb80: 2069 6e70 7574 5f6c 6179 6572 3d69 6e70   input_layer=inp
-0000cb90: 7574 5f70 6173 735f 6c61 7965 722c 0a20  ut_pass_layer,. 
-0000cba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cbb0: 2020 206f 7574 7075 745f 6c61 7965 723d     output_layer=
-0000cbc0: 6f75 7470 7574 5f6c 6179 6572 2c0a 2020  output_layer,.  
-0000cbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cbe0: 2020 6772 6964 7369 7a65 3d67 7269 6473    gridsize=grids
-0000cbf0: 697a 652c 0a20 2020 2020 2020 2020 2020  ize,.           
-0000cc00: 2020 2020 2020 2020 206b 6565 705f 656d           keep_em
-0000cc10: 7074 795f 6765 6f6d 733d 4661 6c73 652c  pty_geoms=False,
-0000cc20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000cc30: 2020 2020 206e 625f 7061 7261 6c6c 656c       nb_parallel
-0000cc40: 3d6e 625f 7061 7261 6c6c 656c 2c0a 2020  =nb_parallel,.  
-0000cc50: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0000cc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cc70: 6c6f 6767 6572 2e69 6e66 6f28 6622 5061  logger.info(f"Pa
-0000cc80: 7373 207b 7061 7373 5f69 647d 2072 6561  ss {pass_id} rea
-0000cc90: 6479 2c20 746f 6f6b 207b 6461 7465 7469  dy, took {dateti
-0000cca0: 6d65 2e6e 6f77 2829 2d70 6173 735f 7374  me.now()-pass_st
-0000ccb0: 6172 747d 2229 0a0a 2020 2020 2020 2020  art}")..        
-0000ccc0: 2020 2020 2020 2020 2320 5072 6570 6172          # Prepar
-0000ccd0: 6520 7468 6520 6e65 7874 2070 6173 730a  e the next pass.
-0000cce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ccf0: 2320 5468 6520 696e 7075 7420 7061 7468  # The input path
-0000cd00: 2069 7320 7468 6520 6f6e 626f 7264 6572   is the onborder
-0000cd10: 2066 696c 650a 2020 2020 2020 2020 2020   file.          
-0000cd20: 2020 2020 2020 7072 6576 5f6e 625f 6261        prev_nb_ba
-0000cd30: 7463 6865 7320 3d20 6c65 6e28 7469 6c65  tches = len(tile
-0000cd40: 735f 6764 6629 0a20 2020 2020 2020 2020  s_gdf).         
-0000cd50: 2020 2020 2020 2069 6e70 7574 5f70 6174         input_pat
-0000cd60: 6820 3d20 6f75 7470 7574 5f74 6d70 5f6f  h = output_tmp_o
-0000cd70: 6e62 6f72 6465 725f 7061 7468 0a20 2020  nborder_path.   
-0000cd80: 2020 2020 2020 2020 2020 2020 2070 6173               pas
-0000cd90: 735f 6964 202b 3d20 310a 2020 2020 2020  s_id += 1.      
-0000cda0: 2020 2020 2020 2020 2020 696e 7075 745f            input_
-0000cdb0: 7061 7373 5f6c 6179 6572 203d 204e 6f6e  pass_layer = Non
-0000cdc0: 650a 0a20 2020 2020 2020 2020 2020 2020  e..             
-0000cdd0: 2020 2023 2049 6620 7765 2061 7265 2072     # If we are r
-0000cde0: 6561 6479 2e2e 2e0a 2020 2020 2020 2020  eady....        
-0000cdf0: 2020 2020 2020 2020 6966 206c 6173 745f          if last_
-0000ce00: 7061 7373 2069 7320 5472 7565 3a0a 2020  pass is True:.  
-0000ce10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ce20: 2020 6272 6561 6b0a 0a20 2020 2020 2020    break..       
-0000ce30: 2020 2020 2023 2043 616c 6375 6c61 7469       # Calculati
-0000ce40: 6f6e 2072 6561 6479 2120 4e6f 7720 6669  on ready! Now fi
-0000ce50: 6e61 6c69 7365 206f 7574 7075 7421 0a20  nalise output!. 
-0000ce60: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-0000ce70: 722e 696e 666f 2822 4669 6e61 6c69 7a65  r.info("Finalize
-0000ce80: 2072 6573 756c 7422 290a 2020 2020 2020   result").      
-0000ce90: 2020 2020 2020 2320 4966 2074 6865 7265        # If there
-0000cea0: 2069 7320 6120 7265 7375 6c74 206f 6e20   is a result on 
-0000ceb0: 626f 7264 6572 2c20 6170 7065 6e64 2069  border, append i
-0000cec0: 7420 746f 2074 6865 2072 6573 740a 2020  t to the rest.  
-0000ced0: 2020 2020 2020 2020 2020 6966 2028 0a20            if (. 
-0000cee0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0000cef0: 7472 286f 7574 7075 745f 746d 705f 6f6e  tr(output_tmp_on
-0000cf00: 626f 7264 6572 5f70 6174 6829 2021 3d20  border_path) != 
-0000cf10: 7374 7228 6f75 7470 7574 5f74 6d70 5f70  str(output_tmp_p
-0000cf20: 6174 6829 0a20 2020 2020 2020 2020 2020  ath).           
-0000cf30: 2020 2020 2061 6e64 206f 7574 7075 745f       and output_
-0000cf40: 746d 705f 6f6e 626f 7264 6572 5f70 6174  tmp_onborder_pat
-0000cf50: 682e 6578 6973 7473 2829 0a20 2020 2020  h.exists().     
-0000cf60: 2020 2020 2020 2029 3a0a 2020 2020 2020         ):.      
-0000cf70: 2020 2020 2020 2020 2020 6766 6f2e 6170            gfo.ap
-0000cf80: 7065 6e64 5f74 6f28 0a20 2020 2020 2020  pend_to(.       
-0000cf90: 2020 2020 2020 2020 2020 2020 206f 7574               out
-0000cfa0: 7075 745f 746d 705f 6f6e 626f 7264 6572  put_tmp_onborder
-0000cfb0: 5f70 6174 682c 206f 7574 7075 745f 746d  _path, output_tm
-0000cfc0: 705f 7061 7468 2c20 6473 745f 6c61 7965  p_path, dst_laye
-0000cfd0: 723d 6f75 7470 7574 5f6c 6179 6572 0a20  r=output_layer. 
-0000cfe0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0000cff0: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-0000d000: 4966 2074 6865 7265 2069 7320 6120 7265  If there is a re
-0000d010: 7375 6c74 2e2e 2e0a 2020 2020 2020 2020  sult....        
-0000d020: 2020 2020 6966 206f 7574 7075 745f 746d      if output_tm
-0000d030: 705f 7061 7468 2e65 7869 7374 7328 293a  p_path.exists():
-0000d040: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d050: 2023 2049 6620 7469 6c65 6420 6f75 7470   # If tiled outp
-0000d060: 7574 2061 736b 6564 2c20 6164 6420 2274  ut asked, add "t
-0000d070: 696c 655f 6964 2220 746f 2067 726f 7570  ile_id" to group
-0000d080: 6279 5f63 6f6c 756d 6e73 0a20 2020 2020  by_columns.     
-0000d090: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
-0000d0a0: 6e28 7265 7375 6c74 5f74 696c 6573 5f67  n(result_tiles_g
-0000d0b0: 6466 2920 3e20 313a 0a20 2020 2020 2020  df) > 1:.       
-0000d0c0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0000d0d0: 6772 6f75 7062 795f 636f 6c75 6d6e 7320  groupby_columns 
-0000d0e0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-0000d0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d100: 2067 726f 7570 6279 5f63 6f6c 756d 6e73   groupby_columns
-0000d110: 203d 205b 2274 696c 655f 6964 225d 0a20   = ["tile_id"]. 
-0000d120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d130: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0000d140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d150: 2067 726f 7570 6279 5f63 6f6c 756d 6e73   groupby_columns
-0000d160: 203d 206c 6973 7428 6772 6f75 7062 795f   = list(groupby_
-0000d170: 636f 6c75 6d6e 7329 2e63 6f70 7928 290a  columns).copy().
-0000d180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d190: 2020 2020 2020 2020 6772 6f75 7062 795f          groupby_
-0000d1a0: 636f 6c75 6d6e 732e 6170 7065 6e64 2822  columns.append("
-0000d1b0: 7469 6c65 5f69 6422 290a 0a20 2020 2020  tile_id")..     
-0000d1c0: 2020 2020 2020 2020 2020 2023 2050 7265             # Pre
-0000d1d0: 7061 7265 2073 7472 696e 6773 2074 6f20  pare strings to 
-0000d1e0: 7573 6520 696e 2073 656c 6563 7420 6261  use in select ba
-0000d1f0: 7365 6420 6f6e 2067 726f 7570 6279 5f63  sed on groupby_c
-0000d200: 6f6c 756d 6e73 0a20 2020 2020 2020 2020  olumns.         
-0000d210: 2020 2020 2020 2069 6620 6772 6f75 7062         if groupb
-0000d220: 795f 636f 6c75 6d6e 7320 6973 206e 6f74  y_columns is not
-0000d230: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-0000d240: 2020 2020 2020 2020 2020 2067 726f 7570             group
-0000d250: 6279 5f70 7265 6669 7865 645f 6c69 7374  by_prefixed_list
-0000d260: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
-0000d270: 2020 2020 2020 2020 2020 2020 2066 277b               f'{
-0000d280: 7b70 7265 6669 787d 7d22 7b63 6f6c 756d  {prefix}}"{colum
-0000d290: 6e7d 2227 2066 6f72 2063 6f6c 756d 6e20  n}"' for column 
-0000d2a0: 696e 2067 726f 7570 6279 5f63 6f6c 756d  in groupby_colum
-0000d2b0: 6e73 0a20 2020 2020 2020 2020 2020 2020  ns.             
-0000d2c0: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
-0000d2d0: 2020 2020 2020 2020 2020 2020 2067 726f               gro
-0000d2e0: 7570 6279 5f73 656c 6563 745f 7072 6566  upby_select_pref
-0000d2f0: 6978 6564 5f73 7472 203d 2028 0a20 2020  ixed_str = (.   
-0000d300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d310: 2020 2020 2066 222c 207b 272c 2027 2e6a       f", {', '.j
-0000d320: 6f69 6e28 6772 6f75 7062 795f 7072 6566  oin(groupby_pref
-0000d330: 6978 6564 5f6c 6973 7429 7d22 0a20 2020  ixed_list)}".   
-0000d340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d350: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-0000d360: 2020 2020 2020 2067 726f 7570 6279 5f67         groupby_g
-0000d370: 726f 7570 6279 5f70 7265 6669 7865 645f  roupby_prefixed_
-0000d380: 7374 7220 3d20 280a 2020 2020 2020 2020  str = (.        
-0000d390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d3a0: 6622 4752 4f55 5020 4259 207b 272c 2027  f"GROUP BY {', '
-0000d3b0: 2e6a 6f69 6e28 6772 6f75 7062 795f 7072  .join(groupby_pr
-0000d3c0: 6566 6978 6564 5f6c 6973 7429 7d22 0a20  efixed_list)}". 
-0000d3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d3e0: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
-0000d3f0: 2020 2020 2020 2020 2020 6772 6f75 7062            groupb
-0000d400: 795f 6669 6c74 6572 5f6c 6973 7420 3d20  y_filter_list = 
-0000d410: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
-0000d420: 2020 2020 2020 2020 2020 6627 2041 4e44            f' AND
-0000d430: 2067 656f 5f64 6174 612e 227b 636f 6c75   geo_data."{colu
-0000d440: 6d6e 7d22 203d 206a 736f 6e5f 6461 7461  mn}" = json_data
-0000d450: 2e22 7b63 6f6c 756d 6e7d 2227 0a20 2020  ."{column}"'.   
-0000d460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d470: 2020 2020 2066 6f72 2063 6f6c 756d 6e20       for column 
-0000d480: 696e 2067 726f 7570 6279 5f63 6f6c 756d  in groupby_colum
-0000d490: 6e73 0a20 2020 2020 2020 2020 2020 2020  ns.             
-0000d4a0: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
-0000d4b0: 2020 2020 2020 2020 2020 2020 2067 726f               gro
-0000d4c0: 7570 6279 5f66 696c 7465 725f 7374 7220  upby_filter_str 
-0000d4d0: 3d20 2220 222e 6a6f 696e 2867 726f 7570  = " ".join(group
-0000d4e0: 6279 5f66 696c 7465 725f 6c69 7374 290a  by_filter_list).
-0000d4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d500: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0000d510: 2020 2020 2020 2020 2020 6772 6f75 7062            groupb
-0000d520: 795f 7365 6c65 6374 5f70 7265 6669 7865  y_select_prefixe
-0000d530: 645f 7374 7220 3d20 2222 0a20 2020 2020  d_str = "".     
-0000d540: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-0000d550: 726f 7570 6279 5f67 726f 7570 6279 5f70  roupby_groupby_p
-0000d560: 7265 6669 7865 645f 7374 7220 3d20 2222  refixed_str = ""
-0000d570: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d580: 2020 2020 2067 726f 7570 6279 5f66 696c       groupby_fil
-0000d590: 7465 725f 7374 7220 3d20 2222 0a0a 2020  ter_str = ""..  
-0000d5a0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0000d5b0: 5072 6570 6172 6520 7374 7269 6e67 7320  Prepare strings 
-0000d5c0: 746f 2075 7365 2069 6e20 7365 6c65 6374  to use in select
-0000d5d0: 2062 6173 6564 206f 6e20 6167 675f 636f   based on agg_co
-0000d5e0: 6c75 6d6e 730a 2020 2020 2020 2020 2020  lumns.          
-0000d5f0: 2020 2020 2020 6167 675f 636f 6c75 6d6e        agg_column
-0000d600: 735f 7374 7220 3d20 2222 0a20 2020 2020  s_str = "".     
-0000d610: 2020 2020 2020 2020 2020 2069 6620 6167             if ag
-0000d620: 675f 636f 6c75 6d6e 7320 6973 206e 6f74  g_columns is not
-0000d630: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-0000d640: 2020 2020 2020 2020 2020 2069 6620 226a             if "j
-0000d650: 736f 6e22 2069 6e20 6167 675f 636f 6c75  son" in agg_colu
-0000d660: 6d6e 733a 0a20 2020 2020 2020 2020 2020  mns:.           
-0000d670: 2020 2020 2020 2020 2020 2020 2023 2054               # T
-0000d680: 6865 2061 6767 7265 6761 7469 6f6e 2069  he aggregation i
-0000d690: 7320 746f 2061 206a 736f 6e20 636f 6c75  s to a json colu
-0000d6a0: 6d6e 2c20 736f 2061 6464 0a20 2020 2020  mn, so add.     
-0000d6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d6c0: 2020 2061 6767 5f63 6f6c 756d 6e73 5f73     agg_columns_s
-0000d6d0: 7472 202b 3d20 280a 2020 2020 2020 2020  tr += (.        
-0000d6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d6f0: 2020 2020 222c 6a73 6f6e 5f67 726f 7570      ",json_group
-0000d700: 5f61 7272 6179 2844 4953 5449 4e43 5420  _array(DISTINCT 
-0000d710: 6a73 6f6e 5f64 6174 612e 6a73 6f6e 5f72  json_data.json_r
-0000d720: 6f77 2920 6173 206a 736f 6e22 0a20 2020  ow) as json".   
-0000d730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d740: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-0000d750: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-0000d760: 2263 6f6c 756d 6e73 2220 696e 2061 6767  "columns" in agg
-0000d770: 5f63 6f6c 756d 6e73 3a0a 2020 2020 2020  _columns:.      
+0000c060: 2020 2020 2069 6e70 7574 5f70 6173 735f       input_pass_
+0000c070: 6c61 7965 7269 6e66 6f2e 746f 7461 6c5f  layerinfo.total_
+0000c080: 626f 756e 6473 5b31 5d20 2d20 302e 3030  bounds[1] - 0.00
+0000c090: 3030 3031 2c0a 2020 2020 2020 2020 2020  0001,.          
+0000c0a0: 2020 2020 2020 2020 2020 2020 2020 696e                in
+0000c0b0: 7075 745f 7061 7373 5f6c 6179 6572 696e  put_pass_layerin
+0000c0c0: 666f 2e74 6f74 616c 5f62 6f75 6e64 735b  fo.total_bounds[
+0000c0d0: 325d 202b 2030 2e30 3030 3030 312c 0a20  2] + 0.000001,. 
+0000c0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c0f0: 2020 2020 2020 2069 6e70 7574 5f70 6173         input_pas
+0000c100: 735f 6c61 7965 7269 6e66 6f2e 746f 7461  s_layerinfo.tota
+0000c110: 6c5f 626f 756e 6473 5b33 5d20 2b20 302e  l_bounds[3] + 0.
+0000c120: 3030 3030 3031 2c0a 2020 2020 2020 2020  000001,.        
+0000c130: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0000c140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c150: 2020 7469 6c65 735f 6764 6620 3d20 6770    tiles_gdf = gp
+0000c160: 642e 4765 6f44 6174 6146 7261 6d65 280a  d.GeoDataFrame(.
+0000c170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c180: 2020 2020 2020 2020 6765 6f6d 6574 7279          geometry
+0000c190: 3d70 7967 656f 6f70 732e 6372 6561 7465  =pygeoops.create
+0000c1a0: 5f67 7269 6432 280a 2020 2020 2020 2020  _grid2(.        
+0000c1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c1c0: 2020 2020 746f 7461 6c5f 626f 756e 6473      total_bounds
+0000c1d0: 3d67 7269 645f 746f 7461 6c5f 626f 756e  =grid_total_boun
+0000c1e0: 6473 2c0a 2020 2020 2020 2020 2020 2020  ds,.            
+0000c1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c200: 6e62 5f73 7175 6172 6973 685f 7469 6c65  nb_squarish_tile
+0000c210: 733d 6e62 5f62 6174 6368 6573 2c0a 2020  s=nb_batches,.  
+0000c220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c230: 2020 2020 2020 2020 2020 6e62 5f73 7175            nb_squ
+0000c240: 6172 6973 685f 7469 6c65 735f 6d61 783d  arish_tiles_max=
+0000c250: 6e62 5f73 7175 6172 6973 685f 7469 6c65  nb_squarish_tile
+0000c260: 735f 6d61 782c 0a20 2020 2020 2020 2020  s_max,.         
+0000c270: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+0000c280: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000c290: 2020 2020 2020 2020 2020 6372 733d 696e            crs=in
+0000c2a0: 7075 745f 7061 7373 5f6c 6179 6572 696e  put_pass_layerin
+0000c2b0: 666f 2e63 7273 2c0a 2020 2020 2020 2020  fo.crs,.        
+0000c2c0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0000c2d0: 2020 2020 2020 2020 2020 2020 2020 656c                el
+0000c2e0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0000c2f0: 2020 2020 2020 2020 2320 4966 2061 2067          # If a g
+0000c300: 7269 6420 6973 2073 7065 6369 6669 6564  rid is specified
+0000c310: 2061 6c72 6561 6479 2c20 6164 6420 6578   already, add ex
+0000c320: 7472 6120 636f 6c75 6d6e 732f 726f 7773  tra columns/rows
+0000c330: 2069 6e73 7465 6164 206f 660a 2020 2020   instead of.    
+0000c340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c350: 2320 6372 6561 7469 6e67 206e 6577 206f  # creating new o
+0000c360: 6e65 2e2e 2e0a 2020 2020 2020 2020 2020  ne....          
+0000c370: 2020 2020 2020 2020 2020 7469 6c65 735f            tiles_
+0000c380: 6764 6620 3d20 7079 6765 6f6f 7073 2e73  gdf = pygeoops.s
+0000c390: 706c 6974 5f74 696c 6573 2872 6573 756c  plit_tiles(resul
+0000c3a0: 745f 7469 6c65 735f 6764 662c 206e 625f  t_tiles_gdf, nb_
+0000c3b0: 6261 7463 6865 7329 0a0a 2020 2020 2020  batches)..      
+0000c3c0: 2020 2020 2020 2020 2020 2320 4170 706c            # Appl
+0000c3d0: 7920 6772 6964 7369 7a65 2074 6f6c 6572  y gridsize toler
+0000c3e0: 616e 6365 206f 6e20 7469 6c65 732c 206f  ance on tiles, o
+0000c3f0: 7468 6572 7769 7365 2074 6865 2062 6f72  therwise the bor
+0000c400: 6465 7220 706f 6c79 676f 6e73 2063 616e  der polygons can
+0000c410: 2774 0a20 2020 2020 2020 2020 2020 2020  't.             
+0000c420: 2020 2023 2062 6520 756e 696f 6e65 6420     # be unioned 
+0000c430: 7072 6f70 6572 6c79 2062 6563 6175 7365  properly because
+0000c440: 2067 6170 7320 6170 7065 6172 2061 6674   gaps appear aft
+0000c450: 6572 2072 6f75 6e64 696e 6720 636f 6f72  er rounding coor
+0000c460: 6469 6e61 7465 732e 0a20 2020 2020 2020  dinates..       
+0000c470: 2020 2020 2020 2020 2069 6620 6772 6964           if grid
+0000c480: 7369 7a65 2021 3d20 302e 303a 0a20 2020  size != 0.0:.   
+0000c490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c4a0: 2074 696c 6573 5f67 6466 2e67 656f 6d65   tiles_gdf.geome
+0000c4b0: 7472 7920 3d20 7368 6170 656c 792e 7365  try = shapely.se
+0000c4c0: 745f 7072 6563 6973 696f 6e28 0a20 2020  t_precision(.   
+0000c4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c4e0: 2020 2020 2074 696c 6573 5f67 6466 2e67       tiles_gdf.g
+0000c4f0: 656f 6d65 7472 792c 2067 7269 645f 7369  eometry, grid_si
+0000c500: 7a65 3d67 7269 6473 697a 650a 2020 2020  ze=gridsize.    
+0000c510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c520: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000c530: 2020 6766 6f2e 746f 5f66 696c 6528 7469    gfo.to_file(ti
+0000c540: 6c65 735f 6764 662c 2074 656d 7064 6972  les_gdf, tempdir
+0000c550: 202f 2066 226f 7574 7075 745f 7b70 6173   / f"output_{pas
+0000c560: 735f 6964 7d5f 7469 6c65 732e 6770 6b67  s_id}_tiles.gpkg
+0000c570: 2229 0a0a 2020 2020 2020 2020 2020 2020  ")..            
+0000c580: 2020 2020 2320 4966 2074 6865 206e 756d      # If the num
+0000c590: 6265 7220 6f66 2074 696c 6573 2065 6e64  ber of tiles end
+0000c5a0: 7320 7570 2061 7320 312c 2069 7420 6973  s up as 1, it is
+0000c5b0: 2074 6865 206c 6173 7420 7061 7373 2061   the last pass a
+0000c5c0: 6e79 7761 792e 2e2e 0a20 2020 2020 2020  nyway....       
+0000c5d0: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
+0000c5e0: 7469 6c65 735f 6764 6629 203d 3d20 313a  tiles_gdf) == 1:
+0000c5f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c600: 2020 2020 206c 6173 745f 7061 7373 203d       last_pass =
+0000c610: 2054 7275 650a 0a20 2020 2020 2020 2020   True..         
+0000c620: 2020 2020 2020 2023 2049 6620 7765 2061         # If we a
+0000c630: 7265 206e 6f74 2069 6e20 7468 6520 6c61  re not in the la
+0000c640: 7374 2070 6173 732c 206f 6e62 6f72 6465  st pass, onborde
+0000c650: 7220 7061 7263 656c 7320 7769 6c6c 206e  r parcels will n
+0000c660: 6565 6420 6578 7472 610a 2020 2020 2020  eed extra.      
+0000c670: 2020 2020 2020 2020 2020 2320 7072 6f63            # proc
+0000c680: 6573 7369 6e67 2073 7469 6c6c 2069 6e20  essing still in 
+0000c690: 6675 7274 6865 7220 7061 7373 6573 2c20  further passes, 
+0000c6a0: 736f 2061 7265 2073 6176 6564 2069 6e20  so are saved in 
+0000c6b0: 6120 7365 7065 7261 7465 0a20 2020 2020  a seperate.     
+0000c6c0: 2020 2020 2020 2020 2020 2023 2067 666f             # gfo
+0000c6d0: 2e20 5468 6520 6e6f 746f 6e62 6f72 6465  . The notonborde
+0000c6e0: 7220 726f 7773 2061 7265 2066 696e 616c  r rows are final
+0000c6f0: 2069 6d6d 6564 6961 7465 6c79 0a20 2020   immediately.   
+0000c700: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0000c710: 6c61 7374 5f70 6173 7320 6973 206e 6f74  last_pass is not
+0000c720: 2054 7275 653a 0a20 2020 2020 2020 2020   True:.         
+0000c730: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
+0000c740: 745f 746d 705f 6f6e 626f 7264 6572 5f70  t_tmp_onborder_p
+0000c750: 6174 6820 3d20 280a 2020 2020 2020 2020  ath = (.        
+0000c760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c770: 7465 6d70 6469 7220 2f20 6622 6f75 7470  tempdir / f"outp
+0000c780: 7574 5f7b 7061 7373 5f69 647d 5f6f 6e62  ut_{pass_id}_onb
+0000c790: 6f72 6465 722e 6770 6b67 220a 2020 2020  order.gpkg".    
+0000c7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c7b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000c7c0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0000c7d0: 2020 2020 2020 2020 2020 2020 6f75 7470              outp
+0000c7e0: 7574 5f74 6d70 5f6f 6e62 6f72 6465 725f  ut_tmp_onborder_
+0000c7f0: 7061 7468 203d 206f 7574 7075 745f 746d  path = output_tm
+0000c800: 705f 7061 7468 0a0a 2020 2020 2020 2020  p_path..        
+0000c810: 2020 2020 2020 2020 2320 4e6f 7720 676f          # Now go
+0000c820: 210a 2020 2020 2020 2020 2020 2020 2020  !.              
+0000c830: 2020 6c6f 6767 6572 2e69 6e66 6f28 0a20    logger.info(. 
+0000c840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c850: 2020 2066 2253 7461 7274 2070 6173 7320     f"Start pass 
+0000c860: 7b70 6173 735f 6964 7d20 746f 207b 6c65  {pass_id} to {le
+0000c870: 6e28 7469 6c65 735f 6764 6629 7d20 7469  n(tiles_gdf)} ti
+0000c880: 6c65 7320 220a 2020 2020 2020 2020 2020  les ".          
+0000c890: 2020 2020 2020 2020 2020 6622 2862 6174            f"(bat
+0000c8a0: 6368 2073 697a 653a 207b 696e 7428 6e62  ch size: {int(nb
+0000c8b0: 5f72 6f77 735f 746f 7461 6c2f 6c65 6e28  _rows_total/len(
+0000c8c0: 7469 6c65 735f 6764 6629 297d 2922 0a20  tiles_gdf))})". 
+0000c8d0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+0000c8e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c8f0: 2070 6173 735f 7374 6172 7420 3d20 6461   pass_start = da
+0000c900: 7465 7469 6d65 2e6e 6f77 2829 0a20 2020  tetime.now().   
+0000c910: 2020 2020 2020 2020 2020 2020 205f 203d               _ =
+0000c920: 205f 6469 7373 6f6c 7665 5f70 6f6c 7967   _dissolve_polyg
+0000c930: 6f6e 735f 7061 7373 280a 2020 2020 2020  ons_pass(.      
+0000c940: 2020 2020 2020 2020 2020 2020 2020 696e                in
+0000c950: 7075 745f 7061 7468 3d69 6e70 7574 5f70  put_path=input_p
+0000c960: 6174 682c 0a20 2020 2020 2020 2020 2020  ath,.           
+0000c970: 2020 2020 2020 2020 206f 7574 7075 745f           output_
+0000c980: 6e6f 746f 6e62 6f72 6465 725f 7061 7468  notonborder_path
+0000c990: 3d6f 7574 7075 745f 746d 705f 7061 7468  =output_tmp_path
+0000c9a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000c9b0: 2020 2020 2020 6f75 7470 7574 5f6f 6e62        output_onb
+0000c9c0: 6f72 6465 725f 7061 7468 3d6f 7574 7075  order_path=outpu
+0000c9d0: 745f 746d 705f 6f6e 626f 7264 6572 5f70  t_tmp_onborder_p
+0000c9e0: 6174 682c 0a20 2020 2020 2020 2020 2020  ath,.           
+0000c9f0: 2020 2020 2020 2020 2065 7870 6c6f 6465           explode
+0000ca00: 636f 6c6c 6563 7469 6f6e 733d 6578 706c  collections=expl
+0000ca10: 6f64 6563 6f6c 6c65 6374 696f 6e73 2c0a  odecollections,.
+0000ca20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ca30: 2020 2020 6772 6f75 7062 795f 636f 6c75      groupby_colu
+0000ca40: 6d6e 733d 6772 6f75 7062 795f 636f 6c75  mns=groupby_colu
+0000ca50: 6d6e 732c 0a20 2020 2020 2020 2020 2020  mns,.           
+0000ca60: 2020 2020 2020 2020 2061 6767 5f63 6f6c           agg_col
+0000ca70: 756d 6e73 3d61 6767 5f63 6f6c 756d 6e73  umns=agg_columns
+0000ca80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000ca90: 2020 2020 2020 7469 6c65 735f 6764 663d        tiles_gdf=
+0000caa0: 7469 6c65 735f 6764 662c 0a20 2020 2020  tiles_gdf,.     
+0000cab0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000cac0: 6e70 7574 5f6c 6179 6572 3d69 6e70 7574  nput_layer=input
+0000cad0: 5f70 6173 735f 6c61 7965 722c 0a20 2020  _pass_layer,.   
+0000cae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000caf0: 206f 7574 7075 745f 6c61 7965 723d 6f75   output_layer=ou
+0000cb00: 7470 7574 5f6c 6179 6572 2c0a 2020 2020  tput_layer,.    
+0000cb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cb20: 6772 6964 7369 7a65 3d67 7269 6473 697a  gridsize=gridsiz
+0000cb30: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+0000cb40: 2020 2020 2020 206b 6565 705f 656d 7074         keep_empt
+0000cb50: 795f 6765 6f6d 733d 4661 6c73 652c 0a20  y_geoms=False,. 
+0000cb60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cb70: 2020 206e 625f 7061 7261 6c6c 656c 3d6e     nb_parallel=n
+0000cb80: 625f 7061 7261 6c6c 656c 2c0a 2020 2020  b_parallel,.    
+0000cb90: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0000cba0: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+0000cbb0: 6767 6572 2e69 6e66 6f28 6622 5061 7373  gger.info(f"Pass
+0000cbc0: 207b 7061 7373 5f69 647d 2072 6561 6479   {pass_id} ready
+0000cbd0: 2c20 746f 6f6b 207b 6461 7465 7469 6d65  , took {datetime
+0000cbe0: 2e6e 6f77 2829 2d70 6173 735f 7374 6172  .now()-pass_star
+0000cbf0: 747d 2229 0a0a 2020 2020 2020 2020 2020  t}")..          
+0000cc00: 2020 2020 2020 2320 5072 6570 6172 6520        # Prepare 
+0000cc10: 7468 6520 6e65 7874 2070 6173 730a 2020  the next pass.  
+0000cc20: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0000cc30: 5468 6520 696e 7075 7420 7061 7468 2069  The input path i
+0000cc40: 7320 7468 6520 6f6e 626f 7264 6572 2066  s the onborder f
+0000cc50: 696c 650a 2020 2020 2020 2020 2020 2020  ile.            
+0000cc60: 2020 2020 7072 6576 5f6e 625f 6261 7463      prev_nb_batc
+0000cc70: 6865 7320 3d20 6c65 6e28 7469 6c65 735f  hes = len(tiles_
+0000cc80: 6764 6629 0a20 2020 2020 2020 2020 2020  gdf).           
+0000cc90: 2020 2020 2069 6e70 7574 5f70 6174 6820       input_path 
+0000cca0: 3d20 6f75 7470 7574 5f74 6d70 5f6f 6e62  = output_tmp_onb
+0000ccb0: 6f72 6465 725f 7061 7468 0a20 2020 2020  order_path.     
+0000ccc0: 2020 2020 2020 2020 2020 2070 6173 735f             pass_
+0000ccd0: 6964 202b 3d20 310a 2020 2020 2020 2020  id += 1.        
+0000cce0: 2020 2020 2020 2020 696e 7075 745f 7061          input_pa
+0000ccf0: 7373 5f6c 6179 6572 203d 204e 6f6e 650a  ss_layer = None.
+0000cd00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000cd10: 2023 2049 6620 7765 2061 7265 2072 6561   # If we are rea
+0000cd20: 6479 2e2e 2e0a 2020 2020 2020 2020 2020  dy....          
+0000cd30: 2020 2020 2020 6966 206c 6173 745f 7061        if last_pa
+0000cd40: 7373 2069 7320 5472 7565 3a0a 2020 2020  ss is True:.    
+0000cd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cd60: 6272 6561 6b0a 0a20 2020 2020 2020 2020  break..         
+0000cd70: 2020 2023 2043 616c 6375 6c61 7469 6f6e     # Calculation
+0000cd80: 2072 6561 6479 2120 4e6f 7720 6669 6e61   ready! Now fina
+0000cd90: 6c69 7365 206f 7574 7075 7421 0a20 2020  lise output!.   
+0000cda0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+0000cdb0: 696e 666f 2822 4669 6e61 6c69 7a65 2072  info("Finalize r
+0000cdc0: 6573 756c 7422 290a 2020 2020 2020 2020  esult").        
+0000cdd0: 2020 2020 2320 4966 2074 6865 7265 2069      # If there i
+0000cde0: 7320 6120 7265 7375 6c74 206f 6e20 626f  s a result on bo
+0000cdf0: 7264 6572 2c20 6170 7065 6e64 2069 7420  rder, append it 
+0000ce00: 746f 2074 6865 2072 6573 740a 2020 2020  to the rest.    
+0000ce10: 2020 2020 2020 2020 6966 2028 0a20 2020          if (.   
+0000ce20: 2020 2020 2020 2020 2020 2020 2073 7472               str
+0000ce30: 286f 7574 7075 745f 746d 705f 6f6e 626f  (output_tmp_onbo
+0000ce40: 7264 6572 5f70 6174 6829 2021 3d20 7374  rder_path) != st
+0000ce50: 7228 6f75 7470 7574 5f74 6d70 5f70 6174  r(output_tmp_pat
+0000ce60: 6829 0a20 2020 2020 2020 2020 2020 2020  h).             
+0000ce70: 2020 2061 6e64 206f 7574 7075 745f 746d     and output_tm
+0000ce80: 705f 6f6e 626f 7264 6572 5f70 6174 682e  p_onborder_path.
+0000ce90: 6578 6973 7473 2829 0a20 2020 2020 2020  exists().       
+0000cea0: 2020 2020 2029 3a0a 2020 2020 2020 2020       ):.        
+0000ceb0: 2020 2020 2020 2020 6766 6f2e 6170 7065          gfo.appe
+0000cec0: 6e64 5f74 6f28 0a20 2020 2020 2020 2020  nd_to(.         
+0000ced0: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
+0000cee0: 745f 746d 705f 6f6e 626f 7264 6572 5f70  t_tmp_onborder_p
+0000cef0: 6174 682c 206f 7574 7075 745f 746d 705f  ath, output_tmp_
+0000cf00: 7061 7468 2c20 6473 745f 6c61 7965 723d  path, dst_layer=
+0000cf10: 6f75 7470 7574 5f6c 6179 6572 0a20 2020  output_layer.   
+0000cf20: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
+0000cf30: 2020 2020 2020 2020 2020 2020 2320 4966              # If
+0000cf40: 2074 6865 7265 2069 7320 6120 7265 7375   there is a resu
+0000cf50: 6c74 2e2e 2e0a 2020 2020 2020 2020 2020  lt....          
+0000cf60: 2020 6966 206f 7574 7075 745f 746d 705f    if output_tmp_
+0000cf70: 7061 7468 2e65 7869 7374 7328 293a 0a20  path.exists():. 
+0000cf80: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0000cf90: 2049 6620 7469 6c65 6420 6f75 7470 7574   If tiled output
+0000cfa0: 2061 736b 6564 2c20 6164 6420 2274 696c   asked, add "til
+0000cfb0: 655f 6964 2220 746f 2067 726f 7570 6279  e_id" to groupby
+0000cfc0: 5f63 6f6c 756d 6e73 0a20 2020 2020 2020  _columns.       
+0000cfd0: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
+0000cfe0: 7265 7375 6c74 5f74 696c 6573 5f67 6466  result_tiles_gdf
+0000cff0: 2920 3e20 313a 0a20 2020 2020 2020 2020  ) > 1:.         
+0000d000: 2020 2020 2020 2020 2020 2069 6620 6772             if gr
+0000d010: 6f75 7062 795f 636f 6c75 6d6e 7320 6973  oupby_columns is
+0000d020: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0000d030: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0000d040: 726f 7570 6279 5f63 6f6c 756d 6e73 203d  roupby_columns =
+0000d050: 205b 2274 696c 655f 6964 225d 0a20 2020   ["tile_id"].   
+0000d060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d070: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0000d080: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0000d090: 726f 7570 6279 5f63 6f6c 756d 6e73 203d  roupby_columns =
+0000d0a0: 206c 6973 7428 6772 6f75 7062 795f 636f   list(groupby_co
+0000d0b0: 6c75 6d6e 7329 2e63 6f70 7928 290a 2020  lumns).copy().  
+0000d0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d0d0: 2020 2020 2020 6772 6f75 7062 795f 636f        groupby_co
+0000d0e0: 6c75 6d6e 732e 6170 7065 6e64 2822 7469  lumns.append("ti
+0000d0f0: 6c65 5f69 6422 290a 0a20 2020 2020 2020  le_id")..       
+0000d100: 2020 2020 2020 2020 2023 2050 7265 7061           # Prepa
+0000d110: 7265 2073 7472 696e 6773 2074 6f20 7573  re strings to us
+0000d120: 6520 696e 2073 656c 6563 7420 6261 7365  e in select base
+0000d130: 6420 6f6e 2067 726f 7570 6279 5f63 6f6c  d on groupby_col
+0000d140: 756d 6e73 0a20 2020 2020 2020 2020 2020  umns.           
+0000d150: 2020 2020 2069 6620 6772 6f75 7062 795f       if groupby_
+0000d160: 636f 6c75 6d6e 7320 6973 206e 6f74 204e  columns is not N
+0000d170: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0000d180: 2020 2020 2020 2020 2067 726f 7570 6279           groupby
+0000d190: 5f70 7265 6669 7865 645f 6c69 7374 203d  _prefixed_list =
+0000d1a0: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
+0000d1b0: 2020 2020 2020 2020 2020 2066 277b 7b70             f'{{p
+0000d1c0: 7265 6669 787d 7d22 7b63 6f6c 756d 6e7d  refix}}"{column}
+0000d1d0: 2227 2066 6f72 2063 6f6c 756d 6e20 696e  "' for column in
+0000d1e0: 2067 726f 7570 6279 5f63 6f6c 756d 6e73   groupby_columns
+0000d1f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000d200: 2020 2020 205d 0a20 2020 2020 2020 2020       ].         
+0000d210: 2020 2020 2020 2020 2020 2067 726f 7570             group
+0000d220: 6279 5f73 656c 6563 745f 7072 6566 6978  by_select_prefix
+0000d230: 6564 5f73 7472 203d 2028 0a20 2020 2020  ed_str = (.     
+0000d240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d250: 2020 2066 222c 207b 272c 2027 2e6a 6f69     f", {', '.joi
+0000d260: 6e28 6772 6f75 7062 795f 7072 6566 6978  n(groupby_prefix
+0000d270: 6564 5f6c 6973 7429 7d22 0a20 2020 2020  ed_list)}".     
+0000d280: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+0000d290: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000d2a0: 2020 2020 2067 726f 7570 6279 5f67 726f       groupby_gro
+0000d2b0: 7570 6279 5f70 7265 6669 7865 645f 7374  upby_prefixed_st
+0000d2c0: 7220 3d20 280a 2020 2020 2020 2020 2020  r = (.          
+0000d2d0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+0000d2e0: 4752 4f55 5020 4259 207b 272c 2027 2e6a  GROUP BY {', '.j
+0000d2f0: 6f69 6e28 6772 6f75 7062 795f 7072 6566  oin(groupby_pref
+0000d300: 6978 6564 5f6c 6973 7429 7d22 0a20 2020  ixed_list)}".   
+0000d310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d320: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
+0000d330: 2020 2020 2020 2020 6772 6f75 7062 795f          groupby_
+0000d340: 6669 6c74 6572 5f6c 6973 7420 3d20 5b0a  filter_list = [.
+0000d350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d360: 2020 2020 2020 2020 6627 2041 4e44 2067          f' AND g
+0000d370: 656f 5f64 6174 612e 227b 636f 6c75 6d6e  eo_data."{column
+0000d380: 7d22 203d 206a 736f 6e5f 6461 7461 2e22  }" = json_data."
+0000d390: 7b63 6f6c 756d 6e7d 2227 0a20 2020 2020  {column}"'.     
+0000d3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d3b0: 2020 2066 6f72 2063 6f6c 756d 6e20 696e     for column in
+0000d3c0: 2067 726f 7570 6279 5f63 6f6c 756d 6e73   groupby_columns
+0000d3d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000d3e0: 2020 2020 205d 0a20 2020 2020 2020 2020       ].         
+0000d3f0: 2020 2020 2020 2020 2020 2067 726f 7570             group
+0000d400: 6279 5f66 696c 7465 725f 7374 7220 3d20  by_filter_str = 
+0000d410: 2220 222e 6a6f 696e 2867 726f 7570 6279  " ".join(groupby
+0000d420: 5f66 696c 7465 725f 6c69 7374 290a 2020  _filter_list).  
+0000d430: 2020 2020 2020 2020 2020 2020 2020 656c                el
+0000d440: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0000d450: 2020 2020 2020 2020 6772 6f75 7062 795f          groupby_
+0000d460: 7365 6c65 6374 5f70 7265 6669 7865 645f  select_prefixed_
+0000d470: 7374 7220 3d20 2222 0a20 2020 2020 2020  str = "".       
+0000d480: 2020 2020 2020 2020 2020 2020 2067 726f               gro
+0000d490: 7570 6279 5f67 726f 7570 6279 5f70 7265  upby_groupby_pre
+0000d4a0: 6669 7865 645f 7374 7220 3d20 2222 0a20  fixed_str = "". 
+0000d4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d4c0: 2020 2067 726f 7570 6279 5f66 696c 7465     groupby_filte
+0000d4d0: 725f 7374 7220 3d20 2222 0a0a 2020 2020  r_str = ""..    
+0000d4e0: 2020 2020 2020 2020 2020 2020 2320 5072              # Pr
+0000d4f0: 6570 6172 6520 7374 7269 6e67 7320 746f  epare strings to
+0000d500: 2075 7365 2069 6e20 7365 6c65 6374 2062   use in select b
+0000d510: 6173 6564 206f 6e20 6167 675f 636f 6c75  ased on agg_colu
+0000d520: 6d6e 730a 2020 2020 2020 2020 2020 2020  mns.            
+0000d530: 2020 2020 6167 675f 636f 6c75 6d6e 735f      agg_columns_
+0000d540: 7374 7220 3d20 2222 0a20 2020 2020 2020  str = "".       
+0000d550: 2020 2020 2020 2020 2069 6620 6167 675f           if agg_
+0000d560: 636f 6c75 6d6e 7320 6973 206e 6f74 204e  columns is not N
+0000d570: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0000d580: 2020 2020 2020 2020 2069 6620 226a 736f           if "jso
+0000d590: 6e22 2069 6e20 6167 675f 636f 6c75 6d6e  n" in agg_column
+0000d5a0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0000d5b0: 2020 2020 2020 2020 2020 2023 2054 6865             # The
+0000d5c0: 2061 6767 7265 6761 7469 6f6e 2069 7320   aggregation is 
+0000d5d0: 746f 2061 206a 736f 6e20 636f 6c75 6d6e  to a json column
+0000d5e0: 2c20 736f 2061 6464 0a20 2020 2020 2020  , so add.       
+0000d5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d600: 2061 6767 5f63 6f6c 756d 6e73 5f73 7472   agg_columns_str
+0000d610: 202b 3d20 280a 2020 2020 2020 2020 2020   += (.          
+0000d620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d630: 2020 222c 6a73 6f6e 5f67 726f 7570 5f61    ",json_group_a
+0000d640: 7272 6179 2844 4953 5449 4e43 5420 6a73  rray(DISTINCT js
+0000d650: 6f6e 5f64 6174 612e 6a73 6f6e 5f72 6f77  on_data.json_row
+0000d660: 2920 6173 206a 736f 6e22 0a20 2020 2020  ) as json".     
+0000d670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d680: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0000d690: 2020 2020 2020 2020 2065 6c69 6620 2263           elif "c
+0000d6a0: 6f6c 756d 6e73 2220 696e 2061 6767 5f63  olumns" in agg_c
+0000d6b0: 6f6c 756d 6e73 3a0a 2020 2020 2020 2020  olumns:.        
+0000d6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d6d0: 666f 7220 6167 675f 636f 6c75 6d6e 2069  for agg_column i
+0000d6e0: 6e20 6167 675f 636f 6c75 6d6e 735b 2263  n agg_columns["c
+0000d6f0: 6f6c 756d 6e73 225d 3a0a 2020 2020 2020  olumns"]:.      
+0000d700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d710: 2020 2020 2020 2320 496e 6974 0a20 2020        # Init.   
+0000d720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d730: 2020 2020 2020 2020 2064 6973 7469 6e63           distinc
+0000d740: 745f 7374 7220 3d20 2222 0a20 2020 2020  t_str = "".     
+0000d750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d760: 2020 2020 2020 2065 7874 7261 5f70 6172         extra_par
+0000d770: 616d 5f73 7472 203d 2022 220a 0a20 2020  am_str = ""..   
 0000d780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d790: 2020 666f 7220 6167 675f 636f 6c75 6d6e    for agg_column
-0000d7a0: 2069 6e20 6167 675f 636f 6c75 6d6e 735b   in agg_columns[
-0000d7b0: 2263 6f6c 756d 6e73 225d 3a0a 2020 2020  "columns"]:.    
+0000d790: 2020 2020 2020 2020 2023 2050 7265 7061           # Prepa
+0000d7a0: 7265 2061 6767 7265 6761 7469 6f6e 206b  re aggregation k
+0000d7b0: 6579 776f 7264 2e0a 2020 2020 2020 2020  eyword..        
 0000d7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d7d0: 2020 2020 2020 2020 2320 496e 6974 0a20          # Init. 
-0000d7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d7f0: 2020 2020 2020 2020 2020 2064 6973 7469             disti
-0000d800: 6e63 745f 7374 7220 3d20 2222 0a20 2020  nct_str = "".   
-0000d810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d820: 2020 2020 2020 2020 2065 7874 7261 5f70           extra_p
-0000d830: 6172 616d 5f73 7472 203d 2022 220a 0a20  aram_str = "".. 
-0000d840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d850: 2020 2020 2020 2020 2020 2023 2050 7265             # Pre
-0000d860: 7061 7265 2061 6767 7265 6761 7469 6f6e  pare aggregation
-0000d870: 206b 6579 776f 7264 2e0a 2020 2020 2020   keyword..      
-0000d880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d890: 2020 2020 2020 6966 2061 6767 5f63 6f6c        if agg_col
-0000d8a0: 756d 6e5b 2261 6767 225d 2e6c 6f77 6572  umn["agg"].lower
-0000d8b0: 2829 2069 6e20 5b0a 2020 2020 2020 2020  () in [.        
+0000d7d0: 2020 2020 6966 2061 6767 5f63 6f6c 756d      if agg_colum
+0000d7e0: 6e5b 2261 6767 225d 2e6c 6f77 6572 2829  n["agg"].lower()
+0000d7f0: 2069 6e20 5b0a 2020 2020 2020 2020 2020   in [.          
+0000d800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d810: 2020 2020 2020 2263 6f75 6e74 222c 0a20        "count",. 
+0000d820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d830: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0000d840: 7375 6d22 2c0a 2020 2020 2020 2020 2020  sum",.          
+0000d850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d860: 2020 2020 2020 226d 696e 222c 0a20 2020        "min",.   
+0000d870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d880: 2020 2020 2020 2020 2020 2020 2022 6d61               "ma
+0000d890: 7822 2c0a 2020 2020 2020 2020 2020 2020  x",.            
+0000d8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d8b0: 2020 2020 226d 6564 6961 6e22 2c0a 2020      "median",.  
 0000d8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d8d0: 2020 2020 2020 2020 2263 6f75 6e74 222c          "count",
-0000d8e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d900: 2022 7375 6d22 2c0a 2020 2020 2020 2020   "sum",.        
-0000d910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d920: 2020 2020 2020 2020 226d 696e 222c 0a20          "min",. 
-0000d930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d940: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0000d950: 6d61 7822 2c0a 2020 2020 2020 2020 2020  max",.          
-0000d960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d970: 2020 2020 2020 226d 6564 6961 6e22 2c0a        "median",.
+0000d8d0: 2020 2020 2020 2020 2020 5d3a 0a20 2020            ]:.   
+0000d8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d8f0: 2020 2020 2020 2020 2020 2020 2061 6767               agg
+0000d900: 7265 6761 7469 6f6e 5f73 7472 203d 2061  regation_str = a
+0000d910: 6767 5f63 6f6c 756d 6e5b 2261 6767 225d  gg_column["agg"]
+0000d920: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000d930: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
+0000d940: 6620 6167 675f 636f 6c75 6d6e 5b22 6167  f agg_column["ag
+0000d950: 6722 5d2e 6c6f 7765 7228 2920 696e 205b  g"].lower() in [
+0000d960: 226d 6561 6e22 2c20 2261 7667 225d 3a0a  "mean", "avg"]:.
+0000d970: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0000d980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d990: 2020 2020 2020 2020 2020 2020 5d3a 0a20              ]:. 
-0000d9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d9b0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0000d9c0: 6767 7265 6761 7469 6f6e 5f73 7472 203d  ggregation_str =
-0000d9d0: 2061 6767 5f63 6f6c 756d 6e5b 2261 6767   agg_column["agg
-0000d9e0: 225d 0a20 2020 2020 2020 2020 2020 2020  "].             
-0000d9f0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0000da00: 6c69 6620 6167 675f 636f 6c75 6d6e 5b22  lif agg_column["
-0000da10: 6167 6722 5d2e 6c6f 7765 7228 2920 696e  agg"].lower() in
-0000da20: 205b 226d 6561 6e22 2c20 2261 7667 225d   ["mean", "avg"]
-0000da30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000d990: 6167 6772 6567 6174 696f 6e5f 7374 7220  aggregation_str 
+0000d9a0: 3d20 2261 7667 220a 2020 2020 2020 2020  = "avg".        
+0000d9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d9c0: 2020 2020 656c 6966 2061 6767 5f63 6f6c      elif agg_col
+0000d9d0: 756d 6e5b 2261 6767 225d 2e6c 6f77 6572  umn["agg"].lower
+0000d9e0: 2829 203d 3d20 2263 6f6e 6361 7422 3a0a  () == "concat":.
+0000d9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000da00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000da10: 6167 6772 6567 6174 696f 6e5f 7374 7220  aggregation_str 
+0000da20: 3d20 2267 726f 7570 5f63 6f6e 6361 7422  = "group_concat"
+0000da30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 0000da40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000da50: 2020 6167 6772 6567 6174 696f 6e5f 7374    aggregation_st
-0000da60: 7220 3d20 2261 7667 220a 2020 2020 2020  r = "avg".      
+0000da50: 2069 6620 2273 6570 2220 696e 2061 6767   if "sep" in agg
+0000da60: 5f63 6f6c 756d 6e3a 0a20 2020 2020 2020  _column:.       
 0000da70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000da80: 2020 2020 2020 656c 6966 2061 6767 5f63        elif agg_c
-0000da90: 6f6c 756d 6e5b 2261 6767 225d 2e6c 6f77  olumn["agg"].low
-0000daa0: 6572 2829 203d 3d20 2263 6f6e 6361 7422  er() == "concat"
-0000dab0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000da80: 2020 2020 2020 2020 2020 2020 2065 7874               ext
+0000da90: 7261 5f70 6172 616d 5f73 7472 203d 2066  ra_param_str = f
+0000daa0: 222c 2027 7b61 6767 5f63 6f6c 756d 6e5b  ", '{agg_column[
+0000dab0: 2773 6570 275d 7d27 220a 2020 2020 2020  'sep']}'".      
 0000dac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dad0: 2020 6167 6772 6567 6174 696f 6e5f 7374    aggregation_st
-0000dae0: 7220 3d20 2267 726f 7570 5f63 6f6e 6361  r = "group_conca
-0000daf0: 7422 0a20 2020 2020 2020 2020 2020 2020  t".             
-0000db00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000db10: 2020 2069 6620 2273 6570 2220 696e 2061     if "sep" in a
-0000db20: 6767 5f63 6f6c 756d 6e3a 0a20 2020 2020  gg_column:.     
-0000db30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000db40: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0000db50: 7874 7261 5f70 6172 616d 5f73 7472 203d  xtra_param_str =
-0000db60: 2066 222c 2027 7b61 6767 5f63 6f6c 756d   f", '{agg_colum
-0000db70: 6e5b 2773 6570 275d 7d27 220a 2020 2020  n['sep']}'".    
-0000db80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000db90: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0000dba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dbb0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-0000dbc0: 6973 6520 5661 6c75 6545 7272 6f72 280a  ise ValueError(.
-0000dbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dad0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0000dae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000daf0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0000db00: 6520 5661 6c75 6545 7272 6f72 280a 2020  e ValueError(.  
+0000db10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000db20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000db30: 2020 6622 6167 6772 6567 6174 696f 6e20    f"aggregation 
+0000db40: 7b61 6767 5f63 6f6c 756d 6e5b 2761 6767  {agg_column['agg
+0000db50: 275d 7d20 6973 206e 6f74 2073 7570 706f  ']} is not suppo
+0000db60: 7274 6564 220a 2020 2020 2020 2020 2020  rted".          
+0000db70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000db80: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+0000db90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dba0: 2020 2020 2023 2049 6620 6469 7374 696e       # If distin
+0000dbb0: 6374 2069 7320 7370 6563 6966 6965 642c  ct is specified,
+0000dbc0: 2061 6464 2074 6865 2064 6973 7469 6e63   add the distinc
+0000dbd0: 7420 6b65 7977 6f72 640a 2020 2020 2020  t keyword.      
 0000dbe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dbf0: 2020 2020 6622 6167 6772 6567 6174 696f      f"aggregatio
-0000dc00: 6e20 7b61 6767 5f63 6f6c 756d 6e5b 2761  n {agg_column['a
-0000dc10: 6767 275d 7d20 6973 206e 6f74 2073 7570  gg']} is not sup
-0000dc20: 706f 7274 6564 220a 2020 2020 2020 2020  ported".        
-0000dc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dc40: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-0000dc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dc60: 2020 2020 2020 2023 2049 6620 6469 7374         # If dist
-0000dc70: 696e 6374 2069 7320 7370 6563 6966 6965  inct is specifie
-0000dc80: 642c 2061 6464 2074 6865 2064 6973 7469  d, add the disti
-0000dc90: 6e63 7420 6b65 7977 6f72 640a 2020 2020  nct keyword.    
+0000dbf0: 2020 2020 2020 6966 2028 0a20 2020 2020        if (.     
+0000dc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dc10: 2020 2020 2020 2020 2020 2022 6469 7374             "dist
+0000dc20: 696e 6374 2220 696e 2061 6767 5f63 6f6c  inct" in agg_col
+0000dc30: 756d 6e0a 2020 2020 2020 2020 2020 2020  umn.            
+0000dc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dc50: 2020 2020 616e 6420 6167 675f 636f 6c75      and agg_colu
+0000dc60: 6d6e 5b22 6469 7374 696e 6374 225d 2069  mn["distinct"] i
+0000dc70: 7320 5472 7565 0a20 2020 2020 2020 2020  s True.         
+0000dc80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dc90: 2020 2029 3a0a 2020 2020 2020 2020 2020     ):.          
 0000dca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dcb0: 2020 2020 2020 2020 6966 2028 0a20 2020          if (.   
-0000dcc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dcd0: 2020 2020 2020 2020 2020 2020 2022 6469               "di
-0000dce0: 7374 696e 6374 2220 696e 2061 6767 5f63  stinct" in agg_c
-0000dcf0: 6f6c 756d 6e0a 2020 2020 2020 2020 2020  olumn.          
-0000dd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dd10: 2020 2020 2020 616e 6420 6167 675f 636f        and agg_co
-0000dd20: 6c75 6d6e 5b22 6469 7374 696e 6374 225d  lumn["distinct"]
-0000dd30: 2069 7320 5472 7565 0a20 2020 2020 2020   is True.       
+0000dcb0: 2020 2020 2020 6469 7374 696e 6374 5f73        distinct_s
+0000dcc0: 7472 203d 2022 4449 5354 494e 4354 2022  tr = "DISTINCT "
+0000dcd0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000dce0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0000dcf0: 5072 6570 6172 6520 636f 6c75 6d6e 206e  Prepare column n
+0000dd00: 616d 6520 7374 7269 6e67 2e0a 2020 2020  ame string..    
+0000dd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dd20: 2020 2020 2020 2020 636f 6c75 6d6e 5f73          column_s
+0000dd30: 7472 203d 2028 0a20 2020 2020 2020 2020  tr = (.         
 0000dd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dd50: 2020 2020 2029 3a0a 2020 2020 2020 2020       ):.        
-0000dd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dd70: 2020 2020 2020 2020 6469 7374 696e 6374          distinct
-0000dd80: 5f73 7472 203d 2022 4449 5354 494e 4354  _str = "DISTINCT
-0000dd90: 2022 0a0a 2020 2020 2020 2020 2020 2020   "..            
-0000dda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ddb0: 2320 5072 6570 6172 6520 636f 6c75 6d6e  # Prepare column
-0000ddc0: 206e 616d 6520 7374 7269 6e67 2e0a 2020   name string..  
-0000ddd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dde0: 2020 2020 2020 2020 2020 636f 6c75 6d6e            column
-0000ddf0: 5f73 7472 203d 2028 0a20 2020 2020 2020  _str = (.       
-0000de00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000de10: 2020 2020 2020 2020 2022 6a73 6f6e 5f65           "json_e
-0000de20: 7874 7261 6374 286a 736f 6e5f 6461 7461  xtract(json_data
-0000de30: 2e6a 736f 6e5f 726f 772c 2022 0a20 2020  .json_row, ".   
-0000de40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000de50: 2020 2020 2020 2020 2020 2020 2066 2722               f'"
-0000de60: 242e 7b61 6767 5f63 6f6c 756d 6e5b 2263  $.{agg_column["c
-0000de70: 6f6c 756d 6e22 5d7d 2229 270a 2020 2020  olumn"]}")'.    
-0000de80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000de90: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+0000dd50: 2020 2020 2020 2022 6a73 6f6e 5f65 7874         "json_ext
+0000dd60: 7261 6374 286a 736f 6e5f 6461 7461 2e6a  ract(json_data.j
+0000dd70: 736f 6e5f 726f 772c 2022 0a20 2020 2020  son_row, ".     
+0000dd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dd90: 2020 2020 2020 2020 2020 2066 2722 242e             f'"$.
+0000dda0: 7b61 6767 5f63 6f6c 756d 6e5b 2263 6f6c  {agg_column["col
+0000ddb0: 756d 6e22 5d7d 2229 270a 2020 2020 2020  umn"]}")'.      
+0000ddc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ddd0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+0000dde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ddf0: 2020 2020 2023 204e 6f77 2070 7574 2065       # Now put e
+0000de00: 7665 7279 7468 696e 6720 746f 6765 7468  verything togeth
+0000de10: 6572 0a20 2020 2020 2020 2020 2020 2020  er.             
+0000de20: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0000de30: 6767 5f63 6f6c 756d 6e73 5f73 7472 202b  gg_columns_str +
+0000de40: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
+0000de50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000de60: 2020 2020 6622 2c20 7b61 6767 7265 6761      f", {aggrega
+0000de70: 7469 6f6e 5f73 7472 7d28 7b64 6973 7469  tion_str}({disti
+0000de80: 6e63 745f 7374 727d 7b63 6f6c 756d 6e5f  nct_str}{column_
+0000de90: 7374 727d 220a 2020 2020 2020 2020 2020  str}".          
 0000dea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000deb0: 2020 2020 2020 2023 204e 6f77 2070 7574         # Now put
-0000dec0: 2065 7665 7279 7468 696e 6720 746f 6765   everything toge
-0000ded0: 7468 6572 0a20 2020 2020 2020 2020 2020  ther.           
-0000dee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000def0: 2061 6767 5f63 6f6c 756d 6e73 5f73 7472   agg_columns_str
-0000df00: 202b 3d20 280a 2020 2020 2020 2020 2020   += (.          
-0000df10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000df20: 2020 2020 2020 6622 2c20 7b61 6767 7265        f", {aggre
-0000df30: 6761 7469 6f6e 5f73 7472 7d28 7b64 6973  gation_str}({dis
-0000df40: 7469 6e63 745f 7374 727d 7b63 6f6c 756d  tinct_str}{colum
-0000df50: 6e5f 7374 727d 220a 2020 2020 2020 2020  n_str}".        
-0000df60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000df70: 2020 2020 2020 2020 6627 7b65 7874 7261          f'{extra
-0000df80: 5f70 6172 616d 5f73 7472 7d29 2041 5320  _param_str}) AS 
-0000df90: 227b 6167 675f 636f 6c75 6d6e 5b22 6173  "{agg_column["as
-0000dfa0: 225d 7d22 270a 2020 2020 2020 2020 2020  "]}"'.          
-0000dfb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dfc0: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
-0000dfd0: 2020 2020 2023 2041 6464 2061 2063 6f6c       # Add a col
-0000dfe0: 756d 6e20 746f 206f 7264 6572 2074 6865  umn to order the
-0000dff0: 2072 6573 756c 7420 6279 2074 6f20 6176   result by to av
-0000e000: 6f69 6420 6861 7669 6e67 2061 6c6c 0a20  oid having all. 
-0000e010: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0000e020: 2063 6f6d 706c 6578 2067 656f 6d65 7472   complex geometr
-0000e030: 6965 7320 746f 6765 7468 6572 2069 6e20  ies together in 
-0000e040: 7468 6520 6f75 7470 7574 2066 696c 652e  the output file.
-0000e050: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e060: 206f 7264 6572 6279 5f63 6f6c 756d 6e20   orderby_column 
-0000e070: 3d20 2274 656d 705f 6f72 6465 7263 6f6c  = "temp_ordercol
-0000e080: 756d 6e5f 6765 6f68 6173 6822 0a20 2020  umn_geohash".   
-0000e090: 2020 2020 2020 2020 2020 2020 205f 6164               _ad
-0000e0a0: 645f 6f72 6465 7262 795f 636f 6c75 6d6e  d_orderby_column
-0000e0b0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000e0c0: 2020 2020 2020 7061 7468 3d6f 7574 7075        path=outpu
-0000e0d0: 745f 746d 705f 7061 7468 2c20 6c61 7965  t_tmp_path, laye
-0000e0e0: 723d 6f75 7470 7574 5f6c 6179 6572 2c20  r=output_layer, 
-0000e0f0: 6e61 6d65 3d6f 7264 6572 6279 5f63 6f6c  name=orderby_col
-0000e100: 756d 6e0a 2020 2020 2020 2020 2020 2020  umn.            
-0000e110: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
-0000e120: 2020 2020 2020 2023 2050 7265 7061 7265         # Prepare
-0000e130: 2053 514c 2073 7461 7465 6d65 6e74 2066   SQL statement f
-0000e140: 6f72 2066 696e 616c 206f 7574 7075 7420  or final output 
-0000e150: 6669 6c65 2e0a 2020 2020 2020 2020 2020  file..          
-0000e160: 2020 2020 2020 2320 416c 6c20 7469 6c65        # All tile
-0000e170: 7320 6172 6520 616c 7265 6164 7920 6469  s are already di
-0000e180: 7373 6f6c 7665 6420 746f 2067 726f 7570  ssolved to group
-0000e190: 732c 2062 7574 206e 6f77 2074 6865 0a20  s, but now the. 
-0000e1a0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0000e1b0: 2072 6573 756c 7473 2066 726f 6d20 616c   results from al
-0000e1c0: 6c20 7469 6c65 7320 7374 696c 6c20 6e65  l tiles still ne
-0000e1d0: 6564 2074 6f20 6265 0a20 2020 2020 2020  ed to be.       
-0000e1e0: 2020 2020 2020 2020 2023 2067 726f 7570           # group
-0000e1f0: 6564 2f63 6f6c 6c65 6374 6564 2074 6f67  ed/collected tog
-0000e200: 6574 6865 722e 0a20 2020 2020 2020 2020  ether..         
-0000e210: 2020 2020 2020 2069 6620 6167 675f 636f         if agg_co
-0000e220: 6c75 6d6e 7320 6973 204e 6f6e 653a 0a20  lumns is None:. 
-0000e230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e240: 2020 2023 2049 6620 7468 6572 6520 6172     # If there ar
-0000e250: 6520 6e6f 2061 6767 7265 6761 7469 6f6e  e no aggregation
-0000e260: 2063 6f6c 756d 6e73 2c20 7468 696e 6773   columns, things
-0000e270: 2061 7265 206e 6f74 2074 6f6f 0a20 2020   are not too.   
-0000e280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e290: 2023 2063 6f6d 706c 6963 6174 6564 2e0a   # complicated..
-0000e2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e2b0: 2020 2020 6966 2065 7870 6c6f 6465 636f      if explodeco
-0000e2c0: 6c6c 6563 7469 6f6e 7320 6973 2054 7275  llections is Tru
-0000e2d0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0000e2e0: 2020 2020 2020 2020 2020 2023 2049 6620             # If 
-0000e2f0: 6578 706c 6f64 6563 6f6c 6c65 6374 696f  explodecollectio
-0000e300: 6e73 2069 7320 7472 7565 2c20 6974 2069  ns is true, it i
-0000e310: 7320 7573 656c 6573 7320 746f 0a20 2020  s useless to.   
-0000e320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e330: 2020 2020 2023 2066 6972 7374 2067 726f       # first gro
-0000e340: 7570 2074 6865 6d20 6865 7265 2c20 6173  up them here, as
-0000e350: 2074 6865 7920 7769 6c6c 2062 6520 6578   they will be ex
-0000e360: 706c 6f64 6564 2061 6761 696e 0a20 2020  ploded again.   
+0000deb0: 2020 2020 2020 6627 7b65 7874 7261 5f70        f'{extra_p
+0000dec0: 6172 616d 5f73 7472 7d29 2041 5320 227b  aram_str}) AS "{
+0000ded0: 6167 675f 636f 6c75 6d6e 5b22 6173 225d  agg_column["as"]
+0000dee0: 7d22 270a 2020 2020 2020 2020 2020 2020  }"'.            
+0000def0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000df00: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+0000df10: 2020 2023 2041 6464 2061 2063 6f6c 756d     # Add a colum
+0000df20: 6e20 746f 206f 7264 6572 2074 6865 2072  n to order the r
+0000df30: 6573 756c 7420 6279 2074 6f20 6176 6f69  esult by to avoi
+0000df40: 6420 6861 7669 6e67 2061 6c6c 0a20 2020  d having all.   
+0000df50: 2020 2020 2020 2020 2020 2020 2023 2063               # c
+0000df60: 6f6d 706c 6578 2067 656f 6d65 7472 6965  omplex geometrie
+0000df70: 7320 746f 6765 7468 6572 2069 6e20 7468  s together in th
+0000df80: 6520 6f75 7470 7574 2066 696c 652e 0a20  e output file.. 
+0000df90: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+0000dfa0: 7264 6572 6279 5f63 6f6c 756d 6e20 3d20  rderby_column = 
+0000dfb0: 2274 656d 705f 6f72 6465 7263 6f6c 756d  "temp_ordercolum
+0000dfc0: 6e5f 6765 6f68 6173 6822 0a20 2020 2020  n_geohash".     
+0000dfd0: 2020 2020 2020 2020 2020 205f 6164 645f             _add_
+0000dfe0: 6f72 6465 7262 795f 636f 6c75 6d6e 280a  orderby_column(.
+0000dff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e000: 2020 2020 7061 7468 3d6f 7574 7075 745f      path=output_
+0000e010: 746d 705f 7061 7468 2c20 6c61 7965 723d  tmp_path, layer=
+0000e020: 6f75 7470 7574 5f6c 6179 6572 2c20 6e61  output_layer, na
+0000e030: 6d65 3d6f 7264 6572 6279 5f63 6f6c 756d  me=orderby_colum
+0000e040: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
+0000e050: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
+0000e060: 2020 2020 2023 2050 7265 7061 7265 2053       # Prepare S
+0000e070: 514c 2073 7461 7465 6d65 6e74 2066 6f72  QL statement for
+0000e080: 2066 696e 616c 206f 7574 7075 7420 6669   final output fi
+0000e090: 6c65 2e0a 2020 2020 2020 2020 2020 2020  le..            
+0000e0a0: 2020 2020 2320 416c 6c20 7469 6c65 7320      # All tiles 
+0000e0b0: 6172 6520 616c 7265 6164 7920 6469 7373  are already diss
+0000e0c0: 6f6c 7665 6420 746f 2067 726f 7570 732c  olved to groups,
+0000e0d0: 2062 7574 206e 6f77 2074 6865 0a20 2020   but now the.   
+0000e0e0: 2020 2020 2020 2020 2020 2020 2023 2072               # r
+0000e0f0: 6573 756c 7473 2066 726f 6d20 616c 6c20  esults from all 
+0000e100: 7469 6c65 7320 7374 696c 6c20 6e65 6564  tiles still need
+0000e110: 2074 6f20 6265 0a20 2020 2020 2020 2020   to be.         
+0000e120: 2020 2020 2020 2023 2067 726f 7570 6564         # grouped
+0000e130: 2f63 6f6c 6c65 6374 6564 2074 6f67 6574  /collected toget
+0000e140: 6865 722e 0a20 2020 2020 2020 2020 2020  her..           
+0000e150: 2020 2020 2069 6620 6167 675f 636f 6c75       if agg_colu
+0000e160: 6d6e 7320 6973 204e 6f6e 653a 0a20 2020  mns is None:.   
+0000e170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e180: 2023 2049 6620 7468 6572 6520 6172 6520   # If there are 
+0000e190: 6e6f 2061 6767 7265 6761 7469 6f6e 2063  no aggregation c
+0000e1a0: 6f6c 756d 6e73 2c20 7468 696e 6773 2061  olumns, things a
+0000e1b0: 7265 206e 6f74 2074 6f6f 0a20 2020 2020  re not too.     
+0000e1c0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0000e1d0: 2063 6f6d 706c 6963 6174 6564 2e0a 2020   complicated..  
+0000e1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e1f0: 2020 6966 2065 7870 6c6f 6465 636f 6c6c    if explodecoll
+0000e200: 6563 7469 6f6e 7320 6973 2054 7275 653a  ections is True:
+0000e210: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e220: 2020 2020 2020 2020 2023 2049 6620 6578           # If ex
+0000e230: 706c 6f64 6563 6f6c 6c65 6374 696f 6e73  plodecollections
+0000e240: 2069 7320 7472 7565 2c20 6974 2069 7320   is true, it is 
+0000e250: 7573 656c 6573 7320 746f 0a20 2020 2020  useless to.     
+0000e260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e270: 2020 2023 2066 6972 7374 2067 726f 7570     # first group
+0000e280: 2074 6865 6d20 6865 7265 2c20 6173 2074   them here, as t
+0000e290: 6865 7920 7769 6c6c 2062 6520 6578 706c  hey will be expl
+0000e2a0: 6f64 6564 2061 6761 696e 0a20 2020 2020  oded again.     
+0000e2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e2c0: 2020 2023 2069 6e20 7468 6520 7365 6c65     # in the sele
+0000e2d0: 6374 2829 2063 616c 6c20 6c61 7465 7220  ct() call later 
+0000e2e0: 6f6e 2e2e 2e20 736f 206a 7573 7420 6f72  on... so just or
+0000e2f0: 6465 7220 7468 656d 2e0a 2020 2020 2020  der them..      
+0000e300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e310: 2020 2320 4966 2061 2074 696c 6564 2072    # If a tiled r
+0000e320: 6573 756c 7420 6973 2061 736b 6564 2c20  esult is asked, 
+0000e330: 616c 736f 2064 6f6e 2774 2063 6f6c 6c65  also don't colle
+0000e340: 6374 2e0a 2020 2020 2020 2020 2020 2020  ct..            
+0000e350: 2020 2020 2020 2020 2020 2020 7371 6c5f              sql_
+0000e360: 7374 6d74 203d 2066 2222 220a 2020 2020  stmt = f""".    
 0000e370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e380: 2020 2020 2023 2069 6e20 7468 6520 7365       # in the se
-0000e390: 6c65 6374 2829 2063 616c 6c20 6c61 7465  lect() call late
-0000e3a0: 7220 6f6e 2e2e 2e20 736f 206a 7573 7420  r on... so just 
-0000e3b0: 6f72 6465 7220 7468 656d 2e0a 2020 2020  order them..    
-0000e3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e3d0: 2020 2020 2320 4966 2061 2074 696c 6564      # If a tiled
-0000e3e0: 2072 6573 756c 7420 6973 2061 736b 6564   result is asked
-0000e3f0: 2c20 616c 736f 2064 6f6e 2774 2063 6f6c  , also don't col
-0000e400: 6c65 6374 2e0a 2020 2020 2020 2020 2020  lect..          
-0000e410: 2020 2020 2020 2020 2020 2020 2020 7371                sq
-0000e420: 6c5f 7374 6d74 203d 2066 2222 220a 2020  l_stmt = f""".  
-0000e430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e440: 2020 2020 2020 2020 2020 5345 4c45 4354            SELECT
-0000e450: 207b 7b67 656f 6d65 7472 7963 6f6c 756d   {{geometrycolum
-0000e460: 6e7d 7d0a 2020 2020 2020 2020 2020 2020  n}}.            
-0000e470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e480: 2020 2020 2020 7b67 726f 7570 6279 5f73        {groupby_s
-0000e490: 656c 6563 745f 7072 6566 6978 6564 5f73  elect_prefixed_s
-0000e4a0: 7472 2e66 6f72 6d61 7428 7072 6566 6978  tr.format(prefix
-0000e4b0: 3d22 6c61 7965 722e 2229 7d0a 2020 2020  ="layer.")}.    
-0000e4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e4d0: 2020 2020 2020 2020 2020 4652 4f4d 2022            FROM "
-0000e4e0: 7b7b 696e 7075 745f 6c61 7965 727d 7d22  {{input_layer}}"
-0000e4f0: 206c 6179 6572 0a20 2020 2020 2020 2020   layer.         
-0000e500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e510: 2020 2020 4f52 4445 5220 4259 206c 6179      ORDER BY lay
-0000e520: 6572 2e7b 6f72 6465 7262 795f 636f 6c75  er.{orderby_colu
-0000e530: 6d6e 7d0a 2020 2020 2020 2020 2020 2020  mn}.            
-0000e540: 2020 2020 2020 2020 2020 2020 2222 220a              """.
-0000e550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e560: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0000e570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e580: 2020 2320 4e6f 2065 7870 6c6f 6465 636f    # No explodeco
-0000e590: 6c6c 6563 7469 6f6e 732c 2073 6f20 636f  llections, so co
-0000e5a0: 6c6c 6563 7420 746f 206f 6e65 2067 656f  llect to one geo
-0000e5b0: 6d65 7472 790a 2020 2020 2020 2020 2020  metry.          
-0000e5c0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0000e5d0: 2870 6572 2067 726f 7570 6279 2069 6620  (per groupby if 
-0000e5e0: 6170 706c 6963 6162 6c65 292e 0a20 2020  applicable)..   
-0000e5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e600: 2020 2020 2073 716c 5f73 746d 7420 3d20       sql_stmt = 
-0000e610: 6622 2222 0a20 2020 2020 2020 2020 2020  f""".           
-0000e620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e630: 2053 454c 4543 5420 5354 5f43 6f6c 6c65   SELECT ST_Colle
-0000e640: 6374 287b 7b67 656f 6d65 7472 7963 6f6c  ct({{geometrycol
-0000e650: 756d 6e7d 7d29 2041 5320 7b7b 6765 6f6d  umn}}) AS {{geom
-0000e660: 6574 7279 636f 6c75 6d6e 7d7d 0a20 2020  etrycolumn}}.   
-0000e670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e680: 2020 2020 2020 2020 2020 2020 2020 207b                 {
-0000e690: 6772 6f75 7062 795f 7365 6c65 6374 5f70  groupby_select_p
-0000e6a0: 7265 6669 7865 645f 7374 722e 666f 726d  refixed_str.form
-0000e6b0: 6174 2870 7265 6669 783d 226c 6179 6572  at(prefix="layer
-0000e6c0: 2e22 297d 0a20 2020 2020 2020 2020 2020  .")}.           
-0000e6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e6e0: 2020 2046 524f 4d20 227b 7b69 6e70 7574     FROM "{{input
-0000e6f0: 5f6c 6179 6572 7d7d 2220 6c61 7965 720a  _layer}}" layer.
-0000e700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e710: 2020 2020 2020 2020 2020 2020 2020 7b67                {g
-0000e720: 726f 7570 6279 5f67 726f 7570 6279 5f70  roupby_groupby_p
-0000e730: 7265 6669 7865 645f 7374 722e 666f 726d  refixed_str.form
-0000e740: 6174 2870 7265 6669 783d 226c 6179 6572  at(prefix="layer
-0000e750: 2e22 297d 0a20 2020 2020 2020 2020 2020  .")}.           
-0000e760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e770: 2020 4f52 4445 5220 4259 204d 494e 286c    ORDER BY MIN(l
-0000e780: 6179 6572 2e7b 6f72 6465 7262 795f 636f  ayer.{orderby_co
-0000e790: 6c75 6d6e 7d29 0a20 2020 2020 2020 2020  lumn}).         
-0000e7a0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0000e7b0: 2222 0a20 2020 2020 2020 2020 2020 2020  "".             
-0000e7c0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0000e7d0: 2020 2020 2020 2020 2020 2020 2023 2049               # I
-0000e7e0: 6620 6167 675f 636f 6c75 6d6e 7320 7370  f agg_columns sp
-0000e7f0: 6563 6966 6965 642c 2070 6f73 7470 726f  ecified, postpro
-0000e800: 6365 7373 696e 6720 6973 2061 2062 6974  cessing is a bit
-0000e810: 206d 6f72 650a 2020 2020 2020 2020 2020   more.          
-0000e820: 2020 2020 2020 2020 2020 2320 636f 6d70            # comp
-0000e830: 6c69 6361 7465 642e 0a20 2020 2020 2020  licated..       
-0000e840: 2020 2020 2020 2020 2020 2020 2073 716c               sql
-0000e850: 5f73 746d 7420 3d20 6622 2222 0a20 2020  _stmt = f""".   
+0000e380: 2020 2020 2020 2020 5345 4c45 4354 207b          SELECT {
+0000e390: 7b67 656f 6d65 7472 7963 6f6c 756d 6e7d  {geometrycolumn}
+0000e3a0: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+0000e3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e3c0: 2020 2020 7b67 726f 7570 6279 5f73 656c      {groupby_sel
+0000e3d0: 6563 745f 7072 6566 6978 6564 5f73 7472  ect_prefixed_str
+0000e3e0: 2e66 6f72 6d61 7428 7072 6566 6978 3d22  .format(prefix="
+0000e3f0: 6c61 7965 722e 2229 7d0a 2020 2020 2020  layer.")}.      
+0000e400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e410: 2020 2020 2020 2020 4652 4f4d 2022 7b7b          FROM "{{
+0000e420: 696e 7075 745f 6c61 7965 727d 7d22 206c  input_layer}}" l
+0000e430: 6179 6572 0a20 2020 2020 2020 2020 2020  ayer.           
+0000e440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e450: 2020 4f52 4445 5220 4259 206c 6179 6572    ORDER BY layer
+0000e460: 2e7b 6f72 6465 7262 795f 636f 6c75 6d6e  .{orderby_column
+0000e470: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+0000e480: 2020 2020 2020 2020 2020 2222 220a 2020            """.  
+0000e490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e4a0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0000e4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e4c0: 2320 4e6f 2065 7870 6c6f 6465 636f 6c6c  # No explodecoll
+0000e4d0: 6563 7469 6f6e 732c 2073 6f20 636f 6c6c  ections, so coll
+0000e4e0: 6563 7420 746f 206f 6e65 2067 656f 6d65  ect to one geome
+0000e4f0: 7472 790a 2020 2020 2020 2020 2020 2020  try.            
+0000e500: 2020 2020 2020 2020 2020 2020 2320 2870              # (p
+0000e510: 6572 2067 726f 7570 6279 2069 6620 6170  er groupby if ap
+0000e520: 706c 6963 6162 6c65 292e 0a20 2020 2020  plicable)..     
+0000e530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e540: 2020 2073 716c 5f73 746d 7420 3d20 6622     sql_stmt = f"
+0000e550: 2222 0a20 2020 2020 2020 2020 2020 2020  "".             
+0000e560: 2020 2020 2020 2020 2020 2020 2020 2053                 S
+0000e570: 454c 4543 5420 5354 5f43 6f6c 6c65 6374  ELECT ST_Collect
+0000e580: 287b 7b67 656f 6d65 7472 7963 6f6c 756d  ({{geometrycolum
+0000e590: 6e7d 7d29 2041 5320 7b7b 6765 6f6d 6574  n}}) AS {{geomet
+0000e5a0: 7279 636f 6c75 6d6e 7d7d 0a20 2020 2020  rycolumn}}.     
+0000e5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e5c0: 2020 2020 2020 2020 2020 2020 207b 6772               {gr
+0000e5d0: 6f75 7062 795f 7365 6c65 6374 5f70 7265  oupby_select_pre
+0000e5e0: 6669 7865 645f 7374 722e 666f 726d 6174  fixed_str.format
+0000e5f0: 2870 7265 6669 783d 226c 6179 6572 2e22  (prefix="layer."
+0000e600: 297d 0a20 2020 2020 2020 2020 2020 2020  )}.             
+0000e610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e620: 2046 524f 4d20 227b 7b69 6e70 7574 5f6c   FROM "{{input_l
+0000e630: 6179 6572 7d7d 2220 6c61 7965 720a 2020  ayer}}" layer.  
+0000e640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e650: 2020 2020 2020 2020 2020 2020 7b67 726f              {gro
+0000e660: 7570 6279 5f67 726f 7570 6279 5f70 7265  upby_groupby_pre
+0000e670: 6669 7865 645f 7374 722e 666f 726d 6174  fixed_str.format
+0000e680: 2870 7265 6669 783d 226c 6179 6572 2e22  (prefix="layer."
+0000e690: 297d 0a20 2020 2020 2020 2020 2020 2020  )}.             
+0000e6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e6b0: 4f52 4445 5220 4259 204d 494e 286c 6179  ORDER BY MIN(lay
+0000e6c0: 6572 2e7b 6f72 6465 7262 795f 636f 6c75  er.{orderby_colu
+0000e6d0: 6d6e 7d29 0a20 2020 2020 2020 2020 2020  mn}).           
+0000e6e0: 2020 2020 2020 2020 2020 2020 2022 2222               """
+0000e6f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e700: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0000e710: 2020 2020 2020 2020 2020 2023 2049 6620             # If 
+0000e720: 6167 675f 636f 6c75 6d6e 7320 7370 6563  agg_columns spec
+0000e730: 6966 6965 642c 2070 6f73 7470 726f 6365  ified, postproce
+0000e740: 7373 696e 6720 6973 2061 2062 6974 206d  ssing is a bit m
+0000e750: 6f72 650a 2020 2020 2020 2020 2020 2020  ore.            
+0000e760: 2020 2020 2020 2020 2320 636f 6d70 6c69          # compli
+0000e770: 6361 7465 642e 0a20 2020 2020 2020 2020  cated..         
+0000e780: 2020 2020 2020 2020 2020 2073 716c 5f73             sql_s
+0000e790: 746d 7420 3d20 6622 2222 0a20 2020 2020  tmt = f""".     
+0000e7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e7b0: 2020 2053 454c 4543 5420 6765 6f5f 6461     SELECT geo_da
+0000e7c0: 7461 2e7b 7b67 656f 6d65 7472 7963 6f6c  ta.{{geometrycol
+0000e7d0: 756d 6e7d 7d0a 2020 2020 2020 2020 2020  umn}}.          
+0000e7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e7f0: 2020 2020 7b67 726f 7570 6279 5f73 656c      {groupby_sel
+0000e800: 6563 745f 7072 6566 6978 6564 5f73 7472  ect_prefixed_str
+0000e810: 2e66 6f72 6d61 7428 7072 6566 6978 3d22  .format(prefix="
+0000e820: 6765 6f5f 6461 7461 2e22 297d 0a20 2020  geo_data.")}.   
+0000e830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e840: 2020 2020 2020 2020 2020 207b 6167 675f             {agg_
+0000e850: 636f 6c75 6d6e 735f 7374 727d 0a20 2020  columns_str}.   
 0000e860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e870: 2020 2020 2053 454c 4543 5420 6765 6f5f       SELECT geo_
-0000e880: 6461 7461 2e7b 7b67 656f 6d65 7472 7963  data.{{geometryc
-0000e890: 6f6c 756d 6e7d 7d0a 2020 2020 2020 2020  olumn}}.        
-0000e8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e8b0: 2020 2020 2020 7b67 726f 7570 6279 5f73        {groupby_s
-0000e8c0: 656c 6563 745f 7072 6566 6978 6564 5f73  elect_prefixed_s
-0000e8d0: 7472 2e66 6f72 6d61 7428 7072 6566 6978  tr.format(prefix
-0000e8e0: 3d22 6765 6f5f 6461 7461 2e22 297d 0a20  ="geo_data.")}. 
-0000e8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e900: 2020 2020 2020 2020 2020 2020 207b 6167               {ag
-0000e910: 675f 636f 6c75 6d6e 735f 7374 727d 0a20  g_columns_str}. 
-0000e920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e930: 2020 2020 2020 2020 2046 524f 4d20 280a           FROM (.
-0000e940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e950: 2020 2020 2020 2020 2020 2020 5345 4c45              SELE
-0000e960: 4354 2053 545f 436f 6c6c 6563 7428 6c61  CT ST_Collect(la
-0000e970: 7965 725f 6765 6f2e 7b7b 6765 6f6d 6574  yer_geo.{{geomet
-0000e980: 7279 636f 6c75 6d6e 7d7d 0a20 2020 2020  rycolumn}}.     
-0000e990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e9a0: 2020 2020 2020 2020 2020 2020 2020 2920                ) 
-0000e9b0: 4153 207b 7b67 656f 6d65 7472 7963 6f6c  AS {{geometrycol
-0000e9c0: 756d 6e7d 7d0a 2020 2020 2020 2020 2020  umn}}.          
-0000e9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e9e0: 2020 2020 2020 2020 7b67 726f 7570 6279          {groupby
-0000e9f0: 5f73 656c 6563 745f 7072 6566 6978 6564  _select_prefixed
-0000ea00: 5f73 7472 2e66 6f72 6d61 7428 7072 6566  _str.format(pref
-0000ea10: 6978 3d22 6c61 7965 725f 6765 6f2e 2229  ix="layer_geo.")
-0000ea20: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-0000ea30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ea40: 2020 2020 2c4d 494e 286c 6179 6572 5f67      ,MIN(layer_g
-0000ea50: 656f 2e7b 6f72 6465 7262 795f 636f 6c75  eo.{orderby_colu
-0000ea60: 6d6e 7d29 2061 7320 7b6f 7264 6572 6279  mn}) as {orderby
-0000ea70: 5f63 6f6c 756d 6e7d 0a20 2020 2020 2020  _column}.       
+0000e870: 2020 2020 2020 2046 524f 4d20 280a 2020         FROM (.  
+0000e880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e890: 2020 2020 2020 2020 2020 5345 4c45 4354            SELECT
+0000e8a0: 2053 545f 436f 6c6c 6563 7428 6c61 7965   ST_Collect(laye
+0000e8b0: 725f 6765 6f2e 7b7b 6765 6f6d 6574 7279  r_geo.{{geometry
+0000e8c0: 636f 6c75 6d6e 7d7d 0a20 2020 2020 2020  column}}.       
+0000e8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e8e0: 2020 2020 2020 2020 2020 2020 2920 4153              ) AS
+0000e8f0: 207b 7b67 656f 6d65 7472 7963 6f6c 756d   {{geometrycolum
+0000e900: 6e7d 7d0a 2020 2020 2020 2020 2020 2020  n}}.            
+0000e910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e920: 2020 2020 2020 7b67 726f 7570 6279 5f73        {groupby_s
+0000e930: 656c 6563 745f 7072 6566 6978 6564 5f73  elect_prefixed_s
+0000e940: 7472 2e66 6f72 6d61 7428 7072 6566 6978  tr.format(prefix
+0000e950: 3d22 6c61 7965 725f 6765 6f2e 2229 7d0a  ="layer_geo.")}.
+0000e960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e980: 2020 2c4d 494e 286c 6179 6572 5f67 656f    ,MIN(layer_geo
+0000e990: 2e7b 6f72 6465 7262 795f 636f 6c75 6d6e  .{orderby_column
+0000e9a0: 7d29 2061 7320 7b6f 7264 6572 6279 5f63  }) as {orderby_c
+0000e9b0: 6f6c 756d 6e7d 0a20 2020 2020 2020 2020  olumn}.         
+0000e9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e9d0: 2020 2020 2046 524f 4d20 227b 7b69 6e70       FROM "{{inp
+0000e9e0: 7574 5f6c 6179 6572 7d7d 2220 6c61 7965  ut_layer}}" laye
+0000e9f0: 725f 6765 6f0a 2020 2020 2020 2020 2020  r_geo.          
+0000ea00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ea10: 2020 2020 7b67 726f 7570 6279 5f67 726f      {groupby_gro
+0000ea20: 7570 6279 5f70 7265 6669 7865 645f 7374  upby_prefixed_st
+0000ea30: 722e 666f 726d 6174 2870 7265 6669 783d  r.format(prefix=
+0000ea40: 226c 6179 6572 5f67 656f 2e22 297d 0a20  "layer_geo.")}. 
+0000ea50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ea60: 2020 2020 2020 2020 2020 2029 2067 656f             ) geo
+0000ea70: 5f64 6174 610a 2020 2020 2020 2020 2020  _data.          
 0000ea80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ea90: 2020 2020 2020 2046 524f 4d20 227b 7b69         FROM "{{i
-0000eaa0: 6e70 7574 5f6c 6179 6572 7d7d 2220 6c61  nput_layer}}" la
-0000eab0: 7965 725f 6765 6f0a 2020 2020 2020 2020  yer_geo.        
-0000eac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ead0: 2020 2020 2020 7b67 726f 7570 6279 5f67        {groupby_g
-0000eae0: 726f 7570 6279 5f70 7265 6669 7865 645f  roupby_prefixed_
-0000eaf0: 7374 722e 666f 726d 6174 2870 7265 6669  str.format(prefi
-0000eb00: 783d 226c 6179 6572 5f67 656f 2e22 297d  x="layer_geo.")}
-0000eb10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000eb20: 2020 2020 2020 2020 2020 2020 2029 2067               ) g
-0000eb30: 656f 5f64 6174 610a 2020 2020 2020 2020  eo_data.        
-0000eb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eb50: 2020 4a4f 494e 2028 0a20 2020 2020 2020    JOIN (.       
-0000eb60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eb70: 2020 2020 2053 454c 4543 5420 4449 5354       SELECT DIST
-0000eb80: 494e 4354 206a 736f 6e5f 726f 7773 5f74  INCT json_rows_t
-0000eb90: 6162 6c65 2e76 616c 7565 2061 7320 6a73  able.value as js
-0000eba0: 6f6e 5f72 6f77 0a20 2020 2020 2020 2020  on_row.         
-0000ebb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ebc0: 2020 2020 2020 207b 6772 6f75 7062 795f         {groupby_
-0000ebd0: 7365 6c65 6374 5f70 7265 6669 7865 645f  select_prefixed_
-0000ebe0: 7374 722e 666f 726d 6174 2870 7265 6669  str.format(prefi
-0000ebf0: 783d 226c 6179 6572 5f66 6f72 5f6a 736f  x="layer_for_jso
-0000ec00: 6e2e 2229 7d0a 2020 2020 2020 2020 2020  n.")}.          
-0000ec10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ec20: 2020 2020 4652 4f4d 2022 7b7b 696e 7075      FROM "{{inpu
-0000ec30: 745f 6c61 7965 727d 7d22 206c 6179 6572  t_layer}}" layer
-0000ec40: 5f66 6f72 5f6a 736f 6e0a 2020 2020 2020  _for_json.      
-0000ec50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ec60: 2020 2020 2020 2020 4352 4f53 5320 4a4f          CROSS JO
-0000ec70: 494e 206a 736f 6e5f 6561 6368 280a 2020  IN json_each(.  
-0000ec80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ec90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eca0: 6c61 7965 725f 666f 725f 6a73 6f6e 2e5f  layer_for_json._
-0000ecb0: 5f44 4953 534f 4c56 455f 544f 4a53 4f4e  _DISSOLVE_TOJSON
-0000ecc0: 2c20 2224 2229 206a 736f 6e5f 726f 7773  , "$") json_rows
-0000ecd0: 5f74 6162 6c65 0a20 2020 2020 2020 2020  _table.         
-0000ece0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ecf0: 2020 2029 206a 736f 6e5f 6461 7461 0a20     ) json_data. 
-0000ed00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ed10: 2020 2020 2020 2020 5748 4552 4520 313d          WHERE 1=
-0000ed20: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
-0000ed30: 2020 2020 2020 2020 2020 2020 2020 7b67                {g
-0000ed40: 726f 7570 6279 5f66 696c 7465 725f 7374  roupby_filter_st
-0000ed50: 727d 0a20 2020 2020 2020 2020 2020 2020  r}.             
-0000ed60: 2020 2020 2020 2020 2020 2020 207b 6772               {gr
-0000ed70: 6f75 7062 795f 6772 6f75 7062 795f 7072  oupby_groupby_pr
-0000ed80: 6566 6978 6564 5f73 7472 2e66 6f72 6d61  efixed_str.forma
-0000ed90: 7428 7072 6566 6978 3d22 6765 6f5f 6461  t(prefix="geo_da
-0000eda0: 7461 2e22 297d 0a20 2020 2020 2020 2020  ta.")}.         
-0000edb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000edc0: 204f 5244 4552 2042 5920 6765 6f5f 6461   ORDER BY geo_da
-0000edd0: 7461 2e7b 6f72 6465 7262 795f 636f 6c75  ta.{orderby_colu
-0000ede0: 6d6e 7d0a 2020 2020 2020 2020 2020 2020  mn}.            
-0000edf0: 2020 2020 2020 2020 2222 220a 0a20 2020          """..   
-0000ee00: 2020 2020 2020 2020 2020 2020 2023 2041               # A
-0000ee10: 7070 6c79 2077 6865 7265 5f70 6f73 7420  pply where_post 
-0000ee20: 7061 7261 6d65 7465 7220 6966 206e 6565  parameter if nee
-0000ee30: 6465 642f 706f 7373 6962 6c65 0a20 2020  ded/possible.   
-0000ee40: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0000ee50: 7768 6572 655f 706f 7374 2069 7320 6e6f  where_post is no
-0000ee60: 7420 4e6f 6e65 2061 6e64 206e 6f74 206e  t None and not n
-0000ee70: 6f74 2065 7870 6c6f 6465 636f 6c6c 6563  ot explodecollec
-0000ee80: 7469 6f6e 733a 0a20 2020 2020 2020 2020  tions:.         
-0000ee90: 2020 2020 2020 2020 2020 2023 2065 7870             # exp
+0000ea90: 4a4f 494e 2028 0a20 2020 2020 2020 2020  JOIN (.         
+0000eaa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eab0: 2020 2053 454c 4543 5420 4449 5354 494e     SELECT DISTIN
+0000eac0: 4354 206a 736f 6e5f 726f 7773 5f74 6162  CT json_rows_tab
+0000ead0: 6c65 2e76 616c 7565 2061 7320 6a73 6f6e  le.value as json
+0000eae0: 5f72 6f77 0a20 2020 2020 2020 2020 2020  _row.           
+0000eaf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eb00: 2020 2020 207b 6772 6f75 7062 795f 7365       {groupby_se
+0000eb10: 6c65 6374 5f70 7265 6669 7865 645f 7374  lect_prefixed_st
+0000eb20: 722e 666f 726d 6174 2870 7265 6669 783d  r.format(prefix=
+0000eb30: 226c 6179 6572 5f66 6f72 5f6a 736f 6e2e  "layer_for_json.
+0000eb40: 2229 7d0a 2020 2020 2020 2020 2020 2020  ")}.            
+0000eb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eb60: 2020 4652 4f4d 2022 7b7b 696e 7075 745f    FROM "{{input_
+0000eb70: 6c61 7965 727d 7d22 206c 6179 6572 5f66  layer}}" layer_f
+0000eb80: 6f72 5f6a 736f 6e0a 2020 2020 2020 2020  or_json.        
+0000eb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eba0: 2020 2020 2020 4352 4f53 5320 4a4f 494e        CROSS JOIN
+0000ebb0: 206a 736f 6e5f 6561 6368 280a 2020 2020   json_each(.    
+0000ebc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ebd0: 2020 2020 2020 2020 2020 2020 2020 6c61                la
+0000ebe0: 7965 725f 666f 725f 6a73 6f6e 2e5f 5f44  yer_for_json.__D
+0000ebf0: 4953 534f 4c56 455f 544f 4a53 4f4e 2c20  ISSOLVE_TOJSON, 
+0000ec00: 2224 2229 206a 736f 6e5f 726f 7773 5f74  "$") json_rows_t
+0000ec10: 6162 6c65 0a20 2020 2020 2020 2020 2020  able.           
+0000ec20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ec30: 2029 206a 736f 6e5f 6461 7461 0a20 2020   ) json_data.   
+0000ec40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ec50: 2020 2020 2020 5748 4552 4520 313d 310a        WHERE 1=1.
+0000ec60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ec70: 2020 2020 2020 2020 2020 2020 7b67 726f              {gro
+0000ec80: 7570 6279 5f66 696c 7465 725f 7374 727d  upby_filter_str}
+0000ec90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000eca0: 2020 2020 2020 2020 2020 207b 6772 6f75             {grou
+0000ecb0: 7062 795f 6772 6f75 7062 795f 7072 6566  pby_groupby_pref
+0000ecc0: 6978 6564 5f73 7472 2e66 6f72 6d61 7428  ixed_str.format(
+0000ecd0: 7072 6566 6978 3d22 6765 6f5f 6461 7461  prefix="geo_data
+0000ece0: 2e22 297d 0a20 2020 2020 2020 2020 2020  .")}.           
+0000ecf0: 2020 2020 2020 2020 2020 2020 2020 204f                 O
+0000ed00: 5244 4552 2042 5920 6765 6f5f 6461 7461  RDER BY geo_data
+0000ed10: 2e7b 6f72 6465 7262 795f 636f 6c75 6d6e  .{orderby_column
+0000ed20: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+0000ed30: 2020 2020 2020 2222 220a 0a20 2020 2020        """..     
+0000ed40: 2020 2020 2020 2020 2020 2023 2041 7070             # App
+0000ed50: 6c79 2077 6865 7265 5f70 6f73 7420 7061  ly where_post pa
+0000ed60: 7261 6d65 7465 7220 6966 206e 6565 6465  rameter if neede
+0000ed70: 642f 706f 7373 6962 6c65 0a20 2020 2020  d/possible.     
+0000ed80: 2020 2020 2020 2020 2020 2069 6620 7768             if wh
+0000ed90: 6572 655f 706f 7374 2069 7320 6e6f 7420  ere_post is not 
+0000eda0: 4e6f 6e65 2061 6e64 206e 6f74 206e 6f74  None and not not
+0000edb0: 2065 7870 6c6f 6465 636f 6c6c 6563 7469   explodecollecti
+0000edc0: 6f6e 733a 0a20 2020 2020 2020 2020 2020  ons:.           
+0000edd0: 2020 2020 2020 2020 2023 2065 7870 6c6f           # explo
+0000ede0: 6465 636f 6c6c 6563 7469 6f6e 7320 6973  decollections is
+0000edf0: 206e 6f74 2054 7275 652c 2073 6f20 7765   not True, so we
+0000ee00: 2063 616e 2061 6464 2069 7420 746f 2073   can add it to s
+0000ee10: 716c 5f73 746d 742e 0a20 2020 2020 2020  ql_stmt..       
+0000ee20: 2020 2020 2020 2020 2020 2020 2023 2049               # I
+0000ee30: 6620 6578 706c 6f64 6563 6f6c 6c65 6374  f explodecollect
+0000ee40: 696f 6e73 2077 6f75 6c64 2062 6520 5472  ions would be Tr
+0000ee50: 7565 2c20 7765 206e 6565 6420 746f 2077  ue, we need to w
+0000ee60: 6169 7420 746f 2061 7070 6c79 2074 6865  ait to apply the
+0000ee70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ee80: 2020 2020 2023 2077 6865 7265 5f70 6f73       # where_pos
+0000ee90: 7420 7469 6c6c 2061 6674 6572 2065 7870  t till after exp
 0000eea0: 6c6f 6465 636f 6c6c 6563 7469 6f6e 7320  lodecollections 
-0000eeb0: 6973 206e 6f74 2054 7275 652c 2073 6f20  is not True, so 
-0000eec0: 7765 2063 616e 2061 6464 2069 7420 746f  we can add it to
-0000eed0: 2073 716c 5f73 746d 742e 0a20 2020 2020   sql_stmt..     
-0000eee0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0000eef0: 2049 6620 6578 706c 6f64 6563 6f6c 6c65   If explodecolle
-0000ef00: 6374 696f 6e73 2077 6f75 6c64 2062 6520  ctions would be 
-0000ef10: 5472 7565 2c20 7765 206e 6565 6420 746f  True, we need to
-0000ef20: 2077 6169 7420 746f 2061 7070 6c79 2074   wait to apply t
-0000ef30: 6865 0a20 2020 2020 2020 2020 2020 2020  he.             
-0000ef40: 2020 2020 2020 2023 2077 6865 7265 5f70         # where_p
-0000ef50: 6f73 7420 7469 6c6c 2061 6674 6572 2065  ost till after e
-0000ef60: 7870 6c6f 6465 636f 6c6c 6563 7469 6f6e  xplodecollection
-0000ef70: 7320 6973 2061 7070 6c69 6564 2c20 736f  s is applied, so
-0000ef80: 2077 6865 6e0a 2020 2020 2020 2020 2020   when.          
-0000ef90: 2020 2020 2020 2020 2020 2320 6170 7065            # appe
-0000efa0: 6e64 696e 6720 7468 6520 7061 7274 6961  nding the partia
-0000efb0: 6c20 7265 7375 6c74 7320 746f 2074 6865  l results to the
-0000efc0: 206f 7574 7075 7420 6669 6c65 2e0a 2020   output file..  
+0000eeb0: 6973 2061 7070 6c69 6564 2c20 736f 2077  is applied, so w
+0000eec0: 6865 6e0a 2020 2020 2020 2020 2020 2020  hen.            
+0000eed0: 2020 2020 2020 2020 2320 6170 7065 6e64          # append
+0000eee0: 696e 6720 7468 6520 7061 7274 6961 6c20  ing the partial 
+0000eef0: 7265 7375 6c74 7320 746f 2074 6865 206f  results to the o
+0000ef00: 7574 7075 7420 6669 6c65 2e0a 2020 2020  utput file..    
+0000ef10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ef20: 7768 6572 655f 706f 7374 203d 2077 6865  where_post = whe
+0000ef30: 7265 5f70 6f73 742e 666f 726d 6174 2867  re_post.format(g
+0000ef40: 656f 6d65 7472 7963 6f6c 756d 6e3d 2267  eometrycolumn="g
+0000ef50: 656f 6d22 290a 2020 2020 2020 2020 2020  eom").          
+0000ef60: 2020 2020 2020 2020 2020 7371 6c5f 7374            sql_st
+0000ef70: 6d74 203d 2066 2222 220a 2020 2020 2020  mt = f""".      
+0000ef80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ef90: 2020 5345 4c45 4354 202a 2046 524f 4d0a    SELECT * FROM.
+0000efa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000efb0: 2020 2020 2020 2020 2020 2020 2820 7b73              ( {s
+0000efc0: 716c 5f73 746d 747d 0a20 2020 2020 2020  ql_stmt}.       
 0000efd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000efe0: 2020 7768 6572 655f 706f 7374 203d 2077    where_post = w
-0000eff0: 6865 7265 5f70 6f73 742e 666f 726d 6174  here_post.format
-0000f000: 2867 656f 6d65 7472 7963 6f6c 756d 6e3d  (geometrycolumn=
-0000f010: 2267 656f 6d22 290a 2020 2020 2020 2020  "geom").        
-0000f020: 2020 2020 2020 2020 2020 2020 7371 6c5f              sql_
-0000f030: 7374 6d74 203d 2066 2222 220a 2020 2020  stmt = f""".    
-0000f040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f050: 2020 2020 5345 4c45 4354 202a 2046 524f      SELECT * FRO
-0000f060: 4d0a 2020 2020 2020 2020 2020 2020 2020  M.              
-0000f070: 2020 2020 2020 2020 2020 2020 2020 2820                ( 
-0000f080: 7b73 716c 5f73 746d 747d 0a20 2020 2020  {sql_stmt}.     
-0000f090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f0a0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0000f0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f0c0: 2057 4845 5245 207b 7768 6572 655f 706f   WHERE {where_po
-0000f0d0: 7374 7d0a 2020 2020 2020 2020 2020 2020  st}.            
-0000f0e0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-0000f0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f100: 2320 7768 6572 655f 706f 7374 2068 6173  # where_post has
-0000f110: 2062 6565 6e20 6170 706c 6965 6420 616c   been applied al
-0000f120: 7265 6164 7920 736f 2073 6574 2074 6f20  ready so set to 
-0000f130: 4e6f 6e65 2e0a 2020 2020 2020 2020 2020  None..          
-0000f140: 2020 2020 2020 2020 2020 7768 6572 655f            where_
-0000f150: 706f 7374 203d 204e 6f6e 650a 0a20 2020  post = None..   
-0000f160: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0000f170: 7768 6572 655f 706f 7374 2069 7320 4e6f  where_post is No
-0000f180: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0000f190: 2020 2020 2020 2020 6e61 6d65 203d 2066          name = f
-0000f1a0: 226f 7574 7075 745f 746d 7032 5f66 696e  "output_tmp2_fin
-0000f1b0: 616c 7b6f 7574 7075 745f 7061 7468 2e73  al{output_path.s
-0000f1c0: 7566 6669 787d 220a 2020 2020 2020 2020  uffix}".        
-0000f1d0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0000f1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f1f0: 2020 6e61 6d65 203d 2066 226f 7574 7075    name = f"outpu
-0000f200: 745f 746d 7032 5f66 696e 616c 7b6f 7574  t_tmp2_final{out
-0000f210: 7075 745f 746d 705f 7061 7468 2e73 7566  put_tmp_path.suf
-0000f220: 6669 787d 220a 2020 2020 2020 2020 2020  fix}".          
-0000f230: 2020 2020 2020 6f75 7470 7574 5f74 6d70        output_tmp
-0000f240: 325f 6669 6e61 6c5f 7061 7468 203d 2074  2_final_path = t
-0000f250: 656d 7064 6972 202f 206e 616d 650a 2020  empdir / name.  
-0000f260: 2020 2020 2020 2020 2020 2020 2020 7371                sq
-0000f270: 6c5f 7374 6d74 203d 2073 716c 5f73 746d  l_stmt = sql_stm
-0000f280: 742e 666f 726d 6174 280a 2020 2020 2020  t.format(.      
-0000f290: 2020 2020 2020 2020 2020 2020 2020 6765                ge
-0000f2a0: 6f6d 6574 7279 636f 6c75 6d6e 3d22 6765  ometrycolumn="ge
-0000f2b0: 6f6d 222c 2069 6e70 7574 5f6c 6179 6572  om", input_layer
-0000f2c0: 3d6f 7574 7075 745f 6c61 7965 720a 2020  =output_layer.  
-0000f2d0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0000f2e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f2f0: 2063 7265 6174 655f 7370 6174 6961 6c5f   create_spatial_
-0000f300: 696e 6465 7820 3d20 5472 7565 2069 6620  index = True if 
-0000f310: 7768 6572 655f 706f 7374 2069 7320 4e6f  where_post is No
-0000f320: 6e65 2065 6c73 6520 4661 6c73 650a 2020  ne else False.  
-0000f330: 2020 2020 2020 2020 2020 2020 2020 6f75                ou
-0000f340: 7470 7574 5f67 656f 6d65 7472 7974 7970  tput_geometrytyp
-0000f350: 6520 3d20 280a 2020 2020 2020 2020 2020  e = (.          
-0000f360: 2020 2020 2020 2020 2020 696e 7075 745f            input_
-0000f370: 6c61 7965 7269 6e66 6f2e 6765 6f6d 6574  layerinfo.geomet
-0000f380: 7279 7479 7065 2e74 6f5f 7369 6e67 6c65  rytype.to_single
-0000f390: 7479 7065 0a20 2020 2020 2020 2020 2020  type.           
-0000f3a0: 2020 2020 2020 2020 2069 6620 6578 706c           if expl
-0000f3b0: 6f64 6563 6f6c 6c65 6374 696f 6e73 0a20  odecollections. 
-0000f3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f3d0: 2020 2065 6c73 6520 696e 7075 745f 6c61     else input_la
-0000f3e0: 7965 7269 6e66 6f2e 6765 6f6d 6574 7279  yerinfo.geometry
-0000f3f0: 7479 7065 2e74 6f5f 6d75 6c74 6974 7970  type.to_multityp
-0000f400: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-0000f410: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0000f420: 2020 2020 5f6f 6772 5f75 7469 6c2e 7665      _ogr_util.ve
-0000f430: 6374 6f72 5f74 7261 6e73 6c61 7465 280a  ctor_translate(.
-0000f440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f450: 2020 2020 696e 7075 745f 7061 7468 3d6f      input_path=o
-0000f460: 7574 7075 745f 746d 705f 7061 7468 2c0a  utput_tmp_path,.
-0000f470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f480: 2020 2020 6f75 7470 7574 5f70 6174 683d      output_path=
-0000f490: 6f75 7470 7574 5f74 6d70 325f 6669 6e61  output_tmp2_fina
-0000f4a0: 6c5f 7061 7468 2c0a 2020 2020 2020 2020  l_path,.        
-0000f4b0: 2020 2020 2020 2020 2020 2020 6f75 7470              outp
-0000f4c0: 7574 5f6c 6179 6572 3d6f 7574 7075 745f  ut_layer=output_
-0000f4d0: 6c61 7965 722c 0a20 2020 2020 2020 2020  layer,.         
-0000f4e0: 2020 2020 2020 2020 2020 2073 716c 5f73             sql_s
-0000f4f0: 746d 743d 7371 6c5f 7374 6d74 2c0a 2020  tmt=sql_stmt,.  
-0000f500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f510: 2020 7371 6c5f 6469 616c 6563 743d 2253    sql_dialect="S
-0000f520: 514c 4954 4522 2c0a 2020 2020 2020 2020  QLITE",.        
-0000f530: 2020 2020 2020 2020 2020 2020 666f 7263              forc
-0000f540: 655f 6f75 7470 7574 5f67 656f 6d65 7472  e_output_geometr
-0000f550: 7974 7970 653d 6f75 7470 7574 5f67 656f  ytype=output_geo
-0000f560: 6d65 7472 7974 7970 652c 0a20 2020 2020  metrytype,.     
-0000f570: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0000f580: 7870 6c6f 6465 636f 6c6c 6563 7469 6f6e  xplodecollection
-0000f590: 733d 6578 706c 6f64 6563 6f6c 6c65 6374  s=explodecollect
-0000f5a0: 696f 6e73 2c0a 2020 2020 2020 2020 2020  ions,.          
-0000f5b0: 2020 2020 2020 2020 2020 6f70 7469 6f6e            option
-0000f5c0: 733d 7b22 4c41 5945 525f 4352 4541 5449  s={"LAYER_CREATI
-0000f5d0: 4f4e 2e53 5041 5449 414c 5f49 4e44 4558  ON.SPATIAL_INDEX
-0000f5e0: 223a 2063 7265 6174 655f 7370 6174 6961  ": create_spatia
-0000f5f0: 6c5f 696e 6465 787d 2c0a 2020 2020 2020  l_index},.      
-0000f600: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-0000f610: 2020 2020 2020 2020 2020 2020 2023 2057               # W
-0000f620: 6520 7374 696c 6c20 6e65 6564 2074 6f20  e still need to 
-0000f630: 6170 706c 7920 7468 6520 7768 6572 655f  apply the where_
-0000f640: 706f 7374 2066 696c 7465 720a 2020 2020  post filter.    
-0000f650: 2020 2020 2020 2020 2020 2020 6966 2077              if w
-0000f660: 6865 7265 5f70 6f73 7420 6973 206e 6f74  here_post is not
-0000f670: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-0000f680: 2020 2020 2020 2020 2020 206e 616d 6520             name 
-0000f690: 3d20 6622 6f75 7470 7574 5f74 6d70 335f  = f"output_tmp3_
-0000f6a0: 7768 6572 657b 6f75 7470 7574 5f70 6174  where{output_pat
-0000f6b0: 682e 7375 6666 6978 7d22 0a20 2020 2020  h.suffix}".     
-0000f6c0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-0000f6d0: 7574 7075 745f 746d 7033 5f77 6865 7265  utput_tmp3_where
-0000f6e0: 5f70 6174 6820 3d20 7465 6d70 6469 7220  _path = tempdir 
-0000f6f0: 2f20 6e61 6d65 0a20 2020 2020 2020 2020  / name.         
-0000f700: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
-0000f710: 745f 746d 7032 5f69 6e66 6f20 3d20 6766  t_tmp2_info = gf
-0000f720: 6f2e 6765 745f 6c61 7965 7269 6e66 6f28  o.get_layerinfo(
-0000f730: 6f75 7470 7574 5f74 6d70 325f 6669 6e61  output_tmp2_fina
-0000f740: 6c5f 7061 7468 290a 2020 2020 2020 2020  l_path).        
-0000f750: 2020 2020 2020 2020 2020 2020 7768 6572              wher
-0000f760: 655f 706f 7374 203d 2077 6865 7265 5f70  e_post = where_p
-0000f770: 6f73 742e 666f 726d 6174 280a 2020 2020  ost.format(.    
-0000f780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f790: 2020 2020 6765 6f6d 6574 7279 636f 6c75      geometrycolu
-0000f7a0: 6d6e 3d6f 7574 7075 745f 746d 7032 5f69  mn=output_tmp2_i
-0000f7b0: 6e66 6f2e 6765 6f6d 6574 7279 636f 6c75  nfo.geometrycolu
-0000f7c0: 6d6e 0a20 2020 2020 2020 2020 2020 2020  mn.             
-0000f7d0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0000f7e0: 2020 2020 2020 2020 2020 2020 2073 716c               sql
-0000f7f0: 5f73 746d 7420 3d20 6622 2222 0a20 2020  _stmt = f""".   
+0000efe0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+0000eff0: 2020 2020 2020 2020 2020 2020 2020 2057                 W
+0000f000: 4845 5245 207b 7768 6572 655f 706f 7374  HERE {where_post
+0000f010: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+0000f020: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0000f030: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0000f040: 7768 6572 655f 706f 7374 2068 6173 2062  where_post has b
+0000f050: 6565 6e20 6170 706c 6965 6420 616c 7265  een applied alre
+0000f060: 6164 7920 736f 2073 6574 2074 6f20 4e6f  ady so set to No
+0000f070: 6e65 2e0a 2020 2020 2020 2020 2020 2020  ne..            
+0000f080: 2020 2020 2020 2020 7768 6572 655f 706f          where_po
+0000f090: 7374 203d 204e 6f6e 650a 0a20 2020 2020  st = None..     
+0000f0a0: 2020 2020 2020 2020 2020 2069 6620 7768             if wh
+0000f0b0: 6572 655f 706f 7374 2069 7320 4e6f 6e65  ere_post is None
+0000f0c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000f0d0: 2020 2020 2020 6e61 6d65 203d 2066 226f        name = f"o
+0000f0e0: 7574 7075 745f 746d 7032 5f66 696e 616c  utput_tmp2_final
+0000f0f0: 7b6f 7574 7075 745f 7061 7468 2e73 7566  {output_path.suf
+0000f100: 6669 787d 220a 2020 2020 2020 2020 2020  fix}".          
+0000f110: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0000f120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f130: 6e61 6d65 203d 2066 226f 7574 7075 745f  name = f"output_
+0000f140: 746d 7032 5f66 696e 616c 7b6f 7574 7075  tmp2_final{outpu
+0000f150: 745f 746d 705f 7061 7468 2e73 7566 6669  t_tmp_path.suffi
+0000f160: 787d 220a 2020 2020 2020 2020 2020 2020  x}".            
+0000f170: 2020 2020 6f75 7470 7574 5f74 6d70 325f      output_tmp2_
+0000f180: 6669 6e61 6c5f 7061 7468 203d 2074 656d  final_path = tem
+0000f190: 7064 6972 202f 206e 616d 650a 2020 2020  pdir / name.    
+0000f1a0: 2020 2020 2020 2020 2020 2020 7371 6c5f              sql_
+0000f1b0: 7374 6d74 203d 2073 716c 5f73 746d 742e  stmt = sql_stmt.
+0000f1c0: 666f 726d 6174 280a 2020 2020 2020 2020  format(.        
+0000f1d0: 2020 2020 2020 2020 2020 2020 6765 6f6d              geom
+0000f1e0: 6574 7279 636f 6c75 6d6e 3d22 6765 6f6d  etrycolumn="geom
+0000f1f0: 222c 2069 6e70 7574 5f6c 6179 6572 3d6f  ", input_layer=o
+0000f200: 7574 7075 745f 6c61 7965 720a 2020 2020  utput_layer.    
+0000f210: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+0000f220: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0000f230: 7265 6174 655f 7370 6174 6961 6c5f 696e  reate_spatial_in
+0000f240: 6465 7820 3d20 280a 2020 2020 2020 2020  dex = (.        
+0000f250: 2020 2020 2020 2020 2020 2020 4765 6f66              Geof
+0000f260: 696c 6549 6e66 6f28 6f75 7470 7574 5f74  ileInfo(output_t
+0000f270: 6d70 325f 6669 6e61 6c5f 7061 7468 292e  mp2_final_path).
+0000f280: 6465 6661 756c 745f 7370 6174 6961 6c5f  default_spatial_
+0000f290: 696e 6465 780a 2020 2020 2020 2020 2020  index.          
+0000f2a0: 2020 2020 2020 2020 2020 6966 2077 6865            if whe
+0000f2b0: 7265 5f70 6f73 7420 6973 204e 6f6e 650a  re_post is None.
+0000f2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f2d0: 2020 2020 656c 7365 2046 616c 7365 0a20      else False. 
+0000f2e0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+0000f2f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f300: 206f 7574 7075 745f 6765 6f6d 6574 7279   output_geometry
+0000f310: 7479 7065 203d 2028 0a20 2020 2020 2020  type = (.       
+0000f320: 2020 2020 2020 2020 2020 2020 2069 6e70               inp
+0000f330: 7574 5f6c 6179 6572 696e 666f 2e67 656f  ut_layerinfo.geo
+0000f340: 6d65 7472 7974 7970 652e 746f 5f73 696e  metrytype.to_sin
+0000f350: 676c 6574 7970 650a 2020 2020 2020 2020  gletype.        
+0000f360: 2020 2020 2020 2020 2020 2020 6966 2065              if e
+0000f370: 7870 6c6f 6465 636f 6c6c 6563 7469 6f6e  xplodecollection
+0000f380: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+0000f390: 2020 2020 2020 656c 7365 2069 6e70 7574        else input
+0000f3a0: 5f6c 6179 6572 696e 666f 2e67 656f 6d65  _layerinfo.geome
+0000f3b0: 7472 7974 7970 652e 746f 5f6d 756c 7469  trytype.to_multi
+0000f3c0: 7479 7065 0a20 2020 2020 2020 2020 2020  type.           
+0000f3d0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+0000f3e0: 2020 2020 2020 205f 6f67 725f 7574 696c         _ogr_util
+0000f3f0: 2e76 6563 746f 725f 7472 616e 736c 6174  .vector_translat
+0000f400: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
+0000f410: 2020 2020 2020 2069 6e70 7574 5f70 6174         input_pat
+0000f420: 683d 6f75 7470 7574 5f74 6d70 5f70 6174  h=output_tmp_pat
+0000f430: 682c 0a20 2020 2020 2020 2020 2020 2020  h,.             
+0000f440: 2020 2020 2020 206f 7574 7075 745f 7061         output_pa
+0000f450: 7468 3d6f 7574 7075 745f 746d 7032 5f66  th=output_tmp2_f
+0000f460: 696e 616c 5f70 6174 682c 0a20 2020 2020  inal_path,.     
+0000f470: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+0000f480: 7574 7075 745f 6c61 7965 723d 6f75 7470  utput_layer=outp
+0000f490: 7574 5f6c 6179 6572 2c0a 2020 2020 2020  ut_layer,.      
+0000f4a0: 2020 2020 2020 2020 2020 2020 2020 7371                sq
+0000f4b0: 6c5f 7374 6d74 3d73 716c 5f73 746d 742c  l_stmt=sql_stmt,
+0000f4c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f4d0: 2020 2020 2073 716c 5f64 6961 6c65 6374       sql_dialect
+0000f4e0: 3d22 5351 4c49 5445 222c 0a20 2020 2020  ="SQLITE",.     
+0000f4f0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000f500: 6f72 6365 5f6f 7574 7075 745f 6765 6f6d  orce_output_geom
+0000f510: 6574 7279 7479 7065 3d6f 7574 7075 745f  etrytype=output_
+0000f520: 6765 6f6d 6574 7279 7479 7065 2c0a 2020  geometrytype,.  
+0000f530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f540: 2020 6578 706c 6f64 6563 6f6c 6c65 6374    explodecollect
+0000f550: 696f 6e73 3d65 7870 6c6f 6465 636f 6c6c  ions=explodecoll
+0000f560: 6563 7469 6f6e 732c 0a20 2020 2020 2020  ections,.       
+0000f570: 2020 2020 2020 2020 2020 2020 206f 7074               opt
+0000f580: 696f 6e73 3d7b 224c 4159 4552 5f43 5245  ions={"LAYER_CRE
+0000f590: 4154 494f 4e2e 5350 4154 4941 4c5f 494e  ATION.SPATIAL_IN
+0000f5a0: 4445 5822 3a20 6372 6561 7465 5f73 7061  DEX": create_spa
+0000f5b0: 7469 616c 5f69 6e64 6578 7d2c 0a20 2020  tial_index},.   
+0000f5c0: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
+0000f5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f5e0: 2320 5765 2073 7469 6c6c 206e 6565 6420  # We still need 
+0000f5f0: 746f 2061 7070 6c79 2074 6865 2077 6865  to apply the whe
+0000f600: 7265 5f70 6f73 7420 6669 6c74 6572 0a20  re_post filter. 
+0000f610: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000f620: 6620 7768 6572 655f 706f 7374 2069 7320  f where_post is 
+0000f630: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+0000f640: 2020 2020 2020 2020 2020 2020 2020 6e61                na
+0000f650: 6d65 203d 2066 226f 7574 7075 745f 746d  me = f"output_tm
+0000f660: 7033 5f77 6865 7265 7b6f 7574 7075 745f  p3_where{output_
+0000f670: 7061 7468 2e73 7566 6669 787d 220a 2020  path.suffix}".  
+0000f680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f690: 2020 6f75 7470 7574 5f74 6d70 335f 7768    output_tmp3_wh
+0000f6a0: 6572 655f 7061 7468 203d 2074 656d 7064  ere_path = tempd
+0000f6b0: 6972 202f 206e 616d 650a 2020 2020 2020  ir / name.      
+0000f6c0: 2020 2020 2020 2020 2020 2020 2020 6f75                ou
+0000f6d0: 7470 7574 5f74 6d70 325f 696e 666f 203d  tput_tmp2_info =
+0000f6e0: 2067 666f 2e67 6574 5f6c 6179 6572 696e   gfo.get_layerin
+0000f6f0: 666f 286f 7574 7075 745f 746d 7032 5f66  fo(output_tmp2_f
+0000f700: 696e 616c 5f70 6174 6829 0a20 2020 2020  inal_path).     
+0000f710: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+0000f720: 6865 7265 5f70 6f73 7420 3d20 7768 6572  here_post = wher
+0000f730: 655f 706f 7374 2e66 6f72 6d61 7428 0a20  e_post.format(. 
+0000f740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f750: 2020 2020 2020 2067 656f 6d65 7472 7963         geometryc
+0000f760: 6f6c 756d 6e3d 6f75 7470 7574 5f74 6d70  olumn=output_tmp
+0000f770: 325f 696e 666f 2e67 656f 6d65 7472 7963  2_info.geometryc
+0000f780: 6f6c 756d 6e0a 2020 2020 2020 2020 2020  olumn.          
+0000f790: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0000f7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f7b0: 7371 6c5f 7374 6d74 203d 2066 2222 220a  sql_stmt = f""".
+0000f7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f7d0: 2020 2020 2020 2020 5345 4c45 4354 202a          SELECT *
+0000f7e0: 2046 524f 4d20 227b 6f75 7470 7574 5f6c   FROM "{output_l
+0000f7f0: 6179 6572 7d22 0a20 2020 2020 2020 2020  ayer}".         
 0000f800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f810: 2020 2020 2053 454c 4543 5420 2a20 4652       SELECT * FR
-0000f820: 4f4d 2022 7b6f 7574 7075 745f 6c61 7965  OM "{output_laye
-0000f830: 727d 220a 2020 2020 2020 2020 2020 2020  r}".            
-0000f840: 2020 2020 2020 2020 2020 2020 2057 4845               WHE
-0000f850: 5245 207b 7768 6572 655f 706f 7374 7d0a  RE {where_post}.
-0000f860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f870: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0000f880: 2020 2020 2020 2020 2020 2020 746d 705f              tmp_
-0000f890: 696e 666f 203d 2067 666f 2e67 6574 5f6c  info = gfo.get_l
-0000f8a0: 6179 6572 696e 666f 286f 7574 7075 745f  ayerinfo(output_
-0000f8b0: 746d 7032 5f66 696e 616c 5f70 6174 682c  tmp2_final_path,
-0000f8c0: 206f 7574 7075 745f 6c61 7965 7229 0a20   output_layer). 
-0000f8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f8e0: 2020 2073 716c 5f73 746d 7420 3d20 7371     sql_stmt = sq
-0000f8f0: 6c5f 7374 6d74 2e66 6f72 6d61 7428 6765  l_stmt.format(ge
-0000f900: 6f6d 6574 7279 636f 6c75 6d6e 3d74 6d70  ometrycolumn=tmp
-0000f910: 5f69 6e66 6f2e 6765 6f6d 6574 7279 636f  _info.geometryco
-0000f920: 6c75 6d6e 290a 2020 2020 2020 2020 2020  lumn).          
-0000f930: 2020 2020 2020 2020 2020 5f6f 6772 5f75            _ogr_u
-0000f940: 7469 6c2e 7665 6374 6f72 5f74 7261 6e73  til.vector_trans
-0000f950: 6c61 7465 280a 2020 2020 2020 2020 2020  late(.          
-0000f960: 2020 2020 2020 2020 2020 2020 2020 696e                in
-0000f970: 7075 745f 7061 7468 3d6f 7574 7075 745f  put_path=output_
-0000f980: 746d 7032 5f66 696e 616c 5f70 6174 682c  tmp2_final_path,
-0000f990: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f9a0: 2020 2020 2020 2020 206f 7574 7075 745f           output_
-0000f9b0: 7061 7468 3d6f 7574 7075 745f 746d 7033  path=output_tmp3
-0000f9c0: 5f77 6865 7265 5f70 6174 682c 0a20 2020  _where_path,.   
-0000f9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f9e0: 2020 2020 206f 7574 7075 745f 6c61 7965       output_laye
-0000f9f0: 723d 6f75 7470 7574 5f6c 6179 6572 2c0a  r=output_layer,.
-0000fa00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fa10: 2020 2020 2020 2020 666f 7263 655f 6f75          force_ou
-0000fa20: 7470 7574 5f67 656f 6d65 7472 7974 7970  tput_geometrytyp
-0000fa30: 653d 6f75 7470 7574 5f67 656f 6d65 7472  e=output_geometr
-0000fa40: 7974 7970 652c 0a20 2020 2020 2020 2020  ytype,.         
-0000fa50: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0000fa60: 716c 5f73 746d 743d 7371 6c5f 7374 6d74  ql_stmt=sql_stmt
-0000fa70: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000fa80: 2020 2020 2020 2020 2020 7371 6c5f 6469            sql_di
-0000fa90: 616c 6563 743d 2253 514c 4954 4522 2c0a  alect="SQLITE",.
-0000faa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fab0: 2020 2020 2020 2020 6f70 7469 6f6e 733d          options=
-0000fac0: 7b22 4c41 5945 525f 4352 4541 5449 4f4e  {"LAYER_CREATION
-0000fad0: 2e53 5041 5449 414c 5f49 4e44 4558 223a  .SPATIAL_INDEX":
-0000fae0: 2054 7275 657d 2c0a 2020 2020 2020 2020   True},.        
-0000faf0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0000fb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fb10: 2020 6f75 7470 7574 5f74 6d70 325f 6669    output_tmp2_fi
-0000fb20: 6e61 6c5f 7061 7468 203d 206f 7574 7075  nal_path = outpu
-0000fb30: 745f 746d 7033 5f77 6865 7265 5f70 6174  t_tmp3_where_pat
-0000fb40: 680a 0a20 2020 2020 2020 2020 2020 2020  h..             
-0000fb50: 2020 2023 204e 6f77 2077 6520 6172 6520     # Now we are 
-0000fb60: 7265 6164 7920 746f 206d 6f76 6520 7468  ready to move th
-0000fb70: 6520 7265 7375 6c74 2074 6f20 7468 6520  e result to the 
-0000fb80: 6669 6e61 6c20 7370 6f74 2e2e 2e0a 2020  final spot....  
-0000fb90: 2020 2020 2020 2020 2020 2020 2020 6766                gf
-0000fba0: 6f2e 6d6f 7665 286f 7574 7075 745f 746d  o.move(output_tm
-0000fbb0: 7032 5f66 696e 616c 5f70 6174 682c 206f  p2_final_path, o
-0000fbc0: 7574 7075 745f 7061 7468 290a 0a20 2020  utput_path)..   
-0000fbd0: 2020 2020 2066 696e 616c 6c79 3a0a 2020       finally:.  
-0000fbe0: 2020 2020 2020 2020 2020 7368 7574 696c            shutil
-0000fbf0: 2e72 6d74 7265 6528 7465 6d70 6469 722c  .rmtree(tempdir,
-0000fc00: 2069 676e 6f72 655f 6572 726f 7273 3d54   ignore_errors=T
-0000fc10: 7275 6529 0a20 2020 2065 6c73 653a 0a20  rue).    else:. 
-0000fc20: 2020 2020 2020 2072 6169 7365 204e 6f74         raise Not
-0000fc30: 496d 706c 656d 656e 7465 6445 7272 6f72  ImplementedError
-0000fc40: 280a 2020 2020 2020 2020 2020 2020 6622  (.            f"
-0000fc50: 556e 7375 7070 6f72 7465 6420 696e 7075  Unsupported inpu
-0000fc60: 7420 6765 6f6d 6574 7279 7479 7065 3a20  t geometrytype: 
-0000fc70: 7b69 6e70 7574 5f6c 6179 6572 696e 666f  {input_layerinfo
-0000fc80: 2e67 656f 6d65 7472 7974 7970 657d 220a  .geometrytype}".
-0000fc90: 2020 2020 2020 2020 290a 0a20 2020 2023          )..    #
-0000fca0: 2052 6574 7572 6e20 7265 7375 6c74 2069   Return result i
-0000fcb0: 6e66 6f0a 2020 2020 7265 7375 6c74 5f69  nfo.    result_i
-0000fcc0: 6e66 6f5b 226d 6573 7361 6765 225d 203d  nfo["message"] =
-0000fcd0: 2066 2252 6561 6479 2c20 746f 6f6b 207b   f"Ready, took {
-0000fce0: 6461 7465 7469 6d65 2e6e 6f77 2829 2d73  datetime.now()-s
-0000fcf0: 7461 7274 5f74 696d 657d 220a 2020 2020  tart_time}".    
-0000fd00: 6c6f 6767 6572 2e69 6e66 6f28 7265 7375  logger.info(resu
-0000fd10: 6c74 5f69 6e66 6f5b 226d 6573 7361 6765  lt_info["message
-0000fd20: 225d 290a 2020 2020 7265 7475 726e 2072  "]).    return r
-0000fd30: 6573 756c 745f 696e 666f 0a0a 0a64 6566  esult_info...def
-0000fd40: 205f 6469 7373 6f6c 7665 5f70 6f6c 7967   _dissolve_polyg
-0000fd50: 6f6e 735f 7061 7373 280a 2020 2020 696e  ons_pass(.    in
-0000fd60: 7075 745f 7061 7468 3a20 5061 7468 2c0a  put_path: Path,.
-0000fd70: 2020 2020 6f75 7470 7574 5f6e 6f74 6f6e      output_noton
-0000fd80: 626f 7264 6572 5f70 6174 683a 2050 6174  border_path: Pat
-0000fd90: 682c 0a20 2020 206f 7574 7075 745f 6f6e  h,.    output_on
-0000fda0: 626f 7264 6572 5f70 6174 683a 2050 6174  border_path: Pat
-0000fdb0: 682c 0a20 2020 2065 7870 6c6f 6465 636f  h,.    explodeco
-0000fdc0: 6c6c 6563 7469 6f6e 733a 2062 6f6f 6c2c  llections: bool,
-0000fdd0: 0a20 2020 2067 726f 7570 6279 5f63 6f6c  .    groupby_col
-0000fde0: 756d 6e73 3a20 4f70 7469 6f6e 616c 5b49  umns: Optional[I
-0000fdf0: 7465 7261 626c 655b 7374 725d 5d2c 0a20  terable[str]],. 
-0000fe00: 2020 2061 6767 5f63 6f6c 756d 6e73 3a20     agg_columns: 
-0000fe10: 4f70 7469 6f6e 616c 5b64 6963 745d 2c0a  Optional[dict],.
-0000fe20: 2020 2020 7469 6c65 735f 6764 663a 2067      tiles_gdf: g
-0000fe30: 7064 2e47 656f 4461 7461 4672 616d 652c  pd.GeoDataFrame,
-0000fe40: 0a20 2020 2069 6e70 7574 5f6c 6179 6572  .    input_layer
-0000fe50: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d2c  : Optional[str],
-0000fe60: 0a20 2020 206f 7574 7075 745f 6c61 7965  .    output_laye
-0000fe70: 723a 204f 7074 696f 6e61 6c5b 7374 725d  r: Optional[str]
-0000fe80: 2c0a 2020 2020 6772 6964 7369 7a65 3a20  ,.    gridsize: 
-0000fe90: 666c 6f61 742c 0a20 2020 206b 6565 705f  float,.    keep_
-0000fea0: 656d 7074 795f 6765 6f6d 733a 2062 6f6f  empty_geoms: boo
-0000feb0: 6c2c 0a20 2020 206e 625f 7061 7261 6c6c  l,.    nb_parall
-0000fec0: 656c 3a20 696e 742c 0a29 3a0a 2020 2020  el: int,.):.    
-0000fed0: 7374 6172 745f 7469 6d65 203d 2064 6174  start_time = dat
-0000fee0: 6574 696d 652e 6e6f 7728 290a 0a20 2020  etime.now()..   
-0000fef0: 2023 204d 616b 6520 7375 7265 2074 6865   # Make sure the
-0000ff00: 2069 6e70 7574 2066 696c 6520 6861 7320   input file has 
-0000ff10: 6120 7370 6174 6961 6c20 696e 6465 780a  a spatial index.
-0000ff20: 2020 2020 6766 6f2e 6372 6561 7465 5f73      gfo.create_s
-0000ff30: 7061 7469 616c 5f69 6e64 6578 2869 6e70  patial_index(inp
-0000ff40: 7574 5f70 6174 682c 206c 6179 6572 3d69  ut_path, layer=i
-0000ff50: 6e70 7574 5f6c 6179 6572 2c20 6578 6973  nput_layer, exis
-0000ff60: 745f 6f6b 3d54 7275 6529 0a0a 2020 2020  t_ok=True)..    
-0000ff70: 2320 5374 6172 7420 6361 6c63 756c 6174  # Start calculat
-0000ff80: 696f 6e20 696e 2070 6172 616c 6c65 6c0a  ion in parallel.
-0000ff90: 2020 2020 696e 7075 745f 6c61 7965 7269      input_layeri
-0000ffa0: 6e66 6f20 3d20 6766 6f2e 6765 745f 6c61  nfo = gfo.get_la
-0000ffb0: 7965 7269 6e66 6f28 696e 7075 745f 7061  yerinfo(input_pa
-0000ffc0: 7468 2c20 696e 7075 745f 6c61 7965 7229  th, input_layer)
-0000ffd0: 0a0a 2020 2020 2320 5072 6f63 6573 7369  ..    # Processi
-0000ffe0: 6e67 2069 6e20 7468 7265 6164 7320 6973  ng in threads is
-0000fff0: 2032 7820 6661 7374 6572 2066 6f72 2073   2x faster for s
-00010000: 6d61 6c6c 2064 6174 6173 6574 7320 286f  mall datasets (o
-00010010: 6e20 5769 6e64 6f77 7329 0a20 2020 2063  n Windows).    c
-00010020: 616c 6375 6c61 7465 5f69 6e5f 7468 7265  alculate_in_thre
-00010030: 6164 7320 3d20 5472 7565 2069 6620 696e  ads = True if in
-00010040: 7075 745f 6c61 7965 7269 6e66 6f2e 6665  put_layerinfo.fe
-00010050: 6174 7572 6563 6f75 6e74 203c 3d20 3130  aturecount <= 10
-00010060: 3020 656c 7365 2046 616c 7365 0a20 2020  0 else False.   
-00010070: 2077 6974 6820 5f70 726f 6365 7373 696e   with _processin
-00010080: 675f 7574 696c 2e50 6f6f 6c65 6445 7865  g_util.PooledExe
-00010090: 6375 746f 7246 6163 746f 7279 280a 2020  cutorFactory(.  
-000100a0: 2020 2020 2020 7468 7265 6164 706f 6f6c        threadpool
-000100b0: 3d63 616c 6375 6c61 7465 5f69 6e5f 7468  =calculate_in_th
-000100c0: 7265 6164 732c 0a20 2020 2020 2020 206d  reads,.        m
-000100d0: 6178 5f77 6f72 6b65 7273 3d6e 625f 7061  ax_workers=nb_pa
-000100e0: 7261 6c6c 656c 2c0a 2020 2020 2020 2020  rallel,.        
-000100f0: 696e 6974 6961 6c69 7a65 723d 5f70 726f  initializer=_pro
-00010100: 6365 7373 696e 675f 7574 696c 2e69 6e69  cessing_util.ini
-00010110: 7469 616c 697a 655f 776f 726b 6572 2829  tialize_worker()
-00010120: 2c0a 2020 2020 2920 6173 2063 616c 6375  ,.    ) as calcu
-00010130: 6c61 7465 5f70 6f6f 6c3a 0a20 2020 2020  late_pool:.     
-00010140: 2020 2023 2050 7265 7061 7265 206f 7574     # Prepare out
-00010150: 7075 7420 6669 6c65 6e61 6d65 0a20 2020  put filename.   
-00010160: 2020 2020 2074 656d 7064 6972 203d 206f       tempdir = o
-00010170: 7574 7075 745f 6f6e 626f 7264 6572 5f70  utput_onborder_p
-00010180: 6174 682e 7061 7265 6e74 0a0a 2020 2020  ath.parent..    
-00010190: 2020 2020 6261 7463 6865 733a 2044 6963      batches: Dic
-000101a0: 745b 696e 742c 2064 6963 745d 203d 207b  t[int, dict] = {
-000101b0: 7d0a 2020 2020 2020 2020 6e62 5f62 6174  }.        nb_bat
-000101c0: 6368 6573 203d 206c 656e 2874 696c 6573  ches = len(tiles
-000101d0: 5f67 6466 290a 2020 2020 2020 2020 6e62  _gdf).        nb
-000101e0: 5f62 6174 6368 6573 5f64 6f6e 6520 3d20  _batches_done = 
-000101f0: 300a 2020 2020 2020 2020 6675 7475 7265  0.        future
-00010200: 5f74 6f5f 6261 7463 685f 6964 203d 207b  _to_batch_id = {
-00010210: 7d0a 2020 2020 2020 2020 6e62 5f72 6f77  }.        nb_row
-00010220: 735f 646f 6e65 203d 2030 0a20 2020 2020  s_done = 0.     
-00010230: 2020 2066 6f72 2062 6174 6368 5f69 642c     for batch_id,
-00010240: 2074 696c 655f 726f 7720 696e 2065 6e75   tile_row in enu
-00010250: 6d65 7261 7465 2874 696c 6573 5f67 6466  merate(tiles_gdf
-00010260: 2e69 7465 7274 7570 6c65 7328 2929 3a0a  .itertuples()):.
-00010270: 2020 2020 2020 2020 2020 2020 6261 7463              batc
-00010280: 6865 735b 6261 7463 685f 6964 5d20 3d20  hes[batch_id] = 
-00010290: 7b7d 0a20 2020 2020 2020 2020 2020 2062  {}.            b
-000102a0: 6174 6368 6573 5b62 6174 6368 5f69 645d  atches[batch_id]
-000102b0: 5b22 6c61 7965 7222 5d20 3d20 6f75 7470  ["layer"] = outp
-000102c0: 7574 5f6c 6179 6572 0a20 2020 2020 2020  ut_layer.       
-000102d0: 2020 2020 2062 6174 6368 6573 5b62 6174       batches[bat
-000102e0: 6368 5f69 645d 5b22 626f 756e 6473 225d  ch_id]["bounds"]
-000102f0: 203d 2074 696c 655f 726f 772e 6765 6f6d   = tile_row.geom
-00010300: 6574 7279 2e62 6f75 6e64 730a 0a20 2020  etry.bounds..   
-00010310: 2020 2020 2020 2020 2023 204f 7574 7075           # Outpu
-00010320: 7420 6561 6368 2062 6174 6368 2074 6f20  t each batch to 
-00010330: 6120 7365 7065 7261 7465 2074 656d 706f  a seperate tempo
-00010340: 7261 7279 2066 696c 652c 206f 7468 6572  rary file, other
-00010350: 7769 7365 2074 6865 7265 0a20 2020 2020  wise there.     
-00010360: 2020 2020 2020 2023 2061 7265 2074 696d         # are tim
-00010370: 656f 7574 2069 7373 7565 7320 7768 656e  eout issues when
-00010380: 2070 726f 6365 7373 696e 6720 6c61 7267   processing larg
-00010390: 6520 6669 6c65 730a 2020 2020 2020 2020  e files.        
-000103a0: 2020 2020 7375 6666 6978 203d 206f 7574      suffix = out
-000103b0: 7075 745f 6e6f 746f 6e62 6f72 6465 725f  put_notonborder_
-000103c0: 7061 7468 2e73 7566 6669 780a 2020 2020  path.suffix.    
-000103d0: 2020 2020 2020 2020 6e61 6d65 203d 2066          name = f
-000103e0: 227b 6f75 7470 7574 5f6e 6f74 6f6e 626f  "{output_notonbo
-000103f0: 7264 6572 5f70 6174 682e 7374 656d 7d5f  rder_path.stem}_
-00010400: 7b62 6174 6368 5f69 647d 7b73 7566 6669  {batch_id}{suffi
-00010410: 787d 220a 2020 2020 2020 2020 2020 2020  x}".            
-00010420: 6f75 7470 7574 5f6e 6f74 6f6e 626f 7264  output_notonbord
-00010430: 6572 5f74 6d70 5f70 6172 7469 616c 5f70  er_tmp_partial_p
-00010440: 6174 6820 3d20 7465 6d70 6469 7220 2f20  ath = tempdir / 
-00010450: 6e61 6d65 0a20 2020 2020 2020 2020 2020  name.           
-00010460: 2062 6174 6368 6573 5b62 6174 6368 5f69   batches[batch_i
-00010470: 645d 5b0a 2020 2020 2020 2020 2020 2020  d][.            
-00010480: 2020 2020 226f 7574 7075 745f 6e6f 746f      "output_noto
-00010490: 6e62 6f72 6465 725f 746d 705f 7061 7274  nborder_tmp_part
-000104a0: 6961 6c5f 7061 7468 220a 2020 2020 2020  ial_path".      
-000104b0: 2020 2020 2020 5d20 3d20 6f75 7470 7574        ] = output
-000104c0: 5f6e 6f74 6f6e 626f 7264 6572 5f74 6d70  _notonborder_tmp
-000104d0: 5f70 6172 7469 616c 5f70 6174 680a 2020  _partial_path.  
-000104e0: 2020 2020 2020 2020 2020 6e61 6d65 203d            name =
-000104f0: 2066 227b 6f75 7470 7574 5f6f 6e62 6f72   f"{output_onbor
-00010500: 6465 725f 7061 7468 2e73 7465 6d7d 5f7b  der_path.stem}_{
-00010510: 6261 7463 685f 6964 7d7b 7375 6666 6978  batch_id}{suffix
-00010520: 7d22 0a20 2020 2020 2020 2020 2020 206f  }".            o
-00010530: 7574 7075 745f 6f6e 626f 7264 6572 5f74  utput_onborder_t
-00010540: 6d70 5f70 6172 7469 616c 5f70 6174 6820  mp_partial_path 
-00010550: 3d20 7465 6d70 6469 7220 2f20 6e61 6d65  = tempdir / name
-00010560: 0a20 2020 2020 2020 2020 2020 2062 6174  .            bat
-00010570: 6368 6573 5b62 6174 6368 5f69 645d 5b0a  ches[batch_id][.
-00010580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010590: 226f 7574 7075 745f 6f6e 626f 7264 6572  "output_onborder
-000105a0: 5f74 6d70 5f70 6172 7469 616c 5f70 6174  _tmp_partial_pat
-000105b0: 6822 0a20 2020 2020 2020 2020 2020 205d  h".            ]
-000105c0: 203d 206f 7574 7075 745f 6f6e 626f 7264   = output_onbord
-000105d0: 6572 5f74 6d70 5f70 6172 7469 616c 5f70  er_tmp_partial_p
-000105e0: 6174 680a 0a20 2020 2020 2020 2020 2020  ath..           
-000105f0: 2023 2047 6574 2074 696c 655f 6964 2069   # Get tile_id i
-00010600: 6620 7072 6573 656e 740a 2020 2020 2020  f present.      
-00010610: 2020 2020 2020 7469 6c65 5f69 6420 3d20        tile_id = 
-00010620: 7469 6c65 5f72 6f77 2e74 696c 655f 6964  tile_row.tile_id
-00010630: 2069 6620 2274 696c 655f 6964 2220 696e   if "tile_id" in
-00010640: 2074 696c 655f 726f 772e 5f66 6965 6c64   tile_row._field
-00010650: 7320 656c 7365 204e 6f6e 650a 0a20 2020  s else None..   
-00010660: 2020 2020 2020 2020 2066 7574 7572 6520           future 
-00010670: 3d20 6361 6c63 756c 6174 655f 706f 6f6c  = calculate_pool
-00010680: 2e73 7562 6d69 7428 0a20 2020 2020 2020  .submit(.       
-00010690: 2020 2020 2020 2020 205f 6469 7373 6f6c           _dissol
-000106a0: 7665 5f70 6f6c 7967 6f6e 732c 0a20 2020  ve_polygons,.   
-000106b0: 2020 2020 2020 2020 2020 2020 2069 6e70               inp
-000106c0: 7574 5f70 6174 683d 696e 7075 745f 7061  ut_path=input_pa
-000106d0: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
-000106e0: 2020 2020 6f75 7470 7574 5f6e 6f74 6f6e      output_noton
-000106f0: 626f 7264 6572 5f70 6174 683d 6f75 7470  border_path=outp
-00010700: 7574 5f6e 6f74 6f6e 626f 7264 6572 5f74  ut_notonborder_t
-00010710: 6d70 5f70 6172 7469 616c 5f70 6174 682c  mp_partial_path,
-00010720: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010730: 206f 7574 7075 745f 6f6e 626f 7264 6572   output_onborder
-00010740: 5f70 6174 683d 6f75 7470 7574 5f6f 6e62  _path=output_onb
-00010750: 6f72 6465 725f 746d 705f 7061 7274 6961  order_tmp_partia
-00010760: 6c5f 7061 7468 2c0a 2020 2020 2020 2020  l_path,.        
-00010770: 2020 2020 2020 2020 6578 706c 6f64 6563          explodec
-00010780: 6f6c 6c65 6374 696f 6e73 3d65 7870 6c6f  ollections=explo
-00010790: 6465 636f 6c6c 6563 7469 6f6e 732c 0a20  decollections,. 
-000107a0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-000107b0: 726f 7570 6279 5f63 6f6c 756d 6e73 3d67  roupby_columns=g
-000107c0: 726f 7570 6279 5f63 6f6c 756d 6e73 2c0a  roupby_columns,.
-000107d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000107e0: 6167 675f 636f 6c75 6d6e 733d 6167 675f  agg_columns=agg_
-000107f0: 636f 6c75 6d6e 732c 0a20 2020 2020 2020  columns,.       
-00010800: 2020 2020 2020 2020 2069 6e70 7574 5f67           input_g
-00010810: 656f 6d65 7472 7974 7970 653d 696e 7075  eometrytype=inpu
-00010820: 745f 6c61 7965 7269 6e66 6f2e 6765 6f6d  t_layerinfo.geom
-00010830: 6574 7279 7479 7065 2c0a 2020 2020 2020  etrytype,.      
-00010840: 2020 2020 2020 2020 2020 696e 7075 745f            input_
-00010850: 6c61 7965 723d 696e 7075 745f 6c61 7965  layer=input_laye
-00010860: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
-00010870: 2020 206f 7574 7075 745f 6c61 7965 723d     output_layer=
-00010880: 6f75 7470 7574 5f6c 6179 6572 2c0a 2020  output_layer,.  
-00010890: 2020 2020 2020 2020 2020 2020 2020 6262                bb
-000108a0: 6f78 3d74 696c 655f 726f 772e 6765 6f6d  ox=tile_row.geom
-000108b0: 6574 7279 2e62 6f75 6e64 732c 0a20 2020  etry.bounds,.   
-000108c0: 2020 2020 2020 2020 2020 2020 2074 696c               til
-000108d0: 655f 6964 3d74 696c 655f 6964 2c0a 2020  e_id=tile_id,.  
-000108e0: 2020 2020 2020 2020 2020 2020 2020 6772                gr
-000108f0: 6964 7369 7a65 3d67 7269 6473 697a 652c  idsize=gridsize,
-00010900: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010910: 206b 6565 705f 656d 7074 795f 6765 6f6d   keep_empty_geom
-00010920: 733d 6b65 6570 5f65 6d70 7479 5f67 656f  s=keep_empty_geo
-00010930: 6d73 2c0a 2020 2020 2020 2020 2020 2020  ms,.            
-00010940: 290a 2020 2020 2020 2020 2020 2020 6675  ).            fu
-00010950: 7475 7265 5f74 6f5f 6261 7463 685f 6964  ture_to_batch_id
-00010960: 5b66 7574 7572 655d 203d 2062 6174 6368  [future] = batch
-00010970: 5f69 640a 0a20 2020 2020 2020 2023 204c  _id..        # L
-00010980: 6f6f 7020 7469 6c6c 2061 6c6c 2070 6172  oop till all par
-00010990: 616c 6c65 6c20 7072 6f63 6573 7365 7320  allel processes 
-000109a0: 6172 6520 7265 6164 792c 2062 7574 2070  are ready, but p
-000109b0: 726f 6365 7373 2065 6163 6820 6f6e 650a  rocess each one.
-000109c0: 2020 2020 2020 2020 2320 7468 6174 2069          # that i
-000109d0: 7320 7265 6164 7920 616c 7265 6164 790a  s ready already.
-000109e0: 2020 2020 2020 2020 5f67 656e 6572 616c          _general
-000109f0: 5f75 7469 6c2e 7265 706f 7274 5f70 726f  _util.report_pro
-00010a00: 6772 6573 7328 0a20 2020 2020 2020 2020  gress(.         
-00010a10: 2020 2073 7461 7274 5f74 696d 652c 206e     start_time, n
-00010a20: 625f 6261 7463 6865 735f 646f 6e65 2c20  b_batches_done, 
-00010a30: 6e62 5f62 6174 6368 6573 2c20 2264 6973  nb_batches, "dis
-00010a40: 736f 6c76 6522 0a20 2020 2020 2020 2029  solve".        )
-00010a50: 0a20 2020 2020 2020 2066 6f72 2066 7574  .        for fut
-00010a60: 7572 6520 696e 2066 7574 7572 6573 2e61  ure in futures.a
-00010a70: 735f 636f 6d70 6c65 7465 6428 6675 7475  s_completed(futu
-00010a80: 7265 5f74 6f5f 6261 7463 685f 6964 293a  re_to_batch_id):
-00010a90: 0a20 2020 2020 2020 2020 2020 2074 7279  .            try
-00010aa0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00010ab0: 2020 2320 4966 2074 6865 2063 616c 6375    # If the calcu
-00010ac0: 6c61 7465 2067 6176 6520 7265 7375 6c74  late gave result
-00010ad0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-00010ae0: 2020 6e62 5f62 6174 6368 6573 5f64 6f6e    nb_batches_don
-00010af0: 6520 2b3d 2031 0a20 2020 2020 2020 2020  e += 1.         
-00010b00: 2020 2020 2020 2062 6174 6368 5f69 6420         batch_id 
-00010b10: 3d20 6675 7475 7265 5f74 6f5f 6261 7463  = future_to_batc
-00010b20: 685f 6964 5b66 7574 7572 655d 0a20 2020  h_id[future].   
-00010b30: 2020 2020 2020 2020 2020 2020 2072 6573               res
-00010b40: 756c 7420 3d20 6675 7475 7265 2e72 6573  ult = future.res
-00010b50: 756c 7428 290a 0a20 2020 2020 2020 2020  ult()..         
-00010b60: 2020 2020 2020 2069 6620 7265 7375 6c74         if result
-00010b70: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-00010b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010b90: 2020 6e62 5f72 6f77 735f 646f 6e65 202b    nb_rows_done +
-00010ba0: 3d20 7265 7375 6c74 5b22 6e62 5f72 6f77  = result["nb_row
-00010bb0: 735f 646f 6e65 225d 0a20 2020 2020 2020  s_done"].       
-00010bc0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00010bd0: 7265 7375 6c74 5b22 6e62 5f72 6f77 735f  result["nb_rows_
-00010be0: 646f 6e65 225d 203e 2030 2061 6e64 2072  done"] > 0 and r
-00010bf0: 6573 756c 745b 2274 6f74 616c 5f74 696d  esult["total_tim
-00010c00: 6522 5d20 3e20 303a 0a20 2020 2020 2020  e"] > 0:.       
-00010c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010c20: 2072 6f77 735f 7065 725f 7365 6320 3d20   rows_per_sec = 
-00010c30: 726f 756e 6428 0a20 2020 2020 2020 2020  round(.         
-00010c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010c50: 2020 2072 6573 756c 745b 226e 625f 726f     result["nb_ro
-00010c60: 7773 5f64 6f6e 6522 5d20 2f20 7265 7375  ws_done"] / resu
-00010c70: 6c74 5b22 746f 7461 6c5f 7469 6d65 225d  lt["total_time"]
-00010c80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010c90: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00010ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010cb0: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
-00010cc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010cd0: 2020 2020 2020 2020 2020 2020 2066 2242               f"B
-00010ce0: 6174 6368 207b 6261 7463 685f 6964 7d20  atch {batch_id} 
-00010cf0: 7072 6f63 6573 7365 6420 7b72 6573 756c  processed {resul
-00010d00: 745b 276e 625f 726f 7773 5f64 6f6e 6527  t['nb_rows_done'
-00010d10: 5d7d 2072 6f77 7320 220a 2020 2020 2020  ]} rows ".      
-00010d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010d30: 2020 2020 2020 6622 287b 726f 7773 5f70        f"({rows_p
-00010d40: 6572 5f73 6563 7d2f 7365 6329 220a 2020  er_sec}/sec)".  
-00010d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010d60: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00010d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010d80: 6966 2022 7065 7266 7374 7269 6e67 2220  if "perfstring" 
-00010d90: 696e 2072 6573 756c 743a 0a20 2020 2020  in result:.     
-00010da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010db0: 2020 2020 2020 206c 6f67 6765 722e 6465         logger.de
-00010dc0: 6275 6728 6622 5065 7266 7374 7269 6e67  bug(f"Perfstring
-00010dd0: 3a20 7b72 6573 756c 745b 2770 6572 6673  : {result['perfs
-00010de0: 7472 696e 6727 5d7d 2229 0a0a 2020 2020  tring']}")..    
-00010df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010e00: 2320 5374 6172 7420 636f 7079 206f 6620  # Start copy of 
-00010e10: 7468 6520 7265 7375 6c74 2074 6f20 6120  the result to a 
-00010e20: 636f 6d6d 6f6e 2066 696c 650a 2020 2020  common file.    
-00010e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010e40: 6261 7463 685f 6964 203d 2066 7574 7572  batch_id = futur
-00010e50: 655f 746f 5f62 6174 6368 5f69 645b 6675  e_to_batch_id[fu
-00010e60: 7475 7265 5d0a 0a20 2020 2020 2020 2020  ture]..         
-00010e70: 2020 2020 2020 2020 2020 2023 2049 6620             # If 
-00010e80: 6361 6c63 756c 6174 6520 6761 7665 206e  calculate gave n
-00010e90: 6f74 6f6e 626f 7264 6572 2072 6573 756c  otonborder resul
-00010ea0: 7473 2c20 6170 7065 6e64 2074 6f20 6f75  ts, append to ou
-00010eb0: 7470 7574 0a20 2020 2020 2020 2020 2020  tput.           
-00010ec0: 2020 2020 2020 2020 206f 7574 7075 745f           output_
-00010ed0: 6e6f 746f 6e62 6f72 6465 725f 746d 705f  notonborder_tmp_
-00010ee0: 7061 7274 6961 6c5f 7061 7468 203d 2062  partial_path = b
-00010ef0: 6174 6368 6573 5b62 6174 6368 5f69 645d  atches[batch_id]
-00010f00: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
-00010f10: 2020 2020 2020 2020 2020 226f 7574 7075            "outpu
-00010f20: 745f 6e6f 746f 6e62 6f72 6465 725f 746d  t_notonborder_tm
-00010f30: 705f 7061 7274 6961 6c5f 7061 7468 220a  p_partial_path".
-00010f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010f50: 2020 2020 5d0a 2020 2020 2020 2020 2020      ].          
-00010f60: 2020 2020 2020 2020 2020 6966 2028 0a20            if (. 
-00010f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010f80: 2020 2020 2020 206f 7574 7075 745f 6e6f         output_no
-00010f90: 746f 6e62 6f72 6465 725f 746d 705f 7061  tonborder_tmp_pa
-00010fa0: 7274 6961 6c5f 7061 7468 2e65 7869 7374  rtial_path.exist
-00010fb0: 7328 290a 2020 2020 2020 2020 2020 2020  s().            
-00010fc0: 2020 2020 2020 2020 2020 2020 616e 6420              and 
-00010fd0: 6f75 7470 7574 5f6e 6f74 6f6e 626f 7264  output_notonbord
-00010fe0: 6572 5f74 6d70 5f70 6172 7469 616c 5f70  er_tmp_partial_p
-00010ff0: 6174 682e 7374 6174 2829 2e73 745f 7369  ath.stat().st_si
-00011000: 7a65 203e 2030 0a20 2020 2020 2020 2020  ze > 0.         
-00011010: 2020 2020 2020 2020 2020 2029 3a0a 2020             ):.  
+0000f810: 5748 4552 4520 7b77 6865 7265 5f70 6f73  WHERE {where_pos
+0000f820: 747d 0a20 2020 2020 2020 2020 2020 2020  t}.             
+0000f830: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0000f840: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0000f850: 6d70 5f69 6e66 6f20 3d20 6766 6f2e 6765  mp_info = gfo.ge
+0000f860: 745f 6c61 7965 7269 6e66 6f28 6f75 7470  t_layerinfo(outp
+0000f870: 7574 5f74 6d70 325f 6669 6e61 6c5f 7061  ut_tmp2_final_pa
+0000f880: 7468 2c20 6f75 7470 7574 5f6c 6179 6572  th, output_layer
+0000f890: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000f8a0: 2020 2020 2020 7371 6c5f 7374 6d74 203d        sql_stmt =
+0000f8b0: 2073 716c 5f73 746d 742e 666f 726d 6174   sql_stmt.format
+0000f8c0: 2867 656f 6d65 7472 7963 6f6c 756d 6e3d  (geometrycolumn=
+0000f8d0: 746d 705f 696e 666f 2e67 656f 6d65 7472  tmp_info.geometr
+0000f8e0: 7963 6f6c 756d 6e29 0a20 2020 2020 2020  ycolumn).       
+0000f8f0: 2020 2020 2020 2020 2020 2020 205f 6f67               _og
+0000f900: 725f 7574 696c 2e76 6563 746f 725f 7472  r_util.vector_tr
+0000f910: 616e 736c 6174 6528 0a20 2020 2020 2020  anslate(.       
+0000f920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f930: 2069 6e70 7574 5f70 6174 683d 6f75 7470   input_path=outp
+0000f940: 7574 5f74 6d70 325f 6669 6e61 6c5f 7061  ut_tmp2_final_pa
+0000f950: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
+0000f960: 2020 2020 2020 2020 2020 2020 6f75 7470              outp
+0000f970: 7574 5f70 6174 683d 6f75 7470 7574 5f74  ut_path=output_t
+0000f980: 6d70 335f 7768 6572 655f 7061 7468 2c0a  mp3_where_path,.
+0000f990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f9a0: 2020 2020 2020 2020 6f75 7470 7574 5f6c          output_l
+0000f9b0: 6179 6572 3d6f 7574 7075 745f 6c61 7965  ayer=output_laye
+0000f9c0: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
+0000f9d0: 2020 2020 2020 2020 2020 2066 6f72 6365             force
+0000f9e0: 5f6f 7574 7075 745f 6765 6f6d 6574 7279  _output_geometry
+0000f9f0: 7479 7065 3d6f 7574 7075 745f 6765 6f6d  type=output_geom
+0000fa00: 6574 7279 7479 7065 2c0a 2020 2020 2020  etrytype,.      
+0000fa10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fa20: 2020 7371 6c5f 7374 6d74 3d73 716c 5f73    sql_stmt=sql_s
+0000fa30: 746d 742c 0a20 2020 2020 2020 2020 2020  tmt,.           
+0000fa40: 2020 2020 2020 2020 2020 2020 2073 716c               sql
+0000fa50: 5f64 6961 6c65 6374 3d22 5351 4c49 5445  _dialect="SQLITE
+0000fa60: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+0000fa70: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000fa80: 2020 2020 2020 2020 2020 2020 206f 7574               out
+0000fa90: 7075 745f 746d 7032 5f66 696e 616c 5f70  put_tmp2_final_p
+0000faa0: 6174 6820 3d20 6f75 7470 7574 5f74 6d70  ath = output_tmp
+0000fab0: 335f 7768 6572 655f 7061 7468 0a0a 2020  3_where_path..  
+0000fac0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0000fad0: 4e6f 7720 7765 2061 7265 2072 6561 6479  Now we are ready
+0000fae0: 2074 6f20 6d6f 7665 2074 6865 2072 6573   to move the res
+0000faf0: 756c 7420 746f 2074 6865 2066 696e 616c  ult to the final
+0000fb00: 2073 706f 742e 2e2e 0a20 2020 2020 2020   spot....       
+0000fb10: 2020 2020 2020 2020 2067 666f 2e6d 6f76           gfo.mov
+0000fb20: 6528 6f75 7470 7574 5f74 6d70 325f 6669  e(output_tmp2_fi
+0000fb30: 6e61 6c5f 7061 7468 2c20 6f75 7470 7574  nal_path, output
+0000fb40: 5f70 6174 6829 0a0a 2020 2020 2020 2020  _path)..        
+0000fb50: 6669 6e61 6c6c 793a 0a20 2020 2020 2020  finally:.       
+0000fb60: 2020 2020 2069 6620 436f 6e66 6967 4f70       if ConfigOp
+0000fb70: 7469 6f6e 732e 7265 6d6f 7665 5f74 656d  tions.remove_tem
+0000fb80: 705f 6669 6c65 733a 0a20 2020 2020 2020  p_files:.       
+0000fb90: 2020 2020 2020 2020 2073 6875 7469 6c2e           shutil.
+0000fba0: 726d 7472 6565 2874 656d 7064 6972 2c20  rmtree(tempdir, 
+0000fbb0: 6967 6e6f 7265 5f65 7272 6f72 733d 5472  ignore_errors=Tr
+0000fbc0: 7565 290a 2020 2020 656c 7365 3a0a 2020  ue).    else:.  
+0000fbd0: 2020 2020 2020 7261 6973 6520 4e6f 7449        raise NotI
+0000fbe0: 6d70 6c65 6d65 6e74 6564 4572 726f 7228  mplementedError(
+0000fbf0: 0a20 2020 2020 2020 2020 2020 2066 2255  .            f"U
+0000fc00: 6e73 7570 706f 7274 6564 2069 6e70 7574  nsupported input
+0000fc10: 2067 656f 6d65 7472 7974 7970 653a 207b   geometrytype: {
+0000fc20: 696e 7075 745f 6c61 7965 7269 6e66 6f2e  input_layerinfo.
+0000fc30: 6765 6f6d 6574 7279 7479 7065 7d22 0a20  geometrytype}". 
+0000fc40: 2020 2020 2020 2029 0a0a 0a64 6566 205f         )...def _
+0000fc50: 6469 7373 6f6c 7665 5f70 6f6c 7967 6f6e  dissolve_polygon
+0000fc60: 735f 7061 7373 280a 2020 2020 696e 7075  s_pass(.    inpu
+0000fc70: 745f 7061 7468 3a20 5061 7468 2c0a 2020  t_path: Path,.  
+0000fc80: 2020 6f75 7470 7574 5f6e 6f74 6f6e 626f    output_notonbo
+0000fc90: 7264 6572 5f70 6174 683a 2050 6174 682c  rder_path: Path,
+0000fca0: 0a20 2020 206f 7574 7075 745f 6f6e 626f  .    output_onbo
+0000fcb0: 7264 6572 5f70 6174 683a 2050 6174 682c  rder_path: Path,
+0000fcc0: 0a20 2020 2065 7870 6c6f 6465 636f 6c6c  .    explodecoll
+0000fcd0: 6563 7469 6f6e 733a 2062 6f6f 6c2c 0a20  ections: bool,. 
+0000fce0: 2020 2067 726f 7570 6279 5f63 6f6c 756d     groupby_colum
+0000fcf0: 6e73 3a20 4f70 7469 6f6e 616c 5b49 7465  ns: Optional[Ite
+0000fd00: 7261 626c 655b 7374 725d 5d2c 0a20 2020  rable[str]],.   
+0000fd10: 2061 6767 5f63 6f6c 756d 6e73 3a20 4f70   agg_columns: Op
+0000fd20: 7469 6f6e 616c 5b64 6963 745d 2c0a 2020  tional[dict],.  
+0000fd30: 2020 7469 6c65 735f 6764 663a 2067 7064    tiles_gdf: gpd
+0000fd40: 2e47 656f 4461 7461 4672 616d 652c 0a20  .GeoDataFrame,. 
+0000fd50: 2020 2069 6e70 7574 5f6c 6179 6572 3a20     input_layer: 
+0000fd60: 4f70 7469 6f6e 616c 5b73 7472 5d2c 0a20  Optional[str],. 
+0000fd70: 2020 206f 7574 7075 745f 6c61 7965 723a     output_layer:
+0000fd80: 204f 7074 696f 6e61 6c5b 7374 725d 2c0a   Optional[str],.
+0000fd90: 2020 2020 6772 6964 7369 7a65 3a20 666c      gridsize: fl
+0000fda0: 6f61 742c 0a20 2020 206b 6565 705f 656d  oat,.    keep_em
+0000fdb0: 7074 795f 6765 6f6d 733a 2062 6f6f 6c2c  pty_geoms: bool,
+0000fdc0: 0a20 2020 206e 625f 7061 7261 6c6c 656c  .    nb_parallel
+0000fdd0: 3a20 696e 742c 0a29 3a0a 2020 2020 7374  : int,.):.    st
+0000fde0: 6172 745f 7469 6d65 203d 2064 6174 6574  art_time = datet
+0000fdf0: 696d 652e 6e6f 7728 290a 0a20 2020 2023  ime.now()..    #
+0000fe00: 204d 616b 6520 7375 7265 2074 6865 2069   Make sure the i
+0000fe10: 6e70 7574 2066 696c 6520 6861 7320 6120  nput file has a 
+0000fe20: 7370 6174 6961 6c20 696e 6465 780a 2020  spatial index.  
+0000fe30: 2020 6766 6f2e 6372 6561 7465 5f73 7061    gfo.create_spa
+0000fe40: 7469 616c 5f69 6e64 6578 2869 6e70 7574  tial_index(input
+0000fe50: 5f70 6174 682c 206c 6179 6572 3d69 6e70  _path, layer=inp
+0000fe60: 7574 5f6c 6179 6572 2c20 6578 6973 745f  ut_layer, exist_
+0000fe70: 6f6b 3d54 7275 6529 0a0a 2020 2020 2320  ok=True)..    # 
+0000fe80: 5374 6172 7420 6361 6c63 756c 6174 696f  Start calculatio
+0000fe90: 6e20 696e 2070 6172 616c 6c65 6c0a 2020  n in parallel.  
+0000fea0: 2020 696e 7075 745f 6c61 7965 7269 6e66    input_layerinf
+0000feb0: 6f20 3d20 6766 6f2e 6765 745f 6c61 7965  o = gfo.get_laye
+0000fec0: 7269 6e66 6f28 696e 7075 745f 7061 7468  rinfo(input_path
+0000fed0: 2c20 696e 7075 745f 6c61 7965 7229 0a0a  , input_layer)..
+0000fee0: 2020 2020 2320 5072 6f63 6573 7369 6e67      # Processing
+0000fef0: 2069 6e20 7468 7265 6164 7320 6973 2032   in threads is 2
+0000ff00: 7820 6661 7374 6572 2066 6f72 2073 6d61  x faster for sma
+0000ff10: 6c6c 2064 6174 6173 6574 7320 286f 6e20  ll datasets (on 
+0000ff20: 5769 6e64 6f77 7329 0a20 2020 2063 616c  Windows).    cal
+0000ff30: 6375 6c61 7465 5f69 6e5f 7468 7265 6164  culate_in_thread
+0000ff40: 7320 3d20 5472 7565 2069 6620 696e 7075  s = True if inpu
+0000ff50: 745f 6c61 7965 7269 6e66 6f2e 6665 6174  t_layerinfo.feat
+0000ff60: 7572 6563 6f75 6e74 203c 3d20 3130 3020  urecount <= 100 
+0000ff70: 656c 7365 2046 616c 7365 0a20 2020 2077  else False.    w
+0000ff80: 6974 6820 5f70 726f 6365 7373 696e 675f  ith _processing_
+0000ff90: 7574 696c 2e50 6f6f 6c65 6445 7865 6375  util.PooledExecu
+0000ffa0: 746f 7246 6163 746f 7279 280a 2020 2020  torFactory(.    
+0000ffb0: 2020 2020 7468 7265 6164 706f 6f6c 3d63      threadpool=c
+0000ffc0: 616c 6375 6c61 7465 5f69 6e5f 7468 7265  alculate_in_thre
+0000ffd0: 6164 732c 0a20 2020 2020 2020 206d 6178  ads,.        max
+0000ffe0: 5f77 6f72 6b65 7273 3d6e 625f 7061 7261  _workers=nb_para
+0000fff0: 6c6c 656c 2c0a 2020 2020 2020 2020 696e  llel,.        in
+00010000: 6974 6961 6c69 7a65 723d 5f70 726f 6365  itializer=_proce
+00010010: 7373 696e 675f 7574 696c 2e69 6e69 7469  ssing_util.initi
+00010020: 616c 697a 655f 776f 726b 6572 2829 2c0a  alize_worker(),.
+00010030: 2020 2020 2920 6173 2063 616c 6375 6c61      ) as calcula
+00010040: 7465 5f70 6f6f 6c3a 0a20 2020 2020 2020  te_pool:.       
+00010050: 2023 2050 7265 7061 7265 206f 7574 7075   # Prepare outpu
+00010060: 7420 6669 6c65 6e61 6d65 0a20 2020 2020  t filename.     
+00010070: 2020 2074 656d 7064 6972 203d 206f 7574     tempdir = out
+00010080: 7075 745f 6f6e 626f 7264 6572 5f70 6174  put_onborder_pat
+00010090: 682e 7061 7265 6e74 0a0a 2020 2020 2020  h.parent..      
+000100a0: 2020 6261 7463 6865 733a 2064 6963 745b    batches: dict[
+000100b0: 696e 742c 2064 6963 745d 203d 207b 7d0a  int, dict] = {}.
+000100c0: 2020 2020 2020 2020 6e62 5f62 6174 6368          nb_batch
+000100d0: 6573 203d 206c 656e 2874 696c 6573 5f67  es = len(tiles_g
+000100e0: 6466 290a 2020 2020 2020 2020 6e62 5f62  df).        nb_b
+000100f0: 6174 6368 6573 5f64 6f6e 6520 3d20 300a  atches_done = 0.
+00010100: 2020 2020 2020 2020 6675 7475 7265 5f74          future_t
+00010110: 6f5f 6261 7463 685f 6964 203d 207b 7d0a  o_batch_id = {}.
+00010120: 2020 2020 2020 2020 6e62 5f72 6f77 735f          nb_rows_
+00010130: 646f 6e65 203d 2030 0a20 2020 2020 2020  done = 0.       
+00010140: 2066 6f72 2062 6174 6368 5f69 642c 2074   for batch_id, t
+00010150: 696c 655f 726f 7720 696e 2065 6e75 6d65  ile_row in enume
+00010160: 7261 7465 2874 696c 6573 5f67 6466 2e69  rate(tiles_gdf.i
+00010170: 7465 7274 7570 6c65 7328 2929 3a0a 2020  tertuples()):.  
+00010180: 2020 2020 2020 2020 2020 6261 7463 6865            batche
+00010190: 735b 6261 7463 685f 6964 5d20 3d20 7b7d  s[batch_id] = {}
+000101a0: 0a20 2020 2020 2020 2020 2020 2062 6174  .            bat
+000101b0: 6368 6573 5b62 6174 6368 5f69 645d 5b22  ches[batch_id]["
+000101c0: 6c61 7965 7222 5d20 3d20 6f75 7470 7574  layer"] = output
+000101d0: 5f6c 6179 6572 0a20 2020 2020 2020 2020  _layer.         
+000101e0: 2020 2062 6174 6368 6573 5b62 6174 6368     batches[batch
+000101f0: 5f69 645d 5b22 626f 756e 6473 225d 203d  _id]["bounds"] =
+00010200: 2074 696c 655f 726f 772e 6765 6f6d 6574   tile_row.geomet
+00010210: 7279 2e62 6f75 6e64 730a 0a20 2020 2020  ry.bounds..     
+00010220: 2020 2020 2020 2023 204f 7574 7075 7420         # Output 
+00010230: 6561 6368 2062 6174 6368 2074 6f20 6120  each batch to a 
+00010240: 7365 7065 7261 7465 2074 656d 706f 7261  seperate tempora
+00010250: 7279 2066 696c 652c 206f 7468 6572 7769  ry file, otherwi
+00010260: 7365 2074 6865 7265 0a20 2020 2020 2020  se there.       
+00010270: 2020 2020 2023 2061 7265 2074 696d 656f       # are timeo
+00010280: 7574 2069 7373 7565 7320 7768 656e 2070  ut issues when p
+00010290: 726f 6365 7373 696e 6720 6c61 7267 6520  rocessing large 
+000102a0: 6669 6c65 730a 2020 2020 2020 2020 2020  files.          
+000102b0: 2020 7375 6666 6978 203d 206f 7574 7075    suffix = outpu
+000102c0: 745f 6e6f 746f 6e62 6f72 6465 725f 7061  t_notonborder_pa
+000102d0: 7468 2e73 7566 6669 780a 2020 2020 2020  th.suffix.      
+000102e0: 2020 2020 2020 6e61 6d65 203d 2066 227b        name = f"{
+000102f0: 6f75 7470 7574 5f6e 6f74 6f6e 626f 7264  output_notonbord
+00010300: 6572 5f70 6174 682e 7374 656d 7d5f 7b62  er_path.stem}_{b
+00010310: 6174 6368 5f69 647d 7b73 7566 6669 787d  atch_id}{suffix}
+00010320: 220a 2020 2020 2020 2020 2020 2020 6f75  ".            ou
+00010330: 7470 7574 5f6e 6f74 6f6e 626f 7264 6572  tput_notonborder
+00010340: 5f74 6d70 5f70 6172 7469 616c 5f70 6174  _tmp_partial_pat
+00010350: 6820 3d20 7465 6d70 6469 7220 2f20 6e61  h = tempdir / na
+00010360: 6d65 0a20 2020 2020 2020 2020 2020 2062  me.            b
+00010370: 6174 6368 6573 5b62 6174 6368 5f69 645d  atches[batch_id]
+00010380: 5b22 6f75 7470 7574 5f6e 6f74 6f6e 626f  ["output_notonbo
+00010390: 7264 6572 5f74 6d70 5f70 6172 7469 616c  rder_tmp_partial
+000103a0: 5f70 6174 6822 5d20 3d20 280a 2020 2020  _path"] = (.    
+000103b0: 2020 2020 2020 2020 2020 2020 6f75 7470              outp
+000103c0: 7574 5f6e 6f74 6f6e 626f 7264 6572 5f74  ut_notonborder_t
+000103d0: 6d70 5f70 6172 7469 616c 5f70 6174 680a  mp_partial_path.
+000103e0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+000103f0: 2020 2020 2020 2020 2020 6e61 6d65 203d            name =
+00010400: 2066 227b 6f75 7470 7574 5f6f 6e62 6f72   f"{output_onbor
+00010410: 6465 725f 7061 7468 2e73 7465 6d7d 5f7b  der_path.stem}_{
+00010420: 6261 7463 685f 6964 7d7b 7375 6666 6978  batch_id}{suffix
+00010430: 7d22 0a20 2020 2020 2020 2020 2020 206f  }".            o
+00010440: 7574 7075 745f 6f6e 626f 7264 6572 5f74  utput_onborder_t
+00010450: 6d70 5f70 6172 7469 616c 5f70 6174 6820  mp_partial_path 
+00010460: 3d20 7465 6d70 6469 7220 2f20 6e61 6d65  = tempdir / name
+00010470: 0a20 2020 2020 2020 2020 2020 2062 6174  .            bat
+00010480: 6368 6573 5b62 6174 6368 5f69 645d 5b22  ches[batch_id]["
+00010490: 6f75 7470 7574 5f6f 6e62 6f72 6465 725f  output_onborder_
+000104a0: 746d 705f 7061 7274 6961 6c5f 7061 7468  tmp_partial_path
+000104b0: 225d 203d 2028 0a20 2020 2020 2020 2020  "] = (.         
+000104c0: 2020 2020 2020 206f 7574 7075 745f 6f6e         output_on
+000104d0: 626f 7264 6572 5f74 6d70 5f70 6172 7469  border_tmp_parti
+000104e0: 616c 5f70 6174 680a 2020 2020 2020 2020  al_path.        
+000104f0: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
+00010500: 2020 2023 2047 6574 2074 696c 655f 6964     # Get tile_id
+00010510: 2069 6620 7072 6573 656e 740a 2020 2020   if present.    
+00010520: 2020 2020 2020 2020 7469 6c65 5f69 6420          tile_id 
+00010530: 3d20 7469 6c65 5f72 6f77 2e74 696c 655f  = tile_row.tile_
+00010540: 6964 2069 6620 2274 696c 655f 6964 2220  id if "tile_id" 
+00010550: 696e 2074 696c 655f 726f 772e 5f66 6965  in tile_row._fie
+00010560: 6c64 7320 656c 7365 204e 6f6e 650a 0a20  lds else None.. 
+00010570: 2020 2020 2020 2020 2020 2066 7574 7572             futur
+00010580: 6520 3d20 6361 6c63 756c 6174 655f 706f  e = calculate_po
+00010590: 6f6c 2e73 7562 6d69 7428 0a20 2020 2020  ol.submit(.     
+000105a0: 2020 2020 2020 2020 2020 205f 6469 7373             _diss
+000105b0: 6f6c 7665 5f70 6f6c 7967 6f6e 732c 0a20  olve_polygons,. 
+000105c0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000105d0: 6e70 7574 5f70 6174 683d 696e 7075 745f  nput_path=input_
+000105e0: 7061 7468 2c0a 2020 2020 2020 2020 2020  path,.          
+000105f0: 2020 2020 2020 6f75 7470 7574 5f6e 6f74        output_not
+00010600: 6f6e 626f 7264 6572 5f70 6174 683d 6f75  onborder_path=ou
+00010610: 7470 7574 5f6e 6f74 6f6e 626f 7264 6572  tput_notonborder
+00010620: 5f74 6d70 5f70 6172 7469 616c 5f70 6174  _tmp_partial_pat
+00010630: 682c 0a20 2020 2020 2020 2020 2020 2020  h,.             
+00010640: 2020 206f 7574 7075 745f 6f6e 626f 7264     output_onbord
+00010650: 6572 5f70 6174 683d 6f75 7470 7574 5f6f  er_path=output_o
+00010660: 6e62 6f72 6465 725f 746d 705f 7061 7274  nborder_tmp_part
+00010670: 6961 6c5f 7061 7468 2c0a 2020 2020 2020  ial_path,.      
+00010680: 2020 2020 2020 2020 2020 6578 706c 6f64            explod
+00010690: 6563 6f6c 6c65 6374 696f 6e73 3d65 7870  ecollections=exp
+000106a0: 6c6f 6465 636f 6c6c 6563 7469 6f6e 732c  lodecollections,
+000106b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000106c0: 2067 726f 7570 6279 5f63 6f6c 756d 6e73   groupby_columns
+000106d0: 3d67 726f 7570 6279 5f63 6f6c 756d 6e73  =groupby_columns
+000106e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000106f0: 2020 6167 675f 636f 6c75 6d6e 733d 6167    agg_columns=ag
+00010700: 675f 636f 6c75 6d6e 732c 0a20 2020 2020  g_columns,.     
+00010710: 2020 2020 2020 2020 2020 2069 6e70 7574             input
+00010720: 5f67 656f 6d65 7472 7974 7970 653d 696e  _geometrytype=in
+00010730: 7075 745f 6c61 7965 7269 6e66 6f2e 6765  put_layerinfo.ge
+00010740: 6f6d 6574 7279 7479 7065 2c0a 2020 2020  ometrytype,.    
+00010750: 2020 2020 2020 2020 2020 2020 696e 7075              inpu
+00010760: 745f 6c61 7965 723d 696e 7075 745f 6c61  t_layer=input_la
+00010770: 7965 722c 0a20 2020 2020 2020 2020 2020  yer,.           
+00010780: 2020 2020 206f 7574 7075 745f 6c61 7965       output_laye
+00010790: 723d 6f75 7470 7574 5f6c 6179 6572 2c0a  r=output_layer,.
+000107a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000107b0: 6262 6f78 3d74 696c 655f 726f 772e 6765  bbox=tile_row.ge
+000107c0: 6f6d 6574 7279 2e62 6f75 6e64 732c 0a20  ometry.bounds,. 
+000107d0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+000107e0: 696c 655f 6964 3d74 696c 655f 6964 2c0a  ile_id=tile_id,.
+000107f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010800: 6772 6964 7369 7a65 3d67 7269 6473 697a  gridsize=gridsiz
+00010810: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00010820: 2020 206b 6565 705f 656d 7074 795f 6765     keep_empty_ge
+00010830: 6f6d 733d 6b65 6570 5f65 6d70 7479 5f67  oms=keep_empty_g
+00010840: 656f 6d73 2c0a 2020 2020 2020 2020 2020  eoms,.          
+00010850: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00010860: 6675 7475 7265 5f74 6f5f 6261 7463 685f  future_to_batch_
+00010870: 6964 5b66 7574 7572 655d 203d 2062 6174  id[future] = bat
+00010880: 6368 5f69 640a 0a20 2020 2020 2020 2023  ch_id..        #
+00010890: 204c 6f6f 7020 7469 6c6c 2061 6c6c 2070   Loop till all p
+000108a0: 6172 616c 6c65 6c20 7072 6f63 6573 7365  arallel processe
+000108b0: 7320 6172 6520 7265 6164 792c 2062 7574  s are ready, but
+000108c0: 2070 726f 6365 7373 2065 6163 6820 6f6e   process each on
+000108d0: 650a 2020 2020 2020 2020 2320 7468 6174  e.        # that
+000108e0: 2069 7320 7265 6164 7920 616c 7265 6164   is ready alread
+000108f0: 790a 2020 2020 2020 2020 5f67 656e 6572  y.        _gener
+00010900: 616c 5f75 7469 6c2e 7265 706f 7274 5f70  al_util.report_p
+00010910: 726f 6772 6573 7328 0a20 2020 2020 2020  rogress(.       
+00010920: 2020 2020 2073 7461 7274 5f74 696d 652c       start_time,
+00010930: 206e 625f 6261 7463 6865 735f 646f 6e65   nb_batches_done
+00010940: 2c20 6e62 5f62 6174 6368 6573 2c20 2264  , nb_batches, "d
+00010950: 6973 736f 6c76 6522 0a20 2020 2020 2020  issolve".       
+00010960: 2029 0a20 2020 2020 2020 2066 6f72 2066   ).        for f
+00010970: 7574 7572 6520 696e 2066 7574 7572 6573  uture in futures
+00010980: 2e61 735f 636f 6d70 6c65 7465 6428 6675  .as_completed(fu
+00010990: 7475 7265 5f74 6f5f 6261 7463 685f 6964  ture_to_batch_id
+000109a0: 293a 0a20 2020 2020 2020 2020 2020 2074  ):.            t
+000109b0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+000109c0: 2020 2020 2320 4966 2074 6865 2063 616c      # If the cal
+000109d0: 6375 6c61 7465 2067 6176 6520 7265 7375  culate gave resu
+000109e0: 6c74 730a 2020 2020 2020 2020 2020 2020  lts.            
+000109f0: 2020 2020 6e62 5f62 6174 6368 6573 5f64      nb_batches_d
+00010a00: 6f6e 6520 2b3d 2031 0a20 2020 2020 2020  one += 1.       
+00010a10: 2020 2020 2020 2020 2062 6174 6368 5f69           batch_i
+00010a20: 6420 3d20 6675 7475 7265 5f74 6f5f 6261  d = future_to_ba
+00010a30: 7463 685f 6964 5b66 7574 7572 655d 0a20  tch_id[future]. 
+00010a40: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00010a50: 6573 756c 7420 3d20 6675 7475 7265 2e72  esult = future.r
+00010a60: 6573 756c 7428 290a 0a20 2020 2020 2020  esult()..       
+00010a70: 2020 2020 2020 2020 2069 6620 7265 7375           if resu
+00010a80: 6c74 2069 7320 6e6f 7420 4e6f 6e65 3a0a  lt is not None:.
+00010a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010aa0: 2020 2020 6e62 5f72 6f77 735f 646f 6e65      nb_rows_done
+00010ab0: 202b 3d20 7265 7375 6c74 5b22 6e62 5f72   += result["nb_r
+00010ac0: 6f77 735f 646f 6e65 225d 0a20 2020 2020  ows_done"].     
+00010ad0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00010ae0: 6620 7265 7375 6c74 5b22 6e62 5f72 6f77  f result["nb_row
+00010af0: 735f 646f 6e65 225d 203e 2030 2061 6e64  s_done"] > 0 and
+00010b00: 2072 6573 756c 745b 2274 6f74 616c 5f74   result["total_t
+00010b10: 696d 6522 5d20 3e20 303a 0a20 2020 2020  ime"] > 0:.     
+00010b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010b30: 2020 2072 6f77 735f 7065 725f 7365 6320     rows_per_sec 
+00010b40: 3d20 726f 756e 6428 0a20 2020 2020 2020  = round(.       
+00010b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010b60: 2020 2020 2072 6573 756c 745b 226e 625f       result["nb_
+00010b70: 726f 7773 5f64 6f6e 6522 5d20 2f20 7265  rows_done"] / re
+00010b80: 7375 6c74 5b22 746f 7461 6c5f 7469 6d65  sult["total_time
+00010b90: 225d 0a20 2020 2020 2020 2020 2020 2020  "].             
+00010ba0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00010bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010bc0: 2020 2020 206c 6f67 6765 722e 6465 6275       logger.debu
+00010bd0: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
+00010be0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00010bf0: 2242 6174 6368 207b 6261 7463 685f 6964  "Batch {batch_id
+00010c00: 7d20 7072 6f63 6573 7365 6420 7b72 6573  } processed {res
+00010c10: 756c 745b 276e 625f 726f 7773 5f64 6f6e  ult['nb_rows_don
+00010c20: 6527 5d7d 2072 6f77 7320 220a 2020 2020  e']} rows ".    
+00010c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010c40: 2020 2020 2020 2020 6622 287b 726f 7773          f"({rows
+00010c50: 5f70 6572 5f73 6563 7d2f 7365 6329 220a  _per_sec}/sec)".
+00010c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010c70: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00010c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010c90: 2020 6966 2022 7065 7266 7374 7269 6e67    if "perfstring
+00010ca0: 2220 696e 2072 6573 756c 743a 0a20 2020  " in result:.   
+00010cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010cc0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+00010cd0: 6465 6275 6728 6622 5065 7266 7374 7269  debug(f"Perfstri
+00010ce0: 6e67 3a20 7b72 6573 756c 745b 2770 6572  ng: {result['per
+00010cf0: 6673 7472 696e 6727 5d7d 2229 0a0a 2020  fstring']}")..  
+00010d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010d10: 2020 2320 5374 6172 7420 636f 7079 206f    # Start copy o
+00010d20: 6620 7468 6520 7265 7375 6c74 2074 6f20  f the result to 
+00010d30: 6120 636f 6d6d 6f6e 2066 696c 650a 2020  a common file.  
+00010d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010d50: 2020 6261 7463 685f 6964 203d 2066 7574    batch_id = fut
+00010d60: 7572 655f 746f 5f62 6174 6368 5f69 645b  ure_to_batch_id[
+00010d70: 6675 7475 7265 5d0a 0a20 2020 2020 2020  future]..       
+00010d80: 2020 2020 2020 2020 2020 2020 2023 2049               # I
+00010d90: 6620 6361 6c63 756c 6174 6520 6761 7665  f calculate gave
+00010da0: 206e 6f74 6f6e 626f 7264 6572 2072 6573   notonborder res
+00010db0: 756c 7473 2c20 6170 7065 6e64 2074 6f20  ults, append to 
+00010dc0: 6f75 7470 7574 0a20 2020 2020 2020 2020  output.         
+00010dd0: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
+00010de0: 745f 6e6f 746f 6e62 6f72 6465 725f 746d  t_notonborder_tm
+00010df0: 705f 7061 7274 6961 6c5f 7061 7468 203d  p_partial_path =
+00010e00: 2062 6174 6368 6573 5b62 6174 6368 5f69   batches[batch_i
+00010e10: 645d 5b0a 2020 2020 2020 2020 2020 2020  d][.            
+00010e20: 2020 2020 2020 2020 2020 2020 226f 7574              "out
+00010e30: 7075 745f 6e6f 746f 6e62 6f72 6465 725f  put_notonborder_
+00010e40: 746d 705f 7061 7274 6961 6c5f 7061 7468  tmp_partial_path
+00010e50: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00010e60: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
+00010e70: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+00010e80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010e90: 2020 2020 2020 2020 206f 7574 7075 745f           output_
+00010ea0: 6e6f 746f 6e62 6f72 6465 725f 746d 705f  notonborder_tmp_
+00010eb0: 7061 7274 6961 6c5f 7061 7468 2e65 7869  partial_path.exi
+00010ec0: 7374 7328 290a 2020 2020 2020 2020 2020  sts().          
+00010ed0: 2020 2020 2020 2020 2020 2020 2020 616e                an
+00010ee0: 6420 6f75 7470 7574 5f6e 6f74 6f6e 626f  d output_notonbo
+00010ef0: 7264 6572 5f74 6d70 5f70 6172 7469 616c  rder_tmp_partial
+00010f00: 5f70 6174 682e 7374 6174 2829 2e73 745f  _path.stat().st_
+00010f10: 7369 7a65 203e 2030 0a20 2020 2020 2020  size > 0.       
+00010f20: 2020 2020 2020 2020 2020 2020 2029 3a0a               ):.
+00010f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010f40: 2020 2020 2020 2020 6669 6c65 6f70 732e          fileops.
+00010f50: 5f61 7070 656e 645f 746f 5f6e 6f6c 6f63  _append_to_noloc
+00010f60: 6b28 0a20 2020 2020 2020 2020 2020 2020  k(.             
+00010f70: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00010f80: 7263 3d6f 7574 7075 745f 6e6f 746f 6e62  rc=output_notonb
+00010f90: 6f72 6465 725f 746d 705f 7061 7274 6961  order_tmp_partia
+00010fa0: 6c5f 7061 7468 2c0a 2020 2020 2020 2020  l_path,.        
+00010fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010fc0: 2020 2020 6473 743d 6f75 7470 7574 5f6e      dst=output_n
+00010fd0: 6f74 6f6e 626f 7264 6572 5f70 6174 682c  otonborder_path,
+00010fe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010ff0: 2020 2020 2020 2020 2020 2020 2063 7265               cre
+00011000: 6174 655f 7370 6174 6961 6c5f 696e 6465  ate_spatial_inde
+00011010: 783d 4661 6c73 652c 0a20 2020 2020 2020  x=False,.       
 00011020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011030: 2020 2020 2020 6669 6c65 6f70 732e 5f61        fileops._a
-00011040: 7070 656e 645f 746f 5f6e 6f6c 6f63 6b28  ppend_to_nolock(
-00011050: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011060: 2020 2020 2020 2020 2020 2020 2073 7263               src
-00011070: 3d6f 7574 7075 745f 6e6f 746f 6e62 6f72  =output_notonbor
-00011080: 6465 725f 746d 705f 7061 7274 6961 6c5f  der_tmp_partial_
-00011090: 7061 7468 2c0a 2020 2020 2020 2020 2020  path,.          
-000110a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000110b0: 2020 6473 743d 6f75 7470 7574 5f6e 6f74    dst=output_not
-000110c0: 6f6e 626f 7264 6572 5f70 6174 682c 0a20  onborder_path,. 
-000110d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000110e0: 2020 2020 2020 2020 2020 2063 7265 6174             creat
-000110f0: 655f 7370 6174 6961 6c5f 696e 6465 783d  e_spatial_index=
-00011100: 4661 6c73 652c 0a20 2020 2020 2020 2020  False,.         
-00011110: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00011120: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011130: 2020 2020 2020 2020 2067 666f 2e72 656d           gfo.rem
-00011140: 6f76 6528 6f75 7470 7574 5f6e 6f74 6f6e  ove(output_noton
-00011150: 626f 7264 6572 5f74 6d70 5f70 6172 7469  border_tmp_parti
-00011160: 616c 5f70 6174 6829 0a0a 2020 2020 2020  al_path)..      
-00011170: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00011180: 4966 2063 616c 6375 6c61 7465 2067 6176  If calculate gav
-00011190: 6520 6f6e 626f 7264 6572 2072 6573 756c  e onborder resul
-000111a0: 7473 2c20 6170 7065 6e64 2074 6f20 6f75  ts, append to ou
-000111b0: 7470 7574 0a20 2020 2020 2020 2020 2020  tput.           
-000111c0: 2020 2020 2020 2020 206f 7574 7075 745f           output_
-000111d0: 6f6e 626f 7264 6572 5f74 6d70 5f70 6172  onborder_tmp_par
-000111e0: 7469 616c 5f70 6174 6820 3d20 6261 7463  tial_path = batc
-000111f0: 6865 735b 6261 7463 685f 6964 5d5b 0a20  hes[batch_id][. 
-00011200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011210: 2020 2020 2020 2022 6f75 7470 7574 5f6f         "output_o
-00011220: 6e62 6f72 6465 725f 746d 705f 7061 7274  nborder_tmp_part
-00011230: 6961 6c5f 7061 7468 220a 2020 2020 2020  ial_path".      
-00011240: 2020 2020 2020 2020 2020 2020 2020 5d0a                ].
-00011250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011260: 2020 2020 6966 2028 0a20 2020 2020 2020      if (.       
-00011270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011280: 206f 7574 7075 745f 6f6e 626f 7264 6572   output_onborder
-00011290: 5f74 6d70 5f70 6172 7469 616c 5f70 6174  _tmp_partial_pat
-000112a0: 682e 6578 6973 7473 2829 0a20 2020 2020  h.exists().     
-000112b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000112c0: 2020 2061 6e64 206f 7574 7075 745f 6f6e     and output_on
-000112d0: 626f 7264 6572 5f74 6d70 5f70 6172 7469  border_tmp_parti
-000112e0: 616c 5f70 6174 682e 7374 6174 2829 2e73  al_path.stat().s
-000112f0: 745f 7369 7a65 203e 2030 0a20 2020 2020  t_size > 0.     
-00011300: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00011310: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00011320: 2020 2020 2020 2020 2020 6669 6c65 6f70            fileop
-00011330: 732e 5f61 7070 656e 645f 746f 5f6e 6f6c  s._append_to_nol
-00011340: 6f63 6b28 0a20 2020 2020 2020 2020 2020  ock(.           
-00011350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011360: 2073 7263 3d6f 7574 7075 745f 6f6e 626f   src=output_onbo
-00011370: 7264 6572 5f74 6d70 5f70 6172 7469 616c  rder_tmp_partial
-00011380: 5f70 6174 682c 0a20 2020 2020 2020 2020  _path,.         
-00011390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000113a0: 2020 2064 7374 3d6f 7574 7075 745f 6f6e     dst=output_on
-000113b0: 626f 7264 6572 5f70 6174 682c 0a20 2020  border_path,.   
-000113c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000113d0: 2020 2020 2020 2020 2063 7265 6174 655f           create_
-000113e0: 7370 6174 6961 6c5f 696e 6465 783d 4661  spatial_index=Fa
-000113f0: 6c73 652c 0a20 2020 2020 2020 2020 2020  lse,.           
-00011400: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-00011410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011420: 2020 2020 2020 2067 666f 2e72 656d 6f76         gfo.remov
-00011430: 6528 6f75 7470 7574 5f6f 6e62 6f72 6465  e(output_onborde
-00011440: 725f 746d 705f 7061 7274 6961 6c5f 7061  r_tmp_partial_pa
-00011450: 7468 290a 0a20 2020 2020 2020 2020 2020  th)..           
-00011460: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
-00011470: 6e20 6173 2065 783a 0a20 2020 2020 2020  n as ex:.       
-00011480: 2020 2020 2020 2020 2062 6174 6368 5f69           batch_i
-00011490: 6420 3d20 6675 7475 7265 5f74 6f5f 6261  d = future_to_ba
-000114a0: 7463 685f 6964 5b66 7574 7572 655d 0a20  tch_id[future]. 
-000114b0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-000114c0: 6573 7361 6765 203d 2066 2245 7272 6f72  essage = f"Error
-000114d0: 2065 7865 6375 7469 6e67 207b 6261 7463   executing {batc
-000114e0: 6865 735b 6261 7463 685f 6964 5d7d 3a20  hes[batch_id]}: 
-000114f0: 7b65 787d 220a 2020 2020 2020 2020 2020  {ex}".          
-00011500: 2020 2020 2020 6c6f 6767 6572 2e65 7863        logger.exc
-00011510: 6570 7469 6f6e 286d 6573 7361 6765 290a  eption(message).
-00011520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011530: 6361 6c63 756c 6174 655f 706f 6f6c 2e73  calculate_pool.s
-00011540: 6875 7464 6f77 6e28 290a 2020 2020 2020  hutdown().      
-00011550: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00011560: 4578 6365 7074 696f 6e28 6d65 7373 6167  Exception(messag
-00011570: 6529 2066 726f 6d20 6578 0a0a 2020 2020  e) from ex..    
-00011580: 2020 2020 2020 2020 2320 4c6f 6720 7468          # Log th
-00011590: 6520 7072 6f67 7265 7373 2061 6e64 2070  e progress and p
-000115a0: 7265 6469 6374 696f 6e20 7370 6565 640a  rediction speed.
-000115b0: 2020 2020 2020 2020 2020 2020 5f67 656e              _gen
-000115c0: 6572 616c 5f75 7469 6c2e 7265 706f 7274  eral_util.report
-000115d0: 5f70 726f 6772 6573 7328 0a20 2020 2020  _progress(.     
-000115e0: 2020 2020 2020 2020 2020 2073 7461 7274             start
-000115f0: 5f74 696d 652c 206e 625f 6261 7463 6865  _time, nb_batche
-00011600: 735f 646f 6e65 2c20 6e62 5f62 6174 6368  s_done, nb_batch
-00011610: 6573 2c20 2264 6973 736f 6c76 6522 0a20  es, "dissolve". 
-00011620: 2020 2020 2020 2020 2020 2029 0a0a 0a64             )...d
-00011630: 6566 205f 6469 7373 6f6c 7665 5f70 6f6c  ef _dissolve_pol
-00011640: 7967 6f6e 7328 0a20 2020 2069 6e70 7574  ygons(.    input
-00011650: 5f70 6174 683a 2050 6174 682c 0a20 2020  _path: Path,.   
-00011660: 206f 7574 7075 745f 6e6f 746f 6e62 6f72   output_notonbor
-00011670: 6465 725f 7061 7468 3a20 5061 7468 2c0a  der_path: Path,.
-00011680: 2020 2020 6f75 7470 7574 5f6f 6e62 6f72      output_onbor
-00011690: 6465 725f 7061 7468 3a20 5061 7468 2c0a  der_path: Path,.
-000116a0: 2020 2020 6578 706c 6f64 6563 6f6c 6c65      explodecolle
-000116b0: 6374 696f 6e73 3a20 626f 6f6c 2c0a 2020  ctions: bool,.  
-000116c0: 2020 6772 6f75 7062 795f 636f 6c75 6d6e    groupby_column
-000116d0: 733a 204f 7074 696f 6e61 6c5b 4974 6572  s: Optional[Iter
-000116e0: 6162 6c65 5b73 7472 5d5d 2c0a 2020 2020  able[str]],.    
-000116f0: 6167 675f 636f 6c75 6d6e 733a 204f 7074  agg_columns: Opt
-00011700: 696f 6e61 6c5b 6469 6374 5d2c 0a20 2020  ional[dict],.   
-00011710: 2069 6e70 7574 5f67 656f 6d65 7472 7974   input_geometryt
-00011720: 7970 653a 2047 656f 6d65 7472 7954 7970  ype: GeometryTyp
-00011730: 652c 0a20 2020 2069 6e70 7574 5f6c 6179  e,.    input_lay
-00011740: 6572 3a20 4f70 7469 6f6e 616c 5b73 7472  er: Optional[str
-00011750: 5d2c 0a20 2020 206f 7574 7075 745f 6c61  ],.    output_la
-00011760: 7965 723a 204f 7074 696f 6e61 6c5b 7374  yer: Optional[st
-00011770: 725d 2c0a 2020 2020 6262 6f78 3a20 5475  r],.    bbox: Tu
-00011780: 706c 655b 666c 6f61 742c 2066 6c6f 6174  ple[float, float
-00011790: 2c20 666c 6f61 742c 2066 6c6f 6174 5d2c  , float, float],
-000117a0: 0a20 2020 2074 696c 655f 6964 3a20 4f70  .    tile_id: Op
-000117b0: 7469 6f6e 616c 5b69 6e74 5d2c 0a20 2020  tional[int],.   
-000117c0: 2067 7269 6473 697a 653a 2066 6c6f 6174   gridsize: float
-000117d0: 2c0a 2020 2020 6b65 6570 5f65 6d70 7479  ,.    keep_empty
-000117e0: 5f67 656f 6d73 3a20 626f 6f6c 2c0a 2920  _geoms: bool,.) 
-000117f0: 2d3e 2064 6963 743a 0a20 2020 2023 2049  -> dict:.    # I
-00011800: 6e69 740a 2020 2020 7065 7266 696e 666f  nit.    perfinfo
-00011810: 3a20 4469 6374 5b73 7472 2c20 666c 6f61  : Dict[str, floa
-00011820: 745d 203d 207b 7d0a 2020 2020 7374 6172  t] = {}.    star
-00011830: 745f 7469 6d65 203d 2064 6174 6574 696d  t_time = datetim
-00011840: 652e 6e6f 7728 290a 2020 2020 7265 7475  e.now().    retu
-00011850: 726e 5f69 6e66 6f20 3d20 7b0a 2020 2020  rn_info = {.    
-00011860: 2020 2020 2269 6e70 7574 5f70 6174 6822      "input_path"
-00011870: 3a20 696e 7075 745f 7061 7468 2c0a 2020  : input_path,.  
-00011880: 2020 2020 2020 226f 7574 7075 745f 6e6f        "output_no
-00011890: 746f 6e62 6f72 6465 725f 7061 7468 223a  tonborder_path":
-000118a0: 206f 7574 7075 745f 6e6f 746f 6e62 6f72   output_notonbor
-000118b0: 6465 725f 7061 7468 2c0a 2020 2020 2020  der_path,.      
-000118c0: 2020 226f 7574 7075 745f 6f6e 626f 7264    "output_onbord
-000118d0: 6572 5f70 6174 6822 3a20 6f75 7470 7574  er_path": output
-000118e0: 5f6f 6e62 6f72 6465 725f 7061 7468 2c0a  _onborder_path,.
-000118f0: 2020 2020 2020 2020 2262 626f 7822 3a20          "bbox": 
-00011900: 6262 6f78 2c0a 2020 2020 2020 2020 2274  bbox,.        "t
-00011910: 696c 655f 6964 223a 2074 696c 655f 6964  ile_id": tile_id
-00011920: 2c0a 2020 2020 2020 2020 2267 7269 6473  ,.        "grids
-00011930: 697a 6522 3a20 6772 6964 7369 7a65 2c0a  ize": gridsize,.
-00011940: 2020 2020 2020 2020 226e 625f 726f 7773          "nb_rows
-00011950: 5f64 6f6e 6522 3a20 302c 0a20 2020 2020  _done": 0,.     
-00011960: 2020 2022 746f 7461 6c5f 7469 6d65 223a     "total_time":
-00011970: 2030 2c0a 2020 2020 2020 2020 2270 6572   0,.        "per
-00011980: 6669 6e66 6f22 3a20 2222 2c0a 2020 2020  finfo": "",.    
-00011990: 7d0a 0a20 2020 2023 2052 6561 6420 616c  }..    # Read al
-000119a0: 6c20 7265 636f 7264 7320 7468 6174 2061  l records that a
-000119b0: 7265 2069 6e20 7468 6520 6262 6f78 0a20  re in the bbox. 
-000119c0: 2020 2072 6574 7279 5f63 6f75 6e74 203d     retry_count =
-000119d0: 2030 0a20 2020 2073 7461 7274 5f72 6561   0.    start_rea
-000119e0: 6420 3d20 6461 7465 7469 6d65 2e6e 6f77  d = datetime.now
-000119f0: 2829 0a20 2020 2061 6767 5f63 6f6c 756d  ().    agg_colum
-00011a00: 6e73 5f6e 6565 6465 6420 3d20 4e6f 6e65  ns_needed = None
-00011a10: 0a20 2020 2077 6869 6c65 2054 7275 653a  .    while True:
-00011a20: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-00011a30: 2020 2020 2020 2020 2020 636f 6c75 6d6e            column
-00011a40: 735f 746f 5f72 6561 643a 2053 6574 5b73  s_to_read: Set[s
-00011a50: 7472 5d20 3d20 7365 7428 290a 2020 2020  tr] = set().    
-00011a60: 2020 2020 2020 2020 696e 666f 203d 2067          info = g
-00011a70: 666f 2e67 6574 5f6c 6179 6572 696e 666f  fo.get_layerinfo
-00011a80: 2869 6e70 7574 5f70 6174 682c 2069 6e70  (input_path, inp
-00011a90: 7574 5f6c 6179 6572 290a 2020 2020 2020  ut_layer).      
-00011aa0: 2020 2020 2020 6966 2067 726f 7570 6279        if groupby
-00011ab0: 5f63 6f6c 756d 6e73 2069 7320 6e6f 7420  _columns is not 
-00011ac0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00011ad0: 2020 2020 2020 636f 6c75 6d6e 735f 746f        columns_to
-00011ae0: 5f72 6561 642e 7570 6461 7465 2867 726f  _read.update(gro
-00011af0: 7570 6279 5f63 6f6c 756d 6e73 290a 2020  upby_columns).  
-00011b00: 2020 2020 2020 2020 2020 6669 645f 6173            fid_as
-00011b10: 5f69 6e64 6578 203d 2046 616c 7365 0a20  _index = False. 
-00011b20: 2020 2020 2020 2020 2020 2069 6620 6167             if ag
-00011b30: 675f 636f 6c75 6d6e 7320 6973 206e 6f74  g_columns is not
-00011b40: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00011b50: 2020 2020 2020 2066 6964 5f61 735f 696e         fid_as_in
-00011b60: 6465 7820 3d20 5472 7565 0a20 2020 2020  dex = True.     
-00011b70: 2020 2020 2020 2020 2020 2069 6620 225f             if "_
-00011b80: 5f44 4953 534f 4c56 455f 544f 4a53 4f4e  _DISSOLVE_TOJSON
-00011b90: 2220 696e 2069 6e66 6f2e 636f 6c75 6d6e  " in info.column
-00011ba0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00011bb0: 2020 2020 2020 2023 2049 6620 7765 2061         # If we a
-00011bc0: 7265 206e 6f74 2069 6e20 7468 6520 6669  re not in the fi
-00011bd0: 7273 7420 7061 7373 2c20 7468 6520 636f  rst pass, the co
-00011be0: 6c75 6d6e 7320 746f 2062 6520 7265 6164  lumns to be read
-00011bf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011c00: 2020 2020 2023 2061 7265 2061 6c72 6561       # are alrea
-00011c10: 6479 2069 6e20 7468 6520 6a73 6f6e 2063  dy in the json c
-00011c20: 6f6c 756d 6e0a 2020 2020 2020 2020 2020  olumn.          
-00011c30: 2020 2020 2020 2020 2020 636f 6c75 6d6e            column
-00011c40: 735f 746f 5f72 6561 642e 6164 6428 225f  s_to_read.add("_
-00011c50: 5f44 4953 534f 4c56 455f 544f 4a53 4f4e  _DISSOLVE_TOJSON
-00011c60: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
-00011c70: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00011c80: 2020 2020 2020 2020 2020 2020 2023 2054               # T
-00011c90: 6865 2066 6972 7374 2070 6173 732c 2073  he first pass, s
-00011ca0: 6f20 7265 6164 2061 6c6c 2072 656c 6576  o read all relev
-00011cb0: 616e 7420 636f 6c75 6d6e 7320 746f 2063  ant columns to c
-00011cc0: 6f64 650a 2020 2020 2020 2020 2020 2020  ode.            
-00011cd0: 2020 2020 2020 2020 2320 7468 656d 2069          # them i
-00011ce0: 6e20 6a73 6f6e 0a20 2020 2020 2020 2020  n json.         
-00011cf0: 2020 2020 2020 2020 2020 2069 6620 226a             if "j
-00011d00: 736f 6e22 2069 6e20 6167 675f 636f 6c75  son" in agg_colu
-00011d10: 6d6e 733a 0a20 2020 2020 2020 2020 2020  mns:.           
-00011d20: 2020 2020 2020 2020 2020 2020 2061 6767               agg
-00011d30: 5f63 6f6c 756d 6e73 5f6e 6565 6465 6420  _columns_needed 
-00011d40: 3d20 6167 675f 636f 6c75 6d6e 735b 226a  = agg_columns["j
-00011d50: 736f 6e22 5d0a 2020 2020 2020 2020 2020  son"].          
-00011d60: 2020 2020 2020 2020 2020 656c 6966 2022            elif "
-00011d70: 636f 6c75 6d6e 7322 2069 6e20 6167 675f  columns" in agg_
-00011d80: 636f 6c75 6d6e 733a 0a20 2020 2020 2020  columns:.       
-00011d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011da0: 2061 6767 5f63 6f6c 756d 6e73 5f6e 6565   agg_columns_nee
-00011db0: 6465 6420 3d20 5b0a 2020 2020 2020 2020  ded = [.        
-00011dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011dd0: 2020 2020 6167 675f 636f 6c75 6d6e 5b22      agg_column["
-00011de0: 636f 6c75 6d6e 225d 0a20 2020 2020 2020  column"].       
-00011df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011e00: 2020 2020 2066 6f72 2061 6767 5f63 6f6c       for agg_col
-00011e10: 756d 6e20 696e 2061 6767 5f63 6f6c 756d  umn in agg_colum
-00011e20: 6e73 5b22 636f 6c75 6d6e 7322 5d0a 2020  ns["columns"].  
-00011e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011e40: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
-00011e50: 2020 2020 2020 2020 2020 2020 6966 2061              if a
-00011e60: 6767 5f63 6f6c 756d 6e73 5f6e 6565 6465  gg_columns_neede
-00011e70: 6420 6973 206e 6f74 204e 6f6e 653a 0a20  d is not None:. 
-00011e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011e90: 2020 2020 2020 2063 6f6c 756d 6e73 5f74         columns_t
-00011ea0: 6f5f 7265 6164 2e75 7064 6174 6528 6167  o_read.update(ag
-00011eb0: 675f 636f 6c75 6d6e 735f 6e65 6564 6564  g_columns_needed
-00011ec0: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
-00011ed0: 6e70 7574 5f67 6466 203d 2067 666f 2e72  nput_gdf = gfo.r
-00011ee0: 6561 645f 6669 6c65 280a 2020 2020 2020  ead_file(.      
-00011ef0: 2020 2020 2020 2020 2020 7061 7468 3d69            path=i
-00011f00: 6e70 7574 5f70 6174 682c 0a20 2020 2020  nput_path,.     
-00011f10: 2020 2020 2020 2020 2020 206c 6179 6572             layer
-00011f20: 3d69 6e70 7574 5f6c 6179 6572 2c0a 2020  =input_layer,.  
-00011f30: 2020 2020 2020 2020 2020 2020 2020 6262                bb
-00011f40: 6f78 3d62 626f 782c 0a20 2020 2020 2020  ox=bbox,.       
-00011f50: 2020 2020 2020 2020 2063 6f6c 756d 6e73           columns
-00011f60: 3d63 6f6c 756d 6e73 5f74 6f5f 7265 6164  =columns_to_read
-00011f70: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00011f80: 2020 6669 645f 6173 5f69 6e64 6578 3d66    fid_as_index=f
-00011f90: 6964 5f61 735f 696e 6465 782c 0a20 2020  id_as_index,.   
-00011fa0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-00011fb0: 2020 2020 2020 2020 6966 2061 6767 5f63          if agg_c
-00011fc0: 6f6c 756d 6e73 2069 7320 6e6f 7420 4e6f  olumns is not No
-00011fd0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00011fe0: 2020 2020 696e 7075 745f 6764 665b 2266      input_gdf["f
-00011ff0: 6964 5f6f 7269 6722 5d20 3d20 696e 7075  id_orig"] = inpu
-00012000: 745f 6764 662e 696e 6465 780a 2020 2020  t_gdf.index.    
-00012010: 2020 2020 2020 2020 2020 2020 6966 2061              if a
-00012020: 6767 5f63 6f6c 756d 6e73 5f6e 6565 6465  gg_columns_neede
-00012030: 6420 6973 206e 6f74 204e 6f6e 653a 0a20  d is not None:. 
-00012040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012050: 2020 2061 6767 5f63 6f6c 756d 6e73 5f6e     agg_columns_n
-00012060: 6565 6465 642e 6170 7065 6e64 2822 6669  eeded.append("fi
-00012070: 645f 6f72 6967 2229 0a0a 2020 2020 2020  d_orig")..      
-00012080: 2020 2020 2020 6272 6561 6b0a 2020 2020        break.    
-00012090: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
-000120a0: 7469 6f6e 2061 7320 6578 3a0a 2020 2020  tion as ex:.    
-000120b0: 2020 2020 2020 2020 6966 2073 7472 2865          if str(e
-000120c0: 7829 203d 3d20 2264 6174 6162 6173 6520  x) == "database 
-000120d0: 6973 206c 6f63 6b65 6422 3a0a 2020 2020  is locked":.    
-000120e0: 2020 2020 2020 2020 2020 2020 6966 2072              if r
-000120f0: 6574 7279 5f63 6f75 6e74 203c 2031 303a  etry_count < 10:
-00012100: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012110: 2020 2020 2072 6574 7279 5f63 6f75 6e74       retry_count
-00012120: 202b 3d20 310a 2020 2020 2020 2020 2020   += 1.          
-00012130: 2020 2020 2020 2020 2020 7469 6d65 2e73            time.s
-00012140: 6c65 6570 2831 290a 2020 2020 2020 2020  leep(1).        
-00012150: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00012160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012170: 2020 7261 6973 6520 4578 6365 7074 696f    raise Exceptio
-00012180: 6e28 2272 6574 7269 6564 2031 3020 7469  n("retried 10 ti
-00012190: 6d65 732c 2064 6174 6162 6173 6520 7374  mes, database st
-000121a0: 696c 6c20 6c6f 636b 6564 2229 2066 726f  ill locked") fro
-000121b0: 6d20 6578 0a20 2020 2020 2020 2020 2020  m ex.           
-000121c0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000121d0: 2020 2020 2020 2072 6169 7365 2065 780a         raise ex.
-000121e0: 0a20 2020 2023 2043 6865 636b 2072 6573  .    # Check res
-000121f0: 756c 740a 2020 2020 7065 7266 696e 666f  ult.    perfinfo
-00012200: 5b22 7469 6d65 5f72 6561 6422 5d20 3d20  ["time_read"] = 
-00012210: 2864 6174 6574 696d 652e 6e6f 7728 2920  (datetime.now() 
-00012220: 2d20 7374 6172 745f 7265 6164 292e 746f  - start_read).to
-00012230: 7461 6c5f 7365 636f 6e64 7328 290a 2020  tal_seconds().  
-00012240: 2020 7265 7475 726e 5f69 6e66 6f5b 226e    return_info["n
-00012250: 625f 726f 7773 5f64 6f6e 6522 5d20 3d20  b_rows_done"] = 
-00012260: 6c65 6e28 696e 7075 745f 6764 6629 0a20  len(input_gdf). 
-00012270: 2020 2069 6620 7265 7475 726e 5f69 6e66     if return_inf
-00012280: 6f5b 226e 625f 726f 7773 5f64 6f6e 6522  o["nb_rows_done"
-00012290: 5d20 3d3d 2030 3a0a 2020 2020 2020 2020  ] == 0:.        
-000122a0: 6d65 7373 6167 6520 3d20 6622 6469 7373  message = f"diss
-000122b0: 6f6c 7665 5f70 6f6c 7967 6f6e 733a 206e  olve_polygons: n
-000122c0: 6f20 696e 7075 7420 6765 6f6d 6574 7269  o input geometri
-000122d0: 6573 2066 6f75 6e64 2069 6e20 7b69 6e70  es found in {inp
-000122e0: 7574 5f70 6174 687d 220a 2020 2020 2020  ut_path}".      
-000122f0: 2020 6c6f 6767 6572 2e69 6e66 6f28 6d65    logger.info(me
-00012300: 7373 6167 6529 0a20 2020 2020 2020 2072  ssage).        r
-00012310: 6574 7572 6e5f 696e 666f 5b22 6d65 7373  eturn_info["mess
-00012320: 6167 6522 5d20 3d20 6d65 7373 6167 650a  age"] = message.
-00012330: 2020 2020 2020 2020 7265 7475 726e 5f69          return_i
-00012340: 6e66 6f5b 2274 6f74 616c 5f74 696d 6522  nfo["total_time"
-00012350: 5d20 3d20 2864 6174 6574 696d 652e 6e6f  ] = (datetime.no
-00012360: 7728 2920 2d20 7374 6172 745f 7469 6d65  w() - start_time
-00012370: 292e 746f 7461 6c5f 7365 636f 6e64 7328  ).total_seconds(
-00012380: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-00012390: 2072 6574 7572 6e5f 696e 666f 0a0a 2020   return_info..  
-000123a0: 2020 2320 4e6f 7720 7468 6520 7265 616c    # Now the real
-000123b0: 2070 726f 6365 7373 696e 670a 2020 2020   processing.    
-000123c0: 6167 6766 756e 633a 2055 6e69 6f6e 5b73  aggfunc: Union[s
-000123d0: 7472 2c20 6469 6374 2c20 4e6f 6e65 5d20  tr, dict, None] 
-000123e0: 3d20 4e6f 6e65 0a20 2020 2069 6620 6167  = None.    if ag
-000123f0: 675f 636f 6c75 6d6e 7320 6973 206e 6f74  g_columns is not
-00012400: 204e 6f6e 653a 0a20 2020 2020 2020 2069   None:.        i
-00012410: 6620 225f 5f44 4953 534f 4c56 455f 544f  f "__DISSOLVE_TO
-00012420: 4a53 4f4e 2220 6e6f 7420 696e 2069 6e70  JSON" not in inp
-00012430: 7574 5f67 6466 2e63 6f6c 756d 6e73 3a0a  ut_gdf.columns:.
-00012440: 2020 2020 2020 2020 2020 2020 2320 4669              # Fi
-00012450: 7273 7420 7061 7373 202d 3e20 7075 7420  rst pass -> put 
-00012460: 7265 6c65 7661 6e74 2063 6f6c 756d 6e73  relevant columns
-00012470: 2069 6e20 6a73 6f6e 2066 6965 6c64 0a20   in json field. 
-00012480: 2020 2020 2020 2020 2020 2061 6767 6675             aggfu
-00012490: 6e63 203d 207b 2274 6f5f 6a73 6f6e 223a  nc = {"to_json":
-000124a0: 2061 6767 5f63 6f6c 756d 6e73 5f6e 6565   agg_columns_nee
-000124b0: 6465 647d 0a20 2020 2020 2020 2065 6c73  ded}.        els
-000124c0: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
-000124d0: 2043 6f6c 756d 6e73 2061 6c72 6561 6479   Columns already
-000124e0: 2063 6f64 6564 2069 6e20 6120 6a73 6f6e   coded in a json
-000124f0: 2063 6f6c 756d 6e2c 2073 6f20 6d65 7267   column, so merg
-00012500: 6520 6a73 6f6e 206c 6973 7473 0a20 2020  e json lists.   
-00012510: 2020 2020 2020 2020 2061 6767 6675 6e63           aggfunc
-00012520: 203d 2022 6d65 7267 655f 6a73 6f6e 5f6c   = "merge_json_l
-00012530: 6973 7473 220a 2020 2020 656c 7365 3a0a  ists".    else:.
-00012540: 2020 2020 2020 2020 6167 6766 756e 6320          aggfunc 
-00012550: 3d20 2266 6972 7374 220a 2020 2020 7374  = "first".    st
-00012560: 6172 745f 6469 7373 6f6c 7665 203d 2064  art_dissolve = d
-00012570: 6174 6574 696d 652e 6e6f 7728 290a 2020  atetime.now().  
-00012580: 2020 6469 7373 5f67 6466 203d 205f 6469    diss_gdf = _di
-00012590: 7373 6f6c 7665 280a 2020 2020 2020 2020  ssolve(.        
-000125a0: 6466 3d69 6e70 7574 5f67 6466 2c20 6279  df=input_gdf, by
-000125b0: 3d67 726f 7570 6279 5f63 6f6c 756d 6e73  =groupby_columns
-000125c0: 2c20 6167 6766 756e 633d 6167 6766 756e  , aggfunc=aggfun
-000125d0: 632c 2061 735f 696e 6465 783d 4661 6c73  c, as_index=Fals
-000125e0: 652c 2064 726f 706e 613d 4661 6c73 650a  e, dropna=False.
-000125f0: 2020 2020 290a 2020 2020 7065 7266 696e      ).    perfin
-00012600: 666f 5b22 7469 6d65 5f64 6973 736f 6c76  fo["time_dissolv
-00012610: 6522 5d20 3d20 2864 6174 6574 696d 652e  e"] = (datetime.
-00012620: 6e6f 7728 2920 2d20 7374 6172 745f 6469  now() - start_di
-00012630: 7373 6f6c 7665 292e 746f 7461 6c5f 7365  ssolve).total_se
-00012640: 636f 6e64 7328 290a 0a20 2020 2023 2049  conds()..    # I
-00012650: 6620 6578 706c 6f64 6563 6f6c 6c65 6374  f explodecollect
-00012660: 696f 6e73 2069 7320 5472 7565 2061 6e64  ions is True and
-00012670: 2046 6f72 2070 6f6c 7967 6f6e 732c 2065   For polygons, e
-00012680: 7870 6c6f 6465 206d 756c 7469 2d67 656f  xplode multi-geo
-00012690: 6d65 7472 6965 732e 0a20 2020 2023 2049  metries..    # I
-000126a0: 6620 6e65 6564 6564 2074 6865 7920 7769  f needed they wi
-000126b0: 6c6c 2062 6520 2763 6f6c 6c65 6374 6564  ll be 'collected
-000126c0: 2720 6166 7465 7277 6172 6473 2074 6f20  ' afterwards to 
-000126d0: 6d75 6c74 6970 6f6c 7967 6f6e 7320 6167  multipolygons ag
-000126e0: 6169 6e2e 0a20 2020 2069 6620 6578 706c  ain..    if expl
-000126f0: 6f64 6563 6f6c 6c65 6374 696f 6e73 2069  odecollections i
-00012700: 7320 5472 7565 206f 7220 696e 7075 745f  s True or input_
-00012710: 6765 6f6d 6574 7279 7479 7065 2069 6e20  geometrytype in 
-00012720: 5b0a 2020 2020 2020 2020 4765 6f6d 6574  [.        Geomet
-00012730: 7279 5479 7065 2e50 4f4c 5947 4f4e 2c0a  ryType.POLYGON,.
-00012740: 2020 2020 2020 2020 4765 6f6d 6574 7279          Geometry
-00012750: 5479 7065 2e4d 554c 5449 504f 4c59 474f  Type.MULTIPOLYGO
-00012760: 4e2c 0a20 2020 205d 3a0a 2020 2020 2020  N,.    ]:.      
-00012770: 2020 6469 7373 5f67 6466 203d 2064 6973    diss_gdf = dis
-00012780: 735f 6764 662e 6578 706c 6f64 6528 6967  s_gdf.explode(ig
-00012790: 6e6f 7265 5f69 6e64 6578 3d54 7275 6529  nore_index=True)
-000127a0: 0a0a 2020 2020 2320 436c 6970 2074 6865  ..    # Clip the
-000127b0: 2072 6573 756c 7420 6f6e 2074 6865 2062   result on the b
-000127c0: 6f72 6465 7273 206f 6620 7468 6520 6262  orders of the bb
-000127d0: 6f78 206e 6f74 2074 6f20 6861 7665 206f  ox not to have o
-000127e0: 7665 726c 6170 730a 2020 2020 2320 6265  verlaps.    # be
-000127f0: 7477 6565 6e20 7468 6520 6469 6666 6572  tween the differ
-00012800: 656e 7420 7469 6c65 732e 0a20 2020 2023  ent tiles..    #
-00012810: 2049 6620 7468 6973 2069 7320 6e6f 7420   If this is not 
-00012820: 6170 706c 6965 642c 2074 6869 7320 7265  applied, this re
-00012830: 7375 6c74 7320 696e 2073 6f6d 6520 6765  sults in some ge
-00012840: 6f6d 6574 7269 6573 206e 6f74 2062 6569  ometries not bei
-00012850: 6e67 206d 6572 6765 640a 2020 2020 2320  ng merged.    # 
-00012860: 6f72 2069 6e20 6475 706c 6963 6174 6573  or in duplicates
-00012870: 2e0a 2020 2020 2320 5245 4d41 524b 3a20  ..    # REMARK: 
-00012880: 666f 7220 286d 756c 7469 296c 696e 6573  for (multi)lines
-00012890: 7472 696e 6773 2c20 7468 6520 656e 6470  trings, the endp
-000128a0: 6f69 6e74 7320 6372 6561 7465 6420 6279  oints created by
-000128b0: 2074 6865 2063 6c69 7020 6172 6520 6e6f   the clip are no
-000128c0: 740a 2020 2020 2320 616c 7761 7973 2074  t.    # always t
-000128d0: 6865 2073 616d 6520 6475 6520 746f 2072  he same due to r
-000128e0: 6f75 6e64 696e 672c 2073 6f20 6469 7373  ounding, so diss
-000128f0: 6f6c 7669 6e67 2069 6e20 6120 6e65 7874  olving in a next
-00012900: 2070 6173 7320 646f 6573 6e27 740a 2020   pass doesn't.  
-00012910: 2020 2320 616c 7761 7973 2072 6573 756c    # always resul
-00012920: 7420 696e 206c 696e 6573 7472 696e 6773  t in linestrings
-00012930: 2062 6569 6e67 2072 652d 636f 6e6e 6563   being re-connec
-00012940: 7465 642e 2e2e 2042 6563 6175 7365 2064  ted... Because d
-00012950: 6973 736f 6c76 696e 670a 2020 2020 2320  issolving.    # 
-00012960: 6c69 6e65 7320 6973 6e27 7420 736f 2063  lines isn't so c
-00012970: 6f6d 7075 7461 7469 6f6e 616c 6c79 2068  omputationally h
-00012980: 6561 7679 2061 6e79 7761 792c 2064 726f  eavy anyway, dro
-00012990: 7020 7375 7070 6f72 7420 6865 7265 2e0a  p support here..
-000129a0: 2020 2020 6966 2062 626f 7820 6973 206e      if bbox is n
-000129b0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-000129c0: 2073 7461 7274 5f63 6c69 7020 3d20 6461   start_clip = da
-000129d0: 7465 7469 6d65 2e6e 6f77 2829 0a20 2020  tetime.now().   
-000129e0: 2020 2020 2062 626f 785f 706f 6c79 676f       bbox_polygo
-000129f0: 6e20 3d20 7368 5f67 656f 6d2e 506f 6c79  n = sh_geom.Poly
-00012a00: 676f 6e28 0a20 2020 2020 2020 2020 2020  gon(.           
-00012a10: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
-00012a20: 2020 2028 6262 6f78 5b30 5d2c 2062 626f     (bbox[0], bbo
-00012a30: 785b 315d 292c 0a20 2020 2020 2020 2020  x[1]),.         
-00012a40: 2020 2020 2020 2028 6262 6f78 5b30 5d2c         (bbox[0],
-00012a50: 2062 626f 785b 335d 292c 0a20 2020 2020   bbox[3]),.     
-00012a60: 2020 2020 2020 2020 2020 2028 6262 6f78             (bbox
-00012a70: 5b32 5d2c 2062 626f 785b 335d 292c 0a20  [2], bbox[3]),. 
-00012a80: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00012a90: 6262 6f78 5b32 5d2c 2062 626f 785b 315d  bbox[2], bbox[1]
-00012aa0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00012ab0: 2020 2028 6262 6f78 5b30 5d2c 2062 626f     (bbox[0], bbo
-00012ac0: 785b 315d 292c 0a20 2020 2020 2020 2020  x[1]),.         
-00012ad0: 2020 205d 0a20 2020 2020 2020 2029 0a20     ].        ). 
-00012ae0: 2020 2020 2020 2062 626f 785f 6764 6620         bbox_gdf 
-00012af0: 3d20 6770 642e 4765 6f44 6174 6146 7261  = gpd.GeoDataFra
-00012b00: 6d65 280a 2020 2020 2020 2020 2020 2020  me(.            
-00012b10: 6461 7461 3d5b 315d 2c20 6765 6f6d 6574  data=[1], geomet
-00012b20: 7279 3d5b 6262 6f78 5f70 6f6c 7967 6f6e  ry=[bbox_polygon
-00012b30: 5d2c 2063 7273 3d69 6e70 7574 5f67 6466  ], crs=input_gdf
-00012b40: 2e63 7273 0a20 2020 2020 2020 2029 0a0a  .crs.        )..
-00012b50: 2020 2020 2020 2020 2320 4361 7463 6820          # Catch 
-00012b60: 6972 7265 6c65 7661 6e74 2070 616e 6461  irrelevant panda
-00012b70: 7320 6675 7475 7265 2077 6172 6e69 6e67  s future warning
-00012b80: 0a20 2020 2020 2020 2023 2054 4f44 4f3a  .        # TODO:
-00012b90: 2077 6865 6e20 7265 6d6f 7665 6420 696e   when removed in
-00012ba0: 206c 6174 6572 2076 6572 7369 6f6e 206f   later version o
-00012bb0: 6620 7061 6e64 6173 2c20 6361 6e20 6265  f pandas, can be
-00012bc0: 2072 656d 6f76 6564 2068 6572 650a 2020   removed here.  
-00012bd0: 2020 2020 2020 7769 7468 2077 6172 6e69        with warni
-00012be0: 6e67 732e 6361 7463 685f 7761 726e 696e  ngs.catch_warnin
-00012bf0: 6773 2829 3a0a 2020 2020 2020 2020 2020  gs():.          
-00012c00: 2020 6d65 7373 6167 6520 3d20 280a 2020    message = (.  
-00012c10: 2020 2020 2020 2020 2020 2020 2020 2249                "I
-00012c20: 6e20 6120 6675 7475 7265 2076 6572 7369  n a future versi
-00012c30: 6f6e 2c20 6064 662e 696c 6f63 5b3a 2c20  on, `df.iloc[:, 
-00012c40: 695d 203d 206e 6577 7661 6c73 6020 7769  i] = newvals` wi
-00012c50: 6c6c 2061 7474 656d 7074 2074 6f20 220a  ll attempt to ".
-00012c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012c70: 2273 6574 2074 6865 2076 616c 7565 7320  "set the values 
-00012c80: 696e 706c 6163 6520 696e 7374 6561 6420  inplace instead 
-00012c90: 6f66 2061 6c77 6179 7320 7365 7474 696e  of always settin
-00012ca0: 6720 6120 6e65 7720 6172 7261 792e 220a  g a new array.".
-00012cb0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00012cc0: 2020 2020 2020 2020 2020 7761 726e 696e            warnin
-00012cd0: 6773 2e66 696c 7465 7277 6172 6e69 6e67  gs.filterwarning
-00012ce0: 7328 0a20 2020 2020 2020 2020 2020 2020  s(.             
-00012cf0: 2020 2061 6374 696f 6e3d 2269 676e 6f72     action="ignor
-00012d00: 6522 2c20 6361 7465 676f 7279 3d46 7574  e", category=Fut
-00012d10: 7572 6557 6172 6e69 6e67 2c20 6d65 7373  ureWarning, mess
-00012d20: 6167 653d 7265 2e65 7363 6170 6528 6d65  age=re.escape(me
-00012d30: 7373 6167 6529 0a20 2020 2020 2020 2020  ssage).         
-00012d40: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00012d50: 2023 206b 6565 705f 6765 6f6d 5f74 7970   # keep_geom_typ
-00012d60: 653d 5472 7565 2067 6176 6520 736f 6d65  e=True gave some
-00012d70: 7469 6d65 7320 6572 726f 722c 2061 6e64  times error, and
-00012d80: 2073 7469 6c6c 2064 6f65 7320 696e 2030   still does in 0
-00012d90: 2e39 2e30 0a20 2020 2020 2020 2020 2020  .9.0.           
-00012da0: 2023 2073 6f20 7573 6520 6f77 6e20 696d   # so use own im
-00012db0: 706c 656d 656e 7461 7469 6f6e 206f 6620  plementation of 
-00012dc0: 6b65 6570 5f67 656f 6d5f 7479 7065 0a20  keep_geom_type. 
-00012dd0: 2020 2020 2020 2020 2020 2064 6973 735f             diss_
-00012de0: 6764 6620 3d20 6770 642e 636c 6970 2864  gdf = gpd.clip(d
-00012df0: 6973 735f 6764 662c 2062 626f 785f 6764  iss_gdf, bbox_gd
-00012e00: 6629 2020 2320 2c20 6b65 6570 5f67 656f  f)  # , keep_geo
-00012e10: 6d5f 7479 7065 3d54 7275 6529 0a20 2020  m_type=True).   
-00012e20: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00012e30: 6973 696e 7374 616e 6365 2864 6973 735f  isinstance(diss_
-00012e40: 6764 662c 2067 7064 2e47 656f 4461 7461  gdf, gpd.GeoData
-00012e50: 4672 616d 6529 0a0a 2020 2020 2020 2020  Frame)..        
-00012e60: 2320 4f6e 6c79 206b 6565 7020 6765 6f6d  # Only keep geom
-00012e70: 6574 7269 6573 206f 6620 7468 6520 7072  etries of the pr
-00012e80: 696d 6974 6976 6520 7479 7065 2073 7065  imitive type spe
-00012e90: 6369 6669 6564 2061 6674 6572 2063 6c69  cified after cli
-00012ea0: 702e 2e2e 0a20 2020 2020 2020 2061 7373  p....        ass
-00012eb0: 6572 7420 6973 696e 7374 616e 6365 2864  ert isinstance(d
-00012ec0: 6973 735f 6764 662c 2067 7064 2e47 656f  iss_gdf, gpd.Geo
-00012ed0: 4461 7461 4672 616d 6529 0a20 2020 2020  DataFrame).     
-00012ee0: 2020 2064 6973 735f 6764 662e 6765 6f6d     diss_gdf.geom
-00012ef0: 6574 7279 203d 2070 7967 656f 6f70 732e  etry = pygeoops.
-00012f00: 636f 6c6c 6563 7469 6f6e 5f65 7874 7261  collection_extra
-00012f10: 6374 280a 2020 2020 2020 2020 2020 2020  ct(.            
-00012f20: 6469 7373 5f67 6466 2e67 656f 6d65 7472  diss_gdf.geometr
-00012f30: 792c 2070 7269 6d69 7469 7665 7479 7065  y, primitivetype
-00012f40: 3d69 6e70 7574 5f67 656f 6d65 7472 7974  =input_geometryt
-00012f50: 7970 652e 746f 5f70 7269 6d69 7469 7665  ype.to_primitive
-00012f60: 7479 7065 0a20 2020 2020 2020 2029 0a0a  type.        )..
-00012f70: 2020 2020 2020 2020 7065 7266 696e 666f          perfinfo
-00012f80: 5b22 7469 6d65 5f63 6c69 7022 5d20 3d20  ["time_clip"] = 
-00012f90: 2864 6174 6574 696d 652e 6e6f 7728 2920  (datetime.now() 
-00012fa0: 2d20 7374 6172 745f 636c 6970 292e 746f  - start_clip).to
-00012fb0: 7461 6c5f 7365 636f 6e64 7328 290a 0a20  tal_seconds().. 
-00012fc0: 2020 2069 6620 6772 6964 7369 7a65 2021     if gridsize !
-00012fd0: 3d20 302e 303a 0a20 2020 2020 2020 2064  = 0.0:.        d
-00012fe0: 6973 735f 6764 662e 6765 6f6d 6574 7279  iss_gdf.geometry
-00012ff0: 203d 205f 6765 6f73 6572 6965 735f 7574   = _geoseries_ut
-00013000: 696c 2e73 6574 5f70 7265 6369 7369 6f6e  il.set_precision
-00013010: 280a 2020 2020 2020 2020 2020 2020 6469  (.            di
-00013020: 7373 5f67 6466 2e67 656f 6d65 7472 792c  ss_gdf.geometry,
-00013030: 2067 7269 645f 7369 7a65 3d67 7269 6473   grid_size=grids
-00013040: 697a 652c 2072 6169 7365 5f6f 6e5f 746f  ize, raise_on_to
-00013050: 706f 6572 726f 723d 4661 6c73 650a 2020  poerror=False.  
-00013060: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00013070: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
-00013080: 6528 6469 7373 5f67 6466 2e67 656f 6d65  e(diss_gdf.geome
-00013090: 7472 792c 2067 7064 2e47 656f 5365 7269  try, gpd.GeoSeri
-000130a0: 6573 290a 0a20 2020 2023 2053 6574 2065  es)..    # Set e
-000130b0: 6d70 7479 2067 656f 6d65 7472 6965 7320  mpty geometries 
-000130c0: 746f 204e 6f6e 650a 2020 2020 6469 7373  to None.    diss
-000130d0: 5f67 6466 2e6c 6f63 5b64 6973 735f 6764  _gdf.loc[diss_gd
-000130e0: 662e 6765 6f6d 6574 7279 2e69 735f 656d  f.geometry.is_em
-000130f0: 7074 792c 2064 6973 735f 6764 662e 6765  pty, diss_gdf.ge
-00013100: 6f6d 6574 7279 2e6e 616d 655d 203d 204e  ometry.name] = N
-00013110: 6f6e 650a 0a20 2020 2069 6620 6e6f 7420  one..    if not 
-00013120: 6b65 6570 5f65 6d70 7479 5f67 656f 6d73  keep_empty_geoms
-00013130: 3a0a 2020 2020 2020 2020 2320 5265 6d6f  :.        # Remo
-00013140: 7665 2072 6f77 7320 7768 6572 6520 6765  ve rows where ge
-00013150: 6f6d 2069 7320 4e6f 6e65 0a20 2020 2020  om is None.     
-00013160: 2020 2061 7373 6572 7420 6973 696e 7374     assert isinst
-00013170: 616e 6365 2864 6973 735f 6764 662c 2067  ance(diss_gdf, g
-00013180: 7064 2e47 656f 4461 7461 4672 616d 6529  pd.GeoDataFrame)
-00013190: 0a20 2020 2020 2020 2064 6973 735f 6764  .        diss_gd
-000131a0: 6620 3d20 6469 7373 5f67 6466 5b7e 6469  f = diss_gdf[~di
-000131b0: 7373 5f67 6466 2e67 656f 6d65 7472 792e  ss_gdf.geometry.
-000131c0: 6973 6e61 2829 5d0a 0a20 2020 2023 2049  isna()]..    # I
-000131d0: 6620 7468 6572 6520 6973 206e 6f20 7265  f there is no re
-000131e0: 7375 6c74 2c20 7265 7475 726e 0a20 2020  sult, return.   
-000131f0: 2069 6620 6c65 6e28 6469 7373 5f67 6466   if len(diss_gdf
-00013200: 2920 3d3d 2030 3a0a 2020 2020 2020 2020  ) == 0:.        
-00013210: 6d65 7373 6167 6520 3d20 6622 5265 7375  message = f"Resu
-00013220: 6c74 2069 7320 656d 7074 7920 666f 7220  lt is empty for 
-00013230: 7b69 6e70 7574 5f70 6174 687d 220a 2020  {input_path}".  
-00013240: 2020 2020 2020 7265 7475 726e 5f69 6e66        return_inf
-00013250: 6f5b 226d 6573 7361 6765 225d 203d 206d  o["message"] = m
-00013260: 6573 7361 6765 0a20 2020 2020 2020 2072  essage.        r
-00013270: 6574 7572 6e5f 696e 666f 5b22 7065 7266  eturn_info["perf
-00013280: 696e 666f 225d 203d 2070 6572 6669 6e66  info"] = perfinf
-00013290: 6f0a 2020 2020 2020 2020 7265 7475 726e  o.        return
-000132a0: 5f69 6e66 6f5b 2274 6f74 616c 5f74 696d  _info["total_tim
-000132b0: 6522 5d20 3d20 2864 6174 6574 696d 652e  e"] = (datetime.
-000132c0: 6e6f 7728 2920 2d20 7374 6172 745f 7469  now() - start_ti
-000132d0: 6d65 292e 746f 7461 6c5f 7365 636f 6e64  me).total_second
-000132e0: 7328 290a 2020 2020 2020 2020 7265 7475  s().        retu
-000132f0: 726e 2072 6574 7572 6e5f 696e 666f 0a0a  rn return_info..
-00013300: 2020 2020 2320 4164 6420 636f 6c75 6d6e      # Add column
-00013310: 2077 6974 6820 7469 6c65 5f69 640a 2020   with tile_id.  
-00013320: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
-00013330: 6e63 6528 6469 7373 5f67 6466 2c20 6770  nce(diss_gdf, gp
-00013340: 642e 4765 6f44 6174 6146 7261 6d65 290a  d.GeoDataFrame).
-00013350: 2020 2020 6966 2074 696c 655f 6964 2069      if tile_id i
-00013360: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00013370: 2020 2020 6469 7373 5f67 6466 5b22 7469      diss_gdf["ti
-00013380: 6c65 5f69 6422 5d20 3d20 7469 6c65 5f69  le_id"] = tile_i
-00013390: 640a 0a20 2020 2023 2053 6176 6520 7468  d..    # Save th
-000133a0: 6520 7265 7375 6c74 2074 6f20 6465 7374  e result to dest
-000133b0: 696e 6174 696f 6e20 6669 6c65 2873 290a  ination file(s).
-000133c0: 2020 2020 7374 6172 745f 746f 5f66 696c      start_to_fil
-000133d0: 6520 3d20 6461 7465 7469 6d65 2e6e 6f77  e = datetime.now
-000133e0: 2829 0a0a 2020 2020 2320 4966 2074 6865  ()..    # If the
-000133f0: 2074 696c 6573 2064 6f6e 2774 206e 6565   tiles don't nee
-00013400: 6420 746f 2062 6520 6d65 7267 6564 2061  d to be merged a
-00013410: 6674 6572 7761 7264 732c 2077 6520 6361  fterwards, we ca
-00013420: 6e20 6a75 7374 2073 6176 6520 7468 6520  n just save the 
-00013430: 7265 7375 6c74 2061 730a 2020 2020 2320  result as.    # 
-00013440: 6974 2069 732e 0a20 2020 2069 6620 7374  it is..    if st
-00013450: 7228 6f75 7470 7574 5f6e 6f74 6f6e 626f  r(output_notonbo
-00013460: 7264 6572 5f70 6174 6829 203d 3d20 7374  rder_path) == st
-00013470: 7228 6f75 7470 7574 5f6f 6e62 6f72 6465  r(output_onborde
-00013480: 725f 7061 7468 293a 0a20 2020 2020 2020  r_path):.       
-00013490: 2023 2061 7373 6572 7420 746f 2061 766f   # assert to avo
-000134a0: 6964 2070 794c 616e 6365 2077 6172 6e69  id pyLance warni
-000134b0: 6e67 0a20 2020 2020 2020 2061 7373 6572  ng.        asser
-000134c0: 7420 6973 696e 7374 616e 6365 2864 6973  t isinstance(dis
-000134d0: 735f 6764 662c 2067 7064 2e47 656f 4461  s_gdf, gpd.GeoDa
-000134e0: 7461 4672 616d 6529 0a20 2020 2020 2020  taFrame).       
-000134f0: 2023 2055 7365 2066 6f72 6365 5f6d 756c   # Use force_mul
-00013500: 7469 7479 7065 2c20 746f 2061 766f 6964  titype, to avoid
-00013510: 2077 6172 6e69 6e67 7320 7768 656e 2073   warnings when s
-00013520: 6f6d 6520 6261 7463 6865 7320 636f 6e74  ome batches cont
-00013530: 6169 6e0a 2020 2020 2020 2020 2320 7369  ain.        # si
-00013540: 6e67 6c65 7479 7065 2061 6e64 2073 6f6d  ngletype and som
-00013550: 6520 636f 6e74 6169 6e20 6d75 6c74 6974  e contain multit
-00013560: 7970 6520 6765 6f6d 6574 7269 6573 0a20  ype geometries. 
-00013570: 2020 2020 2020 2067 666f 2e74 6f5f 6669         gfo.to_fi
-00013580: 6c65 280a 2020 2020 2020 2020 2020 2020  le(.            
-00013590: 6469 7373 5f67 6466 2c0a 2020 2020 2020  diss_gdf,.      
-000135a0: 2020 2020 2020 6f75 7470 7574 5f6e 6f74        output_not
-000135b0: 6f6e 626f 7264 6572 5f70 6174 682c 0a20  onborder_path,. 
-000135c0: 2020 2020 2020 2020 2020 206c 6179 6572             layer
-000135d0: 3d6f 7574 7075 745f 6c61 7965 722c 0a20  =output_layer,. 
-000135e0: 2020 2020 2020 2020 2020 2066 6f72 6365             force
-000135f0: 5f6d 756c 7469 7479 7065 3d54 7275 652c  _multitype=True,
-00013600: 0a20 2020 2020 2020 2020 2020 2069 6e64  .            ind
-00013610: 6578 3d46 616c 7365 2c0a 2020 2020 2020  ex=False,.      
-00013620: 2020 2020 2020 6372 6561 7465 5f73 7061        create_spa
-00013630: 7469 616c 5f69 6e64 6578 3d46 616c 7365  tial_index=False
-00013640: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-00013650: 656c 7365 3a0a 2020 2020 2020 2020 2320  else:.        # 
-00013660: 4966 206e 6f74 2c20 7361 7665 2074 6865  If not, save the
-00013670: 2070 6f6c 7967 6f6e 7320 6f6e 2074 6865   polygons on the
-00013680: 2062 6f72 6465 7220 7365 7065 7261 7465   border seperate
-00013690: 6c79 0a20 2020 2020 2020 2062 626f 785f  ly.        bbox_
-000136a0: 6c69 6e65 7320 3d20 7079 6765 6f6f 7073  lines = pygeoops
-000136b0: 2e65 7870 6c6f 6465 280a 2020 2020 2020  .explode(.      
-000136c0: 2020 2020 2020 7368 6170 656c 792e 626f        shapely.bo
-000136d0: 756e 6461 7279 2873 685f 6765 6f6d 2e62  undary(sh_geom.b
-000136e0: 6f78 2862 626f 785b 305d 2c20 6262 6f78  ox(bbox[0], bbox
-000136f0: 5b31 5d2c 2062 626f 785b 325d 2c20 6262  [1], bbox[2], bb
-00013700: 6f78 5b33 5d29 290a 2020 2020 2020 2020  ox[3])).        
-00013710: 290a 2020 2020 2020 2020 6262 6f78 5f6c  ).        bbox_l
-00013720: 696e 6573 5f67 6466 203d 2067 7064 2e47  ines_gdf = gpd.G
-00013730: 656f 4461 7461 4672 616d 6528 6765 6f6d  eoDataFrame(geom
-00013740: 6574 7279 3d62 626f 785f 6c69 6e65 732c  etry=bbox_lines,
-00013750: 2063 7273 3d69 6e70 7574 5f67 6466 2e63   crs=input_gdf.c
-00013760: 7273 290a 2020 2020 2020 2020 6f6e 626f  rs).        onbo
-00013770: 7264 6572 5f67 6466 203d 2067 7064 2e73  rder_gdf = gpd.s
-00013780: 6a6f 696e 2864 6973 735f 6764 662c 2062  join(diss_gdf, b
-00013790: 626f 785f 6c69 6e65 735f 6764 662c 2070  box_lines_gdf, p
-000137a0: 7265 6469 6361 7465 3d22 696e 7465 7273  redicate="inters
-000137b0: 6563 7473 2229 0a20 2020 2020 2020 206f  ects").        o
-000137c0: 6e62 6f72 6465 725f 6764 662e 6472 6f70  nborder_gdf.drop
-000137d0: 2822 696e 6465 785f 7269 6768 7422 2c20  ("index_right", 
-000137e0: 6178 6973 3d31 2c20 696e 706c 6163 653d  axis=1, inplace=
-000137f0: 5472 7565 290a 2020 2020 2020 2020 6966  True).        if
-00013800: 206c 656e 286f 6e62 6f72 6465 725f 6764   len(onborder_gd
-00013810: 6629 203e 2030 3a0a 2020 2020 2020 2020  f) > 0:.        
-00013820: 2020 2020 2320 5573 6520 666f 7263 655f      # Use force_
-00013830: 6d75 6c74 6974 7970 652c 2074 6f20 6176  multitype, to av
-00013840: 6f69 6420 7761 726e 696e 6773 2077 6865  oid warnings whe
-00013850: 6e20 736f 6d65 2062 6174 6368 6573 2063  n some batches c
-00013860: 6f6e 7461 696e 0a20 2020 2020 2020 2020  ontain.         
-00013870: 2020 2023 2073 696e 676c 6574 7970 6520     # singletype 
-00013880: 616e 6420 736f 6d65 2063 6f6e 7461 696e  and some contain
-00013890: 206d 756c 7469 7479 7065 2067 656f 6d65   multitype geome
-000138a0: 7472 6965 730a 2020 2020 2020 2020 2020  tries.          
-000138b0: 2020 6766 6f2e 746f 5f66 696c 6528 0a20    gfo.to_file(. 
-000138c0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-000138d0: 6e62 6f72 6465 725f 6764 662c 0a20 2020  nborder_gdf,.   
-000138e0: 2020 2020 2020 2020 2020 2020 206f 7574               out
-000138f0: 7075 745f 6f6e 626f 7264 6572 5f70 6174  put_onborder_pat
-00013900: 682c 0a20 2020 2020 2020 2020 2020 2020  h,.             
-00013910: 2020 206c 6179 6572 3d6f 7574 7075 745f     layer=output_
-00013920: 6c61 7965 722c 0a20 2020 2020 2020 2020  layer,.         
-00013930: 2020 2020 2020 2066 6f72 6365 5f6d 756c         force_mul
-00013940: 7469 7479 7065 3d54 7275 652c 0a20 2020  titype=True,.   
-00013950: 2020 2020 2020 2020 2020 2020 2063 7265               cre
-00013960: 6174 655f 7370 6174 6961 6c5f 696e 6465  ate_spatial_inde
-00013970: 783d 4661 6c73 652c 0a20 2020 2020 2020  x=False,.       
-00013980: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00013990: 6e6f 746f 6e62 6f72 6465 725f 6764 6620  notonborder_gdf 
-000139a0: 3d20 6469 7373 5f67 6466 5b7e 6469 7373  = diss_gdf[~diss
-000139b0: 5f67 6466 2e69 6e64 6578 2e69 7369 6e28  _gdf.index.isin(
-000139c0: 6f6e 626f 7264 6572 5f67 6466 2e69 6e64  onborder_gdf.ind
-000139d0: 6578 295d 0a20 2020 2020 2020 2069 6620  ex)].        if 
-000139e0: 6c65 6e28 6e6f 746f 6e62 6f72 6465 725f  len(notonborder_
-000139f0: 6764 6629 203e 2030 3a0a 2020 2020 2020  gdf) > 0:.      
-00013a00: 2020 2020 2020 2320 5573 6520 666f 7263        # Use forc
-00013a10: 655f 6d75 6c74 6974 7970 652c 2074 6f20  e_multitype, to 
-00013a20: 6176 6f69 6420 7761 726e 696e 6773 2077  avoid warnings w
-00013a30: 6865 6e20 736f 6d65 2062 6174 6368 6573  hen some batches
-00013a40: 2063 6f6e 7461 696e 0a20 2020 2020 2020   contain.       
-00013a50: 2020 2020 2023 2073 696e 676c 6574 7970       # singletyp
-00013a60: 6520 616e 6420 736f 6d65 2063 6f6e 7461  e and some conta
-00013a70: 696e 206d 756c 7469 7479 7065 2067 656f  in multitype geo
-00013a80: 6d65 7472 6965 730a 2020 2020 2020 2020  metries.        
-00013a90: 2020 2020 6766 6f2e 746f 5f66 696c 6528      gfo.to_file(
-00013aa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013ab0: 206e 6f74 6f6e 626f 7264 6572 5f67 6466   notonborder_gdf
-00013ac0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00013ad0: 2020 6f75 7470 7574 5f6e 6f74 6f6e 626f    output_notonbo
-00013ae0: 7264 6572 5f70 6174 682c 0a20 2020 2020  rder_path,.     
-00013af0: 2020 2020 2020 2020 2020 206c 6179 6572             layer
-00013b00: 3d6f 7574 7075 745f 6c61 7965 722c 0a20  =output_layer,. 
-00013b10: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00013b20: 6f72 6365 5f6d 756c 7469 7479 7065 3d54  orce_multitype=T
-00013b30: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
-00013b40: 2020 2020 2069 6e64 6578 3d46 616c 7365       index=False
-00013b50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00013b60: 2020 6372 6561 7465 5f73 7061 7469 616c    create_spatial
-00013b70: 5f69 6e64 6578 3d46 616c 7365 2c0a 2020  _index=False,.  
-00013b80: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00013b90: 7065 7266 696e 666f 5b22 7469 6d65 5f74  perfinfo["time_t
-00013ba0: 6f5f 6669 6c65 225d 203d 2028 6461 7465  o_file"] = (date
-00013bb0: 7469 6d65 2e6e 6f77 2829 202d 2073 7461  time.now() - sta
-00013bc0: 7274 5f74 6f5f 6669 6c65 292e 746f 7461  rt_to_file).tota
-00013bd0: 6c5f 7365 636f 6e64 7328 290a 0a20 2020  l_seconds()..   
-00013be0: 2023 2046 696e 616c 6973 652e 2e2e 0a20   # Finalise.... 
-00013bf0: 2020 206d 6573 7361 6765 203d 2066 2264     message = f"d
-00013c00: 6973 736f 6c76 655f 706f 6c79 676f 6e73  issolve_polygons
-00013c10: 3a20 7265 6164 7920 696e 207b 6461 7465  : ready in {date
-00013c20: 7469 6d65 2e6e 6f77 2829 2d73 7461 7274  time.now()-start
-00013c30: 5f74 696d 657d 206f 6e20 7b69 6e70 7574  _time} on {input
-00013c40: 5f70 6174 687d 220a 2020 2020 6c6f 6767  _path}".    logg
-00013c50: 6572 2e64 6562 7567 286d 6573 7361 6765  er.debug(message
-00013c60: 290a 0a20 2020 2023 2043 6f6c 6c65 6374  )..    # Collect
-00013c70: 2070 6572 6669 6e66 6f0a 2020 2020 746f   perfinfo.    to
-00013c80: 7461 6c5f 7065 7266 5f74 696d 6520 3d20  tal_perf_time = 
-00013c90: 302e 300a 2020 2020 7065 7266 7374 7269  0.0.    perfstri
-00013ca0: 6e67 203d 2022 220a 2020 2020 666f 7220  ng = "".    for 
-00013cb0: 7065 7266 636f 6465 2069 6e20 7065 7266  perfcode in perf
-00013cc0: 696e 666f 3a0a 2020 2020 2020 2020 746f  info:.        to
-00013cd0: 7461 6c5f 7065 7266 5f74 696d 6520 2b3d  tal_perf_time +=
-00013ce0: 2070 6572 6669 6e66 6f5b 7065 7266 636f   perfinfo[perfco
-00013cf0: 6465 5d0a 2020 2020 2020 2020 7065 7266  de].        perf
-00013d00: 7374 7269 6e67 202b 3d20 6622 7b70 6572  string += f"{per
-00013d10: 6663 6f64 657d 3a20 7b70 6572 6669 6e66  fcode}: {perfinf
-00013d20: 6f5b 7065 7266 636f 6465 5d3a 2e32 667d  o[perfcode]:.2f}
-00013d30: 2c20 220a 2020 2020 7265 7475 726e 5f69  , ".    return_i
-00013d40: 6e66 6f5b 2274 6f74 616c 5f74 696d 6522  nfo["total_time"
-00013d50: 5d20 3d20 2864 6174 6574 696d 652e 6e6f  ] = (datetime.no
-00013d60: 7728 2920 2d20 7374 6172 745f 7469 6d65  w() - start_time
-00013d70: 292e 746f 7461 6c5f 7365 636f 6e64 7328  ).total_seconds(
-00013d80: 290a 2020 2020 7065 7266 696e 666f 5b22  ).    perfinfo["
-00013d90: 756e 6163 636f 756e 7465 6422 5d20 3d20  unaccounted"] = 
-00013da0: 280a 2020 2020 2020 2020 7265 7475 726e  (.        return
-00013db0: 5f69 6e66 6f5b 2274 6f74 616c 5f74 696d  _info["total_tim
-00013dc0: 6522 5d20 2d20 746f 7461 6c5f 7065 7266  e"] - total_perf
-00013dd0: 5f74 696d 6520 2023 2074 7970 653a 2069  _time  # type: i
-00013de0: 676e 6f72 655b 6f70 6572 6174 6f72 5d0a  gnore[operator].
-00013df0: 2020 2020 290a 2020 2020 7065 7266 7374      ).    perfst
-00013e00: 7269 6e67 202b 3d20 6622 756e 6163 636f  ring += f"unacco
-00013e10: 756e 7465 643a 207b 7065 7266 696e 666f  unted: {perfinfo
-00013e20: 5b27 756e 6163 636f 756e 7465 6427 5d3a  ['unaccounted']:
-00013e30: 2e32 667d 220a 0a20 2020 2023 2052 6574  .2f}"..    # Ret
-00013e40: 7572 6e0a 2020 2020 7265 7475 726e 5f69  urn.    return_i
-00013e50: 6e66 6f5b 2270 6572 6669 6e66 6f22 5d20  nfo["perfinfo"] 
-00013e60: 3d20 7065 7266 696e 666f 0a20 2020 2072  = perfinfo.    r
-00013e70: 6574 7572 6e5f 696e 666f 5b22 7065 7266  eturn_info["perf
-00013e80: 7374 7269 6e67 225d 203d 2070 6572 6673  string"] = perfs
-00013e90: 7472 696e 670a 2020 2020 7265 7475 726e  tring.    return
-00013ea0: 5f69 6e66 6f5b 226d 6573 7361 6765 225d  _info["message"]
-00013eb0: 203d 206d 6573 7361 6765 0a20 2020 2072   = message.    r
-00013ec0: 6574 7572 6e20 7265 7475 726e 5f69 6e66  eturn return_inf
-00013ed0: 6f0a 0a0a 6465 6620 5f64 6973 736f 6c76  o...def _dissolv
-00013ee0: 6528 0a20 2020 2064 663a 2067 7064 2e47  e(.    df: gpd.G
-00013ef0: 656f 4461 7461 4672 616d 652c 0a20 2020  eoDataFrame,.   
-00013f00: 2062 793d 4e6f 6e65 2c0a 2020 2020 6167   by=None,.    ag
-00013f10: 6766 756e 633a 204f 7074 696f 6e61 6c5b  gfunc: Optional[
-00013f20: 556e 696f 6e5b 7374 722c 2064 6963 745d  Union[str, dict]
-00013f30: 5d20 3d20 2266 6972 7374 222c 0a20 2020  ] = "first",.   
-00013f40: 2061 735f 696e 6465 783d 5472 7565 2c0a   as_index=True,.
-00013f50: 2020 2020 6c65 7665 6c3d 4e6f 6e65 2c0a      level=None,.
-00013f60: 2020 2020 736f 7274 3d54 7275 652c 0a20      sort=True,. 
-00013f70: 2020 206f 6273 6572 7665 643d 4661 6c73     observed=Fals
-00013f80: 652c 0a20 2020 2064 726f 706e 613d 5472  e,.    dropna=Tr
-00013f90: 7565 2c0a 2920 2d3e 2067 7064 2e47 656f  ue,.) -> gpd.Geo
-00013fa0: 4461 7461 4672 616d 653a 0a20 2020 2022  DataFrame:.    "
-00013fb0: 2222 0a20 2020 2044 6973 736f 6c76 6520  "".    Dissolve 
-00013fc0: 6765 6f6d 6574 7269 6573 2077 6974 6869  geometries withi
-00013fd0: 6e20 6067 726f 7570 6279 6020 696e 746f  n `groupby` into
-00013fe0: 2073 696e 676c 6520 6f62 7365 7276 6174   single observat
-00013ff0: 696f 6e2e 0a0a 2020 2020 5468 6973 2069  ion...    This i
-00014000: 7320 6163 636f 6d70 6c69 7368 6564 2062  s accomplished b
-00014010: 7920 6170 706c 7969 6e67 2074 6865 2060  y applying the `
-00014020: 756e 6172 795f 756e 696f 6e60 206d 6574  unary_union` met
-00014030: 686f 640a 2020 2020 746f 2061 6c6c 2067  hod.    to all g
-00014040: 656f 6d65 7472 6965 7320 7769 7468 696e  eometries within
-00014050: 2061 2067 726f 7570 7365 6c66 2e0a 2020   a groupself..  
-00014060: 2020 4f62 7365 7276 6174 696f 6e73 2061    Observations a
-00014070: 7373 6f63 6961 7465 6420 7769 7468 2065  ssociated with e
-00014080: 6163 6820 6067 726f 7570 6279 6020 6772  ach `groupby` gr
-00014090: 6f75 7020 7769 6c6c 2062 6520 6167 6772  oup will be aggr
-000140a0: 6567 6174 6564 0a20 2020 2075 7369 6e67  egated.    using
-000140b0: 2074 6865 2060 6167 6766 756e 6360 2e0a   the `aggfunc`..
-000140c0: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
-000140d0: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
-000140e0: 2020 6279 203a 2073 7472 696e 672c 2064    by : string, d
-000140f0: 6566 6175 6c74 204e 6f6e 650a 2020 2020  efault None.    
-00014100: 2020 2020 436f 6c75 6d6e 2077 686f 7365      Column whose
-00014110: 2076 616c 7565 7320 6465 6669 6e65 2067   values define g
-00014120: 726f 7570 7320 746f 2062 6520 6469 7373  roups to be diss
-00014130: 6f6c 7665 642e 2049 6620 4e6f 6e65 2c0a  olved. If None,.
-00014140: 2020 2020 2020 2020 7768 6f6c 6520 4765          whole Ge
-00014150: 6f44 6174 6146 7261 6d65 2069 7320 636f  oDataFrame is co
-00014160: 6e73 6964 6572 6564 2061 2073 696e 676c  nsidered a singl
-00014170: 6520 6772 6f75 702e 0a20 2020 2061 6767  e group..    agg
-00014180: 6675 6e63 203a 2066 756e 6374 696f 6e2c  func : function,
-00014190: 2073 7472 696e 6720 6f72 2064 6963 742c   string or dict,
-000141a0: 2064 6566 6175 6c74 2022 6669 7273 7422   default "first"
-000141b0: 0a20 2020 2020 2020 2041 6767 7265 6761  .        Aggrega
-000141c0: 7469 6f6e 2066 756e 6374 696f 6e20 666f  tion function fo
-000141d0: 7220 6d61 6e69 7075 6c61 7469 6f6e 206f  r manipulation o
-000141e0: 6620 6461 7461 2061 7373 6f63 6961 7465  f data associate
-000141f0: 640a 2020 2020 2020 2020 7769 7468 2065  d.        with e
-00014200: 6163 6820 6772 6f75 702e 2050 6173 7365  ach group. Passe
-00014210: 6420 746f 2070 616e 6461 7320 6067 726f  d to pandas `gro
-00014220: 7570 6279 2e61 6767 6020 6d65 7468 6f64  upby.agg` method
-00014230: 2e0a 2020 2020 6173 5f69 6e64 6578 203a  ..    as_index :
-00014240: 2062 6f6f 6c65 616e 2c20 6465 6661 756c   boolean, defaul
-00014250: 7420 5472 7565 0a20 2020 2020 2020 2049  t True.        I
-00014260: 6620 7472 7565 2c20 6772 6f75 7062 7920  f true, groupby 
-00014270: 636f 6c75 6d6e 7320 6265 636f 6d65 2069  columns become i
-00014280: 6e64 6578 206f 6620 7265 7375 6c74 2e0a  ndex of result..
-00014290: 2020 2020 6c65 7665 6c20 3a20 696e 7420      level : int 
-000142a0: 6f72 2073 7472 206f 7220 7365 7175 656e  or str or sequen
-000142b0: 6365 206f 6620 696e 7420 6f72 2073 6571  ce of int or seq
-000142c0: 7565 6e63 6520 6f66 2073 7472 2c20 6465  uence of str, de
-000142d0: 6661 756c 7420 4e6f 6e65 0a20 2020 2020  fault None.     
-000142e0: 2020 2049 6620 7468 6520 6178 6973 2069     If the axis i
-000142f0: 7320 6120 4d75 6c74 6949 6e64 6578 2028  s a MultiIndex (
-00014300: 6869 6572 6172 6368 6963 616c 292c 2067  hierarchical), g
-00014310: 726f 7570 2062 7920 610a 2020 2020 2020  roup by a.      
-00014320: 2020 7061 7274 6963 756c 6172 206c 6576    particular lev
-00014330: 656c 206f 7220 6c65 7665 6c73 2e0a 2020  el or levels..  
-00014340: 2020 2020 2020 2e2e 2076 6572 7369 6f6e        .. version
-00014350: 6164 6465 643a 3a20 302e 392e 300a 2020  added:: 0.9.0.  
-00014360: 2020 736f 7274 203a 2062 6f6f 6c2c 2064    sort : bool, d
-00014370: 6566 6175 6c74 2054 7275 650a 2020 2020  efault True.    
-00014380: 2020 2020 536f 7274 2067 726f 7570 206b      Sort group k
-00014390: 6579 732e 2047 6574 2062 6574 7465 7220  eys. Get better 
-000143a0: 7065 7266 6f72 6d61 6e63 6520 6279 2074  performance by t
-000143b0: 7572 6e69 6e67 2074 6869 7320 6f66 662e  urning this off.
-000143c0: 0a20 2020 2020 2020 204e 6f74 6520 7468  .        Note th
-000143d0: 6973 2064 6f65 7320 6e6f 7420 696e 666c  is does not infl
-000143e0: 7565 6e63 6520 7468 6520 6f72 6465 7220  uence the order 
-000143f0: 6f66 206f 6273 6572 7661 7469 6f6e 7320  of observations 
-00014400: 7769 7468 696e 0a20 2020 2020 2020 2065  within.        e
-00014410: 6163 6820 6772 6f75 702e 2047 726f 7570  ach group. Group
-00014420: 6279 2070 7265 7365 7276 6573 2074 6865  by preserves the
-00014430: 206f 7264 6572 206f 6620 726f 7773 2077   order of rows w
-00014440: 6974 6869 6e20 6561 6368 2067 726f 7570  ithin each group
-00014450: 2e0a 2020 2020 2020 2020 2e2e 2076 6572  ..        .. ver
-00014460: 7369 6f6e 6164 6465 643a 3a20 302e 392e  sionadded:: 0.9.
-00014470: 300a 2020 2020 6f62 7365 7276 6564 203a  0.    observed :
-00014480: 2062 6f6f 6c2c 2064 6566 6175 6c74 2046   bool, default F
-00014490: 616c 7365 0a20 2020 2020 2020 2054 6869  alse.        Thi
-000144a0: 7320 6f6e 6c79 2061 7070 6c69 6573 2069  s only applies i
-000144b0: 6620 616e 7920 6f66 2074 6865 2067 726f  f any of the gro
-000144c0: 7570 6572 7320 6172 6520 4361 7465 676f  upers are Catego
-000144d0: 7269 6361 6c73 2e0a 2020 2020 2020 2020  ricals..        
-000144e0: 4966 2054 7275 653a 206f 6e6c 7920 7368  If True: only sh
-000144f0: 6f77 206f 6273 6572 7665 6420 7661 6c75  ow observed valu
-00014500: 6573 2066 6f72 2063 6174 6567 6f72 6963  es for categoric
-00014510: 616c 2067 726f 7570 6572 732e 0a20 2020  al groupers..   
-00014520: 2020 2020 2049 6620 4661 6c73 653a 2073       If False: s
-00014530: 686f 7720 616c 6c20 7661 6c75 6573 2066  how all values f
-00014540: 6f72 2063 6174 6567 6f72 6963 616c 2067  or categorical g
-00014550: 726f 7570 6572 732e 0a20 2020 2020 2020  roupers..       
-00014560: 202e 2e20 7665 7273 696f 6e61 6464 6564   .. versionadded
-00014570: 3a3a 2030 2e39 2e30 0a20 2020 2064 726f  :: 0.9.0.    dro
-00014580: 706e 6120 3a20 626f 6f6c 2c20 6465 6661  pna : bool, defa
-00014590: 756c 7420 5472 7565 0a20 2020 2020 2020  ult True.       
-000145a0: 2049 6620 5472 7565 2c20 616e 6420 6966   If True, and if
-000145b0: 2067 726f 7570 206b 6579 7320 636f 6e74   group keys cont
-000145c0: 6169 6e20 4e41 2076 616c 7565 732c 204e  ain NA values, N
-000145d0: 4120 7661 6c75 6573 0a20 2020 2020 2020  A values.       
-000145e0: 2074 6f67 6574 6865 7220 7769 7468 2072   together with r
-000145f0: 6f77 2f63 6f6c 756d 6e20 7769 6c6c 2062  ow/column will b
-00014600: 6520 6472 6f70 7065 642e 2049 6620 4661  e dropped. If Fa
-00014610: 6c73 652c 204e 410a 2020 2020 2020 2020  lse, NA.        
-00014620: 7661 6c75 6573 2077 696c 6c20 616c 736f  values will also
-00014630: 2062 6520 7472 6561 7465 6420 6173 2074   be treated as t
-00014640: 6865 206b 6579 2069 6e20 6772 6f75 7073  he key in groups
-00014650: 2e0a 2020 2020 2020 2020 5468 6973 2070  ..        This p
-00014660: 6172 616d 6574 6572 2069 7320 6e6f 7420  arameter is not 
-00014670: 7375 7070 6f72 7465 6420 666f 7220 7061  supported for pa
-00014680: 6e64 6173 203c 2031 2e31 2e30 2e0a 2020  ndas < 1.1.0..  
-00014690: 2020 2020 2020 4120 7761 726e 696e 6720        A warning 
-000146a0: 7769 6c6c 2062 6520 656d 6974 7465 6420  will be emitted 
-000146b0: 666f 7220 6561 726c 6965 7220 7061 6e64  for earlier pand
-000146c0: 6173 2076 6572 7369 6f6e 730a 2020 2020  as versions.    
-000146d0: 2020 2020 6966 2061 206e 6f6e 2d64 6566      if a non-def
-000146e0: 6175 6c74 2076 616c 7565 2069 7320 6769  ault value is gi
-000146f0: 7665 6e20 666f 7220 7468 6973 2070 6172  ven for this par
-00014700: 616d 6574 6572 2e0a 2020 2020 2020 2020  ameter..        
-00014710: 2e2e 2076 6572 7369 6f6e 6164 6465 643a  .. versionadded:
-00014720: 3a20 302e 392e 300a 0a20 2020 2052 6574  : 0.9.0..    Ret
-00014730: 7572 6e73 3a0a 2020 2020 2d2d 2d2d 2d2d  urns:.    ------
-00014740: 2d0a 2020 2020 4765 6f44 6174 6146 7261  -.    GeoDataFra
-00014750: 6d65 0a0a 2020 2020 4578 616d 706c 6573  me..    Examples
-00014760: 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20  :.    --------. 
-00014770: 2020 203e 3e3e 2066 726f 6d20 7368 6170     >>> from shap
-00014780: 656c 792e 6765 6f6d 6574 7279 2069 6d70  ely.geometry imp
-00014790: 6f72 7420 506f 696e 740a 2020 2020 3e3e  ort Point.    >>
-000147a0: 3e20 6420 3d20 7b0a 2020 2020 2e2e 2e20  > d = {.    ... 
-000147b0: 2020 2020 2263 6f6c 3122 3a20 5b22 6e61      "col1": ["na
-000147c0: 6d65 3122 2c20 226e 616d 6532 222c 2022  me1", "name2", "
-000147d0: 6e61 6d65 3122 5d2c 0a20 2020 202e 2e2e  name1"],.    ...
-000147e0: 2020 2020 2022 6765 6f6d 6574 7279 223a       "geometry":
-000147f0: 205b 506f 696e 7428 312c 2032 292c 2050   [Point(1, 2), P
-00014800: 6f69 6e74 2832 2c20 3129 2c20 506f 696e  oint(2, 1), Poin
-00014810: 7428 302c 2031 295d 2c0a 2020 2020 2e2e  t(0, 1)],.    ..
-00014820: 2e20 7d0a 2020 2020 3e3e 3e20 6764 6620  . }.    >>> gdf 
-00014830: 3d20 6765 6f70 616e 6461 732e 4765 6f44  = geopandas.GeoD
-00014840: 6174 6146 7261 6d65 2864 2c20 6372 733d  ataFrame(d, crs=
-00014850: 3433 3236 290a 2020 2020 3e3e 3e20 6764  4326).    >>> gd
-00014860: 660a 2020 2020 2020 2020 636f 6c31 2020  f.        col1  
-00014870: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00014880: 656f 6d65 7472 790a 2020 2020 3020 206e  eometry.    0  n
-00014890: 616d 6531 2020 504f 494e 5420 2831 2e30  ame1  POINT (1.0
-000148a0: 3030 3030 2032 2e30 3030 3030 290a 2020  0000 2.00000).  
-000148b0: 2020 3120 206e 616d 6532 2020 504f 494e    1  name2  POIN
-000148c0: 5420 2832 2e30 3030 3030 2031 2e30 3030  T (2.00000 1.000
-000148d0: 3030 290a 2020 2020 3220 206e 616d 6531  00).    2  name1
-000148e0: 2020 504f 494e 5420 2830 2e30 3030 3030    POINT (0.00000
-000148f0: 2031 2e30 3030 3030 290a 2020 2020 3e3e   1.00000).    >>
-00014900: 3e20 6469 7373 6f6c 7665 6420 3d20 6764  > dissolved = gd
-00014910: 662e 6469 7373 6f6c 7665 2827 636f 6c31  f.dissolve('col1
-00014920: 2729 0a20 2020 203e 3e3e 2064 6973 736f  ').    >>> disso
-00014930: 6c76 6564 2020 2320 646f 6374 6573 743a  lved  # doctest:
-00014940: 202b 534b 4950 0a20 2020 2020 2020 2020   +SKIP.         
-00014950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014970: 2020 2020 2020 2067 656f 6d65 7472 790a         geometry.
-00014980: 2020 2020 636f 6c31 0a20 2020 206e 616d      col1.    nam
-00014990: 6531 2020 4d55 4c54 4950 4f49 4e54 2028  e1  MULTIPOINT (
-000149a0: 302e 3030 3030 3020 312e 3030 3030 302c  0.00000 1.00000,
-000149b0: 2031 2e30 3030 3030 2032 2e30 3030 3030   1.00000 2.00000
-000149c0: 290a 2020 2020 6e61 6d65 3220 2020 2020  ).    name2     
-000149d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000149e0: 2020 2050 4f49 4e54 2028 322e 3030 3030     POINT (2.0000
-000149f0: 3020 312e 3030 3030 3029 0a0a 2020 2020  0 1.00000)..    
-00014a00: 5365 6520 416c 736f 3a0a 2020 2020 2d2d  See Also:.    --
-00014a10: 2d2d 2d2d 2d2d 0a20 2020 2047 656f 4461  ------.    GeoDa
-00014a20: 7461 4672 616d 652e 6578 706c 6f64 6520  taFrame.explode 
-00014a30: 3a20 6578 706c 6f64 6520 6d75 6c74 692d  : explode multi-
-00014a40: 7061 7274 2067 656f 6d65 7472 6965 7320  part geometries 
-00014a50: 696e 746f 2073 696e 676c 6520 6765 6f6d  into single geom
-00014a60: 6574 7269 6573 0a20 2020 2022 2222 0a20  etries.    """. 
-00014a70: 2020 2069 6620 6279 2069 7320 4e6f 6e65     if by is None
-00014a80: 2061 6e64 206c 6576 656c 2069 7320 4e6f   and level is No
-00014a90: 6e65 3a0a 2020 2020 2020 2020 6279 5f6c  ne:.        by_l
-00014aa0: 6f63 616c 203d 206e 702e 7a65 726f 7328  ocal = np.zeros(
-00014ab0: 6c65 6e28 6466 292c 2064 7479 7065 3d22  len(df), dtype="
-00014ac0: 696e 7436 3422 290a 2020 2020 656c 7365  int64").    else
-00014ad0: 3a0a 2020 2020 2020 2020 6279 5f6c 6f63  :.        by_loc
-00014ae0: 616c 203d 2062 790a 0a20 2020 2067 726f  al = by..    gro
-00014af0: 7570 6279 5f6b 7761 7267 7320 3d20 7b0a  upby_kwargs = {.
-00014b00: 2020 2020 2020 2020 2262 7922 3a20 6279          "by": by
-00014b10: 5f6c 6f63 616c 2c0a 2020 2020 2020 2020  _local,.        
-00014b20: 226c 6576 656c 223a 206c 6576 656c 2c0a  "level": level,.
-00014b30: 2020 2020 2020 2020 2273 6f72 7422 3a20          "sort": 
-00014b40: 736f 7274 2c0a 2020 2020 2020 2020 226f  sort,.        "o
-00014b50: 6273 6572 7665 6422 3a20 6f62 7365 7276  bserved": observ
-00014b60: 6564 2c0a 2020 2020 2020 2020 2264 726f  ed,.        "dro
-00014b70: 706e 6122 3a20 6472 6f70 6e61 2c0a 2020  pna": dropna,.  
-00014b80: 2020 7d0a 2020 2020 2222 220a 2020 2020    }.    """.    
-00014b90: 6966 206e 6f74 2063 6f6d 7061 742e 5041  if not compat.PA
-00014ba0: 4e44 4153 5f47 455f 3131 3a0a 2020 2020  NDAS_GE_11:.    
-00014bb0: 2020 2020 6772 6f75 7062 795f 6b77 6172      groupby_kwar
-00014bc0: 6773 2e70 6f70 2822 6472 6f70 6e61 2229  gs.pop("dropna")
-00014bd0: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
-00014be0: 2064 726f 706e 613a 2020 2320 4966 2074   dropna:  # If t
-00014bf0: 6865 7920 7061 7373 6564 2061 206e 6f6e  hey passed a non
-00014c00: 2d64 6566 6175 6c74 2064 726f 706e 6120  -default dropna 
-00014c10: 7661 6c75 650a 2020 2020 2020 2020 2020  value.          
-00014c20: 2020 7761 726e 696e 6773 2e77 6172 6e28    warnings.warn(
-00014c30: 2264 726f 706e 6120 6b77 6172 6720 6973  "dropna kwarg is
-00014c40: 206e 6f74 2073 7570 706f 7274 6564 2066   not supported f
-00014c50: 6f72 2070 616e 6461 7320 3c20 312e 312e  or pandas < 1.1.
-00014c60: 3022 290a 2020 2020 2222 220a 0a20 2020  0").    """..   
-00014c70: 2023 2050 726f 6365 7373 206e 6f6e 2d73   # Process non-s
-00014c80: 7061 7469 616c 2063 6f6d 706f 6e65 6e74  patial component
-00014c90: 0a20 2020 2064 6174 6120 3d20 7064 2e44  .    data = pd.D
-00014ca0: 6174 6146 7261 6d65 2864 662e 6472 6f70  ataFrame(df.drop
-00014cb0: 2863 6f6c 756d 6e73 3d64 662e 6765 6f6d  (columns=df.geom
-00014cc0: 6574 7279 2e6e 616d 6529 290a 0a20 2020  etry.name))..   
-00014cd0: 2069 6620 6167 6766 756e 6320 6973 206e   if aggfunc is n
-00014ce0: 6f74 204e 6f6e 6520 616e 6420 6973 696e  ot None and isin
-00014cf0: 7374 616e 6365 2861 6767 6675 6e63 2c20  stance(aggfunc, 
-00014d00: 6469 6374 2920 616e 6420 2274 6f5f 6a73  dict) and "to_js
-00014d10: 6f6e 2220 696e 2061 6767 6675 6e63 3a0a  on" in aggfunc:.
-00014d20: 2020 2020 2020 2020 6167 675f 636f 6c75          agg_colu
-00014d30: 6d6e 7320 3d20 6c69 7374 2873 6574 2861  mns = list(set(a
-00014d40: 6767 6675 6e63 5b22 746f 5f6a 736f 6e22  ggfunc["to_json"
-00014d50: 5d29 290a 2020 2020 2020 2020 6167 675f  ])).        agg_
-00014d60: 6461 7461 203d 2028 0a20 2020 2020 2020  data = (.       
-00014d70: 2020 2020 2064 6174 612e 6772 6f75 7062       data.groupb
-00014d80: 7928 2a2a 6772 6f75 7062 795f 6b77 6172  y(**groupby_kwar
-00014d90: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
-00014da0: 2e61 7070 6c79 286c 616d 6264 6120 673a  .apply(lambda g:
-00014db0: 2067 5b61 6767 5f63 6f6c 756d 6e73 5d2e   g[agg_columns].
-00014dc0: 746f 5f6a 736f 6e28 6f72 6965 6e74 3d22  to_json(orient="
-00014dd0: 7265 636f 7264 7322 2929 0a20 2020 2020  records")).     
-00014de0: 2020 2020 2020 202e 746f 5f66 7261 6d65         .to_frame
-00014df0: 286e 616d 653d 225f 5f44 4953 534f 4c56  (name="__DISSOLV
-00014e00: 455f 544f 4a53 4f4e 2229 0a20 2020 2020  E_TOJSON").     
-00014e10: 2020 2029 0a20 2020 2065 6c69 6620 6973     ).    elif is
-00014e20: 696e 7374 616e 6365 2861 6767 6675 6e63  instance(aggfunc
-00014e30: 2c20 7374 7229 2061 6e64 2061 6767 6675  , str) and aggfu
-00014e40: 6e63 203d 3d20 226d 6572 6765 5f6a 736f  nc == "merge_jso
-00014e50: 6e5f 6c69 7374 7322 3a0a 2020 2020 2020  n_lists":.      
-00014e60: 2020 2320 4d65 7267 6520 616e 6420 666c    # Merge and fl
-00014e70: 6174 7465 6e20 7468 6520 6a73 6f6e 206c  atten the json l
-00014e80: 6973 7473 2069 6e20 7468 6520 6772 6f75  ists in the grou
-00014e90: 7073 0a20 2020 2020 2020 2064 6566 2067  ps.        def g
-00014ea0: 726f 7570 5f66 6c61 7474 656e 5f6a 736f  roup_flatten_jso
-00014eb0: 6e5f 6c69 7374 2867 293a 0a20 2020 2020  n_list(g):.     
-00014ec0: 2020 2020 2020 2023 2045 7661 6c75 6174         # Evaluat
-00014ed0: 6520 616c 6c20 6772 6f75 7065 6420 726f  e all grouped ro
-00014ee0: 7773 2074 6f20 6a73 6f6e 206f 626a 6563  ws to json objec
-00014ef0: 7473 2e20 5468 6973 2072 6573 756c 7473  ts. This results
-00014f00: 2069 6e20 6120 6c69 7374 206f 660a 2020   in a list of.  
-00014f10: 2020 2020 2020 2020 2020 2320 6c69 7374            # list
-00014f20: 7320 6f66 206a 736f 6e20 6f62 6a65 6374  s of json object
-00014f30: 732e 0a20 2020 2020 2020 2020 2020 206a  s..            j
-00014f40: 736f 6e5f 6e65 7374 6564 5f6c 6973 7473  son_nested_lists
-00014f50: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
-00014f60: 2020 2020 206a 736f 6e2e 6c6f 6164 7328       json.loads(
-00014f70: 6a73 6f6e 5f76 616c 7565 7329 2066 6f72  json_values) for
-00014f80: 206a 736f 6e5f 7661 6c75 6573 2069 6e20   json_values in 
-00014f90: 675b 225f 5f44 4953 534f 4c56 455f 544f  g["__DISSOLVE_TO
-00014fa0: 4a53 4f4e 225d 0a20 2020 2020 2020 2020  JSON"].         
-00014fb0: 2020 205d 0a0a 2020 2020 2020 2020 2020     ]..          
-00014fc0: 2020 2320 4578 7472 6163 7420 7468 6520    # Extract the 
-00014fd0: 726f 7773 2066 726f 6d20 7468 6520 6e65  rows from the ne
-00014fe0: 7374 6564 206c 6973 7473 202b 2070 7574  sted lists + put
-00014ff0: 2069 6e20 6120 666c 6174 206c 6973 7420   in a flat list 
-00015000: 6173 2073 7472 696e 6773 0a20 2020 2020  as strings.     
-00015010: 2020 2020 2020 206a 736f 6e73 7472 5f66         jsonstr_f
-00015020: 6c61 7420 3d20 5b0a 2020 2020 2020 2020  lat = [.        
-00015030: 2020 2020 2020 2020 6a73 6f6e 2e64 756d          json.dum
-00015040: 7073 286a 736f 6e5f 7661 6c75 6529 0a20  ps(json_value). 
-00015050: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00015060: 6f72 206a 736f 6e5f 7661 6c75 6573 2069  or json_values i
-00015070: 6e20 6a73 6f6e 5f6e 6573 7465 645f 6c69  n json_nested_li
-00015080: 7374 730a 2020 2020 2020 2020 2020 2020  sts.            
-00015090: 2020 2020 666f 7220 6a73 6f6e 5f76 616c      for json_val
-000150a0: 7565 2069 6e20 6a73 6f6e 5f76 616c 7565  ue in json_value
-000150b0: 730a 2020 2020 2020 2020 2020 2020 5d0a  s.            ].
-000150c0: 0a20 2020 2020 2020 2020 2020 2023 2052  .            # R
-000150d0: 656d 6f76 6520 6475 706c 6963 6174 6573  emove duplicates
-000150e0: 0a20 2020 2020 2020 2020 2020 206a 736f  .            jso
-000150f0: 6e73 7374 725f 6469 7374 696e 6374 203d  nsstr_distinct =
-00015100: 2073 6574 286a 736f 6e73 7472 5f66 6c61   set(jsonstr_fla
-00015110: 7429 0a0a 2020 2020 2020 2020 2020 2020  t)..            
-00015120: 2320 436f 6e76 6572 7420 7468 6520 6461  # Convert the da
-00015130: 7461 2061 6761 696e 2074 6f20 6120 6c69  ta again to a li
-00015140: 7374 206f 6620 6a73 6f6e 206f 626a 6563  st of json objec
-00015150: 7473 0a20 2020 2020 2020 2020 2020 206a  ts.            j
-00015160: 736f 6e5f 6469 7374 696e 6374 203d 205b  son_distinct = [
-00015170: 6a73 6f6e 2e6c 6f61 6473 286a 736f 6e5f  json.loads(json_
-00015180: 7661 6c75 6529 2066 6f72 206a 736f 6e5f  value) for json_
-00015190: 7661 6c75 6520 696e 206a 736f 6e73 7374  value in jsonsst
-000151a0: 725f 6469 7374 696e 6374 5d0a 0a20 2020  r_distinct]..   
-000151b0: 2020 2020 2020 2020 2023 2052 6574 7572           # Retur
-000151c0: 6e20 6173 206a 736f 6e20 7374 7269 6e67  n as json string
-000151d0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-000151e0: 7572 6e20 6a73 6f6e 2e64 756d 7073 286a  urn json.dumps(j
-000151f0: 736f 6e5f 6469 7374 696e 6374 290a 0a20  son_distinct).. 
-00015200: 2020 2020 2020 2061 6767 5f64 6174 6120         agg_data 
-00015210: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
-00015220: 6461 7461 2e67 726f 7570 6279 282a 2a67  data.groupby(**g
-00015230: 726f 7570 6279 5f6b 7761 7267 7329 0a20  roupby_kwargs). 
-00015240: 2020 2020 2020 2020 2020 202e 6170 706c             .appl
-00015250: 7928 6c61 6d62 6461 2067 3a20 6772 6f75  y(lambda g: grou
-00015260: 705f 666c 6174 7465 6e5f 6a73 6f6e 5f6c  p_flatten_json_l
-00015270: 6973 7428 6729 290a 2020 2020 2020 2020  ist(g)).        
-00015280: 2020 2020 2e74 6f5f 6672 616d 6528 6e61      .to_frame(na
-00015290: 6d65 3d22 5f5f 4449 5353 4f4c 5645 5f54  me="__DISSOLVE_T
-000152a0: 4f4a 534f 4e22 290a 2020 2020 2020 2020  OJSON").        
-000152b0: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
-000152c0: 2020 2020 6167 675f 6461 7461 203d 2064      agg_data = d
-000152d0: 6174 612e 6772 6f75 7062 7928 2a2a 6772  ata.groupby(**gr
-000152e0: 6f75 7062 795f 6b77 6172 6773 292e 6167  oupby_kwargs).ag
-000152f0: 6728 6167 6766 756e 6329 2020 2320 7479  g(aggfunc)  # ty
-00015300: 7065 3a20 6967 6e6f 7265 5b61 7267 2d74  pe: ignore[arg-t
-00015310: 7970 655d 0a20 2020 2020 2020 2023 2043  ype].        # C
-00015320: 6865 636b 2069 6620 616c 6c20 636f 6c75  heck if all colu
-00015330: 6d6e 7320 7765 7265 2070 726f 7065 726c  mns were properl
-00015340: 7920 6167 6772 6567 6174 6564 0a20 2020  y aggregated.   
-00015350: 2020 2020 2061 7373 6572 7420 6279 5f6c       assert by_l
-00015360: 6f63 616c 2069 7320 6e6f 7420 4e6f 6e65  ocal is not None
-00015370: 0a20 2020 2020 2020 2063 6f6c 756d 6e73  .        columns
-00015380: 5f74 6f5f 6167 6720 3d20 5b63 6f6c 756d  _to_agg = [colum
-00015390: 6e20 666f 7220 636f 6c75 6d6e 2069 6e20  n for column in 
-000153a0: 6461 7461 2e63 6f6c 756d 6e73 2069 6620  data.columns if 
-000153b0: 636f 6c75 6d6e 206e 6f74 2069 6e20 6279  column not in by
-000153c0: 5f6c 6f63 616c 5d0a 2020 2020 2020 2020  _local].        
-000153d0: 6966 206c 656e 2863 6f6c 756d 6e73 5f74  if len(columns_t
-000153e0: 6f5f 6167 6729 2021 3d20 6c65 6e28 6167  o_agg) != len(ag
-000153f0: 675f 6461 7461 2e63 6f6c 756d 6e73 293a  g_data.columns):
-00015400: 0a20 2020 2020 2020 2020 2020 2064 726f  .            dro
-00015410: 7070 6564 5f63 6f6c 756d 6e73 203d 205b  pped_columns = [
-00015420: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015430: 2063 6f6c 756d 6e20 666f 7220 636f 6c75   column for colu
-00015440: 6d6e 2069 6e20 636f 6c75 6d6e 735f 746f  mn in columns_to
-00015450: 5f61 6767 2069 6620 636f 6c75 6d6e 206e  _agg if column n
-00015460: 6f74 2069 6e20 6167 675f 6461 7461 2e63  ot in agg_data.c
-00015470: 6f6c 756d 6e73 0a20 2020 2020 2020 2020  olumns.         
-00015480: 2020 205d 0a20 2020 2020 2020 2020 2020     ].           
-00015490: 2072 6169 7365 2045 7863 6570 7469 6f6e   raise Exception
-000154a0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000154b0: 2020 6622 436f 6c75 6d6e 2873 2920 7b64    f"Column(s) {d
-000154c0: 726f 7070 6564 5f63 6f6c 756d 6e73 7d20  ropped_columns} 
-000154d0: 6172 6520 6e6f 7420 7375 7070 6f72 7465  are not supporte
-000154e0: 6420 666f 7220 6167 6772 6567 6174 696f  d for aggregatio
-000154f0: 6e2c 2073 746f 7022 0a20 2020 2020 2020  n, stop".       
-00015500: 2020 2020 2029 0a0a 2020 2020 2320 5072       )..    # Pr
-00015510: 6f63 6573 7320 7370 6174 6961 6c20 636f  ocess spatial co
-00015520: 6d70 6f6e 656e 740a 2020 2020 6465 6620  mponent.    def 
-00015530: 6d65 7267 655f 6765 6f6d 6574 7269 6573  merge_geometries
-00015540: 2862 6c6f 636b 293a 0a20 2020 2020 2020  (block):.       
-00015550: 206d 6572 6765 645f 6765 6f6d 203d 2062   merged_geom = b
-00015560: 6c6f 636b 2e75 6e61 7279 5f75 6e69 6f6e  lock.unary_union
-00015570: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00015580: 6d65 7267 6564 5f67 656f 6d0a 0a20 2020  merged_geom..   
-00015590: 2067 203d 2064 662e 6772 6f75 7062 7928   g = df.groupby(
-000155a0: 6772 6f75 705f 6b65 7973 3d46 616c 7365  group_keys=False
-000155b0: 2c20 2a2a 6772 6f75 7062 795f 6b77 6172  , **groupby_kwar
-000155c0: 6773 295b 6466 2e67 656f 6d65 7472 792e  gs)[df.geometry.
-000155d0: 6e61 6d65 5d2e 6167 6728 0a20 2020 2020  name].agg(.     
-000155e0: 2020 206d 6572 6765 5f67 656f 6d65 7472     merge_geometr
-000155f0: 6965 730a 2020 2020 290a 0a20 2020 2023  ies.    )..    #
-00015600: 2041 6767 7265 6761 7465 0a20 2020 2061   Aggregate.    a
-00015610: 6767 7265 6761 7465 645f 6765 6f6d 6574  ggregated_geomet
-00015620: 7279 203d 2067 7064 2e47 656f 4461 7461  ry = gpd.GeoData
-00015630: 4672 616d 6528 0a20 2020 2020 2020 2064  Frame(.        d
-00015640: 6174 613d 672c 2067 656f 6d65 7472 793d  ata=g, geometry=
-00015650: 6466 2e67 656f 6d65 7472 792e 6e61 6d65  df.geometry.name
-00015660: 2c20 6372 733d 6466 2e63 7273 0a20 2020  , crs=df.crs.   
-00015670: 2029 0a20 2020 2023 2052 6563 6f6d 6269   ).    # Recombi
-00015680: 6e65 0a20 2020 2061 6767 7265 6761 7465  ne.    aggregate
-00015690: 6420 3d20 6167 6772 6567 6174 6564 5f67  d = aggregated_g
-000156a0: 656f 6d65 7472 792e 6a6f 696e 2861 6767  eometry.join(agg
-000156b0: 5f64 6174 6129 0a0a 2020 2020 2320 5265  _data)..    # Re
-000156c0: 7365 7420 6966 2072 6571 7565 7374 6564  set if requested
-000156d0: 0a20 2020 2069 6620 6e6f 7420 6173 5f69  .    if not as_i
-000156e0: 6e64 6578 3a0a 2020 2020 2020 2020 6167  ndex:.        ag
-000156f0: 6772 6567 6174 6564 203d 2061 6767 7265  gregated = aggre
-00015700: 6761 7465 642e 7265 7365 745f 696e 6465  gated.reset_inde
-00015710: 7828 290a 0a20 2020 2023 204d 616b 6520  x()..    # Make 
-00015720: 7375 7265 206f 7574 7075 7420 7479 7065  sure output type
-00015730: 7320 6f66 2067 726f 7570 6564 2063 6f6c  s of grouped col
-00015740: 756d 6e73 2061 7265 2074 6865 2073 616d  umns are the sam
-00015750: 6520 6173 2069 6e70 7574 2074 7970 6573  e as input types
-00015760: 2e0a 2020 2020 2320 452e 672e 206f 626a  ..    # E.g. obj
-00015770: 6563 7420 636f 6c75 6d6e 7320 6265 636f  ect columns beco
-00015780: 6d65 2066 6c6f 6174 2069 6620 616c 6c20  me float if all 
-00015790: 7661 6c75 6573 2061 7265 204e 6f6e 652e  values are None.
-000157a0: 0a20 2020 2069 6620 6279 2069 7320 6e6f  .    if by is no
-000157b0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-000157c0: 6966 2069 7369 6e73 7461 6e63 6528 6279  if isinstance(by
-000157d0: 2c20 7374 7229 3a0a 2020 2020 2020 2020  , str):.        
-000157e0: 2020 2020 6966 2062 7920 696e 2061 6767      if by in agg
-000157f0: 7265 6761 7465 642e 636f 6c75 6d6e 7320  regated.columns 
-00015800: 616e 6420 6466 5b62 795d 2e64 7479 7065  and df[by].dtype
-00015810: 2021 3d20 6167 6772 6567 6174 6564 5b62   != aggregated[b
-00015820: 795d 2e64 7479 7065 3a0a 2020 2020 2020  y].dtype:.      
-00015830: 2020 2020 2020 2020 2020 6167 6772 6567            aggreg
-00015840: 6174 6564 5b62 795d 203d 2061 6767 7265  ated[by] = aggre
-00015850: 6761 7465 645b 6279 5d2e 6173 7479 7065  gated[by].astype
-00015860: 2864 665b 6279 5d2e 6474 7970 6529 0a20  (df[by].dtype). 
-00015870: 2020 2020 2020 2065 6c69 6620 6973 696e         elif isin
-00015880: 7374 616e 6365 2862 792c 2049 7465 7261  stance(by, Itera
-00015890: 626c 6529 3a0a 2020 2020 2020 2020 2020  ble):.          
-000158a0: 2020 666f 7220 636f 6c20 696e 2062 793a    for col in by:
-000158b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000158c0: 2069 6620 636f 6c20 696e 2061 6767 7265   if col in aggre
-000158d0: 6761 7465 642e 636f 6c75 6d6e 7320 616e  gated.columns an
-000158e0: 6420 6466 5b63 6f6c 5d2e 6474 7970 6520  d df[col].dtype 
-000158f0: 213d 2061 6767 7265 6761 7465 645b 636f  != aggregated[co
-00015900: 6c5d 2e64 7479 7065 3a0a 2020 2020 2020  l].dtype:.      
-00015910: 2020 2020 2020 2020 2020 2020 2020 6167                ag
-00015920: 6772 6567 6174 6564 5b63 6f6c 5d20 3d20  gregated[col] = 
-00015930: 6167 6772 6567 6174 6564 5b63 6f6c 5d2e  aggregated[col].
-00015940: 6173 7479 7065 2864 665b 636f 6c5d 2e64  astype(df[col].d
-00015950: 7479 7065 290a 0a20 2020 2061 7373 6572  type)..    asser
-00015960: 7420 6973 696e 7374 616e 6365 2861 6767  t isinstance(agg
-00015970: 7265 6761 7465 642c 2067 7064 2e47 656f  regated, gpd.Geo
-00015980: 4461 7461 4672 616d 6529 0a20 2020 2072  DataFrame).    r
-00015990: 6574 7572 6e20 6167 6772 6567 6174 6564  eturn aggregated
-000159a0: 0a0a 0a64 6566 205f 6164 645f 6f72 6465  ...def _add_orde
-000159b0: 7262 795f 636f 6c75 6d6e 2870 6174 683a  rby_column(path:
-000159c0: 2050 6174 682c 206c 6179 6572 3a20 7374   Path, layer: st
-000159d0: 722c 206e 616d 653a 2073 7472 293a 0a20  r, name: str):. 
-000159e0: 2020 2023 2050 7265 7061 7265 2074 6865     # Prepare the
-000159f0: 2065 7870 7265 7373 696f 6e20 746f 2063   expression to c
-00015a00: 616c 6375 6c61 7465 2074 6865 206f 7264  alculate the ord
-00015a10: 6572 6279 2063 6f6c 756d 6e2e 0a20 2020  erby column..   
-00015a20: 2023 2049 6e20 6120 7370 6174 6961 6c20   # In a spatial 
-00015a30: 6669 6c65 2c20 6120 7370 6174 6961 6c20  file, a spatial 
-00015a40: 6f72 6465 7220 7769 6c6c 206d 616b 6520  order will make 
-00015a50: 6c61 7465 7220 7573 6520 6d6f 7265 2065  later use more e
-00015a60: 6666 6963 69c3 ab6e 742c 0a20 2020 2023  ffici..nt,.    #
-00015a70: 2073 6f20 7573 6520 6120 6765 6f68 6173   so use a geohas
-00015a80: 682e 0a20 2020 206c 6179 6572 696e 666f  h..    layerinfo
-00015a90: 203d 2067 666f 2e67 6574 5f6c 6179 6572   = gfo.get_layer
-00015aa0: 696e 666f 2870 6174 6829 0a20 2020 2069  info(path).    i
-00015ab0: 6620 6c61 7965 7269 6e66 6f2e 6372 7320  f layerinfo.crs 
-00015ac0: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
-00015ad0: 6c61 7965 7269 6e66 6f2e 6372 732e 6973  layerinfo.crs.is
-00015ae0: 5f67 656f 6772 6170 6869 633a 0a20 2020  _geographic:.   
-00015af0: 2020 2020 2023 2049 6620 7468 6520 636f       # If the co
-00015b00: 6f72 6469 6e61 7465 7320 6172 6520 6765  ordinates are ge
-00015b10: 6f67 7261 7068 6963 2028 696e 206c 6174  ographic (in lat
-00015b20: 2f6c 6f6e 2064 6567 7265 6573 292c 206f  /lon degrees), o
-00015b30: 6b0a 2020 2020 2020 2020 6578 7072 6573  k.        expres
-00015b40: 7369 6f6e 203d 2066 2253 545f 4765 6f48  sion = f"ST_GeoH
-00015b50: 6173 6828 7b6c 6179 6572 696e 666f 2e67  ash({layerinfo.g
-00015b60: 656f 6d65 7472 7963 6f6c 756d 6e7d 2c20  eometrycolumn}, 
-00015b70: 3130 2922 0a20 2020 2065 6c73 653a 0a20  10)".    else:. 
-00015b80: 2020 2020 2020 2023 2049 6620 7468 6579         # If they
-00015b90: 2061 7265 206e 6f74 2067 656f 6772 6170   are not geograp
-00015ba0: 6869 6320 2869 6e20 6c61 742f 6c6f 6e20  hic (in lat/lon 
-00015bb0: 6465 6772 6565 7329 2c20 7468 6579 206e  degrees), they n
-00015bc0: 6565 6420 746f 2062 650a 2020 2020 2020  eed to be.      
-00015bd0: 2020 2320 636f 6e76 6572 7465 6420 746f    # converted to
-00015be0: 207e 2064 6567 7265 6573 2074 6f20 6265   ~ degrees to be
-00015bf0: 2061 626c 6520 746f 2063 616c 6375 6c61   able to calcula
-00015c00: 7465 2061 2067 656f 6861 7368 2e0a 0a20  te a geohash... 
-00015c10: 2020 2020 2020 2023 2050 726f 7065 726c         # Properl
-00015c20: 7920 6361 6c63 756c 6174 696e 6720 7468  y calculating th
-00015c30: 6520 7472 616e 7366 6f72 6d61 7469 6f6e  e transformation
-00015c40: 2074 6f20 6567 2e20 5747 5320 6973 2074   to eg. WGS is t
-00015c50: 6572 7269 626c 7920 736c 6f77 2e2e 2e0a  erribly slow....
-00015c60: 2020 2020 2020 2020 2320 6578 7072 6573          # expres
-00015c70: 7369 6f6e 203d 2066 2222 2253 545f 4765  sion = f"""ST_Ge
-00015c80: 6f48 6173 6828 5354 5f54 7261 6e73 666f  oHash(ST_Transfo
-00015c90: 726d 284d 616b 6550 6f69 6e74 280a 2020  rm(MakePoint(.  
-00015ca0: 2020 2020 2020 2320 2020 2020 2020 284d        #       (M
-00015cb0: 6272 4d61 7858 2867 656f 6d29 2b4d 6272  brMaxX(geom)+Mbr
-00015cc0: 4d69 6e58 2867 656f 6d29 292f 322c 0a20  MinX(geom))/2,. 
-00015cd0: 2020 2020 2020 2023 2020 2020 2020 2028         #       (
-00015ce0: 4d62 724d 696e 5928 6765 6f6d 292b 4d62  MbrMinY(geom)+Mb
-00015cf0: 724d 6178 5928 6765 6f6d 2929 2f32 2c20  rMaxY(geom))/2, 
-00015d00: 5354 5f53 5249 4428 6765 6f6d 2929 2c20  ST_SRID(geom)), 
-00015d10: 3433 3236 292c 2031 3029 2222 220a 2020  4326), 10)""".  
-00015d20: 2020 2020 2020 2320 536f 2c20 646f 2073        # So, do s
-00015d30: 6f6d 6574 6869 6e67 2065 6c73 6520 7468  omething else th
-00015d40: 6174 2773 2066 6173 7465 7220 616e 6420  at's faster and 
-00015d50: 7374 696c 6c20 6769 7665 7320 6120 676f  still gives a go
-00015d60: 6f64 0a20 2020 2020 2020 2023 2067 656f  od.        # geo
-00015d70: 6772 6170 6869 6320 636c 7573 7465 7269  graphic clusteri
-00015d80: 6e67 2e0a 2020 2020 2020 2020 746f 5f67  ng..        to_g
-00015d90: 656f 6772 6170 6869 635f 6661 6374 6f72  eographic_factor
-00015da0: 5f61 7070 726f 7820 3d20 3930 202f 206d  _approx = 90 / m
-00015db0: 6178 286c 6179 6572 696e 666f 2e74 6f74  ax(layerinfo.tot
-00015dc0: 616c 5f62 6f75 6e64 7329 0a20 2020 2020  al_bounds).     
-00015dd0: 2020 2065 7870 7265 7373 696f 6e20 3d20     expression = 
-00015de0: 6622 2222 5354 5f47 656f 4861 7368 284d  f"""ST_GeoHash(M
-00015df0: 616b 6550 6f69 6e74 280a 2020 2020 2020  akePoint(.      
-00015e00: 2020 2020 2020 2020 2020 2828 4d62 724d            ((MbrM
-00015e10: 6178 5828 7b6c 6179 6572 696e 666f 2e67  axX({layerinfo.g
-00015e20: 656f 6d65 7472 7963 6f6c 756d 6e7d 290a  eometrycolumn}).
-00015e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015e40: 2020 2b4d 6272 4d69 6e58 287b 6c61 7965    +MbrMinX({laye
-00015e50: 7269 6e66 6f2e 6765 6f6d 6574 7279 636f  rinfo.geometryco
-00015e60: 6c75 6d6e 7d29 292f 320a 2020 2020 2020  lumn}))/2.      
-00015e70: 2020 2020 2020 2020 2020 292a 7b74 6f5f            )*{to_
-00015e80: 6765 6f67 7261 7068 6963 5f66 6163 746f  geographic_facto
-00015e90: 725f 6170 7072 6f78 7d2c 0a20 2020 2020  r_approx},.     
-00015ea0: 2020 2020 2020 2020 2020 2028 284d 6272             ((Mbr
-00015eb0: 4d69 6e59 287b 6c61 7965 7269 6e66 6f2e  MinY({layerinfo.
-00015ec0: 6765 6f6d 6574 7279 636f 6c75 6d6e 7d29  geometrycolumn})
-00015ed0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015ee0: 2020 202b 4d62 724d 6178 5928 7b6c 6179     +MbrMaxY({lay
-00015ef0: 6572 696e 666f 2e67 656f 6d65 7472 7963  erinfo.geometryc
-00015f00: 6f6c 756d 6e7d 2929 2f32 0a20 2020 2020  olumn}))/2.     
-00015f10: 2020 2020 2020 2020 2020 2029 2a7b 746f             )*{to
-00015f20: 5f67 656f 6772 6170 6869 635f 6661 6374  _geographic_fact
-00015f30: 6f72 5f61 7070 726f 787d 2c20 3433 3236  or_approx}, 4326
-00015f40: 292c 2031 3029 2222 220a 0a20 2020 2023  ), 10)"""..    #
-00015f50: 204e 6f77 2077 6520 6361 6e20 6163 7475   Now we can actu
-00015f60: 616c 6c79 2061 6464 2074 6865 2063 6f6c  ally add the col
-00015f70: 756d 6e2e 0a20 2020 2067 666f 2e61 6464  umn..    gfo.add
-00015f80: 5f63 6f6c 756d 6e28 7061 7468 3d70 6174  _column(path=pat
-00015f90: 682c 206e 616d 653d 6e61 6d65 2c20 7479  h, name=name, ty
-00015fa0: 7065 3d67 666f 2e44 6174 6154 7970 652e  pe=gfo.DataType.
-00015fb0: 5445 5854 2c20 6578 7072 6573 7369 6f6e  TEXT, expression
-00015fc0: 3d65 7870 7265 7373 696f 6e29 0a20 2020  =expression).   
-00015fd0: 2073 716c 6974 655f 7374 6d74 203d 2066   sqlite_stmt = f
-00015fe0: 2743 5245 4154 4520 494e 4445 5820 7b6e  'CREATE INDEX {n
-00015ff0: 616d 657d 5f69 6478 204f 4e20 227b 6c61  ame}_idx ON "{la
-00016000: 7965 727d 2228 7b6e 616d 657d 2927 0a20  yer}"({name})'. 
-00016010: 2020 2067 666f 2e65 7865 6375 7465 5f73     gfo.execute_s
-00016020: 716c 2870 6174 683d 7061 7468 2c20 7371  ql(path=path, sq
-00016030: 6c5f 7374 6d74 3d73 716c 6974 655f 7374  l_stmt=sqlite_st
-00016040: 6d74 290a                                mt).
+00011030: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+00011040: 2020 2020 2020 2020 2020 2067 666f 2e72             gfo.r
+00011050: 656d 6f76 6528 6f75 7470 7574 5f6e 6f74  emove(output_not
+00011060: 6f6e 626f 7264 6572 5f74 6d70 5f70 6172  onborder_tmp_par
+00011070: 7469 616c 5f70 6174 6829 0a0a 2020 2020  tial_path)..    
+00011080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011090: 2320 4966 2063 616c 6375 6c61 7465 2067  # If calculate g
+000110a0: 6176 6520 6f6e 626f 7264 6572 2072 6573  ave onborder res
+000110b0: 756c 7473 2c20 6170 7065 6e64 2074 6f20  ults, append to 
+000110c0: 6f75 7470 7574 0a20 2020 2020 2020 2020  output.         
+000110d0: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
+000110e0: 745f 6f6e 626f 7264 6572 5f74 6d70 5f70  t_onborder_tmp_p
+000110f0: 6172 7469 616c 5f70 6174 6820 3d20 6261  artial_path = ba
+00011100: 7463 6865 735b 6261 7463 685f 6964 5d5b  tches[batch_id][
+00011110: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011120: 2020 2020 2020 2020 2022 6f75 7470 7574           "output
+00011130: 5f6f 6e62 6f72 6465 725f 746d 705f 7061  _onborder_tmp_pa
+00011140: 7274 6961 6c5f 7061 7468 220a 2020 2020  rtial_path".    
+00011150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011160: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00011170: 2020 2020 2020 6966 2028 0a20 2020 2020        if (.     
+00011180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011190: 2020 206f 7574 7075 745f 6f6e 626f 7264     output_onbord
+000111a0: 6572 5f74 6d70 5f70 6172 7469 616c 5f70  er_tmp_partial_p
+000111b0: 6174 682e 6578 6973 7473 2829 0a20 2020  ath.exists().   
+000111c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000111d0: 2020 2020 2061 6e64 206f 7574 7075 745f       and output_
+000111e0: 6f6e 626f 7264 6572 5f74 6d70 5f70 6172  onborder_tmp_par
+000111f0: 7469 616c 5f70 6174 682e 7374 6174 2829  tial_path.stat()
+00011200: 2e73 745f 7369 7a65 203e 2030 0a20 2020  .st_size > 0.   
+00011210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011220: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
+00011230: 2020 2020 2020 2020 2020 2020 6669 6c65              file
+00011240: 6f70 732e 5f61 7070 656e 645f 746f 5f6e  ops._append_to_n
+00011250: 6f6c 6f63 6b28 0a20 2020 2020 2020 2020  olock(.         
+00011260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011270: 2020 2073 7263 3d6f 7574 7075 745f 6f6e     src=output_on
+00011280: 626f 7264 6572 5f74 6d70 5f70 6172 7469  border_tmp_parti
+00011290: 616c 5f70 6174 682c 0a20 2020 2020 2020  al_path,.       
+000112a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000112b0: 2020 2020 2064 7374 3d6f 7574 7075 745f       dst=output_
+000112c0: 6f6e 626f 7264 6572 5f70 6174 682c 0a20  onborder_path,. 
+000112d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000112e0: 2020 2020 2020 2020 2020 2063 7265 6174             creat
+000112f0: 655f 7370 6174 6961 6c5f 696e 6465 783d  e_spatial_index=
+00011300: 4661 6c73 652c 0a20 2020 2020 2020 2020  False,.         
+00011310: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00011320: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011330: 2020 2020 2020 2020 2067 666f 2e72 656d           gfo.rem
+00011340: 6f76 6528 6f75 7470 7574 5f6f 6e62 6f72  ove(output_onbor
+00011350: 6465 725f 746d 705f 7061 7274 6961 6c5f  der_tmp_partial_
+00011360: 7061 7468 290a 0a20 2020 2020 2020 2020  path)..         
+00011370: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
+00011380: 696f 6e20 6173 2065 783a 0a20 2020 2020  ion as ex:.     
+00011390: 2020 2020 2020 2020 2020 2062 6174 6368             batch
+000113a0: 5f69 6420 3d20 6675 7475 7265 5f74 6f5f  _id = future_to_
+000113b0: 6261 7463 685f 6964 5b66 7574 7572 655d  batch_id[future]
+000113c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000113d0: 206d 6573 7361 6765 203d 2066 2245 7272   message = f"Err
+000113e0: 6f72 2065 7865 6375 7469 6e67 207b 6261  or executing {ba
+000113f0: 7463 6865 735b 6261 7463 685f 6964 5d7d  tches[batch_id]}
+00011400: 3a20 7b65 787d 220a 2020 2020 2020 2020  : {ex}".        
+00011410: 2020 2020 2020 2020 6c6f 6767 6572 2e65          logger.e
+00011420: 7863 6570 7469 6f6e 286d 6573 7361 6765  xception(message
+00011430: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00011440: 2020 6361 6c63 756c 6174 655f 706f 6f6c    calculate_pool
+00011450: 2e73 6875 7464 6f77 6e28 290a 2020 2020  .shutdown().    
+00011460: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00011470: 6520 4578 6365 7074 696f 6e28 6d65 7373  e Exception(mess
+00011480: 6167 6529 2066 726f 6d20 6578 0a0a 2020  age) from ex..  
+00011490: 2020 2020 2020 2020 2020 2320 4c6f 6720            # Log 
+000114a0: 7468 6520 7072 6f67 7265 7373 2061 6e64  the progress and
+000114b0: 2070 7265 6469 6374 696f 6e20 7370 6565   prediction spee
+000114c0: 640a 2020 2020 2020 2020 2020 2020 5f67  d.            _g
+000114d0: 656e 6572 616c 5f75 7469 6c2e 7265 706f  eneral_util.repo
+000114e0: 7274 5f70 726f 6772 6573 7328 0a20 2020  rt_progress(.   
+000114f0: 2020 2020 2020 2020 2020 2020 2073 7461               sta
+00011500: 7274 5f74 696d 652c 206e 625f 6261 7463  rt_time, nb_batc
+00011510: 6865 735f 646f 6e65 2c20 6e62 5f62 6174  hes_done, nb_bat
+00011520: 6368 6573 2c20 2264 6973 736f 6c76 6522  ches, "dissolve"
+00011530: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
+00011540: 0a64 6566 205f 6469 7373 6f6c 7665 5f70  .def _dissolve_p
+00011550: 6f6c 7967 6f6e 7328 0a20 2020 2069 6e70  olygons(.    inp
+00011560: 7574 5f70 6174 683a 2050 6174 682c 0a20  ut_path: Path,. 
+00011570: 2020 206f 7574 7075 745f 6e6f 746f 6e62     output_notonb
+00011580: 6f72 6465 725f 7061 7468 3a20 5061 7468  order_path: Path
+00011590: 2c0a 2020 2020 6f75 7470 7574 5f6f 6e62  ,.    output_onb
+000115a0: 6f72 6465 725f 7061 7468 3a20 5061 7468  order_path: Path
+000115b0: 2c0a 2020 2020 6578 706c 6f64 6563 6f6c  ,.    explodecol
+000115c0: 6c65 6374 696f 6e73 3a20 626f 6f6c 2c0a  lections: bool,.
+000115d0: 2020 2020 6772 6f75 7062 795f 636f 6c75      groupby_colu
+000115e0: 6d6e 733a 204f 7074 696f 6e61 6c5b 4974  mns: Optional[It
+000115f0: 6572 6162 6c65 5b73 7472 5d5d 2c0a 2020  erable[str]],.  
+00011600: 2020 6167 675f 636f 6c75 6d6e 733a 204f    agg_columns: O
+00011610: 7074 696f 6e61 6c5b 6469 6374 5d2c 0a20  ptional[dict],. 
+00011620: 2020 2069 6e70 7574 5f67 656f 6d65 7472     input_geometr
+00011630: 7974 7970 653a 2047 656f 6d65 7472 7954  ytype: GeometryT
+00011640: 7970 652c 0a20 2020 2069 6e70 7574 5f6c  ype,.    input_l
+00011650: 6179 6572 3a20 4f70 7469 6f6e 616c 5b73  ayer: Optional[s
+00011660: 7472 5d2c 0a20 2020 206f 7574 7075 745f  tr],.    output_
+00011670: 6c61 7965 723a 204f 7074 696f 6e61 6c5b  layer: Optional[
+00011680: 7374 725d 2c0a 2020 2020 6262 6f78 3a20  str],.    bbox: 
+00011690: 7475 706c 655b 666c 6f61 742c 2066 6c6f  tuple[float, flo
+000116a0: 6174 2c20 666c 6f61 742c 2066 6c6f 6174  at, float, float
+000116b0: 5d2c 0a20 2020 2074 696c 655f 6964 3a20  ],.    tile_id: 
+000116c0: 4f70 7469 6f6e 616c 5b69 6e74 5d2c 0a20  Optional[int],. 
+000116d0: 2020 2067 7269 6473 697a 653a 2066 6c6f     gridsize: flo
+000116e0: 6174 2c0a 2020 2020 6b65 6570 5f65 6d70  at,.    keep_emp
+000116f0: 7479 5f67 656f 6d73 3a20 626f 6f6c 2c0a  ty_geoms: bool,.
+00011700: 2920 2d3e 2064 6963 743a 0a20 2020 2023  ) -> dict:.    #
+00011710: 2049 6e69 740a 2020 2020 7065 7266 696e   Init.    perfin
+00011720: 666f 3a20 6469 6374 5b73 7472 2c20 666c  fo: dict[str, fl
+00011730: 6f61 745d 203d 207b 7d0a 2020 2020 7374  oat] = {}.    st
+00011740: 6172 745f 7469 6d65 203d 2064 6174 6574  art_time = datet
+00011750: 696d 652e 6e6f 7728 290a 2020 2020 7265  ime.now().    re
+00011760: 7475 726e 5f69 6e66 6f20 3d20 7b0a 2020  turn_info = {.  
+00011770: 2020 2020 2020 2269 6e70 7574 5f70 6174        "input_pat
+00011780: 6822 3a20 696e 7075 745f 7061 7468 2c0a  h": input_path,.
+00011790: 2020 2020 2020 2020 226f 7574 7075 745f          "output_
+000117a0: 6e6f 746f 6e62 6f72 6465 725f 7061 7468  notonborder_path
+000117b0: 223a 206f 7574 7075 745f 6e6f 746f 6e62  ": output_notonb
+000117c0: 6f72 6465 725f 7061 7468 2c0a 2020 2020  order_path,.    
+000117d0: 2020 2020 226f 7574 7075 745f 6f6e 626f      "output_onbo
+000117e0: 7264 6572 5f70 6174 6822 3a20 6f75 7470  rder_path": outp
+000117f0: 7574 5f6f 6e62 6f72 6465 725f 7061 7468  ut_onborder_path
+00011800: 2c0a 2020 2020 2020 2020 2262 626f 7822  ,.        "bbox"
+00011810: 3a20 6262 6f78 2c0a 2020 2020 2020 2020  : bbox,.        
+00011820: 2274 696c 655f 6964 223a 2074 696c 655f  "tile_id": tile_
+00011830: 6964 2c0a 2020 2020 2020 2020 2267 7269  id,.        "gri
+00011840: 6473 697a 6522 3a20 6772 6964 7369 7a65  dsize": gridsize
+00011850: 2c0a 2020 2020 2020 2020 226e 625f 726f  ,.        "nb_ro
+00011860: 7773 5f64 6f6e 6522 3a20 302c 0a20 2020  ws_done": 0,.   
+00011870: 2020 2020 2022 746f 7461 6c5f 7469 6d65       "total_time
+00011880: 223a 2030 2c0a 2020 2020 2020 2020 2270  ": 0,.        "p
+00011890: 6572 6669 6e66 6f22 3a20 2222 2c0a 2020  erfinfo": "",.  
+000118a0: 2020 7d0a 0a20 2020 2023 2052 6561 6420    }..    # Read 
+000118b0: 616c 6c20 7265 636f 7264 7320 7468 6174  all records that
+000118c0: 2061 7265 2069 6e20 7468 6520 6262 6f78   are in the bbox
+000118d0: 0a20 2020 2072 6574 7279 5f63 6f75 6e74  .    retry_count
+000118e0: 203d 2030 0a20 2020 2073 7461 7274 5f72   = 0.    start_r
+000118f0: 6561 6420 3d20 6461 7465 7469 6d65 2e6e  ead = datetime.n
+00011900: 6f77 2829 0a20 2020 2061 6767 5f63 6f6c  ow().    agg_col
+00011910: 756d 6e73 5f6e 6565 6465 6420 3d20 4e6f  umns_needed = No
+00011920: 6e65 0a20 2020 2077 6869 6c65 2054 7275  ne.    while Tru
+00011930: 653a 0a20 2020 2020 2020 2074 7279 3a0a  e:.        try:.
+00011940: 2020 2020 2020 2020 2020 2020 636f 6c75              colu
+00011950: 6d6e 735f 746f 5f72 6561 643a 2073 6574  mns_to_read: set
+00011960: 5b73 7472 5d20 3d20 7365 7428 290a 2020  [str] = set().  
+00011970: 2020 2020 2020 2020 2020 696e 666f 203d            info =
+00011980: 2067 666f 2e67 6574 5f6c 6179 6572 696e   gfo.get_layerin
+00011990: 666f 2869 6e70 7574 5f70 6174 682c 2069  fo(input_path, i
+000119a0: 6e70 7574 5f6c 6179 6572 290a 2020 2020  nput_layer).    
+000119b0: 2020 2020 2020 2020 6966 2067 726f 7570          if group
+000119c0: 6279 5f63 6f6c 756d 6e73 2069 7320 6e6f  by_columns is no
+000119d0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+000119e0: 2020 2020 2020 2020 636f 6c75 6d6e 735f          columns_
+000119f0: 746f 5f72 6561 642e 7570 6461 7465 2867  to_read.update(g
+00011a00: 726f 7570 6279 5f63 6f6c 756d 6e73 290a  roupby_columns).
+00011a10: 2020 2020 2020 2020 2020 2020 6669 645f              fid_
+00011a20: 6173 5f69 6e64 6578 203d 2046 616c 7365  as_index = False
+00011a30: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00011a40: 6167 675f 636f 6c75 6d6e 7320 6973 206e  agg_columns is n
+00011a50: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00011a60: 2020 2020 2020 2020 2066 6964 5f61 735f           fid_as_
+00011a70: 696e 6465 7820 3d20 5472 7565 0a20 2020  index = True.   
+00011a80: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00011a90: 225f 5f44 4953 534f 4c56 455f 544f 4a53  "__DISSOLVE_TOJS
+00011aa0: 4f4e 2220 696e 2069 6e66 6f2e 636f 6c75  ON" in info.colu
+00011ab0: 6d6e 733a 0a20 2020 2020 2020 2020 2020  mns:.           
+00011ac0: 2020 2020 2020 2020 2023 2049 6620 7765           # If we
+00011ad0: 2061 7265 206e 6f74 2069 6e20 7468 6520   are not in the 
+00011ae0: 6669 7273 7420 7061 7373 2c20 7468 6520  first pass, the 
+00011af0: 636f 6c75 6d6e 7320 746f 2062 6520 7265  columns to be re
+00011b00: 6164 0a20 2020 2020 2020 2020 2020 2020  ad.             
+00011b10: 2020 2020 2020 2023 2061 7265 2061 6c72         # are alr
+00011b20: 6561 6479 2069 6e20 7468 6520 6a73 6f6e  eady in the json
+00011b30: 2063 6f6c 756d 6e0a 2020 2020 2020 2020   column.        
+00011b40: 2020 2020 2020 2020 2020 2020 636f 6c75              colu
+00011b50: 6d6e 735f 746f 5f72 6561 642e 6164 6428  mns_to_read.add(
+00011b60: 225f 5f44 4953 534f 4c56 455f 544f 4a53  "__DISSOLVE_TOJS
+00011b70: 4f4e 2229 0a20 2020 2020 2020 2020 2020  ON").           
+00011b80: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00011b90: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00011ba0: 2054 6865 2066 6972 7374 2070 6173 732c   The first pass,
+00011bb0: 2073 6f20 7265 6164 2061 6c6c 2072 656c   so read all rel
+00011bc0: 6576 616e 7420 636f 6c75 6d6e 7320 746f  evant columns to
+00011bd0: 2063 6f64 650a 2020 2020 2020 2020 2020   code.          
+00011be0: 2020 2020 2020 2020 2020 2320 7468 656d            # them
+00011bf0: 2069 6e20 6a73 6f6e 0a20 2020 2020 2020   in json.       
+00011c00: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00011c10: 226a 736f 6e22 2069 6e20 6167 675f 636f  "json" in agg_co
+00011c20: 6c75 6d6e 733a 0a20 2020 2020 2020 2020  lumns:.         
+00011c30: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00011c40: 6767 5f63 6f6c 756d 6e73 5f6e 6565 6465  gg_columns_neede
+00011c50: 6420 3d20 6167 675f 636f 6c75 6d6e 735b  d = agg_columns[
+00011c60: 226a 736f 6e22 5d0a 2020 2020 2020 2020  "json"].        
+00011c70: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+00011c80: 2022 636f 6c75 6d6e 7322 2069 6e20 6167   "columns" in ag
+00011c90: 675f 636f 6c75 6d6e 733a 0a20 2020 2020  g_columns:.     
+00011ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011cb0: 2020 2061 6767 5f63 6f6c 756d 6e73 5f6e     agg_columns_n
+00011cc0: 6565 6465 6420 3d20 5b0a 2020 2020 2020  eeded = [.      
+00011cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011ce0: 2020 2020 2020 6167 675f 636f 6c75 6d6e        agg_column
+00011cf0: 5b22 636f 6c75 6d6e 225d 0a20 2020 2020  ["column"].     
+00011d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011d10: 2020 2020 2020 2066 6f72 2061 6767 5f63         for agg_c
+00011d20: 6f6c 756d 6e20 696e 2061 6767 5f63 6f6c  olumn in agg_col
+00011d30: 756d 6e73 5b22 636f 6c75 6d6e 7322 5d0a  umns["columns"].
+00011d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011d50: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
+00011d60: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00011d70: 2061 6767 5f63 6f6c 756d 6e73 5f6e 6565   agg_columns_nee
+00011d80: 6465 6420 6973 206e 6f74 204e 6f6e 653a  ded is not None:
+00011d90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011da0: 2020 2020 2020 2020 2063 6f6c 756d 6e73           columns
+00011db0: 5f74 6f5f 7265 6164 2e75 7064 6174 6528  _to_read.update(
+00011dc0: 6167 675f 636f 6c75 6d6e 735f 6e65 6564  agg_columns_need
+00011dd0: 6564 290a 0a20 2020 2020 2020 2020 2020  ed)..           
+00011de0: 2069 6e70 7574 5f67 6466 203d 2067 666f   input_gdf = gfo
+00011df0: 2e72 6561 645f 6669 6c65 280a 2020 2020  .read_file(.    
+00011e00: 2020 2020 2020 2020 2020 2020 7061 7468              path
+00011e10: 3d69 6e70 7574 5f70 6174 682c 0a20 2020  =input_path,.   
+00011e20: 2020 2020 2020 2020 2020 2020 206c 6179               lay
+00011e30: 6572 3d69 6e70 7574 5f6c 6179 6572 2c0a  er=input_layer,.
+00011e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011e50: 6262 6f78 3d62 626f 782c 0a20 2020 2020  bbox=bbox,.     
+00011e60: 2020 2020 2020 2020 2020 2063 6f6c 756d             colum
+00011e70: 6e73 3d63 6f6c 756d 6e73 5f74 6f5f 7265  ns=columns_to_re
+00011e80: 6164 2c0a 2020 2020 2020 2020 2020 2020  ad,.            
+00011e90: 2020 2020 6669 645f 6173 5f69 6e64 6578      fid_as_index
+00011ea0: 3d66 6964 5f61 735f 696e 6465 782c 0a20  =fid_as_index,. 
+00011eb0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00011ec0: 2020 2020 2020 2020 2020 6966 2061 6767            if agg
+00011ed0: 5f63 6f6c 756d 6e73 2069 7320 6e6f 7420  _columns is not 
+00011ee0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00011ef0: 2020 2020 2020 696e 7075 745f 6764 665b        input_gdf[
+00011f00: 2266 6964 5f6f 7269 6722 5d20 3d20 696e  "fid_orig"] = in
+00011f10: 7075 745f 6764 662e 696e 6465 780a 2020  put_gdf.index.  
+00011f20: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00011f30: 2061 6767 5f63 6f6c 756d 6e73 5f6e 6565   agg_columns_nee
+00011f40: 6465 6420 6973 206e 6f74 204e 6f6e 653a  ded is not None:
+00011f50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011f60: 2020 2020 2061 6767 5f63 6f6c 756d 6e73       agg_columns
+00011f70: 5f6e 6565 6465 642e 6170 7065 6e64 2822  _needed.append("
+00011f80: 6669 645f 6f72 6967 2229 0a0a 2020 2020  fid_orig")..    
+00011f90: 2020 2020 2020 2020 6272 6561 6b0a 2020          break.  
+00011fa0: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
+00011fb0: 6570 7469 6f6e 2061 7320 6578 3a0a 2020  eption as ex:.  
+00011fc0: 2020 2020 2020 2020 2020 6966 2073 7472            if str
+00011fd0: 2865 7829 203d 3d20 2264 6174 6162 6173  (ex) == "databas
+00011fe0: 6520 6973 206c 6f63 6b65 6422 3a0a 2020  e is locked":.  
+00011ff0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00012000: 2072 6574 7279 5f63 6f75 6e74 203c 2031   retry_count < 1
+00012010: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
+00012020: 2020 2020 2020 2072 6574 7279 5f63 6f75         retry_cou
+00012030: 6e74 202b 3d20 310a 2020 2020 2020 2020  nt += 1.        
+00012040: 2020 2020 2020 2020 2020 2020 7469 6d65              time
+00012050: 2e73 6c65 6570 2831 290a 2020 2020 2020  .sleep(1).      
+00012060: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00012070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012080: 2020 2020 7261 6973 6520 4578 6365 7074      raise Except
+00012090: 696f 6e28 2272 6574 7269 6564 2031 3020  ion("retried 10 
+000120a0: 7469 6d65 732c 2064 6174 6162 6173 6520  times, database 
+000120b0: 7374 696c 6c20 6c6f 636b 6564 2229 2066  still locked") f
+000120c0: 726f 6d20 6578 0a20 2020 2020 2020 2020  rom ex.         
+000120d0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000120e0: 2020 2020 2020 2020 2072 6169 7365 2065           raise e
+000120f0: 780a 0a20 2020 2023 2043 6865 636b 2072  x..    # Check r
+00012100: 6573 756c 740a 2020 2020 7065 7266 696e  esult.    perfin
+00012110: 666f 5b22 7469 6d65 5f72 6561 6422 5d20  fo["time_read"] 
+00012120: 3d20 2864 6174 6574 696d 652e 6e6f 7728  = (datetime.now(
+00012130: 2920 2d20 7374 6172 745f 7265 6164 292e  ) - start_read).
+00012140: 746f 7461 6c5f 7365 636f 6e64 7328 290a  total_seconds().
+00012150: 2020 2020 7265 7475 726e 5f69 6e66 6f5b      return_info[
+00012160: 226e 625f 726f 7773 5f64 6f6e 6522 5d20  "nb_rows_done"] 
+00012170: 3d20 6c65 6e28 696e 7075 745f 6764 6629  = len(input_gdf)
+00012180: 0a20 2020 2069 6620 7265 7475 726e 5f69  .    if return_i
+00012190: 6e66 6f5b 226e 625f 726f 7773 5f64 6f6e  nfo["nb_rows_don
+000121a0: 6522 5d20 3d3d 2030 3a0a 2020 2020 2020  e"] == 0:.      
+000121b0: 2020 6d65 7373 6167 6520 3d20 6622 6469    message = f"di
+000121c0: 7373 6f6c 7665 5f70 6f6c 7967 6f6e 733a  ssolve_polygons:
+000121d0: 206e 6f20 696e 7075 7420 6765 6f6d 6574   no input geomet
+000121e0: 7269 6573 2066 6f75 6e64 2069 6e20 7b69  ries found in {i
+000121f0: 6e70 7574 5f70 6174 687d 220a 2020 2020  nput_path}".    
+00012200: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
+00012210: 6d65 7373 6167 6529 0a20 2020 2020 2020  message).       
+00012220: 2072 6574 7572 6e5f 696e 666f 5b22 6d65   return_info["me
+00012230: 7373 6167 6522 5d20 3d20 6d65 7373 6167  ssage"] = messag
+00012240: 650a 2020 2020 2020 2020 7265 7475 726e  e.        return
+00012250: 5f69 6e66 6f5b 2274 6f74 616c 5f74 696d  _info["total_tim
+00012260: 6522 5d20 3d20 2864 6174 6574 696d 652e  e"] = (datetime.
+00012270: 6e6f 7728 2920 2d20 7374 6172 745f 7469  now() - start_ti
+00012280: 6d65 292e 746f 7461 6c5f 7365 636f 6e64  me).total_second
+00012290: 7328 290a 2020 2020 2020 2020 7265 7475  s().        retu
+000122a0: 726e 2072 6574 7572 6e5f 696e 666f 0a0a  rn return_info..
+000122b0: 2020 2020 2320 4e6f 7720 7468 6520 7265      # Now the re
+000122c0: 616c 2070 726f 6365 7373 696e 670a 2020  al processing.  
+000122d0: 2020 6167 6766 756e 633a 2055 6e69 6f6e    aggfunc: Union
+000122e0: 5b73 7472 2c20 6469 6374 2c20 4e6f 6e65  [str, dict, None
+000122f0: 5d20 3d20 4e6f 6e65 0a20 2020 2069 6620  ] = None.    if 
+00012300: 6167 675f 636f 6c75 6d6e 7320 6973 206e  agg_columns is n
+00012310: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00012320: 2069 6620 225f 5f44 4953 534f 4c56 455f   if "__DISSOLVE_
+00012330: 544f 4a53 4f4e 2220 6e6f 7420 696e 2069  TOJSON" not in i
+00012340: 6e70 7574 5f67 6466 2e63 6f6c 756d 6e73  nput_gdf.columns
+00012350: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+00012360: 4669 7273 7420 7061 7373 202d 3e20 7075  First pass -> pu
+00012370: 7420 7265 6c65 7661 6e74 2063 6f6c 756d  t relevant colum
+00012380: 6e73 2069 6e20 6a73 6f6e 2066 6965 6c64  ns in json field
+00012390: 0a20 2020 2020 2020 2020 2020 2061 6767  .            agg
+000123a0: 6675 6e63 203d 207b 2274 6f5f 6a73 6f6e  func = {"to_json
+000123b0: 223a 2061 6767 5f63 6f6c 756d 6e73 5f6e  ": agg_columns_n
+000123c0: 6565 6465 647d 0a20 2020 2020 2020 2065  eeded}.        e
+000123d0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+000123e0: 2023 2043 6f6c 756d 6e73 2061 6c72 6561   # Columns alrea
+000123f0: 6479 2063 6f64 6564 2069 6e20 6120 6a73  dy coded in a js
+00012400: 6f6e 2063 6f6c 756d 6e2c 2073 6f20 6d65  on column, so me
+00012410: 7267 6520 6a73 6f6e 206c 6973 7473 0a20  rge json lists. 
+00012420: 2020 2020 2020 2020 2020 2061 6767 6675             aggfu
+00012430: 6e63 203d 2022 6d65 7267 655f 6a73 6f6e  nc = "merge_json
+00012440: 5f6c 6973 7473 220a 2020 2020 656c 7365  _lists".    else
+00012450: 3a0a 2020 2020 2020 2020 6167 6766 756e  :.        aggfun
+00012460: 6320 3d20 2266 6972 7374 220a 2020 2020  c = "first".    
+00012470: 7374 6172 745f 6469 7373 6f6c 7665 203d  start_dissolve =
+00012480: 2064 6174 6574 696d 652e 6e6f 7728 290a   datetime.now().
+00012490: 2020 2020 6469 7373 5f67 6466 203d 205f      diss_gdf = _
+000124a0: 6469 7373 6f6c 7665 280a 2020 2020 2020  dissolve(.      
+000124b0: 2020 6466 3d69 6e70 7574 5f67 6466 2c20    df=input_gdf, 
+000124c0: 6279 3d67 726f 7570 6279 5f63 6f6c 756d  by=groupby_colum
+000124d0: 6e73 2c20 6167 6766 756e 633d 6167 6766  ns, aggfunc=aggf
+000124e0: 756e 632c 2061 735f 696e 6465 783d 4661  unc, as_index=Fa
+000124f0: 6c73 652c 2064 726f 706e 613d 4661 6c73  lse, dropna=Fals
+00012500: 650a 2020 2020 290a 2020 2020 7065 7266  e.    ).    perf
+00012510: 696e 666f 5b22 7469 6d65 5f64 6973 736f  info["time_disso
+00012520: 6c76 6522 5d20 3d20 2864 6174 6574 696d  lve"] = (datetim
+00012530: 652e 6e6f 7728 2920 2d20 7374 6172 745f  e.now() - start_
+00012540: 6469 7373 6f6c 7665 292e 746f 7461 6c5f  dissolve).total_
+00012550: 7365 636f 6e64 7328 290a 0a20 2020 2023  seconds()..    #
+00012560: 2049 6620 6578 706c 6f64 6563 6f6c 6c65   If explodecolle
+00012570: 6374 696f 6e73 2069 7320 5472 7565 2061  ctions is True a
+00012580: 6e64 2046 6f72 2070 6f6c 7967 6f6e 732c  nd For polygons,
+00012590: 2065 7870 6c6f 6465 206d 756c 7469 2d67   explode multi-g
+000125a0: 656f 6d65 7472 6965 732e 0a20 2020 2023  eometries..    #
+000125b0: 2049 6620 6e65 6564 6564 2074 6865 7920   If needed they 
+000125c0: 7769 6c6c 2062 6520 2763 6f6c 6c65 6374  will be 'collect
+000125d0: 6564 2720 6166 7465 7277 6172 6473 2074  ed' afterwards t
+000125e0: 6f20 6d75 6c74 6970 6f6c 7967 6f6e 7320  o multipolygons 
+000125f0: 6167 6169 6e2e 0a20 2020 2069 6620 6578  again..    if ex
+00012600: 706c 6f64 6563 6f6c 6c65 6374 696f 6e73  plodecollections
+00012610: 2069 7320 5472 7565 206f 7220 696e 7075   is True or inpu
+00012620: 745f 6765 6f6d 6574 7279 7479 7065 2069  t_geometrytype i
+00012630: 6e20 5b0a 2020 2020 2020 2020 4765 6f6d  n [.        Geom
+00012640: 6574 7279 5479 7065 2e50 4f4c 5947 4f4e  etryType.POLYGON
+00012650: 2c0a 2020 2020 2020 2020 4765 6f6d 6574  ,.        Geomet
+00012660: 7279 5479 7065 2e4d 554c 5449 504f 4c59  ryType.MULTIPOLY
+00012670: 474f 4e2c 0a20 2020 205d 3a0a 2020 2020  GON,.    ]:.    
+00012680: 2020 2020 6469 7373 5f67 6466 203d 2064      diss_gdf = d
+00012690: 6973 735f 6764 662e 6578 706c 6f64 6528  iss_gdf.explode(
+000126a0: 6967 6e6f 7265 5f69 6e64 6578 3d54 7275  ignore_index=Tru
+000126b0: 6529 0a0a 2020 2020 2320 436c 6970 2074  e)..    # Clip t
+000126c0: 6865 2072 6573 756c 7420 6f6e 2074 6865  he result on the
+000126d0: 2062 6f72 6465 7273 206f 6620 7468 6520   borders of the 
+000126e0: 6262 6f78 206e 6f74 2074 6f20 6861 7665  bbox not to have
+000126f0: 206f 7665 726c 6170 730a 2020 2020 2320   overlaps.    # 
+00012700: 6265 7477 6565 6e20 7468 6520 6469 6666  between the diff
+00012710: 6572 656e 7420 7469 6c65 732e 0a20 2020  erent tiles..   
+00012720: 2023 2049 6620 7468 6973 2069 7320 6e6f   # If this is no
+00012730: 7420 6170 706c 6965 642c 2074 6869 7320  t applied, this 
+00012740: 7265 7375 6c74 7320 696e 2073 6f6d 6520  results in some 
+00012750: 6765 6f6d 6574 7269 6573 206e 6f74 2062  geometries not b
+00012760: 6569 6e67 206d 6572 6765 640a 2020 2020  eing merged.    
+00012770: 2320 6f72 2069 6e20 6475 706c 6963 6174  # or in duplicat
+00012780: 6573 2e0a 2020 2020 2320 5245 4d41 524b  es..    # REMARK
+00012790: 3a20 666f 7220 286d 756c 7469 296c 696e  : for (multi)lin
+000127a0: 6573 7472 696e 6773 2c20 7468 6520 656e  estrings, the en
+000127b0: 6470 6f69 6e74 7320 6372 6561 7465 6420  dpoints created 
+000127c0: 6279 2074 6865 2063 6c69 7020 6172 6520  by the clip are 
+000127d0: 6e6f 740a 2020 2020 2320 616c 7761 7973  not.    # always
+000127e0: 2074 6865 2073 616d 6520 6475 6520 746f   the same due to
+000127f0: 2072 6f75 6e64 696e 672c 2073 6f20 6469   rounding, so di
+00012800: 7373 6f6c 7669 6e67 2069 6e20 6120 6e65  ssolving in a ne
+00012810: 7874 2070 6173 7320 646f 6573 6e27 740a  xt pass doesn't.
+00012820: 2020 2020 2320 616c 7761 7973 2072 6573      # always res
+00012830: 756c 7420 696e 206c 696e 6573 7472 696e  ult in linestrin
+00012840: 6773 2062 6569 6e67 2072 652d 636f 6e6e  gs being re-conn
+00012850: 6563 7465 642e 2e2e 2042 6563 6175 7365  ected... Because
+00012860: 2064 6973 736f 6c76 696e 670a 2020 2020   dissolving.    
+00012870: 2320 6c69 6e65 7320 6973 6e27 7420 736f  # lines isn't so
+00012880: 2063 6f6d 7075 7461 7469 6f6e 616c 6c79   computationally
+00012890: 2068 6561 7679 2061 6e79 7761 792c 2064   heavy anyway, d
+000128a0: 726f 7020 7375 7070 6f72 7420 6865 7265  rop support here
+000128b0: 2e0a 2020 2020 6966 2062 626f 7820 6973  ..    if bbox is
+000128c0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+000128d0: 2020 2073 7461 7274 5f63 6c69 7020 3d20     start_clip = 
+000128e0: 6461 7465 7469 6d65 2e6e 6f77 2829 0a20  datetime.now(). 
+000128f0: 2020 2020 2020 2062 626f 785f 706f 6c79         bbox_poly
+00012900: 676f 6e20 3d20 7368 5f67 656f 6d2e 506f  gon = sh_geom.Po
+00012910: 6c79 676f 6e28 0a20 2020 2020 2020 2020  lygon(.         
+00012920: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00012930: 2020 2020 2028 6262 6f78 5b30 5d2c 2062       (bbox[0], b
+00012940: 626f 785b 315d 292c 0a20 2020 2020 2020  box[1]),.       
+00012950: 2020 2020 2020 2020 2028 6262 6f78 5b30           (bbox[0
+00012960: 5d2c 2062 626f 785b 335d 292c 0a20 2020  ], bbox[3]),.   
+00012970: 2020 2020 2020 2020 2020 2020 2028 6262               (bb
+00012980: 6f78 5b32 5d2c 2062 626f 785b 335d 292c  ox[2], bbox[3]),
+00012990: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000129a0: 2028 6262 6f78 5b32 5d2c 2062 626f 785b   (bbox[2], bbox[
+000129b0: 315d 292c 0a20 2020 2020 2020 2020 2020  1]),.           
+000129c0: 2020 2020 2028 6262 6f78 5b30 5d2c 2062       (bbox[0], b
+000129d0: 626f 785b 315d 292c 0a20 2020 2020 2020  box[1]),.       
+000129e0: 2020 2020 205d 0a20 2020 2020 2020 2029       ].        )
+000129f0: 0a20 2020 2020 2020 2062 626f 785f 6764  .        bbox_gd
+00012a00: 6620 3d20 6770 642e 4765 6f44 6174 6146  f = gpd.GeoDataF
+00012a10: 7261 6d65 280a 2020 2020 2020 2020 2020  rame(.          
+00012a20: 2020 6461 7461 3d5b 315d 2c20 6765 6f6d    data=[1], geom
+00012a30: 6574 7279 3d5b 6262 6f78 5f70 6f6c 7967  etry=[bbox_polyg
+00012a40: 6f6e 5d2c 2063 7273 3d69 6e70 7574 5f67  on], crs=input_g
+00012a50: 6466 2e63 7273 0a20 2020 2020 2020 2029  df.crs.        )
+00012a60: 0a0a 2020 2020 2020 2020 2320 4361 7463  ..        # Catc
+00012a70: 6820 6972 7265 6c65 7661 6e74 2070 616e  h irrelevant pan
+00012a80: 6461 7320 6675 7475 7265 2077 6172 6e69  das future warni
+00012a90: 6e67 0a20 2020 2020 2020 2023 2054 4f44  ng.        # TOD
+00012aa0: 4f3a 2077 6865 6e20 7265 6d6f 7665 6420  O: when removed 
+00012ab0: 696e 206c 6174 6572 2076 6572 7369 6f6e  in later version
+00012ac0: 206f 6620 7061 6e64 6173 2c20 6361 6e20   of pandas, can 
+00012ad0: 6265 2072 656d 6f76 6564 2068 6572 650a  be removed here.
+00012ae0: 2020 2020 2020 2020 7769 7468 2077 6172          with war
+00012af0: 6e69 6e67 732e 6361 7463 685f 7761 726e  nings.catch_warn
+00012b00: 696e 6773 2829 3a0a 2020 2020 2020 2020  ings():.        
+00012b10: 2020 2020 6d65 7373 6167 6520 3d20 280a      message = (.
+00012b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012b30: 2249 6e20 6120 6675 7475 7265 2076 6572  "In a future ver
+00012b40: 7369 6f6e 2c20 6064 662e 696c 6f63 5b3a  sion, `df.iloc[:
+00012b50: 2c20 695d 203d 206e 6577 7661 6c73 6020  , i] = newvals` 
+00012b60: 7769 6c6c 2061 7474 656d 7074 2074 6f20  will attempt to 
+00012b70: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00012b80: 2020 2273 6574 2074 6865 2076 616c 7565    "set the value
+00012b90: 7320 696e 706c 6163 6520 696e 7374 6561  s inplace instea
+00012ba0: 6420 6f66 2061 6c77 6179 7320 7365 7474  d of always sett
+00012bb0: 696e 6720 6120 6e65 7720 6172 7261 792e  ing a new array.
+00012bc0: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
+00012bd0: 2020 2020 2020 2020 2020 2020 7761 726e              warn
+00012be0: 696e 6773 2e66 696c 7465 7277 6172 6e69  ings.filterwarni
+00012bf0: 6e67 7328 0a20 2020 2020 2020 2020 2020  ngs(.           
+00012c00: 2020 2020 2061 6374 696f 6e3d 2269 676e       action="ign
+00012c10: 6f72 6522 2c20 6361 7465 676f 7279 3d46  ore", category=F
+00012c20: 7574 7572 6557 6172 6e69 6e67 2c20 6d65  utureWarning, me
+00012c30: 7373 6167 653d 7265 2e65 7363 6170 6528  ssage=re.escape(
+00012c40: 6d65 7373 6167 6529 0a20 2020 2020 2020  message).       
+00012c50: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00012c60: 2020 2023 206b 6565 705f 6765 6f6d 5f74     # keep_geom_t
+00012c70: 7970 653d 5472 7565 2067 6176 6520 736f  ype=True gave so
+00012c80: 6d65 7469 6d65 7320 6572 726f 722c 2061  metimes error, a
+00012c90: 6e64 2073 7469 6c6c 2064 6f65 7320 696e  nd still does in
+00012ca0: 2030 2e39 2e30 0a20 2020 2020 2020 2020   0.9.0.         
+00012cb0: 2020 2023 2073 6f20 7573 6520 6f77 6e20     # so use own 
+00012cc0: 696d 706c 656d 656e 7461 7469 6f6e 206f  implementation o
+00012cd0: 6620 6b65 6570 5f67 656f 6d5f 7479 7065  f keep_geom_type
+00012ce0: 0a20 2020 2020 2020 2020 2020 2064 6973  .            dis
+00012cf0: 735f 6764 6620 3d20 6770 642e 636c 6970  s_gdf = gpd.clip
+00012d00: 2864 6973 735f 6764 662c 2062 626f 785f  (diss_gdf, bbox_
+00012d10: 6764 6629 2020 2320 2c20 6b65 6570 5f67  gdf)  # , keep_g
+00012d20: 656f 6d5f 7479 7065 3d54 7275 6529 0a20  eom_type=True). 
+00012d30: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00012d40: 7420 6973 696e 7374 616e 6365 2864 6973  t isinstance(dis
+00012d50: 735f 6764 662c 2067 7064 2e47 656f 4461  s_gdf, gpd.GeoDa
+00012d60: 7461 4672 616d 6529 0a0a 2020 2020 2020  taFrame)..      
+00012d70: 2020 2320 4f6e 6c79 206b 6565 7020 6765    # Only keep ge
+00012d80: 6f6d 6574 7269 6573 206f 6620 7468 6520  ometries of the 
+00012d90: 7072 696d 6974 6976 6520 7479 7065 2073  primitive type s
+00012da0: 7065 6369 6669 6564 2061 6674 6572 2063  pecified after c
+00012db0: 6c69 702e 2e2e 0a20 2020 2020 2020 2061  lip....        a
+00012dc0: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
+00012dd0: 2864 6973 735f 6764 662c 2067 7064 2e47  (diss_gdf, gpd.G
+00012de0: 656f 4461 7461 4672 616d 6529 0a20 2020  eoDataFrame).   
+00012df0: 2020 2020 2064 6973 735f 6764 662e 6765       diss_gdf.ge
+00012e00: 6f6d 6574 7279 203d 2070 7967 656f 6f70  ometry = pygeoop
+00012e10: 732e 636f 6c6c 6563 7469 6f6e 5f65 7874  s.collection_ext
+00012e20: 7261 6374 280a 2020 2020 2020 2020 2020  ract(.          
+00012e30: 2020 6469 7373 5f67 6466 2e67 656f 6d65    diss_gdf.geome
+00012e40: 7472 792c 2070 7269 6d69 7469 7665 7479  try, primitivety
+00012e50: 7065 3d69 6e70 7574 5f67 656f 6d65 7472  pe=input_geometr
+00012e60: 7974 7970 652e 746f 5f70 7269 6d69 7469  ytype.to_primiti
+00012e70: 7665 7479 7065 0a20 2020 2020 2020 2029  vetype.        )
+00012e80: 0a0a 2020 2020 2020 2020 7065 7266 696e  ..        perfin
+00012e90: 666f 5b22 7469 6d65 5f63 6c69 7022 5d20  fo["time_clip"] 
+00012ea0: 3d20 2864 6174 6574 696d 652e 6e6f 7728  = (datetime.now(
+00012eb0: 2920 2d20 7374 6172 745f 636c 6970 292e  ) - start_clip).
+00012ec0: 746f 7461 6c5f 7365 636f 6e64 7328 290a  total_seconds().
+00012ed0: 0a20 2020 2069 6620 6772 6964 7369 7a65  .    if gridsize
+00012ee0: 2021 3d20 302e 303a 0a20 2020 2020 2020   != 0.0:.       
+00012ef0: 2064 6973 735f 6764 662e 6765 6f6d 6574   diss_gdf.geomet
+00012f00: 7279 203d 205f 6765 6f73 6572 6965 735f  ry = _geoseries_
+00012f10: 7574 696c 2e73 6574 5f70 7265 6369 7369  util.set_precisi
+00012f20: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
+00012f30: 6469 7373 5f67 6466 2e67 656f 6d65 7472  diss_gdf.geometr
+00012f40: 792c 2067 7269 645f 7369 7a65 3d67 7269  y, grid_size=gri
+00012f50: 6473 697a 652c 2072 6169 7365 5f6f 6e5f  dsize, raise_on_
+00012f60: 746f 706f 6572 726f 723d 4661 6c73 650a  topoerror=False.
+00012f70: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00012f80: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
+00012f90: 6e63 6528 6469 7373 5f67 6466 2e67 656f  nce(diss_gdf.geo
+00012fa0: 6d65 7472 792c 2067 7064 2e47 656f 5365  metry, gpd.GeoSe
+00012fb0: 7269 6573 290a 0a20 2020 2023 2053 6574  ries)..    # Set
+00012fc0: 2065 6d70 7479 2067 656f 6d65 7472 6965   empty geometrie
+00012fd0: 7320 746f 204e 6f6e 650a 2020 2020 6469  s to None.    di
+00012fe0: 7373 5f67 6466 2e6c 6f63 5b64 6973 735f  ss_gdf.loc[diss_
+00012ff0: 6764 662e 6765 6f6d 6574 7279 2e69 735f  gdf.geometry.is_
+00013000: 656d 7074 792c 2064 6973 735f 6764 662e  empty, diss_gdf.
+00013010: 6765 6f6d 6574 7279 2e6e 616d 655d 203d  geometry.name] =
+00013020: 204e 6f6e 650a 0a20 2020 2069 6620 6e6f   None..    if no
+00013030: 7420 6b65 6570 5f65 6d70 7479 5f67 656f  t keep_empty_geo
+00013040: 6d73 3a0a 2020 2020 2020 2020 2320 5265  ms:.        # Re
+00013050: 6d6f 7665 2072 6f77 7320 7768 6572 6520  move rows where 
+00013060: 6765 6f6d 2069 7320 4e6f 6e65 0a20 2020  geom is None.   
+00013070: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
+00013080: 7374 616e 6365 2864 6973 735f 6764 662c  stance(diss_gdf,
+00013090: 2067 7064 2e47 656f 4461 7461 4672 616d   gpd.GeoDataFram
+000130a0: 6529 0a20 2020 2020 2020 2064 6973 735f  e).        diss_
+000130b0: 6764 6620 3d20 6469 7373 5f67 6466 5b7e  gdf = diss_gdf[~
+000130c0: 6469 7373 5f67 6466 2e67 656f 6d65 7472  diss_gdf.geometr
+000130d0: 792e 6973 6e61 2829 5d0a 0a20 2020 2023  y.isna()]..    #
+000130e0: 2049 6620 7468 6572 6520 6973 206e 6f20   If there is no 
+000130f0: 7265 7375 6c74 2c20 7265 7475 726e 0a20  result, return. 
+00013100: 2020 2069 6620 6c65 6e28 6469 7373 5f67     if len(diss_g
+00013110: 6466 2920 3d3d 2030 3a0a 2020 2020 2020  df) == 0:.      
+00013120: 2020 6d65 7373 6167 6520 3d20 6622 5265    message = f"Re
+00013130: 7375 6c74 2069 7320 656d 7074 7920 666f  sult is empty fo
+00013140: 7220 7b69 6e70 7574 5f70 6174 687d 220a  r {input_path}".
+00013150: 2020 2020 2020 2020 7265 7475 726e 5f69          return_i
+00013160: 6e66 6f5b 226d 6573 7361 6765 225d 203d  nfo["message"] =
+00013170: 206d 6573 7361 6765 0a20 2020 2020 2020   message.       
+00013180: 2072 6574 7572 6e5f 696e 666f 5b22 7065   return_info["pe
+00013190: 7266 696e 666f 225d 203d 2070 6572 6669  rfinfo"] = perfi
+000131a0: 6e66 6f0a 2020 2020 2020 2020 7265 7475  nfo.        retu
+000131b0: 726e 5f69 6e66 6f5b 2274 6f74 616c 5f74  rn_info["total_t
+000131c0: 696d 6522 5d20 3d20 2864 6174 6574 696d  ime"] = (datetim
+000131d0: 652e 6e6f 7728 2920 2d20 7374 6172 745f  e.now() - start_
+000131e0: 7469 6d65 292e 746f 7461 6c5f 7365 636f  time).total_seco
+000131f0: 6e64 7328 290a 2020 2020 2020 2020 7265  nds().        re
+00013200: 7475 726e 2072 6574 7572 6e5f 696e 666f  turn return_info
+00013210: 0a0a 2020 2020 2320 4164 6420 636f 6c75  ..    # Add colu
+00013220: 6d6e 2077 6974 6820 7469 6c65 5f69 640a  mn with tile_id.
+00013230: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
+00013240: 7461 6e63 6528 6469 7373 5f67 6466 2c20  tance(diss_gdf, 
+00013250: 6770 642e 4765 6f44 6174 6146 7261 6d65  gpd.GeoDataFrame
+00013260: 290a 2020 2020 6966 2074 696c 655f 6964  ).    if tile_id
+00013270: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00013280: 2020 2020 2020 6469 7373 5f67 6466 5b22        diss_gdf["
+00013290: 7469 6c65 5f69 6422 5d20 3d20 7469 6c65  tile_id"] = tile
+000132a0: 5f69 640a 0a20 2020 2023 2053 6176 6520  _id..    # Save 
+000132b0: 7468 6520 7265 7375 6c74 2074 6f20 6465  the result to de
+000132c0: 7374 696e 6174 696f 6e20 6669 6c65 2873  stination file(s
+000132d0: 290a 2020 2020 7374 6172 745f 746f 5f66  ).    start_to_f
+000132e0: 696c 6520 3d20 6461 7465 7469 6d65 2e6e  ile = datetime.n
+000132f0: 6f77 2829 0a0a 2020 2020 2320 4966 2074  ow()..    # If t
+00013300: 6865 2074 696c 6573 2064 6f6e 2774 206e  he tiles don't n
+00013310: 6565 6420 746f 2062 6520 6d65 7267 6564  eed to be merged
+00013320: 2061 6674 6572 7761 7264 732c 2077 6520   afterwards, we 
+00013330: 6361 6e20 6a75 7374 2073 6176 6520 7468  can just save th
+00013340: 6520 7265 7375 6c74 2061 730a 2020 2020  e result as.    
+00013350: 2320 6974 2069 732e 0a20 2020 2069 6620  # it is..    if 
+00013360: 7374 7228 6f75 7470 7574 5f6e 6f74 6f6e  str(output_noton
+00013370: 626f 7264 6572 5f70 6174 6829 203d 3d20  border_path) == 
+00013380: 7374 7228 6f75 7470 7574 5f6f 6e62 6f72  str(output_onbor
+00013390: 6465 725f 7061 7468 293a 0a20 2020 2020  der_path):.     
+000133a0: 2020 2023 2061 7373 6572 7420 746f 2061     # assert to a
+000133b0: 766f 6964 2070 794c 616e 6365 2077 6172  void pyLance war
+000133c0: 6e69 6e67 0a20 2020 2020 2020 2061 7373  ning.        ass
+000133d0: 6572 7420 6973 696e 7374 616e 6365 2864  ert isinstance(d
+000133e0: 6973 735f 6764 662c 2067 7064 2e47 656f  iss_gdf, gpd.Geo
+000133f0: 4461 7461 4672 616d 6529 0a20 2020 2020  DataFrame).     
+00013400: 2020 2023 2055 7365 2066 6f72 6365 5f6d     # Use force_m
+00013410: 756c 7469 7479 7065 2c20 746f 2061 766f  ultitype, to avo
+00013420: 6964 2077 6172 6e69 6e67 7320 7768 656e  id warnings when
+00013430: 2073 6f6d 6520 6261 7463 6865 7320 636f   some batches co
+00013440: 6e74 6169 6e0a 2020 2020 2020 2020 2320  ntain.        # 
+00013450: 7369 6e67 6c65 7479 7065 2061 6e64 2073  singletype and s
+00013460: 6f6d 6520 636f 6e74 6169 6e20 6d75 6c74  ome contain mult
+00013470: 6974 7970 6520 6765 6f6d 6574 7269 6573  itype geometries
+00013480: 0a20 2020 2020 2020 2067 666f 2e74 6f5f  .        gfo.to_
+00013490: 6669 6c65 280a 2020 2020 2020 2020 2020  file(.          
+000134a0: 2020 6469 7373 5f67 6466 2c0a 2020 2020    diss_gdf,.    
+000134b0: 2020 2020 2020 2020 6f75 7470 7574 5f6e          output_n
+000134c0: 6f74 6f6e 626f 7264 6572 5f70 6174 682c  otonborder_path,
+000134d0: 0a20 2020 2020 2020 2020 2020 206c 6179  .            lay
+000134e0: 6572 3d6f 7574 7075 745f 6c61 7965 722c  er=output_layer,
+000134f0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+00013500: 6365 5f6d 756c 7469 7479 7065 3d54 7275  ce_multitype=Tru
+00013510: 652c 0a20 2020 2020 2020 2020 2020 2069  e,.            i
+00013520: 6e64 6578 3d46 616c 7365 2c0a 2020 2020  ndex=False,.    
+00013530: 2020 2020 2020 2020 6372 6561 7465 5f73          create_s
+00013540: 7061 7469 616c 5f69 6e64 6578 3d46 616c  patial_index=Fal
+00013550: 7365 2c0a 2020 2020 2020 2020 290a 2020  se,.        ).  
+00013560: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00013570: 2320 4966 206e 6f74 2c20 7361 7665 2074  # If not, save t
+00013580: 6865 2070 6f6c 7967 6f6e 7320 6f6e 2074  he polygons on t
+00013590: 6865 2062 6f72 6465 7220 7365 7065 7261  he border sepera
+000135a0: 7465 6c79 0a20 2020 2020 2020 2062 626f  tely.        bbo
+000135b0: 785f 6c69 6e65 7320 3d20 7079 6765 6f6f  x_lines = pygeoo
+000135c0: 7073 2e65 7870 6c6f 6465 280a 2020 2020  ps.explode(.    
+000135d0: 2020 2020 2020 2020 7368 6170 656c 792e          shapely.
+000135e0: 626f 756e 6461 7279 2873 685f 6765 6f6d  boundary(sh_geom
+000135f0: 2e62 6f78 2862 626f 785b 305d 2c20 6262  .box(bbox[0], bb
+00013600: 6f78 5b31 5d2c 2062 626f 785b 325d 2c20  ox[1], bbox[2], 
+00013610: 6262 6f78 5b33 5d29 290a 2020 2020 2020  bbox[3])).      
+00013620: 2020 290a 2020 2020 2020 2020 6262 6f78    ).        bbox
+00013630: 5f6c 696e 6573 5f67 6466 203d 2067 7064  _lines_gdf = gpd
+00013640: 2e47 656f 4461 7461 4672 616d 6528 6765  .GeoDataFrame(ge
+00013650: 6f6d 6574 7279 3d62 626f 785f 6c69 6e65  ometry=bbox_line
+00013660: 732c 2063 7273 3d69 6e70 7574 5f67 6466  s, crs=input_gdf
+00013670: 2e63 7273 290a 2020 2020 2020 2020 6f6e  .crs).        on
+00013680: 626f 7264 6572 5f67 6466 203d 2067 7064  border_gdf = gpd
+00013690: 2e73 6a6f 696e 2864 6973 735f 6764 662c  .sjoin(diss_gdf,
+000136a0: 2062 626f 785f 6c69 6e65 735f 6764 662c   bbox_lines_gdf,
+000136b0: 2070 7265 6469 6361 7465 3d22 696e 7465   predicate="inte
+000136c0: 7273 6563 7473 2229 0a20 2020 2020 2020  rsects").       
+000136d0: 206f 6e62 6f72 6465 725f 6764 662e 6472   onborder_gdf.dr
+000136e0: 6f70 2822 696e 6465 785f 7269 6768 7422  op("index_right"
+000136f0: 2c20 6178 6973 3d31 2c20 696e 706c 6163  , axis=1, inplac
+00013700: 653d 5472 7565 290a 2020 2020 2020 2020  e=True).        
+00013710: 6966 206c 656e 286f 6e62 6f72 6465 725f  if len(onborder_
+00013720: 6764 6629 203e 2030 3a0a 2020 2020 2020  gdf) > 0:.      
+00013730: 2020 2020 2020 2320 5573 6520 666f 7263        # Use forc
+00013740: 655f 6d75 6c74 6974 7970 652c 2074 6f20  e_multitype, to 
+00013750: 6176 6f69 6420 7761 726e 696e 6773 2077  avoid warnings w
+00013760: 6865 6e20 736f 6d65 2062 6174 6368 6573  hen some batches
+00013770: 2063 6f6e 7461 696e 0a20 2020 2020 2020   contain.       
+00013780: 2020 2020 2023 2073 696e 676c 6574 7970       # singletyp
+00013790: 6520 616e 6420 736f 6d65 2063 6f6e 7461  e and some conta
+000137a0: 696e 206d 756c 7469 7479 7065 2067 656f  in multitype geo
+000137b0: 6d65 7472 6965 730a 2020 2020 2020 2020  metries.        
+000137c0: 2020 2020 6766 6f2e 746f 5f66 696c 6528      gfo.to_file(
+000137d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000137e0: 206f 6e62 6f72 6465 725f 6764 662c 0a20   onborder_gdf,. 
+000137f0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+00013800: 7574 7075 745f 6f6e 626f 7264 6572 5f70  utput_onborder_p
+00013810: 6174 682c 0a20 2020 2020 2020 2020 2020  ath,.           
+00013820: 2020 2020 206c 6179 6572 3d6f 7574 7075       layer=outpu
+00013830: 745f 6c61 7965 722c 0a20 2020 2020 2020  t_layer,.       
+00013840: 2020 2020 2020 2020 2066 6f72 6365 5f6d           force_m
+00013850: 756c 7469 7479 7065 3d54 7275 652c 0a20  ultitype=True,. 
+00013860: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00013870: 7265 6174 655f 7370 6174 6961 6c5f 696e  reate_spatial_in
+00013880: 6465 783d 4661 6c73 652c 0a20 2020 2020  dex=False,.     
+00013890: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+000138a0: 2020 6e6f 746f 6e62 6f72 6465 725f 6764    notonborder_gd
+000138b0: 6620 3d20 6469 7373 5f67 6466 5b7e 6469  f = diss_gdf[~di
+000138c0: 7373 5f67 6466 2e69 6e64 6578 2e69 7369  ss_gdf.index.isi
+000138d0: 6e28 6f6e 626f 7264 6572 5f67 6466 2e69  n(onborder_gdf.i
+000138e0: 6e64 6578 295d 0a20 2020 2020 2020 2069  ndex)].        i
+000138f0: 6620 6c65 6e28 6e6f 746f 6e62 6f72 6465  f len(notonborde
+00013900: 725f 6764 6629 203e 2030 3a0a 2020 2020  r_gdf) > 0:.    
+00013910: 2020 2020 2020 2020 2320 5573 6520 666f          # Use fo
+00013920: 7263 655f 6d75 6c74 6974 7970 652c 2074  rce_multitype, t
+00013930: 6f20 6176 6f69 6420 7761 726e 696e 6773  o avoid warnings
+00013940: 2077 6865 6e20 736f 6d65 2062 6174 6368   when some batch
+00013950: 6573 2063 6f6e 7461 696e 0a20 2020 2020  es contain.     
+00013960: 2020 2020 2020 2023 2073 696e 676c 6574         # singlet
+00013970: 7970 6520 616e 6420 736f 6d65 2063 6f6e  ype and some con
+00013980: 7461 696e 206d 756c 7469 7479 7065 2067  tain multitype g
+00013990: 656f 6d65 7472 6965 730a 2020 2020 2020  eometries.      
+000139a0: 2020 2020 2020 6766 6f2e 746f 5f66 696c        gfo.to_fil
+000139b0: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
+000139c0: 2020 206e 6f74 6f6e 626f 7264 6572 5f67     notonborder_g
+000139d0: 6466 2c0a 2020 2020 2020 2020 2020 2020  df,.            
+000139e0: 2020 2020 6f75 7470 7574 5f6e 6f74 6f6e      output_noton
+000139f0: 626f 7264 6572 5f70 6174 682c 0a20 2020  border_path,.   
+00013a00: 2020 2020 2020 2020 2020 2020 206c 6179               lay
+00013a10: 6572 3d6f 7574 7075 745f 6c61 7965 722c  er=output_layer,
+00013a20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013a30: 2066 6f72 6365 5f6d 756c 7469 7479 7065   force_multitype
+00013a40: 3d54 7275 652c 0a20 2020 2020 2020 2020  =True,.         
+00013a50: 2020 2020 2020 2069 6e64 6578 3d46 616c         index=Fal
+00013a60: 7365 2c0a 2020 2020 2020 2020 2020 2020  se,.            
+00013a70: 2020 2020 6372 6561 7465 5f73 7061 7469      create_spati
+00013a80: 616c 5f69 6e64 6578 3d46 616c 7365 2c0a  al_index=False,.
+00013a90: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00013aa0: 2020 7065 7266 696e 666f 5b22 7469 6d65    perfinfo["time
+00013ab0: 5f74 6f5f 6669 6c65 225d 203d 2028 6461  _to_file"] = (da
+00013ac0: 7465 7469 6d65 2e6e 6f77 2829 202d 2073  tetime.now() - s
+00013ad0: 7461 7274 5f74 6f5f 6669 6c65 292e 746f  tart_to_file).to
+00013ae0: 7461 6c5f 7365 636f 6e64 7328 290a 0a20  tal_seconds().. 
+00013af0: 2020 2023 2046 696e 616c 6973 652e 2e2e     # Finalise...
+00013b00: 0a20 2020 206d 6573 7361 6765 203d 2066  .    message = f
+00013b10: 2264 6973 736f 6c76 655f 706f 6c79 676f  "dissolve_polygo
+00013b20: 6e73 3a20 7265 6164 7920 696e 207b 6461  ns: ready in {da
+00013b30: 7465 7469 6d65 2e6e 6f77 2829 2d73 7461  tetime.now()-sta
+00013b40: 7274 5f74 696d 657d 206f 6e20 7b69 6e70  rt_time} on {inp
+00013b50: 7574 5f70 6174 687d 220a 2020 2020 6c6f  ut_path}".    lo
+00013b60: 6767 6572 2e64 6562 7567 286d 6573 7361  gger.debug(messa
+00013b70: 6765 290a 0a20 2020 2023 2043 6f6c 6c65  ge)..    # Colle
+00013b80: 6374 2070 6572 6669 6e66 6f0a 2020 2020  ct perfinfo.    
+00013b90: 746f 7461 6c5f 7065 7266 5f74 696d 6520  total_perf_time 
+00013ba0: 3d20 302e 300a 2020 2020 7065 7266 7374  = 0.0.    perfst
+00013bb0: 7269 6e67 203d 2022 220a 2020 2020 666f  ring = "".    fo
+00013bc0: 7220 7065 7266 636f 6465 2069 6e20 7065  r perfcode in pe
+00013bd0: 7266 696e 666f 3a0a 2020 2020 2020 2020  rfinfo:.        
+00013be0: 746f 7461 6c5f 7065 7266 5f74 696d 6520  total_perf_time 
+00013bf0: 2b3d 2070 6572 6669 6e66 6f5b 7065 7266  += perfinfo[perf
+00013c00: 636f 6465 5d0a 2020 2020 2020 2020 7065  code].        pe
+00013c10: 7266 7374 7269 6e67 202b 3d20 6622 7b70  rfstring += f"{p
+00013c20: 6572 6663 6f64 657d 3a20 7b70 6572 6669  erfcode}: {perfi
+00013c30: 6e66 6f5b 7065 7266 636f 6465 5d3a 2e32  nfo[perfcode]:.2
+00013c40: 667d 2c20 220a 2020 2020 7265 7475 726e  f}, ".    return
+00013c50: 5f69 6e66 6f5b 2274 6f74 616c 5f74 696d  _info["total_tim
+00013c60: 6522 5d20 3d20 2864 6174 6574 696d 652e  e"] = (datetime.
+00013c70: 6e6f 7728 2920 2d20 7374 6172 745f 7469  now() - start_ti
+00013c80: 6d65 292e 746f 7461 6c5f 7365 636f 6e64  me).total_second
+00013c90: 7328 290a 2020 2020 7065 7266 696e 666f  s().    perfinfo
+00013ca0: 5b22 756e 6163 636f 756e 7465 6422 5d20  ["unaccounted"] 
+00013cb0: 3d20 280a 2020 2020 2020 2020 7265 7475  = (.        retu
+00013cc0: 726e 5f69 6e66 6f5b 2274 6f74 616c 5f74  rn_info["total_t
+00013cd0: 696d 6522 5d20 2d20 746f 7461 6c5f 7065  ime"] - total_pe
+00013ce0: 7266 5f74 696d 6520 2023 2074 7970 653a  rf_time  # type:
+00013cf0: 2069 676e 6f72 655b 6f70 6572 6174 6f72   ignore[operator
+00013d00: 5d0a 2020 2020 290a 2020 2020 7065 7266  ].    ).    perf
+00013d10: 7374 7269 6e67 202b 3d20 6622 756e 6163  string += f"unac
+00013d20: 636f 756e 7465 643a 207b 7065 7266 696e  counted: {perfin
+00013d30: 666f 5b27 756e 6163 636f 756e 7465 6427  fo['unaccounted'
+00013d40: 5d3a 2e32 667d 220a 0a20 2020 2023 2052  ]:.2f}"..    # R
+00013d50: 6574 7572 6e0a 2020 2020 7265 7475 726e  eturn.    return
+00013d60: 5f69 6e66 6f5b 2270 6572 6669 6e66 6f22  _info["perfinfo"
+00013d70: 5d20 3d20 7065 7266 696e 666f 0a20 2020  ] = perfinfo.   
+00013d80: 2072 6574 7572 6e5f 696e 666f 5b22 7065   return_info["pe
+00013d90: 7266 7374 7269 6e67 225d 203d 2070 6572  rfstring"] = per
+00013da0: 6673 7472 696e 670a 2020 2020 7265 7475  fstring.    retu
+00013db0: 726e 5f69 6e66 6f5b 226d 6573 7361 6765  rn_info["message
+00013dc0: 225d 203d 206d 6573 7361 6765 0a20 2020  "] = message.   
+00013dd0: 2072 6574 7572 6e20 7265 7475 726e 5f69   return return_i
+00013de0: 6e66 6f0a 0a0a 6465 6620 5f64 6973 736f  nfo...def _disso
+00013df0: 6c76 6528 0a20 2020 2064 663a 2067 7064  lve(.    df: gpd
+00013e00: 2e47 656f 4461 7461 4672 616d 652c 0a20  .GeoDataFrame,. 
+00013e10: 2020 2062 793d 4e6f 6e65 2c0a 2020 2020     by=None,.    
+00013e20: 6167 6766 756e 633a 204f 7074 696f 6e61  aggfunc: Optiona
+00013e30: 6c5b 556e 696f 6e5b 7374 722c 2064 6963  l[Union[str, dic
+00013e40: 745d 5d20 3d20 2266 6972 7374 222c 0a20  t]] = "first",. 
+00013e50: 2020 2061 735f 696e 6465 783d 5472 7565     as_index=True
+00013e60: 2c0a 2020 2020 6c65 7665 6c3d 4e6f 6e65  ,.    level=None
+00013e70: 2c0a 2020 2020 736f 7274 3d54 7275 652c  ,.    sort=True,
+00013e80: 0a20 2020 206f 6273 6572 7665 643d 4661  .    observed=Fa
+00013e90: 6c73 652c 0a20 2020 2064 726f 706e 613d  lse,.    dropna=
+00013ea0: 5472 7565 2c0a 2920 2d3e 2067 7064 2e47  True,.) -> gpd.G
+00013eb0: 656f 4461 7461 4672 616d 653a 0a20 2020  eoDataFrame:.   
+00013ec0: 2022 2222 0a20 2020 2044 6973 736f 6c76   """.    Dissolv
+00013ed0: 6520 6765 6f6d 6574 7269 6573 2077 6974  e geometries wit
+00013ee0: 6869 6e20 6067 726f 7570 6279 6020 696e  hin `groupby` in
+00013ef0: 746f 2073 696e 676c 6520 6f62 7365 7276  to single observ
+00013f00: 6174 696f 6e2e 0a0a 2020 2020 5468 6973  ation...    This
+00013f10: 2069 7320 6163 636f 6d70 6c69 7368 6564   is accomplished
+00013f20: 2062 7920 6170 706c 7969 6e67 2074 6865   by applying the
+00013f30: 2060 756e 6172 795f 756e 696f 6e60 206d   `unary_union` m
+00013f40: 6574 686f 640a 2020 2020 746f 2061 6c6c  ethod.    to all
+00013f50: 2067 656f 6d65 7472 6965 7320 7769 7468   geometries with
+00013f60: 696e 2061 2067 726f 7570 7365 6c66 2e0a  in a groupself..
+00013f70: 2020 2020 4f62 7365 7276 6174 696f 6e73      Observations
+00013f80: 2061 7373 6f63 6961 7465 6420 7769 7468   associated with
+00013f90: 2065 6163 6820 6067 726f 7570 6279 6020   each `groupby` 
+00013fa0: 6772 6f75 7020 7769 6c6c 2062 6520 6167  group will be ag
+00013fb0: 6772 6567 6174 6564 0a20 2020 2075 7369  gregated.    usi
+00013fc0: 6e67 2074 6865 2060 6167 6766 756e 6360  ng the `aggfunc`
+00013fd0: 2e0a 2020 2020 5061 7261 6d65 7465 7273  ..    Parameters
+00013fe0: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
+00013ff0: 2020 2020 6279 203a 2073 7472 696e 672c      by : string,
+00014000: 2064 6566 6175 6c74 204e 6f6e 650a 2020   default None.  
+00014010: 2020 2020 2020 436f 6c75 6d6e 2077 686f        Column who
+00014020: 7365 2076 616c 7565 7320 6465 6669 6e65  se values define
+00014030: 2067 726f 7570 7320 746f 2062 6520 6469   groups to be di
+00014040: 7373 6f6c 7665 642e 2049 6620 4e6f 6e65  ssolved. If None
+00014050: 2c0a 2020 2020 2020 2020 7768 6f6c 6520  ,.        whole 
+00014060: 4765 6f44 6174 6146 7261 6d65 2069 7320  GeoDataFrame is 
+00014070: 636f 6e73 6964 6572 6564 2061 2073 696e  considered a sin
+00014080: 676c 6520 6772 6f75 702e 0a20 2020 2061  gle group..    a
+00014090: 6767 6675 6e63 203a 2066 756e 6374 696f  ggfunc : functio
+000140a0: 6e2c 2073 7472 696e 6720 6f72 2064 6963  n, string or dic
+000140b0: 742c 2064 6566 6175 6c74 2022 6669 7273  t, default "firs
+000140c0: 7422 0a20 2020 2020 2020 2041 6767 7265  t".        Aggre
+000140d0: 6761 7469 6f6e 2066 756e 6374 696f 6e20  gation function 
+000140e0: 666f 7220 6d61 6e69 7075 6c61 7469 6f6e  for manipulation
+000140f0: 206f 6620 6461 7461 2061 7373 6f63 6961   of data associa
+00014100: 7465 640a 2020 2020 2020 2020 7769 7468  ted.        with
+00014110: 2065 6163 6820 6772 6f75 702e 2050 6173   each group. Pas
+00014120: 7365 6420 746f 2070 616e 6461 7320 6067  sed to pandas `g
+00014130: 726f 7570 6279 2e61 6767 6020 6d65 7468  roupby.agg` meth
+00014140: 6f64 2e0a 2020 2020 6173 5f69 6e64 6578  od..    as_index
+00014150: 203a 2062 6f6f 6c65 616e 2c20 6465 6661   : boolean, defa
+00014160: 756c 7420 5472 7565 0a20 2020 2020 2020  ult True.       
+00014170: 2049 6620 7472 7565 2c20 6772 6f75 7062   If true, groupb
+00014180: 7920 636f 6c75 6d6e 7320 6265 636f 6d65  y columns become
+00014190: 2069 6e64 6578 206f 6620 7265 7375 6c74   index of result
+000141a0: 2e0a 2020 2020 6c65 7665 6c20 3a20 696e  ..    level : in
+000141b0: 7420 6f72 2073 7472 206f 7220 7365 7175  t or str or sequ
+000141c0: 656e 6365 206f 6620 696e 7420 6f72 2073  ence of int or s
+000141d0: 6571 7565 6e63 6520 6f66 2073 7472 2c20  equence of str, 
+000141e0: 6465 6661 756c 7420 4e6f 6e65 0a20 2020  default None.   
+000141f0: 2020 2020 2049 6620 7468 6520 6178 6973       If the axis
+00014200: 2069 7320 6120 4d75 6c74 6949 6e64 6578   is a MultiIndex
+00014210: 2028 6869 6572 6172 6368 6963 616c 292c   (hierarchical),
+00014220: 2067 726f 7570 2062 7920 610a 2020 2020   group by a.    
+00014230: 2020 2020 7061 7274 6963 756c 6172 206c      particular l
+00014240: 6576 656c 206f 7220 6c65 7665 6c73 2e0a  evel or levels..
+00014250: 2020 2020 2020 2020 2e2e 2076 6572 7369          .. versi
+00014260: 6f6e 6164 6465 643a 3a20 302e 392e 300a  onadded:: 0.9.0.
+00014270: 2020 2020 736f 7274 203a 2062 6f6f 6c2c      sort : bool,
+00014280: 2064 6566 6175 6c74 2054 7275 650a 2020   default True.  
+00014290: 2020 2020 2020 536f 7274 2067 726f 7570        Sort group
+000142a0: 206b 6579 732e 2047 6574 2062 6574 7465   keys. Get bette
+000142b0: 7220 7065 7266 6f72 6d61 6e63 6520 6279  r performance by
+000142c0: 2074 7572 6e69 6e67 2074 6869 7320 6f66   turning this of
+000142d0: 662e 0a20 2020 2020 2020 204e 6f74 6520  f..        Note 
+000142e0: 7468 6973 2064 6f65 7320 6e6f 7420 696e  this does not in
+000142f0: 666c 7565 6e63 6520 7468 6520 6f72 6465  fluence the orde
+00014300: 7220 6f66 206f 6273 6572 7661 7469 6f6e  r of observation
+00014310: 7320 7769 7468 696e 0a20 2020 2020 2020  s within.       
+00014320: 2065 6163 6820 6772 6f75 702e 2047 726f   each group. Gro
+00014330: 7570 6279 2070 7265 7365 7276 6573 2074  upby preserves t
+00014340: 6865 206f 7264 6572 206f 6620 726f 7773  he order of rows
+00014350: 2077 6974 6869 6e20 6561 6368 2067 726f   within each gro
+00014360: 7570 2e0a 2020 2020 2020 2020 2e2e 2076  up..        .. v
+00014370: 6572 7369 6f6e 6164 6465 643a 3a20 302e  ersionadded:: 0.
+00014380: 392e 300a 2020 2020 6f62 7365 7276 6564  9.0.    observed
+00014390: 203a 2062 6f6f 6c2c 2064 6566 6175 6c74   : bool, default
+000143a0: 2046 616c 7365 0a20 2020 2020 2020 2054   False.        T
+000143b0: 6869 7320 6f6e 6c79 2061 7070 6c69 6573  his only applies
+000143c0: 2069 6620 616e 7920 6f66 2074 6865 2067   if any of the g
+000143d0: 726f 7570 6572 7320 6172 6520 4361 7465  roupers are Cate
+000143e0: 676f 7269 6361 6c73 2e0a 2020 2020 2020  goricals..      
+000143f0: 2020 4966 2054 7275 653a 206f 6e6c 7920    If True: only 
+00014400: 7368 6f77 206f 6273 6572 7665 6420 7661  show observed va
+00014410: 6c75 6573 2066 6f72 2063 6174 6567 6f72  lues for categor
+00014420: 6963 616c 2067 726f 7570 6572 732e 0a20  ical groupers.. 
+00014430: 2020 2020 2020 2049 6620 4661 6c73 653a         If False:
+00014440: 2073 686f 7720 616c 6c20 7661 6c75 6573   show all values
+00014450: 2066 6f72 2063 6174 6567 6f72 6963 616c   for categorical
+00014460: 2067 726f 7570 6572 732e 0a20 2020 2020   groupers..     
+00014470: 2020 202e 2e20 7665 7273 696f 6e61 6464     .. versionadd
+00014480: 6564 3a3a 2030 2e39 2e30 0a20 2020 2064  ed:: 0.9.0.    d
+00014490: 726f 706e 6120 3a20 626f 6f6c 2c20 6465  ropna : bool, de
+000144a0: 6661 756c 7420 5472 7565 0a20 2020 2020  fault True.     
+000144b0: 2020 2049 6620 5472 7565 2c20 616e 6420     If True, and 
+000144c0: 6966 2067 726f 7570 206b 6579 7320 636f  if group keys co
+000144d0: 6e74 6169 6e20 4e41 2076 616c 7565 732c  ntain NA values,
+000144e0: 204e 4120 7661 6c75 6573 0a20 2020 2020   NA values.     
+000144f0: 2020 2074 6f67 6574 6865 7220 7769 7468     together with
+00014500: 2072 6f77 2f63 6f6c 756d 6e20 7769 6c6c   row/column will
+00014510: 2062 6520 6472 6f70 7065 642e 2049 6620   be dropped. If 
+00014520: 4661 6c73 652c 204e 410a 2020 2020 2020  False, NA.      
+00014530: 2020 7661 6c75 6573 2077 696c 6c20 616c    values will al
+00014540: 736f 2062 6520 7472 6561 7465 6420 6173  so be treated as
+00014550: 2074 6865 206b 6579 2069 6e20 6772 6f75   the key in grou
+00014560: 7073 2e0a 2020 2020 2020 2020 5468 6973  ps..        This
+00014570: 2070 6172 616d 6574 6572 2069 7320 6e6f   parameter is no
+00014580: 7420 7375 7070 6f72 7465 6420 666f 7220  t supported for 
+00014590: 7061 6e64 6173 203c 2031 2e31 2e30 2e0a  pandas < 1.1.0..
+000145a0: 2020 2020 2020 2020 4120 7761 726e 696e          A warnin
+000145b0: 6720 7769 6c6c 2062 6520 656d 6974 7465  g will be emitte
+000145c0: 6420 666f 7220 6561 726c 6965 7220 7061  d for earlier pa
+000145d0: 6e64 6173 2076 6572 7369 6f6e 730a 2020  ndas versions.  
+000145e0: 2020 2020 2020 6966 2061 206e 6f6e 2d64        if a non-d
+000145f0: 6566 6175 6c74 2076 616c 7565 2069 7320  efault value is 
+00014600: 6769 7665 6e20 666f 7220 7468 6973 2070  given for this p
+00014610: 6172 616d 6574 6572 2e0a 2020 2020 2020  arameter..      
+00014620: 2020 2e2e 2076 6572 7369 6f6e 6164 6465    .. versionadde
+00014630: 643a 3a20 302e 392e 300a 0a20 2020 2052  d:: 0.9.0..    R
+00014640: 6574 7572 6e73 3a0a 2020 2020 2d2d 2d2d  eturns:.    ----
+00014650: 2d2d 2d0a 2020 2020 4765 6f44 6174 6146  ---.    GeoDataF
+00014660: 7261 6d65 0a0a 2020 2020 4578 616d 706c  rame..    Exampl
+00014670: 6573 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d  es:.    --------
+00014680: 0a20 2020 203e 3e3e 2066 726f 6d20 7368  .    >>> from sh
+00014690: 6170 656c 792e 6765 6f6d 6574 7279 2069  apely.geometry i
+000146a0: 6d70 6f72 7420 506f 696e 740a 2020 2020  mport Point.    
+000146b0: 3e3e 3e20 6420 3d20 7b0a 2020 2020 2e2e  >>> d = {.    ..
+000146c0: 2e20 2020 2020 2263 6f6c 3122 3a20 5b22  .     "col1": ["
+000146d0: 6e61 6d65 3122 2c20 226e 616d 6532 222c  name1", "name2",
+000146e0: 2022 6e61 6d65 3122 5d2c 0a20 2020 202e   "name1"],.    .
+000146f0: 2e2e 2020 2020 2022 6765 6f6d 6574 7279  ..     "geometry
+00014700: 223a 205b 506f 696e 7428 312c 2032 292c  ": [Point(1, 2),
+00014710: 2050 6f69 6e74 2832 2c20 3129 2c20 506f   Point(2, 1), Po
+00014720: 696e 7428 302c 2031 295d 2c0a 2020 2020  int(0, 1)],.    
+00014730: 2e2e 2e20 7d0a 2020 2020 3e3e 3e20 6764  ... }.    >>> gd
+00014740: 6620 3d20 6765 6f70 616e 6461 732e 4765  f = geopandas.Ge
+00014750: 6f44 6174 6146 7261 6d65 2864 2c20 6372  oDataFrame(d, cr
+00014760: 733d 3433 3236 290a 2020 2020 3e3e 3e20  s=4326).    >>> 
+00014770: 6764 660a 2020 2020 2020 2020 636f 6c31  gdf.        col1
+00014780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014790: 2067 656f 6d65 7472 790a 2020 2020 3020   geometry.    0 
+000147a0: 206e 616d 6531 2020 504f 494e 5420 2831   name1  POINT (1
+000147b0: 2e30 3030 3030 2032 2e30 3030 3030 290a  .00000 2.00000).
+000147c0: 2020 2020 3120 206e 616d 6532 2020 504f      1  name2  PO
+000147d0: 494e 5420 2832 2e30 3030 3030 2031 2e30  INT (2.00000 1.0
+000147e0: 3030 3030 290a 2020 2020 3220 206e 616d  0000).    2  nam
+000147f0: 6531 2020 504f 494e 5420 2830 2e30 3030  e1  POINT (0.000
+00014800: 3030 2031 2e30 3030 3030 290a 2020 2020  00 1.00000).    
+00014810: 3e3e 3e20 6469 7373 6f6c 7665 6420 3d20  >>> dissolved = 
+00014820: 6764 662e 6469 7373 6f6c 7665 2827 636f  gdf.dissolve('co
+00014830: 6c31 2729 0a20 2020 203e 3e3e 2064 6973  l1').    >>> dis
+00014840: 736f 6c76 6564 2020 2320 646f 6374 6573  solved  # doctes
+00014850: 743a 202b 534b 4950 0a20 2020 2020 2020  t: +SKIP.       
+00014860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014880: 2020 2020 2020 2020 2067 656f 6d65 7472           geometr
+00014890: 790a 2020 2020 636f 6c31 0a20 2020 206e  y.    col1.    n
+000148a0: 616d 6531 2020 4d55 4c54 4950 4f49 4e54  ame1  MULTIPOINT
+000148b0: 2028 302e 3030 3030 3020 312e 3030 3030   (0.00000 1.0000
+000148c0: 302c 2031 2e30 3030 3030 2032 2e30 3030  0, 1.00000 2.000
+000148d0: 3030 290a 2020 2020 6e61 6d65 3220 2020  00).    name2   
+000148e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000148f0: 2020 2020 2050 4f49 4e54 2028 322e 3030       POINT (2.00
+00014900: 3030 3020 312e 3030 3030 3029 0a0a 2020  000 1.00000)..  
+00014910: 2020 5365 6520 416c 736f 3a0a 2020 2020    See Also:.    
+00014920: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2047 656f  --------.    Geo
+00014930: 4461 7461 4672 616d 652e 6578 706c 6f64  DataFrame.explod
+00014940: 6520 3a20 6578 706c 6f64 6520 6d75 6c74  e : explode mult
+00014950: 692d 7061 7274 2067 656f 6d65 7472 6965  i-part geometrie
+00014960: 7320 696e 746f 2073 696e 676c 6520 6765  s into single ge
+00014970: 6f6d 6574 7269 6573 0a20 2020 2022 2222  ometries.    """
+00014980: 0a20 2020 2069 6620 6279 2069 7320 4e6f  .    if by is No
+00014990: 6e65 2061 6e64 206c 6576 656c 2069 7320  ne and level is 
+000149a0: 4e6f 6e65 3a0a 2020 2020 2020 2020 6279  None:.        by
+000149b0: 5f6c 6f63 616c 203d 206e 702e 7a65 726f  _local = np.zero
+000149c0: 7328 6c65 6e28 6466 292c 2064 7479 7065  s(len(df), dtype
+000149d0: 3d22 696e 7436 3422 290a 2020 2020 656c  ="int64").    el
+000149e0: 7365 3a0a 2020 2020 2020 2020 6279 5f6c  se:.        by_l
+000149f0: 6f63 616c 203d 2062 790a 0a20 2020 2067  ocal = by..    g
+00014a00: 726f 7570 6279 5f6b 7761 7267 7320 3d20  roupby_kwargs = 
+00014a10: 7b0a 2020 2020 2020 2020 2262 7922 3a20  {.        "by": 
+00014a20: 6279 5f6c 6f63 616c 2c0a 2020 2020 2020  by_local,.      
+00014a30: 2020 226c 6576 656c 223a 206c 6576 656c    "level": level
+00014a40: 2c0a 2020 2020 2020 2020 2273 6f72 7422  ,.        "sort"
+00014a50: 3a20 736f 7274 2c0a 2020 2020 2020 2020  : sort,.        
+00014a60: 226f 6273 6572 7665 6422 3a20 6f62 7365  "observed": obse
+00014a70: 7276 6564 2c0a 2020 2020 2020 2020 2264  rved,.        "d
+00014a80: 726f 706e 6122 3a20 6472 6f70 6e61 2c0a  ropna": dropna,.
+00014a90: 2020 2020 7d0a 2020 2020 2222 220a 2020      }.    """.  
+00014aa0: 2020 6966 206e 6f74 2063 6f6d 7061 742e    if not compat.
+00014ab0: 5041 4e44 4153 5f47 455f 3131 3a0a 2020  PANDAS_GE_11:.  
+00014ac0: 2020 2020 2020 6772 6f75 7062 795f 6b77        groupby_kw
+00014ad0: 6172 6773 2e70 6f70 2822 6472 6f70 6e61  args.pop("dropna
+00014ae0: 2229 0a0a 2020 2020 2020 2020 6966 206e  ")..        if n
+00014af0: 6f74 2064 726f 706e 613a 2020 2320 4966  ot dropna:  # If
+00014b00: 2074 6865 7920 7061 7373 6564 2061 206e   they passed a n
+00014b10: 6f6e 2d64 6566 6175 6c74 2064 726f 706e  on-default dropn
+00014b20: 6120 7661 6c75 650a 2020 2020 2020 2020  a value.        
+00014b30: 2020 2020 7761 726e 696e 6773 2e77 6172      warnings.war
+00014b40: 6e28 2264 726f 706e 6120 6b77 6172 6720  n("dropna kwarg 
+00014b50: 6973 206e 6f74 2073 7570 706f 7274 6564  is not supported
+00014b60: 2066 6f72 2070 616e 6461 7320 3c20 312e   for pandas < 1.
+00014b70: 312e 3022 290a 2020 2020 2222 220a 0a20  1.0").    """.. 
+00014b80: 2020 2023 2050 726f 6365 7373 206e 6f6e     # Process non
+00014b90: 2d73 7061 7469 616c 2063 6f6d 706f 6e65  -spatial compone
+00014ba0: 6e74 0a20 2020 2064 6174 6120 3d20 7064  nt.    data = pd
+00014bb0: 2e44 6174 6146 7261 6d65 2864 662e 6472  .DataFrame(df.dr
+00014bc0: 6f70 2863 6f6c 756d 6e73 3d64 662e 6765  op(columns=df.ge
+00014bd0: 6f6d 6574 7279 2e6e 616d 6529 290a 0a20  ometry.name)).. 
+00014be0: 2020 2069 6620 6167 6766 756e 6320 6973     if aggfunc is
+00014bf0: 206e 6f74 204e 6f6e 6520 616e 6420 6973   not None and is
+00014c00: 696e 7374 616e 6365 2861 6767 6675 6e63  instance(aggfunc
+00014c10: 2c20 6469 6374 2920 616e 6420 2274 6f5f  , dict) and "to_
+00014c20: 6a73 6f6e 2220 696e 2061 6767 6675 6e63  json" in aggfunc
+00014c30: 3a0a 2020 2020 2020 2020 6167 675f 636f  :.        agg_co
+00014c40: 6c75 6d6e 7320 3d20 6c69 7374 2873 6574  lumns = list(set
+00014c50: 2861 6767 6675 6e63 5b22 746f 5f6a 736f  (aggfunc["to_jso
+00014c60: 6e22 5d29 290a 2020 2020 2020 2020 6167  n"])).        ag
+00014c70: 675f 6461 7461 203d 2028 0a20 2020 2020  g_data = (.     
+00014c80: 2020 2020 2020 2064 6174 612e 6772 6f75         data.grou
+00014c90: 7062 7928 2a2a 6772 6f75 7062 795f 6b77  pby(**groupby_kw
+00014ca0: 6172 6773 290a 2020 2020 2020 2020 2020  args).          
+00014cb0: 2020 2e61 7070 6c79 286c 616d 6264 6120    .apply(lambda 
+00014cc0: 673a 2067 5b61 6767 5f63 6f6c 756d 6e73  g: g[agg_columns
+00014cd0: 5d2e 746f 5f6a 736f 6e28 6f72 6965 6e74  ].to_json(orient
+00014ce0: 3d22 7265 636f 7264 7322 2929 0a20 2020  ="records")).   
+00014cf0: 2020 2020 2020 2020 202e 746f 5f66 7261           .to_fra
+00014d00: 6d65 286e 616d 653d 225f 5f44 4953 534f  me(name="__DISSO
+00014d10: 4c56 455f 544f 4a53 4f4e 2229 0a20 2020  LVE_TOJSON").   
+00014d20: 2020 2020 2029 0a20 2020 2065 6c69 6620       ).    elif 
+00014d30: 6973 696e 7374 616e 6365 2861 6767 6675  isinstance(aggfu
+00014d40: 6e63 2c20 7374 7229 2061 6e64 2061 6767  nc, str) and agg
+00014d50: 6675 6e63 203d 3d20 226d 6572 6765 5f6a  func == "merge_j
+00014d60: 736f 6e5f 6c69 7374 7322 3a0a 2020 2020  son_lists":.    
+00014d70: 2020 2020 2320 4d65 7267 6520 616e 6420      # Merge and 
+00014d80: 666c 6174 7465 6e20 7468 6520 6a73 6f6e  flatten the json
+00014d90: 206c 6973 7473 2069 6e20 7468 6520 6772   lists in the gr
+00014da0: 6f75 7073 0a20 2020 2020 2020 2064 6566  oups.        def
+00014db0: 2067 726f 7570 5f66 6c61 7474 656e 5f6a   group_flatten_j
+00014dc0: 736f 6e5f 6c69 7374 2867 293a 0a20 2020  son_list(g):.   
+00014dd0: 2020 2020 2020 2020 2023 2045 7661 6c75           # Evalu
+00014de0: 6174 6520 616c 6c20 6772 6f75 7065 6420  ate all grouped 
+00014df0: 726f 7773 2074 6f20 6a73 6f6e 206f 626a  rows to json obj
+00014e00: 6563 7473 2e20 5468 6973 2072 6573 756c  ects. This resul
+00014e10: 7473 2069 6e20 6120 6c69 7374 206f 660a  ts in a list of.
+00014e20: 2020 2020 2020 2020 2020 2020 2320 6c69              # li
+00014e30: 7374 7320 6f66 206a 736f 6e20 6f62 6a65  sts of json obje
+00014e40: 6374 732e 0a20 2020 2020 2020 2020 2020  cts..           
+00014e50: 206a 736f 6e5f 6e65 7374 6564 5f6c 6973   json_nested_lis
+00014e60: 7473 203d 205b 0a20 2020 2020 2020 2020  ts = [.         
+00014e70: 2020 2020 2020 206a 736f 6e2e 6c6f 6164         json.load
+00014e80: 7328 6a73 6f6e 5f76 616c 7565 7329 2066  s(json_values) f
+00014e90: 6f72 206a 736f 6e5f 7661 6c75 6573 2069  or json_values i
+00014ea0: 6e20 675b 225f 5f44 4953 534f 4c56 455f  n g["__DISSOLVE_
+00014eb0: 544f 4a53 4f4e 225d 0a20 2020 2020 2020  TOJSON"].       
+00014ec0: 2020 2020 205d 0a0a 2020 2020 2020 2020       ]..        
+00014ed0: 2020 2020 2320 4578 7472 6163 7420 7468      # Extract th
+00014ee0: 6520 726f 7773 2066 726f 6d20 7468 6520  e rows from the 
+00014ef0: 6e65 7374 6564 206c 6973 7473 202b 2070  nested lists + p
+00014f00: 7574 2069 6e20 6120 666c 6174 206c 6973  ut in a flat lis
+00014f10: 7420 6173 2073 7472 696e 6773 0a20 2020  t as strings.   
+00014f20: 2020 2020 2020 2020 206a 736f 6e73 7472           jsonstr
+00014f30: 5f66 6c61 7420 3d20 5b0a 2020 2020 2020  _flat = [.      
+00014f40: 2020 2020 2020 2020 2020 6a73 6f6e 2e64            json.d
+00014f50: 756d 7073 286a 736f 6e5f 7661 6c75 6529  umps(json_value)
+00014f60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014f70: 2066 6f72 206a 736f 6e5f 7661 6c75 6573   for json_values
+00014f80: 2069 6e20 6a73 6f6e 5f6e 6573 7465 645f   in json_nested_
+00014f90: 6c69 7374 730a 2020 2020 2020 2020 2020  lists.          
+00014fa0: 2020 2020 2020 666f 7220 6a73 6f6e 5f76        for json_v
+00014fb0: 616c 7565 2069 6e20 6a73 6f6e 5f76 616c  alue in json_val
+00014fc0: 7565 730a 2020 2020 2020 2020 2020 2020  ues.            
+00014fd0: 5d0a 0a20 2020 2020 2020 2020 2020 2023  ]..            #
+00014fe0: 2052 656d 6f76 6520 6475 706c 6963 6174   Remove duplicat
+00014ff0: 6573 0a20 2020 2020 2020 2020 2020 206a  es.            j
+00015000: 736f 6e73 7374 725f 6469 7374 696e 6374  sonsstr_distinct
+00015010: 203d 2073 6574 286a 736f 6e73 7472 5f66   = set(jsonstr_f
+00015020: 6c61 7429 0a0a 2020 2020 2020 2020 2020  lat)..          
+00015030: 2020 2320 436f 6e76 6572 7420 7468 6520    # Convert the 
+00015040: 6461 7461 2061 6761 696e 2074 6f20 6120  data again to a 
+00015050: 6c69 7374 206f 6620 6a73 6f6e 206f 626a  list of json obj
+00015060: 6563 7473 0a20 2020 2020 2020 2020 2020  ects.           
+00015070: 206a 736f 6e5f 6469 7374 696e 6374 203d   json_distinct =
+00015080: 205b 6a73 6f6e 2e6c 6f61 6473 286a 736f   [json.loads(jso
+00015090: 6e5f 7661 6c75 6529 2066 6f72 206a 736f  n_value) for jso
+000150a0: 6e5f 7661 6c75 6520 696e 206a 736f 6e73  n_value in jsons
+000150b0: 7374 725f 6469 7374 696e 6374 5d0a 0a20  str_distinct].. 
+000150c0: 2020 2020 2020 2020 2020 2023 2052 6574             # Ret
+000150d0: 7572 6e20 6173 206a 736f 6e20 7374 7269  urn as json stri
+000150e0: 6e67 0a20 2020 2020 2020 2020 2020 2072  ng.            r
+000150f0: 6574 7572 6e20 6a73 6f6e 2e64 756d 7073  eturn json.dumps
+00015100: 286a 736f 6e5f 6469 7374 696e 6374 290a  (json_distinct).
+00015110: 0a20 2020 2020 2020 2061 6767 5f64 6174  .        agg_dat
+00015120: 6120 3d20 280a 2020 2020 2020 2020 2020  a = (.          
+00015130: 2020 6461 7461 2e67 726f 7570 6279 282a    data.groupby(*
+00015140: 2a67 726f 7570 6279 5f6b 7761 7267 7329  *groupby_kwargs)
+00015150: 0a20 2020 2020 2020 2020 2020 202e 6170  .            .ap
+00015160: 706c 7928 6c61 6d62 6461 2067 3a20 6772  ply(lambda g: gr
+00015170: 6f75 705f 666c 6174 7465 6e5f 6a73 6f6e  oup_flatten_json
+00015180: 5f6c 6973 7428 6729 290a 2020 2020 2020  _list(g)).      
+00015190: 2020 2020 2020 2e74 6f5f 6672 616d 6528        .to_frame(
+000151a0: 6e61 6d65 3d22 5f5f 4449 5353 4f4c 5645  name="__DISSOLVE
+000151b0: 5f54 4f4a 534f 4e22 290a 2020 2020 2020  _TOJSON").      
+000151c0: 2020 290a 2020 2020 656c 7365 3a0a 2020    ).    else:.  
+000151d0: 2020 2020 2020 6167 675f 6461 7461 203d        agg_data =
+000151e0: 2064 6174 612e 6772 6f75 7062 7928 2a2a   data.groupby(**
+000151f0: 6772 6f75 7062 795f 6b77 6172 6773 292e  groupby_kwargs).
+00015200: 6167 6728 6167 6766 756e 6329 2020 2320  agg(aggfunc)  # 
+00015210: 7479 7065 3a20 6967 6e6f 7265 5b61 7267  type: ignore[arg
+00015220: 2d74 7970 655d 0a20 2020 2020 2020 2023  -type].        #
+00015230: 2043 6865 636b 2069 6620 616c 6c20 636f   Check if all co
+00015240: 6c75 6d6e 7320 7765 7265 2070 726f 7065  lumns were prope
+00015250: 726c 7920 6167 6772 6567 6174 6564 0a20  rly aggregated. 
+00015260: 2020 2020 2020 2061 7373 6572 7420 6279         assert by
+00015270: 5f6c 6f63 616c 2069 7320 6e6f 7420 4e6f  _local is not No
+00015280: 6e65 0a20 2020 2020 2020 2063 6f6c 756d  ne.        colum
+00015290: 6e73 5f74 6f5f 6167 6720 3d20 5b63 6f6c  ns_to_agg = [col
+000152a0: 756d 6e20 666f 7220 636f 6c75 6d6e 2069  umn for column i
+000152b0: 6e20 6461 7461 2e63 6f6c 756d 6e73 2069  n data.columns i
+000152c0: 6620 636f 6c75 6d6e 206e 6f74 2069 6e20  f column not in 
+000152d0: 6279 5f6c 6f63 616c 5d0a 2020 2020 2020  by_local].      
+000152e0: 2020 6966 206c 656e 2863 6f6c 756d 6e73    if len(columns
+000152f0: 5f74 6f5f 6167 6729 2021 3d20 6c65 6e28  _to_agg) != len(
+00015300: 6167 675f 6461 7461 2e63 6f6c 756d 6e73  agg_data.columns
+00015310: 293a 0a20 2020 2020 2020 2020 2020 2064  ):.            d
+00015320: 726f 7070 6564 5f63 6f6c 756d 6e73 203d  ropped_columns =
+00015330: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
+00015340: 2020 2063 6f6c 756d 6e20 666f 7220 636f     column for co
+00015350: 6c75 6d6e 2069 6e20 636f 6c75 6d6e 735f  lumn in columns_
+00015360: 746f 5f61 6767 2069 6620 636f 6c75 6d6e  to_agg if column
+00015370: 206e 6f74 2069 6e20 6167 675f 6461 7461   not in agg_data
+00015380: 2e63 6f6c 756d 6e73 0a20 2020 2020 2020  .columns.       
+00015390: 2020 2020 205d 0a20 2020 2020 2020 2020       ].         
+000153a0: 2020 2072 6169 7365 2045 7863 6570 7469     raise Excepti
+000153b0: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
+000153c0: 2020 2020 6622 436f 6c75 6d6e 2873 2920      f"Column(s) 
+000153d0: 7b64 726f 7070 6564 5f63 6f6c 756d 6e73  {dropped_columns
+000153e0: 7d20 6172 6520 6e6f 7420 7375 7070 6f72  } are not suppor
+000153f0: 7465 6420 666f 7220 6167 6772 6567 6174  ted for aggregat
+00015400: 696f 6e2c 2073 746f 7022 0a20 2020 2020  ion, stop".     
+00015410: 2020 2020 2020 2029 0a0a 2020 2020 2320         )..    # 
+00015420: 5072 6f63 6573 7320 7370 6174 6961 6c20  Process spatial 
+00015430: 636f 6d70 6f6e 656e 740a 2020 2020 6465  component.    de
+00015440: 6620 6d65 7267 655f 6765 6f6d 6574 7269  f merge_geometri
+00015450: 6573 2862 6c6f 636b 293a 0a20 2020 2020  es(block):.     
+00015460: 2020 206d 6572 6765 645f 6765 6f6d 203d     merged_geom =
+00015470: 2062 6c6f 636b 2e75 6e61 7279 5f75 6e69   block.unary_uni
+00015480: 6f6e 0a20 2020 2020 2020 2072 6574 7572  on.        retur
+00015490: 6e20 6d65 7267 6564 5f67 656f 6d0a 0a20  n merged_geom.. 
+000154a0: 2020 2067 203d 2064 662e 6772 6f75 7062     g = df.groupb
+000154b0: 7928 6772 6f75 705f 6b65 7973 3d46 616c  y(group_keys=Fal
+000154c0: 7365 2c20 2a2a 6772 6f75 7062 795f 6b77  se, **groupby_kw
+000154d0: 6172 6773 295b 6466 2e67 656f 6d65 7472  args)[df.geometr
+000154e0: 792e 6e61 6d65 5d2e 6167 6728 0a20 2020  y.name].agg(.   
+000154f0: 2020 2020 206d 6572 6765 5f67 656f 6d65       merge_geome
+00015500: 7472 6965 730a 2020 2020 290a 0a20 2020  tries.    )..   
+00015510: 2023 2041 6767 7265 6761 7465 0a20 2020   # Aggregate.   
+00015520: 2061 6767 7265 6761 7465 645f 6765 6f6d   aggregated_geom
+00015530: 6574 7279 203d 2067 7064 2e47 656f 4461  etry = gpd.GeoDa
+00015540: 7461 4672 616d 6528 0a20 2020 2020 2020  taFrame(.       
+00015550: 2064 6174 613d 672c 2067 656f 6d65 7472   data=g, geometr
+00015560: 793d 6466 2e67 656f 6d65 7472 792e 6e61  y=df.geometry.na
+00015570: 6d65 2c20 6372 733d 6466 2e63 7273 0a20  me, crs=df.crs. 
+00015580: 2020 2029 0a20 2020 2023 2052 6563 6f6d     ).    # Recom
+00015590: 6269 6e65 0a20 2020 2061 6767 7265 6761  bine.    aggrega
+000155a0: 7465 6420 3d20 6167 6772 6567 6174 6564  ted = aggregated
+000155b0: 5f67 656f 6d65 7472 792e 6a6f 696e 2861  _geometry.join(a
+000155c0: 6767 5f64 6174 6129 0a0a 2020 2020 2320  gg_data)..    # 
+000155d0: 5265 7365 7420 6966 2072 6571 7565 7374  Reset if request
+000155e0: 6564 0a20 2020 2069 6620 6e6f 7420 6173  ed.    if not as
+000155f0: 5f69 6e64 6578 3a0a 2020 2020 2020 2020  _index:.        
+00015600: 6167 6772 6567 6174 6564 203d 2061 6767  aggregated = agg
+00015610: 7265 6761 7465 642e 7265 7365 745f 696e  regated.reset_in
+00015620: 6465 7828 290a 0a20 2020 2023 204d 616b  dex()..    # Mak
+00015630: 6520 7375 7265 206f 7574 7075 7420 7479  e sure output ty
+00015640: 7065 7320 6f66 2067 726f 7570 6564 2063  pes of grouped c
+00015650: 6f6c 756d 6e73 2061 7265 2074 6865 2073  olumns are the s
+00015660: 616d 6520 6173 2069 6e70 7574 2074 7970  ame as input typ
+00015670: 6573 2e0a 2020 2020 2320 452e 672e 206f  es..    # E.g. o
+00015680: 626a 6563 7420 636f 6c75 6d6e 7320 6265  bject columns be
+00015690: 636f 6d65 2066 6c6f 6174 2069 6620 616c  come float if al
+000156a0: 6c20 7661 6c75 6573 2061 7265 204e 6f6e  l values are Non
+000156b0: 652e 0a20 2020 2069 6620 6279 2069 7320  e..    if by is 
+000156c0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+000156d0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+000156e0: 6279 2c20 7374 7229 3a0a 2020 2020 2020  by, str):.      
+000156f0: 2020 2020 2020 6966 2062 7920 696e 2061        if by in a
+00015700: 6767 7265 6761 7465 642e 636f 6c75 6d6e  ggregated.column
+00015710: 7320 616e 6420 6466 5b62 795d 2e64 7479  s and df[by].dty
+00015720: 7065 2021 3d20 6167 6772 6567 6174 6564  pe != aggregated
+00015730: 5b62 795d 2e64 7479 7065 3a0a 2020 2020  [by].dtype:.    
+00015740: 2020 2020 2020 2020 2020 2020 6167 6772              aggr
+00015750: 6567 6174 6564 5b62 795d 203d 2061 6767  egated[by] = agg
+00015760: 7265 6761 7465 645b 6279 5d2e 6173 7479  regated[by].asty
+00015770: 7065 2864 665b 6279 5d2e 6474 7970 6529  pe(df[by].dtype)
+00015780: 0a20 2020 2020 2020 2065 6c69 6620 6973  .        elif is
+00015790: 696e 7374 616e 6365 2862 792c 2049 7465  instance(by, Ite
+000157a0: 7261 626c 6529 3a0a 2020 2020 2020 2020  rable):.        
+000157b0: 2020 2020 666f 7220 636f 6c20 696e 2062      for col in b
+000157c0: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+000157d0: 2020 2069 6620 636f 6c20 696e 2061 6767     if col in agg
+000157e0: 7265 6761 7465 642e 636f 6c75 6d6e 7320  regated.columns 
+000157f0: 616e 6420 6466 5b63 6f6c 5d2e 6474 7970  and df[col].dtyp
+00015800: 6520 213d 2061 6767 7265 6761 7465 645b  e != aggregated[
+00015810: 636f 6c5d 2e64 7479 7065 3a0a 2020 2020  col].dtype:.    
+00015820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015830: 6167 6772 6567 6174 6564 5b63 6f6c 5d20  aggregated[col] 
+00015840: 3d20 6167 6772 6567 6174 6564 5b63 6f6c  = aggregated[col
+00015850: 5d2e 6173 7479 7065 2864 665b 636f 6c5d  ].astype(df[col]
+00015860: 2e64 7479 7065 290a 0a20 2020 2061 7373  .dtype)..    ass
+00015870: 6572 7420 6973 696e 7374 616e 6365 2861  ert isinstance(a
+00015880: 6767 7265 6761 7465 642c 2067 7064 2e47  ggregated, gpd.G
+00015890: 656f 4461 7461 4672 616d 6529 0a20 2020  eoDataFrame).   
+000158a0: 2072 6574 7572 6e20 6167 6772 6567 6174   return aggregat
+000158b0: 6564 0a0a 0a64 6566 205f 6164 645f 6f72  ed...def _add_or
+000158c0: 6465 7262 795f 636f 6c75 6d6e 2870 6174  derby_column(pat
+000158d0: 683a 2050 6174 682c 206c 6179 6572 3a20  h: Path, layer: 
+000158e0: 7374 722c 206e 616d 653a 2073 7472 293a  str, name: str):
+000158f0: 0a20 2020 2023 2050 7265 7061 7265 2074  .    # Prepare t
+00015900: 6865 2065 7870 7265 7373 696f 6e20 746f  he expression to
+00015910: 2063 616c 6375 6c61 7465 2074 6865 206f   calculate the o
+00015920: 7264 6572 6279 2063 6f6c 756d 6e2e 0a20  rderby column.. 
+00015930: 2020 2023 2049 6e20 6120 7370 6174 6961     # In a spatia
+00015940: 6c20 6669 6c65 2c20 6120 7370 6174 6961  l file, a spatia
+00015950: 6c20 6f72 6465 7220 7769 6c6c 206d 616b  l order will mak
+00015960: 6520 6c61 7465 7220 7573 6520 6d6f 7265  e later use more
+00015970: 2065 6666 6963 69c3 ab6e 742c 0a20 2020   effici..nt,.   
+00015980: 2023 2073 6f20 7573 6520 6120 6765 6f68   # so use a geoh
+00015990: 6173 682e 0a20 2020 206c 6179 6572 696e  ash..    layerin
+000159a0: 666f 203d 2067 666f 2e67 6574 5f6c 6179  fo = gfo.get_lay
+000159b0: 6572 696e 666f 2870 6174 6829 0a20 2020  erinfo(path).   
+000159c0: 2069 6620 6c61 7965 7269 6e66 6f2e 6372   if layerinfo.cr
+000159d0: 7320 6973 206e 6f74 204e 6f6e 6520 616e  s is not None an
+000159e0: 6420 6c61 7965 7269 6e66 6f2e 6372 732e  d layerinfo.crs.
+000159f0: 6973 5f67 656f 6772 6170 6869 633a 0a20  is_geographic:. 
+00015a00: 2020 2020 2020 2023 2049 6620 7468 6520         # If the 
+00015a10: 636f 6f72 6469 6e61 7465 7320 6172 6520  coordinates are 
+00015a20: 6765 6f67 7261 7068 6963 2028 696e 206c  geographic (in l
+00015a30: 6174 2f6c 6f6e 2064 6567 7265 6573 292c  at/lon degrees),
+00015a40: 206f 6b0a 2020 2020 2020 2020 6578 7072   ok.        expr
+00015a50: 6573 7369 6f6e 203d 2066 2253 545f 4765  ession = f"ST_Ge
+00015a60: 6f48 6173 6828 7b6c 6179 6572 696e 666f  oHash({layerinfo
+00015a70: 2e67 656f 6d65 7472 7963 6f6c 756d 6e7d  .geometrycolumn}
+00015a80: 2c20 3130 2922 0a20 2020 2065 6c73 653a  , 10)".    else:
+00015a90: 0a20 2020 2020 2020 2023 2049 6620 7468  .        # If th
+00015aa0: 6579 2061 7265 206e 6f74 2067 656f 6772  ey are not geogr
+00015ab0: 6170 6869 6320 2869 6e20 6c61 742f 6c6f  aphic (in lat/lo
+00015ac0: 6e20 6465 6772 6565 7329 2c20 7468 6579  n degrees), they
+00015ad0: 206e 6565 6420 746f 2062 650a 2020 2020   need to be.    
+00015ae0: 2020 2020 2320 636f 6e76 6572 7465 6420      # converted 
+00015af0: 746f 207e 2064 6567 7265 6573 2074 6f20  to ~ degrees to 
+00015b00: 6265 2061 626c 6520 746f 2063 616c 6375  be able to calcu
+00015b10: 6c61 7465 2061 2067 656f 6861 7368 2e0a  late a geohash..
+00015b20: 0a20 2020 2020 2020 2023 2050 726f 7065  .        # Prope
+00015b30: 726c 7920 6361 6c63 756c 6174 696e 6720  rly calculating 
+00015b40: 7468 6520 7472 616e 7366 6f72 6d61 7469  the transformati
+00015b50: 6f6e 2074 6f20 6567 2e20 5747 5320 6973  on to eg. WGS is
+00015b60: 2074 6572 7269 626c 7920 736c 6f77 2e2e   terribly slow..
+00015b70: 2e0a 2020 2020 2020 2020 2320 6578 7072  ..        # expr
+00015b80: 6573 7369 6f6e 203d 2066 2222 2253 545f  ession = f"""ST_
+00015b90: 4765 6f48 6173 6828 5354 5f54 7261 6e73  GeoHash(ST_Trans
+00015ba0: 666f 726d 284d 616b 6550 6f69 6e74 280a  form(MakePoint(.
+00015bb0: 2020 2020 2020 2020 2320 2020 2020 2020          #       
+00015bc0: 284d 6272 4d61 7858 2867 656f 6d29 2b4d  (MbrMaxX(geom)+M
+00015bd0: 6272 4d69 6e58 2867 656f 6d29 292f 322c  brMinX(geom))/2,
+00015be0: 0a20 2020 2020 2020 2023 2020 2020 2020  .        #      
+00015bf0: 2028 4d62 724d 696e 5928 6765 6f6d 292b   (MbrMinY(geom)+
+00015c00: 4d62 724d 6178 5928 6765 6f6d 2929 2f32  MbrMaxY(geom))/2
+00015c10: 2c20 5354 5f53 5249 4428 6765 6f6d 2929  , ST_SRID(geom))
+00015c20: 2c20 3433 3236 292c 2031 3029 2222 220a  , 4326), 10)""".
+00015c30: 2020 2020 2020 2020 2320 536f 2c20 646f          # So, do
+00015c40: 2073 6f6d 6574 6869 6e67 2065 6c73 6520   something else 
+00015c50: 7468 6174 2773 2066 6173 7465 7220 616e  that's faster an
+00015c60: 6420 7374 696c 6c20 6769 7665 7320 6120  d still gives a 
+00015c70: 676f 6f64 0a20 2020 2020 2020 2023 2067  good.        # g
+00015c80: 656f 6772 6170 6869 6320 636c 7573 7465  eographic cluste
+00015c90: 7269 6e67 2e0a 2020 2020 2020 2020 746f  ring..        to
+00015ca0: 5f67 656f 6772 6170 6869 635f 6661 6374  _geographic_fact
+00015cb0: 6f72 5f61 7070 726f 7820 3d20 3930 202f  or_approx = 90 /
+00015cc0: 206d 6178 286c 6179 6572 696e 666f 2e74   max(layerinfo.t
+00015cd0: 6f74 616c 5f62 6f75 6e64 7329 0a20 2020  otal_bounds).   
+00015ce0: 2020 2020 2065 7870 7265 7373 696f 6e20       expression 
+00015cf0: 3d20 6622 2222 5354 5f47 656f 4861 7368  = f"""ST_GeoHash
+00015d00: 284d 616b 6550 6f69 6e74 280a 2020 2020  (MakePoint(.    
+00015d10: 2020 2020 2020 2020 2020 2020 2828 4d62              ((Mb
+00015d20: 724d 6178 5828 7b6c 6179 6572 696e 666f  rMaxX({layerinfo
+00015d30: 2e67 656f 6d65 7472 7963 6f6c 756d 6e7d  .geometrycolumn}
+00015d40: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00015d50: 2020 2020 2b4d 6272 4d69 6e58 287b 6c61      +MbrMinX({la
+00015d60: 7965 7269 6e66 6f2e 6765 6f6d 6574 7279  yerinfo.geometry
+00015d70: 636f 6c75 6d6e 7d29 292f 320a 2020 2020  column}))/2.    
+00015d80: 2020 2020 2020 2020 2020 2020 292a 7b74              )*{t
+00015d90: 6f5f 6765 6f67 7261 7068 6963 5f66 6163  o_geographic_fac
+00015da0: 746f 725f 6170 7072 6f78 7d2c 0a20 2020  tor_approx},.   
+00015db0: 2020 2020 2020 2020 2020 2020 2028 284d               ((M
+00015dc0: 6272 4d69 6e59 287b 6c61 7965 7269 6e66  brMinY({layerinf
+00015dd0: 6f2e 6765 6f6d 6574 7279 636f 6c75 6d6e  o.geometrycolumn
+00015de0: 7d29 0a20 2020 2020 2020 2020 2020 2020  }).             
+00015df0: 2020 2020 202b 4d62 724d 6178 5928 7b6c       +MbrMaxY({l
+00015e00: 6179 6572 696e 666f 2e67 656f 6d65 7472  ayerinfo.geometr
+00015e10: 7963 6f6c 756d 6e7d 2929 2f32 0a20 2020  ycolumn}))/2.   
+00015e20: 2020 2020 2020 2020 2020 2020 2029 2a7b               )*{
+00015e30: 746f 5f67 656f 6772 6170 6869 635f 6661  to_geographic_fa
+00015e40: 6374 6f72 5f61 7070 726f 787d 2c20 3433  ctor_approx}, 43
+00015e50: 3236 292c 2031 3029 2222 220a 0a20 2020  26), 10)"""..   
+00015e60: 2023 204e 6f77 2077 6520 6361 6e20 6163   # Now we can ac
+00015e70: 7475 616c 6c79 2061 6464 2074 6865 2063  tually add the c
+00015e80: 6f6c 756d 6e2e 0a20 2020 2067 666f 2e61  olumn..    gfo.a
+00015e90: 6464 5f63 6f6c 756d 6e28 7061 7468 3d70  dd_column(path=p
+00015ea0: 6174 682c 206e 616d 653d 6e61 6d65 2c20  ath, name=name, 
+00015eb0: 7479 7065 3d67 666f 2e44 6174 6154 7970  type=gfo.DataTyp
+00015ec0: 652e 5445 5854 2c20 6578 7072 6573 7369  e.TEXT, expressi
+00015ed0: 6f6e 3d65 7870 7265 7373 696f 6e29 0a20  on=expression). 
+00015ee0: 2020 2073 716c 6974 655f 7374 6d74 203d     sqlite_stmt =
+00015ef0: 2066 2743 5245 4154 4520 494e 4445 5820   f'CREATE INDEX 
+00015f00: 7b6e 616d 657d 5f69 6478 204f 4e20 227b  {name}_idx ON "{
+00015f10: 6c61 7965 727d 2228 7b6e 616d 657d 2927  layer}"({name})'
+00015f20: 0a20 2020 2067 666f 2e65 7865 6375 7465  .    gfo.execute
+00015f30: 5f73 716c 2870 6174 683d 7061 7468 2c20  _sql(path=path, 
+00015f40: 7371 6c5f 7374 6d74 3d73 716c 6974 655f  sql_stmt=sqlite_
+00015f50: 7374 6d74 290a                           stmt).
```

### Comparing `geofileops-0.8.2/geofileops/util/_geoops_ogr.py` & `geofileops-0.9.0/geofileops/util/_geoops_ogr.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,86 +1,82 @@
-from datetime import datetime
 import logging
+from datetime import datetime
 from pathlib import Path
-from typing import List, Literal, Optional, Tuple, Union
+from typing import Literal, Optional, Union
 
 from pygeoops import GeometryType
 from shapely import wkt
 
 import geofileops as gfo
-from geofileops.util import _ogr_util
+from geofileops.util import _io_util, _ogr_util
 
 logger = logging.getLogger(__name__)
 
 
 def clip_by_geometry(
     input_path: Path,
     output_path: Path,
-    clip_geometry: Union[Tuple[float, float, float, float], str],
+    clip_geometry: Union[tuple[float, float, float, float], str],
     input_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
-    columns: Optional[List[str]] = None,
+    columns: Optional[list[str]] = None,
     explodecollections: bool = False,
     force: bool = False,
 ):
     spatial_filter = None
     if isinstance(clip_geometry, str):
         geom = wkt.loads(clip_geometry)
         spatial_filter = tuple(geom.bounds)
 
-    options = {"LAYER_CREATION.SPATIAL_INDEX": True}
     _run_ogr(
         operation="clip_by_geometry",
         input_path=input_path,
         output_path=output_path,
         spatial_filter=spatial_filter,  # type: ignore[arg-type]
         clip_geometry=clip_geometry,
         input_layer=input_layer,
         output_layer=output_layer,
         columns=columns,
         explodecollections=explodecollections,
-        options=options,
         force=force,
     )
 
 
 def export_by_bounds(
     input_path: Path,
     output_path: Path,
-    bounds: Tuple[float, float, float, float],
+    bounds: tuple[float, float, float, float],
     input_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
-    columns: Optional[List[str]] = None,
+    columns: Optional[list[str]] = None,
     explodecollections: bool = False,
     force: bool = False,
 ):
-    options = {"LAYER_CREATION.SPATIAL_INDEX": True}
     _run_ogr(
         operation="export_by_bounds",
         input_path=input_path,
         output_path=output_path,
         spatial_filter=bounds,
         input_layer=input_layer,
         output_layer=output_layer,
         columns=columns,
         explodecollections=explodecollections,
-        options=options,
         force=force,
     )
 
 
 def warp(
     input_path: Path,
     output_path: Path,
-    gcps: List[Tuple[float, float, float, float, Optional[float]]],
+    gcps: list[tuple[float, float, float, float, Optional[float]]],
     algorithm: str = "polynomial",
     order: Optional[int] = None,
     input_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
-    columns: Optional[List[str]] = None,
+    columns: Optional[list[str]] = None,
     explodecollections: bool = False,
     force: bool = False,
 ):
     warp = {
         "gcps": gcps,
         "algorithm": algorithm,
         "order": order,
@@ -104,40 +100,35 @@
     input_path: Path,
     output_path: Path,
     input_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
     input_srs: Union[int, str, None] = None,
     output_srs: Union[int, str, None] = None,
     reproject: bool = False,
-    spatial_filter: Optional[Tuple[float, float, float, float]] = None,
-    clip_geometry: Optional[Union[Tuple[float, float, float, float], str]] = None,
+    spatial_filter: Optional[tuple[float, float, float, float]] = None,
+    clip_geometry: Optional[Union[tuple[float, float, float, float], str]] = None,
     sql_stmt: Optional[str] = None,
     sql_dialect: Optional[Literal["SQLITE", "OGRSQL"]] = None,
     transaction_size: int = 65536,
     append: bool = False,
     update: bool = False,
     explodecollections: bool = False,
     force_output_geometrytype: Optional[GeometryType] = None,
     options: dict = {},
-    columns: Optional[List[str]] = None,
+    columns: Optional[list[str]] = None,
     warp: Optional[dict] = None,
     force: bool = False,
 ) -> bool:
     # Init
     logger = logging.getLogger(f"geofileops.{operation}")
     start_time = datetime.now()
     if input_layer is None:
         input_layer = gfo.get_only_layer(input_path)
-    if output_path.exists():
-        if force:
-            gfo.remove(output_path)
-        else:
-            logger.info(f"Stop, output exists already {output_path}")
-            return True
-
+    if _io_util.output_exists(path=output_path, remove_if_exists=force):
+        return True
     if input_layer is None:
         input_layer = gfo.get_only_layer(input_path)
     if output_layer is None:
         output_layer = gfo.get_default_layer(output_path)
 
     info = _ogr_util.VectorTranslateInfo(
         input_path=input_path,
```

### Comparing `geofileops-0.8.2/geofileops/util/_geoops_sql.py` & `geofileops-0.9.0/geofileops/util/_geoops_sql.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,43 +1,46 @@
 """
 Module containing the implementation of Geofile operations using a sql statement.
 """
 
-from concurrent import futures
-from datetime import datetime
 import json
 import logging
 import logging.config
 import math
 import multiprocessing
-from pathlib import Path
 import shutil
 import string
-from typing import Dict, Iterable, List, Literal, Optional, Tuple, Union
 import warnings
+from collections.abc import Iterable
+from concurrent import futures
+from datetime import datetime
+from pathlib import Path
+from typing import Literal, Optional, Union
 
 import pandas as pd
 import pygeoops
 import shapely
 
 import geofileops as gfo
-from geofileops import GeometryType, PrimitiveType
-from geofileops import fileops
-
+from geofileops import GeometryType, PrimitiveType, fileops
 from geofileops._compat import SPATIALITE_GTE_51
 from geofileops.fileops import _append_to_nolock
-from geofileops.util import _general_util
-from geofileops.util import _geofileinfo
-from geofileops.util import _geoops_gpd
-from geofileops.util import _io_util
-from geofileops.util import _ogr_sql_util
-from geofileops.util import _ogr_util
 from geofileops.helpers import _parameter_helper
-from geofileops.util import _processing_util
-from geofileops.util import _sqlite_util
+from geofileops.helpers._configoptions_helper import ConfigOptions
+from geofileops.util import (
+    _general_util,
+    _geofileinfo,
+    _geoops_gpd,
+    _io_util,
+    _ogr_sql_util,
+    _ogr_util,
+    _processing_util,
+    _sqlite_util,
+)
+from geofileops.util._geofileinfo import GeofileInfo
 
 logger = logging.getLogger(__name__)
 
 # -----------------------
 # Operations on one layer
 # -----------------------
 
@@ -45,18 +48,18 @@
 def buffer(
     input_path: Path,
     output_path: Path,
     distance: float,
     quadrantsegments: int = 5,
     input_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
-    columns: Optional[List[str]] = None,
+    columns: Optional[list[str]] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
-    keep_empty_geoms: bool = True,
+    keep_empty_geoms: bool = False,
     where_post: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
 ):
     # Init + prepare sql template for this operation
     # ----------------------------------------------
@@ -108,18 +111,18 @@
 
 
 def convexhull(
     input_path: Path,
     output_path: Path,
     input_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
-    columns: Optional[List[str]] = None,
+    columns: Optional[list[str]] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
-    keep_empty_geoms: bool = False,  # Should become True
+    keep_empty_geoms: bool = False,
     where_post: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
 ):
     # Init + prepare sql template for this operation
     # ----------------------------------------------
@@ -157,17 +160,17 @@
 
 
 def delete_duplicate_geometries(
     input_path: Path,
     output_path: Path,
     input_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
-    columns: Optional[List[str]] = None,
+    columns: Optional[list[str]] = None,
     explodecollections: bool = False,
-    keep_empty_geoms: bool = True,
+    keep_empty_geoms: bool = False,
     where_post: Optional[str] = None,
     force: bool = False,
 ):
     # The query as written doesn't give correct results when parallelized,
     # but it isn't useful to do it for this operation.
     sql_template = """
         SELECT {geometrycolumn} AS {geometrycolumn}
@@ -204,15 +207,15 @@
 
 
 def isvalid(
     input_path: Path,
     output_path: Path,
     input_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
-    columns: Optional[List[str]] = None,
+    columns: Optional[list[str]] = None,
     explodecollections: bool = False,
     validate_attribute_data: bool = False,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
 ) -> bool:
     # Prepare sql template for this operation
@@ -278,19 +281,19 @@
 
 
 def makevalid(
     input_path: Path,
     output_path: Path,
     input_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
-    columns: Optional[List[str]] = None,
+    columns: Optional[list[str]] = None,
     explodecollections: bool = False,
-    force_output_geometrytype: Optional[GeometryType] = None,
+    force_output_geometrytype: Union[str, None, GeometryType] = None,
     gridsize: float = 0.0,
-    keep_empty_geoms: bool = True,
+    keep_empty_geoms: bool = False,
     where_post: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
 ):
     # If output file exists already, either clean up or return...
     operation_name = "makevalid"
@@ -301,15 +304,19 @@
 
     # Determine output_geometrytype + make it multitype if it wasn't specified.
     # Otherwise makevalid can result in column type 'GEOMETRY'/'UNKNOWN(ANY)'.
     if force_output_geometrytype is None:
         input_layerinfo = gfo.get_layerinfo(input_path, input_layer)
         force_output_geometrytype = input_layerinfo.geometrytype
         if not explodecollections:
+            assert isinstance(force_output_geometrytype, GeometryType)
             force_output_geometrytype = force_output_geometrytype.to_multitype
+    if isinstance(force_output_geometrytype, str):
+        force_output_geometrytype = GeometryType[force_output_geometrytype]
+    assert force_output_geometrytype is not None
 
     # Init + prepare sql template for this operation
     # ----------------------------------------------
     # Only apply makevalid if the geometry is truly invalid, this is faster.
     # GEOSMakeValid crashes with EMPTY input, so check this first.
     if SPATIALITE_GTE_51:
         operation = """
@@ -366,30 +373,28 @@
 def select(
     input_path: Path,
     output_path: Path,
     sql_stmt: str,
     sql_dialect: Optional[Literal["SQLITE", "OGRSQL"]] = "SQLITE",
     input_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
-    columns: Optional[List[str]] = None,
+    columns: Optional[list[str]] = None,
     explodecollections: bool = False,
     force_output_geometrytype: Optional[GeometryType] = None,
     gridsize: float = 0.0,
-    keep_empty_geoms: bool = True,
+    keep_empty_geoms: bool = False,
     nb_parallel: int = 1,
     batchsize: int = -1,
     force: bool = False,
     operation_prefix: str = "",
 ):
     # Check if output exists already here, to avoid to much logging to be written
     logger = logging.getLogger(f"geofileops.{operation_prefix}select")
-    if output_path.exists():
-        if force is False:
-            logger.info(f"Stop, output exists already {output_path}")
-            return
+    if _io_util.output_exists(path=output_path, remove_if_exists=force):
+        return
     logger.debug(f"  -> select to execute:\n{sql_stmt}")
 
     # If no output geometrytype is specified, use the geometrytype of the input layer
     if force_output_geometrytype is None:
         force_output_geometrytype = gfo.get_layerinfo(
             input_path, input_layer, raise_on_nogeom=False
         ).geometrytype
@@ -425,18 +430,18 @@
 
 def simplify(
     input_path: Path,
     output_path: Path,
     tolerance: float,
     input_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
-    columns: Optional[List[str]] = None,
+    columns: Optional[list[str]] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
-    keep_empty_geoms: bool = True,
+    keep_empty_geoms: bool = False,
     where_post: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
 ):
     # Init + prepare sql template for this operation
     # ----------------------------------------------
@@ -476,15 +481,15 @@
     input_path: Path,
     output_path: Path,
     sql_template: str,
     geom_selected: Optional[bool],
     operation_name: str,
     input_layer: Optional[str],
     output_layer: Optional[str],
-    columns: Optional[List[str]],
+    columns: Optional[list[str]],
     explodecollections: bool,
     force_output_geometrytype: Optional[GeometryType],
     gridsize: float,
     keep_empty_geoms: bool,
     where_post: Optional[str],
     sql_dialect: Optional[Literal["SQLITE", "OGRSQL"]],
     nb_parallel: int,
@@ -536,20 +541,16 @@
     # Check/get layer names
     if input_layer is None:
         input_layer = gfo.get_only_layer(input_path)
     if output_layer is None:
         output_layer = gfo.get_default_layer(output_path)
 
     # If output file exists already, either clean up or return...
-    if output_path.exists():
-        if force is False:
-            logger.info(f"Stop, output exists already {output_path}")
-            return
-        else:
-            gfo.remove(output_path)
+    if _io_util.output_exists(path=output_path, remove_if_exists=force):
+        return
 
     # Determine if fid can be preserved
     preserve_fid = False
     if (
         not explodecollections
         and _geofileinfo.get_geofileinfo(input_path).is_spatialite_based
         and _geofileinfo.get_geofileinfo(output_path).is_spatialite_based
@@ -632,14 +633,15 @@
                 geom_selected = input_layerinfo.geometrycolumn in cols
 
         # Fill out/add to the sql_template what is already possible
         # ---------------------------------------------------------
 
         # Add application of gridsize around sql_template if specified
         if geom_selected and gridsize != 0.0:
+            assert force_output_geometrytype is not None
             gridsize_op = _format_apply_gridsize_operation(
                 geometrycolumn=f"sub_gridsize.{input_layerinfo.geometrycolumn}",
                 gridsize=gridsize,
                 force_output_geometrytype=force_output_geometrytype,
             )
 
             # Get all columns of the sql_template
@@ -715,15 +717,15 @@
         # Processing in threads is 2x faster for small datasets (on Windows)
         calculate_in_threads = True if input_layerinfo.featurecount <= 100 else False
         with _processing_util.PooledExecutorFactory(
             threadpool=calculate_in_threads,
             max_workers=processing_params.nb_parallel,
             initializer=_processing_util.initialize_worker(),
         ) as calculate_pool:
-            batches: Dict[int, dict] = {}
+            batches: dict[int, dict] = {}
             future_to_batch_id = {}
             for batch_id in processing_params.batches:
                 batches[batch_id] = {}
                 batches[batch_id]["layer"] = output_layer
 
                 tmp_partial_output_path = (
                     tempdir / f"{output_path.stem}_{batch_id}.gpkg"
@@ -735,17 +737,19 @@
                     batch_filter=processing_params.batches[batch_id]["batch_filter"]
                 )
                 batches[batch_id]["sql_stmt"] = sql_stmt
 
                 # If there is only one batch, it is faster to create the spatial index
                 # immediately. Otherwise no index needed, because partial files still
                 # need to be merged to one file later on.
-                create_spatial_index = False
-                if nb_batches == 1:
-                    create_spatial_index = True
+                create_spatial_index = (
+                    GeofileInfo(tmp_partial_output_path).default_spatial_index
+                    if nb_batches == 1
+                    else False
+                )
                 translate_info = _ogr_util.VectorTranslateInfo(
                     input_path=processing_params.batches[batch_id]["input1_path"],
                     output_path=tmp_partial_output_path,
                     output_layer=output_layer,
                     sql_stmt=sql_stmt,
                     sql_dialect=sql_dialect,
                     explodecollections=explodecollections,
@@ -828,15 +832,16 @@
                     nb_parallel=processing_params.nb_parallel,
                 )
 
         # Round up and clean up
         # Now create spatial index and move to output location
         if tmp_output_path.exists():
             if (
-                gfo.get_layerinfo(
+                GeofileInfo(tmp_output_path).default_spatial_index
+                and gfo.get_layerinfo(
                     path=tmp_output_path, layer=output_layer, raise_on_nogeom=False
                 ).geometrycolumn
                 is not None
             ):
                 gfo.create_spatial_index(
                     path=tmp_output_path, layer=output_layer, exist_ok=True
                 )
@@ -853,40 +858,41 @@
                 tmp_output_path.with_suffix(".dbf"), output_path.with_suffix(".dbf")
             )
         else:
             logger.debug("Result was empty!")
 
     finally:
         # Clean tmp dir
-        shutil.rmtree(tempdir, ignore_errors=True)
+        if ConfigOptions.remove_temp_files:
+            shutil.rmtree(tempdir, ignore_errors=True)
 
     logger.info(f"Ready, took {datetime.now()-start_time}")
 
 
 # ------------------------
 # Operations on two layers
 # ------------------------
 
 
 def clip(
     input_path: Path,
     clip_path: Path,
     output_path: Path,
     input_layer: Optional[str] = None,
-    input_columns: Optional[List[str]] = None,
+    input_columns: Optional[list[str]] = None,
     clip_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
     where_post: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
     input_columns_prefix: str = "",
-    output_with_spatial_index: bool = True,
+    output_with_spatial_index: Optional[bool] = None,
 ):
     # Init
     # In the query, important to only extract the geometry types that are expected
     input_layer_info = gfo.get_layerinfo(input_path, input_layer)
     primitivetypeid = input_layer_info.geometrytype.to_primitivetype.value
 
     # If explodecollections is False and the input type is not point, force the output
@@ -971,117 +977,79 @@
     )
 
 
 def erase(
     input_path: Path,
     erase_path: Path,
     output_path: Path,
+    overlay_self: bool,
     input_layer: Optional[str] = None,
-    input_columns: Optional[List[str]] = None,
+    input_columns: Optional[list[str]] = None,
     erase_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
     where_post: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     subdivide_coords: int = 2000,
     force: bool = False,
     input_columns_prefix: str = "",
-    output_with_spatial_index: bool = True,
+    output_with_spatial_index: Optional[bool] = None,
     operation_prefix: str = "",
 ):
     # Because there might be extra preparation of the erase layer before going ahead
     # with the real calculation, do some additional init + checks here...
     if subdivide_coords < 0:
         raise ValueError("subdivide_coords < 0 is not allowed")
 
-    operation = f"{operation_prefix}erase"
-    logger = logging.getLogger(f"geofileops.{operation}")
-    if output_path.exists():
-        if force is False:
-            logger.info(f"Stop, output exists already {output_path}")
-            return
-        else:
-            gfo.remove(output_path)
+    operation_name = f"{operation_prefix}erase"
+    logger = logging.getLogger(f"geofileops.{operation_name}")
+
+    # If we are doing a self overlay, we need to filter out rows with the same rowid.
+    where_clause_self = "1=1"
+    if overlay_self:
+        where_clause_self = "layer1.rowid <> layer2_sub.rowid"
+
+    # Get layer names
+    if input_layer is None:
+        input_layer = gfo.get_only_layer(input_path)
+    if erase_layer is None:
+        erase_layer = gfo.get_only_layer(erase_path)
+
+    if _io_util.output_exists(path=output_path, remove_if_exists=force):
+        return
 
-    # Init
     start_time = datetime.now()
     input_layer_info = gfo.get_layerinfo(input_path, input_layer)
     primitivetypeid = input_layer_info.geometrytype.to_primitivetype.value
 
     # If explodecollections is False and the input type is not point, force the output
     # type to multi, because erase can cause eg. polygons to be split to multipolygons.
     force_output_geometrytype = input_layer_info.geometrytype
     if not explodecollections and force_output_geometrytype is not GeometryType.POINT:
         force_output_geometrytype = force_output_geometrytype.to_multitype
 
-    # If the erase layer is made out of polygons, subdivide them if needed
-    tmp_dir = None
-    erase_layer_info = gfo.get_layerinfo(erase_path, erase_layer)
-    if (
-        subdivide_coords > 0
-        and erase_layer_info.geometrytype.to_primitivetype == PrimitiveType.POLYGON
-    ):
-        erase_layer = erase_layer_info.name
-
-        # If erase layer has complex geometries, subdivide them to speed up processing.
-        complexgeom_sql = f"""
-            SELECT 1
-              FROM "{erase_layer}" layer
-             WHERE ST_NPoints({erase_layer_info.geometrycolumn}) > {subdivide_coords}
-             LIMIT 1
-        """
-        logger.info(
-            f"Check if complex geometries in erase layer (> {subdivide_coords} coords)"
-        )
-        complexgeom_df = gfo.read_file(
-            erase_path, sql_stmt=complexgeom_sql, sql_dialect="SQLITE"
-        )
-        if len(complexgeom_df) > 0:
-            logger.info("Subdivide needed: complex geometries found")
-
-            # Do subdivide using python function, because all spatialite options didn't
-            # seem to work.
-            # Check out commits in https://github.com/geofileops/geofileops/pull/433
-            def subdivide(geom, num_coords_max):
-                result = pygeoops.subdivide(geom, num_coords_max=num_coords_max)
-
-                if result is None:
-                    return None
-                if not hasattr(result, "__len__"):
-                    return result
-                if len(result) == 1:
-                    return result[0]
-
-                # Explode because
-                #   - they will be exploded anyway by spatialite.ST_Collect
-                #   - spatialite.ST_AsBinary and/or spatialite.ST_GeomFromWkb don't seem
-                #     to handle nested collections well.
-                return shapely.GeometryCollection(shapely.get_parts(result).tolist())
-
-            tmp_dir = _io_util.create_tempdir("geofileops/erase_input")
-            erase_subdidided_path = tmp_dir / f"{erase_path.stem}_subdivided.gpkg"
-            _geoops_gpd.apply(
-                input_path=erase_path,
-                input_layer=erase_layer,
-                output_path=erase_subdidided_path,
-                output_layer=erase_layer,
-                func=lambda geom: subdivide(geom, num_coords_max=subdivide_coords),
-                operation_name="erase/subdivide",
-                columns=[],
-                explodecollections=True,
-                nb_parallel=nb_parallel,
-                batchsize=batchsize,
-                parallelization_config=_geoops_gpd.ParallelizationConfig(
-                    bytes_per_row=2000, max_rows_per_batch=50000
-                ),
-            )
+    # Subdivide the erase layer if applicable to speed up further processing.
+    tmp_dir = _io_util.create_tempdir(f"geofileops/{operation_name}")
+    erase_subdivided_path = _subdivide_layer(
+        path=erase_path,
+        layer=erase_layer,
+        output_dir=tmp_dir / "subdivided",
+        subdivide_coords=subdivide_coords,
+        overlay_self=overlay_self,
+        nb_parallel=nb_parallel,
+        batchsize=batchsize,
+    )
+    if erase_subdivided_path is not None:
+        erase_path = erase_subdivided_path
 
-            erase_path = erase_subdidided_path
+        # _subdivide_layer will save the original fid column in a new fid_1 column
+        if overlay_self:
+            where_clause_self = "layer1.rowid <> layer2_sub.fid_1"
 
     # Prepare sql template for this operation
     # - WHERE geom IS NOT NULL to avoid rows with a NULL geom, they give issues in
     #   later operations
     # - use "LIMIT -1 OFFSET 0" to avoid the subquery flattening. Flattening e.g.
     #   "geom IS NOT NULL" leads to GFO_Difference_Collection calculated double!
     # - ST_Intersects and ST_Touches slow down a lot when the data contains huge geoms
@@ -1130,15 +1098,16 @@
                                ),
                                'DIFF_EMPTY'
                             ) AS diff_geom
                        FROM {{input1_databasename}}."{input1_layer_rtree}" layer1tree
                        JOIN {{input2_databasename}}."{{input2_layer}}" layer2_sub
                        JOIN {{input2_databasename}}."{input2_layer_rtree}" layer2tree
                          ON layer2_sub.rowid = layer2tree.id
-                      WHERE layer1tree.id = layer1.rowid
+                      WHERE {where_clause_self}
+                        AND layer1tree.id = layer1.rowid
                         AND layer1tree.minx <= layer2tree.maxx
                         AND layer1tree.maxx >= layer2tree.minx
                         AND layer1tree.miny <= layer2tree.maxy
                         AND layer1tree.maxy >= layer2tree.miny
                         AND ST_intersects(layer1.{{input1_geometrycolumn}},
                                           layer2_sub.{{input2_geometrycolumn}}) = 1
                       LIMIT -1 OFFSET 0
@@ -1154,167 +1123,373 @@
           )
          WHERE geom IS NOT NULL
            AND geom <> 'DIFF_EMPTY'
            AND ST_IsEmpty(geom) = 0
     """
 
     # Go!
-    try:
-        _two_layer_vector_operation(
-            input1_path=input_path,
-            input2_path=erase_path,
-            output_path=output_path,
-            sql_template=sql_template,
-            operation_name=operation,
-            input1_layer=input_layer,
-            input1_columns=input_columns,
-            input1_columns_prefix=input_columns_prefix,
-            input2_layer=erase_layer,
-            input2_columns=[],
-            input2_columns_prefix="",
-            output_layer=output_layer,
-            explodecollections=explodecollections,
-            force_output_geometrytype=force_output_geometrytype,
-            gridsize=gridsize,
-            where_post=where_post,
-            nb_parallel=nb_parallel,
-            batchsize=batchsize,
-            force=force,
-            output_with_spatial_index=output_with_spatial_index,
-        )
-    finally:
-        if tmp_dir is not None:
-            shutil.rmtree(tmp_dir, ignore_errors=True)
+    _two_layer_vector_operation(
+        input1_path=input_path,
+        input2_path=erase_path,
+        output_path=output_path,
+        sql_template=sql_template,
+        operation_name=operation_name,
+        input1_layer=input_layer,
+        input1_columns=input_columns,
+        input1_columns_prefix=input_columns_prefix,
+        input2_layer=erase_layer,
+        input2_columns=[],
+        input2_columns_prefix="",
+        output_layer=output_layer,
+        explodecollections=explodecollections,
+        force_output_geometrytype=force_output_geometrytype,
+        gridsize=gridsize,
+        where_post=where_post,
+        nb_parallel=nb_parallel,
+        batchsize=batchsize,
+        force=force,
+        output_with_spatial_index=output_with_spatial_index,
+        tmp_dir=tmp_dir,
+    )
 
     # Print time taken
     logger.info(f"Ready, full erase took {datetime.now()-start_time}")
 
 
+def _subdivide_layer(
+    path: Path,
+    layer: Optional[str],
+    output_dir: Path,
+    subdivide_coords: int,
+    overlay_self: bool,
+    nb_parallel: int = -1,
+    batchsize: int = -1,
+) -> Optional[Path]:
+    """
+    Subdivide a layer if applicable.
+
+    Args:
+        path (Path): path to the input file.
+        layer (str): layer in the file to be subdivided
+        output_dir (Path): the dir to create the subdivided file in. If the directory
+            specified doesn't exist yet, it is created.
+        subdivide_coords (int): number of coordinates to aim for
+        overlay_self (bool): _description_
+        nb_parallel (int, optional): _description_. Defaults to -1.
+        batchsize (int, optional): _description_. Defaults to -1.
+
+    Returns:
+        Optional[Path]: path to the result or None if it didn't need subdivision.
+    """
+    if subdivide_coords <= 0:
+        return None
+
+    # Only subdivide Polygon layers
+    layer_info = gfo.get_layerinfo(path, layer)
+    if layer_info.geometrytype.to_primitivetype != PrimitiveType.POLYGON:
+        return None
+
+    # If layer has complex geometries, subdivide them.
+    layer = layer_info.name
+    complexgeom_sql = f"""
+        SELECT 1
+          FROM "{layer}" layer
+         WHERE ST_NPoints({layer_info.geometrycolumn}) > {subdivide_coords}
+         LIMIT 1
+    """
+    logger.info(
+        f"Check if complex geometries in erase layer (> {subdivide_coords} coords)"
+    )
+    complexgeom_df = gfo.read_file(path, sql_stmt=complexgeom_sql, sql_dialect="SQLITE")
+    if len(complexgeom_df) <= 0:
+        return None
+
+    logger.info("Subdivide needed: complex geometries found")
+
+    # Do subdivide using python function, because all spatialite options didn't
+    # seem to work.
+    # Check out commits in https://github.com/geofileops/geofileops/pull/433
+    def subdivide(geom, num_coords_max):
+        result = pygeoops.subdivide(geom, num_coords_max=num_coords_max)
+
+        if result is None:
+            return None
+        if not hasattr(result, "__len__"):
+            return result
+        if len(result) == 1:
+            return result[0]
+
+        # Explode because
+        #   - they will be exploded anyway by spatialite.ST_Collect
+        #   - spatialite.ST_AsBinary and/or spatialite.ST_GeomFromWkb don't seem
+        #     to handle nested collections well.
+        return shapely.GeometryCollection(shapely.get_parts(result).tolist())
+
+    # If we are self-erasing the layer, we need to retain the fid to be able to
+    # know which row the subdivided geometries belonged to originally.
+    if overlay_self:
+        columns = ["fid"]
+    else:
+        columns = []
+
+    output_dir.mkdir(parents=True, exist_ok=True)
+    subdidided_path = output_dir / f"{path.stem}_subdivided.gpkg"
+    _geoops_gpd.apply(
+        input_path=path,
+        input_layer=layer,
+        output_path=subdidided_path,
+        output_layer=layer,
+        func=lambda geom: subdivide(geom, num_coords_max=subdivide_coords),
+        operation_name="erase/subdivide",
+        columns=columns,
+        explodecollections=True,
+        nb_parallel=nb_parallel,
+        batchsize=batchsize,
+        parallelization_config=_geoops_gpd.ParallelizationConfig(
+            bytes_per_row=2000, max_rows_per_batch=50000
+        ),
+    )
+    if overlay_self:
+        sql_create_index = f'CREATE INDEX "IDX_{layer}_fid_1" ON "{layer}"(fid_1)'
+        fileops.execute_sql(subdidided_path, sql_stmt=sql_create_index)
+
+    return subdidided_path
+
+
 def export_by_location(
     input_path: Path,
     input_to_compare_with_path: Path,
     output_path: Path,
+    spatial_relations_query: str,
     min_area_intersect: Optional[float] = None,
     area_inters_column_name: Optional[str] = None,
     input_layer: Optional[str] = None,
-    input_columns: Optional[List[str]] = None,
+    input_columns: Optional[list[str]] = None,
     input_to_compare_with_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
     gridsize: float = 0.0,
     where_post: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
+    subdivide_coords: int = 10000,
     force: bool = False,
 ):
+    # Because there might be extra preparation of the erase layer before going ahead
+    # with the real calculation, do some additional init + checks here...
+    if subdivide_coords < 0:
+        raise ValueError("subdivide_coords < 0 is not allowed")
+
+    operation_name = "export_by_location"
+    logger = logging.getLogger(f"geofileops.{operation_name}")
+    if output_path.exists():
+        if force is False:
+            logger.info(f"Stop, output exists already {output_path}")
+            return
+        else:
+            gfo.remove(output_path)
+
+    start_time = datetime.now()
+
     # Prepare sql template for this operation
-    # TODO: test performance difference between the following two queries
     input1_layer_rtree = "rtree_{input1_layer}_{input1_geometrycolumn}"
     input2_layer_rtree = "rtree_{input2_layer}_{input2_geometrycolumn}"
 
-    # If intersect area needs to be calculated, other query needed
-    if area_inters_column_name is None and min_area_intersect is None:
+    # Prepare spatial relation column and filter
+    (
+        spatial_relation_column,
+        spatial_relation_filter,
+        true_for_disjoint,
+    ) = _prepare_filter_by_location_fields(spatial_relations_query)
+
+    # Subdivide the erase layer if applicable to speed up further processing.
+    tmp_dir = _io_util.create_tempdir(f"geofileops/{operation_name}")
+    input_to_compare_with_subdivided_path = _subdivide_layer(
+        path=input_to_compare_with_path,
+        layer=input_to_compare_with_layer,
+        output_dir=tmp_dir / "subdivided",
+        subdivide_coords=subdivide_coords,
+        overlay_self=False,
+        nb_parallel=nb_parallel,
+        batchsize=batchsize,
+    )
+    if input_to_compare_with_subdivided_path is not None:
+        input_to_compare_with_path = input_to_compare_with_subdivided_path
+
+    # Different query if intersecting features need to be unioned...
+    if (
+        true_for_disjoint is False
+        and area_inters_column_name is None
+        and min_area_intersect is None
+    ):
+        # No union needed.
         sql_template = f"""
-            SELECT layer1.{{input1_geometrycolumn}} AS geom
-                  {{layer1_columns_prefix_alias_str}}
-              FROM {{input1_databasename}}."{{input1_layer}}" layer1
-              JOIN {{input1_databasename}}."{input1_layer_rtree}" layer1tree
-                ON layer1.fid = layer1tree.id
-             WHERE 1=1
-               {{batch_filter}}
-               AND EXISTS (
-                  SELECT 1
-                    FROM {{input2_databasename}}."{{input2_layer}}" layer2
-                    JOIN {{input2_databasename}}."{input2_layer_rtree}" layer2tree
-                      ON layer2.fid = layer2tree.id
-                   WHERE layer1tree.minx <= layer2tree.maxx
-                     AND layer1tree.maxx >= layer2tree.minx
-                     AND layer1tree.miny <= layer2tree.maxy
-                     AND layer1tree.maxy >= layer2tree.miny
-                     AND ST_intersects(layer1.{{input1_geometrycolumn}},
-                                       layer2.{{input2_geometrycolumn}}) = 1
-                     AND ST_touches(layer1.{{input1_geometrycolumn}},
-                                    layer2.{{input2_geometrycolumn}}) = 0)
-            """
+            WITH layer1_intersecting_filtered AS (
+              SELECT layer1.{{input1_geometrycolumn}} AS geom
+                    {{layer1_columns_prefix_alias_str}}
+                FROM {{input1_databasename}}."{{input1_layer}}" layer1
+               WHERE 1=1
+                 {{batch_filter}}
+                 AND EXISTS (
+                      SELECT 1 FROM (
+                        SELECT 1
+                              {spatial_relation_column}
+                          FROM {{input2_databasename}}."{{input2_layer}}" layer2
+                          JOIN {{input2_databasename}}."{input2_layer_rtree}" layer2tree
+                            ON layer2.fid = layer2tree.id
+                         WHERE ST_MinX(layer1.{{input1_geometrycolumn}}) <= layer2tree.maxx
+                           AND ST_MaxX(layer1.{{input1_geometrycolumn}}) >= layer2tree.minx
+                           AND ST_MinY(layer1.{{input1_geometrycolumn}}) <= layer2tree.maxy
+                           AND ST_MaxY(layer1.{{input1_geometrycolumn}}) >= layer2tree.miny
+                           --LIMIT -1 OFFSET 0
+                        ) sub_filter
+                       WHERE {spatial_relation_filter}
+                      )
+            )
+            SELECT sub.geom
+                  {{layer1_columns_from_subselect_str}}
+                  {{layer2_columns_from_subselect_str}}
+              FROM layer1_intersecting_filtered sub
+        """  # noqa: E501
+
+        # If disjoint is True according to the query, include features that don't match
+        # the spatial index.
+        if true_for_disjoint:
+            sql_template = f"""
+                {sql_template}
+                UNION ALL
+                SELECT layer1.{{input1_geometrycolumn}} AS geom
+                      {{layer1_columns_prefix_alias_str}}
+                      {{layer2_columns_prefix_alias_null_str}}
+                  FROM {{input1_databasename}}."{{input1_layer}}" layer1
+                  WHERE 1=1
+                   {{batch_filter}}
+                   AND NOT EXISTS (
+                        SELECT 1
+                          FROM {{input2_databasename}}."{{input2_layer}}" layer2
+                          JOIN {{input2_databasename}}."{input2_layer_rtree}" layer2tree
+                            ON layer2.fid = layer2tree.id
+                         WHERE ST_MinX(layer1.{{input1_geometrycolumn}}) <= layer2tree.maxx
+                           AND ST_MaxX(layer1.{{input1_geometrycolumn}}) >= layer2tree.minx
+                           AND ST_MinY(layer1.{{input1_geometrycolumn}}) <= layer2tree.maxy
+                           AND ST_MaxY(layer1.{{input1_geometrycolumn}}) >= layer2tree.miny
+                       )
+        """  # noqa: E501
     else:
-        # Intersect area needs to be calculated
-        if area_inters_column_name is None:
-            area_inters_column_name = "area_inters"
-        area_inters_column_expression = f"""
-            ,ST_area(ST_intersection(
-                    ST_union(layer1.{{input1_geometrycolumn}}),
-                    ST_union(layer2.{{input2_geometrycolumn}})
-                )) AS {area_inters_column_name}
-        """
+        # Union needed to calculate intersection area or because spatial_relation_query
+        # returns True for disjoint features.
 
-        # Prepare sql template with intersect area calculation
+        # Prepare area calculation is relevant
+        area_inters_column_expression = ""
+        if area_inters_column_name is not None or min_area_intersect is not None:
+            if area_inters_column_name is None:
+                area_inters_column_name = "area_inters"
+            area_inters_column_expression = (
+                f",ST_area(ST_intersection(geom, geom2)) AS {area_inters_column_name}"
+            )
+
+        (
+            spatial_relation_column,
+            spatial_relation_filter,
+            true_for_disjoint,
+        ) = _prepare_filter_by_location_fields(
+            spatial_relations_query, geom1="geom", geom2="geom2", subquery_alias="sub"
+        )
+
+        # Optimize special case: geom2 is already filtered on intersects in the query,
+        # so for "intersects is True" we can avoid calculating intersects again:
+        if spatial_relations_query.lower() == "intersects is true":
+            spatial_relation_column = ""
+            spatial_relation_filter = "geom2 IS NOT NULL"
+
+        if true_for_disjoint:
+            spatial_relation_filter = f"geom2 IS NULL OR ({spatial_relation_filter})"
+        area_inters_column = (
+            f",{area_inters_column_name}" if area_inters_column_name is not None else ""
+        )
         sql_template = f"""
-            SELECT ST_union(layer1.{{input1_geometrycolumn}}) as geom
-                  {{layer1_columns_prefix_str}}
-                  {area_inters_column_expression}
-              FROM {{input1_databasename}}."{{input1_layer}}" layer1
-              JOIN {{input1_databasename}}."{input1_layer_rtree}" layer1tree
-                ON layer1.fid = layer1tree.id
-              JOIN {{input2_databasename}}."{{input2_layer}}" layer2
-              JOIN {{input2_databasename}}."{input2_layer_rtree}" layer2tree
-                ON layer2.fid = layer2tree.id
-             WHERE 1=1
-               {{batch_filter}}
-               AND layer1tree.minx <= layer2tree.maxx
-               AND layer1tree.maxx >= layer2tree.minx
-               AND layer1tree.miny <= layer2tree.maxy
-               AND layer1tree.maxy >= layer2tree.miny
-               AND ST_Intersects(layer1.{{input1_geometrycolumn}},
-                                 layer2.{{input2_geometrycolumn}}) = 1
-               AND ST_Touches(layer1.{{input1_geometrycolumn}},
-                              layer2.{{input2_geometrycolumn}}) = 0
-             GROUP BY layer1.rowid {{layer1_columns_prefix_str}}
-        """
+            SELECT sub.geom
+                  {{layer1_columns_from_subselect_str}}
+                  {area_inters_column}
+              FROM (
+                SELECT sub_union.*
+                      {spatial_relation_column}
+                      {area_inters_column_expression}
+                  FROM (
+                    SELECT layer1.*
+                          ,(SELECT ST_Union(layer2_sub.{{input2_geometrycolumn}}) AS geom2
+                              FROM {{input1_databasename}}."{input1_layer_rtree}" layer1tree
+                              JOIN {{input2_databasename}}."{{input2_layer}}" layer2_sub
+                              JOIN {{input2_databasename}}."{input2_layer_rtree}" layer2tree
+                                ON layer2_sub.rowid = layer2tree.id
+                             WHERE layer1tree.id = layer1.rowid
+                               AND layer1tree.minx <= layer2tree.maxx
+                               AND layer1tree.maxx >= layer2tree.minx
+                               AND layer1tree.miny <= layer2tree.maxy
+                               AND layer1tree.maxy >= layer2tree.miny
+                               AND ST_intersects(
+                                        layer1.{{input1_geometrycolumn}},
+                                        layer2_sub.{{input2_geometrycolumn}}
+                                   ) = 1
+                             LIMIT -1 OFFSET 0
+                           ) AS geom2
+                      FROM {{input1_databasename}}."{{input1_layer}}" layer1
+                     WHERE 1=1
+                       {{batch_filter}}
+                     LIMIT -1 OFFSET 0
+                ) sub_union
+              ) sub
+             WHERE {spatial_relation_filter}
+        """  # noqa: E501
 
         # Filter on intersect area if necessary
         if min_area_intersect is not None:
             sql_template = f"""
-                SELECT sub.* FROM
+                SELECT * FROM
                   ( {sql_template}
                      LIMIT -1 OFFSET 0
-                  ) sub
-                WHERE sub.{area_inters_column_name} >= {min_area_intersect}
+                  ) sub_area
+                WHERE sub_area.{area_inters_column_name} >= {min_area_intersect}
             """
 
     # Go!
     input_layer_info = gfo.get_layerinfo(input_path, input_layer)
-    return _two_layer_vector_operation(
+    _two_layer_vector_operation(
         input1_path=input_path,
         input2_path=input_to_compare_with_path,
         output_path=output_path,
         sql_template=sql_template,
-        operation_name="export_by_location",
+        operation_name=operation_name,
         input1_layer=input_layer,
         input1_columns=input_columns,
         input1_columns_prefix="",
         input2_layer=input_to_compare_with_layer,
         input2_columns=[],
         input2_columns_prefix="",
         output_layer=output_layer,
         explodecollections=False,
         force_output_geometrytype=input_layer_info.geometrytype,
         gridsize=gridsize,
         where_post=where_post,
         nb_parallel=nb_parallel,
         batchsize=batchsize,
         force=force,
+        tmp_dir=tmp_dir,
     )
 
+    # Print time taken
+    logger.info(f"Ready, full export_by_location took {datetime.now()-start_time}")
+
 
 def export_by_distance(
     input_to_select_from_path: Path,
     input_to_compare_with_path: Path,
     output_path: Path,
     max_distance: float,
     input1_layer: Optional[str] = None,
-    input1_columns: Optional[List[str]] = None,
+    input1_columns: Optional[list[str]] = None,
     input2_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
     gridsize: float = 0.0,
     where_post: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
@@ -1370,32 +1545,41 @@
     )
 
 
 def intersection(
     input1_path: Path,
     input2_path: Path,
     output_path: Path,
+    overlay_self: bool,
     input1_layer: Optional[str] = None,
-    input1_columns: Optional[List[str]] = None,
+    input1_columns: Optional[list[str]] = None,
     input1_columns_prefix: str = "l1_",
     input2_layer: Optional[str] = None,
-    input2_columns: Optional[List[str]] = None,
+    input2_columns: Optional[list[str]] = None,
     input2_columns_prefix: str = "l2_",
     output_layer: Optional[str] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
     where_post: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
-    output_with_spatial_index: bool = True,
+    output_with_spatial_index: Optional[bool] = None,
     operation_prefix: str = "",
 ):
+    # If we are doing a self overlay, we need to filter out rows with the same rowid.
+    where_clause_self = "1=1"
+    if overlay_self:
+        where_clause_self = "layer1.rowid <> layer2.rowid"
+
     # In the query, important to only extract the geometry types that are expected
-    # TODO: test for geometrycollection, line, point,...
+    if input1_layer is None:
+        input1_layer = gfo.get_only_layer(input1_path)
+    if input2_layer is None:
+        input2_layer = gfo.get_only_layer(input2_path)
     input1_layer_info = gfo.get_layerinfo(input1_path, input1_layer)
     input2_layer_info = gfo.get_layerinfo(input2_path, input2_layer)
     primitivetype_to_extract = PrimitiveType(
         min(
             input1_layer_info.geometrytype.to_primitivetype.value,
             input2_layer_info.geometrytype.to_primitivetype.value,
         )
@@ -1431,15 +1615,15 @@
                     {{layer2_columns_prefix_alias_str}}
                 FROM {{input1_databasename}}."{{input1_layer}}" layer1
                 JOIN {{input1_databasename}}."{input1_layer_rtree}" layer1tree
                   ON layer1.fid = layer1tree.id
                 JOIN {{input2_databasename}}."{{input2_layer}}" layer2
                 JOIN {{input2_databasename}}."{input2_layer_rtree}" layer2tree
                   ON layer2.fid = layer2tree.id
-               WHERE 1=1
+               WHERE {where_clause_self}
                  {{batch_filter}}
                  AND layer1tree.minx <= layer2tree.maxx
                  AND layer1tree.maxx >= layer2tree.minx
                  AND layer1tree.miny <= layer2tree.maxy
                  AND layer1tree.maxy >= layer2tree.miny
                  AND ST_Intersects(
                         layer1.{{input1_geometrycolumn}},
@@ -1482,18 +1666,18 @@
     input2_path: Path,
     output_path: Path,
     spatial_relations_query: str = "intersects is True",
     discard_nonmatching: bool = True,
     min_area_intersect: Optional[float] = None,
     area_inters_column_name: Optional[str] = None,
     input1_layer: Optional[str] = None,
-    input1_columns: Optional[List[str]] = None,
+    input1_columns: Optional[list[str]] = None,
     input1_columns_prefix: str = "l1_",
     input2_layer: Optional[str] = None,
-    input2_columns: Optional[List[str]] = None,
+    input2_columns: Optional[list[str]] = None,
     input2_columns_prefix: str = "l2_",
     output_layer: Optional[str] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
     where_post: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
@@ -1510,30 +1694,30 @@
             area_inters_column_name_touse = area_inters_column_name
             area_inters_column_in_output = f',"{area_inters_column_name}"'
             area_inters_column_0_in_output = f',0 AS "{area_inters_column_name}"'
         else:
             area_inters_column_name_touse = "area_inters"
         area_inters_column_expression = (
             ",ST_area(ST_intersection(sub_filter.geom, sub_filter.l2_geom)) "
-            f'as "{area_inters_column_name_touse}"'
+            f'AS "{area_inters_column_name_touse}"'
         )
         if min_area_intersect is not None:
             area_inters_filter = (
                 f'WHERE sub_area."{area_inters_column_name_touse}" '
                 f">= {min_area_intersect}"
             )
 
-    # Prepare spatial relations filter
-    if spatial_relations_query != "intersects is True":
-        # joining should only be possible on features that at least have an
-        # interaction! So, add "intersects is True" to query to avoid errors!
-        spatial_relations_query = f"({spatial_relations_query}) and intersects is True"
-    spatial_relations_filter = _prepare_spatial_relations_filter(
-        spatial_relations_query
-    )
+    # Prepare spatial relation column and filter
+    # As the query is used as the join criterium, it should not evaluate to True for
+    # disjoint features. So specify avoid_disjoint=True.
+    (
+        spatial_relation_column,
+        spatial_relation_filter,
+        _,
+    ) = _prepare_filter_by_location_fields(spatial_relations_query, avoid_disjoint=True)
 
     # Prepare sql template
     #
     # Remark: use "LIMIT -1 OFFSET 0" to avoid that the sqlite query optimizer
     #     "flattens" the subquery, as that makes checking the spatial
     #     relations (using ST_RelateMatch) very slow!
     input1_layer_rtree = "rtree_{input1_layer}_{input1_geometrycolumn}"
@@ -1546,56 +1730,51 @@
                     {area_inters_column_expression}
                 FROM (
                   SELECT layer1.{{input1_geometrycolumn}} AS geom
                         ,layer1.fid l1_fid
                         ,layer2.{{input2_geometrycolumn}} AS l2_geom
                         {{layer1_columns_prefix_alias_str}}
                         {{layer2_columns_prefix_alias_str}}
-                        ,ST_relate(
-                            layer1.{{input1_geometrycolumn}},
-                            layer2.{{input2_geometrycolumn}}
-                         ) AS "GFO_$TEMP$_SPATIAL_RELATION"
+                        {spatial_relation_column}
                     FROM {{input1_databasename}}."{{input1_layer}}" layer1
                     JOIN {{input1_databasename}}."{input1_layer_rtree}" layer1tree
                       ON layer1.fid = layer1tree.id
                     JOIN {{input2_databasename}}."{{input2_layer}}" layer2
                     JOIN {{input2_databasename}}."{input2_layer_rtree}" layer2tree
                       ON layer2.fid = layer2tree.id
                    WHERE 1=1
                      {{batch_filter}}
                      AND layer1tree.minx <= layer2tree.maxx
                      AND layer1tree.maxx >= layer2tree.minx
                      AND layer1tree.miny <= layer2tree.maxy
                      AND layer1tree.maxy >= layer2tree.miny
                    LIMIT -1 OFFSET 0
                   ) sub_filter
-               WHERE {spatial_relations_filter.format(
-                    spatial_relation='sub_filter."GFO_$TEMP$_SPATIAL_RELATION"')}
+               WHERE {spatial_relation_filter}
                LIMIT -1 OFFSET 0
               ) sub_area
            {area_inters_filter}
+           LIMIT -1 OFFSET 0
           )
         SELECT sub.geom
               {{layer1_columns_from_subselect_str}}
               {{layer2_columns_from_subselect_str}}
-              ,sub."GFO_$TEMP$_SPATIAL_RELATION" AS spatial_relation
               {area_inters_column_in_output}
           FROM layer1_relations_filtered sub
     """
 
     # If a left join is asked, add all features from layer1 that weren't
     # matched.
     if discard_nonmatching is False:
         sql_template = f"""
             {sql_template}
             UNION ALL
-            SELECT layer1.{{input1_geometrycolumn}} as geom
+            SELECT layer1.{{input1_geometrycolumn}} AS geom
                   {{layer1_columns_prefix_alias_str}}
                   {{layer2_columns_prefix_alias_null_str}}
-                  ,NULL AS spatial_relation
                   {area_inters_column_0_in_output}
               FROM {{input1_databasename}}."{{input1_layer}}" layer1
              WHERE 1=1
                {{batch_filter}}
                AND layer1.fid NOT IN (
                    SELECT l1_fid FROM layer1_relations_filtered)
         """
@@ -1621,17 +1800,101 @@
         where_post=where_post,
         nb_parallel=nb_parallel,
         batchsize=batchsize,
         force=force,
     )
 
 
+def _prepare_filter_by_location_fields(
+    query: str,
+    geom1: str = "layer1.{input1_geometrycolumn}",
+    geom2: str = "layer2.{input2_geometrycolumn}",
+    subquery_alias: str = "sub_filter",
+    avoid_disjoint: bool = False,
+) -> tuple[str, str, bool]:
+    """
+    Prepare the fields needed to prepare a select to filter by location.
+
+    Args:
+        query (str): the spatial relations query that should be filtered on.
+        geom1 (str): the 1st geom in the spatial_relation_column.
+        geom2 (str): the 2nd geom in the spatial_relation_column.
+        subquery_alias (str): the alias tha will be used for the subquery to filter on.
+            Defaults to "sub_filter".
+        avoid_disjoint (bool): avoid that the query evaluates disjoint featurs to True.
+            If it does, "intersects is True" is added to the input query.
+
+    Returns:
+        Tuple[str, str, bool]: returns a tuple with the following values:
+            - spatial_relation_column: the string to use as column to filter on
+            - spatial_relation_filter: the string to use as filter
+            - true_for_disjoint: True if the query returns True for disjoint features.
+                  If `avoid_disjoint` is True, `includes_disjoint` is always False.
+    """
+    # Add a specific optimisation for "intersects is True" as it is the most used
+    # filtering and it is very optimised in GEOS.
+    if query.lower() == "intersects is true":
+        spatial_relation_column = (
+            f',ST_intersects({geom1}, {geom2}) AS "GFO_$TEMP$_SPATIAL_RELATION"'
+        )
+        spatial_relation_filter = f'{subquery_alias}."GFO_$TEMP$_SPATIAL_RELATION" = 1'
+        true_for_disjoint = False
+
+        return (spatial_relation_column, spatial_relation_filter, true_for_disjoint)
+
+    # It is a more complex query, so some more processing needed
+    spatial_relations_filter = _prepare_spatial_relations_filter(query)
+    spatial_relation_column = (
+        ',ST_relate({input1}, {input2}) AS "GFO_$TEMP$_SPATIAL_RELATION"'
+    )
+    spatial_relation_filter = spatial_relations_filter.format(
+        spatial_relation=f'{subquery_alias}."GFO_$TEMP$_SPATIAL_RELATION"'
+    )
+
+    # Determine of the spatial_relations_query returns True for disjoint features
+    spatial_relation_column_disjoint = spatial_relation_column.format(
+        input1="ST_GeomFromText('POLYGON((0 0, 0 1, 1 1, 1 0, 0 0))')",
+        input2="ST_GeomFromText('POLYGON((5 0, 5 1, 6 1, 6 0, 5 0))')",
+    )
+    test_path = Path(__file__).resolve().parent / "test.gpkg"
+    sql_stmt = f"""
+        SELECT * FROM (
+            SELECT NULL AS ignore
+                  {spatial_relation_column_disjoint}
+            ) {subquery_alias}
+         WHERE {spatial_relation_filter}
+    """
+    df = fileops.read_file(test_path, sql_stmt=sql_stmt)
+    true_for_disjoint = True if len(df) > 0 else False
+
+    if true_for_disjoint and avoid_disjoint:
+        # Avoid the query evaluating to True for disjoint features by adding
+        # "intersects is True"
+        query = f"({query}) and intersects is True"
+        spatial_relations_filter = _prepare_spatial_relations_filter(query)
+        spatial_relation_filter = spatial_relations_filter.format(
+            spatial_relation=f'{subquery_alias}."GFO_$TEMP$_SPATIAL_RELATION"'
+        )
+        true_for_disjoint = False
+
+        warnings.warn(
+            "The spatial relation query specified evaluated to True for disjoint "
+            f"features. To avoid this, 'intersects is True' was added: {query}",
+            stacklevel=2,
+        )
+
+    # Fill out input columns of the spatial_relation_column
+    spatial_relation_column = spatial_relation_column.format(input1=geom1, input2=geom2)
+
+    return (spatial_relation_column, spatial_relation_filter, true_for_disjoint)
+
+
 def _prepare_spatial_relations_filter(query: str) -> str:
     named_spatial_relations = {
-        # "disjoint": ["FF*FF****"],
+        "disjoint": ["FF*FF****"],
         "equals": ["TFFF*FFF*"],
         "touches": ["FT*******", "F**T*****", "F***T****"],
         "within": ["T*F**F***"],
         "overlaps": ["T*T***T**", "1*T***T**"],
         "crosses": ["T*T******", "T*****T**", "0********"],
         "intersects": ["T********", "*T*******", "***T*****", "****T****"],
         "contains": ["T*****FF*"],
@@ -1690,21 +1953,21 @@
 
 
 def join_nearest(
     input1_path: Path,
     input2_path: Path,
     output_path: Path,
     nb_nearest: int,
-    distance: float,
-    expand: bool,
+    distance: Optional[float],
+    expand: Optional[bool],
     input1_layer: Optional[str] = None,
-    input1_columns: Optional[List[str]] = None,
+    input1_columns: Optional[list[str]] = None,
     input1_columns_prefix: str = "l1_",
     input2_layer: Optional[str] = None,
-    input2_columns: Optional[List[str]] = None,
+    input2_columns: Optional[list[str]] = None,
     input2_columns_prefix: str = "l2_",
     output_layer: Optional[str] = None,
     explodecollections: bool = False,
     nb_parallel: int = -1,
     batchsize: int = -1,
     force: bool = False,
 ):
@@ -1828,28 +2091,29 @@
 
 def select_two_layers(
     input1_path: Path,
     input2_path: Path,
     output_path: Path,
     sql_stmt: str,
     input1_layer: Optional[str] = None,
-    input1_columns: Optional[List[str]] = None,
+    input1_columns: Optional[list[str]] = None,
     input1_columns_prefix: str = "l1_",
     input2_layer: Optional[str] = None,
-    input2_columns: Optional[List[str]] = None,
+    input2_columns: Optional[list[str]] = None,
     input2_columns_prefix: str = "l2_",
     output_layer: Optional[str] = None,
     force_output_geometrytype: Optional[GeometryType] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
     where_post: Optional[str] = None,
     nb_parallel: int = 1,
     batchsize: int = -1,
     force: bool = False,
     operation_prefix: str = "",
+    output_with_spatial_index: Optional[bool] = None,
 ):
     # Go!
     return _two_layer_vector_operation(
         input1_path=input1_path,
         input2_path=input2_path,
         output_path=output_path,
         sql_template=sql_stmt,
@@ -1864,26 +2128,28 @@
         explodecollections=explodecollections,
         force_output_geometrytype=force_output_geometrytype,
         gridsize=gridsize,
         where_post=where_post,
         nb_parallel=nb_parallel,
         batchsize=batchsize,
         force=force,
+        output_with_spatial_index=output_with_spatial_index,
     )
 
 
 def identity(
     input1_path: Path,
     input2_path: Path,
     output_path: Path,
+    overlay_self: bool,
     input1_layer: Optional[str] = None,
-    input1_columns: Optional[List[str]] = None,
+    input1_columns: Optional[list[str]] = None,
     input1_columns_prefix: str = "l1_",
     input2_layer: Optional[str] = None,
-    input2_columns: Optional[List[str]] = None,
+    input2_columns: Optional[list[str]] = None,
     input2_columns_prefix: str = "l2_",
     output_layer: Optional[str] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
     where_post: Optional[str] = None,
     nb_parallel: int = 1,
     batchsize: int = -1,
@@ -1894,33 +2160,31 @@
     # input2 and an erase of input2 with input1.
 
     # Because the calculations of the intermediate results will be towards temp files,
     # we need to do some additional init + checks here...
     if subdivide_coords < 0:
         raise ValueError("subdivide_coords < 0 is not allowed")
     logger = logging.getLogger("geofileops.identity")
-    if output_path.exists():
-        if force is False:
-            logger.info(f"Stop, output exists already {output_path}")
-            return
-        else:
-            gfo.remove(output_path)
+    if _io_util.output_exists(path=output_path, remove_if_exists=force):
+        return
+
     if output_layer is None:
         output_layer = gfo.get_default_layer(output_path)
 
     start_time = datetime.now()
     tempdir = _io_util.create_tempdir("geofileops/identity")
     try:
         # First calculate intersection of input1 with input2 to a temporary output file
         logger.info("Step 1 of 3: intersection")
         intersection_output_path = tempdir / "intersection_output.gpkg"
         intersection(
             input1_path=input1_path,
             input2_path=input2_path,
             output_path=intersection_output_path,
+            overlay_self=overlay_self,
             input1_layer=input1_layer,
             input1_columns=input1_columns,
             input1_columns_prefix=input1_columns_prefix,
             input2_layer=input2_layer,
             input2_columns=input2_columns,
             input2_columns_prefix=input2_columns_prefix,
             output_layer=output_layer,
@@ -1937,14 +2201,15 @@
         # Now erase input1 from input2 to another temporary output gfo...
         logger.info("Step 2 of 3: erase")
         erase_output_path = tempdir / "erase_output.gpkg"
         erase(
             input_path=input1_path,
             erase_path=input2_path,
             output_path=erase_output_path,
+            overlay_self=overlay_self,
             input_layer=input1_layer,
             input_columns=input1_columns,
             input_columns_prefix=input1_columns_prefix,
             erase_layer=input2_layer,
             output_layer=output_layer,
             explodecollections=explodecollections,
             gridsize=gridsize,
@@ -1969,36 +2234,37 @@
 
         # Convert or add spatial index
         tmp_output_path = intersection_output_path
         if intersection_output_path.suffix != output_path.suffix:
             # Output file should be in different format, so convert
             tmp_output_path = tempdir / output_path.name
             gfo.copy_layer(src=intersection_output_path, dst=tmp_output_path)
-        else:
-            # Create spatial index
+        elif GeofileInfo(tmp_output_path).default_spatial_index:
             gfo.create_spatial_index(path=tmp_output_path, layer=output_layer)
 
         # Now we are ready to move the result to the final spot...
         gfo.move(tmp_output_path, output_path)
 
     finally:
-        shutil.rmtree(tempdir, ignore_errors=True)
+        if ConfigOptions.remove_temp_files:
+            shutil.rmtree(tempdir, ignore_errors=True)
 
     logger.info(f"Ready, full identity took {datetime.now()-start_time}")
 
 
 def symmetric_difference(
     input1_path: Path,
     input2_path: Path,
     output_path: Path,
+    overlay_self: bool,
     input1_layer: Optional[str] = None,
-    input1_columns: Optional[List[str]] = None,
+    input1_columns: Optional[list[str]] = None,
     input1_columns_prefix: str = "l1_",
     input2_layer: Optional[str] = None,
-    input2_columns: Optional[List[str]] = None,
+    input2_columns: Optional[list[str]] = None,
     input2_columns_prefix: str = "l2_",
     output_layer: Optional[str] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
     where_post: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
@@ -2009,34 +2275,36 @@
     # and input2 and then append the result of an erase of input2 with
     # input1...
 
     # Because both erase calculations will be towards temp files,
     # we need to do some additional init + checks here...
     if subdivide_coords < 0:
         raise ValueError("subdivide_coords < 0 is not allowed")
-    if force is False and output_path.exists():
-        return
     if output_layer is None:
         output_layer = gfo.get_default_layer(output_path)
 
     start_time = datetime.now()
     logger = logging.getLogger("geofileops.symmetric_difference")
     logger.info(
         f"Start, with input1: {input1_path}, "
         f"input2: {input2_path}, output: {output_path}"
     )
+    if _io_util.output_exists(path=output_path, remove_if_exists=force):
+        return
+
     tempdir = _io_util.create_tempdir("geofileops/symmdiff")
     try:
         # First erase input2 from input1 to a temporary output file
         logger.info("Step 1 of 3: erase 1")
         erase1_output_path = tempdir / "layer1_erase_layer2_output.gpkg"
         erase(
             input_path=input1_path,
             erase_path=input2_path,
             output_path=erase1_output_path,
+            overlay_self=overlay_self,
             input_layer=input1_layer,
             input_columns=input1_columns,
             input_columns_prefix=input1_columns_prefix,
             erase_layer=input2_layer,
             output_layer=output_layer,
             explodecollections=explodecollections,
             gridsize=gridsize,
@@ -2064,14 +2332,15 @@
         # Now erase input1 from input2 to another temporary output file
         logger.info("Step 2 of 3: erase 2")
         erase2_output_path = tempdir / "layer2_erase_layer1_output.gpkg"
         erase(
             input_path=input2_path,
             erase_path=input1_path,
             output_path=erase2_output_path,
+            overlay_self=overlay_self,
             input_layer=input2_layer,
             input_columns=input2_columns,
             input_columns_prefix=input2_columns_prefix,
             erase_layer=input1_layer,
             output_layer=output_layer,
             explodecollections=explodecollections,
             gridsize=gridsize,
@@ -2096,38 +2365,37 @@
 
         # Convert or add spatial index
         tmp_output_path = erase1_output_path
         if erase1_output_path.suffix != output_path.suffix:
             # Output file should be in diffent format, so convert
             tmp_output_path = tempdir / output_path.name
             gfo.copy_layer(src=erase1_output_path, dst=tmp_output_path)
-        else:
-            # Create spatial index
+        elif GeofileInfo(tmp_output_path).default_spatial_index:
             gfo.create_spatial_index(path=tmp_output_path, layer=output_layer)
 
         # Now we are ready to move the result to the final spot...
-        if output_path.exists():
-            gfo.remove(output_path)
         gfo.move(tmp_output_path, output_path)
 
     finally:
-        shutil.rmtree(tempdir, ignore_errors=True)
+        if ConfigOptions.remove_temp_files:
+            shutil.rmtree(tempdir, ignore_errors=True)
 
     logger.info(f"Ready, full symmetric_difference took {datetime.now()-start_time}")
 
 
 def union(
     input1_path: Path,
     input2_path: Path,
     output_path: Path,
+    overlay_self: bool,
     input1_layer: Optional[str] = None,
-    input1_columns: Optional[List[str]] = None,
+    input1_columns: Optional[list[str]] = None,
     input1_columns_prefix: str = "l1_",
     input2_layer: Optional[str] = None,
-    input2_columns: Optional[List[str]] = None,
+    input2_columns: Optional[list[str]] = None,
     input2_columns_prefix: str = "l2_",
     output_layer: Optional[str] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
     where_post: Optional[str] = None,
     nb_parallel: int = -1,
     batchsize: int = -1,
@@ -2139,33 +2407,32 @@
 
     # Because the calculations of the intermediate results will be towards temp files,
     # we need to do some additional init + checks here...
     if subdivide_coords < 0:
         raise ValueError("subdivide_coords < 0 is not allowed")
 
     logger = logging.getLogger("geofileops.union")
-    if output_path.exists():
-        if force is False:
-            logger.info(f"Stop, output exists already {output_path}")
-            return
-        else:
-            gfo.remove(output_path)
+
+    if _io_util.output_exists(path=output_path, remove_if_exists=force):
+        return
+
     if output_layer is None:
         output_layer = gfo.get_default_layer(output_path)
 
     start_time = datetime.now()
     tempdir = _io_util.create_tempdir("geofileops/union")
     try:
         # First apply intersection of input1 with input2 to a temporary output file...
         logger.info("Step 1 of 4: intersection")
         intersection_output_path = tempdir / "intersection_output.gpkg"
         intersection(
             input1_path=input1_path,
             input2_path=input2_path,
             output_path=intersection_output_path,
+            overlay_self=overlay_self,
             input1_layer=input1_layer,
             input1_columns=input1_columns,
             input1_columns_prefix=input1_columns_prefix,
             input2_layer=input2_layer,
             input2_columns=input2_columns,
             input2_columns_prefix=input2_columns_prefix,
             output_layer=output_layer,
@@ -2175,21 +2442,22 @@
             nb_parallel=nb_parallel,
             batchsize=batchsize,
             force=force,
             output_with_spatial_index=False,
             operation_prefix="union/",
         )
 
-        # Now erase input1 from input2 to another temporary output gfo...
+        # Erase input1 from input2 to another temporary output gfo.
         logger.info("Step 2 of 4: erase input 1 from input 2")
         erase1_output_path = tempdir / "erase_input1_from_input2_output.gpkg"
         erase(
             input_path=input2_path,
             erase_path=input1_path,
             output_path=erase1_output_path,
+            overlay_self=overlay_self,
             input_layer=input2_layer,
             input_columns=input2_columns,
             input_columns_prefix=input2_columns_prefix,
             erase_layer=input1_layer,
             output_layer=output_layer,
             explodecollections=explodecollections,
             gridsize=gridsize,
@@ -2197,22 +2465,32 @@
             nb_parallel=nb_parallel,
             batchsize=batchsize,
             subdivide_coords=subdivide_coords,
             force=force,
             output_with_spatial_index=False,
             operation_prefix="union/",
         )
+        # Note: append will never create an index on an already existing layer.
+        _append_to_nolock(
+            src=erase1_output_path,
+            dst=intersection_output_path,
+            src_layer=output_layer,
+            dst_layer=output_layer,
+        )
+        gfo.remove(erase1_output_path)
 
-        # Now erase input2 from input1 to another temporary output gfo...
+        # Erase input1 from input2 to and add to temporary output file.
         logger.info("Step 3 of 4: erase input 2 from input 1")
         erase2_output_path = tempdir / "erase_input2_from_input1_output.gpkg"
+
         erase(
             input_path=input1_path,
             erase_path=input2_path,
             output_path=erase2_output_path,
+            overlay_self=overlay_self,
             input_layer=input1_layer,
             input_columns=input1_columns,
             input_columns_prefix=input1_columns_prefix,
             erase_layer=input2_layer,
             output_layer=output_layer,
             explodecollections=explodecollections,
             gridsize=gridsize,
@@ -2220,72 +2498,66 @@
             nb_parallel=nb_parallel,
             batchsize=batchsize,
             subdivide_coords=subdivide_coords,
             force=force,
             output_with_spatial_index=False,
             operation_prefix="union/",
         )
-
-        # Now append
-        logger.info("Step 4 of 4: finalize")
-        # Note: append will never create an index on an already existing layer.
-        _append_to_nolock(
-            src=erase1_output_path,
-            dst=intersection_output_path,
-            src_layer=output_layer,
-            dst_layer=output_layer,
-        )
         _append_to_nolock(
             src=erase2_output_path,
             dst=intersection_output_path,
             src_layer=output_layer,
             dst_layer=output_layer,
         )
+        gfo.remove(erase2_output_path)
 
         # Convert or add spatial index
+        logger.info("Step 4 of 4: finalize")
+
         tmp_output_path = intersection_output_path
         if intersection_output_path.suffix != output_path.suffix:
             # Output file should be in different format, so convert
             tmp_output_path = tempdir / output_path.name
             gfo.copy_layer(src=intersection_output_path, dst=tmp_output_path)
-        else:
-            # Create spatial index
+        elif GeofileInfo(tmp_output_path).default_spatial_index:
             gfo.create_spatial_index(path=tmp_output_path, layer=output_layer)
 
         # Now we are ready to move the result to the final spot...
         gfo.move(tmp_output_path, output_path)
 
     finally:
-        shutil.rmtree(tempdir, ignore_errors=True)
+        if ConfigOptions.remove_temp_files:
+            shutil.rmtree(tempdir, ignore_errors=True)
 
     logger.info(f"Ready, full union took {datetime.now()-start_time}")
 
 
 def _two_layer_vector_operation(
     input1_path: Path,
     input2_path: Path,
     output_path: Path,
     sql_template: str,
     operation_name: str,
     input1_layer: Optional[str],
-    input1_columns: Optional[List[str]],
+    input1_columns: Optional[list[str]],
     input1_columns_prefix: str,
     input2_layer: Optional[str],
-    input2_columns: Optional[List[str]],
+    input2_columns: Optional[list[str]],
     input2_columns_prefix: str,
     output_layer: Optional[str],
     explodecollections: bool,
     force_output_geometrytype: Optional[GeometryType],
     gridsize: float,
     where_post: Optional[str],
     nb_parallel: int,
     batchsize: int,
     force: bool,
     use_ogr: bool = False,
-    output_with_spatial_index: bool = True,
+    output_with_spatial_index: Optional[bool] = None,
+    tmp_dir: Optional[Path] = None,
 ):
     """
     Executes an operation that needs 2 input files.
 
     Args:
         input1_path (str): the file to export features from
         input2_path (str): the file to check intersections with
@@ -2323,15 +2595,18 @@
             Defaults to -1: (try to) determine optimal size automatically.
         force (bool, optional): [description]. Defaults to False.
         use_ogr (bool, optional): If True, ogr is used to do the processing,
             In this case different input files (input1_path, input2_path) are
             NOT supported. If False, sqlite3 is used directly.
             Defaults to False.
         output_with_spatial_index (bool, optional): True to create output file with
-            spatial index. Defaults to True.
+            spatial index. None to use the GDAL default. Defaults to None.
+        tmp_dir (Path, optional): If None, a new temp dir will be created. if not None,
+            the temp dir specified will be used. In both cases the tmp_dir will be
+            removed after the operation if ConfigOptions.remove_temp_files is not False!
 
     Raises:
         ValueError: [description]
 
     .. |spatialite_reference_link| raw:: html
 
         <a href="https://www.gaia-gis.it/gaia-sins/spatialite-sql-latest.html" target="_blank">spatialite reference</a>
@@ -2348,50 +2623,50 @@
         raise ValueError(
             f"{operation_name}: output_path must not equal one of input paths"
         )
     if use_ogr is True and input1_path != input2_path:
         raise ValueError(
             f"{operation_name}: if use_ogr True, input1_path should equal input2_path!"
         )
-    if output_path.exists():
-        if force is False:
-            logger.info(f"Stop, output exists already {output_path}")
-            return
-        else:
-            gfo.remove(output_path)
+    if _io_util.output_exists(path=output_path, remove_if_exists=force):
+        return
+
+    if output_with_spatial_index is None:
+        output_with_spatial_index = GeofileInfo(output_path).default_spatial_index
 
     # Check if spatialite is properly installed to execute this query
     _sqlite_util.spatialite_version_info()
 
     # Init layer info
     start_time = datetime.now()
     if input1_layer is None:
         input1_layer = gfo.get_only_layer(input1_path)
     if input2_layer is None:
         input2_layer = gfo.get_only_layer(input2_path)
     if output_layer is None:
         output_layer = gfo.get_default_layer(output_path)
-    tempdir = _io_util.create_tempdir(f"geofileops/{operation_name}")
+    if tmp_dir is None:
+        tmp_dir = _io_util.create_tempdir(f"geofileops/{operation_name}")
 
     # Prepare output filename
-    tmp_output_path = tempdir / output_path.name
+    tmp_output_path = tmp_dir / output_path.name
     tmp_output_path.parent.mkdir(exist_ok=True, parents=True)
     gfo.remove(tmp_output_path)
 
     try:
         # Prepare tmp files/batches
         # -------------------------
-        logger.debug(f"Prepare input (params), tempdir: {tempdir}")
+        logger.debug(f"Prepare input (params), tempdir: {tmp_dir}")
         processing_params = _prepare_processing_params(
             input1_path=input1_path,
             input1_layer=input1_layer,
             input1_layer_alias="layer1",
             input2_path=input2_path,
             input2_layer=input2_layer,
-            tempdir=tempdir,
+            tempdir=tmp_dir,
             nb_parallel=nb_parallel,
             batchsize=batchsize,
             convert_to_spatialite_based=True,
         )
         if processing_params is None or processing_params.batches is None:
             return
 
@@ -2564,22 +2839,22 @@
         )
         with _processing_util.PooledExecutorFactory(
             threadpool=calculate_in_threads,
             max_workers=processing_params.nb_parallel,
             initializer=_processing_util.initialize_worker(),
         ) as calculate_pool:
             # Start looping
-            batches: Dict[int, dict] = {}
+            batches: dict[int, dict] = {}
             future_to_batch_id = {}
             for batch_id in processing_params.batches:
                 batches[batch_id] = {}
                 batches[batch_id]["layer"] = output_layer
 
                 tmp_partial_output_path = (
-                    tempdir / f"{output_path.stem}_{batch_id}.gpkg"
+                    tmp_dir / f"{output_path.stem}_{batch_id}.gpkg"
                 )
                 batches[batch_id]["tmp_partial_output_path"] = tmp_partial_output_path
 
                 # Fill out final things in sql_template
                 sql_stmt = sql_template.format(
                     input1_databasename="{input1_databasename}",
                     input2_databasename="{input2_databasename}",
@@ -2667,17 +2942,17 @@
                     and tmp_partial_output_path.suffix.lower()
                     == tmp_output_path.suffix.lower()
                 ):
                     gfo.move(tmp_partial_output_path, tmp_output_path)
                 else:
                     # If there is only one batch, it is faster to create the spatial
                     # index immediately
-                    create_spatial_index = False
-                    if nb_batches == 1 and output_with_spatial_index:
-                        create_spatial_index = True
+                    create_spatial_index = (
+                        True if nb_batches == 1 and output_with_spatial_index else False
+                    )
 
                     fileops._append_to_nolock(
                         src=tmp_partial_output_path,
                         dst=tmp_output_path,
                         explodecollections=explodecollections,
                         force_output_geometrytype=force_output_geometrytype,
                         where=where_post,
@@ -2708,19 +2983,22 @@
             if tmp_output_path != output_path:
                 output_path.parent.mkdir(parents=True, exist_ok=True)
                 gfo.move(tmp_output_path, output_path)
         else:
             logger.debug("Result was empty!")
 
         logger.info(f"Ready, took {datetime.now()-start_time}")
-        shutil.rmtree(tempdir, ignore_errors=True)
+
     except Exception:
         gfo.remove(output_path, missing_ok=True)
         gfo.remove(tmp_output_path, missing_ok=True)
         raise
+    finally:
+        if ConfigOptions.remove_temp_files:
+            shutil.rmtree(tmp_dir, ignore_errors=True)
 
 
 def calculate_two_layers(
     input1_path: Path,
     input1_layer: str,
     input2_path: Path,
     input2_layer: str,
@@ -2817,90 +3095,103 @@
     convert_to_spatialite_based: bool,
     nb_parallel: int,
     batchsize: int = -1,
     input1_layer_alias: Optional[str] = None,
     input2_path: Optional[Path] = None,
     input2_layer: Optional[str] = None,
 ) -> Optional[ProcessingParams]:
-    # Init
-    input1_layerinfo = gfo.get_layerinfo(
-        input1_path, input1_layer, raise_on_nogeom=False
-    )
-
     # Prepare input files for the calculation
     if convert_to_spatialite_based:
-        # Check if the input files are of the correct geofiletype
+        # The input files should be spatialite based, and should be of the same type:
+        # either both GPKG, or both SQLite.
         input1_info = _geofileinfo.get_geofileinfo(input1_path)
         input2_info = (
             None if input2_path is None else _geofileinfo.get_geofileinfo(input2_path)
         )
 
-        # If input files are of the same format + are spatialite compatible,
-        # just use them
+        # If input1 is spatialite based and compatible with input2, no conversion.
         if input1_info.is_spatialite_based and (
-            input2_info is None or input1_info.driver == input2_info.driver
+            input1_info.driver == "GPKG"
+            or input2_info is None
+            or input2_info.driver == input2_info.driver
         ):
-            if (
-                input1_info.driver == "GPKG"
-                and input1_layerinfo.geometrycolumn is not None
-            ):
-                # HasSpatialindex doesn't work for spatialite file
-                gfo.create_spatial_index(input1_path, input1_layer, exist_ok=True)
+            if input1_info.driver == "GPKG":
+                # HasSpatialindex doesn't work for spatialite files.
+                gfo.create_spatial_index(
+                    input1_path, input1_layer, exist_ok=True, no_geom_ok=True
+                )
         else:
-            # If not ok, copy the input layer to gpkg
-            input1_tmp_path = tempdir / f"{input1_path.stem}.gpkg"
+            # input1 is not spatialite compatible, so convert it.
+            # If input2 is "Sqlite", convert input1 to SQLite as well.
+            suffix = ".gpkg"
+            if input2_info is not None and input2_info.driver == "SQLite":
+                suffix = ".sqlite"
+            input1_tmp_path = tempdir / f"{input1_path.stem}{suffix}"
             gfo.copy_layer(
                 src=input1_path,
                 src_layer=input1_layer,
                 dst=input1_tmp_path,
                 dst_layer=input1_layer,
                 preserve_fid=True,
             )
             input1_path = input1_tmp_path
+            input1_info = _geofileinfo.get_geofileinfo(input1_path)
+            if input1_info.driver == "SQLite":
+                # In sqlite, the layer name is sometimes changed...
+                input1_layer = gfo.get_only_layer(input1_path)
 
+        # If input2 is spatialite_based and compatible with input1, no conversion.
         if input2_path is not None and input2_info is not None:
             if (
-                input2_info.driver == input1_info.driver
-                and input2_info.is_spatialite_based
+                input2_info.is_spatialite_based
+                and input2_info.driver == input1_info.driver
             ):
-                input2_layerinfo = gfo.get_layerinfo(
-                    input2_path, input2_layer, raise_on_nogeom=False
-                )
-                if (
-                    input2_info.driver == "GPKG"
-                    and input2_layerinfo.geometrycolumn is not None
-                ):
-                    # HasSpatialindex doesn't work for spatialite file
-                    gfo.create_spatial_index(input2_path, input2_layer, exist_ok=True)
+                if input2_info.driver == "GPKG":
+                    # HasSpatialindex doesn't work for spatialite files.
+                    gfo.create_spatial_index(
+                        input2_path, input2_layer, exist_ok=True, no_geom_ok=True
+                    )
             else:
-                # If not spatialite compatible, copy the input layer to gpkg
-                input2_tmp_path = tempdir / f"{input2_path.stem}.gpkg"
+                # input2 is not spatialite compatible, so convert it.
+                # If input1 is "Sqlite", convert input2 to SQLite as well.
+                suffix = ".gpkg"
+                if input1_info is not None and input1_info.driver == "SQLite":
+                    suffix = ".sqlite"
+                input2_tmp_path = tempdir / f"{input2_path.stem}{suffix}"
+
+                # Make sure the copy is taken to a separate file.
+                if input2_tmp_path.exists():
+                    input2_tmp_path = tempdir / f"{input2_path.stem}2{suffix}"
                 gfo.copy_layer(
                     src=input2_path,
                     src_layer=input2_layer,
                     dst=input2_tmp_path,
                     dst_layer=input2_layer,
                     preserve_fid=True,
                 )
                 input2_path = input2_tmp_path
+                input2_info = _geofileinfo.get_geofileinfo(input2_path)
+                if input2_info.driver == "SQLite":
+                    # In sqlite, the layer name is sometimes changed...
+                    input2_layer = gfo.get_only_layer(input2_path)
 
     # Prepare batches to process
     layer1_info = gfo.get_layerinfo(input1_path, input1_layer, raise_on_nogeom=False)
     nb_rows_input_layer = layer1_info.featurecount
 
     # Determine optimal number of batches
     nb_parallel, nb_batches = _determine_nb_batches(
         nb_rows_input_layer=nb_rows_input_layer,
         nb_parallel=nb_parallel,
         batchsize=batchsize,
         is_twolayer_operation=input2_path is not None,
     )
 
     # Check number of batches + appoint nb rows to batches
-    batches: Dict[int, dict] = {}
+    batches: dict[int, dict] = {}
     if nb_batches == 1:
         # If only one batch, no filtering is needed
         batches[0] = {}
         batches[0]["input1_path"] = input1_path
         batches[0]["input1_layer"] = input1_layer
         batches[0]["input2_path"] = input2_path
         batches[0]["input2_layer"] = input2_layer
@@ -2978,17 +3269,17 @@
             # The batch filter
             if batch_info.id < nb_batches - 1:
                 batches[batch_info.id]["batch_filter"] = (
                     f"AND ({layer_alias_d}rowid >= {batch_info.start_rowid} "
                     f"AND {layer_alias_d}rowid <= {batch_info.end_rowid}) "
                 )
             else:
-                batches[batch_info.id][
-                    "batch_filter"
-                ] = f"AND {layer_alias_d}rowid >= {batch_info.start_rowid} "
+                batches[batch_info.id]["batch_filter"] = (
+                    f"AND {layer_alias_d}rowid >= {batch_info.start_rowid} "
+                )
 
     # No use starting more processes than the number of batches...
     if len(batches) < nb_parallel:
         nb_parallel = len(batches)
 
     returnvalue = ProcessingParams(
         input1_path=input1_path,
@@ -3005,15 +3296,15 @@
 
 def _determine_nb_batches(
     nb_rows_input_layer: int,
     nb_parallel: int,
     batchsize: int,
     is_twolayer_operation: bool,
     cpu_count: Optional[int] = None,
-) -> Tuple[int, int]:
+) -> tuple[int, int]:
     """
     Determine an optimal number of batches and parallel workers.
 
     Args:
         nb_rows_input_layer (int): number of input rows
         nb_parallel (int): recommended number of workers
         batchsize (int): recommended number of rows per batch
@@ -3094,15 +3385,15 @@
 def dissolve_singlethread(
     input_path: Path,
     output_path: Path,
     groupby_columns: Union[str, Iterable[str], None] = None,
     agg_columns: Optional[dict] = None,
     explodecollections: bool = False,
     gridsize: float = 0.0,
-    keep_empty_geoms: bool = True,
+    keep_empty_geoms: bool = False,
     where_post: Optional[str] = None,
     input_layer: Optional[str] = None,
     output_layer: Optional[str] = None,
     force: bool = False,
 ):
     """
     Remark: this is not a parallelized version!!!
@@ -3236,20 +3527,16 @@
                 # Now put everything together
                 agg_columns_str += (
                     f", {aggregation_str}({distinct_str}{column_str}{extra_param_str}) "
                     f'AS "{agg_column["as"]}"'
                 )
 
     # Check output path
-    if output_path.exists():
-        if force is False:
-            logger.info(f"Stop, output exists already {output_path}")
-            return
-        else:
-            gfo.remove(output_path)
+    if _io_util.output_exists(path=output_path, remove_if_exists=force):
+        return
 
     # Now prepare the sql statement
     # Remark: calculating the area in the enclosing selects halves the processing time
 
     # The operation to run on the geometry
     operation = f"ST_union(layer.{input_layerinfo.geometrycolumn})"
 
@@ -3273,18 +3560,18 @@
             gridsize=gridsize,
             force_output_geometrytype=force_output_geometrytype,
         )
 
     # Now the sql query can be assembled
     sql_stmt = f"""
         SELECT {operation} AS geom
-            {groupby_columns_for_select_str}
-            {agg_columns_str}
-        FROM "{input_layer}" layer
-        GROUP BY {groupby_columns_for_groupby_str}
+              {groupby_columns_for_select_str}
+              {agg_columns_str}
+          FROM "{input_layer}" layer
+         GROUP BY {groupby_columns_for_groupby_str}
     """
 
     # If empty/null geometries don't need to be kept, filter them away
     if not keep_empty_geoms:
         sql_stmt = f"""
             SELECT * FROM
                 ( {sql_stmt}
@@ -3299,15 +3586,15 @@
         # where_post till after explodecollections is applied, so when appending
         # the partial results to the output file.
         where_post = where_post.format(geometrycolumn="geom")
         sql_stmt = f"""
             SELECT * FROM
                 ( {sql_stmt}
                 )
-                WHERE {where_post}
+             WHERE {where_post}
         """
         # where_post has been applied already so set to None.
         where_post = None
 
     # When null geometries are being kept, we need to make sure the geom in the
     # first row is not NULL because of a bug in gdal, so add ORDER BY as last step.
     #   -> https://github.com/geofileops/geofileops/issues/308
@@ -3318,31 +3605,31 @@
                 )
              ORDER BY geom IS NULL
         """
 
     # Now we can really start
     tempdir = _io_util.create_tempdir("geofileops/dissolve_singlethread")
     try:
-        create_spatial_index = True
         suffix = output_path.suffix
+        options = {}
         if where_post is not None:
             # where_post needs to be applied still, so no spatial index needed
-            create_spatial_index = False
+            options["LAYER_CREATION.SPATIAL_INDEX"] = False
             suffix = ".gpkg"
         tmp_output_path = tempdir / f"output_tmp{suffix}"
 
         _ogr_util.vector_translate(
             input_path=input_path,
             output_path=tmp_output_path,
             output_layer=output_layer,
             sql_stmt=sql_stmt,
             sql_dialect="SQLITE",
             force_output_geometrytype=force_output_geometrytype,
             explodecollections=explodecollections,
-            options={"LAYER_CREATION.SPATIAL_INDEX": create_spatial_index},
+            options=options,
         )
 
         # We still need to apply the where_post filter
         if where_post is not None:
             tmp_output_where_path = tempdir / f"output_tmp2_where{output_path.suffix}"
             tmp_output_info = gfo.get_layerinfo(tmp_output_path)
             where_post = where_post.format(
@@ -3355,23 +3642,23 @@
             _ogr_util.vector_translate(
                 input_path=tmp_output_path,
                 output_path=tmp_output_where_path,
                 output_layer=output_layer,
                 force_output_geometrytype=force_output_geometrytype,
                 sql_stmt=sql_stmt,
                 sql_dialect="SQLITE",
-                options={"LAYER_CREATION.SPATIAL_INDEX": True},
             )
             tmp_output_path = tmp_output_where_path
 
         # Now we are ready to move the result to the final spot...
         gfo.move(tmp_output_path, output_path)
 
     finally:
-        shutil.rmtree(tempdir, ignore_errors=True)
+        if ConfigOptions.remove_temp_files:
+            shutil.rmtree(tempdir, ignore_errors=True)
 
     logger.info(f"Ready, took {datetime.now()-start_time}")
 
 
 def _format_apply_gridsize_operation(
     geometrycolumn: str, gridsize: float, force_output_geometrytype: GeometryType
 ) -> str:
```

### Comparing `geofileops-0.8.2/geofileops/util/_geoseries_util.py` & `geofileops-0.9.0/geofileops/util/_geoseries_util.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,38 +1,38 @@
 """
 Module containing utilities regarding operations on geoseries.
 """
 
 import logging
-from typing import List, Union
 import warnings
+from typing import Union
 
 import geopandas as gpd
 import geopandas._compat as gpd_compat
 import numpy as np
-from numpy.typing import NDArray
 import pandas as pd
-from pygeoops import GeometryType
-from pygeoops._general import _extract_0dim_ndarray
 import pygeoops
 import shapely
+from numpy.typing import NDArray
+from pygeoops import GeometryType
+from pygeoops._general import _extract_0dim_ndarray
 from shapely.geometry.base import BaseGeometry
 
-if gpd_compat.USE_PYGEOS:
+if hasattr(gpd_compat, "USE_PYGEOS") and gpd_compat.USE_PYGEOS:
     import pygeos as shapely2_or_pygeos
 else:
     import shapely as shapely2_or_pygeos
 
 # Get a logger...
 logger = logging.getLogger(__name__)
 
 
 def get_geometrytypes(
     geoseries: gpd.GeoSeries, ignore_empty_geometries: bool = True
-) -> List[GeometryType]:
+) -> list[GeometryType]:
     """
     Determine the geometry types in the GeoDataFrame.
 
     Args:
         geoseries (gpd.GeoSeries): input geoseries.
         ignore_empty_geometries (bool, optional): True to ignore empty geometries.
             Defaults to True.
@@ -113,15 +113,15 @@
     )
 
 
 def _harmonize_to_multitype(
     geoseries: gpd.GeoSeries, dest_geometrytype: GeometryType
 ) -> gpd.GeoSeries:
     # Copy geoseries data to new array
-    if gpd_compat.USE_PYGEOS:
+    if hasattr(gpd_compat, "USE_PYGEOS") and gpd_compat.USE_PYGEOS:
         geometries_arr = geoseries.array.data.copy()
     else:
         geometries_arr = geoseries.copy()
 
     # Set empty geometries to None
     empty_idxs = shapely2_or_pygeos.is_empty(geometries_arr)
     if empty_idxs.sum():
```

### Comparing `geofileops-0.8.2/geofileops/util/_io_util.py` & `geofileops-0.9.0/geofileops/util/_io_util.py`

 * *Files 17% similar despite different names*

```diff
@@ -1,15 +1,18 @@
 """
 Module containing some utilities regarding io.
 """
 
+import logging
 import os
-from pathlib import Path
 import tempfile
-from typing import Optional, Tuple
+from pathlib import Path
+from typing import Optional
+
+import geofileops as gfo
 
 
 def create_tempdir(base_dirname: str, parent_dir: Optional[Path] = None) -> Path:
     """
     Creates a new tempdir in the default temp location.
 
     Remark: the temp dir won't be cleaned up automatically!
@@ -50,15 +53,15 @@
 
 
 def get_tempfile_locked(
     base_filename: str,
     suffix: str = ".tmp",
     dirname: Optional[str] = None,
     tempdir: Optional[Path] = None,
-) -> Tuple[Path, Path]:
+) -> tuple[Path, Path]:
     """
     Formats a temp file path, and creates a corresponding lock file.
 
     This way you can treat it immediately as being locked.
 
     Args:
         base_filename (str): The base filename to use. A numeric suffix will be
@@ -126,7 +129,38 @@
             raise Exception("Error creating lock file {filename}") from ex
 
 
 def with_stem(path: Path, new_stem) -> Path:
     # Remark: from python 3.9 this is available on any Path, but to avoid
     # having to require 3.9 for this, this hack...
     return path.parent / f"{new_stem}{path.suffix}"
+
+
+def output_exists(path: Path, remove_if_exists: bool) -> bool:
+    """
+    Checks and returns whether the file specified exists.
+
+    If remove_if_exists is True, the file is removed and False is returned.
+
+    Args:
+        path (Path): Output file path to check.
+        remove_if_exists (bool): If True, remove the output file if it exists.
+
+    Raises:
+        ValueError: raised when the output directory does not exist.
+
+    Returns:
+        bool: True if the output file exists.
+              False if the file didn't exist or if it was removed
+              because `remove_if_exists` is True.
+    """
+    if not path.parent.exists():
+        raise ValueError(f"Output directory does not exist: {path.parent}")
+    if path.exists():
+        if remove_if_exists:
+            gfo.remove(path)
+            return False
+        else:
+            logging.info(msg=f"Stop, output exists already {path}", stacklevel=2)
+            return True
+
+    return False
```

### Comparing `geofileops-0.8.2/geofileops/util/_ogr_sql_util.py` & `geofileops-0.9.0/geofileops/util/_ogr_sql_util.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,27 +1,28 @@
 """
 Module with utilities to format sql statements meant for use with ogr.
 """
 
-from typing import Iterable, List, Optional
+from collections.abc import Iterable
+from typing import Optional
 
 
 class ColumnFormatter:
     """
     Format strings with the columns for use in sql statements.
 
     There are some specific hacks that are related to specific behaviours of ogr, mainly
     regarding the handling of the special "fid" column.
     """
 
-    _aliases_cache: Optional[List[str]] = None
+    _aliases_cache: Optional[list[str]] = None
 
     def __init__(
         self,
-        columns_asked: Optional[List[str]],
+        columns_asked: Optional[list[str]],
         columns_in_layer: Iterable[str],
         fid_column: str,
         table_alias: str = "",
         column_alias_prefix: str = "",
     ):
         """
         Format strings with column names for use in sql statements.
@@ -75,22 +76,22 @@
         else:
             columns = list(columns_in_layer)
             columns_asked = columns
 
         self._columns = columns
         self._columns_asked = columns_asked
 
-    def _columns_prefixed(self) -> List[str]:
+    def _columns_prefixed(self) -> list[str]:
         columns_prefixed = [
             f'{self._table_prefix}"{column}"' for column in self._columns
         ]
         columns_prefixed = self._fix_fid_columns(columns_prefixed)
         return columns_prefixed
 
-    def _fix_fid_columns(self, columns: List[str]) -> List[str]:
+    def _fix_fid_columns(self, columns: list[str]) -> list[str]:
         """
         Fix the fid columns.
 
         Useful if the "fid" special column needs some extra treatment:
             - if the fid_column name as reported by gdal is "", this means that the file
               format doesn't actually save the fid (eg. shapefile) but uses a row number
               in the file. When using sql in sql_dialect "SQLITE", "rowid" is the
@@ -117,15 +118,15 @@
             for fid_column_index in fid_column_indexes:
                 columns[fid_column_index] = columns[fid_column_index].replace(
                     self._columns[fid_column_index], replace_fid_column
                 )
 
         return columns
 
-    def _aliases(self) -> List[str]:
+    def _aliases(self) -> list[str]:
         if self._aliases_cache is not None:
             return self._aliases_cache
 
         # Use columns_asked to keep asked casing
         aliases = [
             f"{self._columnname_prefix}{column}" for column in self._columns_asked
         ]
@@ -181,12 +182,12 @@
             return ""
 
         prefix = "" if subselect_alias == "" else f"{subselect_alias}."
         columns_from_subselect = [f'{prefix}"{alias}"' for alias in self._aliases()]
         return f",{', '.join(columns_from_subselect)}"
 
 
-def columns_quoted(columns: List[str]):
+def columns_quoted(columns: list[str]):
     if len(columns) == 0:
         return ""
     columns_quoted = [f'"{column}"' for column in columns]
     return f",{', '.join(columns_quoted)}"
```

### Comparing `geofileops-0.8.2/geofileops/util/_ogr_util.py` & `geofileops-0.9.0/geofileops/util/_ogr_util.py`

 * *Files 1% similar despite different names*

```diff
@@ -1,20 +1,20 @@
 """
 Module containing utilities regarding the usage of ogr/gdal functionalities.
 """
 
 import logging
 import os
-from pathlib import Path
 import tempfile
+from collections.abc import Iterable
+from pathlib import Path
 from threading import Lock
-from typing import Dict, List, Literal, Optional, Tuple, Union
+from typing import Literal, Optional, Union
 
-from osgeo import gdal
-from osgeo import ogr
+from osgeo import gdal, ogr
 from pygeoops import GeometryType
 
 import geofileops as gfo
 from geofileops import fileops
 
 # Make sure only one instance per process is running
 lock = Lock()
@@ -25,16 +25,16 @@
 
 class GDALError(Exception):
     """Error with extra gdal info."""
 
     def __init__(
         self,
         message: str,
-        log_details: [List[str]] = [],
-        error_details: [List[str]] = [],
+        log_details: list[str] = [],
+        error_details: list[str] = [],
     ):
         self.message = message
         self.log_details = log_details
         self.error_details = error_details
         super().__init__(self.message)
 
     def __str__(self):
@@ -106,15 +106,15 @@
     drivers = {}
     for i in range(gdal.GetDriverCount()):
         driver = gdal.GetDriver(i)
         drivers[driver.ShortName] = driver.GetDescription()
     return drivers
 
 
-def read_cpl_log(path: Path) -> Tuple[List[str], List[str]]:
+def read_cpl_log(path: Path) -> tuple[list[str], list[str]]:
     """
     Reads a cpl_log file and returns a list with log lines and errors.
 
     Args:
         path (Path): the file path to the cpl_log file.
 
     Returns:
@@ -141,31 +141,31 @@
 
 
 class VectorTranslateInfo:
     def __init__(
         self,
         input_path: Path,
         output_path: Path,
-        input_layers: Union[List[str], str, None] = None,
+        input_layers: Union[list[str], str, None] = None,
         output_layer: Optional[str] = None,
         input_srs: Union[int, str, None] = None,
         output_srs: Union[int, str, None] = None,
         reproject: bool = False,
-        spatial_filter: Optional[Tuple[float, float, float, float]] = None,
-        clip_geometry: Optional[Union[Tuple[float, float, float, float], str]] = None,
+        spatial_filter: Optional[tuple[float, float, float, float]] = None,
+        clip_geometry: Optional[Union[tuple[float, float, float, float], str]] = None,
         sql_stmt: Optional[str] = None,
         sql_dialect: Optional[Literal["SQLITE", "OGRSQL"]] = None,
         where: Optional[str] = None,
         transaction_size: int = 65536,
         append: bool = False,
         update: bool = False,
         explodecollections: bool = False,
         force_output_geometrytype: Union[GeometryType, str, None] = None,
         options: dict = {},
-        columns: Optional[List[str]] = None,
+        columns: Optional[Iterable[str]] = None,
         warp: Optional[dict] = None,
         preserve_fid: Optional[bool] = None,
         dst_dimensions: Optional[str] = None,
     ):
         self.input_path = input_path
         self.output_path = output_path
         self.input_layers = input_layers
@@ -216,34 +216,34 @@
         dst_dimensions=info.dst_dimensions,
     )
 
 
 def vector_translate(
     input_path: Union[Path, str],
     output_path: Path,
-    input_layers: Union[List[str], str, None] = None,
+    input_layers: Union[list[str], str, None] = None,
     output_layer: Optional[str] = None,
     input_srs: Union[int, str, None] = None,
     output_srs: Union[int, str, None] = None,
     reproject: bool = False,
-    spatial_filter: Optional[Tuple[float, float, float, float]] = None,
-    clip_geometry: Optional[Union[Tuple[float, float, float, float], str]] = None,
+    spatial_filter: Optional[tuple[float, float, float, float]] = None,
+    clip_geometry: Optional[Union[tuple[float, float, float, float], str]] = None,
     sql_stmt: Optional[str] = None,
     sql_dialect: Optional[Literal["SQLITE", "OGRSQL"]] = None,
     where: Optional[str] = None,
     transaction_size: int = 65536,
     append: bool = False,
     update: bool = False,
     explodecollections: bool = False,
     force_output_geometrytype: Union[GeometryType, str, None] = None,
     options: dict = {},
-    columns: Optional[List[str]] = None,
+    columns: Optional[Iterable[str]] = None,
     warp: Optional[dict] = None,
     preserve_fid: Optional[bool] = None,
-    dst_dimensions: Optional[bool] = None,
+    dst_dimensions: Optional[str] = None,
 ) -> bool:
     # API Doc of VectorTranslateOptions:
     #   https://gdal.org/api/python/osgeo.gdal.html#osgeo.gdal.VectorTranslateOptions
     args = []
     if isinstance(input_path, str):
         input_path = Path(input_path)
     gdal_options = _prepare_gdal_options(options, split_by_option_type=True)
@@ -384,18 +384,18 @@
     # I also tried using gdal.ConfigurePythonLogging, but with enable_debug=True all
     # gdal debug logging is always logged, which is quite verbose and messy, and
     # with enable_debug=True nothing is logged. In addition, after
     # gdal.ConfigurePythonLogging is called, the CPL_LOG config setting is ignored.
     if "CPL_LOG" not in config_options:
         gdal_cpl_log_dir = Path(tempfile.gettempdir()) / "geofileops/gdal_cpl_log"
         gdal_cpl_log_dir.mkdir(parents=True, exist_ok=True)
-        fd, gdal_cpl_log_path = tempfile.mkstemp(suffix=".log", dir=gdal_cpl_log_dir)
+        fd, gdal_cpl_log = tempfile.mkstemp(suffix=".log", dir=gdal_cpl_log_dir)
         os.close(fd)
-        config_options["CPL_LOG"] = gdal_cpl_log_path
-        gdal_cpl_log_path = Path(gdal_cpl_log_path)
+        config_options["CPL_LOG"] = gdal_cpl_log
+        gdal_cpl_log_path = Path(gdal_cpl_log)
     else:
         gdal_cpl_log_path = Path(config_options["CPL_LOG"])
     if "CPL_LOG_ERRORS" not in config_options:
         config_options["CPL_LOG_ERRORS"] = "ON"
     if "CPL_DEBUG" not in config_options:
         config_options["CPL_DEBUG"] = "ON"
 
@@ -613,15 +613,15 @@
     option_types = [
         "LAYER_CREATION",
         "DATASET_CREATION",
         "INPUT_OPEN",
         "DESTINATION_OPEN",
         "CONFIG",
     ]
-    prepared_options: Dict[str, dict] = {
+    prepared_options: dict[str, dict] = {
         option_type: {} for option_type in option_types
     }
 
     # Loop through options specified to add them
     for option, value in options.items():
         # Prepare option type and name
         option_type, option_name = option.split(".")
```

### Comparing `geofileops-0.8.2/geofileops/util/_processing_util.py` & `geofileops-0.9.0/geofileops/util/_processing_util.py`

 * *Files 1% similar despite different names*

```diff
@@ -1,13 +1,15 @@
 """
 Module containing utilities regarding processes.
 """
-from concurrent import futures
+
 import os
+from concurrent import futures
 from typing import Optional
+
 import psutil
 
 
 class PooledExecutorFactory:
     """
     Context manager to create an Executor.
```

### Comparing `geofileops-0.8.2/geofileops/util/_sqlite_userdefined.py` & `geofileops-0.9.0/geofileops/util/_sqlite_userdefined.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,18 +1,15 @@
 # import datetime
 import logging
 from typing import Optional
 
 import pygeoops
 import shapely
 import shapely.ops
-
-# from pygeoops import _difference as _difference
-# from pygeoops import _paramvalidation as paramvalidation
-import shapely
+from shapely.geometry.base import BaseGeometry
 
 from geofileops.util import _geoseries_util
 
 # Get a logger...
 logger = logging.getLogger(__name__)
 
 
@@ -143,14 +140,15 @@
         raise
 
     try:
         # Apply set_precision
         result = _geoseries_util.set_precision(
             geom, grid_size=gridsize, raise_on_topoerror=False
         )
+        assert isinstance(result, BaseGeometry)
 
         # If an empty result, return None
         # Remark: apparently ST_IsEmpty of spatialite doesn't work (in combination with
         # gpkg and/or wkb?).
         if result is None or result.is_empty:
             return None
 
@@ -198,15 +196,15 @@
         # ex.with_traceback()
         logger.exception(f"Error in gfo_difference_collection: {ex}")
         raise
 
     try:
         # Apply split. Only supports single geometries, so explode twice to be sure.
         result = geom
-        output_primitivetype_id = pygeoops.get_primitivetype_id(geom)
+        output_primitivetype_id = int(pygeoops.get_primitivetype_id(geom))
         for blade_part in shapely.get_parts(blade):
             for blade_part2 in shapely.get_parts(blade_part):
                 result = shapely.ops.split(result, blade_part2)
                 result = pygeoops.collection_extract(result, output_primitivetype_id)
 
         # If an empty result, return None
         # Remark: tried to return empty geometry an empty GeometryCollection, but
```

### Comparing `geofileops-0.8.2/geofileops/util/_sqlite_util.py` & `geofileops-0.9.0/geofileops/util/_sqlite_util.py`

 * *Files 1% similar despite different names*

```diff
@@ -1,25 +1,27 @@
 """
 Module containing utilities regarding sqlite/spatialite files.
 """
 
 import datetime
 import enum
 import logging
-from pathlib import Path
 import pprint
 import shutil
 import sqlite3
 import tempfile
-from typing import Dict, List, Optional, Union
+from pathlib import Path
+from typing import Optional, Union
+
+from pygeoops import GeometryType
 
 import geofileops as gfo
-from geofileops import GeometryType
-from geofileops.util._general_util import MissingRuntimeDependencyError
+from geofileops.helpers._configoptions_helper import ConfigOptions
 from geofileops.util import _sqlite_userdefined as sqlite_userdefined
+from geofileops.util._general_util import MissingRuntimeDependencyError
 
 # Get a logger...
 logger = logging.getLogger(__name__)
 
 
 class EmptyResultError(Exception):
     """
@@ -30,15 +32,15 @@
     """
 
     def __init__(self, message):
         self.message = message
         super().__init__(self.message)
 
 
-def spatialite_version_info() -> Dict[str, str]:
+def spatialite_version_info() -> dict[str, str]:
     """
     Returns the versions of the spatialite modules.
 
     Versions returned: spatialite_version, geos_version.
 
     Raises:
         RuntimeError: if a runtime dependency is not available.
@@ -128,15 +130,15 @@
 def get_columns(
     sql_stmt: str,
     input1_path: Path,
     input2_path: Optional[Path] = None,
     empty_output_ok: bool = True,
     use_spatialite: bool = True,
     output_geometrytype: Optional[GeometryType] = None,
-) -> Dict[str, str]:
+) -> dict[str, str]:
     # Create temp output db to be sure the output DB is writable, even though we only
     # create a temporary table.
     tmp_dir = Path(tempfile.mkdtemp(prefix="geofileops/get_columns_"))
     tmp_path = tmp_dir / f"temp{input1_path.suffix}"
     create_new_spatialdb(path=tmp_path)
 
     sql = None
@@ -265,15 +267,16 @@
                     columns[columnname] = columntype
 
     except Exception as ex:
         conn.rollback()
         raise RuntimeError(f"Error {ex} executing {sql}") from ex
     finally:
         conn.close()
-        shutil.rmtree(tmp_dir, ignore_errors=True)
+        if ConfigOptions.remove_temp_files:
+            shutil.rmtree(tmp_dir, ignore_errors=True)
 
     return columns
 
 
 def create_table_as_sql(
     input1_path: Path,
     input1_layer: str,
@@ -507,14 +510,15 @@
                     VALUES ('{output_layer}', '{data_type}', NULL, '', DATETIME(),
                         NULL, NULL, NULL, NULL, {to_string_for_sql(crs_epsg)});
                 """
                 conn.execute(sql)
 
                 # If there is a geometry column, register it
                 if "geom" in column_types:
+                    assert output_geometrytype is not None
                     sql = f"""
                         INSERT INTO {output_databasename}.gpkg_geometry_columns (
                             table_name, column_name, geometry_type_name, srs_id, z, m)
                         VALUES ('{output_layer}', 'geom', '{output_geometrytype.name}',
                             {to_string_for_sql(crs_epsg)}, 0, 0);
                     """
                     conn.execute(sql)
@@ -522,14 +526,15 @@
                     # Now add geom triggers
                     # Remark: this only works on the main database!
                     sql = f"SELECT gpkgAddGeometryTriggers('{output_layer}', 'geom');"
                     conn.execute(sql)
             elif output_suffix_lower == ".sqlite":
                 # Create geom metadata if there is one
                 if "geom" in column_types:
+                    assert output_geometrytype is not None
                     sql = f"""
                         SELECT RecoverGeometryColumn(
                           '{output_layer}', 'geom',
                           {to_string_for_sql(crs_epsg)}, '{output_geometrytype.name}');
                     """
                     conn.execute(sql)
 
@@ -588,15 +593,15 @@
         raise RuntimeError(f"Error {ex} executing {sql}") from ex
     finally:
         if conn is not None:
             conn.close()
 
 
 def execute_sql(
-    path: Path, sql_stmt: Union[str, List[str]], use_spatialite: bool = True
+    path: Path, sql_stmt: Union[str, list[str]], use_spatialite: bool = True
 ):
     # Connect to database file
     conn = sqlite3.connect(path)
     sql = None
 
     try:
         if use_spatialite is True:
```

### Comparing `geofileops-0.8.2/geofileops/util/geodataframe_util.py` & `geofileops-0.9.0/geofileops/util/geodataframe_util.py`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.2/geofileops/util/test.gpkg` & `geofileops-0.9.0/geofileops/util/test.gpkg`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.2/geofileops.egg-info/PKG-INFO` & `geofileops-0.9.0/geofileops.egg-info/PKG-INFO`

 * *Files 2% similar despite different names*

```diff
@@ -1,22 +1,21 @@
 Metadata-Version: 2.1
 Name: geofileops
-Version: 0.8.2
+Version: 0.9.0
 Summary: Python toolbox to process large vector files faster.
 Home-page: https://github.com/geofileops/geofileops
 Author: Pieter Roggemans
 Author-email: pieter.roggemans@gmail.com
 Classifier: Programming Language :: Python :: 3
 Classifier: Operating System :: OS Independent
-Requires-Python: >=3.8
+Requires-Python: >=3.9
 Description-Content-Type: text/markdown
 License-File: LICENSE.txt
 Requires-Dist: cloudpickle
-Requires-Dist: fiona
-Requires-Dist: gdal<=3.9,>=3.6
+Requires-Dist: gdal<3.10,>=3.6
 Requires-Dist: geopandas<1,>=0.12
 Requires-Dist: numpy
 Requires-Dist: packaging
 Requires-Dist: pandas
 Requires-Dist: psutil
 Requires-Dist: pygeoops<0.5,>=0.4
 Requires-Dist: pyogrio
```

### Comparing `geofileops-0.8.2/geofileops.egg-info/SOURCES.txt` & `geofileops-0.9.0/geofileops.egg-info/SOURCES.txt`

 * *Files 4% similar despite different names*

```diff
@@ -19,14 +19,15 @@
 geofileops/version.txt
 geofileops.egg-info/PKG-INFO
 geofileops.egg-info/SOURCES.txt
 geofileops.egg-info/dependency_links.txt
 geofileops.egg-info/requires.txt
 geofileops.egg-info/top_level.txt
 geofileops/helpers/__init__.py
+geofileops/helpers/_configoptions_helper.py
 geofileops/helpers/_parameter_helper.py
 geofileops/helpers/layerstyles.py
 geofileops/util/__init__.py
 geofileops/util/_general_util.py
 geofileops/util/_geofileinfo.py
 geofileops/util/_geometry_util.py
 geofileops/util/_geoops_gpd.py
@@ -39,23 +40,24 @@
 geofileops/util/_processing_util.py
 geofileops/util/_sqlite_userdefined.py
 geofileops/util/_sqlite_util.py
 geofileops/util/geodataframe_util.py
 geofileops/util/geofiletypes.csv
 geofileops/util/test.gpkg
 tests/__init__.py
+tests/test_configoptions_helper.py
 tests/test_general_util.py
 tests/test_geofile.py
 tests/test_geofileinfo.py
 tests/test_geofileops_singlelayer.py
 tests/test_geofileops_singlelayer_gpd.py
 tests/test_geofileops_singlelayer_ogr.py
 tests/test_geofileops_singlelayer_sql.py
 tests/test_geofileops_twolayers.py
-tests/test_geoops.py
+tests/test_geoops_dissolve_within_distance.py
 tests/test_geoops_gpd.py
 tests/test_geoops_sql.py
 tests/test_geoseries_util.py
 tests/test_helper.py
 tests/test_io_util.py
 tests/test_layerstyles.py
 tests/test_ogr_sql_util.py
```

### Comparing `geofileops-0.8.2/pyproject.toml` & `geofileops-0.9.0/pyproject.toml`

 * *Files 3% similar despite different names*

```diff
@@ -2,20 +2,22 @@
 exclude = ["local_ignore"]
 reportGeneralTypeIssues = false
 
 [tool.mypy]
 exclude = ["local_ignore"]
 
 [[tool.mypy.overrides]]
-module = "cloudpickle.*,fiona.*,geopandas.*,matplotlib.*,osgeo.*,pygeos.*,pyogrio.*,psutil.*,setuptools.*,shapely.*,topojson.*"
+module = "cloudpickle.*,fiona.*,geopandas.*,matplotlib.*,osgeo.*,osgeo_utils.*,pygeos.*,pyogrio.*,psutil.*,setuptools.*,shapely.*,topojson.*"
 ignore_missing_imports = true
 
 [tool.ruff]
 line-length = 88
-select = [
+target-version = "py39"
+
+lint.select = [
     # pyflakes
     "F",
     # pycodestyle
     "E",
     "W",
     # flake8-2020
     "YTT",
@@ -48,18 +50,19 @@
     "PGH",
     # Ruff-specific rules
     "RUF",
     # pyupgrade
     "UP",
     # pydocstyle
     "D",
+    # isort
+    "I",
 ]
 
-target-version = "py38"
-ignore = [ # space before : (needed for how black formats slicing)
+lint.ignore = [ # space before : (needed for how black formats slicing)
     # "E203",  # not yet implemented
     # do not assign a lambda expression, use a def
     "E731",
     # line break before binary operator
     # "W503",  # not yet implemented
     # line break after binary operator
     # "W504",  # not yet implemented
@@ -135,20 +138,18 @@
     "RUF010",
     # One-line docstring should fit on one line
     "D200",
     # Multi-line docstring summary should start at the first line
     "D212",
 ]
 exclude = [
-    "benchmarks/*",
-    "benchmark/*",
     "docs/*",
     "local_ignore/*",
     "versioneer.py",
     "geopandas/_version.py",
 ]
 
-[tool.ruff.per-file-ignores]
+[tool.ruff.lint.per-file-ignores]
 "tests/*" = ["D"]
 
-[tool.ruff.pydocstyle]
+[tool.ruff.lint.pydocstyle]
 convention = "google"
```

### Comparing `geofileops-0.8.2/setup.py` & `geofileops-0.9.0/setup.py`

 * *Files 11% similar despite different names*

```diff
@@ -19,16 +19,15 @@
     long_description=long_description,
     long_description_content_type="text/markdown",
     url="https://github.com/geofileops/geofileops",
     include_package_data=True,
     packages=setuptools.find_packages(),
     install_requires=[
         "cloudpickle",
-        "fiona",
-        "gdal>=3.6,<=3.9",
+        "gdal>=3.6,<3.10",
         "geopandas>=0.12,<1",
         "numpy",
         "packaging",
         "pandas",
         "psutil",
         "pygeoops>=0.4,<0.5",
         "pyogrio",
@@ -36,9 +35,9 @@
         "shapely>=2,<2.1",
     ],
     extras_require={"full": ["simplification"]},
     classifiers=[
         "Programming Language :: Python :: 3",
         "Operating System :: OS Independent",
     ],
-    python_requires=">=3.8",
+    python_requires=">=3.9",
 )
```

### Comparing `geofileops-0.8.2/tests/test_general_util.py` & `geofileops-0.9.0/tests/test_general_util.py`

 * *Files 21% similar despite different names*

```diff
@@ -1,14 +1,16 @@
 """
 Tests for functionalities in _general_util.
 """
 
 import datetime
+import os
 import time
 
+import geofileops as gfo
 from geofileops.util import _general_util
 
 
 def test_formatbytes():
     bytes_str = _general_util.formatbytes(1)
     assert bytes_str == "1.0 Byte"
     bytes_str = _general_util.formatbytes(2)
@@ -33,7 +35,28 @@
             nb_todo=nb_todo,
             operation="test",
             nb_parallel=2,
         )
         time.sleep(0.5)
         if message is not None:
             print(message)
+
+
+def test_TempEnv():
+    test_var1 = "TEST_ENV_VARIABLE1"
+    test_var2 = "TEST_ENV_VARIABLE2"
+    test_var1_value_context = 1234
+    test_var2_value_orig = "test2_value_orig"
+    test_var2_value_context = "test2_value_context"
+
+    assert test_var1 not in os.environ
+    assert test_var2 not in os.environ
+    os.environ[test_var2] = test_var2_value_orig
+
+    with gfo.TempEnv(
+        {test_var1: test_var1_value_context, test_var2: test_var2_value_context}
+    ):
+        assert os.environ[test_var1] == str(test_var1_value_context)
+        assert os.environ[test_var2] == test_var2_value_context
+
+    assert test_var1 not in os.environ
+    assert os.environ[test_var2] == test_var2_value_orig
```

### Comparing `geofileops-0.8.2/tests/test_geofile.py` & `geofileops-0.9.0/tests/test_geofile.py`

 * *Files 1% similar despite different names*

```diff
@@ -1,32 +1,34 @@
 """
 Tests for functionalities in geofileops.general.
 """
 
 import os
+import shutil
 
 import geopandas as gpd
 import pandas as pd
-from pandas.testing import assert_frame_equal
-from pygeoops import GeometryType
 import pytest
 import shapely.geometry as sh_geom
+from pandas.testing import assert_frame_equal
+from pygeoops import GeometryType
 
 import geofileops as gfo
 from geofileops import fileops
-from geofileops.util import _geofileinfo
-from geofileops.util import _geoseries_util
-from geofileops.util import _io_util
-from geofileops.util import _ogr_util
+from geofileops.util import _geofileinfo, _geoseries_util, _io_util, _ogr_util
+from geofileops.util._geofileinfo import GeofileInfo
 from tests import test_helper
-from tests.test_helper import SUFFIXES_FILEOPS
-from tests.test_helper import assert_geodataframe_equal
+from tests.test_helper import SUFFIXES_FILEOPS, assert_geodataframe_equal
 
+try:
+    import fiona  # noqa: F401
 
-ENGINES = ["fiona", "pyogrio"]
+    ENGINES = ["fiona", "pyogrio"]
+except ImportError:
+    ENGINES = ["pyogrio"]
 
 
 @pytest.fixture(scope="module", params=ENGINES)
 def engine_setter(request):
     engine = request.param
     engine_backup = os.environ.get("GFO_IO_ENGINE", None)
     if engine is None:
@@ -501,14 +503,36 @@
 @pytest.mark.parametrize("suffix", [s for s in SUFFIXES_FILEOPS if s != ".csv"])
 def test_get_crs(suffix):
     src = test_helper.get_testfile("polygon-parcel", suffix=suffix)
     crs = gfo.get_crs(str(src))
     assert crs.to_epsg() == 31370
 
 
+def test_get_crs_invalid_params():
+    src = test_helper.get_testfile("polygon-parcel")
+    with pytest.raises(ValueError, match="Layer not_existing not found in file"):
+        _ = gfo.get_crs(str(src), layer="not_existing")
+
+
+def test_get_crs_bad_prj(tmp_path):
+    # Prepare test data
+    src = test_helper.get_testfile("polygon-parcel", dst_dir=tmp_path, suffix=".shp")
+    bad_prj_src = test_helper._data_dir / "crs_custom_match" / "31370_no_epsg.prj"
+    bad_prj_dst = src.with_suffix(".prj")
+    shutil.copy(bad_prj_src, bad_prj_dst)
+    with open(bad_prj_src) as prj_bad:
+        assert prj_bad.read() != fileops.PRJ_EPSG_31370
+
+    crs = fileops.get_crs(src)
+    assert crs.to_epsg() == 31370
+    assert bad_prj_dst.exists()
+    with open(bad_prj_dst) as file_corrected:
+        assert file_corrected.read() == fileops.PRJ_EPSG_31370
+
+
 @pytest.mark.parametrize("suffix", SUFFIXES_FILEOPS)
 def test_get_default_layer(suffix):
     # Prepare test data + test
     src = test_helper.get_testfile("polygon-parcel", suffix=suffix)
     layer = gfo.get_default_layer(str(src))
     assert layer == src.stem
 
@@ -1155,18 +1179,19 @@
 
 @pytest.mark.parametrize("suffix", [s for s in SUFFIXES_FILEOPS if s != ".csv"])
 def test_spatial_index(tmp_path, suffix):
     test_path = test_helper.get_testfile(
         "polygon-parcel", dst_dir=tmp_path, suffix=suffix
     )
     layer = gfo.get_only_layer(test_path)
+    default_spatial_index = GeofileInfo(test_path).default_spatial_index
 
     # Check if spatial index present
     has_spatial_index = gfo.has_spatial_index(path=test_path, layer=layer)
-    assert has_spatial_index is True
+    assert has_spatial_index is default_spatial_index
 
     # Remove spatial index
     gfo.remove_spatial_index(path=test_path, layer=layer)
     has_spatial_index = gfo.has_spatial_index(path=test_path, layer=layer)
     assert has_spatial_index is False
 
     # Create spatial index
@@ -1230,19 +1255,29 @@
     # Remark: geopandas doesn't seem seem to read the Z dimension, so writing can't be
     # tested?
     # Prepare test file
     src = test_helper.get_testfile(
         "polygon-parcel", suffix=suffix, dimensions=dimensions
     )
     output_path = tmp_path / f"{src.stem}-output{suffix}"
+    uidn = str(2318781) if suffix == ".csv" else 2318781
+    encoding = "utf-8" if suffix == ".csv" else None
 
     # Read test file and write to tmppath
-    read_gdf = gfo.read_file(src)
+    read_gdf = gfo.read_file(src, encoding=encoding)
+
+    # Validate if string (encoding) is correct for data read.
+    assert read_gdf.loc[read_gdf["UIDN"] == uidn]["LBLHFDTLT"].item() == "Silomas"
+
     gfo.to_file(read_gdf, str(output_path))
     written_gdf = gfo.read_file(output_path)
+
+    # Validate if string (encoding) is correct for data read after writing.
+    assert read_gdf.loc[read_gdf["UIDN"] == uidn]["LBLHFDTLT"].item() == "Silomas"
+
     assert len(read_gdf) == len(written_gdf)
     if engine_setter == "pyogrio" and suffix == ".csv":
         # pyogrio returns a pd.Dataframe if no geometry column
         assert_frame_equal(written_gdf, read_gdf)
     else:
         if engine_setter == "fiona" and suffix == ".gpkg":
             # Fiona doesn't seem to write EMPTY geom to gpkg, but writes None.
```

#### encoding

```diff
@@ -1 +1 @@
-us-ascii
+utf-8
```

### Comparing `geofileops-0.8.2/tests/test_geofileinfo.py` & `geofileops-0.9.0/tests/test_geofileinfo.py`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.2/tests/test_geofileops_singlelayer.py` & `geofileops-0.9.0/tests/test_geofileops_singlelayer.py`

 * *Files 3% similar despite different names*

```diff
@@ -1,37 +1,35 @@
 """
 Tests for operations that are executed using a sql statement on one layer.
 """
 
-from importlib import import_module
 import logging
 import math
-from typing import List
+from importlib import import_module
+from typing import Any, Optional
 
 import geopandas as gpd
 import pytest
 import shapely
 from shapely import MultiPolygon, Polygon
 
-from geofileops import fileops
-from geofileops import GeometryType
-from geofileops import geoops
+from geofileops import GeometryType, fileops, geoops
 from geofileops._compat import SPATIALITE_GTE_51
-from geofileops.util import _geofileinfo
-from geofileops.util import _geoops_sql
+from geofileops.util import _geofileinfo, _geoops_sql
 from geofileops.util import _io_util as io_util
+from geofileops.util._geofileinfo import GeofileInfo
 from tests import test_helper
 from tests.test_helper import (
     EPSGS,
     GRIDSIZE_DEFAULT,
     SUFFIXES_GEOOPS,
     TESTFILES,
     WHERE_AREA_GT_400,
+    assert_geodataframe_equal,
 )
-from tests.test_helper import assert_geodataframe_equal
 
 # Init gfo module
 current_geoops_module = "unknown"
 GEOOPS_MODULES = [
     "geofileops.geoops",
     "geofileops.util._geoops_gpd",
     "geofileops.util._geoops_sql",
@@ -48,39 +46,39 @@
         global geoops
         geoops = import_module(geoops_module, __package__)
         current_geoops_module = geoops_module
         print(f"gfo module switched to: {current_geoops_module}")
 
 
 def basic_combinations_to_test(
-    geoops_modules: List[str] = GEOOPS_MODULES,
-    testfiles: List[str] = TESTFILES,
-    epsgs: List[int] = EPSGS,
-    suffixes: List[str] = SUFFIXES_GEOOPS,
-) -> list:
+    geoops_modules: list[str] = GEOOPS_MODULES,
+    testfiles: list[str] = TESTFILES,
+    epsgs: list[int] = EPSGS,
+    suffixes: list[str] = SUFFIXES_GEOOPS,
+) -> list[Any]:
     """
     Return sensible combinations of parameters to be used in tests for following params:
         suffix, epsg, geoops_module, testfile, empty_input, gridsize, where_post
     """
     result = []
 
     # On .gpkg test:
     #   - all combinations of geoops_modules, testfiles and epsgs
     #   - fixed empty_input, suffix
     #   - dimensions="XYZ" for polygon input
     for epsg in epsgs:
         for geoops_module in geoops_modules:
             for testfile in testfiles:
                 where_post = None
-                keep_empty_geoms = None
+                keep_empty_geoms: Optional[bool] = False
                 dimensions = None
                 gridsize = 0.01 if epsg == 31370 else GRIDSIZE_DEFAULT
                 if testfile == "polygon-parcel":
                     dimensions = "XYZ"
-                    keep_empty_geoms = False
+                    keep_empty_geoms = None
                     if epsg == 31370:
                         where_post = WHERE_AREA_GT_400
                 elif testfile == "point":
                     keep_empty_geoms = True
                 result.append(
                     (
                         ".gpkg",
@@ -184,36 +182,42 @@
     if input_layerinfo.crs.is_projected is False:
         # 1 degree = 111 km or 111000 m
         distance /= 111000
 
     # Prepare expected result
     expected_gdf = fileops.read_file(input_path)
     expected_gdf.geometry = expected_gdf.geometry.buffer(distance, resolution=5)
+    # Default value for keep_empty_geoms is False
+    keep_empty_geoms_prepped = False if keep_empty_geoms is None else keep_empty_geoms
     expected_gdf = test_helper.prepare_expected_result(
         expected_gdf,
         gridsize=gridsize,
-        keep_empty_geoms=keep_empty_geoms,
+        keep_empty_geoms=keep_empty_geoms_prepped,
         where_post=where_post,
     )
 
     # Test positive buffer
+    kwargs = {}
+    if keep_empty_geoms is not None:
+        kwargs["keep_empty_geoms"] = keep_empty_geoms
     geoops.buffer(
         input_path=input_path,
         output_path=output_path,
         distance=distance,
         gridsize=gridsize,
         keep_empty_geoms=keep_empty_geoms,
         where_post=where_post,
         nb_parallel=2,
         batchsize=batchsize,
     )
 
     # Now check if the output file is correctly created
     assert output_path.exists()
-    assert fileops.has_spatial_index(output_path)
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert fileops.has_spatial_index(output_path) is exp_spatial_index
     output_layerinfo = fileops.get_layerinfo(output_path)
     assert len(output_layerinfo.columns) == len(input_layerinfo.columns)
 
     if empty_input:
         return
 
     # More detailed check
@@ -266,15 +270,16 @@
         input_gdf.geometry.buffer(0).geom_type == "MultiPolygon"
     ]
     assert len(input_multi_gdf) == 2
     multi_fid = input_multi_gdf.index[0]
 
     # Now check if the output file is correctly created
     assert output_path.exists()
-    assert fileops.has_spatial_index(output_path)
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert fileops.has_spatial_index(output_path) is exp_spatial_index
     output_layerinfo = fileops.get_layerinfo(output_path)
     output_gdf = fileops.read_file(output_path)
     assert output_gdf["geometry"][0] is not None
     assert list(output_layerinfo.columns) == ["LblHfdTlt", "fid_1"]
     assert len(output_gdf[output_gdf.fid_1 == multi_fid]) == 2
 
 
@@ -297,15 +302,16 @@
         keep_empty_geoms=False,
         nb_parallel=2,
         batchsize=batchsize,
     )
 
     # Test buffer to existing output path
     assert output_path.exists()
-    assert fileops.has_spatial_index(output_path)
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert fileops.has_spatial_index(output_path) is exp_spatial_index
     mtime_orig = output_path.stat().st_mtime
     geoops.buffer(
         input_path=input_path,
         output_path=output_path,
         distance=distance,
         keep_empty_geoms=False,
         nb_parallel=2,
@@ -381,41 +387,45 @@
     input_path = test_helper.get_testfile(testfile, suffix=suffix)
 
     # Now run test
     output_path = tmp_path / f"{input_path.stem}-{geoops_module}{suffix}"
     set_geoops_module(geoops_module)
     input_layerinfo = fileops.get_layerinfo(input_path)
     batchsize = math.ceil(input_layerinfo.featurecount / 2)
+    keep_empty_geoms_prepped = False if keep_empty_geoms is None else keep_empty_geoms
 
     # Test negative buffer
     distance = -10
+    kwargs = {}
+    if keep_empty_geoms is not None:
+        kwargs["keep_empty_geoms"] = keep_empty_geoms
     output_path = output_path.parent / f"{output_path.stem}_m10m{output_path.suffix}"
     geoops.buffer(
         input_path=input_path,
         output_path=output_path,
         distance=distance,
         gridsize=gridsize,
-        keep_empty_geoms=keep_empty_geoms,
         where_post=where_post,
         nb_parallel=2,
         batchsize=batchsize,
+        **kwargs,
     )
 
     # Now check if the output file is correctly created
     assert output_path.exists()
-    assert fileops.has_spatial_index(output_path)
+
     output_layerinfo = fileops.get_layerinfo(output_path)
     assert len(output_layerinfo.columns) == len(input_layerinfo.columns)
 
     if input_layerinfo.geometrytype in [
         GeometryType.MULTIPOINT,
         GeometryType.MULTILINESTRING,
     ]:
         # A Negative buffer of points or linestrings gives NULL geometries
-        if keep_empty_geoms:
+        if keep_empty_geoms_prepped:
             # If no filtering on NULL geoms, all rows are still present
             assert output_layerinfo.featurecount == input_layerinfo.featurecount
             if suffix != ".shp":
                 # The None geoms aren't properly detected as geometry in shp, so becomes
                 # an extra attribute column...
                 # assert len(output_layerinfo.columns) == len(input_layerinfo.columns)
                 pass
@@ -433,15 +443,15 @@
 
         # Prepare expected result
         expected_gdf = fileops.read_file(input_path)
         expected_gdf.geometry = expected_gdf.geometry.buffer(distance, resolution=5)
         expected_gdf = test_helper.prepare_expected_result(
             expected_gdf,
             gridsize=gridsize,
-            keep_empty_geoms=keep_empty_geoms,
+            keep_empty_geoms=keep_empty_geoms_prepped,
             where_post=where_post,
         )
         assert_geodataframe_equal(output_gdf, expected_gdf, sort_values=True)
 
 
 @pytest.mark.parametrize("geoops_module", GEOOPS_MODULES)
 def test_buffer_negative_explode(tmp_path, geoops_module):
@@ -468,15 +478,16 @@
         keep_empty_geoms=keep_empty_geoms,
         nb_parallel=2,
         batchsize=batchsize,
     )
 
     # Now check if the output file is correctly created
     assert output_path.exists()
-    assert fileops.has_spatial_index(output_path)
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert fileops.has_spatial_index(output_path) is exp_spatial_index
     layerinfo_output = fileops.get_layerinfo(output_path)
     assert len(layerinfo_output.columns) == len(input_layerinfo.columns)
     assert layerinfo_output.geometrytype == GeometryType.POLYGON
 
     output_gdf = fileops.read_file(output_path)
 
     expected_gdf = fileops.read_file(input_path)
@@ -530,15 +541,16 @@
         where_post=where_post,
         nb_parallel=2,
         batchsize=batchsize,
     )
 
     # Check result
     assert output_path.exists()
-    assert fileops.has_spatial_index(output_path)
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert fileops.has_spatial_index(output_path) is exp_spatial_index
     output_layerinfo = fileops.get_layerinfo(output_path)
     assert len(output_layerinfo.columns) == len(input_layerinfo.columns)
 
     output_gdf = fileops.read_file(output_path)
     assert output_gdf["geometry"][0] is not None
 
     assert_geodataframe_equal(
@@ -583,15 +595,16 @@
     # Prepare expected result to compare with
     expected_gdf = fileops.read_file(input_full_path, fid_as_index=True)
     expected_gdf = expected_gdf[~expected_gdf.index.isin([5, 6])]
     expected_gdf = expected_gdf[~expected_gdf.geometry.is_empty]
 
     # Check if the output file with the expected result
     assert output_path.exists()
-    assert fileops.has_spatial_index(output_path)
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert fileops.has_spatial_index(output_path) is exp_spatial_index
     output_gdf = fileops.read_file(output_path, fid_as_index=True)
     assert len(output_gdf) == len(expected_gdf)
     assert output_gdf["geometry"].iloc[0] is not None
     assert (
         output_gdf.index.sort_values().tolist()
         == expected_gdf.index.sort_values().tolist()
     )
@@ -634,15 +647,16 @@
         nb_parallel=2,
         batchsize=batchsize,
         keep_empty_geoms=keep_empty_geoms,
     )
 
     # Now check if the output file is correctly created
     assert output_path.exists()
-    assert fileops.has_spatial_index(output_path)
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert fileops.has_spatial_index(output_path) is exp_spatial_index
     output_layerinfo = fileops.get_layerinfo(output_path)
     assert len(output_layerinfo.columns) == len(input_layerinfo.columns)
 
     # More detailed check
     output_gdf = fileops.read_file(output_path)
     assert output_gdf["geometry"][0] is not None
     assert_geodataframe_equal(
@@ -673,38 +687,43 @@
 
     # Also check if columns parameter works (case insensitive)
     columns = ["OIDN", "uidn", "HFDTLT", "lblhfdtlt", "GEWASGROEP", "lengte", "OPPERVL"]
 
     # Prepare expected result
     expected_gdf = fileops.read_file(input_path)
     expected_gdf.geometry = expected_gdf.geometry.convex_hull
+    keep_empty_geoms_prepped = False if keep_empty_geoms is None else keep_empty_geoms
     expected_gdf = test_helper.prepare_expected_result(
         expected_gdf,
         gridsize=gridsize,
-        keep_empty_geoms=keep_empty_geoms,
+        keep_empty_geoms=keep_empty_geoms_prepped,
         where_post=where_post,
         columns=columns,
     )
 
     # Run test
+    kwargs = {}
+    if keep_empty_geoms is not None:
+        kwargs["keep_empty_geoms"] = keep_empty_geoms
     output_path = tmp_path / f"{input_path.stem}-output{suffix}"
     geoops.convexhull(
         input_path=input_path,
         columns=columns,
         output_path=output_path,
         gridsize=gridsize,
-        keep_empty_geoms=keep_empty_geoms,
         where_post=where_post,
         nb_parallel=2,
         batchsize=batchsize,
+        **kwargs,
     )
 
     # Now check if the output file is correctly created
     assert output_path.exists()
-    assert fileops.has_spatial_index(output_path)
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert fileops.has_spatial_index(output_path) is exp_spatial_index
     layerinfo_output = fileops.get_layerinfo(output_path)
     assert "OIDN" in layerinfo_output.columns
     assert "uidn" in layerinfo_output.columns
     assert len(layerinfo_output.columns) == len(columns)
     assert layerinfo_output.geometrytype == GeometryType.MULTIPOLYGON
 
     # If input was empty, we are already OK
@@ -867,41 +886,49 @@
         assert layerinfo_output.geometrytype == GeometryType.POLYGON
     else:
         assert layerinfo_output.geometrytype == GeometryType.MULTIPOLYGON
 
 
 @pytest.mark.parametrize("geoops_module", GEOOPS_MODULES)
 @pytest.mark.parametrize("gridsize", [0.0, 0.01])
-def test_makevalid_gridsize(tmp_path, geoops_module, gridsize):
+@pytest.mark.parametrize("keep_empty_geoms", [None, True])
+def test_makevalid_gridsize(tmp_path, geoops_module, gridsize, keep_empty_geoms):
     """
     Apply gridsize on the default test file to make it removes sliver polygon.
     """
     # Prepare test data
     input_path = test_helper.get_testfile("polygon-parcel")
     input_info = fileops.get_layerinfo(input_path)
-    # The NULL polygon is always removed
-    expected_featurecount = input_info.featurecount - 1
-    # With gridsize specified, a sliver polygon is removed as well
-    if gridsize > 0.0:
-        # If sql based and spatialite < 5.1, the sliver isn't cleaned up...
-        if not (
-            not SPATIALITE_GTE_51 and geoops_module == "geofileops.util._geoops_sql"
-        ):
-            expected_featurecount -= 1
+
+    expected_featurecount = input_info.featurecount
+    # If NULL/EMPTY geoms should not be kept, the expected featurecount is lower.
+    # (keep_empty_geoms=False is the default)
+    if not keep_empty_geoms or keep_empty_geoms is None:
+        expected_featurecount -= 1
+        # With gridsize specified, a sliver polygon is removed as well
+        if gridsize > 0.0:
+            # If sql based and spatialite < 5.1, the sliver isn't cleaned up...
+            if not (
+                not SPATIALITE_GTE_51 and geoops_module == "geofileops.util._geoops_sql"
+            ):
+                expected_featurecount -= 1
 
     set_geoops_module(geoops_module)
 
     # Do operation
+    kwargs = {}
+    if keep_empty_geoms is not None:
+        kwargs["keep_empty_geoms"] = keep_empty_geoms
     output_path = tmp_path / f"{input_path.stem}-output-{gridsize}.gpkg"
     geoops.makevalid(
         input_path=input_path,
         output_path=output_path,
         gridsize=gridsize,
         nb_parallel=2,
-        keep_empty_geoms=False,
+        **kwargs,
     )
 
     output_info = fileops.get_layerinfo(output_path)
     assert output_info.featurecount == expected_featurecount
 
 
 @pytest.mark.parametrize(
@@ -1055,41 +1082,46 @@
     batchsize = math.ceil(input_layerinfo.featurecount / 2)
     assert input_layerinfo.crs is not None
     if input_layerinfo.crs.is_projected:
         tolerance = 5
     else:
         # 1 degree = 111 km or 111000 m
         tolerance = 5 / 111000
+    keep_empty_geoms_prepped = False if keep_empty_geoms is None else keep_empty_geoms
 
     # Prepare expected result
     expected_gdf = fileops.read_file(input_path)
     expected_gdf.geometry = expected_gdf.geometry.simplify(tolerance)
     expected_gdf = test_helper.prepare_expected_result(
         expected_gdf,
         gridsize=gridsize,
-        keep_empty_geoms=keep_empty_geoms,
+        keep_empty_geoms=keep_empty_geoms_prepped,
         where_post=where_post,
     )
 
     # Test default algorithm (rdp)
+    kwargs = {}
+    if keep_empty_geoms is not None:
+        kwargs["keep_empty_geoms"] = keep_empty_geoms
     output_path = io_util.with_stem(input_path, output_path)
     geoops.simplify(
         input_path=input_path,
         output_path=output_path,
         tolerance=tolerance,
         gridsize=gridsize,
-        keep_empty_geoms=keep_empty_geoms,
         where_post=where_post,
         nb_parallel=2,
         batchsize=batchsize,
+        **kwargs,
     )
 
     # Now check if the tmp file is correctly created
     assert output_path.exists()
-    assert fileops.has_spatial_index(output_path)
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert fileops.has_spatial_index(output_path) is exp_spatial_index
     output_layerinfo = fileops.get_layerinfo(output_path)
     assert len(output_layerinfo.columns) == len(input_layerinfo.columns)
 
     # If input was empty, we are already OK
     if empty_input:
         return
```

### Comparing `geofileops-0.8.2/tests/test_geofileops_singlelayer_gpd.py` & `geofileops-0.9.0/tests/test_geofileops_singlelayer_gpd.py`

 * *Files 1% similar despite different names*

```diff
@@ -10,25 +10,25 @@
 import pandas as pd
 import pygeoops
 import pytest
 import shapely.geometry as sh_geom
 
 import geofileops as gfo
 from geofileops import GeometryType
-from geofileops.util import _geofileinfo
-from geofileops.util import _geometry_util
+from geofileops.util import _geofileinfo, _geometry_util
 from geofileops.util import _geoops_gpd as geoops_gpd
+from geofileops.util._geofileinfo import GeofileInfo
 from tests import test_helper
 from tests.test_helper import (
     EPSGS,
     SUFFIXES_GEOOPS,
     TESTFILES,
+    WHERE_AREA_GT_5000,
     WHERE_LENGTH_GT_1000,
     WHERE_LENGTH_GT_200000,
-    WHERE_AREA_GT_5000,
     assert_geodataframe_equal,
 )
 
 
 @pytest.mark.parametrize("suffix", SUFFIXES_GEOOPS)
 @pytest.mark.parametrize(
     "only_geom_input, gridsize, keep_empty_geoms, where_post",
@@ -83,15 +83,16 @@
         keep_empty_geoms=keep_empty_geoms,
         where_post=where_post,
         batchsize=batchsize,
     )
 
     # Now check if the output file is correctly created
     assert output_path.exists()
-    assert gfo.has_spatial_index(output_path)
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert gfo.has_spatial_index(output_path) is exp_spatial_index
 
     # Read result for some more detailed checks
     output_gdf = gfo.read_file(output_path).sort_values("uidn").reset_index(drop=True)
     output_layerinfo = gfo.get_layerinfo(output_path)
 
     assert len(output_layerinfo.columns) == len(input_layerinfo.columns)
     assert output_layerinfo.geometrytype == GeometryType.MULTIPOLYGON
@@ -170,15 +171,16 @@
         only_geom_input=only_geom_input,
         force_output_geometrytype=force_output_geometrytype,
         batchsize=batchsize,
     )
 
     # Now check if the output file is correctly created
     assert output_path.exists()
-    assert gfo.has_spatial_index(output_path)
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert gfo.has_spatial_index(output_path) is exp_spatial_index
 
     # Read result for some more detailed checks
     output_gdf = gfo.read_file(output_path).sort_values("id").reset_index(drop=True)
     output_layerinfo = gfo.get_layerinfo(output_path)
 
     assert len(output_layerinfo.columns) == len(input_layerinfo.columns)
     if force_output_geometrytype is None:
@@ -307,15 +309,16 @@
         gridsize=gridsize,
         where_post=where_post,
         batchsize=batchsize,
     )
 
     # Check if the result file is correctly created
     assert output_path.exists()
-    assert gfo.has_spatial_index(output_path)
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert gfo.has_spatial_index(output_path) is exp_spatial_index
     output_layerinfo = gfo.get_layerinfo(output_path)
     assert output_layerinfo.geometrytype in [
         GeometryType.LINESTRING,
         GeometryType.MULTILINESTRING,
     ]
     assert len(output_layerinfo.columns) >= 0
 
@@ -583,15 +586,16 @@
         where_post=where_post,
         nb_parallel=2,
         batchsize=batchsize,
     )
 
     # Now check if the tmp file is correctly created
     assert output_path.exists()
-    assert gfo.has_spatial_index(output_path)
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert gfo.has_spatial_index(output_path) is exp_spatial_index
     assert gfo.isvalid(output_path)
     output_layerinfo = gfo.get_layerinfo(output_path)
     assert output_layerinfo.featurecount == expected_featurecount
     if groupby is True:
         # No groupby -> normally no columns.
         # Shapefile needs at least one column, if no columns: fid
         if suffix == ".shp":
@@ -1132,15 +1136,16 @@
         lookahead=8,
         gridsize=gridsize,
         batchsize=batchsize,
     )
 
     # Check if the output file is correctly created
     assert output_path.exists()
-    assert gfo.has_spatial_index(output_path)
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert gfo.has_spatial_index(output_path) is exp_spatial_index
     output_layerinfo = gfo.get_layerinfo(output_path)
     expected_featurecount = input_layerinfo.featurecount
     if testfile == "polygon-parcel":
         # The EMPTY geometry will be removed
         expected_featurecount -= 1
         if gridsize > 0.0:
             # The sliver geometry will be removed
@@ -1192,15 +1197,16 @@
         algorithm=_geometry_util.SimplifyAlgorithm.VISVALINGAM_WHYATT,
         gridsize=gridsize,
         batchsize=batchsize,
     )
 
     # Check if the file is correctly created
     assert output_path.exists()
-    assert gfo.has_spatial_index(output_path)
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert gfo.has_spatial_index(output_path) is exp_spatial_index
     output_layerinfo = gfo.get_layerinfo(output_path)
     expected_featurecount = input_layerinfo.featurecount
     if testfile == "polygon-parcel":
         # The EMPTY geometry will be removed
         expected_featurecount -= 1
         if gridsize > 0.0:
             # The sliver geometry will be removed
```

### Comparing `geofileops-0.8.2/tests/test_geofileops_singlelayer_ogr.py` & `geofileops-0.9.0/tests/test_geofileops_singlelayer_ogr.py`

 * *Files 7% similar despite different names*

```diff
@@ -1,16 +1,18 @@
 """
-Tests for operations using GeoPandas.
+Tests for operations using only gdal.
 """
 
 import sys
+
 import pytest
 
 import geofileops as gfo
 from geofileops import GeometryType
+from geofileops.util._geofileinfo import GeofileInfo
 from tests import test_helper
 from tests.test_helper import SUFFIXES_GEOOPS
 
 
 @pytest.mark.parametrize("suffix", SUFFIXES_GEOOPS)
 def test_clip_by_geometry(tmp_path, suffix):
     # Prepare test data
@@ -27,15 +29,16 @@
     )
     gfo.clip_by_geometry(
         input_path=input_path, output_path=output_path, clip_geometry=clip_wkt
     )
 
     # Now check if the output file is correctly created
     assert output_path.exists()
-    assert gfo.has_spatial_index(output_path)
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert gfo.has_spatial_index(output_path) is exp_spatial_index
     layerinfo_orig = gfo.get_layerinfo(input_path)
     layerinfo_output = gfo.get_layerinfo(output_path)
     assert layerinfo_output.featurecount == 22
     assert len(layerinfo_orig.columns) == len(layerinfo_output.columns)
     assert layerinfo_output.geometrytype == GeometryType.MULTIPOLYGON
 
     # Now check the contents of the result file
@@ -60,15 +63,16 @@
     filter = (156036, 196691, 156368, 196927)
     gfo.export_by_bounds(
         input_path=str(input_path), output_path=str(output_path), bounds=filter
     )
 
     # Now check if the output file is correctly created
     assert output_path.exists()
-    assert gfo.has_spatial_index(output_path)
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert gfo.has_spatial_index(output_path) is exp_spatial_index
     layerinfo_orig = gfo.get_layerinfo(input_path)
     layerinfo_output = gfo.get_layerinfo(output_path)
     assert layerinfo_output.featurecount == 25
     assert len(layerinfo_orig.columns) == len(layerinfo_output.columns)
     assert layerinfo_output.geometrytype == GeometryType.MULTIPOLYGON
 
     # Now check the contents of the result file
@@ -116,15 +120,16 @@
         gcps=gcps,
         algorithm="tps",
         force=True,
     )
 
     # Now check if the output file is correctly created
     assert output_path.exists()
-    assert gfo.has_spatial_index(output_path)
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert gfo.has_spatial_index(output_path) is exp_spatial_index
     layerinfo_orig = gfo.get_layerinfo(input_path)
     layerinfo_output = gfo.get_layerinfo(output_path)
     assert layerinfo_output.featurecount == layerinfo_orig.featurecount
     assert len(layerinfo_orig.columns) == len(layerinfo_output.columns)
     assert layerinfo_output.geometrytype == GeometryType.MULTIPOLYGON
 
     # Now check the contents of the result file
```

### Comparing `geofileops-0.8.2/tests/test_geofileops_singlelayer_sql.py` & `geofileops-0.9.0/tests/test_geofileops_singlelayer_sql.py`

 * *Files 2% similar despite different names*

```diff
@@ -7,16 +7,15 @@
 import geopandas as gpd
 import pytest
 
 import geofileops as gfo
 from geofileops import GeometryType
 from geofileops.util import _geoops_sql as geoops_sql
 from tests import test_helper
-from tests.test_helper import EPSGS, SUFFIXES_GEOOPS
-from tests.test_helper import assert_geodataframe_equal
+from tests.test_helper import EPSGS, SUFFIXES_GEOOPS, assert_geodataframe_equal
 
 
 def test_delete_duplicate_geometries(tmp_path):
     # Prepare test data
     test_gdf = gpd.GeoDataFrame(
         {"fid": [1, 2, 3, 4, 5]},
         geometry=[
@@ -268,14 +267,47 @@
     assert layerinfo_output.featurecount == 0
     assert "oidn" in layerinfo_output.columns
     assert "uidn" in layerinfo_output.columns
     assert len(layerinfo_output.columns) == 2
     assert layerinfo_output.geometrytype == GeometryType.MULTIPOLYGON
 
 
+@pytest.mark.parametrize("suffix", SUFFIXES_GEOOPS)
+def test_select_equal_columns(tmp_path, suffix):
+    """Select that selects two columns with identical names."""
+    # Prepare test data
+    input_path = test_helper.get_testfile("polygon-parcel", suffix=suffix)
+
+    # Now run test
+    output_path = tmp_path / f"{input_path.stem}-output{suffix}"
+    sql_stmt = 'SELECT {geometrycolumn}, oidn, uidn AS oidn FROM "{input_layer}"'
+
+    gfo.select(input_path=input_path, output_path=output_path, sql_stmt=sql_stmt)
+
+    # Now check if the tmp file is correctly created
+    layerinfo_input = gfo.get_layerinfo(input_path)
+    layerinfo_output = gfo.get_layerinfo(output_path)
+    assert layerinfo_input.featurecount == layerinfo_output.featurecount
+    assert layerinfo_output.geometrytype == GeometryType.MULTIPOLYGON
+
+    assert len(layerinfo_output.columns) == 2
+    columns_output_upper = [col.upper() for col in layerinfo_output.columns]
+    assert "OIDN" in columns_output_upper
+    if suffix == ".gpkg":
+        assert "OIDN:1" in columns_output_upper
+    elif suffix == ".shp":
+        assert "OIDN_1" in columns_output_upper
+    else:
+        raise ValueError(f"Test doesn't support {suffix=}")
+
+    # Now check the contents of the result file
+    output_gdf = gfo.read_file(output_path)
+    assert output_gdf["geometry"][0] is not None
+
+
 @pytest.mark.parametrize(
     "sql_stmt",
     [
         'SELECT {geometrycolumn}, "oidn", "UIDN" FROM "{input_layer}"',
     ],
 )
 @pytest.mark.parametrize("input_suffix", SUFFIXES_GEOOPS)
```

### Comparing `geofileops-0.8.2/tests/test_geofileops_twolayers.py` & `geofileops-0.9.0/tests/test_geofileops_twolayers.py`

 * *Files 10% similar despite different names*

```diff
@@ -1,30 +1,31 @@
 """
 Tests for operations that are executed using a sql statement on two layers.
 """
 
 import math
-from pathlib import Path
 import sys
+from contextlib import nullcontext
+from pathlib import Path
 from typing import Optional
 
 import geopandas as gpd
 import pandas as pd
 import pytest
 import shapely
 import shapely.geometry as sh_geom
 
 import geofileops as gfo
 from geofileops import GeometryType
 from geofileops._compat import SPATIALITE_GTE_51
 from geofileops.util import _geofileinfo
 from geofileops.util import _geoops_sql as geoops_sql
+from geofileops.util._geofileinfo import GeofileInfo
 from tests import test_helper
-from tests.test_helper import SUFFIXES_GEOOPS, TESTFILES
-from tests.test_helper import assert_geodataframe_equal
+from tests.test_helper import SUFFIXES_GEOOPS, TESTFILES, assert_geodataframe_equal
 
 
 @pytest.mark.parametrize("testfile", TESTFILES)
 @pytest.mark.parametrize("suffix", SUFFIXES_GEOOPS)
 def test_clip(tmp_path, testfile, suffix):
     input_path = test_helper.get_testfile(testfile, suffix=suffix)
     clip_path = test_helper.get_testfile("polygon-zone", suffix=suffix)
@@ -37,15 +38,16 @@
         output_path=str(output_path),
         where_post=None,
         batchsize=batchsize,
     )
 
     # Compare result with geopandas
     assert output_path.exists()
-    assert gfo.has_spatial_index(output_path)
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert gfo.has_spatial_index(output_path) is exp_spatial_index
     output_gdf = gfo.read_file(output_path)
     input_gdf = gfo.read_file(input_path)
     clip_gdf = gfo.read_file(clip_path)
     output_gpd_gdf = gpd.clip(input_gdf, clip_gdf, keep_geom_type=True)
     assert_geodataframe_equal(
         output_gdf, output_gpd_gdf, promote_to_multi=True, sort_values=True
     )
@@ -83,15 +85,16 @@
         output_path=output_path,
         nb_parallel=2,
         batchsize=batchsize,
     )
 
     # Check if the output file is correctly created
     assert output_path.exists()
-    assert gfo.has_spatial_index(output_path)
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert gfo.has_spatial_index(output_path) is exp_spatial_index
     output_layerinfo = gfo.get_layerinfo(output_path)
     assert output_layerinfo.featurecount == 0
     assert len(output_layerinfo.columns) == len(input_layerinfo.columns)
     assert output_layerinfo.geometrytype == GeometryType.MULTIPOLYGON
 
 
 @pytest.mark.parametrize("suffix", SUFFIXES_GEOOPS)
@@ -132,15 +135,16 @@
         where_post=where_post,
         batchsize=batchsize,
         **kwargs,
     )
 
     # Compare result with geopandas
     assert output_path.exists()
-    assert gfo.has_spatial_index(output_path)
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert gfo.has_spatial_index(output_path) is exp_spatial_index
     output_gdf = gfo.read_file(output_path)
     input_gdf = gfo.read_file(input_path)
     erase_gdf = gfo.read_file(erase_path, layer=erase_layer)
 
     # Prepare expected gdf
     exp_gdf = gpd.overlay(input_gdf, erase_gdf, how="difference", keep_geom_type=True)
     if gridsize != 0.0:
@@ -186,15 +190,16 @@
         output_path=output_path,
         explodecollections=True,
         batchsize=batchsize,
     )
 
     # Compare result with geopandas
     assert output_path.exists()
-    assert gfo.has_spatial_index(output_path)
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert gfo.has_spatial_index(output_path) is exp_spatial_index
     output_gdf = gfo.read_file(output_path)
     input_gdf = gfo.read_file(input_path)
     erase_gdf = gfo.read_file(erase_path)
     output_gpd_gdf = gpd.overlay(
         input_gdf, erase_gdf, how="difference", keep_geom_type=True
     )
     output_gpd_gdf = output_gpd_gdf.explode(ignore_index=True)
@@ -233,14 +238,15 @@
     )
     assert output_path.stat().st_mtime != mtime_orig
 
 
 @pytest.mark.parametrize(
     "kwargs, expected_error",
     [
+        ({"erase_path": None}, "erase_layer must be None if erase_path is None"),
         ({"subdivide_coords": -1}, "subdivide_coords < 0 is not allowed"),
     ],
 )
 def test_erase_invalid_params(kwargs, expected_error):
     if "erase_path" not in kwargs:
         kwargs["erase_path"] = "erase.gpkg"
     with pytest.raises(ValueError, match=expected_error):
@@ -248,14 +254,40 @@
             input_path="input.gpkg",
             output_path="output.gpkg",
             erase_layer="invalid",
             **kwargs,
         )
 
 
+@pytest.mark.parametrize("subdivide_coords", [2000, 5])
+def test_erase_self(tmp_path, subdivide_coords):
+    input_path = test_helper.get_testfile("polygon-overlappingcircles-all")
+    input_layerinfo = gfo.get_layerinfo(input_path)
+    batchsize = math.ceil(input_layerinfo.featurecount / 2)
+
+    # Now run test
+    output_path = tmp_path / f"{input_path.stem}_erase_self.gpkg"
+    gfo.erase(
+        input_path=input_path,
+        erase_path=None,
+        output_path=output_path,
+        subdivide_coords=subdivide_coords,
+        nb_parallel=2,
+        batchsize=batchsize,
+    )
+
+    # Check if the tmp file is correctly created
+    assert output_path.exists()
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert gfo.has_spatial_index(output_path) is exp_spatial_index
+    output_layerinfo = gfo.get_layerinfo(output_path)
+    assert len(output_layerinfo.columns) == len(input_layerinfo.columns)
+    assert output_layerinfo.featurecount == 3
+
+
 @pytest.mark.parametrize("suffix", SUFFIXES_GEOOPS)
 def test_erase_subdivide_multipolygons(tmp_path, suffix):
     """
     Test if erase with subdivide also works if the erase layer contains multipolygons.
 
     It seems spatialite function ST_AsBinary, ST_GeomFromWKB and/or ST_Collect have
     issues processing nested multi-types (e.g. a GeometryCollection containing e.g.
@@ -295,15 +327,16 @@
         output_path=output_path,
         batchsize=batchsize,
         subdivide_coords=10,
     )
 
     # Compare result with geopandas
     assert output_path.exists()
-    assert gfo.has_spatial_index(output_path)
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert gfo.has_spatial_index(output_path) is exp_spatial_index
     output_gdf = gfo.read_file(output_path)
     input_gdf = gfo.read_file(input_path)
     output_gpd_gdf = gpd.overlay(
         input_gdf, erase_gdf, how="difference", keep_geom_type=True
     )
     output_gpd_gdf = output_gpd_gdf.explode(ignore_index=True)
     assert_geodataframe_equal(
@@ -314,52 +347,212 @@
         check_less_precise=True,
         normalize=True,
     )
 
 
 @pytest.mark.parametrize("suffix", SUFFIXES_GEOOPS)
 @pytest.mark.parametrize(
-    "area_inters_column_name, gridsize, where_post, exp_featurecount",
-    [("area_inters", 0.0, "ST_Area(geom) > 2000", 25), (None, 0.01, None, 27)],
+    "columns, gridsize, where_post, subdivide_coords, exp_featurecount",
+    [
+        (["OIDN", "UIDN"], 0.0, "ST_Area(geom) > 2000", 0, 25),
+        (None, 0.01, None, 10, 27),
+    ],
 )
 def test_export_by_location(
-    tmp_path, suffix, area_inters_column_name, gridsize, where_post, exp_featurecount
+    tmp_path,
+    suffix,
+    columns,
+    gridsize,
+    where_post,
+    subdivide_coords,
+    exp_featurecount,
 ):
     input_to_select_from_path = test_helper.get_testfile(
         "polygon-parcel", suffix=suffix
     )
     input_to_compare_with_path = test_helper.get_testfile("polygon-zone", suffix=suffix)
     output_path = tmp_path / f"{input_to_select_from_path.stem}-output{suffix}"
     input_layerinfo = gfo.get_layerinfo(input_to_select_from_path)
     batchsize = math.ceil(input_layerinfo.featurecount / 2)
 
     # Test
     gfo.export_by_location(
         input_to_select_from_path=str(input_to_select_from_path),
         input_to_compare_with_path=str(input_to_compare_with_path),
         output_path=str(output_path),
-        area_inters_column_name=area_inters_column_name,
+        input1_columns=columns,
         gridsize=gridsize,
         where_post=where_post,
+        subdivide_coords=subdivide_coords,
+        batchsize=batchsize,
+    )
+
+    # Check if the output file is correctly created
+    assert output_path.exists()
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert gfo.has_spatial_index(output_path) is exp_spatial_index
+    output_layerinfo = gfo.get_layerinfo(output_path)
+    exp_columns = len(input_layerinfo.columns) if columns is None else len(columns)
+    assert len(output_layerinfo.columns) == exp_columns
+    assert output_layerinfo.geometrytype == GeometryType.MULTIPOLYGON
+    assert output_layerinfo.featurecount == exp_featurecount
+
+    # Check the contents of the result file
+    output_gdf = gfo.read_file(output_path)
+    assert output_gdf["geometry"][0] is not None
+
+
+@pytest.mark.parametrize(
+    "query, area_inters_column_name, min_area_intersect, subdivide_coords, "
+    "exp_featurecount",
+    [
+        (None, None, None, 10, 27),
+        (None, "area_custom", None, 0, 27),
+        ("within is False", "area_custom", None, 0, 39),
+        (None, None, 1000, 10, 24),
+        ("within is False", None, 1000, 0, 15),
+    ],
+)
+def test_export_by_location_area(
+    tmp_path,
+    query,
+    area_inters_column_name,
+    min_area_intersect,
+    subdivide_coords,
+    exp_featurecount,
+):
+    input_to_select_from_path = test_helper.get_testfile("polygon-parcel")
+    input_to_compare_with_path = test_helper.get_testfile("polygon-zone")
+    output_path = tmp_path / f"{input_to_select_from_path.stem}-output.gpkg"
+    input_layerinfo = gfo.get_layerinfo(input_to_select_from_path)
+    batchsize = math.ceil(input_layerinfo.featurecount / 2)
+
+    # Test
+    kwargs = {}
+    if query is not None:
+        kwargs["spatial_relations_query"] = query
+    gfo.export_by_location(
+        input_to_select_from_path=str(input_to_select_from_path),
+        input_to_compare_with_path=str(input_to_compare_with_path),
+        output_path=str(output_path),
+        area_inters_column_name=area_inters_column_name,
+        min_area_intersect=min_area_intersect,
         batchsize=batchsize,
+        subdivide_coords=subdivide_coords,
+        **kwargs,
     )
 
     # Check if the output file is correctly created
     assert output_path.exists()
-    assert gfo.has_spatial_index(output_path)
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert gfo.has_spatial_index(output_path) is exp_spatial_index
     output_layerinfo = gfo.get_layerinfo(output_path)
     exp_columns = len(input_layerinfo.columns)
-    if area_inters_column_name:
+    exp_area_inters_column_name = area_inters_column_name
+    if exp_area_inters_column_name is None and min_area_intersect is not None:
+        exp_area_inters_column_name = "area_inters"
+    if exp_area_inters_column_name is not None:
         exp_columns += 1
+        assert exp_area_inters_column_name in output_layerinfo.columns
+    assert len(output_layerinfo.columns) == exp_columns
+    assert output_layerinfo.geometrytype == GeometryType.MULTIPOLYGON
+    assert output_layerinfo.featurecount == exp_featurecount
+
+    # Check the contents of the result file
+    output_gdf = gfo.read_file(output_path)
+    assert output_gdf["geometry"][0] is not None
+
+    # If an area column name is specified, check the number of None values
+    # (= number features without intersection)
+    if area_inters_column_name is not None:
+        exp_nb_None = 21 if query == "within is False" else 0
+        assert len(output_gdf[output_gdf.area_custom.isna()]) == exp_nb_None
+
+
+def test_export_by_location_force(tmp_path):
+    # Prepare test data
+    input1_path = test_helper.get_testfile("polygon-parcel")
+    input2_path = test_helper.get_testfile("polygon-zone")
+    output_path = tmp_path / f"output{input1_path.suffix}"
+    output_path.touch()
+
+    # Test with force False (the default): existing output file should stay the same
+    mtime_orig = output_path.stat().st_mtime
+    gfo.export_by_location(
+        input_to_select_from_path=input1_path,
+        input_to_compare_with_path=input2_path,
+        output_path=output_path,
+    )
+    assert output_path.stat().st_mtime == mtime_orig
+
+    # With force=True
+    gfo.export_by_location(
+        input_to_select_from_path=input1_path,
+        input_to_compare_with_path=input2_path,
+        output_path=output_path,
+        force=True,
+    )
+    assert output_path.stat().st_mtime != mtime_orig
+
+
+@pytest.mark.parametrize(
+    "kwargs, expected_error",
+    [
+        ({"subdivide_coords": -1}, "subdivide_coords < 0 is not allowed"),
+    ],
+)
+def test_export_by_location_invalid_params(kwargs, expected_error):
+    with pytest.raises(ValueError, match=expected_error):
+        gfo.export_by_location(
+            input_to_select_from_path="input.gpkg",
+            input_to_compare_with_path="input2.gpkg",
+            output_path="output.gpkg",
+            **kwargs,
+        )
+
+
+@pytest.mark.parametrize(
+    "query, subdivide_coords, exp_featurecount",
+    [
+        ("intersects is True or intersects is False", 0, 48),
+        ("intersects is True", 10, 27),
+        ("within is True", 0, 8),
+        ("intersects is False", 10, 21),
+        ("within is False", 10, 39),
+        ("disjoint is True", 0, 21),
+    ],
+)
+def test_export_by_location_query(tmp_path, query, subdivide_coords, exp_featurecount):
+    input_to_select_from_path = test_helper.get_testfile("polygon-parcel")
+    input_to_compare_with_path = test_helper.get_testfile("polygon-zone")
+    output_path = tmp_path / f"{input_to_select_from_path.stem}-output.gpkg"
+    input_layerinfo = gfo.get_layerinfo(input_to_select_from_path)
+    batchsize = math.ceil(input_layerinfo.featurecount / 2)
+
+    # Test
+    gfo.export_by_location(
+        input_to_select_from_path=str(input_to_select_from_path),
+        input_to_compare_with_path=str(input_to_compare_with_path),
+        output_path=str(output_path),
+        spatial_relations_query=query,
+        batchsize=batchsize,
+        subdivide_coords=subdivide_coords,
+    )
+
+    # Check if the output file is correctly created
+    assert output_path.exists()
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert gfo.has_spatial_index(output_path) is exp_spatial_index
+    output_layerinfo = gfo.get_layerinfo(output_path)
+    exp_columns = len(input_layerinfo.columns)
     assert len(output_layerinfo.columns) == exp_columns
     assert output_layerinfo.geometrytype == GeometryType.MULTIPOLYGON
     assert output_layerinfo.featurecount == exp_featurecount
 
     # Check the contents of the result file
-    # TODO: this test should be more elaborate...
     output_gdf = gfo.read_file(output_path)
     assert output_gdf["geometry"][0] is not None
 
 
 @pytest.mark.parametrize("testfile", ["polygon-parcel"])
 @pytest.mark.parametrize("suffix", SUFFIXES_GEOOPS)
 def test_export_by_distance(tmp_path, testfile, suffix):
@@ -376,15 +569,16 @@
         max_distance=10,
         output_path=str(output_path),
         batchsize=batchsize,
     )
 
     # Check if the tmp file is correctly created
     assert output_path.exists()
-    assert gfo.has_spatial_index(output_path)
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert gfo.has_spatial_index(output_path) is exp_spatial_index
     output_layerinfo = gfo.get_layerinfo(input_to_select_from_path)
     assert input_layerinfo.featurecount == output_layerinfo.featurecount
     assert len(input_layerinfo.columns) == len(output_layerinfo.columns)
     assert output_layerinfo.geometrytype == GeometryType.MULTIPOLYGON
 
     # Check the contents of the result file
     # TODO: this test should be more elaborate...
@@ -411,15 +605,16 @@
         output_path=str(output_path),
         gridsize=gridsize,
         batchsize=batchsize,
     )
 
     # Check if the output file is correctly created
     assert output_path.exists()
-    assert gfo.has_spatial_index(output_path)
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert gfo.has_spatial_index(output_path) is exp_spatial_index
     input2_layerinfo = gfo.get_layerinfo(input2_path)
     output_layerinfo = gfo.get_layerinfo(output_path)
     assert (len(input1_layerinfo.columns) + len(input2_layerinfo.columns)) == len(
         output_layerinfo.columns
     )
     assert output_layerinfo.geometrytype == GeometryType.MULTIPOLYGON
 
@@ -476,28 +671,56 @@
     )
     assert output_path.stat().st_mtime != mtime_orig
 
 
 @pytest.mark.parametrize(
     "kwargs, expected_error",
     [
+        (
+            {"input2_path": None, "input2_layer": "invalid"},
+            "input2_layer must be None if input2_path is None",
+        ),
         ({"subdivide_coords": -1}, "subdivide_coords < 0 is not allowed"),
     ],
 )
 def test_identity_invalid_params(kwargs, expected_error):
     if "input2_path" not in kwargs:
         kwargs["input2_path"] = "input2.gpkg"
     with pytest.raises(ValueError, match=expected_error):
         gfo.identity(
             input1_path="input1.gpkg",
             output_path="output.gpkg",
             **kwargs,
         )
 
 
+def test_identity_self(tmp_path):
+    input1_path = test_helper.get_testfile("polygon-overlappingcircles-all")
+    input1_layerinfo = gfo.get_layerinfo(input1_path)
+    batchsize = math.ceil(input1_layerinfo.featurecount / 2)
+
+    # Now run test
+    output_path = tmp_path / f"{input1_path.stem}_identity_self.gpkg"
+    gfo.identity(
+        input1_path=input1_path,
+        input2_path=None,
+        output_path=output_path,
+        nb_parallel=2,
+        batchsize=batchsize,
+    )
+
+    # Check if the tmp file is correctly created
+    assert output_path.exists()
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert gfo.has_spatial_index(output_path) is exp_spatial_index
+    output_layerinfo = gfo.get_layerinfo(output_path)
+    assert len(output_layerinfo.columns) == 2 * len(input1_layerinfo.columns)
+    assert output_layerinfo.featurecount == 9
+
+
 @pytest.mark.parametrize("testfile", ["polygon-parcel"])
 @pytest.mark.parametrize(
     "suffix, epsg, gridsize, explodecollections, nb_parallel",
     [
         (".gpkg", 31370, 0.0, True, 1),
         (".gpkg", 31370, 0.01, True, 1),
         (".gpkg", 31370, 0.0, False, 2),
@@ -528,15 +751,16 @@
         explodecollections=explodecollections,
         nb_parallel=nb_parallel,
         batchsize=batchsize,
     )
 
     # Check if the tmp file is correctly created
     assert output_path.exists()
-    assert gfo.has_spatial_index(output_path)
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert gfo.has_spatial_index(output_path) is exp_spatial_index
     input2_layerinfo = gfo.get_layerinfo(input2_path)
     output_layerinfo = gfo.get_layerinfo(output_path)
     assert len(output_layerinfo.columns) == (
         len(input1_layerinfo.columns) + len(input2_layerinfo.columns)
     )
 
     if explodecollections and suffix != ".shp":
@@ -590,59 +814,86 @@
     )
 
     # Check if the tmp file is correctly created
     assert output_path.exists()
 
 
 @pytest.mark.parametrize(
-    "expected_error, input1_path, input2_path, output_path",
+    "expected_error, expected_exception, input1_path, input2_path, output_path",
     [
         (
             "intersection: output_path must not equal one of input paths",
+            ValueError,
             test_helper.get_testfile("polygon-parcel"),
             test_helper.get_testfile("polygon-zone"),
             test_helper.get_testfile("polygon-parcel"),
         ),
         (
             "intersection: output_path must not equal one of input paths",
+            ValueError,
             test_helper.get_testfile("polygon-parcel"),
             test_helper.get_testfile("polygon-zone"),
             test_helper.get_testfile("polygon-zone"),
         ),
         (
-            "input_path doesn't exist: ",
+            "not_existing_path: No such file or directory",
+            RuntimeError,
             "not_existing_path",
             test_helper.get_testfile("polygon-zone"),
             "output.gpkg",
         ),
         (
-            "input_path doesn't exist: ",
+            "not_existing_path: No such file or directory",
+            RuntimeError,
             test_helper.get_testfile("polygon-zone"),
             "not_existing_path",
             "output.gpkg",
         ),
+        (
+            "Output directory does not exist:",
+            ValueError,
+            test_helper.get_testfile("polygon-parcel"),
+            test_helper.get_testfile("polygon-zone"),
+            "output/output.gpkg",
+        ),
     ],
 )
 def test_intersection_invalid_params(
-    tmp_path, input1_path, input2_path, output_path, expected_error
+    tmp_path, input1_path, input2_path, output_path, expected_exception, expected_error
 ):
-    """
-    Test if intersection works if the input gpkg files don't have a spatial index.
-    """
-    # Now run test
     if isinstance(output_path, str):
         output_path = tmp_path / output_path
-    with pytest.raises(ValueError, match=expected_error):
+    with pytest.raises(expected_exception, match=expected_error):
         gfo.intersection(
             input1_path=input1_path,
             input2_path=input2_path,
             output_path=output_path,
         )
 
 
+@pytest.mark.parametrize(
+    "kwargs, expected_error",
+    [
+        (
+            {"input2_path": None, "input2_layer": "invalid"},
+            "input2_layer must be None if input2_path is None",
+        )
+    ],
+)
+def test_intersection_invalid_params2(kwargs, expected_error):
+    if "input2_path" not in kwargs:
+        kwargs["input2_path"] = "input2.gpkg"
+    with pytest.raises(ValueError, match=expected_error):
+        gfo.intersection(
+            input1_path="input1.gpkg",
+            output_path="output.gpkg",
+            **kwargs,
+        )
+
+
 def test_intersection_output_path_exists(tmp_path):
     # Prepare test data
     input1_path = test_helper.get_testfile("polygon-parcel")
     input2_path = test_helper.get_testfile("polygon-parcel")
 
     # Now run test
     output_path = test_helper.get_testfile("polygon-zone")
@@ -692,24 +943,49 @@
         output_path=output_path,
         nb_parallel=2,
         batchsize=batchsize,
     )
 
     # Check if the output file is correctly created
     assert output_path.exists()
-    assert gfo.has_spatial_index(output_path)
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert gfo.has_spatial_index(output_path) is exp_spatial_index
     output_layerinfo = gfo.get_layerinfo(output_path)
     assert output_layerinfo.featurecount == 0
     input2_layerinfo = gfo.get_layerinfo(input2_path)
     assert len(output_layerinfo.columns) == (
         len(input1_layerinfo.columns) + len(input2_layerinfo.columns)
     )
     assert output_layerinfo.geometrytype == GeometryType.MULTIPOLYGON
 
 
+def test_intersection_self(tmp_path):
+    input1_path = test_helper.get_testfile("polygon-overlappingcircles-all")
+    input1_layerinfo = gfo.get_layerinfo(input1_path)
+    batchsize = math.ceil(input1_layerinfo.featurecount / 2)
+
+    # Now run test
+    output_path = tmp_path / f"{input1_path.stem}_inters_self.gpkg"
+    gfo.intersection(
+        input1_path=input1_path,
+        input2_path=None,
+        output_path=output_path,
+        nb_parallel=2,
+        batchsize=batchsize,
+    )
+
+    # Check if the tmp file is correctly created
+    assert output_path.exists()
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert gfo.has_spatial_index(output_path) is exp_spatial_index
+    output_layerinfo = gfo.get_layerinfo(output_path)
+    assert len(output_layerinfo.columns) == 2 * len(input1_layerinfo.columns)
+    assert output_layerinfo.featurecount == 6
+
+
 @pytest.mark.parametrize("testfile", ["polygon-parcel"])
 @pytest.mark.parametrize("suffix", SUFFIXES_GEOOPS)
 def test_intersection_columns_fid(tmp_path, testfile, suffix):
     input1_path = test_helper.get_testfile(testfile, suffix=suffix)
     input2_path = test_helper.get_testfile("polygon-zone", suffix=suffix)
     input1_layerinfo = gfo.get_layerinfo(input1_path)
     batchsize = math.ceil(input1_layerinfo.featurecount / 2)
@@ -729,15 +1005,16 @@
         input2_columns=input2_columns,
         nb_parallel=2,
         batchsize=batchsize,
     )
 
     # Check if the tmp file is correctly created
     assert output_path.exists()
-    assert gfo.has_spatial_index(output_path)
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert gfo.has_spatial_index(output_path) is exp_spatial_index
     output_layerinfo = gfo.get_layerinfo(output_path)
     assert len(output_layerinfo.columns) == len(input1_columns) + len(input2_columns)
     assert output_layerinfo.geometrytype == GeometryType.MULTIPOLYGON
     assert output_layerinfo.featurecount == 30
 
     # Check the contents of the result file
     output_gdf = gfo.read_file(output_path)
@@ -785,15 +1062,16 @@
         where_post=where_post,
         nb_parallel=2,
         batchsize=batchsize,
     )
 
     # Check if the tmp file is correctly created
     assert output_path.exists()
-    assert gfo.has_spatial_index(output_path)
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert gfo.has_spatial_index(output_path) is exp_spatial_index
     input2_layerinfo = gfo.get_layerinfo(input2_path)
     output_layerinfo = gfo.get_layerinfo(output_path)
     assert len(output_layerinfo.columns) == (
         len(input1_layerinfo.columns) + len(input2_layerinfo.columns)
     )
     if explodecollections and suffix != ".shp":
         assert output_layerinfo.geometrytype == GeometryType.POLYGON
@@ -855,76 +1133,96 @@
             error = False
         except Exception:
             error = True
         assert error is True, error_reason
 
 
 @pytest.mark.parametrize(
-    "suffix, epsg, spatial_relations_query, discard_nonmatching, "
-    "min_area_intersect, area_inters_column_name, expected_featurecount",
+    "suffix, epsg, spatial_relations_query, discard_nonmatching, min_area_intersect, "
+    "area_inters_column_name, exp_disjoint_warning, exp_featurecount",
     [
-        (".gpkg", 31370, "intersects is False", False, None, None, 48),
-        (".gpkg", 31370, "intersects is False", True, None, None, 0),
-        (".gpkg", 31370, "intersects is True", False, 1000, "area_test", 50),
-        (".gpkg", 31370, "intersects is True", False, None, None, 51),
-        (".gpkg", 31370, "intersects is True", True, 1000, None, 26),
-        (".gpkg", 31370, "intersects is True", True, None, None, 30),
-        (".gpkg", 4326, "T******** is True or *T******* is True", True, None, None, 30),
-        (".gpkg", 4326, "intersects is True", False, None, None, 51),
-        (".shp", 31370, "intersects is True", False, None, None, 51),
+        (".gpkg", 31370, "intersects is False", False, None, None, True, 48),
+        (".gpkg", 31370, "intersects is False", True, None, None, True, 0),
+        (".gpkg", 31370, "intersects is True", False, 1000, "area_test", False, 50),
+        (".gpkg", 31370, "intersects is True", False, None, None, False, 51),
+        (".gpkg", 31370, "intersects is True", True, 1000, None, False, 26),
+        (".gpkg", 31370, "intersects is True", True, None, None, False, 30),
+        (
+            ".gpkg",
+            4326,
+            "T******** is True or *T******* is True",
+            True,
+            None,
+            None,
+            False,
+            30,
+        ),
+        (".gpkg", 4326, "intersects is True", False, None, None, False, 51),
+        (".shp", 31370, "intersects is True", False, None, None, False, 51),
     ],
 )
 def test_join_by_location(
     tmp_path,
+    recwarn,
     suffix: str,
     spatial_relations_query: str,
     epsg: int,
     discard_nonmatching: bool,
     min_area_intersect: float,
     area_inters_column_name: str,
-    expected_featurecount: int,
+    exp_disjoint_warning: bool,
+    exp_featurecount: int,
 ):
     input1_path = test_helper.get_testfile("polygon-parcel", suffix=suffix, epsg=epsg)
     input2_path = test_helper.get_testfile("polygon-zone", suffix=suffix, epsg=epsg)
     input1_layerinfo = gfo.get_layerinfo(input1_path)
     batchsize = math.ceil(input1_layerinfo.featurecount / 2)
     name = f"{input1_path.stem}_{discard_nonmatching}_{min_area_intersect}{suffix}"
     output_path = tmp_path / name
 
-    gfo.join_by_location(
-        input1_path=str(input1_path),
-        input2_path=str(input2_path),
-        output_path=str(output_path),
-        spatial_relations_query=spatial_relations_query,
-        discard_nonmatching=discard_nonmatching,
-        min_area_intersect=min_area_intersect,
-        area_inters_column_name=area_inters_column_name,
-        batchsize=batchsize,
-        force=True,
-    )
+    if exp_disjoint_warning:
+        handler = pytest.warns(
+            UserWarning,
+            match="The spatial relation query specified evaluated to True for disjoint",
+        )
+    else:
+        handler = nullcontext()  # type: ignore[assignment]
+
+    with handler:
+        gfo.join_by_location(
+            input1_path=str(input1_path),
+            input2_path=str(input2_path),
+            output_path=str(output_path),
+            spatial_relations_query=spatial_relations_query,
+            discard_nonmatching=discard_nonmatching,
+            min_area_intersect=min_area_intersect,
+            area_inters_column_name=area_inters_column_name,
+            batchsize=batchsize,
+        )
 
     # Check if the output file is correctly created
     assert output_path.exists()
-    assert gfo.has_spatial_index(output_path)
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert gfo.has_spatial_index(output_path) is exp_spatial_index
     input2_layerinfo = gfo.get_layerinfo(input2_path)
     output_layerinfo = gfo.get_layerinfo(output_path)
-    assert output_layerinfo.featurecount == expected_featurecount
+    assert output_layerinfo.featurecount == exp_featurecount
 
-    exp_nb_columns = len(input1_layerinfo.columns) + len(input2_layerinfo.columns) + 1
+    exp_nb_columns = len(input1_layerinfo.columns) + len(input2_layerinfo.columns)
     if area_inters_column_name is not None:
         assert area_inters_column_name in output_layerinfo.columns
         exp_nb_columns += 1
     assert len(output_layerinfo.columns) == exp_nb_columns
     assert output_layerinfo.geometrytype == GeometryType.MULTIPOLYGON
 
     # Check the contents of the result file
     # TODO: this test should be more elaborate...
     output_gdf = gfo.read_file(output_path)
-    assert len(output_gdf) == expected_featurecount
-    if expected_featurecount > 0:
+    assert len(output_gdf) == exp_featurecount
+    if exp_featurecount > 0:
         assert output_gdf["geometry"][0] is not None
 
 
 @pytest.mark.parametrize(
     "suffix, epsg",
     [(".gpkg", 31370), (".gpkg", 4326), (".shp", 31370)],
 )
@@ -949,15 +1247,16 @@
         expand=True,
         batchsize=batchsize,
         force=True,
     )
 
     # Check if the output file is correctly created
     assert output_path.exists()
-    assert gfo.has_spatial_index(output_path)
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert gfo.has_spatial_index(output_path) is exp_spatial_index
     input2_layerinfo = gfo.get_layerinfo(input2_path)
     output_layerinfo = gfo.get_layerinfo(output_path)
     expected_featurecount = nb_nearest * (input1_layerinfo.featurecount - 1)
     assert output_layerinfo.featurecount == expected_featurecount
     exp_columns = len(input1_columns) + len(input2_layerinfo.columns) + 2
     if SPATIALITE_GTE_51:
         exp_columns += 1
@@ -1060,15 +1359,16 @@
         output_path=str(output_path),
         gridsize=gridsize,
         sql_stmt=sql_stmt,
     )
 
     # Check if the tmp file is correctly created
     assert output_path.exists()
-    assert gfo.has_spatial_index(output_path)
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert gfo.has_spatial_index(output_path) is exp_spatial_index
     input1_layerinfo = gfo.get_layerinfo(input1_path)
     input2_layerinfo = gfo.get_layerinfo(input2_path)
     output_layerinfo = gfo.get_layerinfo(output_path)
     assert output_layerinfo.featurecount == 30
     assert len(output_layerinfo.columns) == (
         len(input1_layerinfo.columns) + len(input2_layerinfo.columns)
     )
@@ -1155,15 +1455,16 @@
         sql_stmt=sql_stmt,
         batchsize=exp_featurecount / 2,
     )
 
     # Check if the tmp file is correctly created
     assert output_path.exists()
     if exp_output_geom:
-        assert gfo.has_spatial_index(output_path)
+        exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+        assert gfo.has_spatial_index(output_path) is exp_spatial_index
 
     input1_layerinfo = gfo.get_layerinfo(input1_path, raise_on_nogeom=False)
     input2_layerinfo = gfo.get_layerinfo(input2_path, raise_on_nogeom=False)
     output_layerinfo = gfo.get_layerinfo(output_path, raise_on_nogeom=exp_output_geom)
 
     exp_columns = len(input1_layerinfo.columns) + len(input2_layerinfo.columns)
     if input_nogeom == "both":
@@ -1344,15 +1645,16 @@
         output_path=output_path,
         output_layer=output_layer,
         sql_stmt=sql_stmt,
     )
 
     # Check if the tmp file is correctly created
     assert output_path.exists()
-    assert gfo.has_spatial_index(output_path)
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert gfo.has_spatial_index(output_path) is exp_spatial_index
     input1_layerinfo = gfo.get_layerinfo(input1_path)
     input2_layerinfo = gfo.get_layerinfo(input2_path)
     output_layerinfo = gfo.get_layerinfo(output_path)
     assert output_layerinfo.featurecount == 30
     assert len(output_layerinfo.columns) == (
         len(input1_layerinfo.columns) + len(input2_layerinfo.columns)
     )
@@ -1481,15 +1783,16 @@
         input2_path=str(input2_path),
         output_path=str(output_path),
         batchsize=batchsize,
     )
 
     # Check if the tmp file is correctly created
     assert output_path.exists()
-    assert gfo.has_spatial_index(output_path)
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert gfo.has_spatial_index(output_path) is exp_spatial_index
     input2_layerinfo = gfo.get_layerinfo(input2_path)
     output_layerinfo = gfo.get_layerinfo(output_path)
     assert output_layerinfo.featurecount == 68
     assert (len(input1_layerinfo.columns) + len(input2_layerinfo.columns)) == len(
         output_layerinfo.columns
     )
     assert output_layerinfo.geometrytype == GeometryType.MULTIPOLYGON
@@ -1541,15 +1844,16 @@
         output_path=str(output_path),
         gridsize=gridsize,
         batchsize=batchsize,
     )
 
     # Check if the tmp file is correctly created
     assert output_path.exists()
-    assert gfo.has_spatial_index(output_path)
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert gfo.has_spatial_index(output_path) is exp_spatial_index
     output_gdf = gfo.read_file(output_path)
     assert output_gdf["geometry"][0] is not None
 
     # Prepare expected gdf
     input1_gdf = gfo.read_file(input1_path)
     input2_gdf = gfo.read_file(input2_path)
     exp_gdf = input1_gdf.overlay(
@@ -1574,28 +1878,56 @@
         normalize=True,
     )
 
 
 @pytest.mark.parametrize(
     "kwargs, expected_error",
     [
+        (
+            {"input2_path": None, "input2_layer": "invalid"},
+            "input2_layer must be None if input2_path is None",
+        ),
         ({"subdivide_coords": -1}, "subdivide_coords < 0 is not allowed"),
     ],
 )
 def test_symmetric_difference_invalid_params(kwargs, expected_error):
     if "input2_path" not in kwargs:
         kwargs["input2_path"] = "input2.gpkg"
     with pytest.raises(ValueError, match=expected_error):
         gfo.symmetric_difference(
             input1_path="input1.gpkg",
             output_path="output.gpkg",
             **kwargs,
         )
 
 
+def test_symmetric_difference_self(tmp_path):
+    input1_path = test_helper.get_testfile("polygon-overlappingcircles-all")
+    input1_layerinfo = gfo.get_layerinfo(input1_path)
+    batchsize = math.ceil(input1_layerinfo.featurecount / 2)
+
+    # Now run test
+    output_path = tmp_path / f"{input1_path.stem}_symmetric_difference_self.gpkg"
+    gfo.symmetric_difference(
+        input1_path=input1_path,
+        input2_path=None,
+        output_path=output_path,
+        nb_parallel=2,
+        batchsize=batchsize,
+    )
+
+    # Check if the tmp file is correctly created
+    assert output_path.exists()
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert gfo.has_spatial_index(output_path) is exp_spatial_index
+    output_layerinfo = gfo.get_layerinfo(output_path)
+    assert len(output_layerinfo.columns) == 2 * len(input1_layerinfo.columns)
+    assert output_layerinfo.featurecount == 6
+
+
 @pytest.mark.parametrize(
     "suffix, epsg, gridsize, where_post, explodecollections, keep_fid, "
     "exp_featurecount",
     [
         (".gpkg", 31370, 0.01, "ST_Area(geom) > 1000", True, True, 62),
         (".shp", 31370, 0.0, "ST_Area(geom) > 1000", False, True, 59),
         (".gpkg", 4326, 0.0, None, False, False, 73),
@@ -1652,15 +1984,16 @@
         explodecollections=explodecollections,
         where_post=where_post,
         batchsize=batchsize,
     )
 
     # Check if the tmp file is correctly created
     assert output_path.exists()
-    assert gfo.has_spatial_index(output_path)
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert gfo.has_spatial_index(output_path) is exp_spatial_index
     output_layerinfo = gfo.get_layerinfo(output_path)
     exp_columns = len(input1_layerinfo.columns) + len(input2_layerinfo.columns)
     if keep_fid:
         exp_columns += 2
     assert len(output_layerinfo.columns) == exp_columns
 
     if explodecollections and suffix != ".shp":
@@ -1726,15 +2059,16 @@
         input2_path=input2_path,
         output_path=output_path,
         batchsize=batchsize,
     )
 
     # Check if the tmp file is correctly created
     assert output_path.exists()
-    assert gfo.has_spatial_index(output_path)
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert gfo.has_spatial_index(output_path) is exp_spatial_index
     input2_layerinfo = gfo.get_layerinfo(input2_path)
     output_layerinfo = gfo.get_layerinfo(output_path)
     assert output_layerinfo.featurecount == 5
     assert (len(input1_layerinfo.columns) + len(input2_layerinfo.columns)) == len(
         output_layerinfo.columns
     )
     assert output_layerinfo.geometrytype == GeometryType.MULTIPOLYGON
@@ -1834,19 +2168,47 @@
     )
     assert output_path.stat().st_mtime != mtime_orig
 
 
 @pytest.mark.parametrize(
     "kwargs, expected_error",
     [
+        (
+            {"input2_path": None, "input2_layer": "invalid"},
+            "input2_layer must be None if input2_path is None",
+        ),
         ({"subdivide_coords": -1}, "subdivide_coords < 0 is not allowed"),
     ],
 )
 def test_union_invalid_params(kwargs, expected_error):
     if "input2_path" not in kwargs:
         kwargs["input2_path"] = "input2.gpkg"
     with pytest.raises(ValueError, match=expected_error):
         gfo.union(
             input1_path="input.gpkg",
             output_path="output.gpkg",
             **kwargs,
         )
+
+
+def test_union_self(tmp_path):
+    input1_path = test_helper.get_testfile("polygon-overlappingcircles-all")
+    input1_layerinfo = gfo.get_layerinfo(input1_path)
+    batchsize = math.ceil(input1_layerinfo.featurecount / 2)
+
+    # Now run test
+    output_path = tmp_path / f"{input1_path.stem}_union_self.gpkg"
+    gfo.union(
+        input1_path=input1_path,
+        input2_path=None,
+        output_path=output_path,
+        nb_parallel=2,
+        batchsize=batchsize,
+    )
+
+    # Check if the tmp file is correctly created
+    assert output_path.exists()
+    exp_spatial_index = GeofileInfo(output_path).default_spatial_index
+    assert gfo.has_spatial_index(output_path) is exp_spatial_index
+    output_layerinfo = gfo.get_layerinfo(output_path)
+    assert len(output_layerinfo.columns) == 2 * len(input1_layerinfo.columns)
+    assert output_layerinfo.featurecount == 12
```

### Comparing `geofileops-0.8.2/tests/test_geoops_gpd.py` & `geofileops-0.9.0/tests/test_geoops_gpd.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,8 +1,9 @@
 import logging
+
 import pytest
 
 from geofileops.util import _geoops_gpd
 
 
 @pytest.mark.parametrize(
     "descr, nb_rows_input_layer, nb_parallel, batchsize, cpu_count, bytes_usable, "
@@ -27,15 +28,15 @@
 )
 def test_determine_nb_batches(
     descr: str,
     nb_rows_input_layer: int,
     nb_parallel: int,
     batchsize: int,
     cpu_count: int,
-    bytes_usable: float,
+    bytes_usable: int,
     exp_nb_parallel: int,
     exp_nb_batches: int,
 ):
     # Set the parallelization parameters dependend on machine running the tests to keep
     # them stable regardless of the machine runninng the tests.
     config = _geoops_gpd.ParallelizationConfig(
         bytes_usable=bytes_usable, cpu_count=cpu_count
```

### Comparing `geofileops-0.8.2/tests/test_geoseries_util.py` & `geofileops-0.9.0/tests/test_geoseries_util.py`

 * *Ordering differences only*

 * *Files 0% similar despite different names*

```diff
@@ -1,16 +1,16 @@
 """
 Tests for functionalities in geoseries_util.
 """
 
 import geopandas as gpd
-from pygeoops import GeometryType
 import pytest
 import shapely
 import shapely.geometry as sh_geom
+from pygeoops import GeometryType
 
 import geofileops as gfo
 import geofileops._compat as compat
 from geofileops.util import _geoseries_util
 from tests import test_helper
```

### Comparing `geofileops-0.8.2/tests/test_helper.py` & `geofileops-0.9.0/tests/test_helper.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,26 +1,23 @@
 """
 Helper functions for all tests.
 """
 
 import os
-from pathlib import Path
 import tempfile
-from typing import List, Optional, Union
+from pathlib import Path
+from typing import Optional, Union
 
 import geopandas as gpd
 import geopandas.testing as gpd_testing
-
 import shapely
 import shapely.geometry as sh_geom
 
 import geofileops as gfo
-from geofileops.util import _geofileinfo
-from geofileops.util import geodataframe_util
-from geofileops.util import _geoseries_util
+from geofileops.util import _geofileinfo, _geoseries_util, geodataframe_util
 
 _data_dir = Path(__file__).parent.resolve() / "data"
 EPSGS = [31370, 4326]
 GRIDSIZE_DEFAULT = 0.0
 SUFFIXES_FILEOPS = [".gpkg", ".shp", ".csv"]
 SUFFIXES_GEOOPS = [".gpkg", ".shp"]
 TESTFILES = ["polygon-parcel", "linestring-row-trees", "point"]
@@ -36,60 +33,61 @@
 
 def prepare_expected_result(
     gdf: gpd.GeoDataFrame,
     keep_empty_geoms: bool,
     gridsize: float = 0.0,
     where_post: Optional[str] = None,
     explodecollections=False,
-    columns: Optional[List[str]] = None,
+    columns: Optional[list[str]] = None,
 ) -> gpd.GeoDataFrame:
     """Prepare expected data"""
+    if keep_empty_geoms is None:
+        raise ValueError("keep_empty_geoms cannot be None")
 
-    expected_gdf = gdf.copy()
+    exp_gdf = gdf.copy()
 
     if gridsize != 0.0:
-        expected_gdf.geometry = shapely.set_precision(
-            expected_gdf.geometry, grid_size=gridsize
-        )
+        exp_gdf.geometry = shapely.set_precision(exp_gdf.geometry, grid_size=gridsize)
     if explodecollections:
-        expected_gdf = expected_gdf.explode(ignore_index=True)
+        exp_gdf = exp_gdf.explode(ignore_index=True)
 
     # Check what filtering is needed
     filter_area_gt = None
     if where_post is None or where_post == "":
         pass
     elif where_post == "ST_Area({geometrycolumn}) > 400":
         filter_area_gt = 400
     elif where_post == "ST_Area({geometrycolumn}) > 5000":
         filter_area_gt = 5000
     else:
         raise ValueError(f"unsupported where_post parameter in test: {where_post}")
 
     # Apply filtering
-    if keep_empty_geoms is None or not keep_empty_geoms:
-        expected_gdf = expected_gdf[~expected_gdf.geometry.isna()]
-        expected_gdf = expected_gdf[~expected_gdf.geometry.is_empty]
+    # If keep_empty_geoms is None, treat it as False as this is the default value
+    if not keep_empty_geoms:
+        exp_gdf = exp_gdf[~exp_gdf.geometry.isna()]
+        exp_gdf = exp_gdf[~exp_gdf.geometry.is_empty]
     if filter_area_gt is not None:
-        expected_gdf = expected_gdf[expected_gdf.geometry.area > filter_area_gt]
+        exp_gdf = exp_gdf[exp_gdf.geometry.area > filter_area_gt]
 
     if columns is not None:
         column_mapper = {}
         columns_to_drop = []
         columns_dict = {column.upper(): column for column in columns}
-        for column in expected_gdf.columns:
+        for column in exp_gdf.columns:
             if column.upper() in columns_dict:
                 column_mapper[column] = columns_dict[column.upper()]
             elif column != "geometry":
                 columns_to_drop.append(column)
-        expected_gdf = expected_gdf.rename(columns=column_mapper)
+        exp_gdf = exp_gdf.rename(columns=column_mapper)
         if len(columns_to_drop) > 0:
-            expected_gdf = expected_gdf.drop(columns=columns_to_drop)
+            exp_gdf = exp_gdf.drop(columns=columns_to_drop)
 
-    assert isinstance(expected_gdf, gpd.GeoDataFrame)
-    return expected_gdf
+    assert isinstance(exp_gdf, gpd.GeoDataFrame)
+    return exp_gdf
 
 
 def prepare_test_file(
     input_path: Path,
     output_dir: Path,
     suffix: str,
     crs_epsg: Optional[int] = None,
```

### Comparing `geofileops-0.8.2/tests/test_io_util.py` & `geofileops-0.9.0/tests/test_io_util.py`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.2/tests/test_layerstyles.py` & `geofileops-0.9.0/tests/test_layerstyles.py`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.2/tests/test_ogr_sql_util.py` & `geofileops-0.9.0/tests/test_ogr_sql_util.py`

 * *Files 1% similar despite different names*

```diff
@@ -1,12 +1,13 @@
 """
 Tests for functionalities in sql_util.
 """
 
-from typing import Iterable, List, Optional
+from collections.abc import Iterable
+from typing import Optional
 
 import pytest
 
 from geofileops.util import _ogr_sql_util
 
 
 @pytest.mark.parametrize(
@@ -81,15 +82,15 @@
             ',sub."l1_fid", sub."l1_test1"',
         ),
         ("No columns asked", [], ["test1"], "", "", "fid", "", "", "", "", ""),
     ],
 )
 def test_ColumnFormatter(
     descr: str,
-    columns_specified: Optional[List[str]],
+    columns_specified: Optional[list[str]],
     columns_available: Iterable[str],
     table_alias: str,
     columnname_prefix: str,
     fid_column: str,
     exp_quoted: str,
     exp_prefixed: str,
     exp_prefixed_aliased: str,
```

### Comparing `geofileops-0.8.2/tests/test_ogr_util.py` & `geofileops-0.9.0/tests/test_ogr_util.py`

 * *Ordering differences only*

 * *Files 0% similar despite different names*

```diff
@@ -1,15 +1,15 @@
 """
 Tests for functionalities in ogr_util.
 """
 
 import os
 
-from osgeo import gdal
 import pytest
+from osgeo import gdal
 
 import geofileops as gfo
 from geofileops._compat import GDAL_GTE_38
 from geofileops.util import _ogr_util
 from tests import test_helper
```

### Comparing `geofileops-0.8.2/tests/test_parameter_helper.py` & `geofileops-0.9.0/tests/test_parameter_helper.py`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.2/tests/test_processing_util.py` & `geofileops-0.9.0/tests/test_processing_util.py`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.2/tests/test_spatialite.py` & `geofileops-0.9.0/tests/test_spatialite.py`

 * *Ordering differences only*

 * *Files 4% similar despite different names*

```diff
@@ -1,14 +1,14 @@
 """
 Tests for functionalities in ogr_util.
 """
 
-from packaging import version
 import pytest
 import shapely.geometry as sh_geom
+from packaging import version
 
 import geofileops as gfo
 from geofileops._compat import SPATIALITE_GTE_51
 from tests import test_helper
 
 
 @pytest.mark.parametrize(
```

### Comparing `geofileops-0.8.2/tests/test_sqlite_userdefined.py` & `geofileops-0.9.0/tests/test_sqlite_userdefined.py`

 * *Files identical despite different names*

### Comparing `geofileops-0.8.2/tests/test_sqlite_util.py` & `geofileops-0.9.0/tests/test_sqlite_util.py`

 * *Files 3% similar despite different names*

```diff
@@ -3,17 +3,18 @@
 """
 
 import logging
 from pathlib import Path
 
 import pytest
 
-from geofileops import fileops
 import geofileops as gfo
+from geofileops import fileops
 from geofileops.util import _sqlite_util as sqlite_util
+from geofileops.util._geofileinfo import GeofileInfo
 from tests import test_helper
 from tests.test_helper import assert_geodataframe_equal
 
 
 @pytest.mark.parametrize("create_spatial_index", [(True), (False)])
 def test_create_table_as_sql(tmp_path, create_spatial_index):
     output_path = tmp_path / "output.gpkg"
@@ -107,15 +108,16 @@
 
     with pytest.raises(ValueError, match=expected_error):
         sqlite_util.create_table_as_sql(**kwargs)
 
 
 def test_execute_sql(tmp_path):
     test_path = test_helper.get_testfile(testfile="polygon-parcel", dst_dir=tmp_path)
-    assert gfo.has_spatial_index(test_path)
+    exp_spatial_index = GeofileInfo(test_path).default_spatial_index
+    assert gfo.has_spatial_index(test_path) is exp_spatial_index
     info_input = gfo.get_layerinfo(test_path)
     nb_deleted = 0
 
     # Execute one statement
     sql_stmt = "DELETE FROM parcels WHERE rowid = (SELECT MIN(rowid) FROM parcels)"
     sqlite_util.execute_sql(test_path, sql_stmt=sql_stmt)
     nb_deleted += 1
```

