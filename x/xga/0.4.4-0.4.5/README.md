# Comparing `tmp/xga-0.4.4.tar.gz` & `tmp/xga-0.4.5.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "dist/xga-0.4.4.tar", last modified: Thu May  2 15:38:56 2024, max compression
+gzip compressed data, was "dist/xga-0.4.5.tar", last modified: Mon May 27 15:10:29 2024, max compression
```

## Comparing `xga-0.4.4.tar` & `xga-0.4.5.tar`

### file list

```diff
@@ -1,123 +1,123 @@
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 15:38:56.000000 xga-0.4.4/
--rw-r--r--   0 runner    (1001) docker     (127)      113 2024-05-02 15:38:51.000000 xga-0.4.4/MANIFEST.in
--rw-r--r--   0 runner    (1001) docker     (127)     9108 2024-05-02 15:38:56.000000 xga-0.4.4/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)     7792 2024-05-02 15:38:51.000000 xga-0.4.4/README.md
--rw-r--r--   0 runner    (1001) docker     (127)      188 2024-05-02 15:38:56.000000 xga-0.4.4/setup.cfg
--rw-r--r--   0 runner    (1001) docker     (127)     1343 2024-05-02 15:38:51.000000 xga-0.4.4/setup.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 15:38:56.000000 xga-0.4.4/tests/
--rw-r--r--   0 runner    (1001) docker     (127)      846 2024-05-02 15:38:51.000000 xga-0.4.4/tests/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 15:38:56.000000 xga-0.4.4/tests/imagetools/
--rw-r--r--   0 runner    (1001) docker     (127)      217 2024-05-02 15:38:51.000000 xga-0.4.4/tests/imagetools/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     7489 2024-05-02 15:38:51.000000 xga-0.4.4/tests/imagetools/test_it_misc.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 15:38:56.000000 xga-0.4.4/tests/sourcetools/
--rw-r--r--   0 runner    (1001) docker     (127)      217 2024-05-02 15:38:51.000000 xga-0.4.4/tests/sourcetools/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     2206 2024-05-02 15:38:51.000000 xga-0.4.4/tests/sourcetools/test_st_misc.py
--rw-r--r--   0 runner    (1001) docker     (127)    68829 2024-05-02 15:38:52.000000 xga-0.4.4/versioneer.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 15:38:56.000000 xga-0.4.4/xga/
--rw-r--r--   0 runner    (1001) docker     (127)      587 2024-05-02 15:38:52.000000 xga-0.4.4/xga/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    18661 2024-05-02 15:38:52.000000 xga-0.4.4/xga/_version.py
--rw-r--r--   0 runner    (1001) docker     (127)    16280 2024-05-02 15:38:52.000000 xga-0.4.4/xga/exceptions.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 15:38:56.000000 xga-0.4.4/xga/files/
--rw-r--r--   0 runner    (1001) docker     (127)     1012 2024-05-02 15:38:52.000000 xga-0.4.4/xga/files/add_model_list.txt
--rw-r--r--   0 runner    (1001) docker     (127)    38322 2024-05-02 15:38:52.000000 xga-0.4.4/xga/files/long_xga_logo.png
--rw-r--r--   0 runner    (1001) docker     (127)      387 2024-05-02 15:38:52.000000 xga-0.4.4/xga/files/mult_model_list.txt
--rw-r--r--   0 runner    (1001) docker     (127)    55115 2024-05-02 15:38:52.000000 xga-0.4.4/xga/files/quick_xga_logo.png
--rw-r--r--   0 runner    (1001) docker     (127)    21617 2024-05-02 15:38:52.000000 xga-0.4.4/xga/files/sas_errors.csv
--rw-r--r--   0 runner    (1001) docker     (127)    15346 2024-05-02 15:38:52.000000 xga-0.4.4/xga/files/sas_warnings.csv
--rw-r--r--   0 runner    (1001) docker     (127)    16975 2024-05-02 15:38:52.000000 xga-0.4.4/xga/files/xspec_model_pars.json5
--rw-r--r--   0 runner    (1001) docker     (127)    11690 2024-05-02 15:38:52.000000 xga-0.4.4/xga/files/xspec_model_units.json5
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 15:38:56.000000 xga-0.4.4/xga/imagetools/
--rw-r--r--   0 runner    (1001) docker     (127)      347 2024-05-02 15:38:52.000000 xga-0.4.4/xga/imagetools/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    15405 2024-05-02 15:38:52.000000 xga-0.4.4/xga/imagetools/bin.py
--rw-r--r--   0 runner    (1001) docker     (127)    14581 2024-05-02 15:38:52.000000 xga-0.4.4/xga/imagetools/misc.py
--rw-r--r--   0 runner    (1001) docker     (127)    21456 2024-05-02 15:38:52.000000 xga-0.4.4/xga/imagetools/profile.py
--rw-r--r--   0 runner    (1001) docker     (127)    15234 2024-05-02 15:38:52.000000 xga-0.4.4/xga/imagetools/psf.py
--rw-r--r--   0 runner    (1001) docker     (127)    10252 2024-05-02 15:38:52.000000 xga-0.4.4/xga/imagetools/smooth.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 15:38:56.000000 xga-0.4.4/xga/models/
--rw-r--r--   0 runner    (1001) docker     (127)     4709 2024-05-02 15:38:52.000000 xga-0.4.4/xga/models/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    59947 2024-05-02 15:38:52.000000 xga-0.4.4/xga/models/base.py
--rw-r--r--   0 runner    (1001) docker     (127)    35832 2024-05-02 15:38:52.000000 xga-0.4.4/xga/models/density.py
--rw-r--r--   0 runner    (1001) docker     (127)     3548 2024-05-02 15:38:52.000000 xga-0.4.4/xga/models/fitting.py
--rw-r--r--   0 runner    (1001) docker     (127)     2248 2024-05-02 15:38:52.000000 xga-0.4.4/xga/models/misc.py
--rw-r--r--   0 runner    (1001) docker     (127)    24643 2024-05-02 15:38:52.000000 xga-0.4.4/xga/models/sb.py
--rw-r--r--   0 runner    (1001) docker     (127)    16630 2024-05-02 15:38:52.000000 xga-0.4.4/xga/models/temperature.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 15:38:56.000000 xga-0.4.4/xga/products/
--rw-r--r--   0 runner    (1001) docker     (127)      704 2024-05-02 15:38:52.000000 xga-0.4.4/xga/products/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)   153439 2024-05-02 15:38:52.000000 xga-0.4.4/xga/products/base.py
--rw-r--r--   0 runner    (1001) docker     (127)    73512 2024-05-02 15:38:52.000000 xga-0.4.4/xga/products/lightcurve.py
--rw-r--r--   0 runner    (1001) docker     (127)     1182 2024-05-02 15:38:52.000000 xga-0.4.4/xga/products/misc.py
--rw-r--r--   0 runner    (1001) docker     (127)   194625 2024-05-02 15:38:52.000000 xga-0.4.4/xga/products/phot.py
--rw-r--r--   0 runner    (1001) docker     (127)   136143 2024-05-02 15:38:52.000000 xga-0.4.4/xga/products/profile.py
--rw-r--r--   0 runner    (1001) docker     (127)    87262 2024-05-02 15:38:52.000000 xga-0.4.4/xga/products/relation.py
--rw-r--r--   0 runner    (1001) docker     (127)   167882 2024-05-02 15:38:52.000000 xga-0.4.4/xga/products/spec.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 15:38:56.000000 xga-0.4.4/xga/relations/
--rw-r--r--   0 runner    (1001) docker     (127)      218 2024-05-02 15:38:52.000000 xga-0.4.4/xga/relations/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 15:38:56.000000 xga-0.4.4/xga/relations/clusters/
--rw-r--r--   0 runner    (1001) docker     (127)     5637 2024-05-02 15:38:52.000000 xga-0.4.4/xga/relations/clusters/LT.py
--rw-r--r--   0 runner    (1001) docker     (127)      942 2024-05-02 15:38:52.000000 xga-0.4.4/xga/relations/clusters/Lλ.py
--rw-r--r--   0 runner    (1001) docker     (127)     3855 2024-05-02 15:38:52.000000 xga-0.4.4/xga/relations/clusters/MT.py
--rw-r--r--   0 runner    (1001) docker     (127)      225 2024-05-02 15:38:52.000000 xga-0.4.4/xga/relations/clusters/Mλ.py
--rw-r--r--   0 runner    (1001) docker     (127)     3481 2024-05-02 15:38:52.000000 xga-0.4.4/xga/relations/clusters/RT.py
--rw-r--r--   0 runner    (1001) docker     (127)     1587 2024-05-02 15:38:52.000000 xga-0.4.4/xga/relations/clusters/TL.py
--rw-r--r--   0 runner    (1001) docker     (127)      886 2024-05-02 15:38:52.000000 xga-0.4.4/xga/relations/clusters/Tλ.py
--rw-r--r--   0 runner    (1001) docker     (127)      325 2024-05-02 15:38:52.000000 xga-0.4.4/xga/relations/clusters/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    29780 2024-05-02 15:38:52.000000 xga-0.4.4/xga/relations/fit.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 15:38:56.000000 xga-0.4.4/xga/samples/
--rw-r--r--   0 runner    (1001) docker     (127)      365 2024-05-02 15:38:52.000000 xga-0.4.4/xga/samples/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    26678 2024-05-02 15:38:52.000000 xga-0.4.4/xga/samples/base.py
--rw-r--r--   0 runner    (1001) docker     (127)    91396 2024-05-02 15:38:52.000000 xga-0.4.4/xga/samples/extended.py
--rw-r--r--   0 runner    (1001) docker     (127)    20608 2024-05-02 15:38:52.000000 xga-0.4.4/xga/samples/general.py
--rw-r--r--   0 runner    (1001) docker     (127)    13296 2024-05-02 15:38:52.000000 xga-0.4.4/xga/samples/point.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 15:38:56.000000 xga-0.4.4/xga/sas/
--rw-r--r--   0 runner    (1001) docker     (127)      318 2024-05-02 15:38:52.000000 xga-0.4.4/xga/sas/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    15331 2024-05-02 15:38:52.000000 xga-0.4.4/xga/sas/_common.py
--rw-r--r--   0 runner    (1001) docker     (127)    22112 2024-05-02 15:38:52.000000 xga-0.4.4/xga/sas/lightcurve.py
--rw-r--r--   0 runner    (1001) docker     (127)     3996 2024-05-02 15:38:52.000000 xga-0.4.4/xga/sas/misc.py
--rw-r--r--   0 runner    (1001) docker     (127)    28627 2024-05-02 15:38:52.000000 xga-0.4.4/xga/sas/phot.py
--rw-r--r--   0 runner    (1001) docker     (127)    18762 2024-05-02 15:38:52.000000 xga-0.4.4/xga/sas/run.py
--rw-r--r--   0 runner    (1001) docker     (127)    54920 2024-05-02 15:38:52.000000 xga-0.4.4/xga/sas/spec.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 15:38:56.000000 xga-0.4.4/xga/sources/
--rw-r--r--   0 runner    (1001) docker     (127)      370 2024-05-02 15:38:52.000000 xga-0.4.4/xga/sources/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)   254899 2024-05-02 15:38:52.000000 xga-0.4.4/xga/sources/base.py
--rw-r--r--   0 runner    (1001) docker     (127)    71159 2024-05-02 15:38:52.000000 xga-0.4.4/xga/sources/extended.py
--rw-r--r--   0 runner    (1001) docker     (127)    37987 2024-05-02 15:38:52.000000 xga-0.4.4/xga/sources/general.py
--rw-r--r--   0 runner    (1001) docker     (127)    14617 2024-05-02 15:38:52.000000 xga-0.4.4/xga/sources/point.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 15:38:56.000000 xga-0.4.4/xga/sourcetools/
--rw-r--r--   0 runner    (1001) docker     (127)      308 2024-05-02 15:38:52.000000 xga-0.4.4/xga/sourcetools/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     8228 2024-05-02 15:38:52.000000 xga-0.4.4/xga/sourcetools/_common.py
--rw-r--r--   0 runner    (1001) docker     (127)    45416 2024-05-02 15:38:52.000000 xga-0.4.4/xga/sourcetools/density.py
--rw-r--r--   0 runner    (1001) docker     (127)     4777 2024-05-02 15:38:52.000000 xga-0.4.4/xga/sourcetools/deproj.py
--rw-r--r--   0 runner    (1001) docker     (127)    13858 2024-05-02 15:38:52.000000 xga-0.4.4/xga/sourcetools/entropy.py
--rw-r--r--   0 runner    (1001) docker     (127)    13599 2024-05-02 15:38:52.000000 xga-0.4.4/xga/sourcetools/mass.py
--rw-r--r--   0 runner    (1001) docker     (127)    38586 2024-05-02 15:38:52.000000 xga-0.4.4/xga/sourcetools/match.py
--rw-r--r--   0 runner    (1001) docker     (127)     9086 2024-05-02 15:38:52.000000 xga-0.4.4/xga/sourcetools/misc.py
--rw-r--r--   0 runner    (1001) docker     (127)    47485 2024-05-02 15:38:52.000000 xga-0.4.4/xga/sourcetools/stack.py
--rw-r--r--   0 runner    (1001) docker     (127)    55307 2024-05-02 15:38:52.000000 xga-0.4.4/xga/sourcetools/temperature.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 15:38:56.000000 xga-0.4.4/xga/tools/
--rw-r--r--   0 runner    (1001) docker     (127)      242 2024-05-02 15:38:52.000000 xga-0.4.4/xga/tools/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 15:38:56.000000 xga-0.4.4/xga/tools/clusters/
--rw-r--r--   0 runner    (1001) docker     (127)    42641 2024-05-02 15:38:52.000000 xga-0.4.4/xga/tools/clusters/LT.py
--rw-r--r--   0 runner    (1001) docker     (127)      266 2024-05-02 15:38:52.000000 xga-0.4.4/xga/tools/clusters/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    24247 2024-05-02 15:38:52.000000 xga-0.4.4/xga/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 15:38:56.000000 xga-0.4.4/xga/xspec/
--rw-r--r--   0 runner    (1001) docker     (127)      387 2024-05-02 15:38:52.000000 xga-0.4.4/xga/xspec/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    11909 2024-05-02 15:38:52.000000 xga-0.4.4/xga/xspec/fakeit.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 15:38:56.000000 xga-0.4.4/xga/xspec/fit/
--rw-r--r--   0 runner    (1001) docker     (127)      302 2024-05-02 15:38:52.000000 xga-0.4.4/xga/xspec/fit/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    12625 2024-05-02 15:38:52.000000 xga-0.4.4/xga/xspec/fit/_common.py
--rw-r--r--   0 runner    (1001) docker     (127)    55552 2024-05-02 15:38:52.000000 xga-0.4.4/xga/xspec/fit/general.py
--rw-r--r--   0 runner    (1001) docker     (127)    10831 2024-05-02 15:38:52.000000 xga-0.4.4/xga/xspec/fit/profile.py
--rw-r--r--   0 runner    (1001) docker     (127)    18696 2024-05-02 15:38:52.000000 xga-0.4.4/xga/xspec/run.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 15:38:56.000000 xga-0.4.4/xga/xspec_scripts/
--rw-r--r--   0 runner    (1001) docker     (127)     6273 2024-05-02 15:38:52.000000 xga-0.4.4/xga/xspec_scripts/cr_conv_calc.xcm
--rw-r--r--   0 runner    (1001) docker     (127)    21107 2024-05-02 15:38:52.000000 xga-0.4.4/xga/xspec_scripts/crossarf_xspec_fit.xcm
--rw-r--r--   0 runner    (1001) docker     (127)    20818 2024-05-02 15:38:52.000000 xga-0.4.4/xga/xspec_scripts/general_xspec_fit.xcm
--rw-r--r--   0 runner    (1001) docker     (127)     3198 2024-05-02 15:38:52.000000 xga-0.4.4/xga/xspec_scripts/get_pars.tcl
--rw-r--r--   0 runner    (1001) docker     (127)       28 2024-05-02 15:38:52.000000 xga-0.4.4/xga/xspec_scripts/null_script.xcm
--rw-r--r--   0 runner    (1001) docker     (127)    13829 2024-05-02 15:38:52.000000 xga-0.4.4/xga/xspec_scripts/xga_extract.tcl
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-02 15:38:56.000000 xga-0.4.4/xga.egg-info/
--rw-r--r--   0 runner    (1001) docker     (127)     9108 2024-05-02 15:38:56.000000 xga-0.4.4/xga.egg-info/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)     2461 2024-05-02 15:38:56.000000 xga-0.4.4/xga.egg-info/SOURCES.txt
--rw-r--r--   0 runner    (1001) docker     (127)        1 2024-05-02 15:38:56.000000 xga-0.4.4/xga.egg-info/dependency_links.txt
--rw-r--r--   0 runner    (1001) docker     (127)      219 2024-05-02 15:38:56.000000 xga-0.4.4/xga.egg-info/requires.txt
--rw-r--r--   0 runner    (1001) docker     (127)       10 2024-05-02 15:38:56.000000 xga-0.4.4/xga.egg-info/top_level.txt
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 15:10:29.000000 xga-0.4.5/
+-rw-r--r--   0 runner    (1001) docker     (127)      113 2024-05-27 15:10:24.000000 xga-0.4.5/MANIFEST.in
+-rw-r--r--   0 runner    (1001) docker     (127)     9108 2024-05-27 15:10:29.000000 xga-0.4.5/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)     7792 2024-05-27 15:10:24.000000 xga-0.4.5/README.md
+-rw-r--r--   0 runner    (1001) docker     (127)      188 2024-05-27 15:10:29.000000 xga-0.4.5/setup.cfg
+-rw-r--r--   0 runner    (1001) docker     (127)     1343 2024-05-27 15:10:25.000000 xga-0.4.5/setup.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 15:10:29.000000 xga-0.4.5/tests/
+-rw-r--r--   0 runner    (1001) docker     (127)      846 2024-05-27 15:10:25.000000 xga-0.4.5/tests/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 15:10:29.000000 xga-0.4.5/tests/imagetools/
+-rw-r--r--   0 runner    (1001) docker     (127)      217 2024-05-27 15:10:25.000000 xga-0.4.5/tests/imagetools/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7489 2024-05-27 15:10:25.000000 xga-0.4.5/tests/imagetools/test_it_misc.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 15:10:29.000000 xga-0.4.5/tests/sourcetools/
+-rw-r--r--   0 runner    (1001) docker     (127)      217 2024-05-27 15:10:25.000000 xga-0.4.5/tests/sourcetools/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2206 2024-05-27 15:10:25.000000 xga-0.4.5/tests/sourcetools/test_st_misc.py
+-rw-r--r--   0 runner    (1001) docker     (127)    68829 2024-05-27 15:10:25.000000 xga-0.4.5/versioneer.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 15:10:29.000000 xga-0.4.5/xga/
+-rw-r--r--   0 runner    (1001) docker     (127)      587 2024-05-27 15:10:25.000000 xga-0.4.5/xga/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18661 2024-05-27 15:10:25.000000 xga-0.4.5/xga/_version.py
+-rw-r--r--   0 runner    (1001) docker     (127)    16280 2024-05-27 15:10:25.000000 xga-0.4.5/xga/exceptions.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 15:10:29.000000 xga-0.4.5/xga/files/
+-rw-r--r--   0 runner    (1001) docker     (127)     1012 2024-05-27 15:10:25.000000 xga-0.4.5/xga/files/add_model_list.txt
+-rw-r--r--   0 runner    (1001) docker     (127)    38322 2024-05-27 15:10:25.000000 xga-0.4.5/xga/files/long_xga_logo.png
+-rw-r--r--   0 runner    (1001) docker     (127)      387 2024-05-27 15:10:25.000000 xga-0.4.5/xga/files/mult_model_list.txt
+-rw-r--r--   0 runner    (1001) docker     (127)    55115 2024-05-27 15:10:25.000000 xga-0.4.5/xga/files/quick_xga_logo.png
+-rw-r--r--   0 runner    (1001) docker     (127)    21617 2024-05-27 15:10:25.000000 xga-0.4.5/xga/files/sas_errors.csv
+-rw-r--r--   0 runner    (1001) docker     (127)    15346 2024-05-27 15:10:25.000000 xga-0.4.5/xga/files/sas_warnings.csv
+-rw-r--r--   0 runner    (1001) docker     (127)    16975 2024-05-27 15:10:25.000000 xga-0.4.5/xga/files/xspec_model_pars.json5
+-rw-r--r--   0 runner    (1001) docker     (127)    11690 2024-05-27 15:10:25.000000 xga-0.4.5/xga/files/xspec_model_units.json5
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 15:10:29.000000 xga-0.4.5/xga/imagetools/
+-rw-r--r--   0 runner    (1001) docker     (127)      347 2024-05-27 15:10:25.000000 xga-0.4.5/xga/imagetools/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15405 2024-05-27 15:10:25.000000 xga-0.4.5/xga/imagetools/bin.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14581 2024-05-27 15:10:25.000000 xga-0.4.5/xga/imagetools/misc.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21456 2024-05-27 15:10:25.000000 xga-0.4.5/xga/imagetools/profile.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15234 2024-05-27 15:10:25.000000 xga-0.4.5/xga/imagetools/psf.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10252 2024-05-27 15:10:25.000000 xga-0.4.5/xga/imagetools/smooth.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 15:10:29.000000 xga-0.4.5/xga/models/
+-rw-r--r--   0 runner    (1001) docker     (127)     4709 2024-05-27 15:10:25.000000 xga-0.4.5/xga/models/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    59947 2024-05-27 15:10:25.000000 xga-0.4.5/xga/models/base.py
+-rw-r--r--   0 runner    (1001) docker     (127)    35832 2024-05-27 15:10:25.000000 xga-0.4.5/xga/models/density.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3548 2024-05-27 15:10:25.000000 xga-0.4.5/xga/models/fitting.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2248 2024-05-27 15:10:25.000000 xga-0.4.5/xga/models/misc.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24643 2024-05-27 15:10:25.000000 xga-0.4.5/xga/models/sb.py
+-rw-r--r--   0 runner    (1001) docker     (127)    16630 2024-05-27 15:10:25.000000 xga-0.4.5/xga/models/temperature.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 15:10:29.000000 xga-0.4.5/xga/products/
+-rw-r--r--   0 runner    (1001) docker     (127)      704 2024-05-27 15:10:25.000000 xga-0.4.5/xga/products/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)   153439 2024-05-27 15:10:25.000000 xga-0.4.5/xga/products/base.py
+-rw-r--r--   0 runner    (1001) docker     (127)    73512 2024-05-27 15:10:25.000000 xga-0.4.5/xga/products/lightcurve.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1182 2024-05-27 15:10:25.000000 xga-0.4.5/xga/products/misc.py
+-rw-r--r--   0 runner    (1001) docker     (127)   194625 2024-05-27 15:10:25.000000 xga-0.4.5/xga/products/phot.py
+-rw-r--r--   0 runner    (1001) docker     (127)   136143 2024-05-27 15:10:25.000000 xga-0.4.5/xga/products/profile.py
+-rw-r--r--   0 runner    (1001) docker     (127)    87262 2024-05-27 15:10:25.000000 xga-0.4.5/xga/products/relation.py
+-rw-r--r--   0 runner    (1001) docker     (127)   167882 2024-05-27 15:10:25.000000 xga-0.4.5/xga/products/spec.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 15:10:29.000000 xga-0.4.5/xga/relations/
+-rw-r--r--   0 runner    (1001) docker     (127)      218 2024-05-27 15:10:25.000000 xga-0.4.5/xga/relations/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 15:10:29.000000 xga-0.4.5/xga/relations/clusters/
+-rw-r--r--   0 runner    (1001) docker     (127)     5637 2024-05-27 15:10:25.000000 xga-0.4.5/xga/relations/clusters/LT.py
+-rw-r--r--   0 runner    (1001) docker     (127)      942 2024-05-27 15:10:25.000000 xga-0.4.5/xga/relations/clusters/Lλ.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3855 2024-05-27 15:10:25.000000 xga-0.4.5/xga/relations/clusters/MT.py
+-rw-r--r--   0 runner    (1001) docker     (127)      225 2024-05-27 15:10:25.000000 xga-0.4.5/xga/relations/clusters/Mλ.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3481 2024-05-27 15:10:25.000000 xga-0.4.5/xga/relations/clusters/RT.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1587 2024-05-27 15:10:25.000000 xga-0.4.5/xga/relations/clusters/TL.py
+-rw-r--r--   0 runner    (1001) docker     (127)      886 2024-05-27 15:10:25.000000 xga-0.4.5/xga/relations/clusters/Tλ.py
+-rw-r--r--   0 runner    (1001) docker     (127)      325 2024-05-27 15:10:25.000000 xga-0.4.5/xga/relations/clusters/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    29780 2024-05-27 15:10:25.000000 xga-0.4.5/xga/relations/fit.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 15:10:29.000000 xga-0.4.5/xga/samples/
+-rw-r--r--   0 runner    (1001) docker     (127)      365 2024-05-27 15:10:25.000000 xga-0.4.5/xga/samples/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26678 2024-05-27 15:10:25.000000 xga-0.4.5/xga/samples/base.py
+-rw-r--r--   0 runner    (1001) docker     (127)    91396 2024-05-27 15:10:25.000000 xga-0.4.5/xga/samples/extended.py
+-rw-r--r--   0 runner    (1001) docker     (127)    20608 2024-05-27 15:10:25.000000 xga-0.4.5/xga/samples/general.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13296 2024-05-27 15:10:25.000000 xga-0.4.5/xga/samples/point.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 15:10:29.000000 xga-0.4.5/xga/sas/
+-rw-r--r--   0 runner    (1001) docker     (127)      318 2024-05-27 15:10:25.000000 xga-0.4.5/xga/sas/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15331 2024-05-27 15:10:25.000000 xga-0.4.5/xga/sas/_common.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22112 2024-05-27 15:10:25.000000 xga-0.4.5/xga/sas/lightcurve.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3996 2024-05-27 15:10:25.000000 xga-0.4.5/xga/sas/misc.py
+-rw-r--r--   0 runner    (1001) docker     (127)    28627 2024-05-27 15:10:25.000000 xga-0.4.5/xga/sas/phot.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18762 2024-05-27 15:10:25.000000 xga-0.4.5/xga/sas/run.py
+-rw-r--r--   0 runner    (1001) docker     (127)    54920 2024-05-27 15:10:25.000000 xga-0.4.5/xga/sas/spec.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 15:10:29.000000 xga-0.4.5/xga/sources/
+-rw-r--r--   0 runner    (1001) docker     (127)      370 2024-05-27 15:10:25.000000 xga-0.4.5/xga/sources/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)   255260 2024-05-27 15:10:25.000000 xga-0.4.5/xga/sources/base.py
+-rw-r--r--   0 runner    (1001) docker     (127)    71159 2024-05-27 15:10:25.000000 xga-0.4.5/xga/sources/extended.py
+-rw-r--r--   0 runner    (1001) docker     (127)    37987 2024-05-27 15:10:25.000000 xga-0.4.5/xga/sources/general.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14617 2024-05-27 15:10:25.000000 xga-0.4.5/xga/sources/point.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 15:10:29.000000 xga-0.4.5/xga/sourcetools/
+-rw-r--r--   0 runner    (1001) docker     (127)      308 2024-05-27 15:10:25.000000 xga-0.4.5/xga/sourcetools/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8228 2024-05-27 15:10:25.000000 xga-0.4.5/xga/sourcetools/_common.py
+-rw-r--r--   0 runner    (1001) docker     (127)    45416 2024-05-27 15:10:25.000000 xga-0.4.5/xga/sourcetools/density.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4777 2024-05-27 15:10:25.000000 xga-0.4.5/xga/sourcetools/deproj.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13858 2024-05-27 15:10:25.000000 xga-0.4.5/xga/sourcetools/entropy.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13599 2024-05-27 15:10:25.000000 xga-0.4.5/xga/sourcetools/mass.py
+-rw-r--r--   0 runner    (1001) docker     (127)    38586 2024-05-27 15:10:25.000000 xga-0.4.5/xga/sourcetools/match.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9086 2024-05-27 15:10:25.000000 xga-0.4.5/xga/sourcetools/misc.py
+-rw-r--r--   0 runner    (1001) docker     (127)    47485 2024-05-27 15:10:25.000000 xga-0.4.5/xga/sourcetools/stack.py
+-rw-r--r--   0 runner    (1001) docker     (127)    55307 2024-05-27 15:10:25.000000 xga-0.4.5/xga/sourcetools/temperature.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 15:10:29.000000 xga-0.4.5/xga/tools/
+-rw-r--r--   0 runner    (1001) docker     (127)      242 2024-05-27 15:10:25.000000 xga-0.4.5/xga/tools/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 15:10:29.000000 xga-0.4.5/xga/tools/clusters/
+-rw-r--r--   0 runner    (1001) docker     (127)    42641 2024-05-27 15:10:25.000000 xga-0.4.5/xga/tools/clusters/LT.py
+-rw-r--r--   0 runner    (1001) docker     (127)      266 2024-05-27 15:10:25.000000 xga-0.4.5/xga/tools/clusters/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24247 2024-05-27 15:10:25.000000 xga-0.4.5/xga/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 15:10:29.000000 xga-0.4.5/xga/xspec/
+-rw-r--r--   0 runner    (1001) docker     (127)      387 2024-05-27 15:10:25.000000 xga-0.4.5/xga/xspec/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11909 2024-05-27 15:10:25.000000 xga-0.4.5/xga/xspec/fakeit.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 15:10:29.000000 xga-0.4.5/xga/xspec/fit/
+-rw-r--r--   0 runner    (1001) docker     (127)      302 2024-05-27 15:10:25.000000 xga-0.4.5/xga/xspec/fit/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12625 2024-05-27 15:10:25.000000 xga-0.4.5/xga/xspec/fit/_common.py
+-rw-r--r--   0 runner    (1001) docker     (127)    55552 2024-05-27 15:10:25.000000 xga-0.4.5/xga/xspec/fit/general.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10831 2024-05-27 15:10:25.000000 xga-0.4.5/xga/xspec/fit/profile.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18696 2024-05-27 15:10:25.000000 xga-0.4.5/xga/xspec/run.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 15:10:29.000000 xga-0.4.5/xga/xspec_scripts/
+-rw-r--r--   0 runner    (1001) docker     (127)     6273 2024-05-27 15:10:25.000000 xga-0.4.5/xga/xspec_scripts/cr_conv_calc.xcm
+-rw-r--r--   0 runner    (1001) docker     (127)    21107 2024-05-27 15:10:25.000000 xga-0.4.5/xga/xspec_scripts/crossarf_xspec_fit.xcm
+-rw-r--r--   0 runner    (1001) docker     (127)    20818 2024-05-27 15:10:25.000000 xga-0.4.5/xga/xspec_scripts/general_xspec_fit.xcm
+-rw-r--r--   0 runner    (1001) docker     (127)     3198 2024-05-27 15:10:25.000000 xga-0.4.5/xga/xspec_scripts/get_pars.tcl
+-rw-r--r--   0 runner    (1001) docker     (127)       28 2024-05-27 15:10:25.000000 xga-0.4.5/xga/xspec_scripts/null_script.xcm
+-rw-r--r--   0 runner    (1001) docker     (127)    13829 2024-05-27 15:10:25.000000 xga-0.4.5/xga/xspec_scripts/xga_extract.tcl
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 15:10:29.000000 xga-0.4.5/xga.egg-info/
+-rw-r--r--   0 runner    (1001) docker     (127)     9108 2024-05-27 15:10:28.000000 xga-0.4.5/xga.egg-info/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)     2461 2024-05-27 15:10:29.000000 xga-0.4.5/xga.egg-info/SOURCES.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        1 2024-05-27 15:10:28.000000 xga-0.4.5/xga.egg-info/dependency_links.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      219 2024-05-27 15:10:28.000000 xga-0.4.5/xga.egg-info/requires.txt
+-rw-r--r--   0 runner    (1001) docker     (127)       10 2024-05-27 15:10:28.000000 xga-0.4.5/xga.egg-info/top_level.txt
```

### Comparing `xga-0.4.4/PKG-INFO` & `xga-0.4.5/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: xga
-Version: 0.4.4
+Version: 0.4.5
 Summary: Python package to easily generate and analyse XMM data products
 Home-page: http://github.com/DavidT3/XGA
 Author: David Turner
 Author-email: david.turner@sussex.ac.uk
 License: UNKNOWN
 Description: <p align="center">
             <img src="https://raw.githubusercontent.com/DavidT3/XGA/master/xga/files/long_xga_logo.png" width="500">
```

### Comparing `xga-0.4.4/README.md` & `xga-0.4.5/README.md`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/setup.py` & `xga-0.4.5/setup.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/tests/__init__.py` & `xga-0.4.5/tests/__init__.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/tests/imagetools/test_it_misc.py` & `xga-0.4.5/tests/imagetools/test_it_misc.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/tests/sourcetools/test_st_misc.py` & `xga-0.4.5/tests/sourcetools/test_st_misc.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/versioneer.py` & `xga-0.4.5/versioneer.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/__init__.py` & `xga-0.4.5/xga/__init__.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/_version.py` & `xga-0.4.5/xga/_version.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/exceptions.py` & `xga-0.4.5/xga/exceptions.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/files/add_model_list.txt` & `xga-0.4.5/xga/files/add_model_list.txt`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/files/long_xga_logo.png` & `xga-0.4.5/xga/files/long_xga_logo.png`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/files/quick_xga_logo.png` & `xga-0.4.5/xga/files/quick_xga_logo.png`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/files/sas_errors.csv` & `xga-0.4.5/xga/files/sas_errors.csv`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/files/sas_warnings.csv` & `xga-0.4.5/xga/files/sas_warnings.csv`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/files/xspec_model_pars.json5` & `xga-0.4.5/xga/files/xspec_model_pars.json5`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/files/xspec_model_units.json5` & `xga-0.4.5/xga/files/xspec_model_units.json5`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/imagetools/bin.py` & `xga-0.4.5/xga/imagetools/bin.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/imagetools/misc.py` & `xga-0.4.5/xga/imagetools/misc.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/imagetools/profile.py` & `xga-0.4.5/xga/imagetools/profile.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/imagetools/psf.py` & `xga-0.4.5/xga/imagetools/psf.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/imagetools/smooth.py` & `xga-0.4.5/xga/imagetools/smooth.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/models/__init__.py` & `xga-0.4.5/xga/models/__init__.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/models/base.py` & `xga-0.4.5/xga/models/base.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/models/density.py` & `xga-0.4.5/xga/models/density.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/models/fitting.py` & `xga-0.4.5/xga/models/fitting.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/models/misc.py` & `xga-0.4.5/xga/models/misc.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/models/sb.py` & `xga-0.4.5/xga/models/sb.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/models/temperature.py` & `xga-0.4.5/xga/models/temperature.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/products/__init__.py` & `xga-0.4.5/xga/products/__init__.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/products/base.py` & `xga-0.4.5/xga/products/base.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/products/lightcurve.py` & `xga-0.4.5/xga/products/lightcurve.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/products/misc.py` & `xga-0.4.5/xga/products/misc.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/products/phot.py` & `xga-0.4.5/xga/products/phot.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/products/profile.py` & `xga-0.4.5/xga/products/profile.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/products/relation.py` & `xga-0.4.5/xga/products/relation.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/products/spec.py` & `xga-0.4.5/xga/products/spec.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/relations/clusters/LT.py` & `xga-0.4.5/xga/relations/clusters/LT.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/relations/clusters/Lλ.py` & `xga-0.4.5/xga/relations/clusters/Lλ.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/relations/clusters/MT.py` & `xga-0.4.5/xga/relations/clusters/MT.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/relations/clusters/RT.py` & `xga-0.4.5/xga/relations/clusters/RT.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/relations/clusters/TL.py` & `xga-0.4.5/xga/relations/clusters/TL.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/relations/clusters/Tλ.py` & `xga-0.4.5/xga/relations/clusters/Tλ.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/relations/fit.py` & `xga-0.4.5/xga/relations/fit.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/samples/base.py` & `xga-0.4.5/xga/samples/base.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/samples/extended.py` & `xga-0.4.5/xga/samples/extended.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/samples/general.py` & `xga-0.4.5/xga/samples/general.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/samples/point.py` & `xga-0.4.5/xga/samples/point.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/sas/_common.py` & `xga-0.4.5/xga/sas/_common.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/sas/lightcurve.py` & `xga-0.4.5/xga/sas/lightcurve.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/sas/misc.py` & `xga-0.4.5/xga/sas/misc.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/sas/phot.py` & `xga-0.4.5/xga/sas/phot.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/sas/run.py` & `xga-0.4.5/xga/sas/run.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/sas/spec.py` & `xga-0.4.5/xga/sas/spec.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/sources/base.py` & `xga-0.4.5/xga/sources/base.py`

 * *Files 0% similar despite different names*

```diff
@@ -4,16 +4,16 @@
 00000030: 616c 7973 6520 2858 4741 292c 2061 206d  alyse (XGA), a m
 00000040: 6f64 756c 6520 6465 7369 676e 6564 2066  odule designed f
 00000050: 6f72 2074 6865 2058 4d4d 2043 6c75 7374  or the XMM Clust
 00000060: 6572 2053 7572 7665 7920 2858 4353 292e  er Survey (XCS).
 00000070: 0a23 2020 4c61 7374 206d 6f64 6966 6965  .#  Last modifie
 00000080: 6420 6279 2044 6176 6964 204a 2054 7572  d by David J Tur
 00000090: 6e65 7220 2874 7572 6e65 3534 3040 6d73  ner (turne540@ms
-000000a0: 752e 6564 7529 2030 322f 3035 2f32 3032  u.edu) 02/05/202
-000000b0: 342c 2031 303a 3430 2e20 436f 7079 7269  4, 10:40. Copyri
+000000a0: 752e 6564 7529 2032 372f 3035 2f32 3032  u.edu) 27/05/202
+000000b0: 342c 2031 303a 3438 2e20 436f 7079 7269  4, 10:48. Copyri
 000000c0: 6768 7420 2863 2920 5468 6520 436f 6e74  ght (c) The Cont
 000000d0: 7269 6275 746f 7273 0a0a 696d 706f 7274  ributors..import
 000000e0: 206f 730a 696d 706f 7274 2070 6963 6b6c   os.import pickl
 000000f0: 650a 6672 6f6d 2063 6f70 7920 696d 706f  e.from copy impo
 00000100: 7274 2064 6565 7063 6f70 790a 6672 6f6d  rt deepcopy.from
 00000110: 2069 7465 7274 6f6f 6c73 2069 6d70 6f72   itertools impor
 00000120: 7420 7072 6f64 7563 740a 6672 6f6d 2073  t product.from s
@@ -3690,12243 +3690,12265 @@
 0000e690: 7475 7265 0a20 2020 2020 2020 2069 6620  ture.        if 
 0000e6a0: 6c65 6e28 616e 6e5f 7370 6563 5f63 6f6e  len(ann_spec_con
 0000e6b0: 7374 6974 7565 6e74 7329 2021 3d20 303a  stituents) != 0:
 0000e6c0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
 0000e6d0: 2073 6574 5f69 6420 696e 2061 6e6e 5f73   set_id in ann_s
 0000e6e0: 7065 635f 636f 6e73 7469 7475 656e 7473  pec_constituents
 0000e6f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000e700: 2020 6966 2061 6e6e 5f73 7065 635f 7573    if ann_spec_us
-0000e710: 6162 6c65 5b73 6574 5f69 645d 3a0a 2020  able[set_id]:.  
-0000e720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e730: 2020 616e 6e5f 7370 6563 5f6f 626a 203d    ann_spec_obj =
-0000e740: 2041 6e6e 756c 6172 5370 6563 7472 6128   AnnularSpectra(
-0000e750: 616e 6e5f 7370 6563 5f63 6f6e 7374 6974  ann_spec_constit
-0000e760: 7565 6e74 735b 7365 745f 6964 5d29 0a20  uents[set_id]). 
-0000e770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e780: 2020 2069 6620 7365 6c66 2e5f 7265 6473     if self._reds
-0000e790: 6869 6674 2069 7320 6e6f 7420 4e6f 6e65  hift is not None
-0000e7a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000e7b0: 2020 2020 2020 2020 2020 2320 4966 2077            # If w
-0000e7c0: 6520 6b6e 6f77 2074 6865 2072 6564 7368  e know the redsh
-0000e7d0: 6966 7420 7765 2077 696c 6c20 6164 6420  ift we will add 
-0000e7e0: 7468 6520 7261 6469 6920 746f 2074 6865  the radii to the
-0000e7f0: 2061 6e6e 756c 6172 2073 7065 6374 7261   annular spectra
-0000e800: 2069 6e20 7072 6f70 6572 2064 6973 7461   in proper dista
-0000e810: 6e63 6520 756e 6974 730a 2020 2020 2020  nce units.      
-0000e820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e830: 2020 616e 6e5f 7370 6563 5f6f 626a 2e70    ann_spec_obj.p
-0000e840: 726f 7065 725f 7261 6469 6920 3d20 7365  roper_radii = se
-0000e850: 6c66 2e63 6f6e 7665 7274 5f72 6164 6975  lf.convert_radiu
-0000e860: 7328 616e 6e5f 7370 6563 5f6f 626a 2e72  s(ann_spec_obj.r
-0000e870: 6164 6969 2c20 276b 7063 2729 0a20 2020  adii, 'kpc').   
-0000e880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e890: 2073 656c 662e 7570 6461 7465 5f70 726f   self.update_pro
-0000e8a0: 6475 6374 7328 616e 6e5f 7370 6563 5f6f  ducts(ann_spec_o
-0000e8b0: 626a 2c20 7570 6461 7465 5f69 6e76 3d46  bj, update_inv=F
-0000e8c0: 616c 7365 290a 0a20 2020 2020 2020 2023  alse)..        #
-0000e8d0: 2048 6572 6520 7765 206c 6f61 6420 696e   Here we load in
-0000e8e0: 2061 6e79 2063 6f6d 6269 6e65 6420 696d   any combined im
-0000e8f0: 6167 6573 2061 6e64 2065 7870 6f73 7572  ages and exposur
-0000e900: 6520 6d61 7073 2074 6861 7420 6d61 7920  e maps that may 
-0000e910: 6861 7665 2062 6565 6e20 6765 6e65 7261  have been genera
-0000e920: 7465 640a 2020 2020 2020 2020 6f73 2e63  ted.        os.c
-0000e930: 6864 6972 284f 5554 5055 5420 2b20 2763  hdir(OUTPUT + 'c
-0000e940: 6f6d 6269 6e65 6427 290a 2020 2020 2020  ombined').      
-0000e950: 2020 6375 725f 6420 3d20 6f73 2e67 6574    cur_d = os.get
-0000e960: 6377 6428 2920 2b20 272f 270a 2020 2020  cwd() + '/'.    
-0000e970: 2020 2020 2320 5468 6973 2063 7265 6174      # This creat
-0000e980: 6573 2061 2073 6574 206f 6620 6f62 7365  es a set of obse
-0000e990: 7276 6174 696f 6e2d 696e 7374 7275 6d65  rvation-instrume
-0000e9a0: 6e74 2073 7472 696e 6773 2074 6861 7420  nt strings that 
-0000e9b0: 6465 7363 7269 6265 2074 6865 2063 7572  describe the cur
-0000e9c0: 7265 6e74 2063 6f6d 6269 6e61 7469 6f6e  rent combination
-0000e9d0: 7320 6173 736f 6369 6174 6564 0a20 2020  s associated.   
-0000e9e0: 2020 2020 2023 2020 7769 7468 2074 6869       #  with thi
-0000e9f0: 7320 736f 7572 6365 2c20 666f 7220 7465  s source, for te
-0000ea00: 7374 696e 6720 6167 6169 6e73 7420 746f  sting against to
-0000ea10: 206d 616b 6520 7375 7265 2077 6527 7265   make sure we're
-0000ea20: 206c 6f61 6469 6e67 2069 6e20 636f 6d62   loading in comb
-0000ea30: 696e 6564 2069 6d61 6765 732f 6578 706d  ined images/expm
-0000ea40: 6170 7320 7468 6174 0a20 2020 2020 2020  aps that.       
-0000ea50: 2023 2020 646f 2062 656c 6f6e 6720 7769   #  do belong wi
-0000ea60: 7468 2074 6869 7320 736f 7572 6365 0a20  th this source. 
-0000ea70: 2020 2020 2020 2073 7263 5f6f 695f 7365         src_oi_se
-0000ea80: 7420 3d20 7365 7428 5b6f 2b69 2066 6f72  t = set([o+i for
-0000ea90: 206f 2069 6e20 7365 6c66 2e5f 696e 7374   o in self._inst
-0000eaa0: 7275 6d65 6e74 7320 666f 7220 6920 696e  ruments for i in
-0000eab0: 2073 656c 662e 5f69 6e73 7472 756d 656e   self._instrumen
-0000eac0: 7473 5b6f 5d5d 290a 0a20 2020 2020 2020  ts[o]])..       
-0000ead0: 2023 204c 6f61 6473 2069 6e20 7468 6520   # Loads in the 
-0000eae0: 696e 7665 6e74 6f72 7920 6669 6c65 2066  inventory file f
-0000eaf0: 6f72 2074 6869 7320 4f62 7349 440a 2020  or this ObsID.  
-0000eb00: 2020 2020 2020 696e 7665 6e20 3d20 7064        inven = pd
-0000eb10: 2e72 6561 645f 6373 7628 2269 6e76 656e  .read_csv("inven
-0000eb20: 746f 7279 2e63 7376 222c 2064 7479 7065  tory.csv", dtype
-0000eb30: 3d73 7472 290a 2020 2020 2020 2020 7265  =str).        re
-0000eb40: 6c5f 696e 7665 6e20 3d20 696e 7665 6e5b  l_inven = inven[
-0000eb50: 2869 6e76 656e 5b27 7479 7065 275d 203d  (inven['type'] =
-0000eb60: 3d20 2769 6d61 6765 2729 207c 2028 696e  = 'image') | (in
-0000eb70: 7665 6e5b 2774 7970 6527 5d20 3d3d 2027  ven['type'] == '
-0000eb80: 6578 706d 6170 2729 5d0a 2020 2020 2020  expmap')].      
-0000eb90: 2020 666f 7220 726f 775f 696e 642c 2072    for row_ind, r
-0000eba0: 6f77 2069 6e20 7265 6c5f 696e 7665 6e2e  ow in rel_inven.
-0000ebb0: 6974 6572 726f 7773 2829 3a0a 2020 2020  iterrows():.    
-0000ebc0: 2020 2020 2020 2020 6f5f 7370 6c69 7420          o_split 
-0000ebd0: 3d20 726f 775b 276f 6273 5f69 6473 275d  = row['obs_ids']
-0000ebe0: 2e73 706c 6974 2827 2f27 290a 2020 2020  .split('/').    
-0000ebf0: 2020 2020 2020 2020 695f 7370 6c69 7420          i_split 
-0000ec00: 3d20 726f 775b 2769 6e73 7473 275d 2e73  = row['insts'].s
-0000ec10: 706c 6974 2827 2f27 290a 2020 2020 2020  plit('/').      
-0000ec20: 2020 2020 2020 2320 4173 7365 6d62 6c65        # Assemble
-0000ec30: 2061 2073 6574 206f 6620 6f62 7365 7276   a set of observ
-0000ec40: 6174 696f 6e73 2d69 6e73 7472 756d 656e  ations-instrumen
-0000ec50: 7420 7374 7269 6e67 7320 666f 7220 7468  t strings for th
-0000ec60: 6520 6375 7272 656e 7420 726f 772c 2074  e current row, t
-0000ec70: 6f20 7465 7374 2061 6761 696e 7374 2074  o test against t
-0000ec80: 6865 0a20 2020 2020 2020 2020 2020 2023  he.            #
-0000ec90: 2020 7372 635f 6f69 5f73 6574 2077 6520    src_oi_set we 
-0000eca0: 6173 7365 6d62 6c65 6420 6561 726c 6965  assembled earlie
-0000ecb0: 720a 2020 2020 2020 2020 2020 2020 7465  r.            te
-0000ecc0: 7374 5f6f 695f 7365 7420 3d20 7365 7428  st_oi_set = set(
-0000ecd0: 5b6f 2b69 5f73 706c 6974 5b6f 5f69 6e64  [o+i_split[o_ind
-0000ece0: 5d20 666f 7220 6f5f 696e 642c 206f 2069  ] for o_ind, o i
-0000ecf0: 6e20 656e 756d 6572 6174 6528 6f5f 7370  n enumerate(o_sp
-0000ed00: 6c69 7429 5d29 0a20 2020 2020 2020 2020  lit)]).         
-0000ed10: 2020 2023 2046 6972 7374 2077 6520 6d61     # First we ma
-0000ed20: 6b65 2073 7572 6520 7468 6520 7365 7473  ke sure the sets
-0000ed30: 2061 7265 2074 6865 2073 616d 6520 6c65   are the same le
-0000ed40: 6e67 7468 2c20 6966 2074 6865 7927 7265  ngth, if they're
-0000ed50: 206e 6f74 2074 6865 6e20 7765 206b 6e6f   not then we kno
-0000ed60: 7720 6265 666f 7265 2073 7461 7274 696e  w before startin
-0000ed70: 6720 7468 6174 2074 6869 730a 2020 2020  g that this.    
-0000ed80: 2020 2020 2020 2020 2320 2072 6f77 2773          #  row's
-0000ed90: 2066 696c 6520 6361 6e27 7420 6265 206f   file can't be o
-0000eda0: 6b61 7920 666f 7220 7573 2074 6f20 6c6f  kay for us to lo
-0000edb0: 6164 2069 6e2e 2054 6865 6e20 7765 2063  ad in. Then we c
-0000edc0: 6f6d 7075 7465 2074 6865 2075 6e69 6f6e  ompute the union
-0000edd0: 2062 6574 7765 656e 2074 6865 2074 6573   between the tes
-0000ede0: 745f 6f69 5f73 6574 2061 6e64 0a20 2020  t_oi_set and.   
-0000edf0: 2020 2020 2020 2020 2023 2020 7468 6520           #  the 
-0000ee00: 7372 635f 6f69 5f73 6574 2c20 616e 6420  src_oi_set, and 
-0000ee10: 6966 2074 6861 7420 6973 2074 6865 2073  if that is the s
-0000ee20: 616d 6520 6c65 6e67 7468 2061 7320 7468  ame length as th
-0000ee30: 6520 6f72 6967 696e 616c 2073 7263 5f6f  e original src_o
-0000ee40: 695f 7365 7420 7468 656e 2077 6520 6b6e  i_set then we kn
-0000ee50: 6f77 2074 6861 7420 7468 6579 206d 6174  ow that they mat
-0000ee60: 6368 0a20 2020 2020 2020 2020 2020 2023  ch.            #
-0000ee70: 2020 6578 6163 746c 7920 616e 6420 7468    exactly and th
-0000ee80: 6520 7072 6f64 7563 7420 6361 6e20 6265  e product can be
-0000ee90: 206c 6f61 6465 640a 2020 2020 2020 2020   loaded.        
-0000eea0: 2020 2020 6966 206c 656e 2873 7263 5f6f      if len(src_o
-0000eeb0: 695f 7365 7429 203d 3d20 6c65 6e28 7465  i_set) == len(te
-0000eec0: 7374 5f6f 695f 7365 7429 2061 6e64 206c  st_oi_set) and l
-0000eed0: 656e 2873 7263 5f6f 695f 7365 7420 7c20  en(src_oi_set | 
-0000eee0: 7465 7374 5f6f 695f 7365 7429 203d 3d20  test_oi_set) == 
-0000eef0: 6c65 6e28 7372 635f 6f69 5f73 6574 293a  len(src_oi_set):
-0000ef00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ef10: 2073 656c 662e 7570 6461 7465 5f70 726f   self.update_pro
-0000ef20: 6475 6374 7328 7061 7273 655f 696d 6167  ducts(parse_imag
-0000ef30: 655f 6c69 6b65 2863 7572 5f64 2b72 6f77  e_like(cur_d+row
-0000ef40: 5b27 6669 6c65 5f6e 616d 6527 5d2c 2072  ['file_name'], r
-0000ef50: 6f77 5b27 7479 7065 275d 2c20 6d65 7267  ow['type'], merg
-0000ef60: 6564 3d54 7275 6529 2c0a 2020 2020 2020  ed=True),.      
-0000ef70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ef80: 2020 2020 2020 2020 2020 2020 2020 2075                 u
-0000ef90: 7064 6174 655f 696e 763d 4661 6c73 6529  pdate_inv=False)
-0000efa0: 0a0a 2020 2020 2020 2020 6f73 2e63 6864  ..        os.chd
-0000efb0: 6972 286f 675f 6469 7229 0a0a 2020 2020  ir(og_dir)..    
-0000efc0: 2020 2020 2320 4e6f 7720 6c6f 6164 696e      # Now loadin
-0000efd0: 6720 696e 2070 7265 7669 6f75 7320 6669  g in previous fi
-0000efe0: 7473 0a20 2020 2020 2020 2069 6620 6f73  ts.        if os
-0000eff0: 2e70 6174 682e 6578 6973 7473 284f 5554  .path.exists(OUT
-0000f000: 5055 5420 2b20 2258 5350 4543 2f22 202b  PUT + "XSPEC/" +
-0000f010: 2073 656c 662e 6e61 6d65 2920 616e 6420   self.name) and 
-0000f020: 7265 6164 5f66 6974 733a 0a20 2020 2020  read_fits:.     
-0000f030: 2020 2020 2020 2061 6e6e 5f6f 6273 5f6f         ann_obs_o
-0000f040: 7264 6572 203d 207b 7d0a 2020 2020 2020  rder = {}.      
-0000f050: 2020 2020 2020 616e 6e5f 7265 7375 6c74        ann_result
-0000f060: 7320 3d20 7b7d 0a20 2020 2020 2020 2020  s = {}.         
-0000f070: 2020 2061 6e6e 5f6c 756d 7320 3d20 7b7d     ann_lums = {}
-0000f080: 0a20 2020 2020 2020 2020 2020 2070 7265  .            pre
-0000f090: 765f 6669 7473 203d 205b 4f55 5450 5554  v_fits = [OUTPUT
-0000f0a0: 202b 2022 5853 5045 432f 2220 2b20 7365   + "XSPEC/" + se
-0000f0b0: 6c66 2e6e 616d 6520 2b20 222f 2220 2b20  lf.name + "/" + 
-0000f0c0: 660a 2020 2020 2020 2020 2020 2020 2020  f.              
-0000f0d0: 2020 2020 2020 2020 2020 2066 6f72 2066             for f
-0000f0e0: 2069 6e20 6f73 2e6c 6973 7464 6972 284f   in os.listdir(O
-0000f0f0: 5554 5055 5420 2b20 2258 5350 4543 2f22  UTPUT + "XSPEC/"
-0000f100: 202b 2073 656c 662e 6e61 6d65 2920 6966   + self.name) if
-0000f110: 2022 2e78 636d 2220 6e6f 7420 696e 2066   ".xcm" not in f
-0000f120: 2061 6e64 2022 2e66 6974 7322 2069 6e20   and ".fits" in 
-0000f130: 665d 0a20 2020 2020 2020 2020 2020 2066  f].            f
-0000f140: 6f72 2066 6974 2069 6e20 7072 6576 5f66  or fit in prev_f
-0000f150: 6974 733a 0a20 2020 2020 2020 2020 2020  its:.           
-0000f160: 2020 2020 2066 6974 5f6e 616d 6520 3d20       fit_name = 
-0000f170: 6669 742e 7370 6c69 7428 222f 2229 5b2d  fit.split("/")[-
-0000f180: 315d 0a20 2020 2020 2020 2020 2020 2020  1].             
-0000f190: 2020 2066 6974 5f69 6e66 6f20 3d20 6669     fit_info = fi
-0000f1a0: 745f 6e61 6d65 2e73 706c 6974 2822 5f22  t_name.split("_"
-0000f1b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000f1c0: 2020 7374 6f72 6167 655f 6b65 7920 3d20    storage_key = 
-0000f1d0: 225f 222e 6a6f 696e 2866 6974 5f69 6e66  "_".join(fit_inf
-0000f1e0: 6f5b 313a 2d31 5d29 0a20 2020 2020 2020  o[1:-1]).       
-0000f1f0: 2020 2020 2020 2020 2023 204c 6f61 6420           # Load 
-0000f200: 696e 2074 6865 2072 6573 756c 7473 2074  in the results t
-0000f210: 6162 6c65 0a20 2020 2020 2020 2020 2020  able.           
-0000f220: 2020 2020 2066 6974 5f64 6174 6120 3d20       fit_data = 
-0000f230: 4649 5453 2866 6974 290a 0a20 2020 2020  FITS(fit)..     
-0000f240: 2020 2020 2020 2020 2020 2023 2054 6869             # Thi
-0000f250: 7320 6269 7420 6973 206c 6172 6765 6c79  s bit is largely
-0000f260: 2063 6f70 6965 6420 6672 6f6d 2078 7370   copied from xsp
-0000f270: 6563 2e70 792c 2073 6f72 7279 2066 6f72  ec.py, sorry for
-0000f280: 206d 7920 6c61 7a69 6e65 7373 0a20 2020   my laziness.   
-0000f290: 2020 2020 2020 2020 2020 2020 2067 6c6f               glo
-0000f2a0: 6261 6c5f 7265 7375 6c74 7320 3d20 6669  bal_results = fi
-0000f2b0: 745f 6461 7461 5b22 5245 5355 4c54 5322  t_data["RESULTS"
-0000f2c0: 5d5b 305d 0a20 2020 2020 2020 2020 2020  ][0].           
-0000f2d0: 2020 2020 206d 6f64 656c 203d 2067 6c6f       model = glo
-0000f2e0: 6261 6c5f 7265 7375 6c74 735b 224d 4f44  bal_results["MOD
-0000f2f0: 454c 225d 2e73 7472 6970 2822 2022 290a  EL"].strip(" ").
-0000f300: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f310: 2069 6620 225f 6964 656e 7422 2069 6e20   if "_ident" in 
-0000f320: 7374 6f72 6167 655f 6b65 793a 0a20 2020  storage_key:.   
-0000f330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f340: 2073 6574 5f69 642c 2061 6e6e 5f69 6420   set_id, ann_id 
-0000f350: 3d20 7374 6f72 6167 655f 6b65 792e 7370  = storage_key.sp
-0000f360: 6c69 7428 225f 6964 656e 7422 295b 2d31  lit("_ident")[-1
-0000f370: 5d2e 7370 6c69 7428 225f 2229 0a20 2020  ].split("_").   
-0000f380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f390: 2073 6574 5f69 6420 3d20 696e 7428 7365   set_id = int(se
-0000f3a0: 745f 6964 290a 2020 2020 2020 2020 2020  t_id).          
-0000f3b0: 2020 2020 2020 2020 2020 616e 6e5f 6964            ann_id
-0000f3c0: 203d 2069 6e74 2861 6e6e 5f69 6429 0a20   = int(ann_id). 
-0000f3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f3e0: 2020 2069 6620 7365 745f 6964 206e 6f74     if set_id not
-0000f3f0: 2069 6e20 616e 6e5f 7265 7375 6c74 733a   in ann_results:
-0000f400: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f410: 2020 2020 2020 2020 2061 6e6e 5f72 6573           ann_res
-0000f420: 756c 7473 5b73 6574 5f69 645d 203d 207b  ults[set_id] = {
-0000f430: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-0000f440: 2020 2020 2020 2020 2020 616e 6e5f 6c75            ann_lu
-0000f450: 6d73 5b73 6574 5f69 645d 203d 207b 7d0a  ms[set_id] = {}.
-0000f460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f470: 2020 2020 2020 2020 616e 6e5f 6f62 735f          ann_obs_
-0000f480: 6f72 6465 725b 7365 745f 6964 5d20 3d20  order[set_id] = 
-0000f490: 7b7d 0a0a 2020 2020 2020 2020 2020 2020  {}..            
-0000f4a0: 2020 2020 2020 2020 6966 206d 6f64 656c          if model
-0000f4b0: 206e 6f74 2069 6e20 616e 6e5f 7265 7375   not in ann_resu
-0000f4c0: 6c74 735b 7365 745f 6964 5d3a 0a20 2020  lts[set_id]:.   
-0000f4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f4e0: 2020 2020 2061 6e6e 5f72 6573 756c 7473       ann_results
-0000f4f0: 5b73 6574 5f69 645d 5b6d 6f64 656c 5d20  [set_id][model] 
-0000f500: 3d20 7b7d 0a20 2020 2020 2020 2020 2020  = {}.           
-0000f510: 2020 2020 2020 2020 2020 2020 2061 6e6e               ann
-0000f520: 5f6c 756d 735b 7365 745f 6964 5d5b 6d6f  _lums[set_id][mo
-0000f530: 6465 6c5d 203d 207b 7d0a 2020 2020 2020  del] = {}.      
-0000f540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f550: 2020 616e 6e5f 6f62 735f 6f72 6465 725b    ann_obs_order[
-0000f560: 7365 745f 6964 5d5b 6d6f 6465 6c5d 203d  set_id][model] =
-0000f570: 207b 7d0a 0a20 2020 2020 2020 2020 2020   {}..           
-0000f580: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0000f590: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0000f5a0: 6574 5f69 6420 3d20 4e6f 6e65 0a20 2020  et_id = None.   
-0000f5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f5c0: 2061 6e6e 5f69 6420 3d20 4e6f 6e65 0a0a   ann_id = None..
+0000e700: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+0000e710: 2020 2020 2020 2020 2020 2069 6620 616e             if an
+0000e720: 6e5f 7370 6563 5f75 7361 626c 655b 7365  n_spec_usable[se
+0000e730: 745f 6964 5d3a 0a20 2020 2020 2020 2020  t_id]:.         
+0000e740: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0000e750: 6e6e 5f73 7065 635f 6f62 6a20 3d20 416e  nn_spec_obj = An
+0000e760: 6e75 6c61 7253 7065 6374 7261 2861 6e6e  nularSpectra(ann
+0000e770: 5f73 7065 635f 636f 6e73 7469 7475 656e  _spec_constituen
+0000e780: 7473 5b73 6574 5f69 645d 290a 2020 2020  ts[set_id]).    
+0000e790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e7a0: 2020 2020 6966 2073 656c 662e 5f72 6564      if self._red
+0000e7b0: 7368 6966 7420 6973 206e 6f74 204e 6f6e  shift is not Non
+0000e7c0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0000e7d0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0000e7e0: 2049 6620 7765 206b 6e6f 7720 7468 6520   If we know the 
+0000e7f0: 7265 6473 6869 6674 2077 6520 7769 6c6c  redshift we will
+0000e800: 2061 6464 2074 6865 2072 6164 6969 2074   add the radii t
+0000e810: 6f20 7468 6520 616e 6e75 6c61 7220 7370  o the annular sp
+0000e820: 6563 7472 6120 696e 2070 726f 7065 720a  ectra in proper.
+0000e830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e840: 2020 2020 2020 2020 2020 2020 2320 2064              #  d
+0000e850: 6973 7461 6e63 6520 756e 6974 730a 2020  istance units.  
+0000e860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e870: 2020 2020 2020 2020 2020 616e 6e5f 7370            ann_sp
+0000e880: 6563 5f6f 626a 2e70 726f 7065 725f 7261  ec_obj.proper_ra
+0000e890: 6469 6920 3d20 7365 6c66 2e63 6f6e 7665  dii = self.conve
+0000e8a0: 7274 5f72 6164 6975 7328 616e 6e5f 7370  rt_radius(ann_sp
+0000e8b0: 6563 5f6f 626a 2e72 6164 6969 2c20 276b  ec_obj.radii, 'k
+0000e8c0: 7063 2729 0a20 2020 2020 2020 2020 2020  pc').           
+0000e8d0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0000e8e0: 662e 7570 6461 7465 5f70 726f 6475 6374  f.update_product
+0000e8f0: 7328 616e 6e5f 7370 6563 5f6f 626a 2c20  s(ann_spec_obj, 
+0000e900: 7570 6461 7465 5f69 6e76 3d46 616c 7365  update_inv=False
+0000e910: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000e920: 2020 6578 6365 7074 2041 7474 7269 6275    except Attribu
+0000e930: 7465 4572 726f 723a 0a20 2020 2020 2020  teError:.       
+0000e940: 2020 2020 2020 2020 2020 2020 2023 2054               # T
+0000e950: 6869 7320 7368 6f75 6c64 2068 6f70 6566  his should hopef
+0000e960: 756c 6c79 2061 6374 2074 6f20 6361 7463  ully act to catc
+0000e970: 6820 7468 6520 4e6f 6e65 5479 7065 2068  h the NoneType h
+0000e980: 6173 206e 6f20 6174 7472 6962 7574 6520  as no attribute 
+0000e990: 7072 6f62 6c65 6d73 2074 6861 7420 6861  problems that ha
+0000e9a0: 7665 2070 6c61 6775 6564 2074 6869 730a  ve plagued this.
+0000e9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e9c0: 2020 2020 2320 2063 6c61 7373 202d 2077      #  class - w
+0000e9d0: 6869 6c65 2049 2066 696e 6420 6120 6265  hile I find a be
+0000e9e0: 7474 6572 2067 656e 6572 616c 2073 6f6c  tter general sol
+0000e9f0: 7574 696f 6e20 7468 6174 2073 686f 756c  ution that shoul
+0000ea00: 6420 736f 6c76 6520 7468 6973 2070 726f  d solve this pro
+0000ea10: 7065 726c 790a 2020 2020 2020 2020 2020  perly.          
+0000ea20: 2020 2020 2020 2020 2020 7061 7373 0a0a            pass..
+0000ea30: 2020 2020 2020 2020 2320 4865 7265 2077          # Here w
+0000ea40: 6520 6c6f 6164 2069 6e20 616e 7920 636f  e load in any co
+0000ea50: 6d62 696e 6564 2069 6d61 6765 7320 616e  mbined images an
+0000ea60: 6420 6578 706f 7375 7265 206d 6170 7320  d exposure maps 
+0000ea70: 7468 6174 206d 6179 2068 6176 6520 6265  that may have be
+0000ea80: 656e 2067 656e 6572 6174 6564 0a20 2020  en generated.   
+0000ea90: 2020 2020 206f 732e 6368 6469 7228 4f55       os.chdir(OU
+0000eaa0: 5450 5554 202b 2027 636f 6d62 696e 6564  TPUT + 'combined
+0000eab0: 2729 0a20 2020 2020 2020 2063 7572 5f64  ').        cur_d
+0000eac0: 203d 206f 732e 6765 7463 7764 2829 202b   = os.getcwd() +
+0000ead0: 2027 2f27 0a20 2020 2020 2020 2023 2054   '/'.        # T
+0000eae0: 6869 7320 6372 6561 7465 7320 6120 7365  his creates a se
+0000eaf0: 7420 6f66 206f 6273 6572 7661 7469 6f6e  t of observation
+0000eb00: 2d69 6e73 7472 756d 656e 7420 7374 7269  -instrument stri
+0000eb10: 6e67 7320 7468 6174 2064 6573 6372 6962  ngs that describ
+0000eb20: 6520 7468 6520 6375 7272 656e 7420 636f  e the current co
+0000eb30: 6d62 696e 6174 696f 6e73 2061 7373 6f63  mbinations assoc
+0000eb40: 6961 7465 640a 2020 2020 2020 2020 2320  iated.        # 
+0000eb50: 2077 6974 6820 7468 6973 2073 6f75 7263   with this sourc
+0000eb60: 652c 2066 6f72 2074 6573 7469 6e67 2061  e, for testing a
+0000eb70: 6761 696e 7374 2074 6f20 6d61 6b65 2073  gainst to make s
+0000eb80: 7572 6520 7765 2772 6520 6c6f 6164 696e  ure we're loadin
+0000eb90: 6720 696e 2063 6f6d 6269 6e65 6420 696d  g in combined im
+0000eba0: 6167 6573 2f65 7870 6d61 7073 2074 6861  ages/expmaps tha
+0000ebb0: 740a 2020 2020 2020 2020 2320 2064 6f20  t.        #  do 
+0000ebc0: 6265 6c6f 6e67 2077 6974 6820 7468 6973  belong with this
+0000ebd0: 2073 6f75 7263 650a 2020 2020 2020 2020   source.        
+0000ebe0: 7372 635f 6f69 5f73 6574 203d 2073 6574  src_oi_set = set
+0000ebf0: 285b 6f2b 6920 666f 7220 6f20 696e 2073  ([o+i for o in s
+0000ec00: 656c 662e 5f69 6e73 7472 756d 656e 7473  elf._instruments
+0000ec10: 2066 6f72 2069 2069 6e20 7365 6c66 2e5f   for i in self._
+0000ec20: 696e 7374 7275 6d65 6e74 735b 6f5d 5d29  instruments[o]])
+0000ec30: 0a0a 2020 2020 2020 2020 2320 4c6f 6164  ..        # Load
+0000ec40: 7320 696e 2074 6865 2069 6e76 656e 746f  s in the invento
+0000ec50: 7279 2066 696c 6520 666f 7220 7468 6973  ry file for this
+0000ec60: 204f 6273 4944 0a20 2020 2020 2020 2069   ObsID.        i
+0000ec70: 6e76 656e 203d 2070 642e 7265 6164 5f63  nven = pd.read_c
+0000ec80: 7376 2822 696e 7665 6e74 6f72 792e 6373  sv("inventory.cs
+0000ec90: 7622 2c20 6474 7970 653d 7374 7229 0a20  v", dtype=str). 
+0000eca0: 2020 2020 2020 2072 656c 5f69 6e76 656e         rel_inven
+0000ecb0: 203d 2069 6e76 656e 5b28 696e 7665 6e5b   = inven[(inven[
+0000ecc0: 2774 7970 6527 5d20 3d3d 2027 696d 6167  'type'] == 'imag
+0000ecd0: 6527 2920 7c20 2869 6e76 656e 5b27 7479  e') | (inven['ty
+0000ece0: 7065 275d 203d 3d20 2765 7870 6d61 7027  pe'] == 'expmap'
+0000ecf0: 295d 0a20 2020 2020 2020 2066 6f72 2072  )].        for r
+0000ed00: 6f77 5f69 6e64 2c20 726f 7720 696e 2072  ow_ind, row in r
+0000ed10: 656c 5f69 6e76 656e 2e69 7465 7272 6f77  el_inven.iterrow
+0000ed20: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+0000ed30: 206f 5f73 706c 6974 203d 2072 6f77 5b27   o_split = row['
+0000ed40: 6f62 735f 6964 7327 5d2e 7370 6c69 7428  obs_ids'].split(
+0000ed50: 272f 2729 0a20 2020 2020 2020 2020 2020  '/').           
+0000ed60: 2069 5f73 706c 6974 203d 2072 6f77 5b27   i_split = row['
+0000ed70: 696e 7374 7327 5d2e 7370 6c69 7428 272f  insts'].split('/
+0000ed80: 2729 0a20 2020 2020 2020 2020 2020 2023  ').            #
+0000ed90: 2041 7373 656d 626c 6520 6120 7365 7420   Assemble a set 
+0000eda0: 6f66 206f 6273 6572 7661 7469 6f6e 732d  of observations-
+0000edb0: 696e 7374 7275 6d65 6e74 2073 7472 696e  instrument strin
+0000edc0: 6773 2066 6f72 2074 6865 2063 7572 7265  gs for the curre
+0000edd0: 6e74 2072 6f77 2c20 746f 2074 6573 7420  nt row, to test 
+0000ede0: 6167 6169 6e73 7420 7468 650a 2020 2020  against the.    
+0000edf0: 2020 2020 2020 2020 2320 2073 7263 5f6f          #  src_o
+0000ee00: 695f 7365 7420 7765 2061 7373 656d 626c  i_set we assembl
+0000ee10: 6564 2065 6172 6c69 6572 0a20 2020 2020  ed earlier.     
+0000ee20: 2020 2020 2020 2074 6573 745f 6f69 5f73         test_oi_s
+0000ee30: 6574 203d 2073 6574 285b 6f2b 695f 7370  et = set([o+i_sp
+0000ee40: 6c69 745b 6f5f 696e 645d 2066 6f72 206f  lit[o_ind] for o
+0000ee50: 5f69 6e64 2c20 6f20 696e 2065 6e75 6d65  _ind, o in enume
+0000ee60: 7261 7465 286f 5f73 706c 6974 295d 290a  rate(o_split)]).
+0000ee70: 2020 2020 2020 2020 2020 2020 2320 4669              # Fi
+0000ee80: 7273 7420 7765 206d 616b 6520 7375 7265  rst we make sure
+0000ee90: 2074 6865 2073 6574 7320 6172 6520 7468   the sets are th
+0000eea0: 6520 7361 6d65 206c 656e 6774 682c 2069  e same length, i
+0000eeb0: 6620 7468 6579 2772 6520 6e6f 7420 7468  f they're not th
+0000eec0: 656e 2077 6520 6b6e 6f77 2062 6566 6f72  en we know befor
+0000eed0: 6520 7374 6172 7469 6e67 2074 6861 7420  e starting that 
+0000eee0: 7468 6973 0a20 2020 2020 2020 2020 2020  this.           
+0000eef0: 2023 2020 726f 7727 7320 6669 6c65 2063   #  row's file c
+0000ef00: 616e 2774 2062 6520 6f6b 6179 2066 6f72  an't be okay for
+0000ef10: 2075 7320 746f 206c 6f61 6420 696e 2e20   us to load in. 
+0000ef20: 5468 656e 2077 6520 636f 6d70 7574 6520  Then we compute 
+0000ef30: 7468 6520 756e 696f 6e20 6265 7477 6565  the union betwee
+0000ef40: 6e20 7468 6520 7465 7374 5f6f 695f 7365  n the test_oi_se
+0000ef50: 7420 616e 640a 2020 2020 2020 2020 2020  t and.          
+0000ef60: 2020 2320 2074 6865 2073 7263 5f6f 695f    #  the src_oi_
+0000ef70: 7365 742c 2061 6e64 2069 6620 7468 6174  set, and if that
+0000ef80: 2069 7320 7468 6520 7361 6d65 206c 656e   is the same len
+0000ef90: 6774 6820 6173 2074 6865 206f 7269 6769  gth as the origi
+0000efa0: 6e61 6c20 7372 635f 6f69 5f73 6574 2074  nal src_oi_set t
+0000efb0: 6865 6e20 7765 206b 6e6f 7720 7468 6174  hen we know that
+0000efc0: 2074 6865 7920 6d61 7463 680a 2020 2020   they match.    
+0000efd0: 2020 2020 2020 2020 2320 2065 7861 6374          #  exact
+0000efe0: 6c79 2061 6e64 2074 6865 2070 726f 6475  ly and the produ
+0000eff0: 6374 2063 616e 2062 6520 6c6f 6164 6564  ct can be loaded
+0000f000: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0000f010: 6c65 6e28 7372 635f 6f69 5f73 6574 2920  len(src_oi_set) 
+0000f020: 3d3d 206c 656e 2874 6573 745f 6f69 5f73  == len(test_oi_s
+0000f030: 6574 2920 616e 6420 6c65 6e28 7372 635f  et) and len(src_
+0000f040: 6f69 5f73 6574 207c 2074 6573 745f 6f69  oi_set | test_oi
+0000f050: 5f73 6574 2920 3d3d 206c 656e 2873 7263  _set) == len(src
+0000f060: 5f6f 695f 7365 7429 3a0a 2020 2020 2020  _oi_set):.      
+0000f070: 2020 2020 2020 2020 2020 7365 6c66 2e75            self.u
+0000f080: 7064 6174 655f 7072 6f64 7563 7473 2870  pdate_products(p
+0000f090: 6172 7365 5f69 6d61 6765 5f6c 696b 6528  arse_image_like(
+0000f0a0: 6375 725f 642b 726f 775b 2766 696c 655f  cur_d+row['file_
+0000f0b0: 6e61 6d65 275d 2c20 726f 775b 2774 7970  name'], row['typ
+0000f0c0: 6527 5d2c 206d 6572 6765 643d 5472 7565  e'], merged=True
+0000f0d0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+0000f0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f0f0: 2020 2020 2020 2020 7570 6461 7465 5f69          update_i
+0000f100: 6e76 3d46 616c 7365 290a 0a20 2020 2020  nv=False)..     
+0000f110: 2020 206f 732e 6368 6469 7228 6f67 5f64     os.chdir(og_d
+0000f120: 6972 290a 0a20 2020 2020 2020 2023 204e  ir)..        # N
+0000f130: 6f77 206c 6f61 6469 6e67 2069 6e20 7072  ow loading in pr
+0000f140: 6576 696f 7573 2066 6974 730a 2020 2020  evious fits.    
+0000f150: 2020 2020 6966 206f 732e 7061 7468 2e65      if os.path.e
+0000f160: 7869 7374 7328 4f55 5450 5554 202b 2022  xists(OUTPUT + "
+0000f170: 5853 5045 432f 2220 2b20 7365 6c66 2e6e  XSPEC/" + self.n
+0000f180: 616d 6529 2061 6e64 2072 6561 645f 6669  ame) and read_fi
+0000f190: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
+0000f1a0: 616e 6e5f 6f62 735f 6f72 6465 7220 3d20  ann_obs_order = 
+0000f1b0: 7b7d 0a20 2020 2020 2020 2020 2020 2061  {}.            a
+0000f1c0: 6e6e 5f72 6573 756c 7473 203d 207b 7d0a  nn_results = {}.
+0000f1d0: 2020 2020 2020 2020 2020 2020 616e 6e5f              ann_
+0000f1e0: 6c75 6d73 203d 207b 7d0a 2020 2020 2020  lums = {}.      
+0000f1f0: 2020 2020 2020 7072 6576 5f66 6974 7320        prev_fits 
+0000f200: 3d20 5b4f 5554 5055 5420 2b20 2258 5350  = [OUTPUT + "XSP
+0000f210: 4543 2f22 202b 2073 656c 662e 6e61 6d65  EC/" + self.name
+0000f220: 202b 2022 2f22 202b 2066 0a20 2020 2020   + "/" + f.     
+0000f230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f240: 2020 2020 666f 7220 6620 696e 206f 732e      for f in os.
+0000f250: 6c69 7374 6469 7228 4f55 5450 5554 202b  listdir(OUTPUT +
+0000f260: 2022 5853 5045 432f 2220 2b20 7365 6c66   "XSPEC/" + self
+0000f270: 2e6e 616d 6529 2069 6620 222e 7863 6d22  .name) if ".xcm"
+0000f280: 206e 6f74 2069 6e20 6620 616e 6420 222e   not in f and ".
+0000f290: 6669 7473 2220 696e 2066 5d0a 2020 2020  fits" in f].    
+0000f2a0: 2020 2020 2020 2020 666f 7220 6669 7420          for fit 
+0000f2b0: 696e 2070 7265 765f 6669 7473 3a0a 2020  in prev_fits:.  
+0000f2c0: 2020 2020 2020 2020 2020 2020 2020 6669                fi
+0000f2d0: 745f 6e61 6d65 203d 2066 6974 2e73 706c  t_name = fit.spl
+0000f2e0: 6974 2822 2f22 295b 2d31 5d0a 2020 2020  it("/")[-1].    
+0000f2f0: 2020 2020 2020 2020 2020 2020 6669 745f              fit_
+0000f300: 696e 666f 203d 2066 6974 5f6e 616d 652e  info = fit_name.
+0000f310: 7370 6c69 7428 225f 2229 0a20 2020 2020  split("_").     
+0000f320: 2020 2020 2020 2020 2020 2073 746f 7261             stora
+0000f330: 6765 5f6b 6579 203d 2022 5f22 2e6a 6f69  ge_key = "_".joi
+0000f340: 6e28 6669 745f 696e 666f 5b31 3a2d 315d  n(fit_info[1:-1]
+0000f350: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000f360: 2020 2320 4c6f 6164 2069 6e20 7468 6520    # Load in the 
+0000f370: 7265 7375 6c74 7320 7461 626c 650a 2020  results table.  
+0000f380: 2020 2020 2020 2020 2020 2020 2020 6669                fi
+0000f390: 745f 6461 7461 203d 2046 4954 5328 6669  t_data = FITS(fi
+0000f3a0: 7429 0a0a 2020 2020 2020 2020 2020 2020  t)..            
+0000f3b0: 2020 2020 2320 5468 6973 2062 6974 2069      # This bit i
+0000f3c0: 7320 6c61 7267 656c 7920 636f 7069 6564  s largely copied
+0000f3d0: 2066 726f 6d20 7873 7065 632e 7079 2c20   from xspec.py, 
+0000f3e0: 736f 7272 7920 666f 7220 6d79 206c 617a  sorry for my laz
+0000f3f0: 696e 6573 730a 2020 2020 2020 2020 2020  iness.          
+0000f400: 2020 2020 2020 676c 6f62 616c 5f72 6573        global_res
+0000f410: 756c 7473 203d 2066 6974 5f64 6174 615b  ults = fit_data[
+0000f420: 2252 4553 554c 5453 225d 5b30 5d0a 2020  "RESULTS"][0].  
+0000f430: 2020 2020 2020 2020 2020 2020 2020 6d6f                mo
+0000f440: 6465 6c20 3d20 676c 6f62 616c 5f72 6573  del = global_res
+0000f450: 756c 7473 5b22 4d4f 4445 4c22 5d2e 7374  ults["MODEL"].st
+0000f460: 7269 7028 2220 2229 0a0a 2020 2020 2020  rip(" ")..      
+0000f470: 2020 2020 2020 2020 2020 6966 2022 5f69            if "_i
+0000f480: 6465 6e74 2220 696e 2073 746f 7261 6765  dent" in storage
+0000f490: 5f6b 6579 3a0a 2020 2020 2020 2020 2020  _key:.          
+0000f4a0: 2020 2020 2020 2020 2020 7365 745f 6964            set_id
+0000f4b0: 2c20 616e 6e5f 6964 203d 2073 746f 7261  , ann_id = stora
+0000f4c0: 6765 5f6b 6579 2e73 706c 6974 2822 5f69  ge_key.split("_i
+0000f4d0: 6465 6e74 2229 5b2d 315d 2e73 706c 6974  dent")[-1].split
+0000f4e0: 2822 5f22 290a 2020 2020 2020 2020 2020  ("_").          
+0000f4f0: 2020 2020 2020 2020 2020 7365 745f 6964            set_id
+0000f500: 203d 2069 6e74 2873 6574 5f69 6429 0a20   = int(set_id). 
+0000f510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f520: 2020 2061 6e6e 5f69 6420 3d20 696e 7428     ann_id = int(
+0000f530: 616e 6e5f 6964 290a 2020 2020 2020 2020  ann_id).        
+0000f540: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+0000f550: 6574 5f69 6420 6e6f 7420 696e 2061 6e6e  et_id not in ann
+0000f560: 5f72 6573 756c 7473 3a0a 2020 2020 2020  _results:.      
+0000f570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f580: 2020 616e 6e5f 7265 7375 6c74 735b 7365    ann_results[se
+0000f590: 745f 6964 5d20 3d20 7b7d 0a20 2020 2020  t_id] = {}.     
+0000f5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f5b0: 2020 2061 6e6e 5f6c 756d 735b 7365 745f     ann_lums[set_
+0000f5c0: 6964 5d20 3d20 7b7d 0a20 2020 2020 2020  id] = {}.       
 0000f5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f5e0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-0000f5f0: 2020 2020 2020 2020 2069 6e73 745f 6c75           inst_lu
-0000f600: 6d73 203d 207b 7d0a 2020 2020 2020 2020  ms = {}.        
-0000f610: 2020 2020 2020 2020 2020 2020 6f62 735f              obs_
-0000f620: 6f72 6465 7220 3d20 5b5d 0a20 2020 2020  order = [].     
-0000f630: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0000f640: 6f72 206c 696e 655f 696e 642c 206c 696e  or line_ind, lin
-0000f650: 6520 696e 2065 6e75 6d65 7261 7465 2866  e in enumerate(f
-0000f660: 6974 5f64 6174 615b 2253 5045 435f 494e  it_data["SPEC_IN
-0000f670: 464f 225d 293a 0a20 2020 2020 2020 2020  FO"]):.         
-0000f680: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0000f690: 705f 696e 666f 203d 206c 696e 655b 2253  p_info = line["S
-0000f6a0: 5045 435f 5041 5448 225d 2e73 7472 6970  PEC_PATH"].strip
-0000f6b0: 2822 2022 292e 7370 6c69 7428 222f 2229  (" ").split("/")
-0000f6c0: 5b2d 315d 2e73 706c 6974 2822 5f22 290a  [-1].split("_").
-0000f6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f6e0: 2020 2020 2020 2020 2320 5761 6e74 2074          # Want t
-0000f6f0: 6f20 6465 7269 7665 2074 6865 2073 7065  o derive the spe
-0000f700: 6374 7261 2073 746f 7261 6765 206b 6579  ctra storage key
-0000f710: 2066 726f 6d20 7468 6520 6669 6c65 206e   from the file n
-0000f720: 616d 652c 2074 6869 7320 7374 7269 7073  ame, this strips
-0000f730: 206f 6666 2073 6f6d 650a 2020 2020 2020   off some.      
-0000f740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f750: 2020 2320 2075 6e6e 6563 6573 7361 7279    #  unnecessary
-0000f760: 2069 6e66 6f0a 2020 2020 2020 2020 2020   info.          
-0000f770: 2020 2020 2020 2020 2020 2020 2020 7370                sp
-0000f780: 5f6b 6579 203d 206c 696e 655b 2253 5045  _key = line["SPE
-0000f790: 435f 5041 5448 225d 2e73 7472 6970 2822  C_PATH"].strip("
-0000f7a0: 2022 292e 7370 6c69 7428 222f 2229 5b2d   ").split("/")[-
-0000f7b0: 315d 2e73 706c 6974 2827 7261 2729 5b2d  1].split('ra')[-
-0000f7c0: 315d 2e73 706c 6974 2827 5f73 7065 632e  1].split('_spec.
-0000f7d0: 6669 7473 2729 5b30 5d0a 0a20 2020 2020  fits')[0]..     
+0000f5e0: 2061 6e6e 5f6f 6273 5f6f 7264 6572 5b73   ann_obs_order[s
+0000f5f0: 6574 5f69 645d 203d 207b 7d0a 0a20 2020  et_id] = {}..   
+0000f600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f610: 2069 6620 6d6f 6465 6c20 6e6f 7420 696e   if model not in
+0000f620: 2061 6e6e 5f72 6573 756c 7473 5b73 6574   ann_results[set
+0000f630: 5f69 645d 3a0a 2020 2020 2020 2020 2020  _id]:.          
+0000f640: 2020 2020 2020 2020 2020 2020 2020 616e                an
+0000f650: 6e5f 7265 7375 6c74 735b 7365 745f 6964  n_results[set_id
+0000f660: 5d5b 6d6f 6465 6c5d 203d 207b 7d0a 2020  ][model] = {}.  
+0000f670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f680: 2020 2020 2020 616e 6e5f 6c75 6d73 5b73        ann_lums[s
+0000f690: 6574 5f69 645d 5b6d 6f64 656c 5d20 3d20  et_id][model] = 
+0000f6a0: 7b7d 0a20 2020 2020 2020 2020 2020 2020  {}.             
+0000f6b0: 2020 2020 2020 2020 2020 2061 6e6e 5f6f             ann_o
+0000f6c0: 6273 5f6f 7264 6572 5b73 6574 5f69 645d  bs_order[set_id]
+0000f6d0: 5b6d 6f64 656c 5d20 3d20 7b7d 0a0a 2020  [model] = {}..  
+0000f6e0: 2020 2020 2020 2020 2020 2020 2020 656c                el
+0000f6f0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0000f700: 2020 2020 2020 2020 7365 745f 6964 203d          set_id =
+0000f710: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
+0000f720: 2020 2020 2020 2020 2020 616e 6e5f 6964            ann_id
+0000f730: 203d 204e 6f6e 650a 0a20 2020 2020 2020   = None..       
+0000f740: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+0000f750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f760: 2020 696e 7374 5f6c 756d 7320 3d20 7b7d    inst_lums = {}
+0000f770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f780: 2020 2020 206f 6273 5f6f 7264 6572 203d       obs_order =
+0000f790: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
+0000f7a0: 2020 2020 2020 2020 666f 7220 6c69 6e65          for line
+0000f7b0: 5f69 6e64 2c20 6c69 6e65 2069 6e20 656e  _ind, line in en
+0000f7c0: 756d 6572 6174 6528 6669 745f 6461 7461  umerate(fit_data
+0000f7d0: 5b22 5350 4543 5f49 4e46 4f22 5d29 3a0a  ["SPEC_INFO"]):.
 0000f7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f7f0: 2020 2023 2049 6620 6974 7320 6e6f 7420     # If its not 
-0000f800: 616e 2041 6e6e 756c 6172 5370 6563 7472  an AnnularSpectr
-0000f810: 6120 6669 7420 7468 656e 2077 6520 6361  a fit then we ca
-0000f820: 6e20 6a75 7374 2066 6574 6368 2074 6865  n just fetch the
-0000f830: 2073 7065 6374 7275 6d20 6672 6f6d 2074   spectrum from t
-0000f840: 6865 2073 6f75 7263 650a 2020 2020 2020  he source.      
-0000f850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f860: 2020 2320 2074 6865 206e 6f72 6d61 6c20    #  the normal 
-0000f870: 7761 790a 2020 2020 2020 2020 2020 2020  way.            
-0000f880: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-0000f890: 6574 5f69 6420 6973 204e 6f6e 653a 0a20  et_id is None:. 
-0000f8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f8b0: 2020 2020 2020 2020 2020 2023 2054 6869             # Thi
-0000f8c0: 7320 6164 6473 2072 6120 6261 636b 206f  s adds ra back o
-0000f8d0: 6e2c 2061 6e64 2072 656d 6f76 6573 2061  n, and removes a
-0000f8e0: 6e79 2069 6465 6e74 2069 6e66 6f72 6d61  ny ident informa
-0000f8f0: 7469 6f6e 2069 6620 6974 2069 7320 7468  tion if it is th
-0000f900: 6572 650a 2020 2020 2020 2020 2020 2020  ere.            
-0000f910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f920: 7370 5f6b 6579 203d 2027 7261 2720 2b20  sp_key = 'ra' + 
-0000f930: 7370 5f6b 6579 0a20 2020 2020 2020 2020  sp_key.         
-0000f940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f950: 2020 2023 2046 696e 6473 2074 6865 2061     # Finds the a
-0000f960: 7070 726f 7072 6961 7465 206d 6174 6368  ppropriate match
-0000f970: 696e 6720 7370 6563 7472 756d 206f 626a  ing spectrum obj
-0000f980: 6563 7420 666f 7220 7468 6520 6375 7272  ect for the curr
-0000f990: 656e 7420 7461 626c 6520 6c69 6e65 0a20  ent table line. 
-0000f9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f9b0: 2020 2020 2020 2020 2020 2073 7065 6320             spec 
-0000f9c0: 3d20 7365 6c66 2e67 6574 5f70 726f 6475  = self.get_produ
-0000f9d0: 6374 7328 2273 7065 6374 7275 6d22 2c20  cts("spectrum", 
-0000f9e0: 7370 5f69 6e66 6f5b 305d 2c20 7370 5f69  sp_info[0], sp_i
-0000f9f0: 6e66 6f5b 315d 2c20 6578 7472 615f 6b65  nfo[1], extra_ke
-0000fa00: 793d 7370 5f6b 6579 295b 305d 0a20 2020  y=sp_key)[0].   
+0000f7f0: 2020 2020 2020 2020 7370 5f69 6e66 6f20          sp_info 
+0000f800: 3d20 6c69 6e65 5b22 5350 4543 5f50 4154  = line["SPEC_PAT
+0000f810: 4822 5d2e 7374 7269 7028 2220 2229 2e73  H"].strip(" ").s
+0000f820: 706c 6974 2822 2f22 295b 2d31 5d2e 7370  plit("/")[-1].sp
+0000f830: 6c69 7428 225f 2229 0a20 2020 2020 2020  lit("_").       
+0000f840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f850: 2023 2057 616e 7420 746f 2064 6572 6976   # Want to deriv
+0000f860: 6520 7468 6520 7370 6563 7472 6120 7374  e the spectra st
+0000f870: 6f72 6167 6520 6b65 7920 6672 6f6d 2074  orage key from t
+0000f880: 6865 2066 696c 6520 6e61 6d65 2c20 7468  he file name, th
+0000f890: 6973 2073 7472 6970 7320 6f66 6620 736f  is strips off so
+0000f8a0: 6d65 0a20 2020 2020 2020 2020 2020 2020  me.             
+0000f8b0: 2020 2020 2020 2020 2020 2023 2020 756e             #  un
+0000f8c0: 6e65 6365 7373 6172 7920 696e 666f 0a20  necessary info. 
+0000f8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f8e0: 2020 2020 2020 2073 705f 6b65 7920 3d20         sp_key = 
+0000f8f0: 6c69 6e65 5b22 5350 4543 5f50 4154 4822  line["SPEC_PATH"
+0000f900: 5d2e 7374 7269 7028 2220 2229 2e73 706c  ].strip(" ").spl
+0000f910: 6974 2822 2f22 295b 2d31 5d2e 7370 6c69  it("/")[-1].spli
+0000f920: 7428 2772 6127 295b 2d31 5d2e 7370 6c69  t('ra')[-1].spli
+0000f930: 7428 275f 7370 6563 2e66 6974 7327 295b  t('_spec.fits')[
+0000f940: 305d 0a0a 2020 2020 2020 2020 2020 2020  0]..            
+0000f950: 2020 2020 2020 2020 2020 2020 2320 4966              # If
+0000f960: 2069 7473 206e 6f74 2061 6e20 416e 6e75   its not an Annu
+0000f970: 6c61 7253 7065 6374 7261 2066 6974 2074  larSpectra fit t
+0000f980: 6865 6e20 7765 2063 616e 206a 7573 7420  hen we can just 
+0000f990: 6665 7463 6820 7468 6520 7370 6563 7472  fetch the spectr
+0000f9a0: 756d 2066 726f 6d20 7468 6520 736f 7572  um from the sour
+0000f9b0: 6365 0a20 2020 2020 2020 2020 2020 2020  ce.             
+0000f9c0: 2020 2020 2020 2020 2020 2023 2020 7468             #  th
+0000f9d0: 6520 6e6f 726d 616c 2077 6179 0a20 2020  e normal way.   
+0000f9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f9f0: 2020 2020 2069 6620 7365 745f 6964 2069       if set_id i
+0000fa00: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
 0000fa10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fa20: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0000fa30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fa40: 2020 2020 2020 2073 705f 6b65 7920 3d20         sp_key = 
-0000fa50: 2772 6127 202b 2073 705f 6b65 792e 7370  'ra' + sp_key.sp
-0000fa60: 6c69 7428 275f 6964 656e 7427 295b 305d  lit('_ident')[0]
-0000fa70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000fa80: 2020 2020 2020 2020 2020 2020 2061 6e6e               ann
-0000fa90: 5f73 7065 6320 3d20 7365 6c66 2e67 6574  _spec = self.get
-0000faa0: 5f61 6e6e 756c 6172 5f73 7065 6374 7261  _annular_spectra
-0000fab0: 2873 6574 5f69 643d 7365 745f 6964 290a  (set_id=set_id).
-0000fac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fad0: 2020 2020 2020 2020 2020 2020 7370 6563              spec
-0000fae0: 203d 2061 6e6e 5f73 7065 632e 6765 745f   = ann_spec.get_
-0000faf0: 7370 6563 7472 6128 616e 6e5f 6964 2c20  spectra(ann_id, 
-0000fb00: 7370 5f69 6e66 6f5b 305d 2c20 7370 5f69  sp_info[0], sp_i
-0000fb10: 6e66 6f5b 315d 290a 2020 2020 2020 2020  nfo[1]).        
-0000fb20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fb30: 2020 2020 6f62 735f 6f72 6465 722e 6170      obs_order.ap
-0000fb40: 7065 6e64 285b 7370 5f69 6e66 6f5b 305d  pend([sp_info[0]
-0000fb50: 2c20 7370 5f69 6e66 6f5b 315d 5d29 0a0a  , sp_info[1]])..
-0000fb60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fb70: 2020 2020 2020 2020 2320 4164 6473 2069          # Adds i
-0000fb80: 6e66 6f72 6d61 7469 6f6e 2066 726f 6d20  nformation from 
-0000fb90: 7468 6973 2066 6974 2074 6f20 7468 6520  this fit to the 
-0000fba0: 7370 6563 7472 756d 206f 626a 6563 742e  spectrum object.
-0000fbb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000fbc0: 2020 2020 2020 2020 2073 7065 632e 6164           spec.ad
-0000fbd0: 645f 6669 745f 6461 7461 2873 7472 286d  d_fit_data(str(m
-0000fbe0: 6f64 656c 292c 206c 696e 652c 2066 6974  odel), line, fit
-0000fbf0: 5f64 6174 615b 2250 4c4f 5422 2b73 7472  _data["PLOT"+str
-0000fc00: 286c 696e 655f 696e 642b 3129 5d29 0a0a  (line_ind+1)])..
-0000fc10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fc20: 2020 2020 2020 2020 2320 5468 6520 6164          # The ad
-0000fc30: 645f 6669 745f 6461 7461 206d 6574 686f  d_fit_data metho
-0000fc40: 6420 666f 726d 6174 7320 7468 6520 6c75  d formats the lu
-0000fc50: 6d69 6e6f 7369 7469 6573 206e 6963 656c  minosities nicel
-0000fc60: 792c 2073 6f20 7765 2067 7261 6220 7468  y, so we grab th
-0000fc70: 656d 2062 6163 6b20 6f75 740a 2020 2020  em back out.    
-0000fc80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fc90: 2020 2020 2320 2074 6f20 6865 6c70 2067      #  to help g
-0000fca0: 7261 6220 7468 6520 6c75 6d69 6e6f 7369  rab the luminosi
-0000fcb0: 7479 206e 6565 6465 6420 746f 2070 6173  ty needed to pas
-0000fcc0: 7320 746f 2074 6865 2073 6f75 7263 6520  s to the source 
-0000fcd0: 6f62 6a65 6374 2027 6164 645f 6669 745f  object 'add_fit_
-0000fce0: 6461 7461 2720 6d65 7468 6f64 0a20 2020  data' method.   
-0000fcf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fd00: 2020 2020 2070 726f 6365 7373 6564 5f6c       processed_l
-0000fd10: 756d 7320 3d20 7370 6563 2e67 6574 5f6c  ums = spec.get_l
-0000fd20: 756d 696e 6f73 6974 6965 7328 6d6f 6465  uminosities(mode
-0000fd30: 6c29 0a20 2020 2020 2020 2020 2020 2020  l).             
-0000fd40: 2020 2020 2020 2020 2020 2069 6620 7370             if sp
-0000fd50: 6563 2e69 6e73 7472 756d 656e 7420 6e6f  ec.instrument no
-0000fd60: 7420 696e 2069 6e73 745f 6c75 6d73 3a0a  t in inst_lums:.
-0000fd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fd80: 2020 2020 2020 2020 2020 2020 696e 7374              inst
-0000fd90: 5f6c 756d 735b 7370 6563 2e69 6e73 7472  _lums[spec.instr
-0000fda0: 756d 656e 745d 203d 2070 726f 6365 7373  ument] = process
-0000fdb0: 6564 5f6c 756d 730a 0a20 2020 2020 2020  ed_lums..       
-0000fdc0: 2020 2020 2020 2020 2020 2020 2023 2049               # I
-0000fdd0: 6465 616c 6c79 2074 6865 206c 756d 696e  deally the lumin
-0000fde0: 6f73 6974 7920 7265 706f 7274 6564 2069  osity reported i
-0000fdf0: 6e20 7468 6520 736f 7572 6365 206f 626a  n the source obj
-0000fe00: 6563 7420 7769 6c6c 2062 6520 6120 504e  ect will be a PN
-0000fe10: 206c 756d 2c20 6275 7420 6974 7320 6e6f   lum, but its no
-0000fe20: 7420 696d 706f 7373 6962 6c65 0a20 2020  t impossible.   
-0000fe30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fe40: 2023 2020 7468 6174 2061 2050 4e20 7661   #  that a PN va
-0000fe50: 6c75 6520 776f 6e27 7420 6265 2061 7661  lue won't be ava
-0000fe60: 696c 6162 6c65 2e20 2d20 6974 2073 686f  ilable. - it sho
-0000fe70: 756c 646e 2774 206d 6174 7465 7220 6d75  uldn't matter mu
-0000fe80: 6368 2c20 6c75 6d73 2061 6372 6f73 7320  ch, lums across 
-0000fe90: 7468 6520 6361 6d65 7261 7320 6172 650a  the cameras are.
+0000fa20: 2020 2020 2320 5468 6973 2061 6464 7320      # This adds 
+0000fa30: 7261 2062 6163 6b20 6f6e 2c20 616e 6420  ra back on, and 
+0000fa40: 7265 6d6f 7665 7320 616e 7920 6964 656e  removes any iden
+0000fa50: 7420 696e 666f 726d 6174 696f 6e20 6966  t information if
+0000fa60: 2069 7420 6973 2074 6865 7265 0a20 2020   it is there.   
+0000fa70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fa80: 2020 2020 2020 2020 2073 705f 6b65 7920           sp_key 
+0000fa90: 3d20 2772 6127 202b 2073 705f 6b65 790a  = 'ra' + sp_key.
+0000faa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fab0: 2020 2020 2020 2020 2020 2020 2320 4669              # Fi
+0000fac0: 6e64 7320 7468 6520 6170 7072 6f70 7269  nds the appropri
+0000fad0: 6174 6520 6d61 7463 6869 6e67 2073 7065  ate matching spe
+0000fae0: 6374 7275 6d20 6f62 6a65 6374 2066 6f72  ctrum object for
+0000faf0: 2074 6865 2063 7572 7265 6e74 2074 6162   the current tab
+0000fb00: 6c65 206c 696e 650a 2020 2020 2020 2020  le line.        
+0000fb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fb20: 2020 2020 7370 6563 203d 2073 656c 662e      spec = self.
+0000fb30: 6765 745f 7072 6f64 7563 7473 2822 7370  get_products("sp
+0000fb40: 6563 7472 756d 222c 2073 705f 696e 666f  ectrum", sp_info
+0000fb50: 5b30 5d2c 2073 705f 696e 666f 5b31 5d2c  [0], sp_info[1],
+0000fb60: 2065 7874 7261 5f6b 6579 3d73 705f 6b65   extra_key=sp_ke
+0000fb70: 7929 5b30 5d0a 2020 2020 2020 2020 2020  y)[0].          
+0000fb80: 2020 2020 2020 2020 2020 2020 2020 656c                el
+0000fb90: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0000fba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fbb0: 7370 5f6b 6579 203d 2027 7261 2720 2b20  sp_key = 'ra' + 
+0000fbc0: 7370 5f6b 6579 2e73 706c 6974 2827 5f69  sp_key.split('_i
+0000fbd0: 6465 6e74 2729 5b30 5d0a 2020 2020 2020  dent')[0].      
+0000fbe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fbf0: 2020 2020 2020 616e 6e5f 7370 6563 203d        ann_spec =
+0000fc00: 2073 656c 662e 6765 745f 616e 6e75 6c61   self.get_annula
+0000fc10: 725f 7370 6563 7472 6128 7365 745f 6964  r_spectra(set_id
+0000fc20: 3d73 6574 5f69 6429 0a20 2020 2020 2020  =set_id).       
+0000fc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fc40: 2020 2020 2073 7065 6320 3d20 616e 6e5f       spec = ann_
+0000fc50: 7370 6563 2e67 6574 5f73 7065 6374 7261  spec.get_spectra
+0000fc60: 2861 6e6e 5f69 642c 2073 705f 696e 666f  (ann_id, sp_info
+0000fc70: 5b30 5d2c 2073 705f 696e 666f 5b31 5d29  [0], sp_info[1])
+0000fc80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000fc90: 2020 2020 2020 2020 2020 2020 206f 6273               obs
+0000fca0: 5f6f 7264 6572 2e61 7070 656e 6428 5b73  _order.append([s
+0000fcb0: 705f 696e 666f 5b30 5d2c 2073 705f 696e  p_info[0], sp_in
+0000fcc0: 666f 5b31 5d5d 290a 0a20 2020 2020 2020  fo[1]])..       
+0000fcd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fce0: 2023 2041 6464 7320 696e 666f 726d 6174   # Adds informat
+0000fcf0: 696f 6e20 6672 6f6d 2074 6869 7320 6669  ion from this fi
+0000fd00: 7420 746f 2074 6865 2073 7065 6374 7275  t to the spectru
+0000fd10: 6d20 6f62 6a65 6374 2e0a 2020 2020 2020  m object..      
+0000fd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fd30: 2020 7370 6563 2e61 6464 5f66 6974 5f64    spec.add_fit_d
+0000fd40: 6174 6128 7374 7228 6d6f 6465 6c29 2c20  ata(str(model), 
+0000fd50: 6c69 6e65 2c20 6669 745f 6461 7461 5b22  line, fit_data["
+0000fd60: 504c 4f54 222b 7374 7228 6c69 6e65 5f69  PLOT"+str(line_i
+0000fd70: 6e64 2b31 295d 290a 0a20 2020 2020 2020  nd+1)])..       
+0000fd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fd90: 2023 2054 6865 2061 6464 5f66 6974 5f64   # The add_fit_d
+0000fda0: 6174 6120 6d65 7468 6f64 2066 6f72 6d61  ata method forma
+0000fdb0: 7473 2074 6865 206c 756d 696e 6f73 6974  ts the luminosit
+0000fdc0: 6965 7320 6e69 6365 6c79 2c20 736f 2077  ies nicely, so w
+0000fdd0: 6520 6772 6162 2074 6865 6d20 6261 636b  e grab them back
+0000fde0: 206f 7574 0a20 2020 2020 2020 2020 2020   out.           
+0000fdf0: 2020 2020 2020 2020 2020 2020 2023 2020               #  
+0000fe00: 746f 2068 656c 7020 6772 6162 2074 6865  to help grab the
+0000fe10: 206c 756d 696e 6f73 6974 7920 6e65 6564   luminosity need
+0000fe20: 6564 2074 6f20 7061 7373 2074 6f20 7468  ed to pass to th
+0000fe30: 6520 736f 7572 6365 206f 626a 6563 7420  e source object 
+0000fe40: 2761 6464 5f66 6974 5f64 6174 6127 206d  'add_fit_data' m
+0000fe50: 6574 686f 640a 2020 2020 2020 2020 2020  ethod.          
+0000fe60: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+0000fe70: 6f63 6573 7365 645f 6c75 6d73 203d 2073  ocessed_lums = s
+0000fe80: 7065 632e 6765 745f 6c75 6d69 6e6f 7369  pec.get_luminosi
+0000fe90: 7469 6573 286d 6f64 656c 290a 2020 2020  ties(model).    
 0000fea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000feb0: 2020 2020 2320 2063 6f6e 7369 7374 656e      #  consisten
-0000fec0: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
-0000fed0: 2020 2020 2020 6966 2022 706e 2220 696e        if "pn" in
-0000fee0: 2069 6e73 745f 6c75 6d73 3a0a 2020 2020   inst_lums:.    
-0000fef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ff00: 2020 2020 6368 6f73 656e 5f6c 756d 7320      chosen_lums 
-0000ff10: 3d20 696e 7374 5f6c 756d 735b 2270 6e22  = inst_lums["pn"
-0000ff20: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0000ff30: 2020 2020 2020 2020 2020 2320 6d6f 7332            # mos2
-0000ff40: 2067 656e 6572 616c 6c79 2062 6574 7465   generally bette
-0000ff50: 7220 7468 616e 206d 6f73 312c 2061 7320  r than mos1, as 
-0000ff60: 6d6f 7331 2068 6173 2043 4344 2064 616d  mos1 has CCD dam
-0000ff70: 6167 6520 6166 7465 7220 6120 6365 7274  age after a cert
-0000ff80: 6169 6e20 706f 696e 7420 696e 2069 7473  ain point in its
-0000ff90: 206c 6966 650a 2020 2020 2020 2020 2020   life.          
-0000ffa0: 2020 2020 2020 2020 2020 656c 6966 2022            elif "
-0000ffb0: 6d6f 7332 2220 696e 2069 6e73 745f 6c75  mos2" in inst_lu
-0000ffc0: 6d73 3a0a 2020 2020 2020 2020 2020 2020  ms:.            
-0000ffd0: 2020 2020 2020 2020 2020 2020 6368 6f73              chos
-0000ffe0: 656e 5f6c 756d 7320 3d20 696e 7374 5f6c  en_lums = inst_l
-0000fff0: 756d 735b 226d 6f73 3222 5d0a 2020 2020  ums["mos2"].    
-00010000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010010: 656c 6966 2022 6d6f 7331 2220 696e 2069  elif "mos1" in i
-00010020: 6e73 745f 6c75 6d73 3a0a 2020 2020 2020  nst_lums:.      
-00010030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010040: 2020 6368 6f73 656e 5f6c 756d 7320 3d20    chosen_lums = 
-00010050: 696e 7374 5f6c 756d 735b 226d 6f73 3122  inst_lums["mos1"
-00010060: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00010070: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00010080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010090: 2020 2020 6368 6f73 656e 5f6c 756d 7320      chosen_lums 
-000100a0: 3d20 4e6f 6e65 0a0a 2020 2020 2020 2020  = None..        
-000100b0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-000100c0: 6574 5f69 6420 6973 206e 6f74 204e 6f6e  et_id is not Non
-000100d0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-000100e0: 2020 2020 2020 2020 2020 2061 6e6e 5f72             ann_r
-000100f0: 6573 756c 7473 5b73 6574 5f69 645d 5b6d  esults[set_id][m
-00010100: 6f64 656c 5d5b 7370 6563 2e61 6e6e 756c  odel][spec.annul
-00010110: 7573 5f69 6465 6e74 5d20 3d20 676c 6f62  us_ident] = glob
-00010120: 616c 5f72 6573 756c 7473 0a20 2020 2020  al_results.     
+0000feb0: 2020 2020 6966 2073 7065 632e 696e 7374      if spec.inst
+0000fec0: 7275 6d65 6e74 206e 6f74 2069 6e20 696e  rument not in in
+0000fed0: 7374 5f6c 756d 733a 0a20 2020 2020 2020  st_lums:.       
+0000fee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fef0: 2020 2020 2069 6e73 745f 6c75 6d73 5b73       inst_lums[s
+0000ff00: 7065 632e 696e 7374 7275 6d65 6e74 5d20  pec.instrument] 
+0000ff10: 3d20 7072 6f63 6573 7365 645f 6c75 6d73  = processed_lums
+0000ff20: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000ff30: 2020 2020 2020 2320 4964 6561 6c6c 7920        # Ideally 
+0000ff40: 7468 6520 6c75 6d69 6e6f 7369 7479 2072  the luminosity r
+0000ff50: 6570 6f72 7465 6420 696e 2074 6865 2073  eported in the s
+0000ff60: 6f75 7263 6520 6f62 6a65 6374 2077 696c  ource object wil
+0000ff70: 6c20 6265 2061 2050 4e20 6c75 6d2c 2062  l be a PN lum, b
+0000ff80: 7574 2069 7473 206e 6f74 2069 6d70 6f73  ut its not impos
+0000ff90: 7369 626c 650a 2020 2020 2020 2020 2020  sible.          
+0000ffa0: 2020 2020 2020 2020 2020 2320 2074 6861            #  tha
+0000ffb0: 7420 6120 504e 2076 616c 7565 2077 6f6e  t a PN value won
+0000ffc0: 2774 2062 6520 6176 6169 6c61 626c 652e  't be available.
+0000ffd0: 202d 2069 7420 7368 6f75 6c64 6e27 7420   - it shouldn't 
+0000ffe0: 6d61 7474 6572 206d 7563 682c 206c 756d  matter much, lum
+0000fff0: 7320 6163 726f 7373 2074 6865 2063 616d  s across the cam
+00010000: 6572 6173 2061 7265 0a20 2020 2020 2020  eras are.       
+00010010: 2020 2020 2020 2020 2020 2020 2023 2020               #  
+00010020: 636f 6e73 6973 7465 6e74 0a20 2020 2020  consistent.     
+00010030: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00010040: 6620 2270 6e22 2069 6e20 696e 7374 5f6c  f "pn" in inst_l
+00010050: 756d 733a 0a20 2020 2020 2020 2020 2020  ums:.           
+00010060: 2020 2020 2020 2020 2020 2020 2063 686f               cho
+00010070: 7365 6e5f 6c75 6d73 203d 2069 6e73 745f  sen_lums = inst_
+00010080: 6c75 6d73 5b22 706e 225d 0a20 2020 2020  lums["pn"].     
+00010090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000100a0: 2020 2023 206d 6f73 3220 6765 6e65 7261     # mos2 genera
+000100b0: 6c6c 7920 6265 7474 6572 2074 6861 6e20  lly better than 
+000100c0: 6d6f 7331 2c20 6173 206d 6f73 3120 6861  mos1, as mos1 ha
+000100d0: 7320 4343 4420 6461 6d61 6765 2061 6674  s CCD damage aft
+000100e0: 6572 2061 2063 6572 7461 696e 2070 6f69  er a certain poi
+000100f0: 6e74 2069 6e20 6974 7320 6c69 6665 0a20  nt in its life. 
+00010100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010110: 2020 2065 6c69 6620 226d 6f73 3222 2069     elif "mos2" i
+00010120: 6e20 696e 7374 5f6c 756d 733a 0a20 2020  n inst_lums:.   
 00010130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010140: 2020 2061 6e6e 5f6c 756d 735b 7365 745f     ann_lums[set_
-00010150: 6964 5d5b 6d6f 6465 6c5d 5b73 7065 632e  id][model][spec.
-00010160: 616e 6e75 6c75 735f 6964 656e 745d 203d  annulus_ident] =
-00010170: 2063 686f 7365 6e5f 6c75 6d73 0a20 2020   chosen_lums.   
-00010180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010190: 2020 2020 2061 6e6e 5f6f 6273 5f6f 7264       ann_obs_ord
-000101a0: 6572 5b73 6574 5f69 645d 5b6d 6f64 656c  er[set_id][model
-000101b0: 5d5b 7370 6563 2e61 6e6e 756c 7573 5f69  ][spec.annulus_i
-000101c0: 6465 6e74 5d20 3d20 6f62 735f 6f72 6465  dent] = obs_orde
-000101d0: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
-000101e0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-000101f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010200: 2020 2020 2320 5075 7368 2067 6c6f 6261      # Push globa
-00010210: 6c20 6669 7420 7265 7375 6c74 732c 206c  l fit results, l
-00010220: 756d 696e 6f73 6974 6965 7320 6574 632e  uminosities etc.
-00010230: 2069 6e74 6f20 7468 6520 636f 7272 6573   into the corres
-00010240: 706f 6e64 696e 6720 736f 7572 6365 206f  ponding source o
-00010250: 626a 6563 742e 0a20 2020 2020 2020 2020  bject..         
-00010260: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00010270: 656c 662e 6164 645f 6669 745f 6461 7461  elf.add_fit_data
-00010280: 286d 6f64 656c 2c20 676c 6f62 616c 5f72  (model, global_r
-00010290: 6573 756c 7473 2c20 6368 6f73 656e 5f6c  esults, chosen_l
-000102a0: 756d 732c 2073 705f 6b65 7929 0a20 2020  ums, sp_key).   
-000102b0: 2020 2020 2020 2020 2020 2020 2065 7863               exc
-000102c0: 6570 7420 284f 5345 7272 6f72 2c20 4e6f  ept (OSError, No
-000102d0: 5072 6f64 7563 7441 7661 696c 6162 6c65  ProductAvailable
-000102e0: 4572 726f 722c 2049 6e64 6578 4572 726f  Error, IndexErro
-000102f0: 722c 204e 6f74 4173 736f 6369 6174 6564  r, NotAssociated
-00010300: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
-00010310: 2020 2020 2020 2020 2020 2020 6368 6f73              chos
-00010320: 656e 5f6c 756d 7320 3d20 7b7d 0a20 2020  en_lums = {}.   
-00010330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010340: 2077 6172 6e5f 7465 7874 203d 2022 7b73   warn_text = "{s
-00010350: 7263 7d20 6669 7420 7b66 7d20 636f 756c  rc} fit {f} coul
-00010360: 6420 6e6f 7420 6265 206c 6f61 6465 6420  d not be loaded 
-00010370: 696e 2061 7320 7468 6572 6520 6172 6520  in as there are 
-00010380: 6e6f 206d 6174 6368 696e 6720 7370 6563  no matching spec
-00010390: 7472 6120 2220 5c0a 2020 2020 2020 2020  tra " \.        
-000103a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000103b0: 2020 2020 2020 2020 2261 7661 696c 6162          "availab
-000103c0: 6c65 222e 666f 726d 6174 2873 7263 3d73  le".format(src=s
-000103d0: 656c 662e 6e61 6d65 2c20 663d 6669 745f  elf.name, f=fit_
-000103e0: 6e61 6d65 290a 2020 2020 2020 2020 2020  name).          
-000103f0: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-00010400: 2073 656c 662e 5f73 616d 705f 6d65 6d62   self._samp_memb
-00010410: 6572 3a0a 2020 2020 2020 2020 2020 2020  er:.            
-00010420: 2020 2020 2020 2020 2020 2020 7761 726e              warn
-00010430: 2877 6172 6e5f 7465 7874 2c20 7374 6163  (warn_text, stac
-00010440: 6b6c 6576 656c 3d32 290a 2020 2020 2020  klevel=2).      
-00010450: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00010460: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00010470: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00010480: 2e5f 7375 7070 5f77 6172 6e2e 6170 7065  ._supp_warn.appe
-00010490: 6e64 2877 6172 6e5f 7465 7874 290a 2020  nd(warn_text).  
-000104a0: 2020 2020 2020 2020 2020 2020 2020 6669                fi
-000104b0: 745f 6461 7461 2e63 6c6f 7365 2829 0a0a  t_data.close()..
-000104c0: 2020 2020 2020 2020 2020 2020 6966 206c              if l
-000104d0: 656e 2861 6e6e 5f72 6573 756c 7473 2920  en(ann_results) 
-000104e0: 213d 2030 3a0a 2020 2020 2020 2020 2020  != 0:.          
-000104f0: 2020 2020 2020 666f 7220 7365 745f 6964        for set_id
-00010500: 2069 6e20 616e 6e5f 7265 7375 6c74 733a   in ann_results:
-00010510: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010520: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00010530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010540: 2020 7265 6c5f 616e 6e5f 7370 6563 203d    rel_ann_spec =
-00010550: 2073 656c 662e 6765 745f 616e 6e75 6c61   self.get_annula
-00010560: 725f 7370 6563 7472 6128 7365 745f 6964  r_spectra(set_id
-00010570: 3d73 6574 5f69 6429 0a20 2020 2020 2020  =set_id).       
+00010140: 2020 2020 2063 686f 7365 6e5f 6c75 6d73       chosen_lums
+00010150: 203d 2069 6e73 745f 6c75 6d73 5b22 6d6f   = inst_lums["mo
+00010160: 7332 225d 0a20 2020 2020 2020 2020 2020  s2"].           
+00010170: 2020 2020 2020 2020 2065 6c69 6620 226d           elif "m
+00010180: 6f73 3122 2069 6e20 696e 7374 5f6c 756d  os1" in inst_lum
+00010190: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+000101a0: 2020 2020 2020 2020 2020 2063 686f 7365             chose
+000101b0: 6e5f 6c75 6d73 203d 2069 6e73 745f 6c75  n_lums = inst_lu
+000101c0: 6d73 5b22 6d6f 7331 225d 0a20 2020 2020  ms["mos1"].     
+000101d0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+000101e0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+000101f0: 2020 2020 2020 2020 2020 2020 2063 686f               cho
+00010200: 7365 6e5f 6c75 6d73 203d 204e 6f6e 650a  sen_lums = None.
+00010210: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010220: 2020 2020 2069 6620 7365 745f 6964 2069       if set_id i
+00010230: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00010240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010250: 2020 2020 616e 6e5f 7265 7375 6c74 735b      ann_results[
+00010260: 7365 745f 6964 5d5b 6d6f 6465 6c5d 5b73  set_id][model][s
+00010270: 7065 632e 616e 6e75 6c75 735f 6964 656e  pec.annulus_iden
+00010280: 745d 203d 2067 6c6f 6261 6c5f 7265 7375  t] = global_resu
+00010290: 6c74 730a 2020 2020 2020 2020 2020 2020  lts.            
+000102a0: 2020 2020 2020 2020 2020 2020 616e 6e5f              ann_
+000102b0: 6c75 6d73 5b73 6574 5f69 645d 5b6d 6f64  lums[set_id][mod
+000102c0: 656c 5d5b 7370 6563 2e61 6e6e 756c 7573  el][spec.annulus
+000102d0: 5f69 6465 6e74 5d20 3d20 6368 6f73 656e  _ident] = chosen
+000102e0: 5f6c 756d 730a 2020 2020 2020 2020 2020  _lums.          
+000102f0: 2020 2020 2020 2020 2020 2020 2020 616e                an
+00010300: 6e5f 6f62 735f 6f72 6465 725b 7365 745f  n_obs_order[set_
+00010310: 6964 5d5b 6d6f 6465 6c5d 5b73 7065 632e  id][model][spec.
+00010320: 616e 6e75 6c75 735f 6964 656e 745d 203d  annulus_ident] =
+00010330: 206f 6273 5f6f 7264 6572 0a20 2020 2020   obs_order.     
+00010340: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00010350: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00010360: 2020 2020 2020 2020 2020 2020 2023 2050               # P
+00010370: 7573 6820 676c 6f62 616c 2066 6974 2072  ush global fit r
+00010380: 6573 756c 7473 2c20 6c75 6d69 6e6f 7369  esults, luminosi
+00010390: 7469 6573 2065 7463 2e20 696e 746f 2074  ties etc. into t
+000103a0: 6865 2063 6f72 7265 7370 6f6e 6469 6e67  he corresponding
+000103b0: 2073 6f75 7263 6520 6f62 6a65 6374 2e0a   source object..
+000103c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000103d0: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
+000103e0: 5f66 6974 5f64 6174 6128 6d6f 6465 6c2c  _fit_data(model,
+000103f0: 2067 6c6f 6261 6c5f 7265 7375 6c74 732c   global_results,
+00010400: 2063 686f 7365 6e5f 6c75 6d73 2c20 7370   chosen_lums, sp
+00010410: 5f6b 6579 290a 2020 2020 2020 2020 2020  _key).          
+00010420: 2020 2020 2020 6578 6365 7074 2028 4f53        except (OS
+00010430: 4572 726f 722c 204e 6f50 726f 6475 6374  Error, NoProduct
+00010440: 4176 6169 6c61 626c 6545 7272 6f72 2c20  AvailableError, 
+00010450: 496e 6465 7845 7272 6f72 2c20 4e6f 7441  IndexError, NotA
+00010460: 7373 6f63 6961 7465 6445 7272 6f72 293a  ssociatedError):
+00010470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010480: 2020 2020 2063 686f 7365 6e5f 6c75 6d73       chosen_lums
+00010490: 203d 207b 7d0a 2020 2020 2020 2020 2020   = {}.          
+000104a0: 2020 2020 2020 2020 2020 7761 726e 5f74            warn_t
+000104b0: 6578 7420 3d20 227b 7372 637d 2066 6974  ext = "{src} fit
+000104c0: 207b 667d 2063 6f75 6c64 206e 6f74 2062   {f} could not b
+000104d0: 6520 6c6f 6164 6564 2069 6e20 6173 2074  e loaded in as t
+000104e0: 6865 7265 2061 7265 206e 6f20 6d61 7463  here are no matc
+000104f0: 6869 6e67 2073 7065 6374 7261 2022 205c  hing spectra " \
+00010500: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010520: 2022 6176 6169 6c61 626c 6522 2e66 6f72   "available".for
+00010530: 6d61 7428 7372 633d 7365 6c66 2e6e 616d  mat(src=self.nam
+00010540: 652c 2066 3d66 6974 5f6e 616d 6529 0a20  e, f=fit_name). 
+00010550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010560: 2020 2069 6620 6e6f 7420 7365 6c66 2e5f     if not self._
+00010570: 7361 6d70 5f6d 656d 6265 723a 0a20 2020  samp_member:.   
 00010580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010590: 2066 6f72 206d 6f64 656c 2069 6e20 616e   for model in an
-000105a0: 6e5f 7265 7375 6c74 735b 7365 745f 6964  n_results[set_id
-000105b0: 5d3a 0a20 2020 2020 2020 2020 2020 2020  ]:.             
-000105c0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-000105d0: 656c 5f61 6e6e 5f73 7065 632e 6164 645f  el_ann_spec.add_
-000105e0: 6669 745f 6461 7461 286d 6f64 656c 2c20  fit_data(model, 
-000105f0: 616e 6e5f 7265 7375 6c74 735b 7365 745f  ann_results[set_
-00010600: 6964 5d5b 6d6f 6465 6c5d 2c20 616e 6e5f  id][model], ann_
-00010610: 6c75 6d73 5b73 6574 5f69 645d 5b6d 6f64  lums[set_id][mod
-00010620: 656c 5d2c 0a20 2020 2020 2020 2020 2020  el],.           
-00010630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010650: 2020 2020 2020 2020 2020 2061 6e6e 5f6f             ann_o
-00010660: 6273 5f6f 7264 6572 5b73 6574 5f69 645d  bs_order[set_id]
-00010670: 5b6d 6f64 656c 5d29 0a20 2020 2020 2020  [model]).       
-00010680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010690: 2020 2020 2023 2069 6620 6d6f 6465 6c20       # if model 
-000106a0: 3d3d 2022 636f 6e73 7461 6e74 2a74 6261  == "constant*tba
-000106b0: 6273 2a61 7065 6322 3a0a 2020 2020 2020  bs*apec":.      
-000106c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000106d0: 2020 2020 2020 2320 2020 2020 7465 6d70        #     temp
-000106e0: 5f70 726f 6620 3d20 7265 6c5f 616e 6e5f  _prof = rel_ann_
-000106f0: 7370 6563 2e67 656e 6572 6174 655f 7072  spec.generate_pr
-00010700: 6f66 696c 6528 6d6f 6465 6c2c 2027 6b54  ofile(model, 'kT
-00010710: 272c 2027 6b65 5627 290a 2020 2020 2020  ', 'keV').      
+00010590: 2020 2020 2077 6172 6e28 7761 726e 5f74       warn(warn_t
+000105a0: 6578 742c 2073 7461 636b 6c65 7665 6c3d  ext, stacklevel=
+000105b0: 3229 0a20 2020 2020 2020 2020 2020 2020  2).             
+000105c0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+000105d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000105e0: 2020 2020 2073 656c 662e 5f73 7570 705f       self._supp_
+000105f0: 7761 726e 2e61 7070 656e 6428 7761 726e  warn.append(warn
+00010600: 5f74 6578 7429 0a20 2020 2020 2020 2020  _text).         
+00010610: 2020 2020 2020 2066 6974 5f64 6174 612e         fit_data.
+00010620: 636c 6f73 6528 290a 0a20 2020 2020 2020  close()..       
+00010630: 2020 2020 2069 6620 6c65 6e28 616e 6e5f       if len(ann_
+00010640: 7265 7375 6c74 7329 2021 3d20 303a 0a20  results) != 0:. 
+00010650: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00010660: 6f72 2073 6574 5f69 6420 696e 2061 6e6e  or set_id in ann
+00010670: 5f72 6573 756c 7473 3a0a 2020 2020 2020  _results:.      
+00010680: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+00010690: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+000106a0: 2020 2020 2020 2020 2020 2072 656c 5f61             rel_a
+000106b0: 6e6e 5f73 7065 6320 3d20 7365 6c66 2e67  nn_spec = self.g
+000106c0: 6574 5f61 6e6e 756c 6172 5f73 7065 6374  et_annular_spect
+000106d0: 7261 2873 6574 5f69 643d 7365 745f 6964  ra(set_id=set_id
+000106e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000106f0: 2020 2020 2020 2020 2020 666f 7220 6d6f            for mo
+00010700: 6465 6c20 696e 2061 6e6e 5f72 6573 756c  del in ann_resul
+00010710: 7473 5b73 6574 5f69 645d 3a0a 2020 2020  ts[set_id]:.    
 00010720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010730: 2020 2020 2020 2320 2020 2020 7365 6c66        #     self
-00010740: 2e75 7064 6174 655f 7072 6f64 7563 7473  .update_products
-00010750: 2874 656d 705f 7072 6f66 290a 2020 2020  (temp_prof).    
-00010760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010770: 2020 2020 2020 2020 230a 2020 2020 2020          #.      
-00010780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010790: 2020 2020 2020 2320 2020 2020 2320 4e6f        #     # No
-000107a0: 726d 616c 6973 6174 696f 6e20 7072 6f66  rmalisation prof
-000107b0: 696c 6573 2063 616e 2062 6520 7573 6566  iles can be usef
-000107c0: 756c 2066 6f72 206d 616e 7920 7468 696e  ul for many thin
-000107d0: 6773 2c20 736f 2077 6520 6765 6e65 7261  gs, so we genera
-000107e0: 7465 2074 6865 6d20 746f 6f0a 2020 2020  te them too.    
-000107f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010800: 2020 2020 2020 2020 2320 2020 2020 6e6f          #     no
-00010810: 726d 5f70 726f 6620 3d20 7265 6c5f 616e  rm_prof = rel_an
-00010820: 6e5f 7370 6563 2e67 656e 6572 6174 655f  n_spec.generate_
-00010830: 7072 6f66 696c 6528 6d6f 6465 6c2c 2027  profile(model, '
-00010840: 6e6f 726d 272c 2027 636d 5e2d 3527 290a  norm', 'cm^-5').
-00010850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010860: 2020 2020 2020 2020 2020 2020 2320 2020              #   
-00010870: 2020 7365 6c66 2e75 7064 6174 655f 7072    self.update_pr
-00010880: 6f64 7563 7473 286e 6f72 6d5f 7072 6f66  oducts(norm_prof
-00010890: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000108a0: 2020 2020 2020 2020 2020 2020 2020 230a                #.
-000108b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000108c0: 2020 2020 2020 2020 2020 2020 2320 2020              #   
-000108d0: 2020 6966 2027 4162 756e 6461 6e63 2720    if 'Abundanc' 
-000108e0: 696e 2072 656c 5f61 6e6e 5f73 7065 632e  in rel_ann_spec.
-000108f0: 6765 745f 7265 7375 6c74 7328 302c 2027  get_results(0, '
-00010900: 636f 6e73 7461 6e74 2a74 6261 6273 2a61  constant*tbabs*a
-00010910: 7065 6327 293a 0a20 2020 2020 2020 2020  pec'):.         
-00010920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010930: 2020 2023 2020 2020 2020 2020 206d 6574     #         met
-00010940: 5f70 726f 6620 3d20 7265 6c5f 616e 6e5f  _prof = rel_ann_
-00010950: 7370 6563 2e67 656e 6572 6174 655f 7072  spec.generate_pr
-00010960: 6f66 696c 6528 6d6f 6465 6c2c 2027 4162  ofile(model, 'Ab
-00010970: 756e 6461 6e63 272c 2027 2729 0a20 2020  undanc', '').   
-00010980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010990: 2020 2020 2020 2020 2023 2020 2020 2020           #      
-000109a0: 2020 2073 656c 662e 7570 6461 7465 5f70     self.update_p
-000109b0: 726f 6475 6374 7328 6d65 745f 7072 6f66  roducts(met_prof
-000109c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000109d0: 2020 2020 2020 6578 6365 7074 2028 4e6f        except (No
-000109e0: 5072 6f64 7563 7441 7661 696c 6162 6c65  ProductAvailable
-000109f0: 4572 726f 722c 2056 616c 7565 4572 726f  Error, ValueErro
-00010a00: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-00010a10: 2020 2020 2020 2020 2020 2020 7761 726e              warn
-00010a20: 5f74 6578 7420 3d20 2241 2070 7265 7669  _text = "A previ
-00010a30: 6f75 7320 616e 6e75 6c61 7220 7370 6563  ous annular spec
-00010a40: 7472 6120 7072 6f66 696c 6520 6669 7420  tra profile fit 
-00010a50: 666f 7220 7b73 7263 7d20 7761 7320 6e6f  for {src} was no
-00010a60: 7420 7375 6363 6573 7366 756c 2c20 6f72  t successful, or
-00010a70: 206e 6f20 2220 5c0a 2020 2020 2020 2020   no " \.        
+00010730: 2020 2020 2020 2020 7265 6c5f 616e 6e5f          rel_ann_
+00010740: 7370 6563 2e61 6464 5f66 6974 5f64 6174  spec.add_fit_dat
+00010750: 6128 6d6f 6465 6c2c 2061 6e6e 5f72 6573  a(model, ann_res
+00010760: 756c 7473 5b73 6574 5f69 645d 5b6d 6f64  ults[set_id][mod
+00010770: 656c 5d2c 2061 6e6e 5f6c 756d 735b 7365  el], ann_lums[se
+00010780: 745f 6964 5d5b 6d6f 6465 6c5d 2c0a 2020  t_id][model],.  
+00010790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000107a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000107b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000107c0: 2020 2020 616e 6e5f 6f62 735f 6f72 6465      ann_obs_orde
+000107d0: 725b 7365 745f 6964 5d5b 6d6f 6465 6c5d  r[set_id][model]
+000107e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000107f0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00010800: 6966 206d 6f64 656c 203d 3d20 2263 6f6e  if model == "con
+00010810: 7374 616e 742a 7462 6162 732a 6170 6563  stant*tbabs*apec
+00010820: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
+00010830: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00010840: 2020 2020 2074 656d 705f 7072 6f66 203d       temp_prof =
+00010850: 2072 656c 5f61 6e6e 5f73 7065 632e 6765   rel_ann_spec.ge
+00010860: 6e65 7261 7465 5f70 726f 6669 6c65 286d  nerate_profile(m
+00010870: 6f64 656c 2c20 276b 5427 2c20 276b 6556  odel, 'kT', 'keV
+00010880: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
+00010890: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+000108a0: 2020 2020 2073 656c 662e 7570 6461 7465       self.update
+000108b0: 5f70 726f 6475 6374 7328 7465 6d70 5f70  _products(temp_p
+000108c0: 726f 6629 0a20 2020 2020 2020 2020 2020  rof).           
+000108d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000108e0: 2023 0a20 2020 2020 2020 2020 2020 2020   #.             
+000108f0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00010900: 2020 2020 2023 204e 6f72 6d61 6c69 7361       # Normalisa
+00010910: 7469 6f6e 2070 726f 6669 6c65 7320 6361  tion profiles ca
+00010920: 6e20 6265 2075 7365 6675 6c20 666f 7220  n be useful for 
+00010930: 6d61 6e79 2074 6869 6e67 732c 2073 6f20  many things, so 
+00010940: 7765 2067 656e 6572 6174 6520 7468 656d  we generate them
+00010950: 2074 6f6f 0a20 2020 2020 2020 2020 2020   too.           
+00010960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010970: 2023 2020 2020 206e 6f72 6d5f 7072 6f66   #     norm_prof
+00010980: 203d 2072 656c 5f61 6e6e 5f73 7065 632e   = rel_ann_spec.
+00010990: 6765 6e65 7261 7465 5f70 726f 6669 6c65  generate_profile
+000109a0: 286d 6f64 656c 2c20 276e 6f72 6d27 2c20  (model, 'norm', 
+000109b0: 2763 6d5e 2d35 2729 0a20 2020 2020 2020  'cm^-5').       
+000109c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000109d0: 2020 2020 2023 2020 2020 2073 656c 662e       #     self.
+000109e0: 7570 6461 7465 5f70 726f 6475 6374 7328  update_products(
+000109f0: 6e6f 726d 5f70 726f 6629 0a20 2020 2020  norm_prof).     
+00010a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010a10: 2020 2020 2020 2023 0a20 2020 2020 2020         #.       
+00010a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010a30: 2020 2020 2023 2020 2020 2069 6620 2741       #     if 'A
+00010a40: 6275 6e64 616e 6327 2069 6e20 7265 6c5f  bundanc' in rel_
+00010a50: 616e 6e5f 7370 6563 2e67 6574 5f72 6573  ann_spec.get_res
+00010a60: 756c 7473 2830 2c20 2763 6f6e 7374 616e  ults(0, 'constan
+00010a70: 742a 7462 6162 732a 6170 6563 2729 3a0a  t*tbabs*apec'):.
 00010a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010a90: 2020 2020 2020 2020 2020 2020 226d 6174              "mat
-00010aa0: 6368 696e 6720 7370 6563 7472 756d 2068  ching spectrum h
-00010ab0: 6173 2062 6565 6e20 6c6f 6164 6564 2c20  as been loaded, 
-00010ac0: 736f 2069 7420 6361 6e6e 6f74 2062 6520  so it cannot be 
-00010ad0: 7265 6164 2022 205c 0a20 2020 2020 2020  read " \.       
-00010ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010af0: 2020 2020 2020 2020 2020 2020 2022 696e               "in
-00010b00: 222e 666f 726d 6174 2873 7263 3d73 656c  ".format(src=sel
-00010b10: 662e 6e61 6d65 290a 2020 2020 2020 2020  f.name).        
-00010b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010b30: 6966 206e 6f74 2073 656c 662e 5f73 616d  if not self._sam
-00010b40: 705f 6d65 6d62 6572 3a0a 2020 2020 2020  p_member:.      
-00010b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010b60: 2020 2020 2020 7761 726e 2877 6172 6e5f        warn(warn_
-00010b70: 7465 7874 2c20 7374 6163 6b6c 6576 656c  text, stacklevel
-00010b80: 3d32 290a 2020 2020 2020 2020 2020 2020  =2).            
-00010b90: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00010ba0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00010bb0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00010bc0: 6c66 2e5f 7375 7070 5f77 6172 6e2e 6170  lf._supp_warn.ap
-00010bd0: 7065 6e64 2877 6172 6e5f 7465 7874 290a  pend(warn_text).
-00010be0: 0a20 2020 2020 2020 206f 732e 6368 6469  .        os.chdi
-00010bf0: 7228 6f67 5f64 6972 290a 0a20 2020 2020  r(og_dir)..     
-00010c00: 2020 2023 2041 6e64 2066 696e 616c 6c79     # And finally
-00010c10: 206c 6f61 6469 6e67 2069 6e20 616e 7920   loading in any 
-00010c20: 636f 6e76 6572 7369 6f6e 2066 6163 746f  conversion facto
-00010c30: 7273 2074 6861 7420 6861 7665 2062 6565  rs that have bee
-00010c40: 6e20 6361 6c63 756c 6174 6564 2075 7369  n calculated usi
-00010c50: 6e67 2058 4741 2773 2066 616b 6569 7420  ng XGA's fakeit 
-00010c60: 696e 7465 7266 6163 650a 2020 2020 2020  interface.      
-00010c70: 2020 6966 206f 732e 7061 7468 2e65 7869    if os.path.exi
-00010c80: 7374 7328 4f55 5450 5554 202b 2022 5853  sts(OUTPUT + "XS
-00010c90: 5045 432f 2220 2b20 7365 6c66 2e6e 616d  PEC/" + self.nam
-00010ca0: 6529 2061 6e64 2072 6561 645f 6669 7473  e) and read_fits
-00010cb0: 3a0a 2020 2020 2020 2020 2020 2020 636f  :.            co
-00010cc0: 6e76 5f66 6163 746f 7273 203d 205b 4f55  nv_factors = [OU
-00010cd0: 5450 5554 202b 2022 5853 5045 432f 2220  TPUT + "XSPEC/" 
-00010ce0: 2b20 7365 6c66 2e6e 616d 6520 2b20 222f  + self.name + "/
-00010cf0: 2220 2b20 6620 666f 7220 6620 696e 206f  " + f for f in o
-00010d00: 732e 6c69 7374 6469 7228 4f55 5450 5554  s.listdir(OUTPUT
-00010d10: 202b 2022 5853 5045 432f 2220 2b20 7365   + "XSPEC/" + se
-00010d20: 6c66 2e6e 616d 6529 0a20 2020 2020 2020  lf.name).       
-00010d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010d40: 2020 2020 2069 6620 222e 7863 6d22 206e       if ".xcm" n
-00010d50: 6f74 2069 6e20 6620 616e 6420 2263 6f6e  ot in f and "con
-00010d60: 765f 6661 6374 6f72 7322 2069 6e20 665d  v_factors" in f]
-00010d70: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00010d80: 2063 6f6e 765f 7061 7468 2069 6e20 636f   conv_path in co
-00010d90: 6e76 5f66 6163 746f 7273 3a0a 2020 2020  nv_factors:.    
-00010da0: 2020 2020 2020 2020 2020 2020 7265 735f              res_
-00010db0: 7461 626c 6520 3d20 7064 2e72 6561 645f  table = pd.read_
-00010dc0: 6373 7628 636f 6e76 5f70 6174 682c 2064  csv(conv_path, d
-00010dd0: 7479 7065 3d7b 226c 6f5f 656e 223a 2073  type={"lo_en": s
-00010de0: 7472 2c20 2268 695f 656e 223a 2073 7472  tr, "hi_en": str
-00010df0: 7d29 0a20 2020 2020 2020 2020 2020 2020  }).             
-00010e00: 2020 2023 2047 6574 7320 7468 6520 6d6f     # Gets the mo
-00010e10: 6465 6c20 6e61 6d65 2066 726f 6d20 7468  del name from th
-00010e20: 6520 6669 6c65 206e 616d 6520 6f66 2074  e file name of t
-00010e30: 6865 206f 7574 7075 7420 7265 7375 6c74  he output result
-00010e40: 7320 7461 626c 650a 2020 2020 2020 2020  s table.        
-00010e50: 2020 2020 2020 2020 6d6f 6465 6c20 3d20          model = 
-00010e60: 636f 6e76 5f70 6174 682e 7370 6c69 7428  conv_path.split(
-00010e70: 225f 2229 5b2d 335d 0a0a 2020 2020 2020  "_")[-3]..      
-00010e80: 2020 2020 2020 2020 2020 2320 5765 2063            # We c
-00010e90: 616e 2069 6e66 6572 2074 6865 2073 746f  an infer the sto
-00010ea0: 7261 6765 206b 6579 2066 726f 6d20 7468  rage key from th
-00010eb0: 6520 6e61 6d65 206f 6620 7468 6520 7265  e name of the re
-00010ec0: 7375 6c74 7320 7461 626c 652c 206a 7573  sults table, jus
-00010ed0: 7420 6d61 6b65 7320 6974 2065 6173 6965  t makes it easie
-00010ee0: 7220 746f 0a20 2020 2020 2020 2020 2020  r to.           
-00010ef0: 2020 2020 2023 2020 6772 6162 2074 6865       #  grab the
-00010f00: 2063 6f72 7265 6374 2073 7065 6374 7261   correct spectra
-00010f10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010f20: 2073 746f 7261 6765 5f6b 6579 203d 2063   storage_key = c
-00010f30: 6f6e 765f 7061 7468 2e73 706c 6974 2827  onv_path.split('
-00010f40: 2f27 295b 2d31 5d2e 7370 6c69 7428 7365  /')[-1].split(se
-00010f50: 6c66 2e6e 616d 6529 5b2d 315d 5b31 3a5d  lf.name)[-1][1:]
-00010f60: 2e73 706c 6974 286d 6f64 656c 295b 305d  .split(model)[0]
-00010f70: 5b3a 2d31 5d0a 0a20 2020 2020 2020 2020  [:-1]..         
-00010f80: 2020 2020 2020 2023 2047 7261 6273 2074         # Grabs t
-00010f90: 6865 204f 6273 4944 2b69 6e73 7472 756d  he ObsID+instrum
-00010fa0: 656e 7420 636f 6d62 696e 6174 696f 6e73  ent combinations
-00010fb0: 2066 726f 6d20 7468 6520 6865 6164 6572   from the header
-00010fc0: 7320 6f66 2074 6865 2063 7376 2e20 4d61  s of the csv. Ma
-00010fd0: 6b65 7320 7375 7265 2074 6865 7920 6172  kes sure they ar
-00010fe0: 6520 756e 6971 7565 0a20 2020 2020 2020  e unique.       
-00010ff0: 2020 2020 2020 2020 2023 2020 6279 2067           #  by g
-00011000: 6f69 6e67 2074 6f20 6120 7365 7420 2862  oing to a set (b
-00011010: 6563 6175 7365 2074 6865 7265 2077 696c  ecause there wil
-00011020: 6c20 6265 2074 776f 2063 6f6c 756d 6e73  l be two columns
-00011030: 2066 6f72 2065 6163 6820 4f62 7349 442b   for each ObsID+
-00011040: 496e 7374 7275 6d65 6e74 2c20 7261 7465  Instrument, rate
-00011050: 2061 6e64 204c 7829 0a20 2020 2020 2020   and Lx).       
-00011060: 2020 2020 2020 2020 2023 2046 6972 7374           # First
-00011070: 2074 776f 2063 6f6c 756d 6e73 2061 7265   two columns are
-00011080: 2073 6b69 7070 6564 2062 6563 6175 7365   skipped because
-00011090: 2074 6865 7920 6172 6520 656e 6572 6779   they are energy
-000110a0: 206c 696d 6974 730a 2020 2020 2020 2020   limits.        
-000110b0: 2020 2020 2020 2020 636f 6d62 6f73 203d          combos =
-000110c0: 206c 6973 7428 7365 7428 5b63 2e73 706c   list(set([c.spl
-000110d0: 6974 2822 5f22 295b 315d 2066 6f72 2063  it("_")[1] for c
-000110e0: 2069 6e20 7265 735f 7461 626c 652e 636f   in res_table.co
-000110f0: 6c75 6d6e 735b 323a 5d5d 2929 0a20 2020  lumns[2:]])).   
-00011100: 2020 2020 2020 2020 2020 2020 2023 2047               # G
-00011110: 6574 7469 6e67 2074 6865 2073 7065 6374  etting the spect
-00011120: 7261 2066 6f72 2065 6163 6820 636f 6c75  ra for each colu
-00011130: 6d6e 2c20 7468 656e 2061 7373 6967 6e69  mn, then assigni
-00011140: 6e67 2072 6174 6573 2061 6e64 206c 756d  ng rates and lum
-00011150: 696e 6f73 6974 6965 732e 0a20 2020 2020  inosities..     
-00011160: 2020 2020 2020 2020 2020 2023 2044 7565             # Due
-00011170: 2074 6f20 7468 6520 6461 6e67 6572 206f   to the danger o
-00011180: 6620 6120 6669 7420 7573 696e 6720 6120  f a fit using a 
-00011190: 7069 6563 6520 6f66 2064 6174 6120 2861  piece of data (a
-000111a0: 6e20 4f62 7349 442d 696e 7374 7275 6d65  n ObsID-instrume
-000111b0: 6e74 2063 6f6d 626f 2920 7468 6174 2069  nt combo) that i
-000111c0: 736e 2774 2063 7572 7265 6e74 6c79 0a20  sn't currently. 
-000111d0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000111e0: 2020 6173 736f 6369 6174 6564 2077 6974    associated wit
-000111f0: 6820 7468 6520 736f 7572 6365 2c20 7765  h the source, we
-00011200: 2066 6972 7374 2066 6574 6368 2074 6865   first fetch the
-00011210: 2073 7065 6374 7261 2c20 7468 656e 2069   spectra, then i
-00011220: 6e20 6120 7365 636f 6e64 206c 6f6f 7020  n a second loop 
-00011230: 7765 2061 7373 6967 6e20 7468 6520 6661  we assign the fa
-00011240: 6374 6f72 730a 2020 2020 2020 2020 2020  ctors.          
-00011250: 2020 2020 2020 7265 6c5f 7370 6563 203d        rel_spec =
-00011260: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
-00011270: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00011280: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00011290: 2063 6f6d 6220 696e 2063 6f6d 626f 733a   comb in combos:
-000112a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000112b0: 2020 2020 2020 2020 2073 7065 6320 3d20           spec = 
-000112c0: 7365 6c66 2e67 6574 5f70 726f 6475 6374  self.get_product
-000112d0: 7328 2273 7065 6374 7275 6d22 2c20 636f  s("spectrum", co
-000112e0: 6d62 5b3a 3130 5d2c 2063 6f6d 625b 3130  mb[:10], comb[10
-000112f0: 3a5d 2c20 6578 7472 615f 6b65 793d 7374  :], extra_key=st
-00011300: 6f72 6167 655f 6b65 7929 5b30 5d0a 2020  orage_key)[0].  
-00011310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011320: 2020 2020 2020 7265 6c5f 7370 6563 2e61        rel_spec.a
-00011330: 7070 656e 6428 7370 6563 290a 0a20 2020  ppend(spec)..   
-00011340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011350: 2066 6f72 2063 6f6d 625f 696e 642c 2063   for comb_ind, c
-00011360: 6f6d 6220 696e 2065 6e75 6d65 7261 7465  omb in enumerate
-00011370: 2863 6f6d 626f 7329 3a0a 2020 2020 2020  (combos):.      
-00011380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011390: 2020 7265 6c5f 7370 6563 5b63 6f6d 625f    rel_spec[comb_
-000113a0: 696e 645d 2e61 6464 5f63 6f6e 765f 6661  ind].add_conv_fa
-000113b0: 6374 6f72 7328 7265 735f 7461 626c 655b  ctors(res_table[
-000113c0: 226c 6f5f 656e 225d 2e76 616c 7565 732c  "lo_en"].values,
-000113d0: 2072 6573 5f74 6162 6c65 5b22 6869 5f65   res_table["hi_e
-000113e0: 6e22 5d2e 7661 6c75 6573 2c0a 2020 2020  n"].values,.    
-000113f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010a90: 2020 2020 2020 2020 2020 2020 2320 2020              #   
+00010aa0: 2020 2020 2020 6d65 745f 7072 6f66 203d        met_prof =
+00010ab0: 2072 656c 5f61 6e6e 5f73 7065 632e 6765   rel_ann_spec.ge
+00010ac0: 6e65 7261 7465 5f70 726f 6669 6c65 286d  nerate_profile(m
+00010ad0: 6f64 656c 2c20 2741 6275 6e64 616e 6327  odel, 'Abundanc'
+00010ae0: 2c20 2727 290a 2020 2020 2020 2020 2020  , '').          
+00010af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010b00: 2020 2320 2020 2020 2020 2020 7365 6c66    #         self
+00010b10: 2e75 7064 6174 655f 7072 6f64 7563 7473  .update_products
+00010b20: 286d 6574 5f70 726f 6629 0a20 2020 2020  (met_prof).     
+00010b30: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00010b40: 7863 6570 7420 284e 6f50 726f 6475 6374  xcept (NoProduct
+00010b50: 4176 6169 6c61 626c 6545 7272 6f72 2c20  AvailableError, 
+00010b60: 5661 6c75 6545 7272 6f72 293a 0a20 2020  ValueError):.   
+00010b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010b80: 2020 2020 2077 6172 6e5f 7465 7874 203d       warn_text =
+00010b90: 2022 4120 7072 6576 696f 7573 2061 6e6e   "A previous ann
+00010ba0: 756c 6172 2073 7065 6374 7261 2070 726f  ular spectra pro
+00010bb0: 6669 6c65 2066 6974 2066 6f72 207b 7372  file fit for {sr
+00010bc0: 637d 2077 6173 206e 6f74 2073 7563 6365  c} was not succe
+00010bd0: 7373 6675 6c2c 206f 7220 6e6f 2022 205c  ssful, or no " \
+00010be0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010c00: 2020 2020 2022 6d61 7463 6869 6e67 2073       "matching s
+00010c10: 7065 6374 7275 6d20 6861 7320 6265 656e  pectrum has been
+00010c20: 206c 6f61 6465 642c 2073 6f20 6974 2063   loaded, so it c
+00010c30: 616e 6e6f 7420 6265 2072 6561 6420 2220  annot be read " 
+00010c40: 5c0a 2020 2020 2020 2020 2020 2020 2020  \.              
+00010c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010c60: 2020 2020 2020 2269 6e22 2e66 6f72 6d61        "in".forma
+00010c70: 7428 7372 633d 7365 6c66 2e6e 616d 6529  t(src=self.name)
+00010c80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010c90: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+00010ca0: 7365 6c66 2e5f 7361 6d70 5f6d 656d 6265  self._samp_membe
+00010cb0: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
+00010cc0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+00010cd0: 6172 6e28 7761 726e 5f74 6578 742c 2073  arn(warn_text, s
+00010ce0: 7461 636b 6c65 7665 6c3d 3229 0a20 2020  tacklevel=2).   
+00010cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010d00: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00010d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010d20: 2020 2020 2020 2073 656c 662e 5f73 7570         self._sup
+00010d30: 705f 7761 726e 2e61 7070 656e 6428 7761  p_warn.append(wa
+00010d40: 726e 5f74 6578 7429 0a0a 2020 2020 2020  rn_text)..      
+00010d50: 2020 6f73 2e63 6864 6972 286f 675f 6469    os.chdir(og_di
+00010d60: 7229 0a0a 2020 2020 2020 2020 2320 416e  r)..        # An
+00010d70: 6420 6669 6e61 6c6c 7920 6c6f 6164 696e  d finally loadin
+00010d80: 6720 696e 2061 6e79 2063 6f6e 7665 7273  g in any convers
+00010d90: 696f 6e20 6661 6374 6f72 7320 7468 6174  ion factors that
+00010da0: 2068 6176 6520 6265 656e 2063 616c 6375   have been calcu
+00010db0: 6c61 7465 6420 7573 696e 6720 5847 4127  lated using XGA'
+00010dc0: 7320 6661 6b65 6974 2069 6e74 6572 6661  s fakeit interfa
+00010dd0: 6365 0a20 2020 2020 2020 2069 6620 6f73  ce.        if os
+00010de0: 2e70 6174 682e 6578 6973 7473 284f 5554  .path.exists(OUT
+00010df0: 5055 5420 2b20 2258 5350 4543 2f22 202b  PUT + "XSPEC/" +
+00010e00: 2073 656c 662e 6e61 6d65 2920 616e 6420   self.name) and 
+00010e10: 7265 6164 5f66 6974 733a 0a20 2020 2020  read_fits:.     
+00010e20: 2020 2020 2020 2063 6f6e 765f 6661 6374         conv_fact
+00010e30: 6f72 7320 3d20 5b4f 5554 5055 5420 2b20  ors = [OUTPUT + 
+00010e40: 2258 5350 4543 2f22 202b 2073 656c 662e  "XSPEC/" + self.
+00010e50: 6e61 6d65 202b 2022 2f22 202b 2066 2066  name + "/" + f f
+00010e60: 6f72 2066 2069 6e20 6f73 2e6c 6973 7464  or f in os.listd
+00010e70: 6972 284f 5554 5055 5420 2b20 2258 5350  ir(OUTPUT + "XSP
+00010e80: 4543 2f22 202b 2073 656c 662e 6e61 6d65  EC/" + self.name
+00010e90: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00010ea0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00010eb0: 2022 2e78 636d 2220 6e6f 7420 696e 2066   ".xcm" not in f
+00010ec0: 2061 6e64 2022 636f 6e76 5f66 6163 746f   and "conv_facto
+00010ed0: 7273 2220 696e 2066 5d0a 2020 2020 2020  rs" in f].      
+00010ee0: 2020 2020 2020 666f 7220 636f 6e76 5f70        for conv_p
+00010ef0: 6174 6820 696e 2063 6f6e 765f 6661 6374  ath in conv_fact
+00010f00: 6f72 733a 0a20 2020 2020 2020 2020 2020  ors:.           
+00010f10: 2020 2020 2072 6573 5f74 6162 6c65 203d       res_table =
+00010f20: 2070 642e 7265 6164 5f63 7376 2863 6f6e   pd.read_csv(con
+00010f30: 765f 7061 7468 2c20 6474 7970 653d 7b22  v_path, dtype={"
+00010f40: 6c6f 5f65 6e22 3a20 7374 722c 2022 6869  lo_en": str, "hi
+00010f50: 5f65 6e22 3a20 7374 727d 290a 2020 2020  _en": str}).    
+00010f60: 2020 2020 2020 2020 2020 2020 2320 4765              # Ge
+00010f70: 7473 2074 6865 206d 6f64 656c 206e 616d  ts the model nam
+00010f80: 6520 6672 6f6d 2074 6865 2066 696c 6520  e from the file 
+00010f90: 6e61 6d65 206f 6620 7468 6520 6f75 7470  name of the outp
+00010fa0: 7574 2072 6573 756c 7473 2074 6162 6c65  ut results table
+00010fb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010fc0: 206d 6f64 656c 203d 2063 6f6e 765f 7061   model = conv_pa
+00010fd0: 7468 2e73 706c 6974 2822 5f22 295b 2d33  th.split("_")[-3
+00010fe0: 5d0a 0a20 2020 2020 2020 2020 2020 2020  ]..             
+00010ff0: 2020 2023 2057 6520 6361 6e20 696e 6665     # We can infe
+00011000: 7220 7468 6520 7374 6f72 6167 6520 6b65  r the storage ke
+00011010: 7920 6672 6f6d 2074 6865 206e 616d 6520  y from the name 
+00011020: 6f66 2074 6865 2072 6573 756c 7473 2074  of the results t
+00011030: 6162 6c65 2c20 6a75 7374 206d 616b 6573  able, just makes
+00011040: 2069 7420 6561 7369 6572 2074 6f0a 2020   it easier to.  
+00011050: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00011060: 2067 7261 6220 7468 6520 636f 7272 6563   grab the correc
+00011070: 7420 7370 6563 7472 610a 2020 2020 2020  t spectra.      
+00011080: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
+00011090: 655f 6b65 7920 3d20 636f 6e76 5f70 6174  e_key = conv_pat
+000110a0: 682e 7370 6c69 7428 272f 2729 5b2d 315d  h.split('/')[-1]
+000110b0: 2e73 706c 6974 2873 656c 662e 6e61 6d65  .split(self.name
+000110c0: 295b 2d31 5d5b 313a 5d2e 7370 6c69 7428  )[-1][1:].split(
+000110d0: 6d6f 6465 6c29 5b30 5d5b 3a2d 315d 0a0a  model)[0][:-1]..
+000110e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000110f0: 2320 4772 6162 7320 7468 6520 4f62 7349  # Grabs the ObsI
+00011100: 442b 696e 7374 7275 6d65 6e74 2063 6f6d  D+instrument com
+00011110: 6269 6e61 7469 6f6e 7320 6672 6f6d 2074  binations from t
+00011120: 6865 2068 6561 6465 7273 206f 6620 7468  he headers of th
+00011130: 6520 6373 762e 204d 616b 6573 2073 7572  e csv. Makes sur
+00011140: 6520 7468 6579 2061 7265 2075 6e69 7175  e they are uniqu
+00011150: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00011160: 2020 2320 2062 7920 676f 696e 6720 746f    #  by going to
+00011170: 2061 2073 6574 2028 6265 6361 7573 6520   a set (because 
+00011180: 7468 6572 6520 7769 6c6c 2062 6520 7477  there will be tw
+00011190: 6f20 636f 6c75 6d6e 7320 666f 7220 6561  o columns for ea
+000111a0: 6368 204f 6273 4944 2b49 6e73 7472 756d  ch ObsID+Instrum
+000111b0: 656e 742c 2072 6174 6520 616e 6420 4c78  ent, rate and Lx
+000111c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000111d0: 2020 2320 4669 7273 7420 7477 6f20 636f    # First two co
+000111e0: 6c75 6d6e 7320 6172 6520 736b 6970 7065  lumns are skippe
+000111f0: 6420 6265 6361 7573 6520 7468 6579 2061  d because they a
+00011200: 7265 2065 6e65 7267 7920 6c69 6d69 7473  re energy limits
+00011210: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011220: 2063 6f6d 626f 7320 3d20 6c69 7374 2873   combos = list(s
+00011230: 6574 285b 632e 7370 6c69 7428 225f 2229  et([c.split("_")
+00011240: 5b31 5d20 666f 7220 6320 696e 2072 6573  [1] for c in res
+00011250: 5f74 6162 6c65 2e63 6f6c 756d 6e73 5b32  _table.columns[2
+00011260: 3a5d 5d29 290a 2020 2020 2020 2020 2020  :]])).          
+00011270: 2020 2020 2020 2320 4765 7474 696e 6720        # Getting 
+00011280: 7468 6520 7370 6563 7472 6120 666f 7220  the spectra for 
+00011290: 6561 6368 2063 6f6c 756d 6e2c 2074 6865  each column, the
+000112a0: 6e20 6173 7369 676e 696e 6720 7261 7465  n assigning rate
+000112b0: 7320 616e 6420 6c75 6d69 6e6f 7369 7469  s and luminositi
+000112c0: 6573 2e0a 2020 2020 2020 2020 2020 2020  es..            
+000112d0: 2020 2020 2320 4475 6520 746f 2074 6865      # Due to the
+000112e0: 2064 616e 6765 7220 6f66 2061 2066 6974   danger of a fit
+000112f0: 2075 7369 6e67 2061 2070 6965 6365 206f   using a piece o
+00011300: 6620 6461 7461 2028 616e 204f 6273 4944  f data (an ObsID
+00011310: 2d69 6e73 7472 756d 656e 7420 636f 6d62  -instrument comb
+00011320: 6f29 2074 6861 7420 6973 6e27 7420 6375  o) that isn't cu
+00011330: 7272 656e 746c 790a 2020 2020 2020 2020  rrently.        
+00011340: 2020 2020 2020 2020 2320 2061 7373 6f63          #  assoc
+00011350: 6961 7465 6420 7769 7468 2074 6865 2073  iated with the s
+00011360: 6f75 7263 652c 2077 6520 6669 7273 7420  ource, we first 
+00011370: 6665 7463 6820 7468 6520 7370 6563 7472  fetch the spectr
+00011380: 612c 2074 6865 6e20 696e 2061 2073 6563  a, then in a sec
+00011390: 6f6e 6420 6c6f 6f70 2077 6520 6173 7369  ond loop we assi
+000113a0: 676e 2074 6865 2066 6163 746f 7273 0a20  gn the factors. 
+000113b0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000113c0: 656c 5f73 7065 6320 3d20 5b5d 0a20 2020  el_spec = [].   
+000113d0: 2020 2020 2020 2020 2020 2020 2074 7279               try
+000113e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000113f0: 2020 2020 2020 666f 7220 636f 6d62 2069        for comb i
+00011400: 6e20 636f 6d62 6f73 3a0a 2020 2020 2020  n combos:.      
 00011410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011420: 2020 2020 2020 2020 7265 735f 7461 626c          res_tabl
-00011430: 655b 2272 6174 655f 7b7d 222e 666f 726d  e["rate_{}".form
-00011440: 6174 2863 6f6d 6229 5d2e 7661 6c75 6573  at(comb)].values
-00011450: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00011460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011480: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00011490: 735f 7461 626c 655b 224c 785f 7b7d 222e  s_table["Lx_{}".
-000114a0: 666f 726d 6174 2863 6f6d 6229 5d2e 7661  format(comb)].va
-000114b0: 6c75 6573 2c20 6d6f 6465 6c29 0a0a 2020  lues, model)..  
-000114c0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-000114d0: 5468 6973 2074 7269 6767 6572 7320 696e  This triggers in
-000114e0: 2074 6865 2063 6173 6520 6f66 2073 6f6d   the case of som
-000114f0: 6574 6869 6e67 206c 696b 6520 6973 7375  ething like issu
-00011500: 6520 2337 3338 2c20 7768 6572 6520 6120  e #738, where a 
-00011510: 7072 6576 696f 7573 2066 6974 2075 7365  previous fit use
-00011520: 6420 6461 7461 2074 6861 7420 6973 0a20  d data that is. 
-00011530: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00011540: 2020 6e6f 7420 6c6f 6164 6564 2069 6e74    not loaded int
-00011550: 6f20 7468 6973 2073 6f75 7263 6520 2865  o this source (e
-00011560: 6974 6865 7220 6265 6361 7573 6520 6974  ither because it
-00011570: 2077 6173 206d 616e 7561 6c6c 7920 7265   was manually re
-00011580: 6d6f 7665 642c 206f 7220 6265 6361 7573  moved, or becaus
-00011590: 6520 7468 6520 6365 6e74 7261 6c0a 2020  e the central.  
-000115a0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-000115b0: 2070 6f73 6974 696f 6e20 6861 7320 6368   position has ch
-000115c0: 616e 6765 6420 6574 632e 290a 2020 2020  anged etc.).    
-000115d0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-000115e0: 7074 204e 6f74 4173 736f 6369 6174 6564  pt NotAssociated
-000115f0: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
-00011600: 2020 2020 2020 2020 2020 2077 6172 6e5f             warn_
-00011610: 7465 7874 203d 2022 4578 6973 7469 6e67  text = "Existing
-00011620: 2066 6974 2066 6f72 207b 737d 2063 6f75   fit for {s} cou
-00011630: 6c64 206e 6f74 2062 6520 6c6f 6164 6564  ld not be loaded
-00011640: 2064 7565 2074 6f20 6120 6d69 736d 6174   due to a mismat
-00011650: 6368 2069 6e20 6176 6169 6c61 626c 6520  ch in available 
-00011660: 2220 5c0a 2020 2020 2020 2020 2020 2020  " \.            
-00011670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011680: 2020 2020 2264 6174 6122 2e66 6f72 6d61      "data".forma
-00011690: 7428 733d 7365 6c66 2e6e 616d 6529 0a20  t(s=self.name). 
-000116a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000116b0: 2020 2069 6620 6e6f 7420 7365 6c66 2e5f     if not self._
-000116c0: 7361 6d70 5f6d 656d 6265 723a 0a20 2020  samp_member:.   
-000116d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000116e0: 2020 2020 2077 6172 6e28 7761 726e 5f74       warn(warn_t
-000116f0: 6578 742c 2073 7461 636b 6c65 7665 6c3d  ext, stacklevel=
-00011700: 3229 0a20 2020 2020 2020 2020 2020 2020  2).             
-00011710: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00011720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011730: 2020 2020 2073 656c 662e 5f73 7570 705f       self._supp_
-00011740: 7761 726e 2e61 7070 656e 6428 7761 726e  warn.append(warn
-00011750: 5f74 6578 7429 0a0a 2020 2020 6465 6620  _text)..    def 
-00011760: 6765 745f 7072 6f64 7563 7473 2873 656c  get_products(sel
-00011770: 662c 2070 5f74 7970 653a 2073 7472 2c20  f, p_type: str, 
-00011780: 6f62 735f 6964 3a20 7374 7220 3d20 4e6f  obs_id: str = No
-00011790: 6e65 2c20 696e 7374 3a20 7374 7220 3d20  ne, inst: str = 
-000117a0: 4e6f 6e65 2c20 6578 7472 615f 6b65 793a  None, extra_key:
-000117b0: 2073 7472 203d 204e 6f6e 652c 0a20 2020   str = None,.   
-000117c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000117d0: 2020 6a75 7374 5f6f 626a 3a20 626f 6f6c    just_obj: bool
-000117e0: 203d 2054 7275 6529 202d 3e20 4c69 7374   = True) -> List
-000117f0: 5b42 6173 6550 726f 6475 6374 5d3a 0a20  [BaseProduct]:. 
-00011800: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00011810: 2020 2054 6869 7320 6973 2074 6865 2067     This is the g
-00011820: 6574 7465 7220 666f 7220 7468 6520 7072  etter for the pr
-00011830: 6f64 7563 7473 2064 6174 6120 7374 7275  oducts data stru
-00011840: 6374 7572 6520 6f66 2053 6f75 7263 6520  cture of Source 
-00011850: 6f62 6a65 6374 732e 2050 6173 7369 6e67  objects. Passing
-00011860: 2061 2027 7072 6f64 7563 7420 7479 7065   a 'product type
-00011870: 270a 2020 2020 2020 2020 7375 6368 2061  '.        such a
-00011880: 7320 2765 7665 6e74 7327 206f 7220 2769  s 'events' or 'i
-00011890: 6d61 6765 7327 2077 696c 6c20 7265 7475  mages' will retu
-000118a0: 726e 2065 7665 7279 206d 6174 6368 696e  rn every matchin
-000118b0: 6720 656e 7472 7920 696e 2074 6865 2070  g entry in the p
-000118c0: 726f 6475 6374 7320 6461 7461 2073 7472  roducts data str
-000118d0: 7563 7475 7265 2e0a 0a20 2020 2020 2020  ucture...       
-000118e0: 203a 7061 7261 6d20 7374 7220 705f 7479   :param str p_ty
-000118f0: 7065 3a20 5072 6f64 7563 7420 7479 7065  pe: Product type
-00011900: 2069 6465 6e74 6966 6965 722e 2065 2e67   identifier. e.g
-00011910: 2e20 696d 6167 6520 6f72 2065 7870 6d61  . image or expma
-00011920: 702e 0a20 2020 2020 2020 203a 7061 7261  p..        :para
-00011930: 6d20 7374 7220 6f62 735f 6964 3a20 4f70  m str obs_id: Op
-00011940: 7469 6f6e 616c 6c79 2c20 6120 7370 6563  tionally, a spec
-00011950: 6966 6963 206f 6273 5f69 6420 746f 2073  ific obs_id to s
-00011960: 6561 7263 6820 6361 6e20 6265 2073 7570  earch can be sup
-00011970: 706c 6965 642e 0a20 2020 2020 2020 203a  plied..        :
-00011980: 7061 7261 6d20 7374 7220 696e 7374 3a20  param str inst: 
-00011990: 4f70 7469 6f6e 616c 6c79 2c20 6120 7370  Optionally, a sp
-000119a0: 6563 6966 6963 2069 6e73 7472 756d 656e  ecific instrumen
-000119b0: 7420 746f 2073 6561 7263 6820 6361 6e20  t to search can 
-000119c0: 6265 2073 7570 706c 6965 642e 0a20 2020  be supplied..   
-000119d0: 2020 2020 203a 7061 7261 6d20 7374 7220       :param str 
-000119e0: 6578 7472 615f 6b65 793a 204f 7074 696f  extra_key: Optio
-000119f0: 6e61 6c6c 792c 2061 6e20 6578 7472 6120  nally, an extra 
-00011a00: 6b65 7920 286c 696b 6520 616e 2065 6e65  key (like an ene
-00011a10: 7267 7920 626f 756e 6429 2063 616e 2062  rgy bound) can b
-00011a20: 6520 7375 7070 6c69 6564 2e0a 2020 2020  e supplied..    
-00011a30: 2020 2020 3a70 6172 616d 2062 6f6f 6c20      :param bool 
-00011a40: 6a75 7374 5f6f 626a 3a20 4120 626f 6f6c  just_obj: A bool
-00011a50: 6561 6e20 666c 6167 2074 6861 7420 636f  ean flag that co
-00011a60: 6e74 726f 6c73 2077 6865 7468 6572 2074  ntrols whether t
-00011a70: 6869 7320 6d65 7468 6f64 2072 6574 7572  his method retur
-00011a80: 6e73 206a 7573 7420 7468 6520 7072 6f64  ns just the prod
-00011a90: 7563 7420 6f62 6a65 6374 732c 0a20 2020  uct objects,.   
-00011aa0: 2020 2020 2020 2020 206f 7220 7468 6520           or the 
-00011ab0: 6f74 6865 7220 696e 666f 726d 6174 696f  other informatio
-00011ac0: 6e20 7468 6174 2067 6f65 7320 7769 7468  n that goes with
-00011ad0: 2069 7420 6c69 6b65 204f 6273 4944 2061   it like ObsID a
-00011ae0: 6e64 2069 6e73 7472 756d 656e 742e 0a20  nd instrument.. 
-00011af0: 2020 2020 2020 203a 7265 7475 726e 3a20         :return: 
-00011b00: 4c69 7374 206f 6620 6d61 7463 6869 6e67  List of matching
-00011b10: 2070 726f 6475 6374 732e 0a20 2020 2020   products..     
-00011b20: 2020 203a 7274 7970 653a 204c 6973 745b     :rtype: List[
-00011b30: 4261 7365 5072 6f64 7563 745d 0a20 2020  BaseProduct].   
-00011b40: 2020 2020 2022 2222 0a0a 2020 2020 2020       """..      
-00011b50: 2020 6465 6620 756e 7061 636b 5f6c 6973    def unpack_lis
-00011b60: 7428 746f 5f75 6e70 6163 6b3a 206c 6973  t(to_unpack: lis
-00011b70: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
-00011b80: 2222 220a 2020 2020 2020 2020 2020 2020  """.            
-00011b90: 4120 7265 6375 7273 6976 6520 6675 6e63  A recursive func
-00011ba0: 7469 6f6e 2074 6f20 676f 2074 6872 6f75  tion to go throu
-00011bb0: 6768 2065 7665 7279 206c 6179 6572 206f  gh every layer o
-00011bc0: 6620 6120 6e65 7374 6564 206c 6973 7420  f a nested list 
-00011bd0: 616e 6420 666c 6174 7465 6e20 6974 2061  and flatten it a
-00011be0: 6c6c 206f 7574 2e20 4974 0a20 2020 2020  ll out. It.     
-00011bf0: 2020 2020 2020 2064 6f65 736e 2774 2072         doesn't r
-00011c00: 6574 7572 6e20 616e 7974 6869 6e67 2062  eturn anything b
-00011c10: 6563 6175 7365 2074 6f20 6d61 6b65 206c  ecause to make l
-00011c20: 6966 6520 6561 7369 6572 2074 6865 2027  ife easier the '
-00011c30: 7265 7375 6c74 7327 2061 7265 2061 7070  results' are app
-00011c40: 656e 6465 6420 746f 2061 2076 6172 6961  ended to a varia
-00011c50: 626c 650a 2020 2020 2020 2020 2020 2020  ble.            
-00011c60: 696e 2074 6865 206e 616d 6573 7061 6365  in the namespace
-00011c70: 2061 626f 7665 2074 6869 7320 6f6e 652e   above this one.
-00011c80: 0a0a 2020 2020 2020 2020 2020 2020 3a70  ..            :p
-00011c90: 6172 616d 206c 6973 7420 746f 5f75 6e70  aram list to_unp
-00011ca0: 6163 6b3a 2054 6865 206c 6973 7420 7468  ack: The list th
-00011cb0: 6174 206e 6565 6473 2075 6e70 6163 6b69  at needs unpacki
-00011cc0: 6e67 2e0a 2020 2020 2020 2020 2020 2020  ng..            
-00011cd0: 2222 220a 2020 2020 2020 2020 2020 2020  """.            
-00011ce0: 2320 4d75 7374 2069 7465 7261 7465 2074  # Must iterate t
-00011cf0: 6872 6f75 6768 2074 6865 2067 6976 656e  hrough the given
-00011d00: 206c 6973 740a 2020 2020 2020 2020 2020   list.          
-00011d10: 2020 666f 7220 656e 7472 7920 696e 2074    for entry in t
-00011d20: 6f5f 756e 7061 636b 3a0a 2020 2020 2020  o_unpack:.      
-00011d30: 2020 2020 2020 2020 2020 2320 4966 2074            # If t
-00011d40: 6865 2063 7572 7265 6e74 2065 6c65 6d65  he current eleme
-00011d50: 6e74 2069 7320 6e6f 7420 6120 6c69 7374  nt is not a list
-00011d60: 2074 6865 6e20 616c 6c20 6973 2063 6869   then all is chi
-00011d70: 6c6c 2c20 7468 6973 2065 6c65 6d65 6e74  ll, this element
-00011d80: 2069 7320 7265 6164 7920 666f 7220 6170   is ready for ap
-00011d90: 7065 6e64 696e 670a 2020 2020 2020 2020  pending.        
-00011da0: 2020 2020 2020 2020 2320 746f 2074 6865          # to the
-00011db0: 2066 696e 616c 206c 6973 740a 2020 2020   final list.    
-00011dc0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-00011dd0: 6f74 2069 7369 6e73 7461 6e63 6528 656e  ot isinstance(en
-00011de0: 7472 792c 206c 6973 7429 3a0a 2020 2020  try, list):.    
-00011df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011e00: 6f75 742e 6170 7065 6e64 2865 6e74 7279  out.append(entry
-00011e10: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00011e20: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00011e30: 2020 2020 2020 2020 2020 2020 2320 4966              # If
-00011e40: 2074 6865 2063 7572 7265 6e74 2065 6c65   the current ele
-00011e50: 6d65 6e74 2049 5320 6120 6c69 7374 2c20  ment IS a list, 
-00011e60: 7468 656e 206f 6276 696f 7573 6c79 2077  then obviously w
-00011e70: 6520 7374 696c 6c20 6861 7665 206d 6f72  e still have mor
-00011e80: 6520 756e 7061 636b 696e 6720 746f 2064  e unpacking to d
-00011e90: 6f2c 0a20 2020 2020 2020 2020 2020 2020  o,.             
-00011ea0: 2020 2020 2020 2023 2073 6f20 7765 2063         # so we c
-00011eb0: 616c 6c20 7468 6973 2066 756e 6374 696f  all this functio
-00011ec0: 6e20 7265 6375 7273 6976 656c 792e 0a20  n recursively.. 
-00011ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011ee0: 2020 2075 6e70 6163 6b5f 6c69 7374 2865     unpack_list(e
-00011ef0: 6e74 7279 290a 0a20 2020 2020 2020 2069  ntry)..        i
-00011f00: 6620 6f62 735f 6964 206e 6f74 2069 6e20  f obs_id not in 
-00011f10: 7365 6c66 2e5f 7072 6f64 7563 7473 2061  self._products a
-00011f20: 6e64 206f 6273 5f69 6420 6973 206e 6f74  nd obs_id is not
-00011f30: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00011f40: 2020 2072 6169 7365 204e 6f74 4173 736f     raise NotAsso
-00011f50: 6369 6174 6564 4572 726f 7228 227b 307d  ciatedError("{0}
-00011f60: 2069 7320 6e6f 7420 6173 736f 6369 6174   is not associat
-00011f70: 6564 2077 6974 6820 7b31 7d20 2e22 2e66  ed with {1} .".f
-00011f80: 6f72 6d61 7428 6f62 735f 6964 2c20 7365  ormat(obs_id, se
-00011f90: 6c66 2e6e 616d 6529 290a 2020 2020 2020  lf.name)).      
-00011fa0: 2020 656c 6966 2028 6f62 735f 6964 2069    elif (obs_id i
-00011fb0: 7320 6e6f 7420 4e6f 6e65 2061 6e64 206f  s not None and o
-00011fc0: 6273 5f69 6420 696e 2073 656c 662e 5f70  bs_id in self._p
-00011fd0: 726f 6475 6374 7329 2061 6e64 205c 0a20  roducts) and \. 
-00011fe0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00011ff0: 696e 7374 2069 7320 6e6f 7420 4e6f 6e65  inst is not None
-00012000: 2061 6e64 2069 6e73 7420 6e6f 7420 696e   and inst not in
-00012010: 2073 656c 662e 5f70 726f 6475 6374 735b   self._products[
-00012020: 6f62 735f 6964 5d29 3a0a 2020 2020 2020  obs_id]):.      
-00012030: 2020 2020 2020 7261 6973 6520 4e6f 7441        raise NotA
-00012040: 7373 6f63 6961 7465 6445 7272 6f72 2822  ssociatedError("
-00012050: 7b30 7d20 6973 2061 7373 6f63 6961 7465  {0} is associate
-00012060: 6420 7769 7468 207b 317d 2c20 6275 7420  d with {1}, but 
-00012070: 7b32 7d20 6973 206e 6f74 2061 7373 6f63  {2} is not assoc
-00012080: 6961 7465 6420 7769 7468 2074 6861 7420  iated with that 
-00012090: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-000120a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000120b0: 2020 2020 2020 2022 6f62 7365 7276 6174         "observat
-000120c0: 696f 6e22 2e66 6f72 6d61 7428 6f62 735f  ion".format(obs_
-000120d0: 6964 2c20 7365 6c66 2e6e 616d 652c 2069  id, self.name, i
-000120e0: 6e73 7429 290a 0a20 2020 2020 2020 206d  nst))..        m
-000120f0: 6174 6368 6573 203d 205b 5d0a 2020 2020  atches = [].    
-00012100: 2020 2020 2320 4974 6572 6174 6573 2074      # Iterates t
-00012110: 6872 6f75 6768 2074 6865 2064 6963 7420  hrough the dict 
-00012120: 7365 6172 6368 2072 6574 7572 6e2c 2062  search return, b
-00012130: 7574 2065 6163 6820 6d61 7463 6820 6973  ut each match is
-00012140: 206c 696b 656c 7920 746f 2062 6520 6120   likely to be a 
-00012150: 7665 7279 206e 6573 7465 6420 6c69 7374  very nested list
-00012160: 2c0a 2020 2020 2020 2020 2320 7769 7468  ,.        # with
-00012170: 2074 6865 2064 6567 7265 6520 6f66 206e   the degree of n
-00012180: 6573 7469 6e67 2064 6570 656e 6461 6e74  esting dependant
-00012190: 206f 6e20 7072 6f64 7563 7420 7479 7065   on product type
-000121a0: 2028 6173 2065 7665 6e74 206c 6973 7473   (as event lists
-000121b0: 206c 6976 6520 6120 6c65 7665 6c20 7570   live a level up
-000121c0: 2066 726f 6d0a 2020 2020 2020 2020 2320   from.        # 
-000121d0: 696d 6167 6573 2066 6f72 2069 6e73 7461  images for insta
-000121e0: 6e63 650a 2020 2020 2020 2020 666f 7220  nce.        for 
-000121f0: 6d61 7463 6820 696e 2064 6963 745f 7365  match in dict_se
-00012200: 6172 6368 2870 5f74 7970 652c 2073 656c  arch(p_type, sel
-00012210: 662e 5f70 726f 6475 6374 7329 3a0a 2020  f._products):.  
-00012220: 2020 2020 2020 2020 2020 6f75 7420 3d20            out = 
-00012230: 5b5d 0a20 2020 2020 2020 2020 2020 2075  [].            u
-00012240: 6e70 6163 6b5f 6c69 7374 286d 6174 6368  npack_list(match
-00012250: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
-00012260: 4f6e 6c79 2061 7070 656e 6473 2069 6620  Only appends if 
-00012270: 7468 6973 2070 6172 7469 6375 6c61 7220  this particular 
-00012280: 6d61 7463 6820 6973 2066 6f72 2074 6865  match is for the
-00012290: 206f 6273 5f69 6420 616e 6420 696e 7374   obs_id and inst
-000122a0: 7275 6d65 6e74 2070 6173 7365 6420 746f  rument passed to
-000122b0: 2074 6869 7320 6d65 7468 6f64 0a20 2020   this method.   
-000122c0: 2020 2020 2020 2020 2023 2054 686f 7567           # Thoug
-000122d0: 6820 616c 6c20 6d61 7463 6865 7320 7769  h all matches wi
-000122e0: 6c6c 2062 6520 7265 7475 726e 6564 2069  ll be returned i
-000122f0: 6620 6e6f 206f 6273 5f69 642f 696e 7374  f no obs_id/inst
-00012300: 2069 7320 7061 7373 6564 0a20 2020 2020   is passed.     
-00012310: 2020 2020 2020 2069 6620 286f 6273 5f69         if (obs_i
-00012320: 6420 3d3d 206f 7574 5b30 5d20 6f72 206f  d == out[0] or o
-00012330: 6273 5f69 6420 6973 204e 6f6e 6529 2061  bs_id is None) a
-00012340: 6e64 2028 696e 7374 203d 3d20 6f75 745b  nd (inst == out[
-00012350: 315d 206f 7220 696e 7374 2069 7320 4e6f  1] or inst is No
-00012360: 6e65 2920 5c0a 2020 2020 2020 2020 2020  ne) \.          
-00012370: 2020 2020 2020 2020 2020 616e 6420 2865            and (e
-00012380: 7874 7261 5f6b 6579 2069 6e20 6f75 7420  xtra_key in out 
-00012390: 6f72 2065 7874 7261 5f6b 6579 2069 7320  or extra_key is 
-000123a0: 4e6f 6e65 2920 616e 6420 6e6f 7420 6a75  None) and not ju
-000123b0: 7374 5f6f 626a 3a0a 2020 2020 2020 2020  st_obj:.        
-000123c0: 2020 2020 2020 2020 6d61 7463 6865 732e          matches.
-000123d0: 6170 7065 6e64 286f 7574 290a 2020 2020  append(out).    
-000123e0: 2020 2020 2020 2020 656c 6966 2028 6f62          elif (ob
-000123f0: 735f 6964 203d 3d20 6f75 745b 305d 206f  s_id == out[0] o
-00012400: 7220 6f62 735f 6964 2069 7320 4e6f 6e65  r obs_id is None
-00012410: 2920 616e 6420 2869 6e73 7420 3d3d 206f  ) and (inst == o
-00012420: 7574 5b31 5d20 6f72 2069 6e73 7420 6973  ut[1] or inst is
-00012430: 204e 6f6e 6529 205c 0a20 2020 2020 2020   None) \.       
-00012440: 2020 2020 2020 2020 2020 2020 2061 6e64               and
-00012450: 2028 6578 7472 615f 6b65 7920 696e 206f   (extra_key in o
-00012460: 7574 206f 7220 6578 7472 615f 6b65 7920  ut or extra_key 
-00012470: 6973 204e 6f6e 6529 2061 6e64 206a 7573  is None) and jus
-00012480: 745f 6f62 6a3a 0a20 2020 2020 2020 2020  t_obj:.         
-00012490: 2020 2020 2020 206d 6174 6368 6573 2e61         matches.a
-000124a0: 7070 656e 6428 6f75 745b 2d31 5d29 0a20  ppend(out[-1]). 
-000124b0: 2020 2020 2020 2072 6574 7572 6e20 6d61         return ma
-000124c0: 7463 6865 730a 0a20 2020 2064 6566 205f  tches..    def _
-000124d0: 6c6f 6164 5f72 6567 696f 6e73 2873 656c  load_regions(sel
-000124e0: 662c 2072 6567 5f70 6174 6873 2920 2d3e  f, reg_paths) ->
-000124f0: 2054 7570 6c65 5b64 6963 742c 2064 6963   Tuple[dict, dic
-00012500: 745d 3a0a 2020 2020 2020 2020 2222 220a  t]:.        """.
-00012510: 2020 2020 2020 2020 416e 2069 6e74 6572          An inter
-00012520: 6e61 6c20 6d65 7468 6f64 2074 6861 7420  nal method that 
-00012530: 7265 6164 7320 616e 6420 7061 7273 6573  reads and parses
-00012540: 2072 6567 696f 6e20 6669 6c65 7320 666f   region files fo
-00012550: 756e 6420 666f 7220 6f62 7365 7276 6174  und for observat
-00012560: 696f 6e73 0a20 2020 2020 2020 2061 7373  ions.        ass
-00012570: 6f63 6961 7465 6420 7769 7468 2074 6869  ociated with thi
-00012580: 7320 736f 7572 6365 2e20 416c 736f 2063  s source. Also c
-00012590: 6f6d 7075 7465 7320 7369 6d70 6c65 206d  omputes simple m
-000125a0: 6174 6368 6573 2074 6f20 6669 6e64 2072  atches to find r
-000125b0: 6567 696f 6e73 206c 696b 656c 790a 2020  egions likely.  
-000125c0: 2020 2020 2020 746f 2062 6520 7265 6c61        to be rela
-000125d0: 7465 6420 746f 2074 6865 2073 6f75 7263  ted to the sourc
-000125e0: 652e 0a0a 2020 2020 2020 2020 3a72 6574  e...        :ret
-000125f0: 7572 6e3a 2054 776f 2064 6963 7469 6f6e  urn: Two diction
-00012600: 6172 6965 732c 2074 6865 2066 6972 7374  aries, the first
-00012610: 2063 6f6e 7461 696e 7320 7468 6520 7265   contains the re
-00012620: 6769 6f6e 7320 666f 7220 6561 6368 206f  gions for each o
-00012630: 6620 7468 6520 4f62 7349 4473 2061 6e64  f the ObsIDs and
-00012640: 2074 6865 2073 6563 6f6e 6420 636f 6e74   the second cont
-00012650: 6169 6e73 0a20 2020 2020 2020 2020 2020  ains.           
-00012660: 2074 6865 2072 6567 696f 6e73 2074 6861   the regions tha
-00012670: 7420 6861 7665 2062 6565 6e20 7665 7279  t have been very
-00012680: 2073 696d 706c 7920 6d61 7463 6865 6420   simply matched 
-00012690: 746f 2074 6865 2073 6f75 7263 652e 2054  to the source. T
-000126a0: 6865 7365 2073 686f 756c 6420 6265 206f  hese should be o
-000126b0: 7264 6572 6564 2066 726f 6d20 636c 6f73  rdered from clos
-000126c0: 6573 7420 746f 0a20 2020 2020 2020 2020  est to.         
-000126d0: 2020 2066 7572 7468 6573 7420 6672 6f6d     furthest from
-000126e0: 2074 6865 2070 6173 7365 6420 736f 7572   the passed sour
-000126f0: 6365 2063 6f6f 7264 696e 6174 6573 2e0a  ce coordinates..
-00012700: 2020 2020 2020 2020 3a72 7479 7065 3a20          :rtype: 
-00012710: 5475 706c 655b 6469 6374 2c20 6469 6374  Tuple[dict, dict
-00012720: 5d0a 2020 2020 2020 2020 2222 220a 0a20  ].        """.. 
-00012730: 2020 2020 2020 2064 6566 2064 6973 745f         def dist_
-00012740: 6672 6f6d 5f73 6f75 7263 6528 7265 6729  from_source(reg)
-00012750: 3a0a 2020 2020 2020 2020 2020 2020 2222  :.            ""
-00012760: 220a 2020 2020 2020 2020 2020 2020 4361  ".            Ca
-00012770: 6c63 756c 6174 6573 2074 6865 2065 7563  lculates the euc
-00012780: 6c69 6465 616e 2064 6973 7461 6e63 6520  lidean distance 
-00012790: 6265 7477 6565 6e20 7468 6520 6365 6e74  between the cent
-000127a0: 7265 206f 6620 6120 7375 7070 6c69 6564  re of a supplied
-000127b0: 2072 6567 696f 6e2c 2061 6e64 2074 6865   region, and the
-000127c0: 0a20 2020 2020 2020 2020 2020 2070 6f73  .            pos
-000127d0: 6974 696f 6e20 6f66 2074 6865 2073 6f75  ition of the sou
-000127e0: 7263 652e 0a0a 2020 2020 2020 2020 2020  rce...          
-000127f0: 2020 3a70 6172 616d 2072 6567 3a20 4120    :param reg: A 
-00012800: 7265 6769 6f6e 206f 626a 6563 742e 0a20  region object.. 
-00012810: 2020 2020 2020 2020 2020 203a 7265 7475             :retu
-00012820: 726e 3a20 4469 7374 616e 6365 2062 6574  rn: Distance bet
-00012830: 7765 656e 2072 6567 696f 6e20 6365 6e74  ween region cent
-00012840: 7265 2061 6e64 2073 6f75 7263 6520 706f  re and source po
-00012850: 7369 7469 6f6e 2e0a 2020 2020 2020 2020  sition..        
-00012860: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00012870: 2020 2020 7261 203d 2072 6567 2e63 656e      ra = reg.cen
-00012880: 7465 722e 7261 2e76 616c 7565 0a20 2020  ter.ra.value.   
-00012890: 2020 2020 2020 2020 2064 6563 203d 2072           dec = r
-000128a0: 6567 2e63 656e 7465 722e 6465 632e 7661  eg.center.dec.va
-000128b0: 6c75 650a 2020 2020 2020 2020 2020 2020  lue.            
-000128c0: 7265 7475 726e 206e 702e 7371 7274 2861  return np.sqrt(a
-000128d0: 6273 2872 6120 2d20 7365 6c66 2e5f 7261  bs(ra - self._ra
-000128e0: 5f64 6563 5b30 5d29 202a 2a20 3220 2b20  _dec[0]) ** 2 + 
-000128f0: 6162 7328 6465 6320 2d20 7365 6c66 2e5f  abs(dec - self._
-00012900: 7261 5f64 6563 5b31 5d29 202a 2a20 3229  ra_dec[1]) ** 2)
-00012910: 0a0a 2020 2020 2020 2020 2320 5265 6164  ..        # Read
-00012920: 2069 6e20 7468 6520 6375 7374 6f6d 2072   in the custom r
-00012930: 6567 696f 6e20 6669 6c65 2074 6861 7420  egion file that 
-00012940: 6576 6572 7920 5847 4120 6861 7320 6173  every XGA has as
-00012950: 736f 6369 6174 6564 2077 6974 6820 6974  sociated with it
-00012960: 2e20 536f 7572 6365 7320 7769 7468 696e  . Sources within
-00012970: 2077 696c 6c20 6265 2061 6464 6564 2074   will be added t
-00012980: 6f20 7468 650a 2020 2020 2020 2020 2320  o the.        # 
-00012990: 2073 6f75 7263 6520 6c69 7374 2066 6f72   source list for
-000129a0: 2065 7665 7279 204f 6273 4944 3f0a 2020   every ObsID?.  
-000129b0: 2020 2020 2020 6375 7374 6f6d 5f72 6567        custom_reg
-000129c0: 7320 3d20 7265 6164 5f64 7339 284f 5554  s = read_ds9(OUT
-000129d0: 5055 5420 2b20 2272 6567 696f 6e73 2f7b  PUT + "regions/{
-000129e0: 307d 2f7b 307d 5f63 7573 746f 6d2e 7265  0}/{0}_custom.re
-000129f0: 6722 2e66 6f72 6d61 7428 7365 6c66 2e6e  g".format(self.n
-00012a00: 616d 6529 290a 2020 2020 2020 2020 666f  ame)).        fo
-00012a10: 7220 7265 6720 696e 2063 7573 746f 6d5f  r reg in custom_
-00012a20: 7265 6773 3a0a 2020 2020 2020 2020 2020  regs:.          
-00012a30: 2020 6966 206e 6f74 2069 7369 6e73 7461    if not isinsta
-00012a40: 6e63 6528 7265 672c 2053 6b79 5265 6769  nce(reg, SkyRegi
-00012a50: 6f6e 293a 0a20 2020 2020 2020 2020 2020  on):.           
-00012a60: 2020 2020 2072 6169 7365 2054 7970 6545       raise TypeE
-00012a70: 7272 6f72 2822 4375 7374 6f6d 2073 6f75  rror("Custom sou
-00012a80: 7263 6573 2063 616e 206f 6e6c 7920 6265  rces can only be
-00012a90: 2064 6566 696e 6564 2069 6e20 5241 2d44   defined in RA-D
-00012aa0: 6563 2063 6f6f 7264 696e 6174 6573 2e22  ec coordinates."
-00012ab0: 290a 0a20 2020 2020 2020 2072 6567 5f64  )..        reg_d
-00012ac0: 6963 7420 3d20 7b7d 0a20 2020 2020 2020  ict = {}.       
-00012ad0: 206d 6174 6368 5f64 6963 7420 3d20 7b7d   match_dict = {}
-00012ae0: 0a20 2020 2020 2020 2023 2041 7320 7765  .        # As we
-00012af0: 206f 6e6c 7920 616c 6c6f 7720 6f6e 6520   only allow one 
-00012b00: 7365 7420 6f66 2072 6567 696f 6e73 2070  set of regions p
-00012b10: 6572 206f 6273 6572 7661 7469 6f6e 2c20  er observation, 
-00012b20: 7765 2073 6861 6c6c 2061 7373 756d 6520  we shall assume 
-00012b30: 7468 6174 2077 6520 6361 6e20 7573 6520  that we can use 
-00012b40: 7468 650a 2020 2020 2020 2020 2320 5743  the.        # WC
-00012b50: 5320 7472 616e 7366 6f72 6d20 6672 6f6d  S transform from
-00012b60: 2041 4e59 206f 6620 7468 6520 696d 6167   ANY of the imag
-00012b70: 6573 2074 6f20 636f 6e76 6572 7420 7069  es to convert pi
-00012b80: 7865 6c73 2074 6f20 6465 6772 6565 730a  xels to degrees.
-00012b90: 0a20 2020 2020 2020 2066 6f72 206f 6273  .        for obs
-00012ba0: 5f69 6420 696e 2072 6567 5f70 6174 6873  _id in reg_paths
-00012bb0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00012bc0: 2072 6567 5f70 6174 6873 5b6f 6273 5f69   reg_paths[obs_i
-00012bd0: 645d 2069 7320 6e6f 7420 4e6f 6e65 3a0a  d] is not None:.
-00012be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012bf0: 6473 395f 7265 6773 203d 2072 6561 645f  ds9_regs = read_
-00012c00: 6473 3928 7265 675f 7061 7468 735b 6f62  ds9(reg_paths[ob
-00012c10: 735f 6964 5d29 0a20 2020 2020 2020 2020  s_id]).         
-00012c20: 2020 2020 2020 2023 2047 7261 6220 616c         # Grab al
-00012c30: 6c20 696d 6167 6573 2066 6f72 2074 6865  l images for the
-00012c40: 204f 6273 4944 2c20 696e 7374 7275 6d65   ObsID, instrume
-00012c50: 6e74 7320 6163 726f 7373 2061 6e20 4f62  nts across an Ob
-00012c60: 7349 4420 6861 7665 2074 6865 2073 616d  sID have the sam
-00012c70: 6520 5743 5320 286f 7468 6572 2074 6861  e WCS (other tha
-00012c80: 6e20 696e 2063 6173 6573 0a20 2020 2020  n in cases.     
-00012c90: 2020 2020 2020 2020 2020 2023 2020 7768             #  wh
-00012ca0: 6572 6520 7468 6579 2077 6572 6520 6765  ere they were ge
-00012cb0: 6e65 7261 7465 6420 7769 7468 2064 6966  nerated with dif
-00012cc0: 6665 7265 6e74 2072 6573 6f6c 7574 696f  ferent resolutio
-00012cd0: 6e73 292e 0a20 2020 2020 2020 2020 2020  ns)..           
-00012ce0: 2020 2020 2023 2020 544f 444f 2073 6565       #  TODO see
-00012cf0: 2069 7373 7565 2023 3930 382c 2066 6967   issue #908, fig
-00012d00: 7572 6520 6f75 7420 686f 7720 746f 2073  ure out how to s
-00012d10: 7570 706f 7274 2064 6966 6665 7265 6e74  upport different
-00012d20: 2072 6573 6f6c 7574 696f 6e73 206f 6620   resolutions of 
-00012d30: 696d 6167 650a 2020 2020 2020 2020 2020  image.          
-00012d40: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-00012d50: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00012d60: 6d73 203d 2073 656c 662e 6765 745f 696d  ms = self.get_im
-00012d70: 6167 6573 286f 6273 5f69 6429 0a20 2020  ages(obs_id).   
-00012d80: 2020 2020 2020 2020 2020 2020 2065 7863               exc
-00012d90: 6570 7420 4e6f 5072 6f64 7563 7441 7661  ept NoProductAva
-00012da0: 696c 6162 6c65 4572 726f 723a 0a20 2020  ilableError:.   
-00012db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012dc0: 2072 6169 7365 204e 6f50 726f 6475 6374   raise NoProduct
-00012dd0: 4176 6169 6c61 626c 6545 7272 6f72 2822  AvailableError("
-00012de0: 5468 6572 6520 6973 206e 6f20 696d 6167  There is no imag
-00012df0: 6520 6176 6169 6c61 626c 6520 666f 7220  e available for 
-00012e00: 6f62 7365 7276 6174 696f 6e20 7b6f 7d2c  observation {o},
-00012e10: 2061 7373 6f63 6961 7465 6420 220a 2020   associated ".  
-00012e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012e50: 2277 6974 6820 7b6e 7d2e 2041 6e20 696d  "with {n}. An im
-00012e60: 6167 6520 6973 2063 7572 7265 6e74 6c79  age is currently
-00012e70: 2072 6571 7569 7265 6420 746f 2063 6865   required to che
-00012e80: 636b 2066 6f72 2073 6b79 2022 0a20 2020  ck for sky ".   
-00012e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012eb0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00012ec0: 636f 6f72 6469 6e61 7465 7320 6265 696e  coordinates bein
-00012ed0: 6720 7072 6573 656e 7420 7769 7468 696e  g present within
-00012ee0: 2061 2073 6b79 2072 6567 696f 6e20 2d20   a sky region - 
-00012ef0: 7468 6f75 6768 2068 6f70 6566 756c 6c79  though hopefully
-00012f00: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-00012f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012f30: 2020 2020 2022 6e6f 2d6f 6e65 2077 696c       "no-one wil
-00012f40: 6c20 6576 6572 2073 6565 2074 6869 7320  l ever see this 
-00012f50: 6265 6361 7573 6520 4927 6c6c 2068 6176  because I'll hav
-00012f60: 6520 6669 7865 6420 220a 2020 2020 2020  e fixed ".      
-00012f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012f90: 2020 2020 2020 2020 2020 2020 2269 7421              "it!
-00012fa0: 222e 666f 726d 6174 286f 3d6f 6273 5f69  ".format(o=obs_i
-00012fb0: 642c 206e 3d73 656c 662e 6e61 6d65 2929  d, n=self.name))
-00012fc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012fd0: 2020 2020 2077 203d 204e 6f6e 650a 2020       w = None.  
-00012fe0: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00012ff0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00013000: 2020 2020 2020 2020 7720 3d20 696d 735b          w = ims[
-00013010: 305d 2e72 6164 6563 5f77 6373 0a20 2020  0].radec_wcs.   
-00013020: 2020 2020 2020 2020 2020 2020 2023 2041               # A
-00013030: 7070 6172 656e 746c 7920 6361 6e20 6861  pparently can ha
-00013040: 7070 656e 2074 6861 7420 7468 6572 6520  ppen that there 
-00013050: 6172 6520 6e6f 2072 6567 696f 6e73 2069  are no regions i
-00013060: 6e20 6120 7265 6769 6f6e 2066 696c 652c  n a region file,
-00013070: 2073 6f20 6966 2074 6861 7420 6973 2074   so if that is t
-00013080: 6865 2063 6173 650a 2020 2020 2020 2020  he case.        
-00013090: 2020 2020 2020 2020 2320 2074 6865 6e20          #  then 
-000130a0: 4920 6a75 7374 2073 6574 2074 6865 2064  I just set the d
-000130b0: 7339 5f72 6567 7320 746f 205b 4e6f 6e65  s9_regs to [None
-000130c0: 5d20 6265 6361 7573 6520 4920 6b6e 6f77  ] because I know
-000130d0: 2074 6865 2072 6573 7420 6f66 2074 6865   the rest of the
-000130e0: 2063 6f64 6520 6361 6e20 6465 616c 2077   code can deal w
-000130f0: 6974 6820 7468 6174 2e0a 2020 2020 2020  ith that..      
-00013100: 2020 2020 2020 2020 2020 2320 2049 7420            #  It 
-00013110: 6361 6e27 7420 6465 616c 2077 6974 6820  can't deal with 
-00013120: 616e 2065 6d70 7479 206c 6973 740a 2020  an empty list.  
-00013130: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00013140: 206c 656e 2864 7339 5f72 6567 7329 203d   len(ds9_regs) =
-00013150: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
-00013160: 2020 2020 2020 2020 2064 7339 5f72 6567           ds9_reg
-00013170: 7320 3d20 5b4e 6f6e 655d 0a20 2020 2020  s = [None].     
-00013180: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00013190: 2020 2020 2020 2020 2020 2020 2064 7339               ds9
-000131a0: 5f72 6567 7320 3d20 5b4e 6f6e 655d 0a0a  _regs = [None]..
-000131b0: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-000131c0: 7369 6e73 7461 6e63 6528 6473 395f 7265  sinstance(ds9_re
-000131d0: 6773 5b30 5d2c 2050 6978 656c 5265 6769  gs[0], PixelRegi
-000131e0: 6f6e 293a 0a20 2020 2020 2020 2020 2020  on):.           
-000131f0: 2020 2020 2023 2049 6620 7265 6769 6f6e       # If region
-00013200: 7320 6578 6973 7420 696e 2070 6978 656c  s exist in pixel
-00013210: 2063 6f6f 7264 696e 6174 6573 2c20 7765   coordinates, we
-00013220: 206e 6565 6420 616e 2069 6d61 6765 2057   need an image W
-00013230: 4353 2074 6f20 636f 6e76 6572 7420 7468  CS to convert th
-00013240: 656d 2074 6f20 5241 2d44 4543 2c20 736f  em to RA-DEC, so
-00013250: 2077 6520 6e65 6564 0a20 2020 2020 2020   we need.       
-00013260: 2020 2020 2020 2020 2023 2020 6f6e 6520           #  one 
-00013270: 6f66 2074 6865 2069 6d61 6765 7320 7375  of the images su
-00013280: 7070 6c69 6564 2069 6e20 7468 6520 636f  pplied in the co
-00013290: 6e66 6967 2066 696c 652c 206e 6f74 2061  nfig file, not a
-000132a0: 6e79 7468 696e 6720 7468 6174 2058 4741  nything that XGA
-000132b0: 2067 656e 6572 6174 6573 2e0a 2020 2020   generates..    
-000132c0: 2020 2020 2020 2020 2020 2020 2320 2042              #  B
-000132d0: 7574 2061 7320 7468 6973 206d 6574 686f  ut as this metho
-000132e0: 6420 6973 206f 6e6c 7920 7275 6e20 6f6e  d is only run on
-000132f0: 6365 2c20 6265 666f 7265 2058 4741 2067  ce, before XGA g
-00013300: 656e 6572 6174 6564 2070 726f 6475 6374  enerated product
-00013310: 7320 6172 6520 6c6f 6164 6564 2069 6e2c  s are loaded in,
-00013320: 2069 740a 2020 2020 2020 2020 2020 2020   it.            
-00013330: 2020 2020 2320 2073 686f 756c 6420 6265      #  should be
-00013340: 2066 696e 650a 2020 2020 2020 2020 2020   fine.          
-00013350: 2020 2020 2020 6966 2077 2069 7320 4e6f        if w is No
-00013360: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00013370: 2020 2020 2020 2020 7261 6973 6520 4e6f          raise No
-00013380: 5072 6f64 7563 7441 7661 696c 6162 6c65  ProductAvailable
-00013390: 4572 726f 7228 2254 6865 7265 2069 7320  Error("There is 
-000133a0: 6e6f 2069 6d61 6765 2061 7661 696c 6162  no image availab
-000133b0: 6c65 2066 6f72 206f 6273 6572 7661 7469  le for observati
-000133c0: 6f6e 207b 6f7d 2c20 6173 736f 6369 6174  on {o}, associat
-000133d0: 6564 2022 0a20 2020 2020 2020 2020 2020  ed ".           
-000133e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000133f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013400: 2020 2020 2020 2022 7769 7468 207b 6e7d         "with {n}
-00013410: 2e20 416e 2069 6d61 6765 2069 7320 6375  . An image is cu
-00013420: 7272 656e 746c 7920 7265 7175 6972 6564  rrently required
-00013430: 2074 6f20 7472 616e 736c 6174 6520 7069   to translate pi
-00013440: 7865 6c20 7265 6769 6f6e 7320 220a 2020  xel regions ".  
-00013450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013480: 2274 6f20 5241 2d44 4543 2e22 2e66 6f72  "to RA-DEC.".for
-00013490: 6d61 7428 6f3d 6f62 735f 6964 2c20 6e3d  mat(o=obs_id, n=
-000134a0: 7365 6c66 2e6e 616d 6529 290a 0a20 2020  self.name))..   
-000134b0: 2020 2020 2020 2020 2020 2020 2073 6b79               sky
-000134c0: 5f72 6567 7320 3d20 5b72 6567 2e74 6f5f  _regs = [reg.to_
-000134d0: 736b 7928 7729 2066 6f72 2072 6567 2069  sky(w) for reg i
-000134e0: 6e20 6473 395f 7265 6773 5d0a 2020 2020  n ds9_regs].    
-000134f0: 2020 2020 2020 2020 2020 2020 7265 675f              reg_
-00013500: 6469 6374 5b6f 6273 5f69 645d 203d 206e  dict[obs_id] = n
-00013510: 702e 6172 7261 7928 736b 795f 7265 6773  p.array(sky_regs
-00013520: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
-00013530: 6966 2069 7369 6e73 7461 6e63 6528 6473  if isinstance(ds
-00013540: 395f 7265 6773 5b30 5d2c 2053 6b79 5265  9_regs[0], SkyRe
-00013550: 6769 6f6e 293a 0a20 2020 2020 2020 2020  gion):.         
-00013560: 2020 2020 2020 2072 6567 5f64 6963 745b         reg_dict[
-00013570: 6f62 735f 6964 5d20 3d20 6e70 2e61 7272  obs_id] = np.arr
-00013580: 6179 2864 7339 5f72 6567 7329 0a20 2020  ay(ds9_regs).   
-00013590: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-000135a0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000135b0: 2053 6f20 7468 6572 6520 6973 2061 6e20   So there is an 
-000135c0: 656e 7472 7920 696e 2074 6869 7320 666f  entry in this fo
-000135d0: 7220 4556 4552 5920 4f62 7349 440a 2020  r EVERY ObsID.  
-000135e0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-000135f0: 675f 6469 6374 5b6f 6273 5f69 645d 203d  g_dict[obs_id] =
-00013600: 206e 702e 6172 7261 7928 5b4e 6f6e 655d   np.array([None]
-00013610: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
-00013620: 2048 6572 6520 7765 2061 6464 2074 6865   Here we add the
-00013630: 2063 7573 746f 6d20 736f 7572 6365 7320   custom sources 
-00013640: 746f 2074 6865 2073 6f75 7263 6520 6c69  to the source li
-00013650: 7374 2c20 7765 206b 6e6f 7720 7468 6579  st, we know they
-00013660: 2061 7265 2073 6b79 2072 6567 696f 6e73   are sky regions
-00013670: 2061 7320 7765 2068 6176 650a 2020 2020   as we have.    
-00013680: 2020 2020 2020 2020 2320 2061 6c72 6561          #  alrea
-00013690: 6479 2065 6e66 6f72 6365 6420 6974 2e20  dy enforced it. 
-000136a0: 4966 2074 6865 7265 2077 6173 206e 6f20  If there was no 
-000136b0: 7265 6769 6f6e 206c 6973 7420 666f 7220  region list for 
-000136c0: 6120 7061 7274 6963 756c 6172 204f 6273  a particular Obs
-000136d0: 4944 2028 6465 7465 6374 6564 2062 7920  ID (detected by 
-000136e0: 7468 6520 6669 7273 740a 2020 2020 2020  the first.      
-000136f0: 2020 2020 2020 2320 2065 6e74 7279 2069        #  entry i
-00013700: 6e20 7468 6520 7265 6720 6469 6374 2062  n the reg dict b
-00013710: 6569 6e67 204e 6f6e 6529 2061 6e64 2074  eing None) and t
-00013720: 6865 7265 2049 5320 6120 6375 7374 6f6d  here IS a custom
-00013730: 2072 6567 696f 6e2c 2077 6520 6a75 7374   region, we just
-00013740: 2072 6570 6c61 6365 2074 6865 204e 6f6e   replace the Non
-00013750: 6520 7769 7468 2074 6865 0a20 2020 2020  e with the.     
-00013760: 2020 2020 2020 2023 2020 6375 7374 6f6d         #  custom
-00013770: 2072 6567 696f 6e0a 2020 2020 2020 2020   region.        
-00013780: 2020 2020 6966 2072 6567 5f64 6963 745b      if reg_dict[
-00013790: 6f62 735f 6964 5d5b 305d 2069 7320 6e6f  obs_id][0] is no
-000137a0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-000137b0: 2020 2020 2020 2020 7265 675f 6469 6374          reg_dict
-000137c0: 5b6f 6273 5f69 645d 203d 206e 702e 6170  [obs_id] = np.ap
-000137d0: 7065 6e64 2872 6567 5f64 6963 745b 6f62  pend(reg_dict[ob
-000137e0: 735f 6964 5d2c 2063 7573 746f 6d5f 7265  s_id], custom_re
-000137f0: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
-00013800: 656c 6966 2072 6567 5f64 6963 745b 6f62  elif reg_dict[ob
-00013810: 735f 6964 5d5b 305d 2069 7320 4e6f 6e65  s_id][0] is None
-00013820: 2061 6e64 206c 656e 2863 7573 746f 6d5f   and len(custom_
-00013830: 7265 6773 2920 213d 2030 3a0a 2020 2020  regs) != 0:.    
-00013840: 2020 2020 2020 2020 2020 2020 7265 675f              reg_
-00013850: 6469 6374 5b6f 6273 5f69 645d 203d 2063  dict[obs_id] = c
-00013860: 7573 746f 6d5f 7265 6773 0a20 2020 2020  ustom_regs.     
-00013870: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00013880: 2020 2020 2020 2020 2020 2020 2072 6567               reg
-00013890: 5f64 6963 745b 6f62 735f 6964 5d20 3d20  _dict[obs_id] = 
-000138a0: 6e70 2e61 7272 6179 285b 4e6f 6e65 5d29  np.array([None])
-000138b0: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-000138c0: 4927 6d20 676f 696e 6720 746f 2065 6e73  I'm going to ens
-000138d0: 7572 6520 7468 6174 2061 6c6c 2072 6567  ure that all reg
-000138e0: 696f 6e73 2061 7265 2065 6c6c 6970 7469  ions are ellipti
-000138f0: 6361 6c2c 2049 2064 6f6e 2774 2077 616e  cal, I don't wan
-00013900: 7420 746f 2068 756e 7420 7468 726f 7567  t to hunt throug
-00013910: 6820 6576 6572 7920 706c 6163 6520 696e  h every place in
-00013920: 2058 4741 0a20 2020 2020 2020 2020 2020   XGA.           
-00013930: 2023 2020 7768 6572 6520 4920 6d61 6465   #  where I made
-00013940: 2074 6861 7420 6173 7375 6d70 7469 6f6e   that assumption
-00013950: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00013960: 2072 6567 5f69 6e64 2c20 7265 6720 696e   reg_ind, reg in
-00013970: 2065 6e75 6d65 7261 7465 2872 6567 5f64   enumerate(reg_d
-00013980: 6963 745b 6f62 735f 6964 5d29 3a0a 2020  ict[obs_id]):.  
-00013990: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000139a0: 2069 7369 6e73 7461 6e63 6528 7265 672c   isinstance(reg,
-000139b0: 2043 6972 636c 6553 6b79 5265 6769 6f6e   CircleSkyRegion
-000139c0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-000139d0: 2020 2020 2020 2023 204d 756c 7469 706c         # Multipl
-000139e0: 7920 7261 6469 6920 6279 2074 776f 2062  y radii by two b
-000139f0: 6563 6175 7365 2074 6865 2065 6c6c 6970  ecause the ellip
-00013a00: 7365 2062 6173 6564 2073 6f75 7263 6573  se based sources
-00013a10: 2077 616e 7420 4845 4947 4854 2061 6e64   want HEIGHT and
-00013a20: 2057 4944 5448 2c20 6e6f 7420 5241 4449   WIDTH, not RADI
-00013a30: 5553 0a20 2020 2020 2020 2020 2020 2020  US.             
-00013a40: 2020 2020 2020 2023 2047 6976 6520 736d         # Give sm
-00013a50: 616c 6c20 616e 676c 6520 2874 686f 7567  all angle (thoug
-00013a60: 6820 776f 6e27 7420 6d61 6b65 2061 2064  h won't make a d
-00013a70: 6966 6665 7265 6e63 6520 6173 2063 6972  ifference as cir
-00013a80: 6375 6c61 7229 2074 6f20 6176 6f69 6420  cular) to avoid 
-00013a90: 7072 6f62 6c65 6d73 2077 6974 6820 616e  problems with an
-00013aa0: 676c 653d 300a 2020 2020 2020 2020 2020  gle=0.          
-00013ab0: 2020 2020 2020 2020 2020 2320 2074 6861            #  tha
-00013ac0: 7420 4927 7665 206e 6f74 6963 6564 2070  t I've noticed p
-00013ad0: 7265 7669 6f75 736c 790a 2020 2020 2020  reviously.      
-00013ae0: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
-00013af0: 775f 7265 6720 3d20 456c 6c69 7073 6553  w_reg = EllipseS
-00013b00: 6b79 5265 6769 6f6e 2872 6567 2e63 656e  kyRegion(reg.cen
-00013b10: 7465 722c 2072 6567 2e72 6164 6975 732a  ter, reg.radius*
-00013b20: 322c 2072 6567 2e72 6164 6975 732a 322c  2, reg.radius*2,
-00013b30: 2051 7561 6e74 6974 7928 332c 2027 6465   Quantity(3, 'de
-00013b40: 6727 2929 0a20 2020 2020 2020 2020 2020  g')).           
-00013b50: 2020 2020 2020 2020 206e 6577 5f72 6567           new_reg
-00013b60: 2e76 6973 7561 6c5b 2763 6f6c 6f72 275d  .visual['color']
-00013b70: 203d 2072 6567 2e76 6973 7561 6c5b 2763   = reg.visual['c
-00013b80: 6f6c 6f72 275d 0a20 2020 2020 2020 2020  olor'].         
-00013b90: 2020 2020 2020 2020 2020 2072 6567 5f64             reg_d
-00013ba0: 6963 745b 6f62 735f 6964 5d5b 7265 675f  ict[obs_id][reg_
-00013bb0: 696e 645d 203d 206e 6577 5f72 6567 0a0a  ind] = new_reg..
-00013bc0: 2020 2020 2020 2020 2020 2020 2320 486f              # Ho
-00013bd0: 7065 6675 6c6c 7920 7468 6973 2062 6f64  pefully this bod
-00013be0: 6765 2064 6f65 736e 2774 2068 6176 6520  ge doesn't have 
-00013bf0: 616e 7920 756e 666f 7265 7365 656e 2063  any unforeseen c
-00013c00: 6f6e 7365 7175 656e 6365 730a 2020 2020  onsequences.    
-00013c10: 2020 2020 2020 2020 6966 2072 6567 5f64          if reg_d
-00013c20: 6963 745b 6f62 735f 6964 5d5b 305d 2069  ict[obs_id][0] i
-00013c30: 7320 6e6f 7420 4e6f 6e65 2061 6e64 206c  s not None and l
-00013c40: 656e 2872 6567 5f64 6963 745b 6f62 735f  en(reg_dict[obs_
-00013c50: 6964 5d29 203e 2031 3a0a 2020 2020 2020  id]) > 1:.      
-00013c60: 2020 2020 2020 2020 2020 2320 5175 6963            # Quic
-00013c70: 6b6c 7920 6361 6c63 756c 6174 696e 6720  kly calculating 
-00013c80: 6469 7374 616e 6365 2062 6574 7765 656e  distance between
-00013c90: 2073 6f75 7263 6520 616e 6420 6365 6e74   source and cent
-00013ca0: 6572 206f 6620 7265 6769 6f6e 732c 2074  er of regions, t
-00013cb0: 6865 6e20 736f 7274 696e 670a 2020 2020  hen sorting.    
-00013cc0: 2020 2020 2020 2020 2020 2020 2320 616e              # an
-00013cd0: 6420 6765 7474 696e 6720 696e 6469 6365  d getting indice
-00013ce0: 732e 2054 6875 7320 4920 6f6e 6c79 206d  s. Thus I only m
-00013cf0: 6174 6368 2074 6f20 7468 6520 636c 6f73  atch to the clos
-00013d00: 6573 7420 3520 7265 6769 6f6e 732e 0a20  est 5 regions.. 
-00013d10: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00013d20: 6966 665f 736f 7274 203d 206e 702e 6172  iff_sort = np.ar
-00013d30: 7261 7928 5b64 6973 745f 6672 6f6d 5f73  ray([dist_from_s
-00013d40: 6f75 7263 6528 7229 2066 6f72 2072 2069  ource(r) for r i
-00013d50: 6e20 7265 675f 6469 6374 5b6f 6273 5f69  n reg_dict[obs_i
-00013d60: 645d 5d29 2e61 7267 736f 7274 2829 0a20  d]]).argsort(). 
-00013d70: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00013d80: 2055 6e66 6f72 7475 6e61 7465 6c79 2064   Unfortunately d
-00013d90: 7565 2074 6f20 6120 6c69 6d69 7461 7469  ue to a limitati
-00013da0: 6f6e 206f 6620 7468 6520 7265 6769 6f6e  on of the region
-00013db0: 7320 6d6f 6475 6c65 2049 2074 6869 6e6b  s module I think
-00013dc0: 2079 6f75 206e 6565 6420 696d 6167 6573   you need images
-00013dd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013de0: 2023 2020 746f 2064 6f20 7468 6973 2063   #  to do this c
-00013df0: 6f6e 7461 696e 7320 6d61 7463 682e 2e2e  ontains match...
-00013e00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013e10: 2077 6974 6869 6e20 3d20 6e70 2e61 7272   within = np.arr
-00013e20: 6179 285b 7265 672e 636f 6e74 6169 6e73  ay([reg.contains
-00013e30: 2853 6b79 436f 6f72 6428 2a73 656c 662e  (SkyCoord(*self.
-00013e40: 5f72 615f 6465 632c 2075 6e69 743d 2764  _ra_dec, unit='d
-00013e50: 6567 2729 2c20 7729 0a20 2020 2020 2020  eg'), w).       
-00013e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013e70: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00013e80: 7265 6720 696e 2072 6567 5f64 6963 745b  reg in reg_dict[
-00013e90: 6f62 735f 6964 5d5b 6469 6666 5f73 6f72  obs_id][diff_sor
-00013ea0: 745b 303a 355d 5d5d 290a 0a20 2020 2020  t[0:5]]])..     
-00013eb0: 2020 2020 2020 2020 2020 2023 204d 616b             # Mak
-00013ec0: 6520 7375 7265 2074 6f20 7265 2d6f 7264  e sure to re-ord
-00013ed0: 6572 2074 6865 2072 6567 696f 6e20 6c69  er the region li
-00013ee0: 7374 2074 6f20 6d61 7463 6820 7468 6520  st to match the 
-00013ef0: 736f 7274 6564 2077 6974 6869 6e20 6172  sorted within ar
-00013f00: 7261 790a 2020 2020 2020 2020 2020 2020  ray.            
-00013f10: 2020 2020 7265 675f 6469 6374 5b6f 6273      reg_dict[obs
-00013f20: 5f69 645d 203d 2072 6567 5f64 6963 745b  _id] = reg_dict[
-00013f30: 6f62 735f 6964 5d5b 6469 6666 5f73 6f72  obs_id][diff_sor
-00013f40: 745d 0a0a 2020 2020 2020 2020 2020 2020  t]..            
-00013f50: 2020 2020 2320 4578 7061 6e64 7320 6974      # Expands it
-00013f60: 2073 6f20 6974 2063 616e 2062 6520 7573   so it can be us
-00013f70: 6564 2061 7320 6120 6d61 736b 206f 6e20  ed as a mask on 
-00013f80: 7468 6520 7768 6f6c 6520 7365 7420 6f66  the whole set of
-00013f90: 2072 6567 696f 6e73 2066 6f72 2074 6869   regions for thi
-00013fa0: 7320 6f62 7365 7276 6174 696f 6e0a 2020  s observation.  
-00013fb0: 2020 2020 2020 2020 2020 2020 2020 7769                wi
-00013fc0: 7468 696e 203d 206e 702e 7061 6428 7769  thin = np.pad(wi
-00013fd0: 7468 696e 2c20 5b30 2c20 6c65 6e28 6469  thin, [0, len(di
-00013fe0: 6666 5f73 6f72 7429 202d 206c 656e 2877  ff_sort) - len(w
-00013ff0: 6974 6869 6e29 5d29 0a20 2020 2020 2020  ithin)]).       
-00014000: 2020 2020 2020 2020 206d 6174 6368 5f64           match_d
-00014010: 6963 745b 6f62 735f 6964 5d20 3d20 7769  ict[obs_id] = wi
-00014020: 7468 696e 0a20 2020 2020 2020 2020 2020  thin.           
-00014030: 2023 2049 6e20 7468 6520 6361 7365 206f   # In the case o
-00014040: 6620 6f6e 6c79 206f 6e65 2072 6567 696f  f only one regio
-00014050: 6e20 6265 696e 6720 696e 2074 6865 206c  n being in the l
-00014060: 6973 742c 2077 6520 7369 6d70 6c69 6679  ist, we simplify
-00014070: 2074 6865 2061 626f 7665 2065 7870 7265   the above expre
-00014080: 7373 696f 6e0a 2020 2020 2020 2020 2020  ssion.          
-00014090: 2020 656c 6966 2072 6567 5f64 6963 745b    elif reg_dict[
-000140a0: 6f62 735f 6964 5d5b 305d 2069 7320 6e6f  obs_id][0] is no
-000140b0: 7420 4e6f 6e65 2061 6e64 206c 656e 2872  t None and len(r
-000140c0: 6567 5f64 6963 745b 6f62 735f 6964 5d29  eg_dict[obs_id])
-000140d0: 203d 3d20 313a 0a20 2020 2020 2020 2020   == 1:.         
-000140e0: 2020 2020 2020 2069 6620 7265 675f 6469         if reg_di
-000140f0: 6374 5b6f 6273 5f69 645d 5b30 5d2e 636f  ct[obs_id][0].co
-00014100: 6e74 6169 6e73 2853 6b79 436f 6f72 6428  ntains(SkyCoord(
-00014110: 2a73 656c 662e 5f72 615f 6465 632c 2075  *self._ra_dec, u
-00014120: 6e69 743d 2764 6567 2729 2c20 7729 3a0a  nit='deg'), w):.
-00014130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014140: 2020 2020 6d61 7463 685f 6469 6374 5b6f      match_dict[o
-00014150: 6273 5f69 645d 203d 206e 702e 6172 7261  bs_id] = np.arra
-00014160: 7928 5b54 7275 655d 290a 2020 2020 2020  y([True]).      
-00014170: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00014180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014190: 2020 2020 6d61 7463 685f 6469 6374 5b6f      match_dict[o
-000141a0: 6273 5f69 645d 203d 206e 702e 6172 7261  bs_id] = np.arra
-000141b0: 7928 5b46 616c 7365 5d29 0a20 2020 2020  y([False]).     
-000141c0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-000141d0: 2020 2020 2020 2020 2020 2020 206d 6174               mat
-000141e0: 6368 5f64 6963 745b 6f62 735f 6964 5d20  ch_dict[obs_id] 
-000141f0: 3d20 6e70 2e61 7272 6179 285b 4661 6c73  = np.array([Fals
-00014200: 655d 290a 0a20 2020 2020 2020 2072 6574  e])..        ret
-00014210: 7572 6e20 7265 675f 6469 6374 2c20 6d61  urn reg_dict, ma
-00014220: 7463 685f 6469 6374 0a0a 2020 2020 6465  tch_dict..    de
-00014230: 6620 7570 6461 7465 5f71 7565 7565 2873  f update_queue(s
-00014240: 656c 662c 2063 6d64 5f61 7272 3a20 6e70  elf, cmd_arr: np
-00014250: 2e6e 6461 7272 6179 2c20 705f 7479 7065  .ndarray, p_type
-00014260: 5f61 7272 3a20 6e70 2e6e 6461 7272 6179  _arr: np.ndarray
-00014270: 2c20 705f 7061 7468 5f61 7272 3a20 6e70  , p_path_arr: np
-00014280: 2e6e 6461 7272 6179 2c0a 2020 2020 2020  .ndarray,.      
-00014290: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-000142a0: 7874 7261 5f69 6e66 6f3a 206e 702e 6e64  xtra_info: np.nd
-000142b0: 6172 7261 792c 2073 7461 636b 3a20 626f  array, stack: bo
-000142c0: 6f6c 203d 2046 616c 7365 293a 0a20 2020  ol = False):.   
-000142d0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-000142e0: 2053 6d61 6c6c 2066 756e 6374 696f 6e20   Small function 
-000142f0: 746f 2075 7064 6174 6520 7468 6520 6e75  to update the nu
-00014300: 6d70 7920 6172 7261 7920 7468 6174 206d  mpy array that m
-00014310: 616b 6573 2075 7020 7468 6520 7175 6575  akes up the queu
-00014320: 6520 6f66 2070 726f 6475 6374 7320 746f  e of products to
-00014330: 2062 6520 6765 6e65 7261 7465 642e 0a0a   be generated...
-00014340: 2020 2020 2020 2020 3a70 6172 616d 206e          :param n
-00014350: 702e 6e64 6172 7261 7920 636d 645f 6172  p.ndarray cmd_ar
-00014360: 723a 2041 7272 6179 2063 6f6e 7461 696e  r: Array contain
-00014370: 696e 6720 5341 5320 636f 6d6d 616e 6473  ing SAS commands
-00014380: 2e0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
-00014390: 206e 702e 6e64 6172 7261 7920 705f 7479   np.ndarray p_ty
-000143a0: 7065 5f61 7272 3a20 4172 7261 7920 6f66  pe_arr: Array of
-000143b0: 2070 726f 6475 6374 2074 7970 6520 6964   product type id
-000143c0: 656e 7469 6669 6572 7320 666f 7220 7468  entifiers for th
-000143d0: 6520 7072 6f64 7563 7473 2067 656e 6572  e products gener
-000143e0: 6174 6564 0a20 2020 2020 2020 2020 2020  ated.           
-000143f0: 2062 7920 7468 6520 636d 6420 6172 7261   by the cmd arra
-00014400: 792e 2065 2e67 2e20 696d 6167 6520 6f72  y. e.g. image or
-00014410: 2065 7870 6d61 702e 0a20 2020 2020 2020   expmap..       
-00014420: 203a 7061 7261 6d20 6e70 2e6e 6461 7272   :param np.ndarr
-00014430: 6179 2070 5f70 6174 685f 6172 723a 2041  ay p_path_arr: A
-00014440: 7272 6179 206f 6620 6669 6e61 6c20 7072  rray of final pr
-00014450: 6f64 7563 7420 7061 7468 7320 6966 2063  oduct paths if c
-00014460: 6d64 2069 7320 7375 6363 6573 7366 756c  md is successful
-00014470: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-00014480: 6e70 2e6e 6461 7272 6179 2065 7874 7261  np.ndarray extra
-00014490: 5f69 6e66 6f3a 2041 7272 6179 206f 6620  _info: Array of 
-000144a0: 6578 7472 6120 696e 666f 726d 6174 696f  extra informatio
-000144b0: 6e20 6469 6374 696f 6e61 7269 6573 0a20  n dictionaries. 
-000144c0: 2020 2020 2020 203a 7061 7261 6d20 7374         :param st
-000144d0: 6163 6b3a 2053 686f 756c 6420 7468 6573  ack: Should thes
-000144e0: 6520 636f 6d6d 616e 6473 2062 6520 6578  e commands be ex
-000144f0: 6563 7574 6564 2061 6674 6572 2061 2070  ecuted after a p
-00014500: 7265 6365 6469 6e67 206c 696e 6520 6f66  receding line of
-00014510: 2063 6f6d 6d61 6e64 732c 0a20 2020 2020   commands,.     
-00014520: 2020 2020 2020 206f 7220 6174 2074 6865         or at the
-00014530: 2073 616d 6520 7469 6d65 2e0a 2020 2020   same time..    
-00014540: 2020 2020 3a72 6574 7572 6e3a 0a20 2020      :return:.   
-00014550: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00014560: 2069 6620 7365 6c66 2e71 7565 7565 2069   if self.queue i
-00014570: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-00014580: 2020 2020 2320 4920 636f 756c 6420 6861      # I could ha
-00014590: 7665 2064 6f6e 6520 616c 6c20 6f66 2074  ve done all of t
-000145a0: 6865 7365 2069 6e20 6f6e 6520 6172 7261  hese in one arra
-000145b0: 7920 7769 7468 2033 2064 696d 656e 7369  y with 3 dimensi
-000145c0: 6f6e 732c 2062 7574 2066 656c 7420 7468  ons, but felt th
-000145d0: 6973 2077 6173 2065 6173 6965 7220 746f  is was easier to
-000145e0: 2072 6561 640a 2020 2020 2020 2020 2020   read.          
-000145f0: 2020 2320 616e 6420 7769 7468 206e 6f20    # and with no 
-00014600: 7265 616c 2070 6572 666f 726d 616e 6365  real performance
-00014610: 2070 656e 616c 7479 0a20 2020 2020 2020   penalty.       
-00014620: 2020 2020 2073 656c 662e 7175 6575 6520       self.queue 
-00014630: 3d20 636d 645f 6172 720a 2020 2020 2020  = cmd_arr.      
-00014640: 2020 2020 2020 7365 6c66 2e71 7565 7565        self.queue
-00014650: 5f74 7970 6520 3d20 705f 7479 7065 5f61  _type = p_type_a
-00014660: 7272 0a20 2020 2020 2020 2020 2020 2073  rr.            s
-00014670: 656c 662e 7175 6575 655f 7061 7468 203d  elf.queue_path =
-00014680: 2070 5f70 6174 685f 6172 720a 2020 2020   p_path_arr.    
-00014690: 2020 2020 2020 2020 7365 6c66 2e71 7565          self.que
-000146a0: 7565 5f65 7874 7261 5f69 6e66 6f20 3d20  ue_extra_info = 
-000146b0: 6578 7472 615f 696e 666f 0a20 2020 2020  extra_info.     
-000146c0: 2020 2065 6c69 6620 7374 6163 6b3a 0a20     elif stack:. 
-000146d0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000146e0: 7175 6575 6520 3d20 6e70 2e76 7374 6163  queue = np.vstac
-000146f0: 6b28 2873 656c 662e 7175 6575 652c 2063  k((self.queue, c
-00014700: 6d64 5f61 7272 2929 0a20 2020 2020 2020  md_arr)).       
-00014710: 2020 2020 2073 656c 662e 7175 6575 655f       self.queue_
-00014720: 7479 7065 203d 206e 702e 7673 7461 636b  type = np.vstack
-00014730: 2828 7365 6c66 2e71 7565 7565 5f74 7970  ((self.queue_typ
-00014740: 652c 2070 5f74 7970 655f 6172 7229 290a  e, p_type_arr)).
-00014750: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00014760: 2e71 7565 7565 5f70 6174 6820 3d20 6e70  .queue_path = np
-00014770: 2e76 7374 6163 6b28 2873 656c 662e 7175  .vstack((self.qu
-00014780: 6575 655f 7061 7468 2c20 705f 7061 7468  eue_path, p_path
-00014790: 5f61 7272 2929 0a20 2020 2020 2020 2020  _arr)).         
-000147a0: 2020 2073 656c 662e 7175 6575 655f 6578     self.queue_ex
-000147b0: 7472 615f 696e 666f 203d 206e 702e 7673  tra_info = np.vs
-000147c0: 7461 636b 2828 7365 6c66 2e71 7565 7565  tack((self.queue
-000147d0: 5f65 7874 7261 5f69 6e66 6f2c 2065 7874  _extra_info, ext
-000147e0: 7261 5f69 6e66 6f29 290a 2020 2020 2020  ra_info)).      
-000147f0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00014800: 2020 2020 7365 6c66 2e71 7565 7565 203d      self.queue =
-00014810: 206e 702e 6170 7065 6e64 2873 656c 662e   np.append(self.
-00014820: 7175 6575 652c 2063 6d64 5f61 7272 2c20  queue, cmd_arr, 
-00014830: 6178 6973 3d30 290a 2020 2020 2020 2020  axis=0).        
-00014840: 2020 2020 7365 6c66 2e71 7565 7565 5f74      self.queue_t
-00014850: 7970 6520 3d20 6e70 2e61 7070 656e 6428  ype = np.append(
-00014860: 7365 6c66 2e71 7565 7565 5f74 7970 652c  self.queue_type,
-00014870: 2070 5f74 7970 655f 6172 722c 2061 7869   p_type_arr, axi
-00014880: 733d 3029 0a20 2020 2020 2020 2020 2020  s=0).           
-00014890: 2073 656c 662e 7175 6575 655f 7061 7468   self.queue_path
-000148a0: 203d 206e 702e 6170 7065 6e64 2873 656c   = np.append(sel
-000148b0: 662e 7175 6575 655f 7061 7468 2c20 705f  f.queue_path, p_
-000148c0: 7061 7468 5f61 7272 2c20 6178 6973 3d30  path_arr, axis=0
-000148d0: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
-000148e0: 6c66 2e71 7565 7565 5f65 7874 7261 5f69  lf.queue_extra_i
-000148f0: 6e66 6f20 3d20 6e70 2e61 7070 656e 6428  nfo = np.append(
-00014900: 7365 6c66 2e71 7565 7565 5f65 7874 7261  self.queue_extra
-00014910: 5f69 6e66 6f2c 2065 7874 7261 5f69 6e66  _info, extra_inf
-00014920: 6f2c 2061 7869 733d 3029 0a0a 2020 2020  o, axis=0)..    
-00014930: 6465 6620 6765 745f 7175 6575 6528 7365  def get_queue(se
-00014940: 6c66 2920 2d3e 2054 7570 6c65 5b4c 6973  lf) -> Tuple[Lis
-00014950: 745b 7374 725d 2c20 4c69 7374 5b73 7472  t[str], List[str
-00014960: 5d2c 204c 6973 745b 4c69 7374 5b73 7472  ], List[List[str
-00014970: 5d5d 2c20 4c69 7374 5b64 6963 745d 5d3a  ]], List[dict]]:
-00014980: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00014990: 2020 2020 2043 616c 6c69 6e67 2074 6869       Calling thi
-000149a0: 7320 696e 6469 6361 7465 7320 7468 6174  s indicates that
-000149b0: 2074 6865 2071 7565 7565 2069 7320 6162   the queue is ab
-000149c0: 6f75 7420 746f 2062 6520 7072 6f63 6573  out to be proces
-000149d0: 7365 642c 2073 6f20 7468 6973 2066 756e  sed, so this fun
-000149e0: 6374 696f 6e20 636f 6d62 696e 6573 2053  ction combines S
-000149f0: 4153 0a20 2020 2020 2020 2063 6f6d 6d61  AS.        comma
-00014a00: 6e64 7320 616c 6f6e 6720 636f 6c75 6d6e  nds along column
-00014a10: 7320 2863 6f6d 6d61 6e64 2073 7461 636b  s (command stack
-00014a20: 7329 2c20 616e 6420 7265 7475 726e 7320  s), and returns 
-00014a30: 4e20 5341 5320 636f 6d6d 616e 6473 2074  N SAS commands t
-00014a40: 6f20 6265 2072 756e 2063 6f6e 6375 7272  o be run concurr
-00014a50: 656e 746c 792c 0a20 2020 2020 2020 2077  ently,.        w
-00014a60: 6865 7265 204e 2069 7320 7468 6520 6e75  here N is the nu
-00014a70: 6d62 6572 206f 6620 636f 6c75 6d6e 732e  mber of columns.
-00014a80: 0a0a 2020 2020 2020 2020 3a72 6574 7572  ..        :retur
-00014a90: 6e3a 204c 6973 7420 6f66 2073 7472 696e  n: List of strin
-00014aa0: 6773 2c20 7768 6572 6520 7468 6520 7374  gs, where the st
-00014ab0: 7269 6e67 7320 6172 6520 6261 7368 2063  rings are bash c
-00014ac0: 6f6d 6d61 6e64 7320 746f 2072 756e 2053  ommands to run S
-00014ad0: 4153 2070 726f 6365 6475 7265 732c 2061  AS procedures, a
-00014ae0: 6e6f 7468 6572 0a20 2020 2020 2020 2020  nother.         
-00014af0: 2020 206c 6973 7420 6f66 2073 7472 696e     list of strin
-00014b00: 6773 2c20 7768 6572 6520 7468 6520 7374  gs, where the st
-00014b10: 7269 6e67 7320 6172 6520 6578 7065 6374  rings are expect
-00014b20: 6564 206f 7574 7075 7420 7479 7065 7320  ed output types 
-00014b30: 666f 7220 7468 6520 636f 6d6d 616e 6473  for the commands
-00014b40: 2c20 6120 6c69 7374 206f 660a 2020 2020  , a list of.    
-00014b50: 2020 2020 2020 2020 6c69 7374 7320 6f66          lists of
-00014b60: 2073 7472 696e 6773 2c20 7768 6572 6520   strings, where 
-00014b70: 7468 6520 7374 7269 6e67 7320 6172 6520  the strings are 
-00014b80: 6578 7065 6374 6564 206f 7574 7075 7420  expected output 
-00014b90: 7061 7468 7320 666f 7220 7072 6f64 7563  paths for produc
-00014ba0: 7473 206f 6620 7468 6520 5341 5320 636f  ts of the SAS co
-00014bb0: 6d6d 616e 6473 2e0a 2020 2020 2020 2020  mmands..        
-00014bc0: 3a72 7479 7065 3a20 5475 706c 655b 4c69  :rtype: Tuple[Li
-00014bd0: 7374 5b73 7472 5d2c 204c 6973 745b 7374  st[str], List[st
-00014be0: 725d 2c20 4c69 7374 5b4c 6973 745b 7374  r], List[List[st
-00014bf0: 725d 5d5d 0a20 2020 2020 2020 2022 2222  r]]].        """
-00014c00: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00014c10: 2e71 7565 7565 2069 7320 4e6f 6e65 3a0a  .queue is None:.
-00014c20: 2020 2020 2020 2020 2020 2020 2320 5468              # Th
-00014c30: 6973 2072 6574 7572 6e73 2065 6d70 7479  is returns empty
-00014c40: 206c 6973 7473 2069 6620 7468 6520 7175   lists if the qu
-00014c50: 6575 6520 6973 2075 6e64 6566 696e 6564  eue is undefined
-00014c60: 0a20 2020 2020 2020 2020 2020 2070 726f  .            pro
-00014c70: 6365 7373 6564 5f63 6d64 7320 3d20 5b5d  cessed_cmds = []
-00014c80: 0a20 2020 2020 2020 2020 2020 2074 7970  .            typ
-00014c90: 6573 203d 205b 5d0a 2020 2020 2020 2020  es = [].        
-00014ca0: 2020 2020 7061 7468 7320 3d20 5b5d 0a20      paths = []. 
-00014cb0: 2020 2020 2020 2020 2020 2065 7874 7261             extra
-00014cc0: 7320 3d20 5b5d 0a20 2020 2020 2020 2065  s = [].        e
-00014cd0: 6c69 6620 6c65 6e28 7365 6c66 2e71 7565  lif len(self.que
-00014ce0: 7565 2e73 6861 7065 2920 3d3d 2031 206f  ue.shape) == 1 o
-00014cf0: 7220 7365 6c66 2e71 7565 7565 2e73 6861  r self.queue.sha
-00014d00: 7065 5b31 5d20 3c3d 2031 3a0a 2020 2020  pe[1] <= 1:.    
-00014d10: 2020 2020 2020 2020 7072 6f63 6573 7365          processe
-00014d20: 645f 636d 6473 203d 206c 6973 7428 7365  d_cmds = list(se
-00014d30: 6c66 2e71 7565 7565 290a 2020 2020 2020  lf.queue).      
-00014d40: 2020 2020 2020 7479 7065 7320 3d20 6c69        types = li
-00014d50: 7374 2873 656c 662e 7175 6575 655f 7479  st(self.queue_ty
-00014d60: 7065 290a 2020 2020 2020 2020 2020 2020  pe).            
-00014d70: 7061 7468 7320 3d20 5b5b 7374 7228 7061  paths = [[str(pa
-00014d80: 7468 295d 2066 6f72 2070 6174 6820 696e  th)] for path in
-00014d90: 2073 656c 662e 7175 6575 655f 7061 7468   self.queue_path
-00014da0: 5d0a 2020 2020 2020 2020 2020 2020 6578  ].            ex
-00014db0: 7472 6173 203d 206c 6973 7428 7365 6c66  tras = list(self
-00014dc0: 2e71 7565 7565 5f65 7874 7261 5f69 6e66  .queue_extra_inf
-00014dd0: 6f29 0a20 2020 2020 2020 2065 6c73 653a  o).        else:
-00014de0: 0a20 2020 2020 2020 2020 2020 2070 726f  .            pro
-00014df0: 6365 7373 6564 5f63 6d64 7320 3d20 5b22  cessed_cmds = ["
-00014e00: 3b22 2e6a 6f69 6e28 636f 6c29 2066 6f72  ;".join(col) for
-00014e10: 2063 6f6c 2069 6e20 7365 6c66 2e71 7565   col in self.que
-00014e20: 7565 2e54 5d0a 2020 2020 2020 2020 2020  ue.T].          
-00014e30: 2020 7479 7065 7320 3d20 6c69 7374 2873    types = list(s
-00014e40: 656c 662e 7175 6575 655f 7479 7065 5b2d  elf.queue_type[-
-00014e50: 312c 203a 5d29 0a20 2020 2020 2020 2020  1, :]).         
-00014e60: 2020 2070 6174 6873 203d 205b 6c69 7374     paths = [list
-00014e70: 2863 6f6c 2e61 7374 7970 6528 7374 7229  (col.astype(str)
-00014e80: 2920 666f 7220 636f 6c20 696e 2073 656c  ) for col in sel
-00014e90: 662e 7175 6575 655f 7061 7468 2e54 5d0a  f.queue_path.T].
-00014ea0: 2020 2020 2020 2020 2020 2020 6578 7472              extr
-00014eb0: 6173 203d 205b 5d0a 2020 2020 2020 2020  as = [].        
-00014ec0: 2020 2020 666f 7220 636f 6c20 696e 2073      for col in s
-00014ed0: 656c 662e 7175 6575 655f 7061 7468 2e54  elf.queue_path.T
-00014ee0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00014ef0: 2020 2320 5468 6973 206e 6573 7465 6420    # This nested 
-00014f00: 6469 6374 696f 6e61 7279 2063 6f6d 7072  dictionary compr
-00014f10: 6568 656e 7369 6f6e 2063 6f6d 6269 6e65  ehension combine
-00014f20: 7320 6120 636f 6c75 6d6e 206f 6620 6578  s a column of ex
-00014f30: 7472 6120 696e 666f 726d 6174 696f 6e0a  tra information.
-00014f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014f50: 2320 6469 6374 696f 6e61 7269 6573 2069  # dictionaries i
-00014f60: 6e74 6f20 6f6e 652c 2066 6f72 2065 6173  nto one, for eas
-00014f70: 6520 6f66 2061 6363 6573 732e 0a20 2020  e of access..   
-00014f80: 2020 2020 2020 2020 2020 2020 2063 6f6d               com
-00014f90: 625f 6578 7472 6120 3d20 7b6b 3a20 7620  b_extra = {k: v 
-00014fa0: 666f 7220 6578 745f 6469 6374 2069 6e20  for ext_dict in 
-00014fb0: 636f 6c20 666f 7220 6b2c 2076 2069 6e20  col for k, v in 
-00014fc0: 6578 745f 6469 6374 2e69 7465 6d73 2829  ext_dict.items()
-00014fd0: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-00014fe0: 2020 6578 7472 6173 2e61 7070 656e 6428    extras.append(
-00014ff0: 636f 6d62 5f65 7874 7261 290a 0a20 2020  comb_extra)..   
-00015000: 2020 2020 2023 2054 6869 7320 6973 206f       # This is o
-00015010: 6e6c 7920 6c69 6b65 6c79 2074 6f20 6265  nly likely to be
-00015020: 2063 616c 6c65 6420 7768 656e 2070 726f   called when pro
-00015030: 6365 7373 696e 6720 6973 2062 6567 696e  cessing is begin
-00015040: 6e69 6e67 2c20 736f 2074 6869 7320 7769  ning, so this wi
-00015050: 6c6c 2077 6970 6520 7468 6520 7175 6575  ll wipe the queu
-00015060: 652e 0a20 2020 2020 2020 2073 656c 662e  e..        self.
-00015070: 7175 6575 6520 3d20 4e6f 6e65 0a20 2020  queue = None.   
-00015080: 2020 2020 2073 656c 662e 7175 6575 655f       self.queue_
-00015090: 7479 7065 203d 204e 6f6e 650a 2020 2020  type = None.    
-000150a0: 2020 2020 7365 6c66 2e71 7565 7565 5f70      self.queue_p
-000150b0: 6174 6820 3d20 4e6f 6e65 0a20 2020 2020  ath = None.     
-000150c0: 2020 2073 656c 662e 7175 6575 655f 6578     self.queue_ex
-000150d0: 7472 615f 696e 666f 203d 204e 6f6e 650a  tra_info = None.
-000150e0: 2020 2020 2020 2020 2320 5468 6520 7265          # The re
-000150f0: 7475 726e 6564 2070 6174 6873 2061 7265  turned paths are
-00015100: 206c 6973 7473 206f 6620 7374 7269 6e67   lists of string
-00015110: 7320 6265 6361 7573 6520 7765 2077 616e  s because we wan
-00015120: 7420 746f 2069 6e63 6c75 6465 2065 7665  t to include eve
-00015130: 7279 2066 696c 6520 696e 2061 2073 7461  ry file in a sta
-00015140: 636b 2074 6f20 6265 2061 626c 650a 2020  ck to be able.  
-00015150: 2020 2020 2020 2320 746f 2063 6865 636b        # to check
-00015160: 2074 6861 7420 6578 6973 7473 0a20 2020   that exists.   
-00015170: 2020 2020 2072 6574 7572 6e20 7072 6f63       return proc
-00015180: 6573 7365 645f 636d 6473 2c20 7479 7065  essed_cmds, type
-00015190: 732c 2070 6174 6873 2c20 6578 7472 6173  s, paths, extras
-000151a0: 0a0a 2020 2020 6465 6620 6765 745f 6174  ..    def get_at
-000151b0: 745f 6669 6c65 2873 656c 662c 206f 6273  t_file(self, obs
-000151c0: 5f69 643a 2073 7472 2920 2d3e 2073 7472  _id: str) -> str
-000151d0: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-000151e0: 2020 2020 2020 4665 7463 6865 7320 7468        Fetches th
-000151f0: 6520 7061 7468 2074 6f20 7468 6520 6174  e path to the at
-00015200: 7469 7475 6465 2066 696c 6520 666f 7220  titude file for 
-00015210: 616e 2058 4d4d 206f 6273 6572 7661 7469  an XMM observati
-00015220: 6f6e 2e0a 0a20 2020 2020 2020 203a 7061  on...        :pa
-00015230: 7261 6d20 6f62 735f 6964 3a20 5468 6520  ram obs_id: The 
-00015240: 4f62 7349 4420 746f 2066 6574 6368 2074  ObsID to fetch t
-00015250: 6865 2061 7474 6974 7564 6520 6669 6c65  he attitude file
-00015260: 2066 6f72 2e0a 2020 2020 2020 2020 3a72   for..        :r
-00015270: 6574 7572 6e3a 2054 6865 2070 6174 6820  eturn: The path 
-00015280: 746f 2074 6865 2061 7474 6974 7564 6520  to the attitude 
-00015290: 6669 6c65 2e0a 2020 2020 2020 2020 3a72  file..        :r
-000152a0: 7479 7065 3a20 7374 720a 2020 2020 2020  type: str.      
-000152b0: 2020 2222 220a 2020 2020 2020 2020 6966    """.        if
-000152c0: 206f 6273 5f69 6420 6e6f 7420 696e 2073   obs_id not in s
-000152d0: 656c 662e 5f70 726f 6475 6374 733a 0a20  elf._products:. 
-000152e0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-000152f0: 204e 6f74 4173 736f 6369 6174 6564 4572   NotAssociatedEr
-00015300: 726f 7228 227b 6f7d 2069 7320 6e6f 7420  ror("{o} is not 
-00015310: 6173 736f 6369 6174 6564 2077 6974 6820  associated with 
-00015320: 7b73 7d22 2e66 6f72 6d61 7428 6f3d 6f62  {s}".format(o=ob
-00015330: 735f 6964 2c20 733d 7365 6c66 2e6e 616d  s_id, s=self.nam
-00015340: 6529 290a 2020 2020 2020 2020 656c 7365  e)).        else
-00015350: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00015360: 7475 726e 2073 656c 662e 5f61 7474 5f66  turn self._att_f
-00015370: 696c 6573 5b6f 6273 5f69 645d 0a0a 2020  iles[obs_id]..  
-00015380: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
-00015390: 6465 6620 6f62 735f 6964 7328 7365 6c66  def obs_ids(self
-000153a0: 2920 2d3e 204c 6973 745b 7374 725d 3a0a  ) -> List[str]:.
-000153b0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-000153c0: 2020 2020 5072 6f70 6572 7479 2067 6574      Property get
-000153d0: 7465 7220 666f 7220 4f62 7349 4473 2061  ter for ObsIDs a
-000153e0: 7373 6f63 6961 7465 6420 7769 7468 2074  ssociated with t
-000153f0: 6869 7320 736f 7572 6365 2074 6861 7420  his source that 
-00015400: 6172 6520 636f 6e66 6972 6d65 6420 746f  are confirmed to
-00015410: 2068 6176 6520 6576 656e 7473 2066 696c   have events fil
-00015420: 6573 2e0a 0a20 2020 2020 2020 203a 7265  es...        :re
-00015430: 7475 726e 3a20 4120 6c69 7374 206f 6620  turn: A list of 
-00015440: 7468 6520 6173 736f 6369 6174 6564 2058  the associated X
-00015450: 4d4d 204f 6273 4944 732e 0a20 2020 2020  MM ObsIDs..     
-00015460: 2020 203a 7274 7970 653a 204c 6973 745b     :rtype: List[
-00015470: 7374 725d 0a20 2020 2020 2020 2022 2222  str].        """
-00015480: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00015490: 7365 6c66 2e5f 6f62 730a 0a20 2020 2040  self._obs..    @
-000154a0: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
-000154b0: 2062 6c61 636b 6c69 7374 6564 2873 656c   blacklisted(sel
-000154c0: 6629 202d 3e20 4469 6374 3a0a 2020 2020  f) -> Dict:.    
-000154d0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-000154e0: 4120 7072 6f70 6572 7479 2067 6574 7465  A property gette
-000154f0: 7220 7468 6174 2072 6574 7572 6e73 2074  r that returns t
-00015500: 6865 2064 6963 7469 6f6e 6172 7920 6f66  he dictionary of
-00015510: 204f 6273 4944 7320 616e 6420 7468 6569   ObsIDs and thei
-00015520: 7220 696e 7374 7275 6d65 6e74 7320 7768  r instruments wh
-00015530: 6963 6820 6861 7665 2062 6565 6e0a 2020  ich have been.  
-00015540: 2020 2020 2020 626c 6163 6b6c 6973 7465        blackliste
-00015550: 642c 2061 6e64 2074 6875 7320 6e6f 7420  d, and thus not 
-00015560: 636f 6e73 6964 6572 6564 2066 6f72 2075  considered for u
-00015570: 7365 2069 6e20 616e 7920 616e 616c 7973  se in any analys
-00015580: 6973 206f 6620 7468 6973 2073 6f75 7263  is of this sourc
-00015590: 652e 0a0a 2020 2020 2020 2020 3a72 6574  e...        :ret
-000155a0: 7572 6e3a 2054 6865 2064 6963 7469 6f6e  urn: The diction
-000155b0: 6172 7920 2877 6974 6820 4f62 7349 4473  ary (with ObsIDs
-000155c0: 2061 7320 6b65 7973 2920 6f66 2062 6c61   as keys) of bla
-000155d0: 636b 6c69 7374 6564 2064 6174 612e 0a20  cklisted data.. 
-000155e0: 2020 2020 2020 203a 7274 7970 653a 2044         :rtype: D
-000155f0: 6963 740a 2020 2020 2020 2020 2222 220a  ict.        """.
-00015600: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00015610: 656c 662e 5f62 6c61 636b 6c69 7374 6564  elf._blacklisted
-00015620: 5f6f 6273 0a0a 2020 2020 6465 6620 5f73  _obs..    def _s
-00015630: 6f75 7263 655f 7479 7065 5f6d 6174 6368  ource_type_match
-00015640: 2873 656c 662c 2073 6f75 7263 655f 7479  (self, source_ty
-00015650: 7065 3a20 7374 7229 202d 3e20 5475 706c  pe: str) -> Tupl
-00015660: 655b 4469 6374 2c20 4469 6374 2c20 4469  e[Dict, Dict, Di
-00015670: 6374 5d3a 0a20 2020 2020 2020 2022 2222  ct]:.        """
-00015680: 0a20 2020 2020 2020 2041 206d 6574 686f  .        A metho
-00015690: 6420 7468 6174 206c 6f6f 6b73 2066 6f72  d that looks for
-000156a0: 206d 6174 6368 6573 206e 6f74 206a 7573   matches not jus
-000156b0: 7420 6261 7365 6420 6f6e 2070 6f73 6974  t based on posit
-000156c0: 696f 6e2c 2062 7574 2061 6c73 6f20 6f6e  ion, but also on
-000156d0: 2074 6865 2074 7970 6520 6f66 2073 6f75   the type of sou
-000156e0: 7263 650a 2020 2020 2020 2020 7765 2077  rce.        we w
-000156f0: 616e 7420 746f 2066 696e 642e 2046 696e  ant to find. Fin
-00015700: 6469 6e67 206e 6f20 6d61 7463 6865 7320  ding no matches 
-00015710: 6973 2061 6c6c 6f77 6564 2c20 6275 7420  is allowed, but 
-00015720: 7468 6520 736f 7572 6365 2077 696c 6c20  the source will 
-00015730: 6265 2064 6563 6c61 7265 6420 6173 2075  be declared as u
-00015740: 6e64 6574 6563 7465 642e 0a20 2020 2020  ndetected..     
-00015750: 2020 2041 6e20 6572 726f 7220 7769 6c6c     An error will
-00015760: 2062 6520 7468 726f 776e 2069 6620 6d6f   be thrown if mo
-00015770: 7265 2074 6861 6e20 6f6e 6520 6d61 7463  re than one matc
-00015780: 6820 6f66 2074 6865 2063 6f72 7265 6374  h of the correct
-00015790: 2074 7970 6520 7065 7220 6f62 7365 7276   type per observ
-000157a0: 6174 696f 6e20 6973 2066 6f75 6e64 2e0a  ation is found..
-000157b0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-000157c0: 7374 7220 736f 7572 6365 5f74 7970 653a  str source_type:
-000157d0: 2053 686f 756c 6420 6569 7468 6572 2062   Should either b
-000157e0: 6520 6578 7420 6f72 2070 6e74 2c20 6465  e ext or pnt, de
-000157f0: 7363 7269 6265 7320 7768 6174 2074 7970  scribes what typ
-00015800: 6520 6f66 2073 6f75 7263 6520 490a 2020  e of source I.  
-00015810: 2020 2020 2020 2020 2020 7368 6f75 6c64            should
-00015820: 2062 6520 6c6f 6f6b 696e 6720 666f 7220   be looking for 
-00015830: 696e 2074 6865 2072 6567 696f 6e20 6669  in the region fi
-00015840: 6c65 732e 0a20 2020 2020 2020 203a 7265  les..        :re
-00015850: 7475 726e 3a20 4120 6469 6374 696f 6e61  turn: A dictiona
-00015860: 7279 2063 6f6e 7461 696e 696e 6720 7468  ry containing th
-00015870: 6520 6d61 7463 6865 6420 7265 6769 6f6e  e matched region
-00015880: 2066 6f72 2065 6163 6820 4f62 7349 4420   for each ObsID 
-00015890: 2b20 6120 636f 6d62 696e 6564 2072 6567  + a combined reg
-000158a0: 696f 6e2c 2061 6e6f 7468 6572 0a20 2020  ion, another.   
-000158b0: 2020 2020 2020 2020 2064 6963 7469 6f6e           diction
-000158c0: 6172 7920 636f 6e74 6169 6e69 6e67 2061  ary containing a
-000158d0: 6e79 2073 6f75 7263 6573 2074 6861 7420  ny sources that 
-000158e0: 6d61 7463 6865 6420 746f 2074 6865 2063  matched to the c
-000158f0: 6f6f 7264 696e 6174 6573 2061 6e64 2077  oordinates and w
-00015900: 6572 656e 2774 2063 686f 7365 6e2c 0a20  eren't chosen,. 
-00015910: 2020 2020 2020 2020 2020 2061 6e64 2061             and a
-00015920: 2066 696e 616c 2064 6963 7469 6f6e 6172   final dictionar
-00015930: 7920 7769 7468 2073 6f75 7263 6573 2074  y with sources t
-00015940: 6861 7420 6172 656e 2774 2074 6865 2074  hat aren't the t
-00015950: 6172 6765 742c 206f 7220 696e 2074 6865  arget, or in the
-00015960: 2032 6e64 2064 6963 7469 6f6e 6172 792e   2nd dictionary.
-00015970: 0a20 2020 2020 2020 203a 7274 7970 653a  .        :rtype:
-00015980: 2054 7570 6c65 5b44 6963 742c 2044 6963   Tuple[Dict, Dic
-00015990: 742c 2044 6963 745d 0a20 2020 2020 2020  t, Dict].       
-000159a0: 2022 2222 0a20 2020 2020 2020 2023 2044   """.        # D
-000159b0: 6566 696e 6974 696f 6e73 206f 6620 7468  efinitions of th
-000159c0: 6520 636f 6c6f 7572 7320 6f66 2058 4353  e colours of XCS
-000159d0: 2072 6567 696f 6e73 2063 616e 2062 6520   regions can be 
-000159e0: 666f 756e 6420 696e 2074 6865 2074 6865  found in the the
-000159f0: 7369 7320 6f66 2044 7220 4d69 6368 6561  sis of Dr Michea
-00015a00: 6c20 4461 7669 6473 6f6e 0a20 2020 2020  l Davidson.     
-00015a10: 2020 2023 2020 556e 6976 6572 7369 7479     #  University
-00015a20: 206f 6620 4564 696e 6275 7267 6820 2d20   of Edinburgh - 
-00015a30: 3230 3035 2e20 5468 6573 6520 6172 6520  2005. These are 
-00015a40: 7468 6520 6465 6661 756c 7420 5847 4120  the default XGA 
-00015a50: 636f 6c6f 7572 206d 6561 6e69 6e67 730a  colour meanings.
-00015a60: 2020 2020 2020 2020 2320 5265 6420 2d20          # Red - 
-00015a70: 506f 696e 7420 736f 7572 6365 0a20 2020  Point source.   
-00015a80: 2020 2020 2023 2047 7265 656e 202d 2045       # Green - E
-00015a90: 7874 656e 6465 6420 736f 7572 6365 0a20  xtended source. 
-00015aa0: 2020 2020 2020 2023 204d 6167 656e 7461         # Magenta
-00015ab0: 202d 2050 5346 2d73 697a 6564 2065 7874   - PSF-sized ext
-00015ac0: 656e 6465 6420 736f 7572 6365 0a20 2020  ended source.   
-00015ad0: 2020 2020 2023 2042 6c75 6520 2d20 4578       # Blue - Ex
-00015ae0: 7465 6e64 6564 2073 6f75 7263 6520 7769  tended source wi
-00015af0: 7468 2073 6967 6e69 6669 6361 6e74 2070  th significant p
-00015b00: 6f69 6e74 2073 6f75 7263 6520 636f 6e74  oint source cont
-00015b10: 7269 6275 7469 6f6e 0a20 2020 2020 2020  ribution.       
-00015b20: 2023 2043 7961 6e20 2d20 4578 7465 6e64   # Cyan - Extend
-00015b30: 6564 2073 6f75 7263 6520 7769 7468 2073  ed source with s
-00015b40: 6967 6e69 6669 6361 6e74 2052 756e 3120  ignificant Run1 
-00015b50: 636f 6e74 7269 6275 7469 6f6e 0a20 2020  contribution.   
-00015b60: 2020 2020 2023 2059 656c 6c6f 7720 2d20       # Yellow - 
-00015b70: 4578 7465 6e64 6564 2073 6f75 7263 6520  Extended source 
-00015b80: 7769 7468 206c 6573 7320 7468 616e 2031  with less than 1
-00015b90: 3020 636f 756e 7473 0a20 2020 2020 2020  0 counts.       
-00015ba0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-00015bb0: 2020 2320 4765 7473 2074 6865 2061 6c6c    # Gets the all
-00015bc0: 6f77 6564 2063 6f6c 6f75 7273 2066 6f72  owed colours for
-00015bd0: 2074 6865 2063 7572 7265 6e74 2073 6f75   the current sou
-00015be0: 7263 6520 7479 7065 0a20 2020 2020 2020  rce type.       
-00015bf0: 2020 2020 2061 6c6c 6f77 6564 5f63 6f6c       allowed_col
-00015c00: 6f75 7273 203d 2053 5243 5f52 4547 494f  ours = SRC_REGIO
-00015c10: 4e5f 434f 4c4f 5552 535b 736f 7572 6365  N_COLOURS[source
-00015c20: 5f74 7970 655d 0a20 2020 2020 2020 2065  _type].        e
-00015c30: 7863 6570 7420 4b65 7945 7272 6f72 3a0a  xcept KeyError:.
-00015c40: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00015c50: 6520 5661 6c75 6545 7272 6f72 2822 7b7d  e ValueError("{}
-00015c60: 2069 7320 6e6f 7420 6120 7265 636f 676e   is not a recogn
-00015c70: 6973 6564 2073 6f75 7263 6520 7479 7065  ised source type
-00015c80: 2c20 706c 6561 7365 2022 0a20 2020 2020  , please ".     
-00015c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015ca0: 2020 2020 2020 2020 2264 6f6e 2774 2075          "don't u
-00015cb0: 7365 2074 6869 7320 696e 7465 726e 616c  se this internal
-00015cc0: 2066 756e 6374 696f 6e21 222e 666f 726d   function!".form
-00015cd0: 6174 2873 6f75 7263 655f 7479 7065 2929  at(source_type))
-00015ce0: 0a0a 2020 2020 2020 2020 2320 4865 7265  ..        # Here
-00015cf0: 2077 6520 7374 6f72 6520 7468 6520 6163   we store the ac
-00015d00: 7475 616c 206d 6174 6368 6564 2073 6f75  tual matched sou
-00015d10: 7263 6573 0a20 2020 2020 2020 2072 6573  rces.        res
-00015d20: 756c 7473 5f64 6963 7420 3d20 7b7d 0a20  ults_dict = {}. 
-00015d30: 2020 2020 2020 2023 2041 6e64 2069 6e20         # And in 
-00015d40: 7468 6973 206f 6e65 2067 6f20 616c 6c20  this one go all 
-00015d50: 7468 6520 736f 7572 6365 7320 7468 6174  the sources that
-00015d60: 2061 7265 6e27 7420 7468 6520 6d61 7463   aren't the matc
-00015d70: 6865 6420 736f 7572 6365 2c20 7765 276c  hed source, we'l
-00015d80: 6c20 6e65 6564 2074 6f20 7375 6274 7261  l need to subtra
-00015d90: 6374 2074 6865 6d2e 0a20 2020 2020 2020  ct them..       
-00015da0: 2061 6e74 695f 7265 7375 6c74 735f 6469   anti_results_di
-00015db0: 6374 203d 207b 7d0a 2020 2020 2020 2020  ct = {}.        
-00015dc0: 2320 536f 7572 6365 7320 696e 2074 6869  # Sources in thi
-00015dd0: 7320 6469 6374 696f 6e61 7279 2061 7265  s dictionary are
-00015de0: 2077 6974 6869 6e20 7468 6520 7461 7267   within the targ
-00015df0: 6574 2073 6f75 7263 6520 7265 6769 6f6e  et source region
-00015e00: 2041 4e44 206d 6174 6368 6564 2074 6f20   AND matched to 
-00015e10: 696e 6974 6961 6c20 636f 6f72 6469 6e61  initial coordina
-00015e20: 7465 732c 0a20 2020 2020 2020 2023 2062  tes,.        # b
-00015e30: 7574 2061 7265 6e27 7420 7468 6520 6368  ut aren't the ch
-00015e40: 6f73 656e 2073 6f75 7263 652e 0a20 2020  osen source..   
-00015e50: 2020 2020 2061 6c74 5f6d 6174 6368 5f64       alt_match_d
-00015e60: 6963 7420 3d20 7b7d 0a20 2020 2020 2020  ict = {}.       
-00015e70: 2023 2047 6f65 7320 7468 726f 7567 6820   # Goes through 
-00015e80: 616c 6c20 7468 6520 4f62 7349 4473 2061  all the ObsIDs a
-00015e90: 7373 6f63 6961 7465 6420 7769 7468 2074  ssociated with t
-00015ea0: 6869 7320 736f 7572 6365 2c20 616e 6420  his source, and 
-00015eb0: 6368 6563 6b73 2069 6620 7468 6579 2068  checks if they h
-00015ec0: 6176 6520 7265 6769 6f6e 730a 2020 2020  ave regions.    
-00015ed0: 2020 2020 2320 2049 6620 6e6f 7420 7468      #  If not th
-00015ee0: 656e 204e 6f6e 6573 2061 7265 2061 6464  en Nones are add
-00015ef0: 6564 2074 6f20 7468 6520 7661 7269 6f75  ed to the variou
-00015f00: 7320 6469 6374 696f 6e61 7269 6573 2c20  s dictionaries, 
-00015f10: 6f74 6865 7277 6973 6520 796f 7520 656e  otherwise you en
-00015f20: 6420 7570 2077 6974 6820 6120 6c69 7374  d up with a list
-00015f30: 206f 6620 7265 6769 6f6e 730a 2020 2020   of regions.    
-00015f40: 2020 2020 2320 2077 6974 6820 6d69 7373      #  with miss
-00015f50: 696e 6720 4f62 7349 4473 0a20 2020 2020  ing ObsIDs.     
-00015f60: 2020 2066 6f72 206f 6273 2069 6e20 7365     for obs in se
-00015f70: 6c66 2e6f 6273 5f69 6473 3a0a 2020 2020  lf.obs_ids:.    
-00015f80: 2020 2020 2020 2020 6966 206f 6273 2069          if obs i
-00015f90: 6e20 7365 6c66 2e5f 696e 6974 6961 6c5f  n self._initial_
-00015fa0: 7265 6769 6f6e 733a 0a20 2020 2020 2020  regions:.       
-00015fb0: 2020 2020 2020 2020 2023 2054 6869 7320           # This 
-00015fc0: 7365 7473 2075 7020 616e 2061 7272 6179  sets up an array
-00015fd0: 206f 6620 6d61 7463 6865 6420 7265 6769   of matched regi
-00015fe0: 6f6e 732c 2061 6363 6f75 6e74 696e 6720  ons, accounting 
-00015ff0: 666f 7220 7468 6520 7072 6f62 6c65 6d73  for the problems
-00016000: 2074 6861 7420 6361 6e20 6f63 6375 7220   that can occur 
-00016010: 7768 656e 0a20 2020 2020 2020 2020 2020  when.           
-00016020: 2020 2020 2023 2020 7468 6572 6520 6973       #  there is
-00016030: 206f 6e6c 7920 6f6e 6520 7265 6769 6f6e   only one region
-00016040: 2069 6e20 7468 6520 7265 6769 6f6e 206c   in the region l
-00016050: 6973 7420 286e 756d 7079 2773 2069 6e64  ist (numpy's ind
-00016060: 6578 696e 6720 6765 7473 2076 6572 7920  exing gets very 
-00016070: 616e 6772 7929 2e20 5468 6520 6172 7261  angry). The arra
-00016080: 790a 2020 2020 2020 2020 2020 2020 2020  y.              
-00016090: 2020 2320 206f 6620 6d61 7463 6865 6420    #  of matched 
-000160a0: 7265 6769 6f6e 2873 2920 7365 7420 7570  region(s) set up
-000160b0: 2068 6572 6520 6973 2075 7365 6420 696e   here is used in
-000160c0: 2074 6869 7320 6d65 7468 6f64 2e0a 2020   this method..  
-000160d0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000160e0: 206c 656e 2873 656c 662e 5f69 6e69 7469   len(self._initi
-000160f0: 616c 5f72 6567 696f 6e73 5b6f 6273 5d29  al_regions[obs])
-00016100: 203d 3d20 3120 616e 6420 6e6f 7420 7365   == 1 and not se
-00016110: 6c66 2e5f 696e 6974 6961 6c5f 7265 6769  lf._initial_regi
-00016120: 6f6e 5f6d 6174 6368 6573 5b6f 6273 5d5b  on_matches[obs][
-00016130: 305d 3a0a 2020 2020 2020 2020 2020 2020  0]:.            
-00016140: 2020 2020 2020 2020 696e 6974 5f72 6567          init_reg
-00016150: 696f 6e5f 6d61 7463 6865 7320 3d20 6e70  ion_matches = np
-00016160: 2e61 7272 6179 285b 5d29 0a20 2020 2020  .array([]).     
-00016170: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-00016180: 6c65 6e28 7365 6c66 2e5f 696e 6974 6961  len(self._initia
-00016190: 6c5f 7265 6769 6f6e 735b 6f62 735d 2920  l_regions[obs]) 
-000161a0: 3d3d 2031 2061 6e64 2073 656c 662e 5f69  == 1 and self._i
-000161b0: 6e69 7469 616c 5f72 6567 696f 6e5f 6d61  nitial_region_ma
-000161c0: 7463 6865 735b 6f62 735d 5b30 5d3a 0a20  tches[obs][0]:. 
-000161d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000161e0: 2020 2069 6e69 745f 7265 6769 6f6e 5f6d     init_region_m
-000161f0: 6174 6368 6573 203d 2073 656c 662e 5f69  atches = self._i
-00016200: 6e69 7469 616c 5f72 6567 696f 6e73 5b6f  nitial_regions[o
-00016210: 6273 5d0a 2020 2020 2020 2020 2020 2020  bs].            
-00016220: 2020 2020 656c 6966 206c 656e 2873 656c      elif len(sel
-00016230: 662e 5f69 6e69 7469 616c 5f72 6567 696f  f._initial_regio
-00016240: 6e73 5b6f 6273 5d5b 7365 6c66 2e5f 696e  ns[obs][self._in
-00016250: 6974 6961 6c5f 7265 6769 6f6e 5f6d 6174  itial_region_mat
-00016260: 6368 6573 5b6f 6273 5d5d 2920 3d3d 2030  ches[obs]]) == 0
-00016270: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00016280: 2020 2020 2020 696e 6974 5f72 6567 696f        init_regio
-00016290: 6e5f 6d61 7463 6865 7320 3d20 6e70 2e61  n_matches = np.a
-000162a0: 7272 6179 285b 5d29 0a20 2020 2020 2020  rray([]).       
-000162b0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-000162c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000162d0: 2020 2069 6e69 745f 7265 6769 6f6e 5f6d     init_region_m
-000162e0: 6174 6368 6573 203d 2073 656c 662e 5f69  atches = self._i
-000162f0: 6e69 7469 616c 5f72 6567 696f 6e73 5b6f  nitial_regions[o
-00016300: 6273 5d5b 7365 6c66 2e5f 696e 6974 6961  bs][self._initia
-00016310: 6c5f 7265 6769 6f6e 5f6d 6174 6368 6573  l_region_matches
-00016320: 5b6f 6273 5d5d 0a0a 2020 2020 2020 2020  [obs]]..        
-00016330: 2020 2020 2020 2020 2320 4966 2074 6865          # If the
-00016340: 7265 2061 7265 206e 6f20 6d61 7463 6865  re are no matche
-00016350: 7320 7468 656e 2074 6865 2072 6574 7572  s then the retur
-00016360: 6e65 6420 7265 7375 6c74 2069 7320 6a75  ned result is ju
-00016370: 7374 204e 6f6e 652e 0a20 2020 2020 2020  st None..       
-00016380: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
-00016390: 696e 6974 5f72 6567 696f 6e5f 6d61 7463  init_region_matc
-000163a0: 6865 7329 203d 3d20 303a 0a20 2020 2020  hes) == 0:.     
-000163b0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-000163c0: 6573 756c 7473 5f64 6963 745b 6f62 735d  esults_dict[obs]
-000163d0: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-000163e0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-000163f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016400: 2020 696e 7465 7269 6d5f 7265 6720 3d20    interim_reg = 
-00016410: 5b5d 0a20 2020 2020 2020 2020 2020 2020  [].             
-00016420: 2020 2020 2020 2023 2054 6865 206f 6e6c         # The onl
-00016430: 7920 736f 6c75 7469 6f6e 2049 2063 6f75  y solution I cou
-00016440: 6c64 2074 6869 6e6b 206f 6620 6973 2074  ld think of is t
-00016450: 6f20 676f 2062 7920 7468 6520 5843 5320  o go by the XCS 
-00016460: 7374 616e 6461 7264 206f 6620 7265 6769  standard of regi
-00016470: 6f6e 2066 696c 6573 2c20 736f 2067 7265  on files, so gre
-00016480: 656e 0a20 2020 2020 2020 2020 2020 2020  en.             
-00016490: 2020 2020 2020 2023 2020 6973 2065 7874         #  is ext
-000164a0: 656e 6465 642c 2072 6564 2069 7320 706f  ended, red is po
-000164b0: 696e 7420 6574 632e 202d 206e 6f74 2069  int etc. - not i
-000164c0: 6465 616c 2062 7574 2049 276c 6c20 6a75  deal but I'll ju
-000164d0: 7374 2065 7870 6c61 696e 2069 6e20 7468  st explain in th
-000164e0: 6520 646f 6375 6d65 6e74 6174 696f 6e0a  e documentation.
-000164f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016500: 2020 2020 2320 666f 7220 656e 7472 7920      # for entry 
-00016510: 696e 2073 656c 662e 5f69 6e69 7469 616c  in self._initial
-00016520: 5f72 6567 696f 6e73 5b6f 6273 5d5b 7365  _regions[obs][se
-00016530: 6c66 2e5f 696e 6974 6961 6c5f 7265 6769  lf._initial_regi
-00016540: 6f6e 5f6d 6174 6368 6573 5b6f 6273 5d5d  on_matches[obs]]
-00016550: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00016560: 2020 2020 2020 666f 7220 656e 7472 7920        for entry 
-00016570: 696e 2069 6e69 745f 7265 6769 6f6e 5f6d  in init_region_m
-00016580: 6174 6368 6573 3a0a 2020 2020 2020 2020  atches:.        
-00016590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000165a0: 6966 2065 6e74 7279 2e76 6973 7561 6c5b  if entry.visual[
-000165b0: 2263 6f6c 6f72 225d 2069 6e20 616c 6c6f  "color"] in allo
-000165c0: 7765 645f 636f 6c6f 7572 733a 0a20 2020  wed_colours:.   
-000165d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000165e0: 2020 2020 2020 2020 2069 6e74 6572 696d           interim
-000165f0: 5f72 6567 2e61 7070 656e 6428 656e 7472  _reg.append(entr
-00016600: 7929 0a0a 2020 2020 2020 2020 2020 2020  y)..            
-00016610: 2020 2020 2020 2020 2320 4469 6666 6572          # Differ
-00016620: 656e 7420 6d61 7463 6869 6e67 2070 6f73  ent matching pos
-00016630: 7369 6269 6c69 7469 6573 0a20 2020 2020  sibilities.     
-00016640: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00016650: 6620 6c65 6e28 696e 7465 7269 6d5f 7265  f len(interim_re
-00016660: 6729 203d 3d20 303a 0a20 2020 2020 2020  g) == 0:.       
-00016670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016680: 2072 6573 756c 7473 5f64 6963 745b 6f62   results_dict[ob
-00016690: 735d 203d 204e 6f6e 650a 2020 2020 2020  s] = None.      
-000166a0: 2020 2020 2020 2020 2020 2020 2020 656c                el
-000166b0: 6966 206c 656e 2869 6e74 6572 696d 5f72  if len(interim_r
-000166c0: 6567 2920 3d3d 2031 3a0a 2020 2020 2020  eg) == 1:.      
-000166d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000166e0: 2020 7265 7375 6c74 735f 6469 6374 5b6f    results_dict[o
-000166f0: 6273 5d20 3d20 696e 7465 7269 6d5f 7265  bs] = interim_re
-00016700: 675b 305d 0a20 2020 2020 2020 2020 2020  g[0].           
-00016710: 2020 2020 2020 2020 2023 204d 6174 6368           # Match
-00016720: 696e 6720 746f 206d 756c 7469 706c 6520  ing to multiple 
-00016730: 736f 7572 6365 7320 776f 756c 6420 6265  sources would be
-00016740: 2076 6572 7920 7072 6f62 6c65 6d61 7469   very problemati
-00016750: 632c 2073 6f20 7468 726f 7720 616e 2065  c, so throw an e
-00016760: 7272 6f72 0a20 2020 2020 2020 2020 2020  rror.           
-00016770: 2020 2020 2020 2020 2065 6c69 6620 6c65           elif le
-00016780: 6e28 696e 7465 7269 6d5f 7265 6729 203e  n(interim_reg) >
-00016790: 2031 2061 6e64 2073 6f75 7263 655f 7479   1 and source_ty
-000167a0: 7065 203d 3d20 2270 6e74 223a 0a20 2020  pe == "pnt":.   
-000167b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000167c0: 2020 2020 2023 2049 206d 6164 6520 7468       # I made th
-000167d0: 6520 5f6c 6f61 645f 7265 6769 6f6e 7320  e _load_regions 
-000167e0: 6d65 7468 6f64 2073 6f72 7420 7468 6520  method sort the 
-000167f0: 6f75 7470 7574 7465 6420 7265 6769 6f6e  outputted region
-00016800: 2064 6963 7469 6f6e 6172 6965 7320 6279   dictionaries by
-00016810: 2064 6973 7461 6e63 6520 6672 6f6d 2074   distance from t
-00016820: 6865 0a20 2020 2020 2020 2020 2020 2020  he.             
-00016830: 2020 2020 2020 2020 2020 2023 2020 696e             #  in
-00016840: 7075 7420 636f 6f72 6469 6e61 7465 732c  put coordinates,
-00016850: 2073 6f20 4920 6b6e 6f77 2074 6861 7420   so I know that 
-00016860: 7468 6520 3074 6820 656e 7472 7920 7769  the 0th entry wi
-00016870: 6c6c 2062 6520 7468 6520 636c 6f73 6573  ll be the closes
-00016880: 7420 746f 2074 6865 2073 6f75 7263 6520  t to the source 
-00016890: 636f 6f72 6473 2e0a 2020 2020 2020 2020  coords..        
-000168a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000168b0: 2320 2048 656e 6365 2049 2063 686f 6f73  #  Hence I choos
-000168c0: 6520 7468 6174 206f 6e65 2066 6f72 2070  e that one for p
-000168d0: 6e74 2073 6f75 7263 6520 6d75 6c74 692d  nt source multi-
-000168e0: 6d61 7463 6865 7320 6c69 6b65 2074 6869  matches like thi
-000168f0: 732c 2073 6565 2063 6f6d 6d65 6e74 2032  s, see comment 2
-00016900: 206f 6620 6973 7375 6520 2336 3339 0a20   of issue #639. 
-00016910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016920: 2020 2020 2020 2023 2020 666f 7220 616e         #  for an
-00016930: 2065 7861 6d70 6c65 2e0a 2020 2020 2020   example..      
-00016940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016950: 2020 7265 7375 6c74 735f 6469 6374 5b6f    results_dict[o
-00016960: 6273 5d20 3d20 696e 7465 7269 6d5f 7265  bs] = interim_re
-00016970: 675b 305d 0a20 2020 2020 2020 2020 2020  g[0].           
-00016980: 2020 2020 2020 2020 2020 2020 2077 6172               war
-00016990: 6e5f 7465 7874 203d 2022 7b6e 737d 206d  n_text = "{ns} m
-000169a0: 6174 6368 6573 2066 6f72 2074 6865 2070  atches for the p
-000169b0: 6f69 6e74 2073 6f75 7263 6520 7b6e 7d20  oint source {n} 
-000169c0: 6172 6520 666f 756e 6420 696e 2074 6865  are found in the
-000169d0: 207b 6f7d 2072 6567 696f 6e20 2220 5c0a   {o} region " \.
-000169e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000169f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016a00: 2020 2020 2266 696c 652e 2054 6865 2073      "file. The s
-00016a10: 6f75 7263 6520 6e65 6172 6573 7420 746f  ource nearest to
-00016a20: 2074 6865 2070 6173 7365 6420 636f 6f72   the passed coor
-00016a30: 6469 6e61 7465 7320 6973 2061 6363 6570  dinates is accep
-00016a40: 7465 642c 2061 6c6c 206f 7468 6572 7320  ted, all others 
-00016a50: 2220 5c0a 2020 2020 2020 2020 2020 2020  " \.            
-00016a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016a70: 2020 2020 2020 2020 2277 696c 6c20 6265          "will be
-00016a80: 2070 6c61 6365 6420 696e 2074 6865 2061   placed in the a
-00016a90: 6c74 6572 6e61 7465 206d 6174 6368 2063  lternate match c
-00016aa0: 6174 6567 6f72 7920 616e 6420 7769 6c6c  ategory and will
-00016ab0: 206e 6f74 2062 6520 7265 6d6f 7665 6420   not be removed 
-00016ac0: 2220 5c0a 2020 2020 2020 2020 2020 2020  " \.            
-00016ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016ae0: 2020 2020 2020 2020 2262 7920 6d61 736b          "by mask
-00016af0: 732e 222e 666f 726d 6174 286f 3d6f 6273  s.".format(o=obs
-00016b00: 2c20 6e3d 7365 6c66 2e6e 616d 652c 206e  , n=self.name, n
-00016b10: 733d 6c65 6e28 696e 7465 7269 6d5f 7265  s=len(interim_re
-00016b20: 6729 290a 2020 2020 2020 2020 2020 2020  g)).            
-00016b30: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-00016b40: 6f74 2073 656c 662e 5f73 616d 705f 6d65  ot self._samp_me
-00016b50: 6d62 6572 3a0a 2020 2020 2020 2020 2020  mber:.          
-00016b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016b70: 2020 7761 726e 2877 6172 6e5f 7465 7874    warn(warn_text
-00016b80: 2c20 7374 6163 6b6c 6576 656c 3d32 290a  , stacklevel=2).
-00016b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016ba0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00016bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016bc0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-00016bd0: 7375 7070 5f77 6172 6e2e 6170 7065 6e64  supp_warn.append
-00016be0: 2877 6172 6e5f 7465 7874 290a 0a20 2020  (warn_text)..   
-00016bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016c00: 2065 6c69 6620 6c65 6e28 696e 7465 7269   elif len(interi
-00016c10: 6d5f 7265 6729 203e 2031 2061 6e64 2073  m_reg) > 1 and s
-00016c20: 6f75 7263 655f 7479 7065 203d 3d20 2265  ource_type == "e
-00016c30: 7874 223a 0a20 2020 2020 2020 2020 2020  xt":.           
-00016c40: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-00016c50: 7365 204d 756c 7469 706c 654d 6174 6368  se MultipleMatch
-00016c60: 4572 726f 7228 224d 6f72 6520 7468 616e  Error("More than
-00016c70: 206f 6e65 206d 6174 6368 2066 6f72 207b   one match for {
-00016c80: 6e7d 2069 7320 666f 756e 6420 696e 2074  n} is found in t
-00016c90: 6865 2072 6567 696f 6e20 6669 6c65 2022  he region file "
-00016ca0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011420: 2020 7370 6563 203d 2073 656c 662e 6765    spec = self.ge
+00011430: 745f 7072 6f64 7563 7473 2822 7370 6563  t_products("spec
+00011440: 7472 756d 222c 2063 6f6d 625b 3a31 305d  trum", comb[:10]
+00011450: 2c20 636f 6d62 5b31 303a 5d2c 2065 7874  , comb[10:], ext
+00011460: 7261 5f6b 6579 3d73 746f 7261 6765 5f6b  ra_key=storage_k
+00011470: 6579 295b 305d 0a20 2020 2020 2020 2020  ey)[0].         
+00011480: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00011490: 656c 5f73 7065 632e 6170 7065 6e64 2873  el_spec.append(s
+000114a0: 7065 6329 0a0a 2020 2020 2020 2020 2020  pec)..          
+000114b0: 2020 2020 2020 2020 2020 666f 7220 636f            for co
+000114c0: 6d62 5f69 6e64 2c20 636f 6d62 2069 6e20  mb_ind, comb in 
+000114d0: 656e 756d 6572 6174 6528 636f 6d62 6f73  enumerate(combos
+000114e0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000114f0: 2020 2020 2020 2020 2020 2072 656c 5f73             rel_s
+00011500: 7065 635b 636f 6d62 5f69 6e64 5d2e 6164  pec[comb_ind].ad
+00011510: 645f 636f 6e76 5f66 6163 746f 7273 2872  d_conv_factors(r
+00011520: 6573 5f74 6162 6c65 5b22 6c6f 5f65 6e22  es_table["lo_en"
+00011530: 5d2e 7661 6c75 6573 2c20 7265 735f 7461  ].values, res_ta
+00011540: 626c 655b 2268 695f 656e 225d 2e76 616c  ble["hi_en"].val
+00011550: 7565 732c 0a20 2020 2020 2020 2020 2020  ues,.           
+00011560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011590: 2072 6573 5f74 6162 6c65 5b22 7261 7465   res_table["rate
+000115a0: 5f7b 7d22 2e66 6f72 6d61 7428 636f 6d62  _{}".format(comb
+000115b0: 295d 2e76 616c 7565 732c 0a20 2020 2020  )].values,.     
+000115c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000115d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000115e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000115f0: 2020 2020 2020 2072 6573 5f74 6162 6c65         res_table
+00011600: 5b22 4c78 5f7b 7d22 2e66 6f72 6d61 7428  ["Lx_{}".format(
+00011610: 636f 6d62 295d 2e76 616c 7565 732c 206d  comb)].values, m
+00011620: 6f64 656c 290a 0a20 2020 2020 2020 2020  odel)..         
+00011630: 2020 2020 2020 2023 2054 6869 7320 7472         # This tr
+00011640: 6967 6765 7273 2069 6e20 7468 6520 6361  iggers in the ca
+00011650: 7365 206f 6620 736f 6d65 7468 696e 6720  se of something 
+00011660: 6c69 6b65 2069 7373 7565 2023 3733 382c  like issue #738,
+00011670: 2077 6865 7265 2061 2070 7265 7669 6f75   where a previou
+00011680: 7320 6669 7420 7573 6564 2064 6174 6120  s fit used data 
+00011690: 7468 6174 2069 730a 2020 2020 2020 2020  that is.        
+000116a0: 2020 2020 2020 2020 2320 206e 6f74 206c          #  not l
+000116b0: 6f61 6465 6420 696e 746f 2074 6869 7320  oaded into this 
+000116c0: 736f 7572 6365 2028 6569 7468 6572 2062  source (either b
+000116d0: 6563 6175 7365 2069 7420 7761 7320 6d61  ecause it was ma
+000116e0: 6e75 616c 6c79 2072 656d 6f76 6564 2c20  nually removed, 
+000116f0: 6f72 2062 6563 6175 7365 2074 6865 2063  or because the c
+00011700: 656e 7472 616c 0a20 2020 2020 2020 2020  entral.         
+00011710: 2020 2020 2020 2023 2020 706f 7369 7469         #  positi
+00011720: 6f6e 2068 6173 2063 6861 6e67 6564 2065  on has changed e
+00011730: 7463 2e29 0a20 2020 2020 2020 2020 2020  tc.).           
+00011740: 2020 2020 2065 7863 6570 7420 4e6f 7441       except NotA
+00011750: 7373 6f63 6961 7465 6445 7272 6f72 3a0a  ssociatedError:.
+00011760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011770: 2020 2020 7761 726e 5f74 6578 7420 3d20      warn_text = 
+00011780: 2245 7869 7374 696e 6720 6669 7420 666f  "Existing fit fo
+00011790: 7220 7b73 7d20 636f 756c 6420 6e6f 7420  r {s} could not 
+000117a0: 6265 206c 6f61 6465 6420 6475 6520 746f  be loaded due to
+000117b0: 2061 206d 6973 6d61 7463 6820 696e 2061   a mismatch in a
+000117c0: 7661 696c 6162 6c65 2022 205c 0a20 2020  vailable " \.   
+000117d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000117e0: 2020 2020 2020 2020 2020 2020 2022 6461               "da
+000117f0: 7461 222e 666f 726d 6174 2873 3d73 656c  ta".format(s=sel
+00011800: 662e 6e61 6d65 290a 2020 2020 2020 2020  f.name).        
+00011810: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+00011820: 6f74 2073 656c 662e 5f73 616d 705f 6d65  ot self._samp_me
+00011830: 6d62 6572 3a0a 2020 2020 2020 2020 2020  mber:.          
+00011840: 2020 2020 2020 2020 2020 2020 2020 7761                wa
+00011850: 726e 2877 6172 6e5f 7465 7874 2c20 7374  rn(warn_text, st
+00011860: 6163 6b6c 6576 656c 3d32 290a 2020 2020  acklevel=2).    
+00011870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011880: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00011890: 2020 2020 2020 2020 2020 2020 2020 7365                se
+000118a0: 6c66 2e5f 7375 7070 5f77 6172 6e2e 6170  lf._supp_warn.ap
+000118b0: 7065 6e64 2877 6172 6e5f 7465 7874 290a  pend(warn_text).
+000118c0: 0a20 2020 2064 6566 2067 6574 5f70 726f  .    def get_pro
+000118d0: 6475 6374 7328 7365 6c66 2c20 705f 7479  ducts(self, p_ty
+000118e0: 7065 3a20 7374 722c 206f 6273 5f69 643a  pe: str, obs_id:
+000118f0: 2073 7472 203d 204e 6f6e 652c 2069 6e73   str = None, ins
+00011900: 743a 2073 7472 203d 204e 6f6e 652c 2065  t: str = None, e
+00011910: 7874 7261 5f6b 6579 3a20 7374 7220 3d20  xtra_key: str = 
+00011920: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+00011930: 2020 2020 2020 2020 2020 206a 7573 745f             just_
+00011940: 6f62 6a3a 2062 6f6f 6c20 3d20 5472 7565  obj: bool = True
+00011950: 2920 2d3e 204c 6973 745b 4261 7365 5072  ) -> List[BasePr
+00011960: 6f64 7563 745d 3a0a 2020 2020 2020 2020  oduct]:.        
+00011970: 2222 220a 2020 2020 2020 2020 5468 6973  """.        This
+00011980: 2069 7320 7468 6520 6765 7474 6572 2066   is the getter f
+00011990: 6f72 2074 6865 2070 726f 6475 6374 7320  or the products 
+000119a0: 6461 7461 2073 7472 7563 7475 7265 206f  data structure o
+000119b0: 6620 536f 7572 6365 206f 626a 6563 7473  f Source objects
+000119c0: 2e20 5061 7373 696e 6720 6120 2770 726f  . Passing a 'pro
+000119d0: 6475 6374 2074 7970 6527 0a20 2020 2020  duct type'.     
+000119e0: 2020 2073 7563 6820 6173 2027 6576 656e     such as 'even
+000119f0: 7473 2720 6f72 2027 696d 6167 6573 2720  ts' or 'images' 
+00011a00: 7769 6c6c 2072 6574 7572 6e20 6576 6572  will return ever
+00011a10: 7920 6d61 7463 6869 6e67 2065 6e74 7279  y matching entry
+00011a20: 2069 6e20 7468 6520 7072 6f64 7563 7473   in the products
+00011a30: 2064 6174 6120 7374 7275 6374 7572 652e   data structure.
+00011a40: 0a0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
+00011a50: 2073 7472 2070 5f74 7970 653a 2050 726f   str p_type: Pro
+00011a60: 6475 6374 2074 7970 6520 6964 656e 7469  duct type identi
+00011a70: 6669 6572 2e20 652e 672e 2069 6d61 6765  fier. e.g. image
+00011a80: 206f 7220 6578 706d 6170 2e0a 2020 2020   or expmap..    
+00011a90: 2020 2020 3a70 6172 616d 2073 7472 206f      :param str o
+00011aa0: 6273 5f69 643a 204f 7074 696f 6e61 6c6c  bs_id: Optionall
+00011ab0: 792c 2061 2073 7065 6369 6669 6320 6f62  y, a specific ob
+00011ac0: 735f 6964 2074 6f20 7365 6172 6368 2063  s_id to search c
+00011ad0: 616e 2062 6520 7375 7070 6c69 6564 2e0a  an be supplied..
+00011ae0: 2020 2020 2020 2020 3a70 6172 616d 2073          :param s
+00011af0: 7472 2069 6e73 743a 204f 7074 696f 6e61  tr inst: Optiona
+00011b00: 6c6c 792c 2061 2073 7065 6369 6669 6320  lly, a specific 
+00011b10: 696e 7374 7275 6d65 6e74 2074 6f20 7365  instrument to se
+00011b20: 6172 6368 2063 616e 2062 6520 7375 7070  arch can be supp
+00011b30: 6c69 6564 2e0a 2020 2020 2020 2020 3a70  lied..        :p
+00011b40: 6172 616d 2073 7472 2065 7874 7261 5f6b  aram str extra_k
+00011b50: 6579 3a20 4f70 7469 6f6e 616c 6c79 2c20  ey: Optionally, 
+00011b60: 616e 2065 7874 7261 206b 6579 2028 6c69  an extra key (li
+00011b70: 6b65 2061 6e20 656e 6572 6779 2062 6f75  ke an energy bou
+00011b80: 6e64 2920 6361 6e20 6265 2073 7570 706c  nd) can be suppl
+00011b90: 6965 642e 0a20 2020 2020 2020 203a 7061  ied..        :pa
+00011ba0: 7261 6d20 626f 6f6c 206a 7573 745f 6f62  ram bool just_ob
+00011bb0: 6a3a 2041 2062 6f6f 6c65 616e 2066 6c61  j: A boolean fla
+00011bc0: 6720 7468 6174 2063 6f6e 7472 6f6c 7320  g that controls 
+00011bd0: 7768 6574 6865 7220 7468 6973 206d 6574  whether this met
+00011be0: 686f 6420 7265 7475 726e 7320 6a75 7374  hod returns just
+00011bf0: 2074 6865 2070 726f 6475 6374 206f 626a   the product obj
+00011c00: 6563 7473 2c0a 2020 2020 2020 2020 2020  ects,.          
+00011c10: 2020 6f72 2074 6865 206f 7468 6572 2069    or the other i
+00011c20: 6e66 6f72 6d61 7469 6f6e 2074 6861 7420  nformation that 
+00011c30: 676f 6573 2077 6974 6820 6974 206c 696b  goes with it lik
+00011c40: 6520 4f62 7349 4420 616e 6420 696e 7374  e ObsID and inst
+00011c50: 7275 6d65 6e74 2e0a 2020 2020 2020 2020  rument..        
+00011c60: 3a72 6574 7572 6e3a 204c 6973 7420 6f66  :return: List of
+00011c70: 206d 6174 6368 696e 6720 7072 6f64 7563   matching produc
+00011c80: 7473 2e0a 2020 2020 2020 2020 3a72 7479  ts..        :rty
+00011c90: 7065 3a20 4c69 7374 5b42 6173 6550 726f  pe: List[BasePro
+00011ca0: 6475 6374 5d0a 2020 2020 2020 2020 2222  duct].        ""
+00011cb0: 220a 0a20 2020 2020 2020 2064 6566 2075  "..        def u
+00011cc0: 6e70 6163 6b5f 6c69 7374 2874 6f5f 756e  npack_list(to_un
+00011cd0: 7061 636b 3a20 6c69 7374 293a 0a20 2020  pack: list):.   
+00011ce0: 2020 2020 2020 2020 2022 2222 0a20 2020           """.   
+00011cf0: 2020 2020 2020 2020 2041 2072 6563 7572           A recur
+00011d00: 7369 7665 2066 756e 6374 696f 6e20 746f  sive function to
+00011d10: 2067 6f20 7468 726f 7567 6820 6576 6572   go through ever
+00011d20: 7920 6c61 7965 7220 6f66 2061 206e 6573  y layer of a nes
+00011d30: 7465 6420 6c69 7374 2061 6e64 2066 6c61  ted list and fla
+00011d40: 7474 656e 2069 7420 616c 6c20 6f75 742e  tten it all out.
+00011d50: 2049 740a 2020 2020 2020 2020 2020 2020   It.            
+00011d60: 646f 6573 6e27 7420 7265 7475 726e 2061  doesn't return a
+00011d70: 6e79 7468 696e 6720 6265 6361 7573 6520  nything because 
+00011d80: 746f 206d 616b 6520 6c69 6665 2065 6173  to make life eas
+00011d90: 6965 7220 7468 6520 2772 6573 756c 7473  ier the 'results
+00011da0: 2720 6172 6520 6170 7065 6e64 6564 2074  ' are appended t
+00011db0: 6f20 6120 7661 7269 6162 6c65 0a20 2020  o a variable.   
+00011dc0: 2020 2020 2020 2020 2069 6e20 7468 6520           in the 
+00011dd0: 6e61 6d65 7370 6163 6520 6162 6f76 6520  namespace above 
+00011de0: 7468 6973 206f 6e65 2e0a 0a20 2020 2020  this one...     
+00011df0: 2020 2020 2020 203a 7061 7261 6d20 6c69         :param li
+00011e00: 7374 2074 6f5f 756e 7061 636b 3a20 5468  st to_unpack: Th
+00011e10: 6520 6c69 7374 2074 6861 7420 6e65 6564  e list that need
+00011e20: 7320 756e 7061 636b 696e 672e 0a20 2020  s unpacking..   
+00011e30: 2020 2020 2020 2020 2022 2222 0a20 2020           """.   
+00011e40: 2020 2020 2020 2020 2023 204d 7573 7420           # Must 
+00011e50: 6974 6572 6174 6520 7468 726f 7567 6820  iterate through 
+00011e60: 7468 6520 6769 7665 6e20 6c69 7374 0a20  the given list. 
+00011e70: 2020 2020 2020 2020 2020 2066 6f72 2065             for e
+00011e80: 6e74 7279 2069 6e20 746f 5f75 6e70 6163  ntry in to_unpac
+00011e90: 6b3a 0a20 2020 2020 2020 2020 2020 2020  k:.             
+00011ea0: 2020 2023 2049 6620 7468 6520 6375 7272     # If the curr
+00011eb0: 656e 7420 656c 656d 656e 7420 6973 206e  ent element is n
+00011ec0: 6f74 2061 206c 6973 7420 7468 656e 2061  ot a list then a
+00011ed0: 6c6c 2069 7320 6368 696c 6c2c 2074 6869  ll is chill, thi
+00011ee0: 7320 656c 656d 656e 7420 6973 2072 6561  s element is rea
+00011ef0: 6479 2066 6f72 2061 7070 656e 6469 6e67  dy for appending
+00011f00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011f10: 2023 2074 6f20 7468 6520 6669 6e61 6c20   # to the final 
+00011f20: 6c69 7374 0a20 2020 2020 2020 2020 2020  list.           
+00011f30: 2020 2020 2069 6620 6e6f 7420 6973 696e       if not isin
+00011f40: 7374 616e 6365 2865 6e74 7279 2c20 6c69  stance(entry, li
+00011f50: 7374 293a 0a20 2020 2020 2020 2020 2020  st):.           
+00011f60: 2020 2020 2020 2020 206f 7574 2e61 7070           out.app
+00011f70: 656e 6428 656e 7472 7929 0a20 2020 2020  end(entry).     
+00011f80: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00011f90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011fa0: 2020 2020 2023 2049 6620 7468 6520 6375       # If the cu
+00011fb0: 7272 656e 7420 656c 656d 656e 7420 4953  rrent element IS
+00011fc0: 2061 206c 6973 742c 2074 6865 6e20 6f62   a list, then ob
+00011fd0: 7669 6f75 736c 7920 7765 2073 7469 6c6c  viously we still
+00011fe0: 2068 6176 6520 6d6f 7265 2075 6e70 6163   have more unpac
+00011ff0: 6b69 6e67 2074 6f20 646f 2c0a 2020 2020  king to do,.    
+00012000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012010: 2320 736f 2077 6520 6361 6c6c 2074 6869  # so we call thi
+00012020: 7320 6675 6e63 7469 6f6e 2072 6563 7572  s function recur
+00012030: 7369 7665 6c79 2e0a 2020 2020 2020 2020  sively..        
+00012040: 2020 2020 2020 2020 2020 2020 756e 7061              unpa
+00012050: 636b 5f6c 6973 7428 656e 7472 7929 0a0a  ck_list(entry)..
+00012060: 2020 2020 2020 2020 6966 206f 6273 5f69          if obs_i
+00012070: 6420 6e6f 7420 696e 2073 656c 662e 5f70  d not in self._p
+00012080: 726f 6475 6374 7320 616e 6420 6f62 735f  roducts and obs_
+00012090: 6964 2069 7320 6e6f 7420 4e6f 6e65 3a0a  id is not None:.
+000120a0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+000120b0: 6520 4e6f 7441 7373 6f63 6961 7465 6445  e NotAssociatedE
+000120c0: 7272 6f72 2822 7b30 7d20 6973 206e 6f74  rror("{0} is not
+000120d0: 2061 7373 6f63 6961 7465 6420 7769 7468   associated with
+000120e0: 207b 317d 202e 222e 666f 726d 6174 286f   {1} .".format(o
+000120f0: 6273 5f69 642c 2073 656c 662e 6e61 6d65  bs_id, self.name
+00012100: 2929 0a20 2020 2020 2020 2065 6c69 6620  )).        elif 
+00012110: 286f 6273 5f69 6420 6973 206e 6f74 204e  (obs_id is not N
+00012120: 6f6e 6520 616e 6420 6f62 735f 6964 2069  one and obs_id i
+00012130: 6e20 7365 6c66 2e5f 7072 6f64 7563 7473  n self._products
+00012140: 2920 616e 6420 5c0a 2020 2020 2020 2020  ) and \.        
+00012150: 2020 2020 2020 2020 2869 6e73 7420 6973          (inst is
+00012160: 206e 6f74 204e 6f6e 6520 616e 6420 696e   not None and in
+00012170: 7374 206e 6f74 2069 6e20 7365 6c66 2e5f  st not in self._
+00012180: 7072 6f64 7563 7473 5b6f 6273 5f69 645d  products[obs_id]
+00012190: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+000121a0: 6169 7365 204e 6f74 4173 736f 6369 6174  aise NotAssociat
+000121b0: 6564 4572 726f 7228 227b 307d 2069 7320  edError("{0} is 
+000121c0: 6173 736f 6369 6174 6564 2077 6974 6820  associated with 
+000121d0: 7b31 7d2c 2062 7574 207b 327d 2069 7320  {1}, but {2} is 
+000121e0: 6e6f 7420 6173 736f 6369 6174 6564 2077  not associated w
+000121f0: 6974 6820 7468 6174 2022 0a20 2020 2020  ith that ".     
+00012200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012220: 226f 6273 6572 7661 7469 6f6e 222e 666f  "observation".fo
+00012230: 726d 6174 286f 6273 5f69 642c 2073 656c  rmat(obs_id, sel
+00012240: 662e 6e61 6d65 2c20 696e 7374 2929 0a0a  f.name, inst))..
+00012250: 2020 2020 2020 2020 6d61 7463 6865 7320          matches 
+00012260: 3d20 5b5d 0a20 2020 2020 2020 2023 2049  = [].        # I
+00012270: 7465 7261 7465 7320 7468 726f 7567 6820  terates through 
+00012280: 7468 6520 6469 6374 2073 6561 7263 6820  the dict search 
+00012290: 7265 7475 726e 2c20 6275 7420 6561 6368  return, but each
+000122a0: 206d 6174 6368 2069 7320 6c69 6b65 6c79   match is likely
+000122b0: 2074 6f20 6265 2061 2076 6572 7920 6e65   to be a very ne
+000122c0: 7374 6564 206c 6973 742c 0a20 2020 2020  sted list,.     
+000122d0: 2020 2023 2077 6974 6820 7468 6520 6465     # with the de
+000122e0: 6772 6565 206f 6620 6e65 7374 696e 6720  gree of nesting 
+000122f0: 6465 7065 6e64 616e 7420 6f6e 2070 726f  dependant on pro
+00012300: 6475 6374 2074 7970 6520 2861 7320 6576  duct type (as ev
+00012310: 656e 7420 6c69 7374 7320 6c69 7665 2061  ent lists live a
+00012320: 206c 6576 656c 2075 7020 6672 6f6d 0a20   level up from. 
+00012330: 2020 2020 2020 2023 2069 6d61 6765 7320         # images 
+00012340: 666f 7220 696e 7374 616e 6365 0a20 2020  for instance.   
+00012350: 2020 2020 2066 6f72 206d 6174 6368 2069       for match i
+00012360: 6e20 6469 6374 5f73 6561 7263 6828 705f  n dict_search(p_
+00012370: 7479 7065 2c20 7365 6c66 2e5f 7072 6f64  type, self._prod
+00012380: 7563 7473 293a 0a20 2020 2020 2020 2020  ucts):.         
+00012390: 2020 206f 7574 203d 205b 5d0a 2020 2020     out = [].    
+000123a0: 2020 2020 2020 2020 756e 7061 636b 5f6c          unpack_l
+000123b0: 6973 7428 6d61 7463 6829 0a20 2020 2020  ist(match).     
+000123c0: 2020 2020 2020 2023 204f 6e6c 7920 6170         # Only ap
+000123d0: 7065 6e64 7320 6966 2074 6869 7320 7061  pends if this pa
+000123e0: 7274 6963 756c 6172 206d 6174 6368 2069  rticular match i
+000123f0: 7320 666f 7220 7468 6520 6f62 735f 6964  s for the obs_id
+00012400: 2061 6e64 2069 6e73 7472 756d 656e 7420   and instrument 
+00012410: 7061 7373 6564 2074 6f20 7468 6973 206d  passed to this m
+00012420: 6574 686f 640a 2020 2020 2020 2020 2020  ethod.          
+00012430: 2020 2320 5468 6f75 6768 2061 6c6c 206d    # Though all m
+00012440: 6174 6368 6573 2077 696c 6c20 6265 2072  atches will be r
+00012450: 6574 7572 6e65 6420 6966 206e 6f20 6f62  eturned if no ob
+00012460: 735f 6964 2f69 6e73 7420 6973 2070 6173  s_id/inst is pas
+00012470: 7365 640a 2020 2020 2020 2020 2020 2020  sed.            
+00012480: 6966 2028 6f62 735f 6964 203d 3d20 6f75  if (obs_id == ou
+00012490: 745b 305d 206f 7220 6f62 735f 6964 2069  t[0] or obs_id i
+000124a0: 7320 4e6f 6e65 2920 616e 6420 2869 6e73  s None) and (ins
+000124b0: 7420 3d3d 206f 7574 5b31 5d20 6f72 2069  t == out[1] or i
+000124c0: 6e73 7420 6973 204e 6f6e 6529 205c 0a20  nst is None) \. 
+000124d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000124e0: 2020 2061 6e64 2028 6578 7472 615f 6b65     and (extra_ke
+000124f0: 7920 696e 206f 7574 206f 7220 6578 7472  y in out or extr
+00012500: 615f 6b65 7920 6973 204e 6f6e 6529 2061  a_key is None) a
+00012510: 6e64 206e 6f74 206a 7573 745f 6f62 6a3a  nd not just_obj:
+00012520: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012530: 206d 6174 6368 6573 2e61 7070 656e 6428   matches.append(
+00012540: 6f75 7429 0a20 2020 2020 2020 2020 2020  out).           
+00012550: 2065 6c69 6620 286f 6273 5f69 6420 3d3d   elif (obs_id ==
+00012560: 206f 7574 5b30 5d20 6f72 206f 6273 5f69   out[0] or obs_i
+00012570: 6420 6973 204e 6f6e 6529 2061 6e64 2028  d is None) and (
+00012580: 696e 7374 203d 3d20 6f75 745b 315d 206f  inst == out[1] o
+00012590: 7220 696e 7374 2069 7320 4e6f 6e65 2920  r inst is None) 
+000125a0: 5c0a 2020 2020 2020 2020 2020 2020 2020  \.              
+000125b0: 2020 2020 2020 616e 6420 2865 7874 7261        and (extra
+000125c0: 5f6b 6579 2069 6e20 6f75 7420 6f72 2065  _key in out or e
+000125d0: 7874 7261 5f6b 6579 2069 7320 4e6f 6e65  xtra_key is None
+000125e0: 2920 616e 6420 6a75 7374 5f6f 626a 3a0a  ) and just_obj:.
+000125f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012600: 6d61 7463 6865 732e 6170 7065 6e64 286f  matches.append(o
+00012610: 7574 5b2d 315d 290a 2020 2020 2020 2020  ut[-1]).        
+00012620: 7265 7475 726e 206d 6174 6368 6573 0a0a  return matches..
+00012630: 2020 2020 6465 6620 5f6c 6f61 645f 7265      def _load_re
+00012640: 6769 6f6e 7328 7365 6c66 2c20 7265 675f  gions(self, reg_
+00012650: 7061 7468 7329 202d 3e20 5475 706c 655b  paths) -> Tuple[
+00012660: 6469 6374 2c20 6469 6374 5d3a 0a20 2020  dict, dict]:.   
+00012670: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00012680: 2041 6e20 696e 7465 726e 616c 206d 6574   An internal met
+00012690: 686f 6420 7468 6174 2072 6561 6473 2061  hod that reads a
+000126a0: 6e64 2070 6172 7365 7320 7265 6769 6f6e  nd parses region
+000126b0: 2066 696c 6573 2066 6f75 6e64 2066 6f72   files found for
+000126c0: 206f 6273 6572 7661 7469 6f6e 730a 2020   observations.  
+000126d0: 2020 2020 2020 6173 736f 6369 6174 6564        associated
+000126e0: 2077 6974 6820 7468 6973 2073 6f75 7263   with this sourc
+000126f0: 652e 2041 6c73 6f20 636f 6d70 7574 6573  e. Also computes
+00012700: 2073 696d 706c 6520 6d61 7463 6865 7320   simple matches 
+00012710: 746f 2066 696e 6420 7265 6769 6f6e 7320  to find regions 
+00012720: 6c69 6b65 6c79 0a20 2020 2020 2020 2074  likely.        t
+00012730: 6f20 6265 2072 656c 6174 6564 2074 6f20  o be related to 
+00012740: 7468 6520 736f 7572 6365 2e0a 0a20 2020  the source...   
+00012750: 2020 2020 203a 7265 7475 726e 3a20 5477       :return: Tw
+00012760: 6f20 6469 6374 696f 6e61 7269 6573 2c20  o dictionaries, 
+00012770: 7468 6520 6669 7273 7420 636f 6e74 6169  the first contai
+00012780: 6e73 2074 6865 2072 6567 696f 6e73 2066  ns the regions f
+00012790: 6f72 2065 6163 6820 6f66 2074 6865 204f  or each of the O
+000127a0: 6273 4944 7320 616e 6420 7468 6520 7365  bsIDs and the se
+000127b0: 636f 6e64 2063 6f6e 7461 696e 730a 2020  cond contains.  
+000127c0: 2020 2020 2020 2020 2020 7468 6520 7265            the re
+000127d0: 6769 6f6e 7320 7468 6174 2068 6176 6520  gions that have 
+000127e0: 6265 656e 2076 6572 7920 7369 6d70 6c79  been very simply
+000127f0: 206d 6174 6368 6564 2074 6f20 7468 6520   matched to the 
+00012800: 736f 7572 6365 2e20 5468 6573 6520 7368  source. These sh
+00012810: 6f75 6c64 2062 6520 6f72 6465 7265 6420  ould be ordered 
+00012820: 6672 6f6d 2063 6c6f 7365 7374 2074 6f0a  from closest to.
+00012830: 2020 2020 2020 2020 2020 2020 6675 7274              furt
+00012840: 6865 7374 2066 726f 6d20 7468 6520 7061  hest from the pa
+00012850: 7373 6564 2073 6f75 7263 6520 636f 6f72  ssed source coor
+00012860: 6469 6e61 7465 732e 0a20 2020 2020 2020  dinates..       
+00012870: 203a 7274 7970 653a 2054 7570 6c65 5b64   :rtype: Tuple[d
+00012880: 6963 742c 2064 6963 745d 0a20 2020 2020  ict, dict].     
+00012890: 2020 2022 2222 0a0a 2020 2020 2020 2020     """..        
+000128a0: 6465 6620 6469 7374 5f66 726f 6d5f 736f  def dist_from_so
+000128b0: 7572 6365 2872 6567 293a 0a20 2020 2020  urce(reg):.     
+000128c0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+000128d0: 2020 2020 2020 2043 616c 6375 6c61 7465         Calculate
+000128e0: 7320 7468 6520 6575 636c 6964 6561 6e20  s the euclidean 
+000128f0: 6469 7374 616e 6365 2062 6574 7765 656e  distance between
+00012900: 2074 6865 2063 656e 7472 6520 6f66 2061   the centre of a
+00012910: 2073 7570 706c 6965 6420 7265 6769 6f6e   supplied region
+00012920: 2c20 616e 6420 7468 650a 2020 2020 2020  , and the.      
+00012930: 2020 2020 2020 706f 7369 7469 6f6e 206f        position o
+00012940: 6620 7468 6520 736f 7572 6365 2e0a 0a20  f the source... 
+00012950: 2020 2020 2020 2020 2020 203a 7061 7261             :para
+00012960: 6d20 7265 673a 2041 2072 6567 696f 6e20  m reg: A region 
+00012970: 6f62 6a65 6374 2e0a 2020 2020 2020 2020  object..        
+00012980: 2020 2020 3a72 6574 7572 6e3a 2044 6973      :return: Dis
+00012990: 7461 6e63 6520 6265 7477 6565 6e20 7265  tance between re
+000129a0: 6769 6f6e 2063 656e 7472 6520 616e 6420  gion centre and 
+000129b0: 736f 7572 6365 2070 6f73 6974 696f 6e2e  source position.
+000129c0: 0a20 2020 2020 2020 2020 2020 2022 2222  .            """
+000129d0: 0a20 2020 2020 2020 2020 2020 2072 6120  .            ra 
+000129e0: 3d20 7265 672e 6365 6e74 6572 2e72 612e  = reg.center.ra.
+000129f0: 7661 6c75 650a 2020 2020 2020 2020 2020  value.          
+00012a00: 2020 6465 6320 3d20 7265 672e 6365 6e74    dec = reg.cent
+00012a10: 6572 2e64 6563 2e76 616c 7565 0a20 2020  er.dec.value.   
+00012a20: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00012a30: 6e70 2e73 7172 7428 6162 7328 7261 202d  np.sqrt(abs(ra -
+00012a40: 2073 656c 662e 5f72 615f 6465 635b 305d   self._ra_dec[0]
+00012a50: 2920 2a2a 2032 202b 2061 6273 2864 6563  ) ** 2 + abs(dec
+00012a60: 202d 2073 656c 662e 5f72 615f 6465 635b   - self._ra_dec[
+00012a70: 315d 2920 2a2a 2032 290a 0a20 2020 2020  1]) ** 2)..     
+00012a80: 2020 2023 2052 6561 6420 696e 2074 6865     # Read in the
+00012a90: 2063 7573 746f 6d20 7265 6769 6f6e 2066   custom region f
+00012aa0: 696c 6520 7468 6174 2065 7665 7279 2058  ile that every X
+00012ab0: 4741 2068 6173 2061 7373 6f63 6961 7465  GA has associate
+00012ac0: 6420 7769 7468 2069 742e 2053 6f75 7263  d with it. Sourc
+00012ad0: 6573 2077 6974 6869 6e20 7769 6c6c 2062  es within will b
+00012ae0: 6520 6164 6465 6420 746f 2074 6865 0a20  e added to the. 
+00012af0: 2020 2020 2020 2023 2020 736f 7572 6365         #  source
+00012b00: 206c 6973 7420 666f 7220 6576 6572 7920   list for every 
+00012b10: 4f62 7349 443f 0a20 2020 2020 2020 2063  ObsID?.        c
+00012b20: 7573 746f 6d5f 7265 6773 203d 2072 6561  ustom_regs = rea
+00012b30: 645f 6473 3928 4f55 5450 5554 202b 2022  d_ds9(OUTPUT + "
+00012b40: 7265 6769 6f6e 732f 7b30 7d2f 7b30 7d5f  regions/{0}/{0}_
+00012b50: 6375 7374 6f6d 2e72 6567 222e 666f 726d  custom.reg".form
+00012b60: 6174 2873 656c 662e 6e61 6d65 2929 0a20  at(self.name)). 
+00012b70: 2020 2020 2020 2066 6f72 2072 6567 2069         for reg i
+00012b80: 6e20 6375 7374 6f6d 5f72 6567 733a 0a20  n custom_regs:. 
+00012b90: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+00012ba0: 7420 6973 696e 7374 616e 6365 2872 6567  t isinstance(reg
+00012bb0: 2c20 536b 7952 6567 696f 6e29 3a0a 2020  , SkyRegion):.  
+00012bc0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+00012bd0: 6973 6520 5479 7065 4572 726f 7228 2243  ise TypeError("C
+00012be0: 7573 746f 6d20 736f 7572 6365 7320 6361  ustom sources ca
+00012bf0: 6e20 6f6e 6c79 2062 6520 6465 6669 6e65  n only be define
+00012c00: 6420 696e 2052 412d 4465 6320 636f 6f72  d in RA-Dec coor
+00012c10: 6469 6e61 7465 732e 2229 0a0a 2020 2020  dinates.")..    
+00012c20: 2020 2020 7265 675f 6469 6374 203d 207b      reg_dict = {
+00012c30: 7d0a 2020 2020 2020 2020 6d61 7463 685f  }.        match_
+00012c40: 6469 6374 203d 207b 7d0a 2020 2020 2020  dict = {}.      
+00012c50: 2020 2320 4173 2077 6520 6f6e 6c79 2061    # As we only a
+00012c60: 6c6c 6f77 206f 6e65 2073 6574 206f 6620  llow one set of 
+00012c70: 7265 6769 6f6e 7320 7065 7220 6f62 7365  regions per obse
+00012c80: 7276 6174 696f 6e2c 2077 6520 7368 616c  rvation, we shal
+00012c90: 6c20 6173 7375 6d65 2074 6861 7420 7765  l assume that we
+00012ca0: 2063 616e 2075 7365 2074 6865 0a20 2020   can use the.   
+00012cb0: 2020 2020 2023 2057 4353 2074 7261 6e73       # WCS trans
+00012cc0: 666f 726d 2066 726f 6d20 414e 5920 6f66  form from ANY of
+00012cd0: 2074 6865 2069 6d61 6765 7320 746f 2063   the images to c
+00012ce0: 6f6e 7665 7274 2070 6978 656c 7320 746f  onvert pixels to
+00012cf0: 2064 6567 7265 6573 0a0a 2020 2020 2020   degrees..      
+00012d00: 2020 666f 7220 6f62 735f 6964 2069 6e20    for obs_id in 
+00012d10: 7265 675f 7061 7468 733a 0a20 2020 2020  reg_paths:.     
+00012d20: 2020 2020 2020 2069 6620 7265 675f 7061         if reg_pa
+00012d30: 7468 735b 6f62 735f 6964 5d20 6973 206e  ths[obs_id] is n
+00012d40: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00012d50: 2020 2020 2020 2020 2064 7339 5f72 6567           ds9_reg
+00012d60: 7320 3d20 7265 6164 5f64 7339 2872 6567  s = read_ds9(reg
+00012d70: 5f70 6174 6873 5b6f 6273 5f69 645d 290a  _paths[obs_id]).
+00012d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012d90: 2320 4772 6162 2061 6c6c 2069 6d61 6765  # Grab all image
+00012da0: 7320 666f 7220 7468 6520 4f62 7349 442c  s for the ObsID,
+00012db0: 2069 6e73 7472 756d 656e 7473 2061 6372   instruments acr
+00012dc0: 6f73 7320 616e 204f 6273 4944 2068 6176  oss an ObsID hav
+00012dd0: 6520 7468 6520 7361 6d65 2057 4353 2028  e the same WCS (
+00012de0: 6f74 6865 7220 7468 616e 2069 6e20 6361  other than in ca
+00012df0: 7365 730a 2020 2020 2020 2020 2020 2020  ses.            
+00012e00: 2020 2020 2320 2077 6865 7265 2074 6865      #  where the
+00012e10: 7920 7765 7265 2067 656e 6572 6174 6564  y were generated
+00012e20: 2077 6974 6820 6469 6666 6572 656e 7420   with different 
+00012e30: 7265 736f 6c75 7469 6f6e 7329 2e0a 2020  resolutions)..  
+00012e40: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00012e50: 2054 4f44 4f20 7365 6520 6973 7375 6520   TODO see issue 
+00012e60: 2339 3038 2c20 6669 6775 7265 206f 7574  #908, figure out
+00012e70: 2068 6f77 2074 6f20 7375 7070 6f72 7420   how to support 
+00012e80: 6469 6666 6572 656e 7420 7265 736f 6c75  different resolu
+00012e90: 7469 6f6e 7320 6f66 2069 6d61 6765 0a20  tions of image. 
+00012ea0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00012eb0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00012ec0: 2020 2020 2020 2020 696d 7320 3d20 7365          ims = se
+00012ed0: 6c66 2e67 6574 5f69 6d61 6765 7328 6f62  lf.get_images(ob
+00012ee0: 735f 6964 290a 2020 2020 2020 2020 2020  s_id).          
+00012ef0: 2020 2020 2020 6578 6365 7074 204e 6f50        except NoP
+00012f00: 726f 6475 6374 4176 6169 6c61 626c 6545  roductAvailableE
+00012f10: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
+00012f20: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00012f30: 4e6f 5072 6f64 7563 7441 7661 696c 6162  NoProductAvailab
+00012f40: 6c65 4572 726f 7228 2254 6865 7265 2069  leError("There i
+00012f50: 7320 6e6f 2069 6d61 6765 2061 7661 696c  s no image avail
+00012f60: 6162 6c65 2066 6f72 206f 6273 6572 7661  able for observa
+00012f70: 7469 6f6e 207b 6f7d 2c20 6173 736f 6369  tion {o}, associ
+00012f80: 6174 6564 2022 0a20 2020 2020 2020 2020  ated ".         
+00012f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012fb0: 2020 2020 2020 2020 2022 7769 7468 207b           "with {
+00012fc0: 6e7d 2e20 416e 2069 6d61 6765 2069 7320  n}. An image is 
+00012fd0: 6375 7272 656e 746c 7920 7265 7175 6972  currently requir
+00012fe0: 6564 2074 6f20 6368 6563 6b20 666f 7220  ed to check for 
+00012ff0: 736b 7920 220a 2020 2020 2020 2020 2020  sky ".          
+00013000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013020: 2020 2020 2020 2020 2263 6f6f 7264 696e          "coordin
+00013030: 6174 6573 2062 6569 6e67 2070 7265 7365  ates being prese
+00013040: 6e74 2077 6974 6869 6e20 6120 736b 7920  nt within a sky 
+00013050: 7265 6769 6f6e 202d 2074 686f 7567 6820  region - though 
+00013060: 686f 7065 6675 6c6c 7920 220a 2020 2020  hopefully ".    
+00013070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013090: 2020 2020 2020 2020 2020 2020 2020 226e                "n
+000130a0: 6f2d 6f6e 6520 7769 6c6c 2065 7665 7220  o-one will ever 
+000130b0: 7365 6520 7468 6973 2062 6563 6175 7365  see this because
+000130c0: 2049 276c 6c20 6861 7665 2066 6978 6564   I'll have fixed
+000130d0: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+000130e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000130f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013100: 2020 2020 2022 6974 2122 2e66 6f72 6d61       "it!".forma
+00013110: 7428 6f3d 6f62 735f 6964 2c20 6e3d 7365  t(o=obs_id, n=se
+00013120: 6c66 2e6e 616d 6529 290a 2020 2020 2020  lf.name)).      
+00013130: 2020 2020 2020 2020 2020 2020 2020 7720                w 
+00013140: 3d20 4e6f 6e65 0a20 2020 2020 2020 2020  = None.         
+00013150: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00013160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013170: 2077 203d 2069 6d73 5b30 5d2e 7261 6465   w = ims[0].rade
+00013180: 635f 7763 730a 2020 2020 2020 2020 2020  c_wcs.          
+00013190: 2020 2020 2020 2320 4170 7061 7265 6e74        # Apparent
+000131a0: 6c79 2063 616e 2068 6170 7065 6e20 7468  ly can happen th
+000131b0: 6174 2074 6865 7265 2061 7265 206e 6f20  at there are no 
+000131c0: 7265 6769 6f6e 7320 696e 2061 2072 6567  regions in a reg
+000131d0: 696f 6e20 6669 6c65 2c20 736f 2069 6620  ion file, so if 
+000131e0: 7468 6174 2069 7320 7468 6520 6361 7365  that is the case
+000131f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013200: 2023 2020 7468 656e 2049 206a 7573 7420   #  then I just 
+00013210: 7365 7420 7468 6520 6473 395f 7265 6773  set the ds9_regs
+00013220: 2074 6f20 5b4e 6f6e 655d 2062 6563 6175   to [None] becau
+00013230: 7365 2049 206b 6e6f 7720 7468 6520 7265  se I know the re
+00013240: 7374 206f 6620 7468 6520 636f 6465 2063  st of the code c
+00013250: 616e 2064 6561 6c20 7769 7468 2074 6861  an deal with tha
+00013260: 742e 0a20 2020 2020 2020 2020 2020 2020  t..             
+00013270: 2020 2023 2020 4974 2063 616e 2774 2064     #  It can't d
+00013280: 6561 6c20 7769 7468 2061 6e20 656d 7074  eal with an empt
+00013290: 7920 6c69 7374 0a20 2020 2020 2020 2020  y list.         
+000132a0: 2020 2020 2020 2069 6620 6c65 6e28 6473         if len(ds
+000132b0: 395f 7265 6773 2920 3d3d 2030 3a0a 2020  9_regs) == 0:.  
+000132c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000132d0: 2020 6473 395f 7265 6773 203d 205b 4e6f    ds9_regs = [No
+000132e0: 6e65 5d0a 2020 2020 2020 2020 2020 2020  ne].            
+000132f0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00013300: 2020 2020 2020 6473 395f 7265 6773 203d        ds9_regs =
+00013310: 205b 4e6f 6e65 5d0a 0a20 2020 2020 2020   [None]..       
+00013320: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+00013330: 6365 2864 7339 5f72 6567 735b 305d 2c20  ce(ds9_regs[0], 
+00013340: 5069 7865 6c52 6567 696f 6e29 3a0a 2020  PixelRegion):.  
+00013350: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00013360: 4966 2072 6567 696f 6e73 2065 7869 7374  If regions exist
+00013370: 2069 6e20 7069 7865 6c20 636f 6f72 6469   in pixel coordi
+00013380: 6e61 7465 732c 2077 6520 6e65 6564 2061  nates, we need a
+00013390: 6e20 696d 6167 6520 5743 5320 746f 2063  n image WCS to c
+000133a0: 6f6e 7665 7274 2074 6865 6d20 746f 2052  onvert them to R
+000133b0: 412d 4445 432c 2073 6f20 7765 206e 6565  A-DEC, so we nee
+000133c0: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+000133d0: 2020 2320 206f 6e65 206f 6620 7468 6520    #  one of the 
+000133e0: 696d 6167 6573 2073 7570 706c 6965 6420  images supplied 
+000133f0: 696e 2074 6865 2063 6f6e 6669 6720 6669  in the config fi
+00013400: 6c65 2c20 6e6f 7420 616e 7974 6869 6e67  le, not anything
+00013410: 2074 6861 7420 5847 4120 6765 6e65 7261   that XGA genera
+00013420: 7465 732e 0a20 2020 2020 2020 2020 2020  tes..           
+00013430: 2020 2020 2023 2020 4275 7420 6173 2074       #  But as t
+00013440: 6869 7320 6d65 7468 6f64 2069 7320 6f6e  his method is on
+00013450: 6c79 2072 756e 206f 6e63 652c 2062 6566  ly run once, bef
+00013460: 6f72 6520 5847 4120 6765 6e65 7261 7465  ore XGA generate
+00013470: 6420 7072 6f64 7563 7473 2061 7265 206c  d products are l
+00013480: 6f61 6465 6420 696e 2c20 6974 0a20 2020  oaded in, it.   
+00013490: 2020 2020 2020 2020 2020 2020 2023 2020               #  
+000134a0: 7368 6f75 6c64 2062 6520 6669 6e65 0a20  should be fine. 
+000134b0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000134c0: 6620 7720 6973 204e 6f6e 653a 0a20 2020  f w is None:.   
+000134d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000134e0: 2072 6169 7365 204e 6f50 726f 6475 6374   raise NoProduct
+000134f0: 4176 6169 6c61 626c 6545 7272 6f72 2822  AvailableError("
+00013500: 5468 6572 6520 6973 206e 6f20 696d 6167  There is no imag
+00013510: 6520 6176 6169 6c61 626c 6520 666f 7220  e available for 
+00013520: 6f62 7365 7276 6174 696f 6e20 7b6f 7d2c  observation {o},
+00013530: 2061 7373 6f63 6961 7465 6420 220a 2020   associated ".  
+00013540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013570: 2277 6974 6820 7b6e 7d2e 2041 6e20 696d  "with {n}. An im
+00013580: 6167 6520 6973 2063 7572 7265 6e74 6c79  age is currently
+00013590: 2072 6571 7569 7265 6420 746f 2074 7261   required to tra
+000135a0: 6e73 6c61 7465 2070 6978 656c 2072 6567  nslate pixel reg
+000135b0: 696f 6e73 2022 0a20 2020 2020 2020 2020  ions ".         
+000135c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000135d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000135e0: 2020 2020 2020 2020 2022 746f 2052 412d           "to RA-
+000135f0: 4445 432e 222e 666f 726d 6174 286f 3d6f  DEC.".format(o=o
+00013600: 6273 5f69 642c 206e 3d73 656c 662e 6e61  bs_id, n=self.na
+00013610: 6d65 2929 0a0a 2020 2020 2020 2020 2020  me))..          
+00013620: 2020 2020 2020 736b 795f 7265 6773 203d        sky_regs =
+00013630: 205b 7265 672e 746f 5f73 6b79 2877 2920   [reg.to_sky(w) 
+00013640: 666f 7220 7265 6720 696e 2064 7339 5f72  for reg in ds9_r
+00013650: 6567 735d 0a20 2020 2020 2020 2020 2020  egs].           
+00013660: 2020 2020 2072 6567 5f64 6963 745b 6f62       reg_dict[ob
+00013670: 735f 6964 5d20 3d20 6e70 2e61 7272 6179  s_id] = np.array
+00013680: 2873 6b79 5f72 6567 7329 0a20 2020 2020  (sky_regs).     
+00013690: 2020 2020 2020 2065 6c69 6620 6973 696e         elif isin
+000136a0: 7374 616e 6365 2864 7339 5f72 6567 735b  stance(ds9_regs[
+000136b0: 305d 2c20 536b 7952 6567 696f 6e29 3a0a  0], SkyRegion):.
+000136c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000136d0: 7265 675f 6469 6374 5b6f 6273 5f69 645d  reg_dict[obs_id]
+000136e0: 203d 206e 702e 6172 7261 7928 6473 395f   = np.array(ds9_
+000136f0: 7265 6773 290a 2020 2020 2020 2020 2020  regs).          
+00013700: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00013710: 2020 2020 2020 2020 2320 536f 2074 6865          # So the
+00013720: 7265 2069 7320 616e 2065 6e74 7279 2069  re is an entry i
+00013730: 6e20 7468 6973 2066 6f72 2045 5645 5259  n this for EVERY
+00013740: 204f 6273 4944 0a20 2020 2020 2020 2020   ObsID.         
+00013750: 2020 2020 2020 2072 6567 5f64 6963 745b         reg_dict[
+00013760: 6f62 735f 6964 5d20 3d20 6e70 2e61 7272  obs_id] = np.arr
+00013770: 6179 285b 4e6f 6e65 5d29 0a0a 2020 2020  ay([None])..    
+00013780: 2020 2020 2020 2020 2320 4865 7265 2077          # Here w
+00013790: 6520 6164 6420 7468 6520 6375 7374 6f6d  e add the custom
+000137a0: 2073 6f75 7263 6573 2074 6f20 7468 6520   sources to the 
+000137b0: 736f 7572 6365 206c 6973 742c 2077 6520  source list, we 
+000137c0: 6b6e 6f77 2074 6865 7920 6172 6520 736b  know they are sk
+000137d0: 7920 7265 6769 6f6e 7320 6173 2077 6520  y regions as we 
+000137e0: 6861 7665 0a20 2020 2020 2020 2020 2020  have.           
+000137f0: 2023 2020 616c 7265 6164 7920 656e 666f   #  already enfo
+00013800: 7263 6564 2069 742e 2049 6620 7468 6572  rced it. If ther
+00013810: 6520 7761 7320 6e6f 2072 6567 696f 6e20  e was no region 
+00013820: 6c69 7374 2066 6f72 2061 2070 6172 7469  list for a parti
+00013830: 6375 6c61 7220 4f62 7349 4420 2864 6574  cular ObsID (det
+00013840: 6563 7465 6420 6279 2074 6865 2066 6972  ected by the fir
+00013850: 7374 0a20 2020 2020 2020 2020 2020 2023  st.            #
+00013860: 2020 656e 7472 7920 696e 2074 6865 2072    entry in the r
+00013870: 6567 2064 6963 7420 6265 696e 6720 4e6f  eg dict being No
+00013880: 6e65 2920 616e 6420 7468 6572 6520 4953  ne) and there IS
+00013890: 2061 2063 7573 746f 6d20 7265 6769 6f6e   a custom region
+000138a0: 2c20 7765 206a 7573 7420 7265 706c 6163  , we just replac
+000138b0: 6520 7468 6520 4e6f 6e65 2077 6974 6820  e the None with 
+000138c0: 7468 650a 2020 2020 2020 2020 2020 2020  the.            
+000138d0: 2320 2063 7573 746f 6d20 7265 6769 6f6e  #  custom region
+000138e0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+000138f0: 7265 675f 6469 6374 5b6f 6273 5f69 645d  reg_dict[obs_id]
+00013900: 5b30 5d20 6973 206e 6f74 204e 6f6e 653a  [0] is not None:
+00013910: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013920: 2072 6567 5f64 6963 745b 6f62 735f 6964   reg_dict[obs_id
+00013930: 5d20 3d20 6e70 2e61 7070 656e 6428 7265  ] = np.append(re
+00013940: 675f 6469 6374 5b6f 6273 5f69 645d 2c20  g_dict[obs_id], 
+00013950: 6375 7374 6f6d 5f72 6567 7329 0a20 2020  custom_regs).   
+00013960: 2020 2020 2020 2020 2065 6c69 6620 7265           elif re
+00013970: 675f 6469 6374 5b6f 6273 5f69 645d 5b30  g_dict[obs_id][0
+00013980: 5d20 6973 204e 6f6e 6520 616e 6420 6c65  ] is None and le
+00013990: 6e28 6375 7374 6f6d 5f72 6567 7329 2021  n(custom_regs) !
+000139a0: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
+000139b0: 2020 2020 2072 6567 5f64 6963 745b 6f62       reg_dict[ob
+000139c0: 735f 6964 5d20 3d20 6375 7374 6f6d 5f72  s_id] = custom_r
+000139d0: 6567 730a 2020 2020 2020 2020 2020 2020  egs.            
+000139e0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+000139f0: 2020 2020 2020 7265 675f 6469 6374 5b6f        reg_dict[o
+00013a00: 6273 5f69 645d 203d 206e 702e 6172 7261  bs_id] = np.arra
+00013a10: 7928 5b4e 6f6e 655d 290a 0a20 2020 2020  y([None])..     
+00013a20: 2020 2020 2020 2023 2049 276d 2067 6f69         # I'm goi
+00013a30: 6e67 2074 6f20 656e 7375 7265 2074 6861  ng to ensure tha
+00013a40: 7420 616c 6c20 7265 6769 6f6e 7320 6172  t all regions ar
+00013a50: 6520 656c 6c69 7074 6963 616c 2c20 4920  e elliptical, I 
+00013a60: 646f 6e27 7420 7761 6e74 2074 6f20 6875  don't want to hu
+00013a70: 6e74 2074 6872 6f75 6768 2065 7665 7279  nt through every
+00013a80: 2070 6c61 6365 2069 6e20 5847 410a 2020   place in XGA.  
+00013a90: 2020 2020 2020 2020 2020 2320 2077 6865            #  whe
+00013aa0: 7265 2049 206d 6164 6520 7468 6174 2061  re I made that a
+00013ab0: 7373 756d 7074 696f 6e0a 2020 2020 2020  ssumption.      
+00013ac0: 2020 2020 2020 666f 7220 7265 675f 696e        for reg_in
+00013ad0: 642c 2072 6567 2069 6e20 656e 756d 6572  d, reg in enumer
+00013ae0: 6174 6528 7265 675f 6469 6374 5b6f 6273  ate(reg_dict[obs
+00013af0: 5f69 645d 293a 0a20 2020 2020 2020 2020  _id]):.         
+00013b00: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+00013b10: 616e 6365 2872 6567 2c20 4369 7263 6c65  ance(reg, Circle
+00013b20: 536b 7952 6567 696f 6e29 3a0a 2020 2020  SkyRegion):.    
+00013b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013b40: 2320 4d75 6c74 6970 6c79 2072 6164 6969  # Multiply radii
+00013b50: 2062 7920 7477 6f20 6265 6361 7573 6520   by two because 
+00013b60: 7468 6520 656c 6c69 7073 6520 6261 7365  the ellipse base
+00013b70: 6420 736f 7572 6365 7320 7761 6e74 2048  d sources want H
+00013b80: 4549 4748 5420 616e 6420 5749 4454 482c  EIGHT and WIDTH,
+00013b90: 206e 6f74 2052 4144 4955 530a 2020 2020   not RADIUS.    
+00013ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013bb0: 2320 4769 7665 2073 6d61 6c6c 2061 6e67  # Give small ang
+00013bc0: 6c65 2028 7468 6f75 6768 2077 6f6e 2774  le (though won't
+00013bd0: 206d 616b 6520 6120 6469 6666 6572 656e   make a differen
+00013be0: 6365 2061 7320 6369 7263 756c 6172 2920  ce as circular) 
+00013bf0: 746f 2061 766f 6964 2070 726f 626c 656d  to avoid problem
+00013c00: 7320 7769 7468 2061 6e67 6c65 3d30 0a20  s with angle=0. 
+00013c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013c20: 2020 2023 2020 7468 6174 2049 2776 6520     #  that I've 
+00013c30: 6e6f 7469 6365 6420 7072 6576 696f 7573  noticed previous
+00013c40: 6c79 0a20 2020 2020 2020 2020 2020 2020  ly.             
+00013c50: 2020 2020 2020 206e 6577 5f72 6567 203d         new_reg =
+00013c60: 2045 6c6c 6970 7365 536b 7952 6567 696f   EllipseSkyRegio
+00013c70: 6e28 7265 672e 6365 6e74 6572 2c20 7265  n(reg.center, re
+00013c80: 672e 7261 6469 7573 2a32 2c20 7265 672e  g.radius*2, reg.
+00013c90: 7261 6469 7573 2a32 2c20 5175 616e 7469  radius*2, Quanti
+00013ca0: 7479 2833 2c20 2764 6567 2729 290a 2020  ty(3, 'deg')).  
+00013cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013cc0: 2020 6e65 775f 7265 672e 7669 7375 616c    new_reg.visual
+00013cd0: 5b27 636f 6c6f 7227 5d20 3d20 7265 672e  ['color'] = reg.
+00013ce0: 7669 7375 616c 5b27 636f 6c6f 7227 5d0a  visual['color'].
+00013cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013d00: 2020 2020 7265 675f 6469 6374 5b6f 6273      reg_dict[obs
+00013d10: 5f69 645d 5b72 6567 5f69 6e64 5d20 3d20  _id][reg_ind] = 
+00013d20: 6e65 775f 7265 670a 0a20 2020 2020 2020  new_reg..       
+00013d30: 2020 2020 2023 2048 6f70 6566 756c 6c79       # Hopefully
+00013d40: 2074 6869 7320 626f 6467 6520 646f 6573   this bodge does
+00013d50: 6e27 7420 6861 7665 2061 6e79 2075 6e66  n't have any unf
+00013d60: 6f72 6573 6565 6e20 636f 6e73 6571 7565  oreseen conseque
+00013d70: 6e63 6573 0a20 2020 2020 2020 2020 2020  nces.           
+00013d80: 2069 6620 7265 675f 6469 6374 5b6f 6273   if reg_dict[obs
+00013d90: 5f69 645d 5b30 5d20 6973 206e 6f74 204e  _id][0] is not N
+00013da0: 6f6e 6520 616e 6420 6c65 6e28 7265 675f  one and len(reg_
+00013db0: 6469 6374 5b6f 6273 5f69 645d 2920 3e20  dict[obs_id]) > 
+00013dc0: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
+00013dd0: 2020 2023 2051 7569 636b 6c79 2063 616c     # Quickly cal
+00013de0: 6375 6c61 7469 6e67 2064 6973 7461 6e63  culating distanc
+00013df0: 6520 6265 7477 6565 6e20 736f 7572 6365  e between source
+00013e00: 2061 6e64 2063 656e 7465 7220 6f66 2072   and center of r
+00013e10: 6567 696f 6e73 2c20 7468 656e 2073 6f72  egions, then sor
+00013e20: 7469 6e67 0a20 2020 2020 2020 2020 2020  ting.           
+00013e30: 2020 2020 2023 2061 6e64 2067 6574 7469       # and getti
+00013e40: 6e67 2069 6e64 6963 6573 2e20 5468 7573  ng indices. Thus
+00013e50: 2049 206f 6e6c 7920 6d61 7463 6820 746f   I only match to
+00013e60: 2074 6865 2063 6c6f 7365 7374 2035 2072   the closest 5 r
+00013e70: 6567 696f 6e73 2e0a 2020 2020 2020 2020  egions..        
+00013e80: 2020 2020 2020 2020 6469 6666 5f73 6f72          diff_sor
+00013e90: 7420 3d20 6e70 2e61 7272 6179 285b 6469  t = np.array([di
+00013ea0: 7374 5f66 726f 6d5f 736f 7572 6365 2872  st_from_source(r
+00013eb0: 2920 666f 7220 7220 696e 2072 6567 5f64  ) for r in reg_d
+00013ec0: 6963 745b 6f62 735f 6964 5d5d 292e 6172  ict[obs_id]]).ar
+00013ed0: 6773 6f72 7428 290a 2020 2020 2020 2020  gsort().        
+00013ee0: 2020 2020 2020 2020 2320 556e 666f 7274          # Unfort
+00013ef0: 756e 6174 656c 7920 6475 6520 746f 2061  unately due to a
+00013f00: 206c 696d 6974 6174 696f 6e20 6f66 2074   limitation of t
+00013f10: 6865 2072 6567 696f 6e73 206d 6f64 756c  he regions modul
+00013f20: 6520 4920 7468 696e 6b20 796f 7520 6e65  e I think you ne
+00013f30: 6564 2069 6d61 6765 730a 2020 2020 2020  ed images.      
+00013f40: 2020 2020 2020 2020 2020 2320 2074 6f20            #  to 
+00013f50: 646f 2074 6869 7320 636f 6e74 6169 6e73  do this contains
+00013f60: 206d 6174 6368 2e2e 2e0a 2020 2020 2020   match....      
+00013f70: 2020 2020 2020 2020 2020 7769 7468 696e            within
+00013f80: 203d 206e 702e 6172 7261 7928 5b72 6567   = np.array([reg
+00013f90: 2e63 6f6e 7461 696e 7328 536b 7943 6f6f  .contains(SkyCoo
+00013fa0: 7264 282a 7365 6c66 2e5f 7261 5f64 6563  rd(*self._ra_dec
+00013fb0: 2c20 756e 6974 3d27 6465 6727 292c 2077  , unit='deg'), w
+00013fc0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00013fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013fe0: 2020 2020 2066 6f72 2072 6567 2069 6e20       for reg in 
+00013ff0: 7265 675f 6469 6374 5b6f 6273 5f69 645d  reg_dict[obs_id]
+00014000: 5b64 6966 665f 736f 7274 5b30 3a35 5d5d  [diff_sort[0:5]]
+00014010: 5d29 0a0a 2020 2020 2020 2020 2020 2020  ])..            
+00014020: 2020 2020 2320 4d61 6b65 2073 7572 6520      # Make sure 
+00014030: 746f 2072 652d 6f72 6465 7220 7468 6520  to re-order the 
+00014040: 7265 6769 6f6e 206c 6973 7420 746f 206d  region list to m
+00014050: 6174 6368 2074 6865 2073 6f72 7465 6420  atch the sorted 
+00014060: 7769 7468 696e 2061 7272 6179 0a20 2020  within array.   
+00014070: 2020 2020 2020 2020 2020 2020 2072 6567               reg
+00014080: 5f64 6963 745b 6f62 735f 6964 5d20 3d20  _dict[obs_id] = 
+00014090: 7265 675f 6469 6374 5b6f 6273 5f69 645d  reg_dict[obs_id]
+000140a0: 5b64 6966 665f 736f 7274 5d0a 0a20 2020  [diff_sort]..   
+000140b0: 2020 2020 2020 2020 2020 2020 2023 2045               # E
+000140c0: 7870 616e 6473 2069 7420 736f 2069 7420  xpands it so it 
+000140d0: 6361 6e20 6265 2075 7365 6420 6173 2061  can be used as a
+000140e0: 206d 6173 6b20 6f6e 2074 6865 2077 686f   mask on the who
+000140f0: 6c65 2073 6574 206f 6620 7265 6769 6f6e  le set of region
+00014100: 7320 666f 7220 7468 6973 206f 6273 6572  s for this obser
+00014110: 7661 7469 6f6e 0a20 2020 2020 2020 2020  vation.         
+00014120: 2020 2020 2020 2077 6974 6869 6e20 3d20         within = 
+00014130: 6e70 2e70 6164 2877 6974 6869 6e2c 205b  np.pad(within, [
+00014140: 302c 206c 656e 2864 6966 665f 736f 7274  0, len(diff_sort
+00014150: 2920 2d20 6c65 6e28 7769 7468 696e 295d  ) - len(within)]
+00014160: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00014170: 2020 6d61 7463 685f 6469 6374 5b6f 6273    match_dict[obs
+00014180: 5f69 645d 203d 2077 6974 6869 6e0a 2020  _id] = within.  
+00014190: 2020 2020 2020 2020 2020 2320 496e 2074            # In t
+000141a0: 6865 2063 6173 6520 6f66 206f 6e6c 7920  he case of only 
+000141b0: 6f6e 6520 7265 6769 6f6e 2062 6569 6e67  one region being
+000141c0: 2069 6e20 7468 6520 6c69 7374 2c20 7765   in the list, we
+000141d0: 2073 696d 706c 6966 7920 7468 6520 6162   simplify the ab
+000141e0: 6f76 6520 6578 7072 6573 7369 6f6e 0a20  ove expression. 
+000141f0: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+00014200: 7265 675f 6469 6374 5b6f 6273 5f69 645d  reg_dict[obs_id]
+00014210: 5b30 5d20 6973 206e 6f74 204e 6f6e 6520  [0] is not None 
+00014220: 616e 6420 6c65 6e28 7265 675f 6469 6374  and len(reg_dict
+00014230: 5b6f 6273 5f69 645d 2920 3d3d 2031 3a0a  [obs_id]) == 1:.
+00014240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014250: 6966 2072 6567 5f64 6963 745b 6f62 735f  if reg_dict[obs_
+00014260: 6964 5d5b 305d 2e63 6f6e 7461 696e 7328  id][0].contains(
+00014270: 536b 7943 6f6f 7264 282a 7365 6c66 2e5f  SkyCoord(*self._
+00014280: 7261 5f64 6563 2c20 756e 6974 3d27 6465  ra_dec, unit='de
+00014290: 6727 292c 2077 293a 0a20 2020 2020 2020  g'), w):.       
+000142a0: 2020 2020 2020 2020 2020 2020 206d 6174               mat
+000142b0: 6368 5f64 6963 745b 6f62 735f 6964 5d20  ch_dict[obs_id] 
+000142c0: 3d20 6e70 2e61 7272 6179 285b 5472 7565  = np.array([True
+000142d0: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
+000142e0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000142f0: 2020 2020 2020 2020 2020 2020 206d 6174               mat
+00014300: 6368 5f64 6963 745b 6f62 735f 6964 5d20  ch_dict[obs_id] 
+00014310: 3d20 6e70 2e61 7272 6179 285b 4661 6c73  = np.array([Fals
+00014320: 655d 290a 2020 2020 2020 2020 2020 2020  e]).            
+00014330: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00014340: 2020 2020 2020 6d61 7463 685f 6469 6374        match_dict
+00014350: 5b6f 6273 5f69 645d 203d 206e 702e 6172  [obs_id] = np.ar
+00014360: 7261 7928 5b46 616c 7365 5d29 0a0a 2020  ray([False])..  
+00014370: 2020 2020 2020 7265 7475 726e 2072 6567        return reg
+00014380: 5f64 6963 742c 206d 6174 6368 5f64 6963  _dict, match_dic
+00014390: 740a 0a20 2020 2064 6566 2075 7064 6174  t..    def updat
+000143a0: 655f 7175 6575 6528 7365 6c66 2c20 636d  e_queue(self, cm
+000143b0: 645f 6172 723a 206e 702e 6e64 6172 7261  d_arr: np.ndarra
+000143c0: 792c 2070 5f74 7970 655f 6172 723a 206e  y, p_type_arr: n
+000143d0: 702e 6e64 6172 7261 792c 2070 5f70 6174  p.ndarray, p_pat
+000143e0: 685f 6172 723a 206e 702e 6e64 6172 7261  h_arr: np.ndarra
+000143f0: 792c 0a20 2020 2020 2020 2020 2020 2020  y,.             
+00014400: 2020 2020 2020 2020 6578 7472 615f 696e          extra_in
+00014410: 666f 3a20 6e70 2e6e 6461 7272 6179 2c20  fo: np.ndarray, 
+00014420: 7374 6163 6b3a 2062 6f6f 6c20 3d20 4661  stack: bool = Fa
+00014430: 6c73 6529 3a0a 2020 2020 2020 2020 2222  lse):.        ""
+00014440: 220a 2020 2020 2020 2020 536d 616c 6c20  ".        Small 
+00014450: 6675 6e63 7469 6f6e 2074 6f20 7570 6461  function to upda
+00014460: 7465 2074 6865 206e 756d 7079 2061 7272  te the numpy arr
+00014470: 6179 2074 6861 7420 6d61 6b65 7320 7570  ay that makes up
+00014480: 2074 6865 2071 7565 7565 206f 6620 7072   the queue of pr
+00014490: 6f64 7563 7473 2074 6f20 6265 2067 656e  oducts to be gen
+000144a0: 6572 6174 6564 2e0a 0a20 2020 2020 2020  erated...       
+000144b0: 203a 7061 7261 6d20 6e70 2e6e 6461 7272   :param np.ndarr
+000144c0: 6179 2063 6d64 5f61 7272 3a20 4172 7261  ay cmd_arr: Arra
+000144d0: 7920 636f 6e74 6169 6e69 6e67 2053 4153  y containing SAS
+000144e0: 2063 6f6d 6d61 6e64 732e 0a20 2020 2020   commands..     
+000144f0: 2020 203a 7061 7261 6d20 6e70 2e6e 6461     :param np.nda
+00014500: 7272 6179 2070 5f74 7970 655f 6172 723a  rray p_type_arr:
+00014510: 2041 7272 6179 206f 6620 7072 6f64 7563   Array of produc
+00014520: 7420 7479 7065 2069 6465 6e74 6966 6965  t type identifie
+00014530: 7273 2066 6f72 2074 6865 2070 726f 6475  rs for the produ
+00014540: 6374 7320 6765 6e65 7261 7465 640a 2020  cts generated.  
+00014550: 2020 2020 2020 2020 2020 6279 2074 6865            by the
+00014560: 2063 6d64 2061 7272 6179 2e20 652e 672e   cmd array. e.g.
+00014570: 2069 6d61 6765 206f 7220 6578 706d 6170   image or expmap
+00014580: 2e0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
+00014590: 206e 702e 6e64 6172 7261 7920 705f 7061   np.ndarray p_pa
+000145a0: 7468 5f61 7272 3a20 4172 7261 7920 6f66  th_arr: Array of
+000145b0: 2066 696e 616c 2070 726f 6475 6374 2070   final product p
+000145c0: 6174 6873 2069 6620 636d 6420 6973 2073  aths if cmd is s
+000145d0: 7563 6365 7373 6675 6c0a 2020 2020 2020  uccessful.      
+000145e0: 2020 3a70 6172 616d 206e 702e 6e64 6172    :param np.ndar
+000145f0: 7261 7920 6578 7472 615f 696e 666f 3a20  ray extra_info: 
+00014600: 4172 7261 7920 6f66 2065 7874 7261 2069  Array of extra i
+00014610: 6e66 6f72 6d61 7469 6f6e 2064 6963 7469  nformation dicti
+00014620: 6f6e 6172 6965 730a 2020 2020 2020 2020  onaries.        
+00014630: 3a70 6172 616d 2073 7461 636b 3a20 5368  :param stack: Sh
+00014640: 6f75 6c64 2074 6865 7365 2063 6f6d 6d61  ould these comma
+00014650: 6e64 7320 6265 2065 7865 6375 7465 6420  nds be executed 
+00014660: 6166 7465 7220 6120 7072 6563 6564 696e  after a precedin
+00014670: 6720 6c69 6e65 206f 6620 636f 6d6d 616e  g line of comman
+00014680: 6473 2c0a 2020 2020 2020 2020 2020 2020  ds,.            
+00014690: 6f72 2061 7420 7468 6520 7361 6d65 2074  or at the same t
+000146a0: 696d 652e 0a20 2020 2020 2020 203a 7265  ime..        :re
+000146b0: 7475 726e 3a0a 2020 2020 2020 2020 2222  turn:.        ""
+000146c0: 220a 2020 2020 2020 2020 6966 2073 656c  ".        if sel
+000146d0: 662e 7175 6575 6520 6973 204e 6f6e 653a  f.queue is None:
+000146e0: 0a20 2020 2020 2020 2020 2020 2023 2049  .            # I
+000146f0: 2063 6f75 6c64 2068 6176 6520 646f 6e65   could have done
+00014700: 2061 6c6c 206f 6620 7468 6573 6520 696e   all of these in
+00014710: 206f 6e65 2061 7272 6179 2077 6974 6820   one array with 
+00014720: 3320 6469 6d65 6e73 696f 6e73 2c20 6275  3 dimensions, bu
+00014730: 7420 6665 6c74 2074 6869 7320 7761 7320  t felt this was 
+00014740: 6561 7369 6572 2074 6f20 7265 6164 0a20  easier to read. 
+00014750: 2020 2020 2020 2020 2020 2023 2061 6e64             # and
+00014760: 2077 6974 6820 6e6f 2072 6561 6c20 7065   with no real pe
+00014770: 7266 6f72 6d61 6e63 6520 7065 6e61 6c74  rformance penalt
+00014780: 790a 2020 2020 2020 2020 2020 2020 7365  y.            se
+00014790: 6c66 2e71 7565 7565 203d 2063 6d64 5f61  lf.queue = cmd_a
+000147a0: 7272 0a20 2020 2020 2020 2020 2020 2073  rr.            s
+000147b0: 656c 662e 7175 6575 655f 7479 7065 203d  elf.queue_type =
+000147c0: 2070 5f74 7970 655f 6172 720a 2020 2020   p_type_arr.    
+000147d0: 2020 2020 2020 2020 7365 6c66 2e71 7565          self.que
+000147e0: 7565 5f70 6174 6820 3d20 705f 7061 7468  ue_path = p_path
+000147f0: 5f61 7272 0a20 2020 2020 2020 2020 2020  _arr.           
+00014800: 2073 656c 662e 7175 6575 655f 6578 7472   self.queue_extr
+00014810: 615f 696e 666f 203d 2065 7874 7261 5f69  a_info = extra_i
+00014820: 6e66 6f0a 2020 2020 2020 2020 656c 6966  nfo.        elif
+00014830: 2073 7461 636b 3a0a 2020 2020 2020 2020   stack:.        
+00014840: 2020 2020 7365 6c66 2e71 7565 7565 203d      self.queue =
+00014850: 206e 702e 7673 7461 636b 2828 7365 6c66   np.vstack((self
+00014860: 2e71 7565 7565 2c20 636d 645f 6172 7229  .queue, cmd_arr)
+00014870: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
+00014880: 6c66 2e71 7565 7565 5f74 7970 6520 3d20  lf.queue_type = 
+00014890: 6e70 2e76 7374 6163 6b28 2873 656c 662e  np.vstack((self.
+000148a0: 7175 6575 655f 7479 7065 2c20 705f 7479  queue_type, p_ty
+000148b0: 7065 5f61 7272 2929 0a20 2020 2020 2020  pe_arr)).       
+000148c0: 2020 2020 2073 656c 662e 7175 6575 655f       self.queue_
+000148d0: 7061 7468 203d 206e 702e 7673 7461 636b  path = np.vstack
+000148e0: 2828 7365 6c66 2e71 7565 7565 5f70 6174  ((self.queue_pat
+000148f0: 682c 2070 5f70 6174 685f 6172 7229 290a  h, p_path_arr)).
+00014900: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00014910: 2e71 7565 7565 5f65 7874 7261 5f69 6e66  .queue_extra_inf
+00014920: 6f20 3d20 6e70 2e76 7374 6163 6b28 2873  o = np.vstack((s
+00014930: 656c 662e 7175 6575 655f 6578 7472 615f  elf.queue_extra_
+00014940: 696e 666f 2c20 6578 7472 615f 696e 666f  info, extra_info
+00014950: 2929 0a20 2020 2020 2020 2065 6c73 653a  )).        else:
+00014960: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00014970: 662e 7175 6575 6520 3d20 6e70 2e61 7070  f.queue = np.app
+00014980: 656e 6428 7365 6c66 2e71 7565 7565 2c20  end(self.queue, 
+00014990: 636d 645f 6172 722c 2061 7869 733d 3029  cmd_arr, axis=0)
+000149a0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000149b0: 662e 7175 6575 655f 7479 7065 203d 206e  f.queue_type = n
+000149c0: 702e 6170 7065 6e64 2873 656c 662e 7175  p.append(self.qu
+000149d0: 6575 655f 7479 7065 2c20 705f 7479 7065  eue_type, p_type
+000149e0: 5f61 7272 2c20 6178 6973 3d30 290a 2020  _arr, axis=0).  
+000149f0: 2020 2020 2020 2020 2020 7365 6c66 2e71            self.q
+00014a00: 7565 7565 5f70 6174 6820 3d20 6e70 2e61  ueue_path = np.a
+00014a10: 7070 656e 6428 7365 6c66 2e71 7565 7565  ppend(self.queue
+00014a20: 5f70 6174 682c 2070 5f70 6174 685f 6172  _path, p_path_ar
+00014a30: 722c 2061 7869 733d 3029 0a20 2020 2020  r, axis=0).     
+00014a40: 2020 2020 2020 2073 656c 662e 7175 6575         self.queu
+00014a50: 655f 6578 7472 615f 696e 666f 203d 206e  e_extra_info = n
+00014a60: 702e 6170 7065 6e64 2873 656c 662e 7175  p.append(self.qu
+00014a70: 6575 655f 6578 7472 615f 696e 666f 2c20  eue_extra_info, 
+00014a80: 6578 7472 615f 696e 666f 2c20 6178 6973  extra_info, axis
+00014a90: 3d30 290a 0a20 2020 2064 6566 2067 6574  =0)..    def get
+00014aa0: 5f71 7565 7565 2873 656c 6629 202d 3e20  _queue(self) -> 
+00014ab0: 5475 706c 655b 4c69 7374 5b73 7472 5d2c  Tuple[List[str],
+00014ac0: 204c 6973 745b 7374 725d 2c20 4c69 7374   List[str], List
+00014ad0: 5b4c 6973 745b 7374 725d 5d2c 204c 6973  [List[str]], Lis
+00014ae0: 745b 6469 6374 5d5d 3a0a 2020 2020 2020  t[dict]]:.      
+00014af0: 2020 2222 220a 2020 2020 2020 2020 4361    """.        Ca
+00014b00: 6c6c 696e 6720 7468 6973 2069 6e64 6963  lling this indic
+00014b10: 6174 6573 2074 6861 7420 7468 6520 7175  ates that the qu
+00014b20: 6575 6520 6973 2061 626f 7574 2074 6f20  eue is about to 
+00014b30: 6265 2070 726f 6365 7373 6564 2c20 736f  be processed, so
+00014b40: 2074 6869 7320 6675 6e63 7469 6f6e 2063   this function c
+00014b50: 6f6d 6269 6e65 7320 5341 530a 2020 2020  ombines SAS.    
+00014b60: 2020 2020 636f 6d6d 616e 6473 2061 6c6f      commands alo
+00014b70: 6e67 2063 6f6c 756d 6e73 2028 636f 6d6d  ng columns (comm
+00014b80: 616e 6420 7374 6163 6b73 292c 2061 6e64  and stacks), and
+00014b90: 2072 6574 7572 6e73 204e 2053 4153 2063   returns N SAS c
+00014ba0: 6f6d 6d61 6e64 7320 746f 2062 6520 7275  ommands to be ru
+00014bb0: 6e20 636f 6e63 7572 7265 6e74 6c79 2c0a  n concurrently,.
+00014bc0: 2020 2020 2020 2020 7768 6572 6520 4e20          where N 
+00014bd0: 6973 2074 6865 206e 756d 6265 7220 6f66  is the number of
+00014be0: 2063 6f6c 756d 6e73 2e0a 0a20 2020 2020   columns...     
+00014bf0: 2020 203a 7265 7475 726e 3a20 4c69 7374     :return: List
+00014c00: 206f 6620 7374 7269 6e67 732c 2077 6865   of strings, whe
+00014c10: 7265 2074 6865 2073 7472 696e 6773 2061  re the strings a
+00014c20: 7265 2062 6173 6820 636f 6d6d 616e 6473  re bash commands
+00014c30: 2074 6f20 7275 6e20 5341 5320 7072 6f63   to run SAS proc
+00014c40: 6564 7572 6573 2c20 616e 6f74 6865 720a  edures, another.
+00014c50: 2020 2020 2020 2020 2020 2020 6c69 7374              list
+00014c60: 206f 6620 7374 7269 6e67 732c 2077 6865   of strings, whe
+00014c70: 7265 2074 6865 2073 7472 696e 6773 2061  re the strings a
+00014c80: 7265 2065 7870 6563 7465 6420 6f75 7470  re expected outp
+00014c90: 7574 2074 7970 6573 2066 6f72 2074 6865  ut types for the
+00014ca0: 2063 6f6d 6d61 6e64 732c 2061 206c 6973   commands, a lis
+00014cb0: 7420 6f66 0a20 2020 2020 2020 2020 2020  t of.           
+00014cc0: 206c 6973 7473 206f 6620 7374 7269 6e67   lists of string
+00014cd0: 732c 2077 6865 7265 2074 6865 2073 7472  s, where the str
+00014ce0: 696e 6773 2061 7265 2065 7870 6563 7465  ings are expecte
+00014cf0: 6420 6f75 7470 7574 2070 6174 6873 2066  d output paths f
+00014d00: 6f72 2070 726f 6475 6374 7320 6f66 2074  or products of t
+00014d10: 6865 2053 4153 2063 6f6d 6d61 6e64 732e  he SAS commands.
+00014d20: 0a20 2020 2020 2020 203a 7274 7970 653a  .        :rtype:
+00014d30: 2054 7570 6c65 5b4c 6973 745b 7374 725d   Tuple[List[str]
+00014d40: 2c20 4c69 7374 5b73 7472 5d2c 204c 6973  , List[str], Lis
+00014d50: 745b 4c69 7374 5b73 7472 5d5d 5d0a 2020  t[List[str]]].  
+00014d60: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00014d70: 2020 6966 2073 656c 662e 7175 6575 6520    if self.queue 
+00014d80: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+00014d90: 2020 2020 2023 2054 6869 7320 7265 7475       # This retu
+00014da0: 726e 7320 656d 7074 7920 6c69 7374 7320  rns empty lists 
+00014db0: 6966 2074 6865 2071 7565 7565 2069 7320  if the queue is 
+00014dc0: 756e 6465 6669 6e65 640a 2020 2020 2020  undefined.      
+00014dd0: 2020 2020 2020 7072 6f63 6573 7365 645f        processed_
+00014de0: 636d 6473 203d 205b 5d0a 2020 2020 2020  cmds = [].      
+00014df0: 2020 2020 2020 7479 7065 7320 3d20 5b5d        types = []
+00014e00: 0a20 2020 2020 2020 2020 2020 2070 6174  .            pat
+00014e10: 6873 203d 205b 5d0a 2020 2020 2020 2020  hs = [].        
+00014e20: 2020 2020 6578 7472 6173 203d 205b 5d0a      extras = [].
+00014e30: 2020 2020 2020 2020 656c 6966 206c 656e          elif len
+00014e40: 2873 656c 662e 7175 6575 652e 7368 6170  (self.queue.shap
+00014e50: 6529 203d 3d20 3120 6f72 2073 656c 662e  e) == 1 or self.
+00014e60: 7175 6575 652e 7368 6170 655b 315d 203c  queue.shape[1] <
+00014e70: 3d20 313a 0a20 2020 2020 2020 2020 2020  = 1:.           
+00014e80: 2070 726f 6365 7373 6564 5f63 6d64 7320   processed_cmds 
+00014e90: 3d20 6c69 7374 2873 656c 662e 7175 6575  = list(self.queu
+00014ea0: 6529 0a20 2020 2020 2020 2020 2020 2074  e).            t
+00014eb0: 7970 6573 203d 206c 6973 7428 7365 6c66  ypes = list(self
+00014ec0: 2e71 7565 7565 5f74 7970 6529 0a20 2020  .queue_type).   
+00014ed0: 2020 2020 2020 2020 2070 6174 6873 203d           paths =
+00014ee0: 205b 5b73 7472 2870 6174 6829 5d20 666f   [[str(path)] fo
+00014ef0: 7220 7061 7468 2069 6e20 7365 6c66 2e71  r path in self.q
+00014f00: 7565 7565 5f70 6174 685d 0a20 2020 2020  ueue_path].     
+00014f10: 2020 2020 2020 2065 7874 7261 7320 3d20         extras = 
+00014f20: 6c69 7374 2873 656c 662e 7175 6575 655f  list(self.queue_
+00014f30: 6578 7472 615f 696e 666f 290a 2020 2020  extra_info).    
+00014f40: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00014f50: 2020 2020 2020 7072 6f63 6573 7365 645f        processed_
+00014f60: 636d 6473 203d 205b 223b 222e 6a6f 696e  cmds = [";".join
+00014f70: 2863 6f6c 2920 666f 7220 636f 6c20 696e  (col) for col in
+00014f80: 2073 656c 662e 7175 6575 652e 545d 0a20   self.queue.T]. 
+00014f90: 2020 2020 2020 2020 2020 2074 7970 6573             types
+00014fa0: 203d 206c 6973 7428 7365 6c66 2e71 7565   = list(self.que
+00014fb0: 7565 5f74 7970 655b 2d31 2c20 3a5d 290a  ue_type[-1, :]).
+00014fc0: 2020 2020 2020 2020 2020 2020 7061 7468              path
+00014fd0: 7320 3d20 5b6c 6973 7428 636f 6c2e 6173  s = [list(col.as
+00014fe0: 7479 7065 2873 7472 2929 2066 6f72 2063  type(str)) for c
+00014ff0: 6f6c 2069 6e20 7365 6c66 2e71 7565 7565  ol in self.queue
+00015000: 5f70 6174 682e 545d 0a20 2020 2020 2020  _path.T].       
+00015010: 2020 2020 2065 7874 7261 7320 3d20 5b5d       extras = []
+00015020: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+00015030: 2063 6f6c 2069 6e20 7365 6c66 2e71 7565   col in self.que
+00015040: 7565 5f70 6174 682e 543a 0a20 2020 2020  ue_path.T:.     
+00015050: 2020 2020 2020 2020 2020 2023 2054 6869             # Thi
+00015060: 7320 6e65 7374 6564 2064 6963 7469 6f6e  s nested diction
+00015070: 6172 7920 636f 6d70 7265 6865 6e73 696f  ary comprehensio
+00015080: 6e20 636f 6d62 696e 6573 2061 2063 6f6c  n combines a col
+00015090: 756d 6e20 6f66 2065 7874 7261 2069 6e66  umn of extra inf
+000150a0: 6f72 6d61 7469 6f6e 0a20 2020 2020 2020  ormation.       
+000150b0: 2020 2020 2020 2020 2023 2064 6963 7469           # dicti
+000150c0: 6f6e 6172 6965 7320 696e 746f 206f 6e65  onaries into one
+000150d0: 2c20 666f 7220 6561 7365 206f 6620 6163  , for ease of ac
+000150e0: 6365 7373 2e0a 2020 2020 2020 2020 2020  cess..          
+000150f0: 2020 2020 2020 636f 6d62 5f65 7874 7261        comb_extra
+00015100: 203d 207b 6b3a 2076 2066 6f72 2065 7874   = {k: v for ext
+00015110: 5f64 6963 7420 696e 2063 6f6c 2066 6f72  _dict in col for
+00015120: 206b 2c20 7620 696e 2065 7874 5f64 6963   k, v in ext_dic
+00015130: 742e 6974 656d 7328 297d 0a20 2020 2020  t.items()}.     
+00015140: 2020 2020 2020 2020 2020 2065 7874 7261             extra
+00015150: 732e 6170 7065 6e64 2863 6f6d 625f 6578  s.append(comb_ex
+00015160: 7472 6129 0a0a 2020 2020 2020 2020 2320  tra)..        # 
+00015170: 5468 6973 2069 7320 6f6e 6c79 206c 696b  This is only lik
+00015180: 656c 7920 746f 2062 6520 6361 6c6c 6564  ely to be called
+00015190: 2077 6865 6e20 7072 6f63 6573 7369 6e67   when processing
+000151a0: 2069 7320 6265 6769 6e6e 696e 672c 2073   is beginning, s
+000151b0: 6f20 7468 6973 2077 696c 6c20 7769 7065  o this will wipe
+000151c0: 2074 6865 2071 7565 7565 2e0a 2020 2020   the queue..    
+000151d0: 2020 2020 7365 6c66 2e71 7565 7565 203d      self.queue =
+000151e0: 204e 6f6e 650a 2020 2020 2020 2020 7365   None.        se
+000151f0: 6c66 2e71 7565 7565 5f74 7970 6520 3d20  lf.queue_type = 
+00015200: 4e6f 6e65 0a20 2020 2020 2020 2073 656c  None.        sel
+00015210: 662e 7175 6575 655f 7061 7468 203d 204e  f.queue_path = N
+00015220: 6f6e 650a 2020 2020 2020 2020 7365 6c66  one.        self
+00015230: 2e71 7565 7565 5f65 7874 7261 5f69 6e66  .queue_extra_inf
+00015240: 6f20 3d20 4e6f 6e65 0a20 2020 2020 2020  o = None.       
+00015250: 2023 2054 6865 2072 6574 7572 6e65 6420   # The returned 
+00015260: 7061 7468 7320 6172 6520 6c69 7374 7320  paths are lists 
+00015270: 6f66 2073 7472 696e 6773 2062 6563 6175  of strings becau
+00015280: 7365 2077 6520 7761 6e74 2074 6f20 696e  se we want to in
+00015290: 636c 7564 6520 6576 6572 7920 6669 6c65  clude every file
+000152a0: 2069 6e20 6120 7374 6163 6b20 746f 2062   in a stack to b
+000152b0: 6520 6162 6c65 0a20 2020 2020 2020 2023  e able.        #
+000152c0: 2074 6f20 6368 6563 6b20 7468 6174 2065   to check that e
+000152d0: 7869 7374 730a 2020 2020 2020 2020 7265  xists.        re
+000152e0: 7475 726e 2070 726f 6365 7373 6564 5f63  turn processed_c
+000152f0: 6d64 732c 2074 7970 6573 2c20 7061 7468  mds, types, path
+00015300: 732c 2065 7874 7261 730a 0a20 2020 2064  s, extras..    d
+00015310: 6566 2067 6574 5f61 7474 5f66 696c 6528  ef get_att_file(
+00015320: 7365 6c66 2c20 6f62 735f 6964 3a20 7374  self, obs_id: st
+00015330: 7229 202d 3e20 7374 723a 0a20 2020 2020  r) -> str:.     
+00015340: 2020 2022 2222 0a20 2020 2020 2020 2046     """.        F
+00015350: 6574 6368 6573 2074 6865 2070 6174 6820  etches the path 
+00015360: 746f 2074 6865 2061 7474 6974 7564 6520  to the attitude 
+00015370: 6669 6c65 2066 6f72 2061 6e20 584d 4d20  file for an XMM 
+00015380: 6f62 7365 7276 6174 696f 6e2e 0a0a 2020  observation...  
+00015390: 2020 2020 2020 3a70 6172 616d 206f 6273        :param obs
+000153a0: 5f69 643a 2054 6865 204f 6273 4944 2074  _id: The ObsID t
+000153b0: 6f20 6665 7463 6820 7468 6520 6174 7469  o fetch the atti
+000153c0: 7475 6465 2066 696c 6520 666f 722e 0a20  tude file for.. 
+000153d0: 2020 2020 2020 203a 7265 7475 726e 3a20         :return: 
+000153e0: 5468 6520 7061 7468 2074 6f20 7468 6520  The path to the 
+000153f0: 6174 7469 7475 6465 2066 696c 652e 0a20  attitude file.. 
+00015400: 2020 2020 2020 203a 7274 7970 653a 2073         :rtype: s
+00015410: 7472 0a20 2020 2020 2020 2022 2222 0a20  tr.        """. 
+00015420: 2020 2020 2020 2069 6620 6f62 735f 6964         if obs_id
+00015430: 206e 6f74 2069 6e20 7365 6c66 2e5f 7072   not in self._pr
+00015440: 6f64 7563 7473 3a0a 2020 2020 2020 2020  oducts:.        
+00015450: 2020 2020 7261 6973 6520 4e6f 7441 7373      raise NotAss
+00015460: 6f63 6961 7465 6445 7272 6f72 2822 7b6f  ociatedError("{o
+00015470: 7d20 6973 206e 6f74 2061 7373 6f63 6961  } is not associa
+00015480: 7465 6420 7769 7468 207b 737d 222e 666f  ted with {s}".fo
+00015490: 726d 6174 286f 3d6f 6273 5f69 642c 2073  rmat(o=obs_id, s
+000154a0: 3d73 656c 662e 6e61 6d65 2929 0a20 2020  =self.name)).   
+000154b0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+000154c0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+000154d0: 6c66 2e5f 6174 745f 6669 6c65 735b 6f62  lf._att_files[ob
+000154e0: 735f 6964 5d0a 0a20 2020 2040 7072 6f70  s_id]..    @prop
+000154f0: 6572 7479 0a20 2020 2064 6566 206f 6273  erty.    def obs
+00015500: 5f69 6473 2873 656c 6629 202d 3e20 4c69  _ids(self) -> Li
+00015510: 7374 5b73 7472 5d3a 0a20 2020 2020 2020  st[str]:.       
+00015520: 2022 2222 0a20 2020 2020 2020 2050 726f   """.        Pro
+00015530: 7065 7274 7920 6765 7474 6572 2066 6f72  perty getter for
+00015540: 204f 6273 4944 7320 6173 736f 6369 6174   ObsIDs associat
+00015550: 6564 2077 6974 6820 7468 6973 2073 6f75  ed with this sou
+00015560: 7263 6520 7468 6174 2061 7265 2063 6f6e  rce that are con
+00015570: 6669 726d 6564 2074 6f20 6861 7665 2065  firmed to have e
+00015580: 7665 6e74 7320 6669 6c65 732e 0a0a 2020  vents files...  
+00015590: 2020 2020 2020 3a72 6574 7572 6e3a 2041        :return: A
+000155a0: 206c 6973 7420 6f66 2074 6865 2061 7373   list of the ass
+000155b0: 6f63 6961 7465 6420 584d 4d20 4f62 7349  ociated XMM ObsI
+000155c0: 4473 2e0a 2020 2020 2020 2020 3a72 7479  Ds..        :rty
+000155d0: 7065 3a20 4c69 7374 5b73 7472 5d0a 2020  pe: List[str].  
+000155e0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+000155f0: 2020 7265 7475 726e 2073 656c 662e 5f6f    return self._o
+00015600: 6273 0a0a 2020 2020 4070 726f 7065 7274  bs..    @propert
+00015610: 790a 2020 2020 6465 6620 626c 6163 6b6c  y.    def blackl
+00015620: 6973 7465 6428 7365 6c66 2920 2d3e 2044  isted(self) -> D
+00015630: 6963 743a 0a20 2020 2020 2020 2022 2222  ict:.        """
+00015640: 0a20 2020 2020 2020 2041 2070 726f 7065  .        A prope
+00015650: 7274 7920 6765 7474 6572 2074 6861 7420  rty getter that 
+00015660: 7265 7475 726e 7320 7468 6520 6469 6374  returns the dict
+00015670: 696f 6e61 7279 206f 6620 4f62 7349 4473  ionary of ObsIDs
+00015680: 2061 6e64 2074 6865 6972 2069 6e73 7472   and their instr
+00015690: 756d 656e 7473 2077 6869 6368 2068 6176  uments which hav
+000156a0: 6520 6265 656e 0a20 2020 2020 2020 2062  e been.        b
+000156b0: 6c61 636b 6c69 7374 6564 2c20 616e 6420  lacklisted, and 
+000156c0: 7468 7573 206e 6f74 2063 6f6e 7369 6465  thus not conside
+000156d0: 7265 6420 666f 7220 7573 6520 696e 2061  red for use in a
+000156e0: 6e79 2061 6e61 6c79 7369 7320 6f66 2074  ny analysis of t
+000156f0: 6869 7320 736f 7572 6365 2e0a 0a20 2020  his source...   
+00015700: 2020 2020 203a 7265 7475 726e 3a20 5468       :return: Th
+00015710: 6520 6469 6374 696f 6e61 7279 2028 7769  e dictionary (wi
+00015720: 7468 204f 6273 4944 7320 6173 206b 6579  th ObsIDs as key
+00015730: 7329 206f 6620 626c 6163 6b6c 6973 7465  s) of blackliste
+00015740: 6420 6461 7461 2e0a 2020 2020 2020 2020  d data..        
+00015750: 3a72 7479 7065 3a20 4469 6374 0a20 2020  :rtype: Dict.   
+00015760: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00015770: 2072 6574 7572 6e20 7365 6c66 2e5f 626c   return self._bl
+00015780: 6163 6b6c 6973 7465 645f 6f62 730a 0a20  acklisted_obs.. 
+00015790: 2020 2064 6566 205f 736f 7572 6365 5f74     def _source_t
+000157a0: 7970 655f 6d61 7463 6828 7365 6c66 2c20  ype_match(self, 
+000157b0: 736f 7572 6365 5f74 7970 653a 2073 7472  source_type: str
+000157c0: 2920 2d3e 2054 7570 6c65 5b44 6963 742c  ) -> Tuple[Dict,
+000157d0: 2044 6963 742c 2044 6963 745d 3a0a 2020   Dict, Dict]:.  
+000157e0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+000157f0: 2020 4120 6d65 7468 6f64 2074 6861 7420    A method that 
+00015800: 6c6f 6f6b 7320 666f 7220 6d61 7463 6865  looks for matche
+00015810: 7320 6e6f 7420 6a75 7374 2062 6173 6564  s not just based
+00015820: 206f 6e20 706f 7369 7469 6f6e 2c20 6275   on position, bu
+00015830: 7420 616c 736f 206f 6e20 7468 6520 7479  t also on the ty
+00015840: 7065 206f 6620 736f 7572 6365 0a20 2020  pe of source.   
+00015850: 2020 2020 2077 6520 7761 6e74 2074 6f20       we want to 
+00015860: 6669 6e64 2e20 4669 6e64 696e 6720 6e6f  find. Finding no
+00015870: 206d 6174 6368 6573 2069 7320 616c 6c6f   matches is allo
+00015880: 7765 642c 2062 7574 2074 6865 2073 6f75  wed, but the sou
+00015890: 7263 6520 7769 6c6c 2062 6520 6465 636c  rce will be decl
+000158a0: 6172 6564 2061 7320 756e 6465 7465 6374  ared as undetect
+000158b0: 6564 2e0a 2020 2020 2020 2020 416e 2065  ed..        An e
+000158c0: 7272 6f72 2077 696c 6c20 6265 2074 6872  rror will be thr
+000158d0: 6f77 6e20 6966 206d 6f72 6520 7468 616e  own if more than
+000158e0: 206f 6e65 206d 6174 6368 206f 6620 7468   one match of th
+000158f0: 6520 636f 7272 6563 7420 7479 7065 2070  e correct type p
+00015900: 6572 206f 6273 6572 7661 7469 6f6e 2069  er observation i
+00015910: 7320 666f 756e 642e 0a0a 2020 2020 2020  s found...      
+00015920: 2020 3a70 6172 616d 2073 7472 2073 6f75    :param str sou
+00015930: 7263 655f 7479 7065 3a20 5368 6f75 6c64  rce_type: Should
+00015940: 2065 6974 6865 7220 6265 2065 7874 206f   either be ext o
+00015950: 7220 706e 742c 2064 6573 6372 6962 6573  r pnt, describes
+00015960: 2077 6861 7420 7479 7065 206f 6620 736f   what type of so
+00015970: 7572 6365 2049 0a20 2020 2020 2020 2020  urce I.         
+00015980: 2020 2073 686f 756c 6420 6265 206c 6f6f     should be loo
+00015990: 6b69 6e67 2066 6f72 2069 6e20 7468 6520  king for in the 
+000159a0: 7265 6769 6f6e 2066 696c 6573 2e0a 2020  region files..  
+000159b0: 2020 2020 2020 3a72 6574 7572 6e3a 2041        :return: A
+000159c0: 2064 6963 7469 6f6e 6172 7920 636f 6e74   dictionary cont
+000159d0: 6169 6e69 6e67 2074 6865 206d 6174 6368  aining the match
+000159e0: 6564 2072 6567 696f 6e20 666f 7220 6561  ed region for ea
+000159f0: 6368 204f 6273 4944 202b 2061 2063 6f6d  ch ObsID + a com
+00015a00: 6269 6e65 6420 7265 6769 6f6e 2c20 616e  bined region, an
+00015a10: 6f74 6865 720a 2020 2020 2020 2020 2020  other.          
+00015a20: 2020 6469 6374 696f 6e61 7279 2063 6f6e    dictionary con
+00015a30: 7461 696e 696e 6720 616e 7920 736f 7572  taining any sour
+00015a40: 6365 7320 7468 6174 206d 6174 6368 6564  ces that matched
+00015a50: 2074 6f20 7468 6520 636f 6f72 6469 6e61   to the coordina
+00015a60: 7465 7320 616e 6420 7765 7265 6e27 7420  tes and weren't 
+00015a70: 6368 6f73 656e 2c0a 2020 2020 2020 2020  chosen,.        
+00015a80: 2020 2020 616e 6420 6120 6669 6e61 6c20      and a final 
+00015a90: 6469 6374 696f 6e61 7279 2077 6974 6820  dictionary with 
+00015aa0: 736f 7572 6365 7320 7468 6174 2061 7265  sources that are
+00015ab0: 6e27 7420 7468 6520 7461 7267 6574 2c20  n't the target, 
+00015ac0: 6f72 2069 6e20 7468 6520 326e 6420 6469  or in the 2nd di
+00015ad0: 6374 696f 6e61 7279 2e0a 2020 2020 2020  ctionary..      
+00015ae0: 2020 3a72 7479 7065 3a20 5475 706c 655b    :rtype: Tuple[
+00015af0: 4469 6374 2c20 4469 6374 2c20 4469 6374  Dict, Dict, Dict
+00015b00: 5d0a 2020 2020 2020 2020 2222 220a 2020  ].        """.  
+00015b10: 2020 2020 2020 2320 4465 6669 6e69 7469        # Definiti
+00015b20: 6f6e 7320 6f66 2074 6865 2063 6f6c 6f75  ons of the colou
+00015b30: 7273 206f 6620 5843 5320 7265 6769 6f6e  rs of XCS region
+00015b40: 7320 6361 6e20 6265 2066 6f75 6e64 2069  s can be found i
+00015b50: 6e20 7468 6520 7468 6573 6973 206f 6620  n the thesis of 
+00015b60: 4472 204d 6963 6865 616c 2044 6176 6964  Dr Micheal David
+00015b70: 736f 6e0a 2020 2020 2020 2020 2320 2055  son.        #  U
+00015b80: 6e69 7665 7273 6974 7920 6f66 2045 6469  niversity of Edi
+00015b90: 6e62 7572 6768 202d 2032 3030 352e 2054  nburgh - 2005. T
+00015ba0: 6865 7365 2061 7265 2074 6865 2064 6566  hese are the def
+00015bb0: 6175 6c74 2058 4741 2063 6f6c 6f75 7220  ault XGA colour 
+00015bc0: 6d65 616e 696e 6773 0a20 2020 2020 2020  meanings.       
+00015bd0: 2023 2052 6564 202d 2050 6f69 6e74 2073   # Red - Point s
+00015be0: 6f75 7263 650a 2020 2020 2020 2020 2320  ource.        # 
+00015bf0: 4772 6565 6e20 2d20 4578 7465 6e64 6564  Green - Extended
+00015c00: 2073 6f75 7263 650a 2020 2020 2020 2020   source.        
+00015c10: 2320 4d61 6765 6e74 6120 2d20 5053 462d  # Magenta - PSF-
+00015c20: 7369 7a65 6420 6578 7465 6e64 6564 2073  sized extended s
+00015c30: 6f75 7263 650a 2020 2020 2020 2020 2320  ource.        # 
+00015c40: 426c 7565 202d 2045 7874 656e 6465 6420  Blue - Extended 
+00015c50: 736f 7572 6365 2077 6974 6820 7369 676e  source with sign
+00015c60: 6966 6963 616e 7420 706f 696e 7420 736f  ificant point so
+00015c70: 7572 6365 2063 6f6e 7472 6962 7574 696f  urce contributio
+00015c80: 6e0a 2020 2020 2020 2020 2320 4379 616e  n.        # Cyan
+00015c90: 202d 2045 7874 656e 6465 6420 736f 7572   - Extended sour
+00015ca0: 6365 2077 6974 6820 7369 676e 6966 6963  ce with signific
+00015cb0: 616e 7420 5275 6e31 2063 6f6e 7472 6962  ant Run1 contrib
+00015cc0: 7574 696f 6e0a 2020 2020 2020 2020 2320  ution.        # 
+00015cd0: 5965 6c6c 6f77 202d 2045 7874 656e 6465  Yellow - Extende
+00015ce0: 6420 736f 7572 6365 2077 6974 6820 6c65  d source with le
+00015cf0: 7373 2074 6861 6e20 3130 2063 6f75 6e74  ss than 10 count
+00015d00: 730a 2020 2020 2020 2020 7472 793a 0a20  s.        try:. 
+00015d10: 2020 2020 2020 2020 2020 2023 2047 6574             # Get
+00015d20: 7320 7468 6520 616c 6c6f 7765 6420 636f  s the allowed co
+00015d30: 6c6f 7572 7320 666f 7220 7468 6520 6375  lours for the cu
+00015d40: 7272 656e 7420 736f 7572 6365 2074 7970  rrent source typ
+00015d50: 650a 2020 2020 2020 2020 2020 2020 616c  e.            al
+00015d60: 6c6f 7765 645f 636f 6c6f 7572 7320 3d20  lowed_colours = 
+00015d70: 5352 435f 5245 4749 4f4e 5f43 4f4c 4f55  SRC_REGION_COLOU
+00015d80: 5253 5b73 6f75 7263 655f 7479 7065 5d0a  RS[source_type].
+00015d90: 2020 2020 2020 2020 6578 6365 7074 204b          except K
+00015da0: 6579 4572 726f 723a 0a20 2020 2020 2020  eyError:.       
+00015db0: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+00015dc0: 4572 726f 7228 227b 7d20 6973 206e 6f74  Error("{} is not
+00015dd0: 2061 2072 6563 6f67 6e69 7365 6420 736f   a recognised so
+00015de0: 7572 6365 2074 7970 652c 2070 6c65 6173  urce type, pleas
+00015df0: 6520 220a 2020 2020 2020 2020 2020 2020  e ".            
+00015e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015e10: 2022 646f 6e27 7420 7573 6520 7468 6973   "don't use this
+00015e20: 2069 6e74 6572 6e61 6c20 6675 6e63 7469   internal functi
+00015e30: 6f6e 2122 2e66 6f72 6d61 7428 736f 7572  on!".format(sour
+00015e40: 6365 5f74 7970 6529 290a 0a20 2020 2020  ce_type))..     
+00015e50: 2020 2023 2048 6572 6520 7765 2073 746f     # Here we sto
+00015e60: 7265 2074 6865 2061 6374 7561 6c20 6d61  re the actual ma
+00015e70: 7463 6865 6420 736f 7572 6365 730a 2020  tched sources.  
+00015e80: 2020 2020 2020 7265 7375 6c74 735f 6469        results_di
+00015e90: 6374 203d 207b 7d0a 2020 2020 2020 2020  ct = {}.        
+00015ea0: 2320 416e 6420 696e 2074 6869 7320 6f6e  # And in this on
+00015eb0: 6520 676f 2061 6c6c 2074 6865 2073 6f75  e go all the sou
+00015ec0: 7263 6573 2074 6861 7420 6172 656e 2774  rces that aren't
+00015ed0: 2074 6865 206d 6174 6368 6564 2073 6f75   the matched sou
+00015ee0: 7263 652c 2077 6527 6c6c 206e 6565 6420  rce, we'll need 
+00015ef0: 746f 2073 7562 7472 6163 7420 7468 656d  to subtract them
+00015f00: 2e0a 2020 2020 2020 2020 616e 7469 5f72  ..        anti_r
+00015f10: 6573 756c 7473 5f64 6963 7420 3d20 7b7d  esults_dict = {}
+00015f20: 0a20 2020 2020 2020 2023 2053 6f75 7263  .        # Sourc
+00015f30: 6573 2069 6e20 7468 6973 2064 6963 7469  es in this dicti
+00015f40: 6f6e 6172 7920 6172 6520 7769 7468 696e  onary are within
+00015f50: 2074 6865 2074 6172 6765 7420 736f 7572   the target sour
+00015f60: 6365 2072 6567 696f 6e20 414e 4420 6d61  ce region AND ma
+00015f70: 7463 6865 6420 746f 2069 6e69 7469 616c  tched to initial
+00015f80: 2063 6f6f 7264 696e 6174 6573 2c0a 2020   coordinates,.  
+00015f90: 2020 2020 2020 2320 6275 7420 6172 656e        # but aren
+00015fa0: 2774 2074 6865 2063 686f 7365 6e20 736f  't the chosen so
+00015fb0: 7572 6365 2e0a 2020 2020 2020 2020 616c  urce..        al
+00015fc0: 745f 6d61 7463 685f 6469 6374 203d 207b  t_match_dict = {
+00015fd0: 7d0a 2020 2020 2020 2020 2320 476f 6573  }.        # Goes
+00015fe0: 2074 6872 6f75 6768 2061 6c6c 2074 6865   through all the
+00015ff0: 204f 6273 4944 7320 6173 736f 6369 6174   ObsIDs associat
+00016000: 6564 2077 6974 6820 7468 6973 2073 6f75  ed with this sou
+00016010: 7263 652c 2061 6e64 2063 6865 636b 7320  rce, and checks 
+00016020: 6966 2074 6865 7920 6861 7665 2072 6567  if they have reg
+00016030: 696f 6e73 0a20 2020 2020 2020 2023 2020  ions.        #  
+00016040: 4966 206e 6f74 2074 6865 6e20 4e6f 6e65  If not then None
+00016050: 7320 6172 6520 6164 6465 6420 746f 2074  s are added to t
+00016060: 6865 2076 6172 696f 7573 2064 6963 7469  he various dicti
+00016070: 6f6e 6172 6965 732c 206f 7468 6572 7769  onaries, otherwi
+00016080: 7365 2079 6f75 2065 6e64 2075 7020 7769  se you end up wi
+00016090: 7468 2061 206c 6973 7420 6f66 2072 6567  th a list of reg
+000160a0: 696f 6e73 0a20 2020 2020 2020 2023 2020  ions.        #  
+000160b0: 7769 7468 206d 6973 7369 6e67 204f 6273  with missing Obs
+000160c0: 4944 730a 2020 2020 2020 2020 666f 7220  IDs.        for 
+000160d0: 6f62 7320 696e 2073 656c 662e 6f62 735f  obs in self.obs_
+000160e0: 6964 733a 0a20 2020 2020 2020 2020 2020  ids:.           
+000160f0: 2069 6620 6f62 7320 696e 2073 656c 662e   if obs in self.
+00016100: 5f69 6e69 7469 616c 5f72 6567 696f 6e73  _initial_regions
+00016110: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00016120: 2020 2320 5468 6973 2073 6574 7320 7570    # This sets up
+00016130: 2061 6e20 6172 7261 7920 6f66 206d 6174   an array of mat
+00016140: 6368 6564 2072 6567 696f 6e73 2c20 6163  ched regions, ac
+00016150: 636f 756e 7469 6e67 2066 6f72 2074 6865  counting for the
+00016160: 2070 726f 626c 656d 7320 7468 6174 2063   problems that c
+00016170: 616e 206f 6363 7572 2077 6865 6e0a 2020  an occur when.  
+00016180: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00016190: 2074 6865 7265 2069 7320 6f6e 6c79 206f   there is only o
+000161a0: 6e65 2072 6567 696f 6e20 696e 2074 6865  ne region in the
+000161b0: 2072 6567 696f 6e20 6c69 7374 2028 6e75   region list (nu
+000161c0: 6d70 7927 7320 696e 6465 7869 6e67 2067  mpy's indexing g
+000161d0: 6574 7320 7665 7279 2061 6e67 7279 292e  ets very angry).
+000161e0: 2054 6865 2061 7272 6179 0a20 2020 2020   The array.     
+000161f0: 2020 2020 2020 2020 2020 2023 2020 6f66             #  of
+00016200: 206d 6174 6368 6564 2072 6567 696f 6e28   matched region(
+00016210: 7329 2073 6574 2075 7020 6865 7265 2069  s) set up here i
+00016220: 7320 7573 6564 2069 6e20 7468 6973 206d  s used in this m
+00016230: 6574 686f 642e 0a20 2020 2020 2020 2020  ethod..         
+00016240: 2020 2020 2020 2069 6620 6c65 6e28 7365         if len(se
+00016250: 6c66 2e5f 696e 6974 6961 6c5f 7265 6769  lf._initial_regi
+00016260: 6f6e 735b 6f62 735d 2920 3d3d 2031 2061  ons[obs]) == 1 a
+00016270: 6e64 206e 6f74 2073 656c 662e 5f69 6e69  nd not self._ini
+00016280: 7469 616c 5f72 6567 696f 6e5f 6d61 7463  tial_region_matc
+00016290: 6865 735b 6f62 735d 5b30 5d3a 0a20 2020  hes[obs][0]:.   
+000162a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000162b0: 2069 6e69 745f 7265 6769 6f6e 5f6d 6174   init_region_mat
+000162c0: 6368 6573 203d 206e 702e 6172 7261 7928  ches = np.array(
+000162d0: 5b5d 290a 2020 2020 2020 2020 2020 2020  []).            
+000162e0: 2020 2020 656c 6966 206c 656e 2873 656c      elif len(sel
+000162f0: 662e 5f69 6e69 7469 616c 5f72 6567 696f  f._initial_regio
+00016300: 6e73 5b6f 6273 5d29 203d 3d20 3120 616e  ns[obs]) == 1 an
+00016310: 6420 7365 6c66 2e5f 696e 6974 6961 6c5f  d self._initial_
+00016320: 7265 6769 6f6e 5f6d 6174 6368 6573 5b6f  region_matches[o
+00016330: 6273 5d5b 305d 3a0a 2020 2020 2020 2020  bs][0]:.        
+00016340: 2020 2020 2020 2020 2020 2020 696e 6974              init
+00016350: 5f72 6567 696f 6e5f 6d61 7463 6865 7320  _region_matches 
+00016360: 3d20 7365 6c66 2e5f 696e 6974 6961 6c5f  = self._initial_
+00016370: 7265 6769 6f6e 735b 6f62 735d 0a20 2020  regions[obs].   
+00016380: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
+00016390: 6620 6c65 6e28 7365 6c66 2e5f 696e 6974  f len(self._init
+000163a0: 6961 6c5f 7265 6769 6f6e 735b 6f62 735d  ial_regions[obs]
+000163b0: 5b73 656c 662e 5f69 6e69 7469 616c 5f72  [self._initial_r
+000163c0: 6567 696f 6e5f 6d61 7463 6865 735b 6f62  egion_matches[ob
+000163d0: 735d 5d29 203d 3d20 303a 0a20 2020 2020  s]]) == 0:.     
+000163e0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000163f0: 6e69 745f 7265 6769 6f6e 5f6d 6174 6368  nit_region_match
+00016400: 6573 203d 206e 702e 6172 7261 7928 5b5d  es = np.array([]
+00016410: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00016420: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00016430: 2020 2020 2020 2020 2020 2020 696e 6974              init
+00016440: 5f72 6567 696f 6e5f 6d61 7463 6865 7320  _region_matches 
+00016450: 3d20 7365 6c66 2e5f 696e 6974 6961 6c5f  = self._initial_
+00016460: 7265 6769 6f6e 735b 6f62 735d 5b73 656c  regions[obs][sel
+00016470: 662e 5f69 6e69 7469 616c 5f72 6567 696f  f._initial_regio
+00016480: 6e5f 6d61 7463 6865 735b 6f62 735d 5d0a  n_matches[obs]].
+00016490: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000164a0: 2023 2049 6620 7468 6572 6520 6172 6520   # If there are 
+000164b0: 6e6f 206d 6174 6368 6573 2074 6865 6e20  no matches then 
+000164c0: 7468 6520 7265 7475 726e 6564 2072 6573  the returned res
+000164d0: 756c 7420 6973 206a 7573 7420 4e6f 6e65  ult is just None
+000164e0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000164f0: 2020 6966 206c 656e 2869 6e69 745f 7265    if len(init_re
+00016500: 6769 6f6e 5f6d 6174 6368 6573 2920 3d3d  gion_matches) ==
+00016510: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+00016520: 2020 2020 2020 2020 7265 7375 6c74 735f          results_
+00016530: 6469 6374 5b6f 6273 5d20 3d20 4e6f 6e65  dict[obs] = None
+00016540: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016550: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00016560: 2020 2020 2020 2020 2020 2069 6e74 6572             inter
+00016570: 696d 5f72 6567 203d 205b 5d0a 2020 2020  im_reg = [].    
+00016580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016590: 2320 5468 6520 6f6e 6c79 2073 6f6c 7574  # The only solut
+000165a0: 696f 6e20 4920 636f 756c 6420 7468 696e  ion I could thin
+000165b0: 6b20 6f66 2069 7320 746f 2067 6f20 6279  k of is to go by
+000165c0: 2074 6865 2058 4353 2073 7461 6e64 6172   the XCS standar
+000165d0: 6420 6f66 2072 6567 696f 6e20 6669 6c65  d of region file
+000165e0: 732c 2073 6f20 6772 6565 6e0a 2020 2020  s, so green.    
+000165f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016600: 2320 2069 7320 6578 7465 6e64 6564 2c20  #  is extended, 
+00016610: 7265 6420 6973 2070 6f69 6e74 2065 7463  red is point etc
+00016620: 2e20 2d20 6e6f 7420 6964 6561 6c20 6275  . - not ideal bu
+00016630: 7420 4927 6c6c 206a 7573 7420 6578 706c  t I'll just expl
+00016640: 6169 6e20 696e 2074 6865 2064 6f63 756d  ain in the docum
+00016650: 656e 7461 7469 6f6e 0a20 2020 2020 2020  entation.       
+00016660: 2020 2020 2020 2020 2020 2020 2023 2066               # f
+00016670: 6f72 2065 6e74 7279 2069 6e20 7365 6c66  or entry in self
+00016680: 2e5f 696e 6974 6961 6c5f 7265 6769 6f6e  ._initial_region
+00016690: 735b 6f62 735d 5b73 656c 662e 5f69 6e69  s[obs][self._ini
+000166a0: 7469 616c 5f72 6567 696f 6e5f 6d61 7463  tial_region_matc
+000166b0: 6865 735b 6f62 735d 5d3a 0a20 2020 2020  hes[obs]]:.     
+000166c0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000166d0: 6f72 2065 6e74 7279 2069 6e20 696e 6974  or entry in init
+000166e0: 5f72 6567 696f 6e5f 6d61 7463 6865 733a  _region_matches:
+000166f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016700: 2020 2020 2020 2020 2069 6620 656e 7472           if entr
+00016710: 792e 7669 7375 616c 5b22 636f 6c6f 7222  y.visual["color"
+00016720: 5d20 696e 2061 6c6c 6f77 6564 5f63 6f6c  ] in allowed_col
+00016730: 6f75 7273 3a0a 2020 2020 2020 2020 2020  ours:.          
+00016740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016750: 2020 696e 7465 7269 6d5f 7265 672e 6170    interim_reg.ap
+00016760: 7065 6e64 2865 6e74 7279 290a 0a20 2020  pend(entry)..   
+00016770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016780: 2023 2044 6966 6665 7265 6e74 206d 6174   # Different mat
+00016790: 6368 696e 6720 706f 7373 6962 696c 6974  ching possibilit
+000167a0: 6965 730a 2020 2020 2020 2020 2020 2020  ies.            
+000167b0: 2020 2020 2020 2020 6966 206c 656e 2869          if len(i
+000167c0: 6e74 6572 696d 5f72 6567 2920 3d3d 2030  nterim_reg) == 0
+000167d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000167e0: 2020 2020 2020 2020 2020 7265 7375 6c74            result
+000167f0: 735f 6469 6374 5b6f 6273 5d20 3d20 4e6f  s_dict[obs] = No
+00016800: 6e65 0a20 2020 2020 2020 2020 2020 2020  ne.             
+00016810: 2020 2020 2020 2065 6c69 6620 6c65 6e28         elif len(
+00016820: 696e 7465 7269 6d5f 7265 6729 203d 3d20  interim_reg) == 
+00016830: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
+00016840: 2020 2020 2020 2020 2020 2072 6573 756c             resul
+00016850: 7473 5f64 6963 745b 6f62 735d 203d 2069  ts_dict[obs] = i
+00016860: 6e74 6572 696d 5f72 6567 5b30 5d0a 2020  nterim_reg[0].  
+00016870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016880: 2020 2320 4d61 7463 6869 6e67 2074 6f20    # Matching to 
+00016890: 6d75 6c74 6970 6c65 2073 6f75 7263 6573  multiple sources
+000168a0: 2077 6f75 6c64 2062 6520 7665 7279 2070   would be very p
+000168b0: 726f 626c 656d 6174 6963 2c20 736f 2074  roblematic, so t
+000168c0: 6872 6f77 2061 6e20 6572 726f 720a 2020  hrow an error.  
+000168d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000168e0: 2020 656c 6966 206c 656e 2869 6e74 6572    elif len(inter
+000168f0: 696d 5f72 6567 2920 3e20 3120 616e 6420  im_reg) > 1 and 
+00016900: 736f 7572 6365 5f74 7970 6520 3d3d 2022  source_type == "
+00016910: 706e 7422 3a0a 2020 2020 2020 2020 2020  pnt":.          
+00016920: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00016930: 4920 6d61 6465 2074 6865 205f 6c6f 6164  I made the _load
+00016940: 5f72 6567 696f 6e73 206d 6574 686f 6420  _regions method 
+00016950: 736f 7274 2074 6865 206f 7574 7075 7474  sort the outputt
+00016960: 6564 2072 6567 696f 6e20 6469 6374 696f  ed region dictio
+00016970: 6e61 7269 6573 2062 7920 6469 7374 616e  naries by distan
+00016980: 6365 2066 726f 6d20 7468 650a 2020 2020  ce from the.    
+00016990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000169a0: 2020 2020 2320 2069 6e70 7574 2063 6f6f      #  input coo
+000169b0: 7264 696e 6174 6573 2c20 736f 2049 206b  rdinates, so I k
+000169c0: 6e6f 7720 7468 6174 2074 6865 2030 7468  now that the 0th
+000169d0: 2065 6e74 7279 2077 696c 6c20 6265 2074   entry will be t
+000169e0: 6865 2063 6c6f 7365 7374 2074 6f20 7468  he closest to th
+000169f0: 6520 736f 7572 6365 2063 6f6f 7264 732e  e source coords.
+00016a00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016a10: 2020 2020 2020 2020 2023 2020 4865 6e63           #  Henc
+00016a20: 6520 4920 6368 6f6f 7365 2074 6861 7420  e I choose that 
+00016a30: 6f6e 6520 666f 7220 706e 7420 736f 7572  one for pnt sour
+00016a40: 6365 206d 756c 7469 2d6d 6174 6368 6573  ce multi-matches
+00016a50: 206c 696b 6520 7468 6973 2c20 7365 6520   like this, see 
+00016a60: 636f 6d6d 656e 7420 3220 6f66 2069 7373  comment 2 of iss
+00016a70: 7565 2023 3633 390a 2020 2020 2020 2020  ue #639.        
+00016a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016a90: 2320 2066 6f72 2061 6e20 6578 616d 706c  #  for an exampl
+00016aa0: 652e 0a20 2020 2020 2020 2020 2020 2020  e..             
+00016ab0: 2020 2020 2020 2020 2020 2072 6573 756c             resul
+00016ac0: 7473 5f64 6963 745b 6f62 735d 203d 2069  ts_dict[obs] = i
+00016ad0: 6e74 6572 696d 5f72 6567 5b30 5d0a 2020  nterim_reg[0].  
+00016ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016af0: 2020 2020 2020 7761 726e 5f74 6578 7420        warn_text 
+00016b00: 3d20 227b 6e73 7d20 6d61 7463 6865 7320  = "{ns} matches 
+00016b10: 666f 7220 7468 6520 706f 696e 7420 736f  for the point so
+00016b20: 7572 6365 207b 6e7d 2061 7265 2066 6f75  urce {n} are fou
+00016b30: 6e64 2069 6e20 7468 6520 7b6f 7d20 7265  nd in the {o} re
+00016b40: 6769 6f6e 2022 205c 0a20 2020 2020 2020  gion " \.       
+00016b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016b60: 2020 2020 2020 2020 2020 2020 2022 6669               "fi
+00016b70: 6c65 2e20 5468 6520 736f 7572 6365 206e  le. The source n
+00016b80: 6561 7265 7374 2074 6f20 7468 6520 7061  earest to the pa
+00016b90: 7373 6564 2063 6f6f 7264 696e 6174 6573  ssed coordinates
+00016ba0: 2069 7320 6163 6365 7074 6564 2c20 616c   is accepted, al
+00016bb0: 6c20 6f74 6865 7273 2022 205c 0a20 2020  l others " \.   
+00016bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016be0: 2022 7769 6c6c 2062 6520 706c 6163 6564   "will be placed
+00016bf0: 2069 6e20 7468 6520 616c 7465 726e 6174   in the alternat
+00016c00: 6520 6d61 7463 6820 6361 7465 676f 7279  e match category
+00016c10: 2061 6e64 2077 696c 6c20 6e6f 7420 6265   and will not be
+00016c20: 2072 656d 6f76 6564 2022 205c 0a20 2020   removed " \.   
+00016c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016c50: 2022 6279 206d 6173 6b73 2e22 2e66 6f72   "by masks.".for
+00016c60: 6d61 7428 6f3d 6f62 732c 206e 3d73 656c  mat(o=obs, n=sel
+00016c70: 662e 6e61 6d65 2c20 6e73 3d6c 656e 2869  f.name, ns=len(i
+00016c80: 6e74 6572 696d 5f72 6567 2929 0a20 2020  nterim_reg)).   
+00016c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016ca0: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
+00016cb0: 2e5f 7361 6d70 5f6d 656d 6265 723a 0a20  ._samp_member:. 
 00016cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016cd0: 2020 2266 6f72 206f 6273 6572 7661 7469    "for observati
-00016ce0: 6f6e 207b 6f7d 2c20 7468 6973 2063 616e  on {o}, this can
-00016cf0: 6e6f 7420 7965 7420 6265 2064 6561 6c74  not yet be dealt
-00016d00: 2077 6974 6820 220a 2020 2020 2020 2020   with ".        
-00016d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016cd0: 2020 2020 2020 2020 2020 2077 6172 6e28             warn(
+00016ce0: 7761 726e 5f74 6578 742c 2073 7461 636b  warn_text, stack
+00016cf0: 6c65 7665 6c3d 3229 0a20 2020 2020 2020  level=2).       
+00016d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016d10: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
 00016d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016d30: 2020 2020 2020 2020 2022 666f 7220 6578           "for ex
-00016d40: 7465 6e64 6564 2073 6f75 7263 6573 2e22  tended sources."
-00016d50: 2e66 6f72 6d61 7428 6f3d 6f62 732c 206e  .format(o=obs, n
-00016d60: 3d73 656c 662e 6e61 6d65 2929 0a0a 2020  =self.name))..  
-00016d70: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00016d80: 416c 7420 6d61 7463 6820 6973 2075 7365  Alt match is use
-00016d90: 6420 666f 7220 7768 656e 2074 6865 7265  d for when there
-00016da0: 2069 7320 6120 7365 636f 6e64 6172 7920   is a secondary 
-00016db0: 6d61 7463 6820 746f 2061 2070 6f69 6e74  match to a point
-00016dc0: 2073 6f75 7263 650a 2020 2020 2020 2020   source.        
-00016dd0: 2020 2020 2020 2020 616c 745f 6d61 7463          alt_matc
-00016de0: 685f 7265 6720 3d20 5b65 6e74 7279 2066  h_reg = [entry f
-00016df0: 6f72 2065 6e74 7279 2069 6e20 696e 6974  or entry in init
-00016e00: 5f72 6567 696f 6e5f 6d61 7463 6865 7320  _region_matches 
-00016e10: 6966 2065 6e74 7279 2021 3d20 7265 7375  if entry != resu
-00016e20: 6c74 735f 6469 6374 5b6f 6273 5d5d 0a20  lts_dict[obs]]. 
-00016e30: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00016e40: 6c74 5f6d 6174 6368 5f64 6963 745b 6f62  lt_match_dict[ob
-00016e50: 735d 203d 2061 6c74 5f6d 6174 6368 5f72  s] = alt_match_r
-00016e60: 6567 0a0a 2020 2020 2020 2020 2020 2020  eg..            
-00016e70: 2020 2020 2320 5468 6573 6520 6172 6520      # These are 
-00016e80: 616c 6c20 7468 6520 736f 7572 6365 7320  all the sources 
-00016e90: 7468 6174 2061 7265 6e27 7420 6120 6d61  that aren't a ma
-00016ea0: 7463 682c 2061 6e64 2073 6f20 7368 6f75  tch, and so shou
-00016eb0: 6c64 2062 6520 7265 6d6f 7665 6420 6672  ld be removed fr
-00016ec0: 6f6d 2061 6e79 2061 6e61 6c79 7369 730a  om any analysis.
-00016ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016ee0: 6e6f 745f 736f 7572 6365 5f72 6567 203d  not_source_reg =
-00016ef0: 205b 7265 6720 666f 7220 7265 6720 696e   [reg for reg in
-00016f00: 2073 656c 662e 5f69 6e69 7469 616c 5f72   self._initial_r
-00016f10: 6567 696f 6e73 5b6f 6273 5d20 6966 2072  egions[obs] if r
-00016f20: 6567 2021 3d20 7265 7375 6c74 735f 6469  eg != results_di
-00016f30: 6374 5b6f 6273 5d0a 2020 2020 2020 2020  ct[obs].        
-00016f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016f50: 2020 2020 2020 2020 2020 616e 6420 7265            and re
-00016f60: 6720 6e6f 7420 696e 2061 6c74 5f6d 6174  g not in alt_mat
-00016f70: 6368 5f72 6567 5d0a 2020 2020 2020 2020  ch_reg].        
-00016f80: 2020 2020 2020 2020 616e 7469 5f72 6573          anti_res
-00016f90: 756c 7473 5f64 6963 745b 6f62 735d 203d  ults_dict[obs] =
-00016fa0: 206e 6f74 5f73 6f75 7263 655f 7265 670a   not_source_reg.
-00016fb0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00016fc0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00016fd0: 2020 2072 6573 756c 7473 5f64 6963 745b     results_dict[
-00016fe0: 6f62 735d 203d 204e 6f6e 650a 2020 2020  obs] = None.    
-00016ff0: 2020 2020 2020 2020 2020 2020 616c 745f              alt_
-00017000: 6d61 7463 685f 6469 6374 5b6f 6273 5d20  match_dict[obs] 
-00017010: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
-00017020: 2020 2020 2061 6e74 695f 7265 7375 6c74       anti_result
-00017030: 735f 6469 6374 5b6f 6273 5d20 3d20 5b5d  s_dict[obs] = []
-00017040: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-00017050: 2072 6573 756c 7473 5f64 6963 742c 2061   results_dict, a
-00017060: 6c74 5f6d 6174 6368 5f64 6963 742c 2061  lt_match_dict, a
-00017070: 6e74 695f 7265 7375 6c74 735f 6469 6374  nti_results_dict
-00017080: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
-00017090: 2020 2020 6465 6620 6465 7465 6374 6564      def detected
-000170a0: 2873 656c 6629 202d 3e20 6469 6374 3a0a  (self) -> dict:.
-000170b0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-000170c0: 2020 2020 4120 7072 6f70 6572 7479 2067      A property g
-000170d0: 6574 7465 7220 746f 2072 6574 7572 6e20  etter to return 
-000170e0: 6966 2061 206d 6174 6368 206f 6620 7468  if a match of th
-000170f0: 6520 636f 7272 6563 7420 7479 7065 2068  e correct type h
-00017100: 6173 2062 6565 6e20 666f 756e 642e 0a0a  as been found...
-00017110: 2020 2020 2020 2020 3a72 6574 7572 6e3a          :return:
-00017120: 2054 6865 2064 6574 6563 7465 6420 626f   The detected bo
-00017130: 6f6c 6561 6e20 6174 7472 6962 7574 652e  olean attribute.
-00017140: 0a20 2020 2020 2020 203a 7274 7970 653a  .        :rtype:
-00017150: 2062 6f6f 6c0a 2020 2020 2020 2020 2222   bool.        ""
-00017160: 220a 2020 2020 2020 2020 6966 2073 656c  ".        if sel
-00017170: 662e 5f64 6574 6563 7465 6420 6973 204e  f._detected is N
-00017180: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00017190: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-000171a0: 7228 2264 6574 6563 7465 6420 6973 2063  r("detected is c
-000171b0: 7572 7265 6e74 6c79 204e 6f6e 652c 2042  urrently None, B
-000171c0: 6173 6553 6f75 7263 6520 6f62 6a65 6374  aseSource object
-000171d0: 7320 646f 6e27 7420 6861 7665 2074 6865  s don't have the
-000171e0: 2074 7970 6520 220a 2020 2020 2020 2020   type ".        
-000171f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017200: 2020 2020 2022 636f 6e74 6578 7420 6e65       "context ne
-00017210: 6564 6564 2074 6f20 6465 6669 6e65 2069  eded to define i
-00017220: 6620 7468 6520 736f 7572 6365 2069 7320  f the source is 
-00017230: 6465 7465 6374 6564 206f 7220 6e6f 742e  detected or not.
-00017240: 2229 0a20 2020 2020 2020 2065 6c73 653a  ").        else:
-00017250: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00017260: 7572 6e20 7365 6c66 2e5f 6465 7465 6374  urn self._detect
-00017270: 6564 0a0a 2020 2020 4070 726f 7065 7274  ed..    @propert
-00017280: 790a 2020 2020 6465 6620 6d61 7463 6865  y.    def matche
-00017290: 645f 7265 6769 6f6e 7328 7365 6c66 2920  d_regions(self) 
-000172a0: 2d3e 2064 6963 743a 0a20 2020 2020 2020  -> dict:.       
-000172b0: 2022 2222 0a20 2020 2020 2020 2050 726f   """.        Pro
-000172c0: 7065 7274 7920 6765 7474 6572 2066 6f72  perty getter for
-000172d0: 2074 6865 206d 6174 6368 6564 2072 6567   the matched reg
-000172e0: 696f 6e73 2061 7373 6f63 6961 7465 6420  ions associated 
-000172f0: 7769 7468 2074 6869 7320 7061 7274 6963  with this partic
-00017300: 756c 6172 2073 6f75 7263 652e 0a0a 2020  ular source...  
-00017310: 2020 2020 2020 3a72 6574 7572 6e3a 2041        :return: A
-00017320: 2064 6963 7469 6f6e 6172 7920 6f66 206d   dictionary of m
-00017330: 6174 6368 696e 6720 7265 6769 6f6e 732c  atching regions,
-00017340: 206f 7220 4e6f 6e65 2069 6620 7375 6368   or None if such
-00017350: 2061 206d 6174 6368 2068 6173 206e 6f74   a match has not
-00017360: 2062 6565 6e20 7065 7266 6f72 6d65 642e   been performed.
-00017370: 0a20 2020 2020 2020 203a 7274 7970 653a  .        :rtype:
-00017380: 2064 6963 740a 2020 2020 2020 2020 2222   dict.        ""
-00017390: 220a 2020 2020 2020 2020 7265 7475 726e  ".        return
-000173a0: 2073 656c 662e 5f72 6567 696f 6e73 0a0a   self._regions..
-000173b0: 2020 2020 6465 6620 736f 7572 6365 5f62      def source_b
-000173c0: 6163 6b5f 7265 6769 6f6e 7328 7365 6c66  ack_regions(self
-000173d0: 2c20 7265 675f 7479 7065 3a20 7374 722c  , reg_type: str,
-000173e0: 206f 6273 5f69 643a 2073 7472 203d 204e   obs_id: str = N
-000173f0: 6f6e 652c 2063 656e 7472 616c 5f63 6f6f  one, central_coo
-00017400: 7264 3a20 5175 616e 7469 7479 203d 204e  rd: Quantity = N
-00017410: 6f6e 6529 205c 0a20 2020 2020 2020 2020  one) \.         
-00017420: 2020 202d 3e20 5475 706c 655b 536b 7952     -> Tuple[SkyR
-00017430: 6567 696f 6e2c 2053 6b79 5265 6769 6f6e  egion, SkyRegion
-00017440: 5d3a 0a20 2020 2020 2020 2022 2222 0a20  ]:.        """. 
-00017450: 2020 2020 2020 2041 206d 6574 686f 6420         A method 
-00017460: 746f 2072 6574 7269 6576 6520 736f 7572  to retrieve sour
-00017470: 6365 2072 6567 696f 6e20 616e 6420 6261  ce region and ba
-00017480: 636b 6772 6f75 6e64 2072 6567 696f 6e20  ckground region 
-00017490: 6f62 6a65 6374 7320 666f 7220 6120 6769  objects for a gi
-000174a0: 7665 6e20 736f 7572 6365 2074 7970 6520  ven source type 
-000174b0: 7769 7468 2061 0a20 2020 2020 2020 2067  with a.        g
-000174c0: 6976 656e 2063 656e 7472 616c 2063 6f6f  iven central coo
-000174d0: 7264 696e 6174 652e 0a0a 2020 2020 2020  rdinate...      
-000174e0: 2020 3a70 6172 616d 2073 7472 2072 6567    :param str reg
-000174f0: 5f74 7970 653a 2054 6865 2074 7970 6520  _type: The type 
-00017500: 6f66 2072 6567 696f 6e20 7768 6963 6820  of region which 
-00017510: 7765 2077 6973 6820 746f 2067 6574 2066  we wish to get f
-00017520: 726f 6d20 7468 6520 736f 7572 6365 2e0a  rom the source..
-00017530: 2020 2020 2020 2020 3a70 6172 616d 2073          :param s
-00017540: 7472 206f 6273 5f69 643a 2054 6865 204f  tr obs_id: The O
-00017550: 6273 4944 2074 6861 7420 7468 6520 7265  bsID that the re
-00017560: 6769 6f6e 2069 7320 6173 736f 6369 6174  gion is associat
-00017570: 6564 2077 6974 6820 2869 6620 6170 7072  ed with (if appr
-00017580: 6f70 7269 6174 6529 2e0a 2020 2020 2020  opriate)..      
-00017590: 2020 3a70 6172 616d 2051 7561 6e74 6974    :param Quantit
-000175a0: 7920 6365 6e74 7261 6c5f 636f 6f72 643a  y central_coord:
-000175b0: 2054 6865 2063 656e 7472 616c 2063 6f6f   The central coo
-000175c0: 7264 696e 6174 6520 6f66 2074 6865 2072  rdinate of the r
-000175d0: 6567 696f 6e2e 0a20 2020 2020 2020 203a  egion..        :
-000175e0: 7265 7475 726e 3a20 5468 6520 6d65 7468  return: The meth
-000175f0: 6f64 2072 6574 7572 6e73 2062 6f74 6820  od returns both 
-00017600: 7468 6520 736f 7572 6365 2072 6567 696f  the source regio
-00017610: 6e20 616e 6420 7468 6520 6173 736f 6369  n and the associ
-00017620: 6174 6564 2062 6163 6b67 726f 756e 6420  ated background 
-00017630: 7265 6769 6f6e 2e0a 2020 2020 2020 2020  region..        
-00017640: 3a72 7479 7065 3a0a 2020 2020 2020 2020  :rtype:.        
-00017650: 2222 220a 2020 2020 2020 2020 2320 446f  """.        # Do
-00017660: 696e 6720 616e 2069 6e69 7469 616c 2063  ing an initial c
-00017670: 6865 636b 2073 6f20 4920 6361 6e20 7468  heck so I can th
-00017680: 726f 7720 6120 7761 726e 696e 6720 6966  row a warning if
-00017690: 2074 6865 2075 7365 7220 7761 6e74 7320   the user wants 
-000176a0: 6120 7265 6769 6f6e 2d6c 6973 7420 7265  a region-list re
-000176b0: 6769 6f6e 2041 4e44 2068 6173 2073 7570  gion AND has sup
-000176c0: 706c 6965 640a 2020 2020 2020 2020 2320  plied.        # 
-000176d0: 2063 7573 746f 6d20 6365 6e74 7261 6c20   custom central 
-000176e0: 636f 6f72 6469 6e61 7465 730a 2020 2020  coordinates.    
-000176f0: 2020 2020 6966 2072 6567 5f74 7970 6520      if reg_type 
-00017700: 3d3d 2022 7265 6769 6f6e 2220 616e 6420  == "region" and 
-00017710: 6365 6e74 7261 6c5f 636f 6f72 6420 6973  central_coord is
-00017720: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-00017730: 2020 2020 2020 2077 6172 6e28 2259 6f75         warn("You
-00017740: 2063 616e 6e6f 7420 7573 6520 6375 7374   cannot use cust
-00017750: 6f6d 2063 656e 7472 616c 2063 6f6f 7264  om central coord
-00017760: 696e 6174 6573 2077 6974 6820 6120 7265  inates with a re
-00017770: 6769 6f6e 2066 726f 6d20 7375 7070 6c69  gion from suppli
-00017780: 6564 2072 6567 696f 6e20 6669 6c65 7322  ed region files"
-00017790: 2c20 7374 6163 6b6c 6576 656c 3d32 290a  , stacklevel=2).
-000177a0: 0a20 2020 2020 2020 2069 6620 6365 6e74  .        if cent
-000177b0: 7261 6c5f 636f 6f72 6420 6973 204e 6f6e  ral_coord is Non
-000177c0: 653a 0a20 2020 2020 2020 2020 2020 2063  e:.            c
-000177d0: 656e 7472 616c 5f63 6f6f 7264 203d 2073  entral_coord = s
-000177e0: 656c 662e 5f64 6566 6175 6c74 5f63 6f6f  elf._default_coo
-000177f0: 7264 0a0a 2020 2020 2020 2020 6966 2074  rd..        if t
-00017800: 7970 6528 6365 6e74 7261 6c5f 636f 6f72  ype(central_coor
-00017810: 6429 203d 3d20 5175 616e 7469 7479 3a0a  d) == Quantity:.
-00017820: 2020 2020 2020 2020 2020 2020 6365 6e74              cent
-00017830: 7265 203d 2053 6b79 436f 6f72 6428 2a63  re = SkyCoord(*c
-00017840: 656e 7472 616c 5f63 6f6f 7264 2e74 6f28  entral_coord.to(
-00017850: 2264 6567 2229 290a 2020 2020 2020 2020  "deg")).        
-00017860: 656c 6966 2074 7970 6528 6365 6e74 7261  elif type(centra
-00017870: 6c5f 636f 6f72 6429 203d 3d20 536b 7943  l_coord) == SkyC
-00017880: 6f6f 7264 3a0a 2020 2020 2020 2020 2020  oord:.          
-00017890: 2020 6365 6e74 7265 203d 2063 656e 7472    centre = centr
-000178a0: 616c 5f63 6f6f 7264 0a20 2020 2020 2020  al_coord.       
-000178b0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000178c0: 2020 2072 6169 7365 2054 7970 6545 7272     raise TypeErr
-000178d0: 6f72 2822 6365 6e74 7261 6c5f 636f 6f72  or("central_coor
-000178e0: 6420 6d75 7374 2062 6520 6f66 2074 7970  d must be of typ
-000178f0: 6520 5175 616e 7469 7479 206f 7220 536b  e Quantity or Sk
-00017900: 7943 6f6f 7264 2e22 290a 0a20 2020 2020  yCoord.")..     
-00017910: 2020 2023 2049 6e20 6361 7365 2063 6f6d     # In case com
-00017920: 6269 6e65 6420 6765 7473 2070 6173 7365  bined gets passe
-00017930: 6420 6173 2074 6865 204f 6273 4944 2061  d as the ObsID a
-00017940: 7420 616e 7920 706f 696e 740a 2020 2020  t any point.    
-00017950: 2020 2020 6966 206f 6273 5f69 6420 3d3d      if obs_id ==
-00017960: 2022 636f 6d62 696e 6564 223a 0a20 2020   "combined":.   
-00017970: 2020 2020 2020 2020 206f 6273 5f69 6420           obs_id 
-00017980: 3d20 4e6f 6e65 0a0a 2020 2020 2020 2020  = None..        
-00017990: 2320 5468 6520 7365 6172 6368 2072 6164  # The search rad
-000179a0: 6975 7320 776f 6e27 7420 6265 2075 7365  ius won't be use
-000179b0: 6420 6279 2074 6865 2075 7365 722c 206a  d by the user, j
-000179c0: 7573 7420 7065 616b 2066 696e 6469 6e67  ust peak finding
-000179d0: 2073 6f6c 7574 696f 6e73 0a20 2020 2020   solutions.     
-000179e0: 2020 2061 6c6c 6f77 6564 5f72 7479 7065     allowed_rtype
-000179f0: 203d 205b 2272 3235 3030 222c 2022 7235   = ["r2500", "r5
-00017a00: 3030 222c 2022 7232 3030 222c 2022 7265  00", "r200", "re
-00017a10: 6769 6f6e 222c 2022 6375 7374 6f6d 222c  gion", "custom",
-00017a20: 2022 7365 6172 6368 222c 2022 706f 696e   "search", "poin
-00017a30: 7422 5d0a 2020 2020 2020 2020 6966 2074  t"].        if t
-00017a40: 7970 6528 7365 6c66 2920 3d3d 2042 6173  ype(self) == Bas
-00017a50: 6553 6f75 7263 653a 0a20 2020 2020 2020  eSource:.       
-00017a60: 2020 2020 2072 6169 7365 2054 7970 6545       raise TypeE
-00017a70: 7272 6f72 2822 4261 7365 536f 7572 6365  rror("BaseSource
-00017a80: 2063 6c61 7373 2064 6f65 7320 6e6f 7420   class does not 
-00017a90: 6861 7665 2074 6865 206e 6563 6573 7361  have the necessa
-00017aa0: 7279 2069 6e66 6f72 6d61 7469 6f6e 2022  ry information "
-00017ab0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017ac0: 2020 2020 2020 2020 2020 2020 2022 746f               "to
-00017ad0: 2073 656c 6563 7420 6120 736f 7572 6365   select a source
-00017ae0: 2072 6567 696f 6e2e 2229 0a20 2020 2020   region.").     
-00017af0: 2020 2065 6c69 6620 6f62 735f 6964 2069     elif obs_id i
-00017b00: 7320 6e6f 7420 4e6f 6e65 2061 6e64 206f  s not None and o
-00017b10: 6273 5f69 6420 6e6f 7420 696e 2073 656c  bs_id not in sel
-00017b20: 662e 6f62 735f 6964 733a 0a20 2020 2020  f.obs_ids:.     
-00017b30: 2020 2020 2020 2072 6169 7365 204e 6f74         raise Not
-00017b40: 4173 736f 6369 6174 6564 4572 726f 7228  AssociatedError(
-00017b50: 2254 6865 204f 6273 4944 207b 6f7d 2069  "The ObsID {o} i
-00017b60: 7320 6e6f 7420 6173 736f 6369 6174 6564  s not associated
-00017b70: 2077 6974 6820 7b73 7d2e 222e 666f 726d   with {s}.".form
-00017b80: 6174 286f 3d6f 6273 5f69 642c 2073 3d73  at(o=obs_id, s=s
-00017b90: 656c 662e 6e61 6d65 2929 0a20 2020 2020  elf.name)).     
-00017ba0: 2020 2065 6c69 6620 7265 675f 7479 7065     elif reg_type
-00017bb0: 206e 6f74 2069 6e20 616c 6c6f 7765 645f   not in allowed_
-00017bc0: 7274 7970 653a 0a20 2020 2020 2020 2020  rtype:.         
-00017bd0: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-00017be0: 726f 7228 2254 6865 206f 6e6c 7920 616c  ror("The only al
-00017bf0: 6c6f 7765 6420 7265 6769 6f6e 2074 7970  lowed region typ
-00017c00: 6573 2061 7265 207b 7d22 2e66 6f72 6d61  es are {}".forma
-00017c10: 7428 222c 2022 2e6a 6f69 6e28 616c 6c6f  t(", ".join(allo
-00017c20: 7765 645f 7274 7970 6529 2929 0a20 2020  wed_rtype))).   
-00017c30: 2020 2020 2065 6c69 6620 7265 675f 7479       elif reg_ty
-00017c40: 7065 203d 3d20 2272 6567 696f 6e22 2061  pe == "region" a
-00017c50: 6e64 206f 6273 5f69 6420 6973 204e 6f6e  nd obs_id is Non
-00017c60: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-00017c70: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-00017c80: 224f 6273 4944 2063 616e 6e6f 7420 6265  "ObsID cannot be
-00017c90: 204e 6f6e 6520 7768 656e 2067 6574 7469   None when getti
-00017ca0: 6e67 2072 6567 696f 6e20 6669 6c65 2072  ng region file r
-00017cb0: 6567 696f 6e73 2e22 290a 2020 2020 2020  egions.").      
-00017cc0: 2020 656c 6966 2072 6567 5f74 7970 6520    elif reg_type 
-00017cd0: 3d3d 2022 7265 6769 6f6e 2220 616e 6420  == "region" and 
-00017ce0: 6f62 735f 6964 2069 7320 6e6f 7420 4e6f  obs_id is not No
-00017cf0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00017d00: 7372 635f 7265 6720 3d20 7365 6c66 2e5f  src_reg = self._
-00017d10: 7265 6769 6f6e 735b 6f62 735f 6964 5d0a  regions[obs_id].
-00017d20: 2020 2020 2020 2020 656c 6966 2072 6567          elif reg
-00017d30: 5f74 7970 6520 696e 205b 2272 3235 3030  _type in ["r2500
-00017d40: 222c 2022 7235 3030 222c 2022 7232 3030  ", "r500", "r200
-00017d50: 225d 2061 6e64 2072 6567 5f74 7970 6520  "] and reg_type 
-00017d60: 6e6f 7420 696e 2073 656c 662e 5f72 6164  not in self._rad
-00017d70: 6969 3a0a 2020 2020 2020 2020 2020 2020  ii:.            
-00017d80: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-00017d90: 2822 5468 6572 6520 6973 206e 6f20 7b72  ("There is no {r
-00017da0: 7d20 6173 736f 6369 6174 6564 2077 6974  } associated wit
-00017db0: 6820 7b73 7d22 2e66 6f72 6d61 7428 723d  h {s}".format(r=
-00017dc0: 7265 675f 7479 7065 2c20 733d 7365 6c66  reg_type, s=self
-00017dd0: 2e6e 616d 6529 290a 2020 2020 2020 2020  .name)).        
-00017de0: 656c 6966 2072 6567 5f74 7970 6520 213d  elif reg_type !=
-00017df0: 2022 7265 6769 6f6e 2220 616e 6420 7265   "region" and re
-00017e00: 675f 7479 7065 2069 6e20 7365 6c66 2e5f  g_type in self._
-00017e10: 7261 6469 693a 0a20 2020 2020 2020 2020  radii:.         
-00017e20: 2020 2023 2057 6520 6b6e 6f77 2066 6f72     # We know for
-00017e30: 2063 6572 7461 696e 2074 6861 7420 7468   certain that th
-00017e40: 6520 7261 6469 7573 2077 696c 6c20 6265  e radius will be
-00017e50: 2069 6e20 6465 6772 6565 732c 2062 7574   in degrees, but
-00017e60: 2069 7420 6861 7320 746f 2062 6520 636f   it has to be co
-00017e70: 6e76 6572 7465 6420 746f 2064 6567 7265  nverted to degre
-00017e80: 6573 0a20 2020 2020 2020 2020 2020 2023  es.            #
-00017e90: 2020 6265 666f 7265 2062 6569 6e67 2073    before being s
-00017ea0: 746f 7265 6420 696e 2074 6865 2072 6164  tored in the rad
-00017eb0: 6969 2061 7474 7269 6275 7465 0a20 2020  ii attribute.   
-00017ec0: 2020 2020 2020 2020 2072 6164 6975 7320           radius 
-00017ed0: 3d20 7365 6c66 2e5f 7261 6469 695b 7265  = self._radii[re
-00017ee0: 675f 7479 7065 5d0a 2020 2020 2020 2020  g_type].        
-00017ef0: 2020 2020 7372 635f 7265 6720 3d20 4369      src_reg = Ci
-00017f00: 7263 6c65 536b 7952 6567 696f 6e28 6365  rcleSkyRegion(ce
-00017f10: 6e74 7265 2c20 7261 6469 7573 2e74 6f28  ntre, radius.to(
-00017f20: 2764 6567 2729 290a 2020 2020 2020 2020  'deg')).        
-00017f30: 656c 6966 2072 6567 5f74 7970 6520 213d  elif reg_type !=
-00017f40: 2022 7265 6769 6f6e 2220 616e 6420 7265   "region" and re
-00017f50: 675f 7479 7065 206e 6f74 2069 6e20 7365  g_type not in se
-00017f60: 6c66 2e5f 7261 6469 693a 0a20 2020 2020  lf._radii:.     
-00017f70: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-00017f80: 7565 4572 726f 7228 227b 7d20 6973 2061  ueError("{} is a
-00017f90: 2076 616c 6964 2072 6567 696f 6e20 7479   valid region ty
-00017fa0: 7065 2c20 6275 7420 6973 206e 6f74 2061  pe, but is not a
-00017fb0: 7373 6f63 6961 7465 6420 7769 7468 2074  ssociated with t
-00017fc0: 6869 7320 220a 2020 2020 2020 2020 2020  his ".          
-00017fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017fe0: 2020 2022 736f 7572 6365 2e22 2e66 6f72     "source.".for
-00017ff0: 6d61 7428 7265 675f 7479 7065 2929 0a20  mat(reg_type)). 
-00018000: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00018010: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
-00018020: 616c 7565 4572 726f 7228 224f 4820 4e4f  alueError("OH NO
-00018030: 2229 0a0a 2020 2020 2020 2020 2320 4865  ")..        # He
-00018040: 7265 2069 7320 7768 6572 6520 7765 2069  re is where we i
-00018050: 6e69 7469 616c 6973 6520 7468 6520 6261  nitialise the ba
-00018060: 636b 6772 6f75 6e64 2072 6567 696f 6e73  ckground regions
-00018070: 2c20 6669 7273 7420 696e 2070 6978 656c  , first in pixel
-00018080: 2063 6f6f 7264 732c 2074 6865 6e20 636f   coords, then co
-00018090: 6e76 6572 7469 6e67 2074 6f20 7261 2d64  nverting to ra-d
-000180a0: 6563 2e0a 2020 2020 2020 2020 2320 544f  ec..        # TO
-000180b0: 444f 2056 6572 6966 7920 7468 6174 206a  DO Verify that j
-000180c0: 7573 7420 7573 696e 6720 7468 6520 6669  ust using the fi
-000180d0: 7273 7420 696d 6167 6520 6973 206f 6b61  rst image is oka
-000180e0: 790a 2020 2020 2020 2020 696d 203d 2073  y.        im = s
-000180f0: 656c 662e 6765 745f 7072 6f64 7563 7473  elf.get_products
-00018100: 2822 696d 6167 6522 295b 305d 0a20 2020  ("image")[0].   
-00018110: 2020 2020 2073 7263 5f70 6978 5f72 6567       src_pix_reg
-00018120: 203d 2073 7263 5f72 6567 2e74 6f5f 7069   = src_reg.to_pi
-00018130: 7865 6c28 696d 2e72 6164 6563 5f77 6373  xel(im.radec_wcs
-00018140: 290a 2020 2020 2020 2020 2320 544f 444f  ).        # TODO
-00018150: 2054 7279 2061 6e64 2072 656d 656d 6265   Try and remembe
-00018160: 7220 7768 7920 4920 6861 6420 746f 2063  r why I had to c
-00018170: 6f6e 7665 7274 2074 6f20 7069 7865 6c20  onvert to pixel 
-00018180: 7265 6769 6f6e 7320 746f 206d 616b 6520  regions to make 
-00018190: 6974 2077 6f72 6b0a 2020 2020 2020 2020  it work.        
-000181a0: 6966 2069 7369 6e73 7461 6e63 6528 7372  if isinstance(sr
-000181b0: 635f 7265 672c 2045 6c6c 6970 7365 536b  c_reg, EllipseSk
-000181c0: 7952 6567 696f 6e29 3a0a 2020 2020 2020  yRegion):.      
-000181d0: 2020 2020 2020 2320 4865 7265 2077 6520        # Here we 
-000181e0: 6d75 6c74 6970 6c79 2074 6865 2069 6e6e  multiply the inn
-000181f0: 6572 2077 6964 7468 2f68 6569 6768 7420  er width/height 
-00018200: 6279 2031 2e30 3520 2874 6f20 6a75 7374  by 1.05 (to just
-00018210: 2073 6c69 6768 746c 7920 636c 6561 7220   slightly clear 
-00018220: 7468 6520 736f 7572 6365 2072 6567 696f  the source regio
-00018230: 6e29 2c0a 2020 2020 2020 2020 2020 2020  n),.            
-00018240: 2320 2061 6e64 2074 6865 206f 7574 6572  #  and the outer
-00018250: 2077 6964 7468 2f68 6569 6768 7420 6279   width/height by
-00018260: 2031 2e35 2028 7374 616e 6461 7264 2066   1.5 (standard f
-00018270: 6f72 2058 4353 2920 2d20 6465 6661 756c  or XCS) - defaul
-00018280: 7420 7661 6c75 6573 0a20 2020 2020 2020  t values.       
-00018290: 2020 2020 2023 2049 6465 616c 6c79 2074       # Ideally t
-000182a0: 6869 7320 776f 756c 6420 6265 2061 6e20  his would be an 
-000182b0: 616e 6e75 6c75 7320 7265 6769 6f6e 2c20  annulus region, 
-000182c0: 6275 7420 7468 6579 2061 7265 2062 7567  but they are bug
-000182d0: 6765 6420 696e 2072 6567 696f 6e73 2076  ged in regions v
-000182e0: 302e 342c 2073 6f20 7765 206d 7573 7420  0.4, so we must 
-000182f0: 626f 6467 650a 2020 2020 2020 2020 2020  bodge.          
-00018300: 2020 696e 5f72 6567 203d 2045 6c6c 6970    in_reg = Ellip
-00018310: 7365 5069 7865 6c52 6567 696f 6e28 7372  sePixelRegion(sr
-00018320: 635f 7069 785f 7265 672e 6365 6e74 6572  c_pix_reg.center
-00018330: 2c20 7372 635f 7069 785f 7265 672e 7769  , src_pix_reg.wi
-00018340: 6474 6820 2a20 7365 6c66 2e5f 6261 636b  dth * self._back
-00018350: 5f69 6e6e 5f66 6163 746f 722c 0a20 2020  _inn_factor,.   
-00018360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018380: 2020 2020 2073 7263 5f70 6978 5f72 6567       src_pix_reg
-00018390: 2e68 6569 6768 7420 2a20 7365 6c66 2e5f  .height * self._
-000183a0: 6261 636b 5f69 6e6e 5f66 6163 746f 722c  back_inn_factor,
-000183b0: 2073 7263 5f70 6978 5f72 6567 2e61 6e67   src_pix_reg.ang
-000183c0: 6c65 290a 2020 2020 2020 2020 2020 2020  le).            
-000183d0: 6f75 745f 7265 6720 3d20 456c 6c69 7073  out_reg = Ellips
-000183e0: 6550 6978 656c 5265 6769 6f6e 2873 7263  ePixelRegion(src
-000183f0: 5f70 6978 5f72 6567 2e63 656e 7465 722c  _pix_reg.center,
-00018400: 2073 7263 5f70 6978 5f72 6567 2e77 6964   src_pix_reg.wid
-00018410: 7468 202a 2073 656c 662e 5f62 6163 6b5f  th * self._back_
-00018420: 6f75 745f 6661 6374 6f72 2c0a 2020 2020  out_factor,.    
-00018430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018450: 2020 2020 2073 7263 5f70 6978 5f72 6567       src_pix_reg
-00018460: 2e68 6569 6768 7420 2a20 7365 6c66 2e5f  .height * self._
-00018470: 6261 636b 5f6f 7574 5f66 6163 746f 722c  back_out_factor,
-00018480: 2073 7263 5f70 6978 5f72 6567 2e61 6e67   src_pix_reg.ang
-00018490: 6c65 290a 2020 2020 2020 2020 2020 2020  le).            
-000184a0: 6263 6b5f 7265 6720 3d20 6f75 745f 7265  bck_reg = out_re
-000184b0: 672e 7379 6d6d 6574 7269 635f 6469 6666  g.symmetric_diff
-000184c0: 6572 656e 6365 2869 6e5f 7265 6729 0a20  erence(in_reg). 
-000184d0: 2020 2020 2020 2065 6c69 6620 6973 696e         elif isin
-000184e0: 7374 616e 6365 2873 7263 5f72 6567 2c20  stance(src_reg, 
-000184f0: 4369 7263 6c65 536b 7952 6567 696f 6e29  CircleSkyRegion)
-00018500: 3a0a 2020 2020 2020 2020 2020 2020 696e  :.            in
-00018510: 5f72 6567 203d 2043 6972 636c 6550 6978  _reg = CirclePix
-00018520: 656c 5265 6769 6f6e 2873 7263 5f70 6978  elRegion(src_pix
-00018530: 5f72 6567 2e63 656e 7465 722c 2073 7263  _reg.center, src
-00018540: 5f70 6978 5f72 6567 2e72 6164 6975 7320  _pix_reg.radius 
-00018550: 2a20 7365 6c66 2e5f 6261 636b 5f69 6e6e  * self._back_inn
-00018560: 5f66 6163 746f 7229 0a20 2020 2020 2020  _factor).       
-00018570: 2020 2020 206f 7574 5f72 6567 203d 2043       out_reg = C
-00018580: 6972 636c 6550 6978 656c 5265 6769 6f6e  irclePixelRegion
-00018590: 2873 7263 5f70 6978 5f72 6567 2e63 656e  (src_pix_reg.cen
-000185a0: 7465 722c 2073 7263 5f70 6978 5f72 6567  ter, src_pix_reg
-000185b0: 2e72 6164 6975 7320 2a20 7365 6c66 2e5f  .radius * self._
-000185c0: 6261 636b 5f6f 7574 5f66 6163 746f 7229  back_out_factor)
-000185d0: 0a20 2020 2020 2020 2020 2020 2062 636b  .            bck
-000185e0: 5f72 6567 203d 206f 7574 5f72 6567 2e73  _reg = out_reg.s
-000185f0: 796d 6d65 7472 6963 5f64 6966 6665 7265  ymmetric_differe
-00018600: 6e63 6528 696e 5f72 6567 290a 0a20 2020  nce(in_reg)..   
-00018610: 2020 2020 2062 636b 5f72 6567 203d 2062       bck_reg = b
-00018620: 636b 5f72 6567 2e74 6f5f 736b 7928 696d  ck_reg.to_sky(im
-00018630: 2e72 6164 6563 5f77 6373 290a 0a20 2020  .radec_wcs)..   
-00018640: 2020 2020 2072 6574 7572 6e20 7372 635f       return src_
-00018650: 7265 672c 2062 636b 5f72 6567 0a0a 2020  reg, bck_reg..  
-00018660: 2020 6465 6620 7769 7468 696e 5f72 6567    def within_reg
-00018670: 696f 6e28 7365 6c66 2c20 7265 6769 6f6e  ion(self, region
-00018680: 3a20 536b 7952 6567 696f 6e29 202d 3e20  : SkyRegion) -> 
-00018690: 4c69 7374 5b53 6b79 5265 6769 6f6e 5d3a  List[SkyRegion]:
-000186a0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-000186b0: 2020 2020 2054 6869 7320 6d65 7468 6f64       This method
-000186c0: 2066 696e 6473 2069 6e74 6572 6c6f 7065   finds interlope
-000186d0: 7220 736f 7572 6365 7320 7468 6174 206c  r sources that l
-000186e0: 6965 2077 6974 6869 6e20 7468 6520 7573  ie within the us
-000186f0: 6572 2073 7570 706c 6965 6420 7265 6769  er supplied regi
-00018700: 6f6e 2e0a 0a20 2020 2020 2020 203a 7061  on...        :pa
-00018710: 7261 6d20 536b 7952 6567 696f 6e20 7265  ram SkyRegion re
-00018720: 6769 6f6e 3a20 5468 6520 7265 6769 6f6e  gion: The region
-00018730: 2069 6e20 7768 6963 6820 7765 2077 6973   in which we wis
-00018740: 6820 746f 2073 6561 7263 6820 666f 7220  h to search for 
-00018750: 696e 7465 726c 6f70 6572 2073 6f75 7263  interloper sourc
-00018760: 6573 2028 666f 7220 696e 7374 616e 6365  es (for instance
-00018770: 0a20 2020 2020 2020 2020 2020 2061 2073  .            a s
-00018780: 6f75 7263 6520 7265 6769 6f6e 206f 7220  ource region or 
-00018790: 6261 636b 6772 6f75 6e64 2072 6567 696f  background regio
-000187a0: 6e29 2e0a 2020 2020 2020 2020 3a72 6574  n)..        :ret
-000187b0: 7572 6e3a 2041 206c 6973 7420 6f66 2072  urn: A list of r
-000187c0: 6567 696f 6e73 2074 6861 7420 6c69 6520  egions that lie 
-000187d0: 7769 7468 696e 2074 6865 2075 7365 7220  within the user 
-000187e0: 7375 7070 6c69 6564 2072 6567 696f 6e2e  supplied region.
-000187f0: 0a20 2020 2020 2020 203a 7274 7970 653a  .        :rtype:
-00018800: 204c 6973 745b 536b 7952 6567 696f 6e5d   List[SkyRegion]
-00018810: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00018820: 2020 2020 2069 6d20 3d20 7365 6c66 2e67       im = self.g
-00018830: 6574 5f70 726f 6475 6374 7328 2269 6d61  et_products("ima
-00018840: 6765 2229 5b30 5d0a 0a20 2020 2020 2020  ge")[0]..       
-00018850: 2063 726f 7373 6f76 6572 203d 206e 702e   crossover = np.
-00018860: 6172 7261 7928 5b72 6567 696f 6e2e 696e  array([region.in
-00018870: 7465 7273 6563 7469 6f6e 2872 292e 746f  tersection(r).to
-00018880: 5f70 6978 656c 2869 6d2e 7261 6465 635f  _pixel(im.radec_
-00018890: 7763 7329 2e74 6f5f 6d61 736b 2829 2e64  wcs).to_mask().d
-000188a0: 6174 612e 7375 6d28 2920 213d 2030 0a20  ata.sum() != 0. 
-000188b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000188c0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-000188d0: 2072 2069 6e20 7365 6c66 2e5f 696e 7465   r in self._inte
-000188e0: 726c 6f70 6572 5f72 6567 696f 6e73 5d29  rloper_regions])
-000188f0: 0a20 2020 2020 2020 2072 6567 5f77 6974  .        reg_wit
-00018900: 6869 6e20 3d20 6e70 2e61 7272 6179 2873  hin = np.array(s
-00018910: 656c 662e 5f69 6e74 6572 6c6f 7065 725f  elf._interloper_
-00018920: 7265 6769 6f6e 7329 5b63 726f 7373 6f76  regions)[crossov
-00018930: 6572 5d0a 0a20 2020 2020 2020 2072 6574  er]..        ret
-00018940: 7572 6e20 7265 675f 7769 7468 696e 0a0a  urn reg_within..
-00018950: 2020 2020 6465 6620 6765 745f 696e 7465      def get_inte
-00018960: 726c 6f70 6572 5f72 6567 696f 6e73 2873  rloper_regions(s
-00018970: 656c 662c 2066 6c61 7474 656e 6564 3a20  elf, flattened: 
-00018980: 626f 6f6c 203d 2046 616c 7365 2920 2d3e  bool = False) ->
-00018990: 2055 6e69 6f6e 5b4c 6973 742c 2044 6963   Union[List, Dic
-000189a0: 745d 3a0a 2020 2020 2020 2020 2222 220a  t]:.        """.
-000189b0: 2020 2020 2020 2020 5468 6973 2067 6574          This get
-000189c0: 206d 6574 686f 6420 7072 6f76 6964 6573   method provides
-000189d0: 2061 2077 6179 2074 6f20 6163 6365 7373   a way to access
-000189e0: 2074 6865 2072 6567 696f 6e73 2074 6861   the regions tha
-000189f0: 7420 6861 7665 2062 6565 6e20 6465 7369  t have been desi
-00018a00: 676e 6174 6564 2061 7320 696e 7465 726c  gnated as interl
-00018a10: 6f70 6572 7320 2869 2e65 2e0a 2020 2020  opers (i.e..    
-00018a20: 2020 2020 6e6f 7420 7468 6520 736f 7572      not the sour
-00018a30: 6365 2072 6567 696f 6e20 7468 6174 2061  ce region that a
-00018a40: 2070 6172 7469 6375 6c61 7220 536f 7572   particular Sour
-00018a50: 6365 2068 6173 2062 6565 6e20 6465 7369  ce has been desi
-00018a60: 676e 6174 6564 2074 6f20 696e 7665 7374  gnated to invest
-00018a70: 6967 6174 6529 2066 6f72 2061 6c6c 206f  igate) for all o
-00018a80: 6273 6572 7661 7469 6f6e 732e 0a20 2020  bservations..   
-00018a90: 2020 2020 2054 6865 7920 6361 6e20 6569       They can ei
-00018aa0: 7468 6572 2062 6520 7265 7472 6965 7665  ther be retrieve
-00018ab0: 6420 696e 2061 2064 6963 7469 6f6e 6172  d in a dictionar
-00018ac0: 7920 7769 7468 204f 6273 4944 7320 6173  y with ObsIDs as
-00018ad0: 2074 6865 206b 6579 732c 206f 7220 6120   the keys, or a 
-00018ae0: 666c 6174 7465 6e65 6420 7369 6e67 6c65  flattened single
-00018af0: 206c 6973 7420 7769 7468 206e 6f0a 2020   list with no.  
-00018b00: 2020 2020 2020 4f62 7349 4420 636f 6e74        ObsID cont
-00018b10: 6578 742e 0a0a 2020 2020 2020 2020 3a70  ext...        :p
-00018b20: 6172 616d 2062 6f6f 6c20 666c 6174 7465  aram bool flatte
-00018b30: 6e65 643a 2049 6620 7472 7565 2074 6865  ned: If true the
-00018b40: 6e20 7468 6520 7265 6769 6f6e 7320 6172  n the regions ar
-00018b50: 6520 7265 7475 726e 6564 2061 7320 6120  e returned as a 
-00018b60: 7369 6e67 6c65 206c 6973 7420 6f66 2072  single list of r
-00018b70: 6567 696f 6e20 6f62 6a65 6374 732e 204f  egion objects. O
-00018b80: 7468 6572 7769 7365 0a20 2020 2020 2020  therwise.       
-00018b90: 2020 2020 2074 6865 7920 6172 6520 7265       they are re
-00018ba0: 7475 726e 6564 2061 7320 6120 6469 6374  turned as a dict
-00018bb0: 696f 6e61 7279 2077 6974 6820 4f62 7349  ionary with ObsI
-00018bc0: 4473 2061 7320 6b65 7973 2e20 4465 6661  Ds as keys. Defa
-00018bd0: 756c 7420 6973 2046 616c 7365 2e0a 2020  ult is False..  
-00018be0: 2020 2020 2020 3a72 6574 7572 6e3a 2045        :return: E
-00018bf0: 6974 6865 7220 6120 6c69 7374 206f 6620  ither a list of 
-00018c00: 7265 6769 6f6e 206f 626a 6563 7473 2c20  region objects, 
-00018c10: 6f72 2061 2064 6963 7469 6f6e 6172 7920  or a dictionary 
-00018c20: 7769 7468 204f 6273 4944 7320 6173 206b  with ObsIDs as k
-00018c30: 6579 732e 0a20 2020 2020 2020 203a 7274  eys..        :rt
-00018c40: 7970 653a 2055 6e69 6f6e 5b4c 6973 742c  ype: Union[List,
-00018c50: 4469 6374 5d0a 2020 2020 2020 2020 2222  Dict].        ""
-00018c60: 220a 2020 2020 2020 2020 6966 2074 7970  ".        if typ
-00018c70: 6528 7365 6c66 2920 3d3d 2042 6173 6553  e(self) == BaseS
-00018c80: 6f75 7263 653a 0a20 2020 2020 2020 2020  ource:.         
-00018c90: 2020 2072 6169 7365 2054 7970 6545 7272     raise TypeErr
-00018ca0: 6f72 2822 4261 7365 536f 7572 6365 206f  or("BaseSource o
-00018cb0: 626a 6563 7473 2064 6f6e 2774 2068 6176  bjects don't hav
-00018cc0: 6520 656e 6f75 6768 2069 6e66 6f72 6d61  e enough informa
-00018cd0: 7469 6f6e 2074 6f20 6b6e 6f77 2077 6869  tion to know whi
-00018ce0: 6368 2073 6f75 7263 6573 2022 0a20 2020  ch sources ".   
-00018cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018d00: 2020 2020 2020 2020 2022 6172 6520 696e           "are in
-00018d10: 7465 726c 6f70 6572 732e 2229 0a0a 2020  terlopers.")..  
-00018d20: 2020 2020 2020 2320 4966 2066 6c61 7474        # If flatt
-00018d30: 656e 6564 2074 6865 6e20 6120 6c69 7374  ened then a list
-00018d40: 2069 7320 7265 7475 726e 6564 2072 6174   is returned rat
-00018d50: 6865 7220 7468 616e 2074 6865 206f 7269  her than the ori
-00018d60: 6769 6e61 6c20 6469 6374 696f 6e61 7279  ginal dictionary
-00018d70: 2077 6974 680a 2020 2020 2020 2020 6966   with.        if
-00018d80: 206e 6f74 2066 6c61 7474 656e 6564 3a0a   not flattened:.
-00018d90: 2020 2020 2020 2020 2020 2020 7265 745f              ret_
-00018da0: 7265 6720 3d20 7365 6c66 2e5f 6f74 6865  reg = self._othe
-00018db0: 725f 7265 6769 6f6e 730a 2020 2020 2020  r_regions.      
-00018dc0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00018dd0: 2020 2020 2320 4974 6572 6174 6520 7468      # Iterate th
-00018de0: 726f 7567 6820 7468 6520 4f62 7349 4473  rough the ObsIDs
-00018df0: 2069 6e20 7468 6520 6469 6374 696f 6e61   in the dictiona
-00018e00: 7279 2061 6e64 2061 6464 2074 6865 2072  ry and add the r
-00018e10: 6573 756c 7469 6e67 206c 6973 7473 2074  esulting lists t
-00018e20: 6f67 6574 6865 720a 2020 2020 2020 2020  ogether.        
-00018e30: 2020 2020 7265 745f 7265 6720 3d20 5b5d      ret_reg = []
-00018e40: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00018e50: 206f 2069 6e20 7365 6c66 2e5f 6f74 6865   o in self._othe
-00018e60: 725f 7265 6769 6f6e 733a 0a20 2020 2020  r_regions:.     
-00018e70: 2020 2020 2020 2020 2020 2072 6574 5f72             ret_r
-00018e80: 6567 202b 3d20 7365 6c66 2e5f 6f74 6865  eg += self._othe
-00018e90: 725f 7265 6769 6f6e 735b 6f5d 0a0a 2020  r_regions[o]..  
-00018ea0: 2020 2020 2020 7265 7475 726e 2072 6574        return ret
-00018eb0: 5f72 6567 0a0a 2020 2020 6465 6620 6765  _reg..    def ge
-00018ec0: 745f 736f 7572 6365 5f6d 6173 6b28 7365  t_source_mask(se
-00018ed0: 6c66 2c20 7265 675f 7479 7065 3a20 7374  lf, reg_type: st
-00018ee0: 722c 206f 6273 5f69 643a 2073 7472 203d  r, obs_id: str =
-00018ef0: 204e 6f6e 652c 2063 656e 7472 616c 5f63   None, central_c
-00018f00: 6f6f 7264 3a20 5175 616e 7469 7479 203d  oord: Quantity =
-00018f10: 204e 6f6e 6529 205c 0a20 2020 2020 2020   None) \.       
-00018f20: 2020 2020 202d 3e20 5475 706c 655b 6e70       -> Tuple[np
-00018f30: 2e6e 6461 7272 6179 2c20 6e70 2e6e 6461  .ndarray, np.nda
-00018f40: 7272 6179 5d3a 0a20 2020 2020 2020 2022  rray]:.        "
-00018f50: 2222 0a20 2020 2020 2020 204d 6574 686f  "".        Metho
-00018f60: 6420 746f 2072 6574 7269 6576 6520 736f  d to retrieve so
-00018f70: 7572 6365 2061 6e64 2062 6163 6b67 726f  urce and backgro
-00018f80: 756e 6420 6d61 736b 7320 666f 7220 7468  und masks for th
-00018f90: 6520 6769 7665 6e20 7265 6769 6f6e 2074  e given region t
-00018fa0: 7970 652e 0a0a 2020 2020 2020 2020 3a70  ype...        :p
-00018fb0: 6172 616d 2073 7472 2072 6567 5f74 7970  aram str reg_typ
-00018fc0: 653a 2054 6865 2074 7970 6520 6f66 2072  e: The type of r
-00018fd0: 6567 696f 6e20 666f 7220 7768 6963 6820  egion for which 
-00018fe0: 746f 2072 6574 7269 6576 6520 7468 6520  to retrieve the 
-00018ff0: 6d61 736b 2e0a 2020 2020 2020 2020 3a70  mask..        :p
-00019000: 6172 616d 2073 7472 206f 6273 5f69 643a  aram str obs_id:
-00019010: 2054 6865 204f 6273 4944 2074 6861 7420   The ObsID that 
-00019020: 7468 6520 6d61 736b 2069 7320 6173 736f  the mask is asso
-00019030: 6369 6174 6564 2077 6974 6820 2869 6620  ciated with (if 
-00019040: 6170 7072 6f70 7269 6174 6529 2e0a 2020  appropriate)..  
-00019050: 2020 2020 2020 3a70 6172 616d 2051 7561        :param Qua
-00019060: 6e74 6974 7920 6365 6e74 7261 6c5f 636f  ntity central_co
-00019070: 6f72 643a 2054 6865 2063 656e 7472 616c  ord: The central
-00019080: 2063 6f6f 7264 696e 6174 6520 6f66 2074   coordinate of t
-00019090: 6865 2072 6567 696f 6e2e 0a20 2020 2020  he region..     
-000190a0: 2020 203a 7265 7475 726e 3a20 5468 6520     :return: The 
-000190b0: 736f 7572 6365 2061 6e64 2062 6163 6b67  source and backg
-000190c0: 726f 756e 6420 6d61 736b 7320 666f 7220  round masks for 
-000190d0: 7468 6520 7265 7175 6573 7465 6420 4f62  the requested Ob
-000190e0: 7349 4420 286f 7220 7468 6520 636f 6d62  sID (or the comb
-000190f0: 696e 6564 2069 6d61 6765 2069 6620 6e6f  ined image if no
-00019100: 204f 6273 4944 292e 0a20 2020 2020 2020   ObsID)..       
-00019110: 203a 7274 7970 653a 2054 7570 6c65 5b6e   :rtype: Tuple[n
-00019120: 702e 6e64 6172 7261 792c 206e 702e 6e64  p.ndarray, np.nd
-00019130: 6172 7261 795d 0a20 2020 2020 2020 2022  array].        "
-00019140: 2222 0a20 2020 2020 2020 2069 6620 6f62  "".        if ob
-00019150: 735f 6964 203d 3d20 2263 6f6d 6269 6e65  s_id == "combine
-00019160: 6422 3a0a 2020 2020 2020 2020 2020 2020  d":.            
-00019170: 6f62 735f 6964 203d 204e 6f6e 650a 0a20  obs_id = None.. 
-00019180: 2020 2020 2020 2069 6620 6365 6e74 7261         if centra
-00019190: 6c5f 636f 6f72 6420 6973 204e 6f6e 653a  l_coord is None:
-000191a0: 0a20 2020 2020 2020 2020 2020 2063 656e  .            cen
-000191b0: 7472 616c 5f63 6f6f 7264 203d 2073 656c  tral_coord = sel
-000191c0: 662e 5f64 6566 6175 6c74 5f63 6f6f 7264  f._default_coord
-000191d0: 0a0a 2020 2020 2020 2020 2320 446f 6e27  ..        # Don'
-000191e0: 7420 6e65 6564 2074 6f20 646f 2061 2062  t need to do a b
-000191f0: 756e 6368 206f 6620 6368 6563 6b73 2c20  unch of checks, 
-00019200: 6265 6361 7573 6520 7468 6520 6d65 7468  because the meth
-00019210: 6f64 2049 2063 616c 6c20 746f 206d 616b  od I call to mak
-00019220: 6520 7468 650a 2020 2020 2020 2020 2320  e the.        # 
-00019230: 206d 6173 6b20 646f 6573 2061 6c6c 2074   mask does all t
-00019240: 6865 2063 6865 636b 7320 616e 7977 6179  he checks anyway
-00019250: 0a20 2020 2020 2020 2073 7263 5f72 6567  .        src_reg
-00019260: 2c20 6263 6b5f 7265 6720 3d20 7365 6c66  , bck_reg = self
-00019270: 2e73 6f75 7263 655f 6261 636b 5f72 6567  .source_back_reg
-00019280: 696f 6e73 2872 6567 5f74 7970 652c 206f  ions(reg_type, o
-00019290: 6273 5f69 642c 2063 656e 7472 616c 5f63  bs_id, central_c
-000192a0: 6f6f 7264 290a 0a20 2020 2020 2020 2023  oord)..        #
-000192b0: 2049 2061 7373 756d 6520 7468 6174 2069   I assume that i
-000192c0: 6620 6e6f 204f 6273 4944 2069 7320 7375  f no ObsID is su
-000192d0: 7070 6c69 6564 2c20 7468 656e 2074 6865  pplied, then the
-000192e0: 2075 7365 7220 7769 7368 6573 2074 6f20   user wishes to 
-000192f0: 6861 7665 2061 206d 6173 6b20 666f 7220  have a mask for 
-00019300: 7468 6520 636f 6d62 696e 6564 2064 6174  the combined dat
-00019310: 610a 2020 2020 2020 2020 6966 206f 6273  a.        if obs
-00019320: 5f69 6420 6973 204e 6f6e 653a 0a20 2020  _id is None:.   
-00019330: 2020 2020 2020 2020 2063 6f6d 625f 696d           comb_im
-00019340: 6167 6573 203d 2073 656c 662e 6765 745f  ages = self.get_
-00019350: 7072 6f64 7563 7473 2822 636f 6d62 696e  products("combin
-00019360: 6564 5f69 6d61 6765 2229 0a20 2020 2020  ed_image").     
-00019370: 2020 2020 2020 2069 6620 6c65 6e28 636f         if len(co
-00019380: 6d62 5f69 6d61 6765 7329 2021 3d20 303a  mb_images) != 0:
-00019390: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000193a0: 206d 6173 6b5f 696d 6167 6520 3d20 636f   mask_image = co
-000193b0: 6d62 5f69 6d61 6765 735b 305d 0a20 2020  mb_images[0].   
-000193c0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-000193d0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-000193e0: 6169 7365 204e 6f50 726f 6475 6374 4176  aise NoProductAv
-000193f0: 6169 6c61 626c 6545 7272 6f72 2822 5468  ailableError("Th
-00019400: 6572 6520 6172 6520 6e6f 2063 6f6d 6269  ere are no combi
-00019410: 6e65 6420 7072 6f64 7563 7473 2061 7661  ned products ava
-00019420: 696c 6162 6c65 2074 6f20 6765 6e65 7261  ilable to genera
-00019430: 7465 2061 206d 6173 6b20 666f 722e 2229  te a mask for.")
-00019440: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00019450: 2020 2020 2020 2020 2020 2023 204a 7573             # Jus
-00019460: 7420 6772 6162 2074 6865 2066 6972 7374  t grab the first
-00019470: 2069 6e73 7472 756d 656e 7420 7468 6174   instrument that
-00019480: 2063 6f6d 6573 206f 7574 2074 6865 2067   comes out the g
-00019490: 6574 206d 6574 686f 642c 2074 6865 206d  et method, the m
-000194a0: 6173 6b73 2073 686f 756c 6420 6265 2074  asks should be t
-000194b0: 6865 2073 616d 652e 0a20 2020 2020 2020  he same..       
-000194c0: 2020 2020 206d 6173 6b5f 696d 6167 6520       mask_image 
-000194d0: 3d20 7365 6c66 2e67 6574 5f70 726f 6475  = self.get_produ
-000194e0: 6374 7328 2269 6d61 6765 222c 206f 6273  cts("image", obs
-000194f0: 5f69 6429 5b30 5d0a 0a20 2020 2020 2020  _id)[0]..       
-00019500: 206d 6173 6b20 3d20 7372 635f 7265 672e   mask = src_reg.
-00019510: 746f 5f70 6978 656c 286d 6173 6b5f 696d  to_pixel(mask_im
-00019520: 6167 652e 7261 6465 635f 7763 7329 2e74  age.radec_wcs).t
-00019530: 6f5f 6d61 736b 2829 2e74 6f5f 696d 6167  o_mask().to_imag
-00019540: 6528 6d61 736b 5f69 6d61 6765 2e73 6861  e(mask_image.sha
-00019550: 7065 290a 2020 2020 2020 2020 6261 636b  pe).        back
-00019560: 5f6d 6173 6b20 3d20 6263 6b5f 7265 672e  _mask = bck_reg.
-00019570: 746f 5f70 6978 656c 286d 6173 6b5f 696d  to_pixel(mask_im
-00019580: 6167 652e 7261 6465 635f 7763 7329 2e74  age.radec_wcs).t
-00019590: 6f5f 6d61 736b 2829 2e74 6f5f 696d 6167  o_mask().to_imag
-000195a0: 6528 6d61 736b 5f69 6d61 6765 2e73 6861  e(mask_image.sha
-000195b0: 7065 290a 0a20 2020 2020 2020 2023 2049  pe)..        # I
-000195c0: 6620 7468 6520 6d61 736b 7320 6172 6520  f the masks are 
-000195d0: 4e6f 6e65 2c20 7468 656e 2074 6865 7920  None, then they 
-000195e0: 6172 6520 7365 7420 746f 2061 6e20 6172  are set to an ar
-000195f0: 7261 7920 6f66 207a 6572 6f73 0a20 2020  ray of zeros.   
-00019600: 2020 2020 2069 6620 6d61 736b 2069 7320       if mask is 
-00019610: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00019620: 2020 6d61 736b 203d 206e 702e 7a65 726f    mask = np.zero
-00019630: 7328 6d61 736b 5f69 6d61 6765 2e73 6861  s(mask_image.sha
-00019640: 7065 290a 2020 2020 2020 2020 6966 2062  pe).        if b
-00019650: 6163 6b5f 6d61 736b 2069 7320 4e6f 6e65  ack_mask is None
-00019660: 3a0a 2020 2020 2020 2020 2020 2020 6261  :.            ba
-00019670: 636b 5f6d 6173 6b20 3d20 6e70 2e7a 6572  ck_mask = np.zer
-00019680: 6f73 286d 6173 6b5f 696d 6167 652e 7368  os(mask_image.sh
-00019690: 6170 6529 0a0a 2020 2020 2020 2020 7265  ape)..        re
-000196a0: 7475 726e 206d 6173 6b2c 2062 6163 6b5f  turn mask, back_
-000196b0: 6d61 736b 0a0a 2020 2020 6465 6620 5f67  mask..    def _g
-000196c0: 656e 6572 6174 655f 696e 7465 726c 6f70  enerate_interlop
-000196d0: 6572 5f6d 6173 6b28 7365 6c66 2c20 6d61  er_mask(self, ma
-000196e0: 736b 5f69 6d61 6765 3a20 496d 6167 6529  sk_image: Image)
-000196f0: 202d 3e20 6e64 6172 7261 793a 0a20 2020   -> ndarray:.   
-00019700: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00019710: 2049 6e74 6572 6e61 6c20 6d65 7468 6f64   Internal method
-00019720: 2074 6861 7420 6d61 6b65 7320 696e 7465   that makes inte
-00019730: 726c 6f70 6572 206d 6173 6b73 2069 6e20  rloper masks in 
-00019740: 7468 6520 6669 7273 7420 706c 6163 653b  the first place;
-00019750: 2049 2061 6c6c 6f77 2074 6869 7320 6265   I allow this be
-00019760: 6361 7573 6520 696e 7465 726c 6f70 6572  cause interloper
-00019770: 0a20 2020 2020 2020 206d 6173 6b73 2077  .        masks w
-00019780: 696c 6c20 6e65 7665 7220 6368 616e 6765  ill never change
-00019790: 2c20 736f 2063 616e 2062 6520 7361 6665  , so can be safe
-000197a0: 6c79 2067 656e 6572 6174 6564 2061 6e64  ly generated and
-000197b0: 2073 746f 7265 6420 696e 2061 6e20 696e   stored in an in
-000197c0: 6974 206f 6620 6120 736f 7572 6365 2063  it of a source c
-000197d0: 6c61 7373 2e0a 0a20 2020 2020 2020 203a  lass...        :
-000197e0: 7061 7261 6d20 496d 6167 6520 6d61 736b  param Image mask
-000197f0: 5f69 6d61 6765 3a20 5468 6520 696d 6167  _image: The imag
-00019800: 6520 666f 7220 7768 6963 6820 746f 2063  e for which to c
-00019810: 7265 6174 6520 7468 6520 696e 7465 726c  reate the interl
-00019820: 6f70 6572 206d 6173 6b2e 0a20 2020 2020  oper mask..     
-00019830: 2020 203a 7265 7475 726e 3a20 4120 6e75     :return: A nu
-00019840: 6d70 7920 6172 7261 7920 6f66 2030 7320  mpy array of 0s 
-00019850: 616e 6420 3173 2077 6869 6368 2061 6374  and 1s which act
-00019860: 7320 6173 2061 206d 6173 6b20 746f 2072  s as a mask to r
-00019870: 656d 6f76 6520 696e 7465 726c 6f70 6572  emove interloper
-00019880: 2073 6f75 7263 6573 2e0a 2020 2020 2020   sources..      
-00019890: 2020 3a72 7479 7065 3a20 6e64 6172 7261    :rtype: ndarra
-000198a0: 790a 2020 2020 2020 2020 2222 220a 2020  y.        """.  
-000198b0: 2020 2020 2020 6d61 736b 7320 3d20 5b5d        masks = []
-000198c0: 0a20 2020 2020 2020 2066 6f72 2072 2069  .        for r i
-000198d0: 6e20 7365 6c66 2e5f 696e 7465 726c 6f70  n self._interlop
-000198e0: 6572 5f72 6567 696f 6e73 3a0a 2020 2020  er_regions:.    
-000198f0: 2020 2020 2020 2020 6966 2072 2069 7320          if r is 
-00019900: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00019910: 2020 2020 2020 2020 2020 2320 5468 6520            # The 
-00019920: 6365 6e74 7261 6c20 636f 6f72 6469 6e61  central coordina
-00019930: 7465 206f 6620 7468 6520 6375 7272 656e  te of the curren
-00019940: 7420 7265 6769 6f6e 0a20 2020 2020 2020  t region.       
-00019950: 2020 2020 2020 2020 2063 203d 2051 7561           c = Qua
-00019960: 6e74 6974 7928 5b72 2e63 656e 7465 722e  ntity([r.center.
-00019970: 7261 2e76 616c 7565 2c20 722e 6365 6e74  ra.value, r.cent
-00019980: 6572 2e64 6563 2e76 616c 7565 5d2c 2027  er.dec.value], '
-00019990: 6465 6727 290a 2020 2020 2020 2020 2020  deg').          
-000199a0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-000199b0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000199c0: 2043 6865 636b 7320 6966 2074 6865 2063   Checks if the c
-000199d0: 656e 7472 616c 2063 6f6f 7264 696e 6174  entral coordinat
-000199e0: 6520 6361 6e20 6265 2063 6f6e 7665 7274  e can be convert
-000199f0: 6564 2074 6f20 7069 7865 6c73 2066 6f72  ed to pixels for
-00019a00: 2074 6865 206d 6173 6b5f 696d 6167 652c   the mask_image,
-00019a10: 2069 6620 6974 2066 6169 6c73 2074 6865   if it fails the
-00019a20: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
-00019a30: 2020 2020 2020 2320 2069 7473 206c 696b        #  its lik
-00019a40: 656c 7920 6f66 6620 6f66 2074 6865 2069  ely off of the i
-00019a50: 6d61 6765 2c20 6173 2061 2056 616c 7565  mage, as a Value
-00019a60: 4572 726f 7220 7769 6c6c 2062 6520 7468  Error will be th
-00019a70: 726f 776e 2069 6620 6120 7069 7865 6c20  rown if a pixel 
-00019a80: 636f 6f72 6469 6e61 7465 2069 7320 6c65  coordinate is le
-00019a90: 7373 0a20 2020 2020 2020 2020 2020 2020  ss.             
-00019aa0: 2020 2020 2020 2023 2020 7468 616e 207a         #  than z
-00019ab0: 6572 6f2c 206f 7220 6772 6561 7465 7220  ero, or greater 
-00019ac0: 7468 616e 2074 6865 2073 697a 6520 6f66  than the size of
-00019ad0: 2074 6865 2069 6d61 6765 2069 6e20 7468   the image in th
-00019ae0: 6174 2061 7869 730a 2020 2020 2020 2020  at axis.        
-00019af0: 2020 2020 2020 2020 2020 2020 6370 203d              cp =
-00019b00: 206d 6173 6b5f 696d 6167 652e 636f 6f72   mask_image.coor
-00019b10: 645f 636f 6e76 2863 2c20 2770 6978 2729  d_conv(c, 'pix')
-00019b20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019b30: 2020 2020 2070 7220 3d20 722e 746f 5f70       pr = r.to_p
-00019b40: 6978 656c 286d 6173 6b5f 696d 6167 652e  ixel(mask_image.
-00019b50: 7261 6465 635f 7763 7329 0a0a 2020 2020  radec_wcs)..    
-00019b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019b70: 2320 4966 2074 6865 2072 6f74 6174 696f  # If the rotatio
-00019b80: 6e20 616e 676c 6520 6973 207a 6572 6f20  n angle is zero 
-00019b90: 7468 656e 2074 6865 2063 6f6e 7665 7273  then the convers
-00019ba0: 696f 6e20 746f 206d 6173 6b20 6279 2074  ion to mask by t
-00019bb0: 6865 2072 6567 696f 6e73 206d 6f64 756c  he regions modul
-00019bc0: 6520 7769 6c6c 2062 6520 7570 7365 742c  e will be upset,
-00019bd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019be0: 2020 2020 2023 2020 736f 2049 2070 6572       #  so I per
-00019bf0: 7475 7262 2074 6865 2061 6e67 6c65 2062  turb the angle b
-00019c00: 7920 302e 3120 6465 6772 6565 730a 2020  y 0.1 degrees.  
-00019c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019c20: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-00019c30: 7072 2c20 456c 6c69 7073 6550 6978 656c  pr, EllipsePixel
-00019c40: 5265 6769 6f6e 2920 616e 6420 7072 2e61  Region) and pr.a
-00019c50: 6e67 6c65 2e76 616c 7565 203d 3d20 303a  ngle.value == 0:
-00019c60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019c70: 2020 2020 2020 2020 2070 722e 616e 676c           pr.angl
-00019c80: 6520 2b3d 2051 7561 6e74 6974 7928 302e  e += Quantity(0.
-00019c90: 312c 2027 6465 6727 290a 2020 2020 2020  1, 'deg').      
-00019ca0: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
-00019cb0: 736b 732e 6170 7065 6e64 2870 722e 746f  sks.append(pr.to
-00019cc0: 5f6d 6173 6b28 292e 746f 5f69 6d61 6765  _mask().to_image
-00019cd0: 286d 6173 6b5f 696d 6167 652e 7368 6170  (mask_image.shap
-00019ce0: 6529 290a 2020 2020 2020 2020 2020 2020  e)).            
-00019cf0: 2020 2020 6578 6365 7074 2056 616c 7565      except Value
-00019d00: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
-00019d10: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
-00019d20: 0a20 2020 2020 2020 2023 206d 6173 6b73  .        # masks
-00019d30: 203d 205b 7265 672e 746f 5f70 6978 656c   = [reg.to_pixel
-00019d40: 286d 6173 6b5f 696d 6167 652e 7261 6465  (mask_image.rade
-00019d50: 635f 7763 7329 2e74 6f5f 6d61 736b 2829  c_wcs).to_mask()
-00019d60: 2e74 6f5f 696d 6167 6528 6d61 736b 5f69  .to_image(mask_i
-00019d70: 6d61 6765 2e73 6861 7065 290a 2020 2020  mage.shape).    
-00019d80: 2020 2020 2320 2020 2020 2020 2020 2066      #          f
-00019d90: 6f72 2072 6567 2069 6e20 7365 6c66 2e5f  or reg in self._
-00019da0: 696e 7465 726c 6f70 6572 5f72 6567 696f  interloper_regio
-00019db0: 6e73 2069 6620 7265 6720 6973 206e 6f74  ns if reg is not
-00019dc0: 204e 6f6e 655d 0a20 2020 2020 2020 2069   None].        i
-00019dd0: 6e74 6572 6c6f 7065 7273 203d 2073 756d  nterlopers = sum
-00019de0: 285b 6d20 666f 7220 6d20 696e 206d 6173  ([m for m in mas
-00019df0: 6b73 2069 6620 6d20 6973 206e 6f74 204e  ks if m is not N
-00019e00: 6f6e 655d 290a 0a20 2020 2020 2020 206d  one])..        m
-00019e10: 6173 6b20 3d20 6e70 2e6f 6e65 7328 6d61  ask = np.ones(ma
-00019e20: 736b 5f69 6d61 6765 2e73 6861 7065 290a  sk_image.shape).
-00019e30: 2020 2020 2020 2020 6d61 736b 5b69 6e74          mask[int
-00019e40: 6572 6c6f 7065 7273 2021 3d20 305d 203d  erlopers != 0] =
-00019e50: 2030 0a0a 2020 2020 2020 2020 7265 7475   0..        retu
-00019e60: 726e 206d 6173 6b0a 0a20 2020 2064 6566  rn mask..    def
-00019e70: 2067 6574 5f69 6e74 6572 6c6f 7065 725f   get_interloper_
-00019e80: 6d61 736b 2873 656c 662c 206f 6273 5f69  mask(self, obs_i
-00019e90: 643a 2073 7472 203d 204e 6f6e 6529 202d  d: str = None) -
-00019ea0: 3e20 6e64 6172 7261 793a 0a20 2020 2020  > ndarray:.     
-00019eb0: 2020 2022 2222 0a20 2020 2020 2020 2052     """.        R
-00019ec0: 6574 7572 6e73 2061 206d 6173 6b20 666f  eturns a mask fo
-00019ed0: 7220 6120 6769 7665 6e20 4f62 7349 4420  r a given ObsID 
-00019ee0: 286f 7220 636f 6d62 696e 6564 2064 6174  (or combined dat
-00019ef0: 6120 6966 206e 6f20 4f62 7349 4420 6769  a if no ObsID gi
-00019f00: 7665 6e29 2074 6861 7420 7769 6c6c 2072  ven) that will r
-00019f10: 656d 6f76 6520 616e 7920 736f 7572 6365  emove any source
-00019f20: 730a 2020 2020 2020 2020 7468 6174 2068  s.        that h
-00019f30: 6176 6520 6e6f 7420 6265 656e 2069 6465  ave not been ide
-00019f40: 6e74 6966 6965 6420 6173 2074 6865 2073  ntified as the s
-00019f50: 6f75 7263 6520 6f66 2069 6e74 6572 6573  ource of interes
-00019f60: 742e 0a0a 2020 2020 2020 2020 3a70 6172  t...        :par
-00019f70: 616d 2073 7472 206f 6273 5f69 643a 2054  am str obs_id: T
-00019f80: 6865 204f 6273 4944 2074 6861 7420 7468  he ObsID that th
-00019f90: 6520 6d61 736b 2069 7320 6173 736f 6369  e mask is associ
-00019fa0: 6174 6564 2077 6974 6820 2869 6620 6170  ated with (if ap
-00019fb0: 7072 6f70 7269 6174 6529 2e0a 2020 2020  propriate)..    
-00019fc0: 2020 2020 3a72 6574 7572 6e3a 2041 206e      :return: A n
-00019fd0: 756d 7079 2061 7272 6179 206f 6620 3073  umpy array of 0s
-00019fe0: 2061 6e64 2031 7320 7768 6963 6820 6163   and 1s which ac
-00019ff0: 7473 2061 7320 6120 6d61 736b 2074 6f20  ts as a mask to 
-0001a000: 7265 6d6f 7665 2069 6e74 6572 6c6f 7065  remove interlope
-0001a010: 7220 736f 7572 6365 732e 0a20 2020 2020  r sources..     
-0001a020: 2020 203a 7274 7970 653a 206e 6461 7272     :rtype: ndarr
-0001a030: 6179 0a20 2020 2020 2020 2022 2222 0a20  ay.        """. 
-0001a040: 2020 2020 2020 2069 6620 7479 7065 2873         if type(s
-0001a050: 656c 6629 203d 3d20 4261 7365 536f 7572  elf) == BaseSour
-0001a060: 6365 3a0a 2020 2020 2020 2020 2020 2020  ce:.            
-0001a070: 7261 6973 6520 5479 7065 4572 726f 7228  raise TypeError(
-0001a080: 2242 6173 6553 6f75 7263 6520 6f62 6a65  "BaseSource obje
-0001a090: 6374 7320 646f 6e27 7420 6861 7665 2065  cts don't have e
-0001a0a0: 6e6f 7567 6820 696e 666f 726d 6174 696f  nough informatio
-0001a0b0: 6e20 746f 206b 6e6f 7720 7768 6963 6820  n to know which 
-0001a0c0: 736f 7572 6365 7320 220a 2020 2020 2020  sources ".      
-0001a0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a0e0: 2020 2020 2020 2261 7265 2069 6e74 6572        "are inter
-0001a0f0: 6c6f 7065 7273 2e22 290a 0a20 2020 2020  lopers.")..     
-0001a100: 2020 2069 6620 6f62 735f 6964 2069 7320     if obs_id is 
-0001a110: 6e6f 7420 4e6f 6e65 2061 6e64 206f 6273  not None and obs
-0001a120: 5f69 6420 213d 2022 636f 6d62 696e 6564  _id != "combined
-0001a130: 2220 616e 6420 6f62 735f 6964 206e 6f74  " and obs_id not
-0001a140: 2069 6e20 7365 6c66 2e6f 6273 5f69 6473   in self.obs_ids
-0001a150: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-0001a160: 6973 6520 4e6f 7441 7373 6f63 6961 7465  ise NotAssociate
-0001a170: 6445 7272 6f72 2822 7b6f 7d20 6973 206e  dError("{o} is n
-0001a180: 6f74 2061 7373 6f63 6961 7465 6420 7769  ot associated wi
-0001a190: 7468 207b 737d 3b20 6f6e 6c79 207b 617d  th {s}; only {a}
-0001a1a0: 2061 7265 2022 0a20 2020 2020 2020 2020   are ".         
-0001a1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a1c0: 2020 2020 2020 2020 2020 2020 2261 7661              "ava
-0001a1d0: 696c 6162 6c65 222e 666f 726d 6174 286f  ilable".format(o
-0001a1e0: 3d6f 6273 5f69 642c 2073 3d73 656c 662e  =obs_id, s=self.
-0001a1f0: 6e61 6d65 2c20 613d 222c 2022 2e6a 6f69  name, a=", ".joi
-0001a200: 6e28 7365 6c66 2e6f 6273 5f69 6473 2929  n(self.obs_ids))
-0001a210: 290a 2020 2020 2020 2020 656c 6966 206f  ).        elif o
-0001a220: 6273 5f69 6420 6973 206e 6f74 204e 6f6e  bs_id is not Non
-0001a230: 6520 616e 6420 6f62 735f 6964 2021 3d20  e and obs_id != 
-0001a240: 2263 6f6d 6269 6e65 6422 3a0a 2020 2020  "combined":.    
-0001a250: 2020 2020 2020 2020 6d61 736b 203d 2073          mask = s
-0001a260: 656c 662e 5f69 6e74 6572 6c6f 7065 725f  elf._interloper_
-0001a270: 6d61 736b 735b 6f62 735f 6964 5d0a 2020  masks[obs_id].  
-0001a280: 2020 2020 2020 656c 6966 206f 6273 5f69        elif obs_i
-0001a290: 6420 6973 204e 6f6e 6520 6f72 206f 6273  d is None or obs
-0001a2a0: 5f69 6420 3d3d 2022 636f 6d62 696e 6564  _id == "combined
-0001a2b0: 2220 616e 6420 2263 6f6d 6269 6e65 6422  " and "combined"
-0001a2c0: 206e 6f74 2069 6e20 7365 6c66 2e5f 696e   not in self._in
-0001a2d0: 7465 726c 6f70 6572 5f6d 6173 6b73 3a0a  terloper_masks:.
-0001a2e0: 2020 2020 2020 2020 2020 2020 636f 6d62              comb
-0001a2f0: 5f69 6d73 203d 2073 656c 662e 6765 745f  _ims = self.get_
-0001a300: 7072 6f64 7563 7473 2822 636f 6d62 696e  products("combin
-0001a310: 6564 5f69 6d61 6765 2229 0a20 2020 2020  ed_image").     
-0001a320: 2020 2020 2020 2069 6620 6c65 6e28 636f         if len(co
-0001a330: 6d62 5f69 6d73 2920 3d3d 2030 3a0a 2020  mb_ims) == 0:.  
-0001a340: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-0001a350: 6973 6520 4e6f 5072 6f64 7563 7441 7661  ise NoProductAva
-0001a360: 696c 6162 6c65 4572 726f 7228 2254 6865  ilableError("The
-0001a370: 7265 2061 7265 206e 6f20 636f 6d62 696e  re are no combin
-0001a380: 6564 2069 6d61 6765 7320 6176 6169 6c61  ed images availa
-0001a390: 626c 6520 666f 7220 7768 6963 6820 746f  ble for which to
-0001a3a0: 2066 6574 6368 220a 2020 2020 2020 2020   fetch".        
-0001a3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a3d0: 2020 2020 2020 2220 696e 7465 726c 6f70        " interlop
-0001a3e0: 6572 206d 6173 6b73 2e22 290a 2020 2020  er masks.").    
-0001a3f0: 2020 2020 2020 2020 696d 203d 2063 6f6d          im = com
-0001a400: 625f 696d 735b 305d 0a20 2020 2020 2020  b_ims[0].       
-0001a410: 2020 2020 206d 6173 6b20 3d20 7365 6c66       mask = self
-0001a420: 2e5f 6765 6e65 7261 7465 5f69 6e74 6572  ._generate_inter
-0001a430: 6c6f 7065 725f 6d61 736b 2869 6d29 0a20  loper_mask(im). 
-0001a440: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0001a450: 5f69 6e74 6572 6c6f 7065 725f 6d61 736b  _interloper_mask
-0001a460: 735b 2263 6f6d 6269 6e65 6422 5d20 3d20  s["combined"] = 
-0001a470: 6d61 736b 0a20 2020 2020 2020 2065 6c69  mask.        eli
-0001a480: 6620 6f62 735f 6964 2069 7320 4e6f 6e65  f obs_id is None
-0001a490: 206f 7220 6f62 735f 6964 203d 3d20 2263   or obs_id == "c
-0001a4a0: 6f6d 6269 6e65 6422 2061 6e64 2022 636f  ombined" and "co
-0001a4b0: 6d62 696e 6564 2220 696e 2073 656c 662e  mbined" in self.
-0001a4c0: 5f69 6e74 6572 6c6f 7065 725f 6d61 736b  _interloper_mask
-0001a4d0: 733a 0a20 2020 2020 2020 2020 2020 206d  s:.            m
-0001a4e0: 6173 6b20 3d20 7365 6c66 2e5f 696e 7465  ask = self._inte
-0001a4f0: 726c 6f70 6572 5f6d 6173 6b73 5b22 636f  rloper_masks["co
-0001a500: 6d62 696e 6564 225d 0a0a 2020 2020 2020  mbined"]..      
-0001a510: 2020 7265 7475 726e 206d 6173 6b0a 0a20    return mask.. 
-0001a520: 2020 2064 6566 2067 6574 5f6d 6173 6b28     def get_mask(
-0001a530: 7365 6c66 2c20 7265 675f 7479 7065 3a20  self, reg_type: 
-0001a540: 7374 722c 206f 6273 5f69 643a 2073 7472  str, obs_id: str
-0001a550: 203d 204e 6f6e 652c 2063 656e 7472 616c   = None, central
-0001a560: 5f63 6f6f 7264 3a20 5175 616e 7469 7479  _coord: Quantity
-0001a570: 203d 204e 6f6e 6529 202d 3e20 5c0a 2020   = None) -> \.  
-0001a580: 2020 2020 2020 2020 2020 5475 706c 655b            Tuple[
-0001a590: 6e70 2e6e 6461 7272 6179 2c20 6e70 2e6e  np.ndarray, np.n
-0001a5a0: 6461 7272 6179 5d3a 0a20 2020 2020 2020  darray]:.       
-0001a5b0: 2022 2222 0a20 2020 2020 2020 204d 6574   """.        Met
-0001a5c0: 686f 6420 746f 2072 6574 7269 6576 6520  hod to retrieve 
-0001a5d0: 736f 7572 6365 2061 6e64 2062 6163 6b67  source and backg
-0001a5e0: 726f 756e 6420 6d61 736b 7320 666f 7220  round masks for 
-0001a5f0: 7468 6520 6769 7665 6e20 7265 6769 6f6e  the given region
-0001a600: 2074 7970 652c 2057 4954 4820 494e 5445   type, WITH INTE
-0001a610: 524c 4f50 4552 5320 5245 4d4f 5645 442e  RLOPERS REMOVED.
-0001a620: 0a0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
-0001a630: 2073 7472 2072 6567 5f74 7970 653a 2054   str reg_type: T
-0001a640: 6865 2074 7970 6520 6f66 2072 6567 696f  he type of regio
-0001a650: 6e20 666f 7220 7768 6963 6820 746f 2072  n for which to r
-0001a660: 6574 7269 6576 6520 7468 6520 696e 7465  etrieve the inte
-0001a670: 726c 6f70 6572 2063 6f72 7265 6374 6564  rloper corrected
-0001a680: 206d 6173 6b2e 0a20 2020 2020 2020 203a   mask..        :
-0001a690: 7061 7261 6d20 7374 7220 6f62 735f 6964  param str obs_id
-0001a6a0: 3a20 5468 6520 4f62 7349 4420 7468 6174  : The ObsID that
-0001a6b0: 2074 6865 206d 6173 6b20 6973 2061 7373   the mask is ass
-0001a6c0: 6f63 6961 7465 6420 7769 7468 2028 6966  ociated with (if
-0001a6d0: 2061 7070 726f 7072 6961 7465 292e 0a20   appropriate).. 
-0001a6e0: 2020 2020 2020 203a 7061 7261 6d20 5175         :param Qu
-0001a6f0: 616e 7469 7479 2063 656e 7472 616c 5f63  antity central_c
-0001a700: 6f6f 7264 3a20 5468 6520 6365 6e74 7261  oord: The centra
-0001a710: 6c20 636f 6f72 6469 6e61 7465 206f 6620  l coordinate of 
-0001a720: 7468 6520 7265 6769 6f6e 2e0a 2020 2020  the region..    
-0001a730: 2020 2020 3a72 6574 7572 6e3a 2054 6865      :return: The
-0001a740: 2073 6f75 7263 6520 616e 6420 6261 636b   source and back
-0001a750: 6772 6f75 6e64 206d 6173 6b73 2066 6f72  ground masks for
-0001a760: 2074 6865 2072 6571 7565 7374 6564 204f   the requested O
-0001a770: 6273 4944 2028 6f72 2074 6865 2063 6f6d  bsID (or the com
-0001a780: 6269 6e65 6420 696d 6167 6520 6966 206e  bined image if n
-0001a790: 6f20 4f62 7349 4429 2e0a 2020 2020 2020  o ObsID)..      
-0001a7a0: 2020 3a72 7479 7065 3a20 5475 706c 655b    :rtype: Tuple[
-0001a7b0: 6e70 2e6e 6461 7272 6179 2c20 6e70 2e6e  np.ndarray, np.n
-0001a7c0: 6461 7272 6179 5d0a 2020 2020 2020 2020  darray].        
-0001a7d0: 2222 220a 2020 2020 2020 2020 2320 4772  """.        # Gr
-0001a7e0: 6162 7320 7468 6520 736f 7572 6365 206d  abs the source m
-0001a7f0: 6173 6b73 2077 6974 686f 7574 2069 6e74  asks without int
-0001a800: 6572 6c6f 7065 7273 2072 656d 6f76 6564  erlopers removed
-0001a810: 0a20 2020 2020 2020 2073 7263 5f6d 6173  .        src_mas
-0001a820: 6b2c 2062 636b 5f6d 6173 6b20 3d20 7365  k, bck_mask = se
-0001a830: 6c66 2e67 6574 5f73 6f75 7263 655f 6d61  lf.get_source_ma
-0001a840: 736b 2872 6567 5f74 7970 652c 206f 6273  sk(reg_type, obs
-0001a850: 5f69 642c 2063 656e 7472 616c 5f63 6f6f  _id, central_coo
-0001a860: 7264 290a 2020 2020 2020 2020 2320 4772  rd).        # Gr
-0001a870: 6162 7320 7468 6520 696e 7465 726c 6f70  abs the interlop
-0001a880: 6572 206d 6173 6b0a 2020 2020 2020 2020  er mask.        
-0001a890: 696e 7465 726c 6f70 6572 5f6d 6173 6b20  interloper_mask 
-0001a8a0: 3d20 7365 6c66 2e67 6574 5f69 6e74 6572  = self.get_inter
-0001a8b0: 6c6f 7065 725f 6d61 736b 286f 6273 5f69  loper_mask(obs_i
-0001a8c0: 6429 0a0a 2020 2020 2020 2020 2320 4d75  d)..        # Mu
-0001a8d0: 6c74 6970 6c69 6573 2074 6865 2075 6e63  ltiplies the unc
-0001a8e0: 6f72 7265 6374 6564 2073 6f75 7263 6520  orrected source 
-0001a8f0: 616e 6420 6261 636b 6772 6f75 6e64 206d  and background m
-0001a900: 6173 6b73 2077 6974 6820 7468 6520 696e  asks with the in
-0001a910: 7465 726c 6f70 6572 206d 6173 6b73 2074  terloper masks t
-0001a920: 6f20 636f 7272 6563 740a 2020 2020 2020  o correct.      
-0001a930: 2020 2320 2066 6f72 2069 6e74 6572 6c6f    #  for interlo
-0001a940: 7065 7220 736f 7572 6365 730a 2020 2020  per sources.    
-0001a950: 2020 2020 746f 7461 6c5f 7372 635f 6d61      total_src_ma
-0001a960: 736b 203d 2073 7263 5f6d 6173 6b20 2a20  sk = src_mask * 
-0001a970: 696e 7465 726c 6f70 6572 5f6d 6173 6b0a  interloper_mask.
-0001a980: 2020 2020 2020 2020 746f 7461 6c5f 6263          total_bc
-0001a990: 6b5f 6d61 736b 203d 2062 636b 5f6d 6173  k_mask = bck_mas
-0001a9a0: 6b20 2a20 696e 7465 726c 6f70 6572 5f6d  k * interloper_m
-0001a9b0: 6173 6b0a 0a20 2020 2020 2020 2072 6574  ask..        ret
-0001a9c0: 7572 6e20 746f 7461 6c5f 7372 635f 6d61  urn total_src_ma
-0001a9d0: 736b 2c20 746f 7461 6c5f 6263 6b5f 6d61  sk, total_bck_ma
-0001a9e0: 736b 0a0a 2020 2020 6465 6620 6765 745f  sk..    def get_
-0001a9f0: 6375 7374 6f6d 5f6d 6173 6b28 7365 6c66  custom_mask(self
-0001aa00: 2c20 6f75 7465 725f 7261 643a 2051 7561  , outer_rad: Qua
-0001aa10: 6e74 6974 792c 2069 6e6e 6572 5f72 6164  ntity, inner_rad
-0001aa20: 3a20 5175 616e 7469 7479 203d 2051 7561  : Quantity = Qua
-0001aa30: 6e74 6974 7928 302c 2027 6172 6373 6563  ntity(0, 'arcsec
-0001aa40: 2729 2c20 6f62 735f 6964 3a20 7374 7220  '), obs_id: str 
-0001aa50: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-0001aa60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aa70: 6365 6e74 7261 6c5f 636f 6f72 643a 2051  central_coord: Q
-0001aa80: 7561 6e74 6974 7920 3d20 4e6f 6e65 2c20  uantity = None, 
-0001aa90: 7265 6d6f 7665 5f69 6e74 6572 6c6f 7065  remove_interlope
-0001aaa0: 7273 3a20 626f 6f6c 203d 2054 7275 6529  rs: bool = True)
-0001aab0: 202d 3e20 6e70 2e6e 6461 7272 6179 3a0a   -> np.ndarray:.
-0001aac0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-0001aad0: 2020 2020 4120 7369 6d70 6c65 2c20 6275      A simple, bu
-0001aae0: 7420 706f 7765 7266 756c 206d 6574 686f  t powerful metho
-0001aaf0: 642c 2074 6f20 6765 6e65 7261 7465 206d  d, to generate m
-0001ab00: 6173 6b20 6120 6d61 736b 2077 6974 6869  ask a mask withi
-0001ab10: 6e20 6120 6375 7374 6f6d 2072 6164 6975  n a custom radiu
-0001ab20: 7320 666f 7220 6120 6769 7665 6e20 4f62  s for a given Ob
-0001ab30: 7349 442e 0a0a 2020 2020 2020 2020 3a70  sID...        :p
-0001ab40: 6172 616d 2051 7561 6e74 6974 7920 6f75  aram Quantity ou
-0001ab50: 7465 725f 7261 643a 2054 6865 206f 7574  ter_rad: The out
-0001ab60: 6572 2072 6164 6975 7320 6f66 2074 6865  er radius of the
-0001ab70: 206d 6173 6b2e 0a20 2020 2020 2020 203a   mask..        :
-0001ab80: 7061 7261 6d20 5175 616e 7469 7479 2069  param Quantity i
-0001ab90: 6e6e 6572 5f72 6164 3a20 5468 6520 696e  nner_rad: The in
-0001aba0: 6e65 7220 7261 6469 7573 206f 6620 7468  ner radius of th
-0001abb0: 6520 6d61 736b 2c20 7468 6520 6465 6661  e mask, the defa
-0001abc0: 756c 7420 6973 207a 6572 6f20 6172 6373  ult is zero arcs
-0001abd0: 6563 6f6e 6473 2e0a 2020 2020 2020 2020  econds..        
-0001abe0: 3a70 6172 616d 2073 7472 206f 6273 5f69  :param str obs_i
-0001abf0: 643a 2054 6865 204f 6273 4944 2066 6f72  d: The ObsID for
-0001ac00: 2077 6869 6368 2074 6f20 6765 6e65 7261   which to genera
-0001ac10: 7465 2074 6865 206d 6173 6b2c 2064 6566  te the mask, def
-0001ac20: 6175 6c74 2069 7320 4e6f 6e65 2077 6869  ault is None whi
-0001ac30: 6368 2077 696c 6c20 7265 7475 726e 2061  ch will return a
-0001ac40: 206d 6173 6b0a 2020 2020 2020 2020 2020   mask.          
-0001ac50: 2020 6765 6e65 7261 7465 6420 6672 6f6d    generated from
-0001ac60: 2061 2063 6f6d 6269 6e65 6420 696d 6167   a combined imag
-0001ac70: 652e 0a20 2020 2020 2020 203a 7061 7261  e..        :para
-0001ac80: 6d20 5175 616e 7469 7479 2063 656e 7472  m Quantity centr
-0001ac90: 616c 5f63 6f6f 7264 3a20 5468 6520 6365  al_coord: The ce
-0001aca0: 6e74 7261 6c20 636f 6f72 6469 6e61 7465  ntral coordinate
-0001acb0: 7320 6f66 2074 6865 206d 6173 6b2c 2074  s of the mask, t
-0001acc0: 6865 2064 6566 6175 6c74 2069 7320 4e6f  he default is No
-0001acd0: 6e65 2077 6869 6368 0a20 2020 2020 2020  ne which.       
-0001ace0: 2020 2020 2077 696c 6c20 7573 6520 7468       will use th
-0001acf0: 6520 6465 6661 756c 7420 636f 6f72 6469  e default coordi
-0001ad00: 6e61 7465 7320 6f66 2074 6865 2073 6f75  nates of the sou
-0001ad10: 7263 652e 0a20 2020 2020 2020 203a 7061  rce..        :pa
-0001ad20: 7261 6d20 626f 6f6c 2072 656d 6f76 655f  ram bool remove_
-0001ad30: 696e 7465 726c 6f70 6572 733a 2057 6865  interlopers: Whe
-0001ad40: 7468 6572 2061 6e20 696e 7465 726c 6f70  ther an interlop
-0001ad50: 6572 206d 6173 6b20 7368 6f75 6c64 2062  er mask should b
-0001ad60: 6520 636f 6d62 696e 6564 2077 6974 6820  e combined with 
-0001ad70: 7468 6520 6375 7374 6f6d 206d 6173 6b20  the custom mask 
-0001ad80: 746f 0a20 2020 2020 2020 2020 2020 2072  to.            r
-0001ad90: 656d 6f76 6520 696e 7465 726c 6f70 6572  emove interloper
-0001ada0: 2070 6f69 6e74 2073 6f75 7263 6573 2e0a   point sources..
-0001adb0: 2020 2020 2020 2020 3a72 6574 7572 6e3a          :return:
-0001adc0: 2041 206e 756d 7079 2061 7272 6179 2063   A numpy array c
-0001add0: 6f6e 7461 696e 696e 6720 7468 6520 6465  ontaining the de
-0001ade0: 7369 7265 6420 6d61 736b 2e0a 2020 2020  sired mask..    
-0001adf0: 2020 2020 3a72 7479 7065 3a20 6e70 2e6e      :rtype: np.n
-0001ae00: 6461 7272 6179 0a20 2020 2020 2020 2022  darray.        "
-0001ae10: 2222 0a20 2020 2020 2020 2069 6620 6365  "".        if ce
-0001ae20: 6e74 7261 6c5f 636f 6f72 6420 6973 204e  ntral_coord is N
-0001ae30: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0001ae40: 2063 656e 7472 616c 5f63 6f6f 7264 203d   central_coord =
-0001ae50: 2073 656c 662e 5f64 6566 6175 6c74 5f63   self._default_c
-0001ae60: 6f6f 7264 0a0a 2020 2020 2020 2020 6966  oord..        if
-0001ae70: 206f 6273 5f69 6420 6973 204e 6f6e 653a   obs_id is None:
-0001ae80: 0a20 2020 2020 2020 2020 2020 2023 2044  .            # D
-0001ae90: 6f65 736e 2774 206d 6174 7465 7220 7768  oesn't matter wh
-0001aea0: 6963 6820 636f 6d62 696e 6564 2072 6174  ich combined rat
-0001aeb0: 656d 6170 2c20 6a75 7374 206e 6565 6420  emap, just need 
-0001aec0: 7468 6520 7369 7a65 2061 6e64 2063 6f6f  the size and coo
-0001aed0: 7264 2063 6f6e 7665 7273 696f 6e20 706f  rd conversion po
-0001aee0: 7765 7273 0a20 2020 2020 2020 2020 2020  wers.           
-0001aef0: 2072 7420 3d20 7365 6c66 2e67 6574 5f63   rt = self.get_c
-0001af00: 6f6d 6269 6e65 645f 7261 7465 6d61 7073  ombined_ratemaps
-0001af10: 2829 0a20 2020 2020 2020 2065 6c73 653a  ().        else:
-0001af20: 0a20 2020 2020 2020 2020 2020 2023 2041  .            # A
-0001af30: 6761 696e 2073 6f20 6c6f 6e67 2061 7320  gain so long as 
-0001af40: 7468 6520 696d 6167 6520 6d61 7463 6865  the image matche
-0001af50: 7320 7468 6520 4f62 7349 4420 7061 7373  s the ObsID pass
-0001af60: 6564 2069 6e20 6279 2074 6865 2075 7365  ed in by the use
-0001af70: 7220 4920 646f 6e27 7420 6361 7265 2077  r I don't care w
-0001af80: 6861 7420 696e 7374 7275 6d65 6e74 0a20  hat instrument. 
-0001af90: 2020 2020 2020 2020 2020 2023 2020 6974             #  it
-0001afa0: 7320 6672 6f6d 0a20 2020 2020 2020 2020  s from.         
-0001afb0: 2020 2072 7420 3d20 7365 6c66 2e67 6574     rt = self.get
-0001afc0: 5f72 6174 656d 6170 7328 6f62 735f 6964  _ratemaps(obs_id
-0001afd0: 3d6f 6273 5f69 6429 0a0a 2020 2020 2020  =obs_id)..      
-0001afe0: 2020 2320 4966 2069 7473 206e 6f74 2061    # If its not a
-0001aff0: 6e20 696e 7374 616e 6365 206f 6620 5261  n instance of Ra
-0001b000: 7465 4d61 7020 7468 6174 206d 6561 6e73  teMap that means
-0001b010: 2061 206c 6973 7420 6f66 2052 6174 654d   a list of RateM
-0001b020: 6170 7320 6861 7320 6265 656e 2072 6574  aps has been ret
-0001b030: 7572 6e65 642c 2061 6e64 2061 7320 4920  urned, and as I 
-0001b040: 6f6e 6c79 2077 616e 740a 2020 2020 2020  only want.      
-0001b050: 2020 2320 2074 6865 2057 4353 2069 6e66    #  the WCS inf
-0001b060: 6f72 6d61 7469 6f6e 2061 6e64 2074 6865  ormation and the
-0001b070: 2073 6861 7065 206f 6620 7468 6520 696d   shape of the im
-0001b080: 6167 6520 4920 646f 6e27 7420 6361 7265  age I don't care
-0001b090: 2077 6869 6368 206f 6e65 2077 6520 7573   which one we us
-0001b0a0: 650a 2020 2020 2020 2020 6966 206e 6f74  e.        if not
-0001b0b0: 2069 7369 6e73 7461 6e63 6528 7274 2c20   isinstance(rt, 
-0001b0c0: 5261 7465 4d61 7029 3a0a 2020 2020 2020  RateMap):.      
-0001b0d0: 2020 2020 2020 7274 203d 2072 745b 305d        rt = rt[0]
-0001b0e0: 0a0a 2020 2020 2020 2020 2320 436f 6e76  ..        # Conv
-0001b0f0: 6572 7420 7468 6520 696e 6e65 7220 616e  ert the inner an
-0001b100: 6420 6f75 7465 7220 7261 6469 6920 746f  d outer radii to
-0001b110: 2064 6567 7265 6573 2073 6f20 7468 6579   degrees so they
-0001b120: 2063 616e 2062 6520 6561 7369 6c79 2063   can be easily c
-0001b130: 6f6e 7665 7274 6564 2074 6f20 7069 7865  onverted to pixe
-0001b140: 6c73 0a20 2020 2020 2020 206f 7574 6572  ls.        outer
-0001b150: 5f72 6164 203d 2073 656c 662e 636f 6e76  _rad = self.conv
-0001b160: 6572 745f 7261 6469 7573 286f 7574 6572  ert_radius(outer
-0001b170: 5f72 6164 2c20 2764 6567 2729 0a20 2020  _rad, 'deg').   
-0001b180: 2020 2020 2069 6e6e 6572 5f72 6164 203d       inner_rad =
-0001b190: 2073 656c 662e 636f 6e76 6572 745f 7261   self.convert_ra
-0001b1a0: 6469 7573 2869 6e6e 6572 5f72 6164 2c20  dius(inner_rad, 
-0001b1b0: 2764 6567 2729 0a20 2020 2020 2020 2070  'deg').        p
-0001b1c0: 6978 5f74 6f5f 6465 6720 3d20 7069 785f  ix_to_deg = pix_
-0001b1d0: 6465 675f 7363 616c 6528 6365 6e74 7261  deg_scale(centra
-0001b1e0: 6c5f 636f 6f72 642c 2072 742e 7261 6465  l_coord, rt.rade
-0001b1f0: 635f 7763 7329 0a0a 2020 2020 2020 2020  c_wcs)..        
-0001b200: 2320 4d61 6b69 6e67 2073 7572 6520 7468  # Making sure th
-0001b210: 6520 696e 6e65 7220 616e 6420 6f75 7465  e inner and oute
-0001b220: 7220 7261 6469 6920 6172 6520 7768 6f6c  r radii are whol
-0001b230: 6520 696e 7465 6765 7220 6e75 6d62 6572  e integer number
-0001b240: 732c 2061 7320 7468 6579 2061 7265 206e  s, as they are n
-0001b250: 6f77 2069 6e20 7069 7865 6c20 756e 6974  ow in pixel unit
-0001b260: 730a 2020 2020 2020 2020 6f75 7465 725f  s.        outer_
-0001b270: 7261 6420 3d20 6e70 2e61 7272 6179 285b  rad = np.array([
-0001b280: 696e 7428 6e70 2e63 6569 6c28 6f75 7465  int(np.ceil(oute
-0001b290: 725f 7261 6420 2f20 7069 785f 746f 5f64  r_rad / pix_to_d
-0001b2a0: 6567 292e 7661 6c75 6529 5d29 0a20 2020  eg).value)]).   
-0001b2b0: 2020 2020 2069 6e6e 6572 5f72 6164 203d       inner_rad =
-0001b2c0: 206e 702e 6172 7261 7928 5b69 6e74 286e   np.array([int(n
-0001b2d0: 702e 666c 6f6f 7228 696e 6e65 725f 7261  p.floor(inner_ra
-0001b2e0: 6420 2f20 7069 785f 746f 5f64 6567 292e  d / pix_to_deg).
-0001b2f0: 7661 6c75 6529 5d29 0a20 2020 2020 2020  value)]).       
-0001b300: 2023 2043 6f6e 7665 7274 2074 6865 2063   # Convert the c
-0001b310: 686f 7365 6e20 6365 6e74 7261 6c20 636f  hosen central co
-0001b320: 6f72 6469 6e61 7465 7320 746f 2070 6978  ordinates to pix
-0001b330: 656c 730a 2020 2020 2020 2020 7069 785f  els.        pix_
-0001b340: 6365 6e74 7265 203d 2072 742e 636f 6f72  centre = rt.coor
-0001b350: 645f 636f 6e76 2863 656e 7472 616c 5f63  d_conv(central_c
-0001b360: 6f6f 7264 2c20 2770 6978 2729 0a0a 2020  oord, 'pix')..  
-0001b370: 2020 2020 2020 2320 4765 6e65 7261 7465        # Generate
-0001b380: 206f 7572 2063 7573 746f 6d20 6d61 736b   our custom mask
-0001b390: 0a20 2020 2020 2020 2063 7573 746f 6d5f  .        custom_
-0001b3a0: 6d61 736b 203d 2061 6e6e 756c 6172 5f6d  mask = annular_m
-0001b3b0: 6173 6b28 7069 785f 6365 6e74 7265 2c20  ask(pix_centre, 
-0001b3c0: 696e 6e65 725f 7261 642c 206f 7574 6572  inner_rad, outer
-0001b3d0: 5f72 6164 2c20 7274 2e73 6861 7065 290a  _rad, rt.shape).
-0001b3e0: 0a20 2020 2020 2020 2023 2041 6e64 2061  .        # And a
-0001b3f0: 7070 6c79 696e 6720 616e 2069 6e74 6572  pplying an inter
-0001b400: 6c6f 7065 7220 6d61 736b 2069 6620 7468  loper mask if th
-0001b410: 6520 7573 6572 2077 616e 7473 2074 6861  e user wants tha
-0001b420: 742e 0a20 2020 2020 2020 2069 6620 7265  t..        if re
-0001b430: 6d6f 7665 5f69 6e74 6572 6c6f 7065 7273  move_interlopers
-0001b440: 3a0a 2020 2020 2020 2020 2020 2020 696e  :.            in
-0001b450: 7465 726c 6f70 6572 5f6d 6173 6b20 3d20  terloper_mask = 
-0001b460: 7365 6c66 2e67 6574 5f69 6e74 6572 6c6f  self.get_interlo
-0001b470: 7065 725f 6d61 736b 286f 6273 5f69 6429  per_mask(obs_id)
-0001b480: 0a20 2020 2020 2020 2020 2020 2063 7573  .            cus
-0001b490: 746f 6d5f 6d61 736b 203d 2063 7573 746f  tom_mask = custo
-0001b4a0: 6d5f 6d61 736b 2a69 6e74 6572 6c6f 7065  m_mask*interlope
-0001b4b0: 725f 6d61 736b 0a20 2020 2020 2020 2072  r_mask.        r
-0001b4c0: 6574 7572 6e20 6375 7374 6f6d 5f6d 6173  eturn custom_mas
-0001b4d0: 6b0a 0a20 2020 2064 6566 2067 6574 5f73  k..    def get_s
-0001b4e0: 6e72 2873 656c 662c 206f 7574 6572 5f72  nr(self, outer_r
-0001b4f0: 6164 6975 733a 2055 6e69 6f6e 5b51 7561  adius: Union[Qua
-0001b500: 6e74 6974 792c 2073 7472 5d2c 2063 656e  ntity, str], cen
-0001b510: 7472 616c 5f63 6f6f 7264 3a20 5175 616e  tral_coord: Quan
-0001b520: 7469 7479 203d 204e 6f6e 652c 206c 6f5f  tity = None, lo_
-0001b530: 656e 3a20 5175 616e 7469 7479 203d 204e  en: Quantity = N
-0001b540: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
-0001b550: 2020 2020 2068 695f 656e 3a20 5175 616e       hi_en: Quan
-0001b560: 7469 7479 203d 204e 6f6e 652c 206f 6273  tity = None, obs
-0001b570: 5f69 643a 2073 7472 203d 204e 6f6e 652c  _id: str = None,
-0001b580: 2069 6e73 743a 2073 7472 203d 204e 6f6e   inst: str = Non
-0001b590: 652c 2070 7366 5f63 6f72 723a 2062 6f6f  e, psf_corr: boo
-0001b5a0: 6c20 3d20 4661 6c73 652c 0a20 2020 2020  l = False,.     
-0001b5b0: 2020 2020 2020 2020 2020 2070 7366 5f6d             psf_m
-0001b5c0: 6f64 656c 3a20 7374 7220 3d20 2245 4c4c  odel: str = "ELL
-0001b5d0: 4245 5441 222c 2070 7366 5f62 696e 733a  BETA", psf_bins:
-0001b5e0: 2069 6e74 203d 2034 2c20 7073 665f 616c   int = 4, psf_al
-0001b5f0: 676f 3a20 7374 7220 3d20 2272 6c22 2c20  go: str = "rl", 
-0001b600: 7073 665f 6974 6572 3a20 696e 7420 3d20  psf_iter: int = 
-0001b610: 3135 2c0a 2020 2020 2020 2020 2020 2020  15,.            
-0001b620: 2020 2020 616c 6c6f 775f 6e65 6761 7469      allow_negati
-0001b630: 7665 3a20 626f 6f6c 203d 2046 616c 7365  ve: bool = False
-0001b640: 2c20 2065 7870 5f63 6f72 723a 2062 6f6f  ,  exp_corr: boo
-0001b650: 6c20 3d20 5472 7565 2920 2d3e 2066 6c6f  l = True) -> flo
-0001b660: 6174 3a0a 2020 2020 2020 2020 2222 220a  at:.        """.
-0001b670: 2020 2020 2020 2020 5468 6973 2074 616b          This tak
-0001b680: 6573 2061 2072 6567 696f 6e20 7479 7065  es a region type
-0001b690: 2061 6e64 2063 656e 7472 616c 2063 6f6f   and central coo
-0001b6a0: 7264 696e 6174 6520 616e 6420 6361 6c63  rdinate and calc
-0001b6b0: 756c 6174 6573 2074 6865 2073 6967 6e61  ulates the signa
-0001b6c0: 6c20 746f 206e 6f69 7365 2072 6174 696f  l to noise ratio
-0001b6d0: 2e0a 2020 2020 2020 2020 5468 6520 6261  ..        The ba
-0001b6e0: 636b 6772 6f75 6e64 2072 6567 696f 6e20  ckground region 
-0001b6f0: 6973 2063 6f6e 7374 7275 6374 6564 2075  is constructed u
-0001b700: 7369 6e67 2074 6865 2062 6163 6b5f 696e  sing the back_in
-0001b710: 6e5f 7261 645f 6661 6374 6f72 2061 6e64  n_rad_factor and
-0001b720: 2062 6163 6b5f 6f75 745f 7261 645f 6661   back_out_rad_fa
-0001b730: 6374 6f72 0a20 2020 2020 2020 2076 616c  ctor.        val
-0001b740: 7565 732c 2074 6865 2064 6566 6175 6c74  ues, the default
-0001b750: 7320 6f66 2077 6869 6368 2061 7265 2031  s of which are 1
-0001b760: 2e30 352a 7261 6469 7573 2061 6e64 2031  .05*radius and 1
-0001b770: 2e35 2a72 6164 6975 7320 7265 7370 6563  .5*radius respec
-0001b780: 7469 7665 6c79 2e0a 0a20 2020 2020 2020  tively...       
-0001b790: 203a 7061 7261 6d20 5175 616e 7469 7479   :param Quantity
-0001b7a0: 2f73 7472 206f 7574 6572 5f72 6164 6975  /str outer_radiu
-0001b7b0: 733a 2054 6865 2072 6164 6975 7320 7468  s: The radius th
-0001b7c0: 6174 2053 4e52 2073 686f 756c 6420 6265  at SNR should be
-0001b7d0: 2063 616c 6375 6c61 7465 6420 7769 7468   calculated with
-0001b7e0: 696e 2c20 7468 6973 2063 616e 2065 6974  in, this can eit
-0001b7f0: 6865 7220 6265 2061 0a20 2020 2020 2020  her be a.       
-0001b800: 2020 2020 206e 616d 6564 2072 6164 6975       named radiu
-0001b810: 7320 7375 6368 2061 7320 7235 3030 2c20  s such as r500, 
-0001b820: 6f72 2061 6e20 6173 7472 6f70 7920 5175  or an astropy Qu
-0001b830: 616e 7469 7479 2e0a 2020 2020 2020 2020  antity..        
-0001b840: 3a70 6172 616d 2051 7561 6e74 6974 7920  :param Quantity 
-0001b850: 6365 6e74 7261 6c5f 636f 6f72 643a 2054  central_coord: T
-0001b860: 6865 2063 656e 7472 616c 2063 6f6f 7264  he central coord
-0001b870: 696e 6174 6520 6f66 2074 6865 2072 6567  inate of the reg
-0001b880: 696f 6e2e 0a20 2020 2020 2020 203a 7061  ion..        :pa
-0001b890: 7261 6d20 5175 616e 7469 7479 206c 6f5f  ram Quantity lo_
-0001b8a0: 656e 3a20 5468 6520 6c6f 7765 7220 656e  en: The lower en
-0001b8b0: 6572 6779 2062 6f75 6e64 206f 6620 7468  ergy bound of th
-0001b8c0: 6520 7261 7465 6d61 7020 746f 2075 7365  e ratemap to use
-0001b8d0: 2074 6f20 6361 6c63 756c 6174 6520 7468   to calculate th
-0001b8e0: 6520 534e 522e 2044 6566 6175 6c74 2069  e SNR. Default i
-0001b8f0: 7320 4e6f 6e65 2c0a 2020 2020 2020 2020  s None,.        
-0001b900: 2020 2020 696e 2077 6869 6368 2063 6173      in which cas
-0001b910: 6520 7468 6520 6c6f 7765 7220 656e 6572  e the lower ener
-0001b920: 6779 2062 6f75 6e64 2066 6f72 2070 6561  gy bound for pea
-0001b930: 6b20 6669 6e64 696e 6720 7769 6c6c 2062  k finding will b
-0001b940: 6520 7573 6564 2028 6465 6661 756c 7420  e used (default 
-0001b950: 6973 2030 2e35 6b65 5629 2e0a 2020 2020  is 0.5keV)..    
-0001b960: 2020 2020 3a70 6172 616d 2051 7561 6e74      :param Quant
-0001b970: 6974 7920 6869 5f65 6e3a 2054 6865 2075  ity hi_en: The u
-0001b980: 7070 6572 2065 6e65 7267 7920 626f 756e  pper energy boun
-0001b990: 6420 6f66 2074 6865 2072 6174 656d 6170  d of the ratemap
-0001b9a0: 2074 6f20 7573 6520 746f 2063 616c 6375   to use to calcu
-0001b9b0: 6c61 7465 2074 6865 2053 4e52 2e20 4465  late the SNR. De
-0001b9c0: 6661 756c 7420 6973 204e 6f6e 652c 0a20  fault is None,. 
-0001b9d0: 2020 2020 2020 2020 2020 2069 6e20 7768             in wh
-0001b9e0: 6963 6820 6361 7365 2074 6865 2075 7070  ich case the upp
-0001b9f0: 6572 2065 6e65 7267 7920 626f 756e 6420  er energy bound 
-0001ba00: 666f 7220 7065 616b 2066 696e 6469 6e67  for peak finding
-0001ba10: 2077 696c 6c20 6265 2075 7365 6420 2864   will be used (d
-0001ba20: 6566 6175 6c74 2069 7320 322e 306b 6556  efault is 2.0keV
-0001ba30: 292e 0a20 2020 2020 2020 203a 7061 7261  )..        :para
-0001ba40: 6d20 7374 7220 6f62 735f 6964 3a20 416e  m str obs_id: An
-0001ba50: 204f 6273 4944 206f 6620 6120 7370 6563   ObsID of a spec
-0001ba60: 6966 6963 2072 6174 656d 6170 2074 6f20  ific ratemap to 
-0001ba70: 7573 6520 666f 7220 7468 6520 534e 5220  use for the SNR 
-0001ba80: 6361 6c63 756c 6174 696f 6e2e 2044 6566  calculation. Def
-0001ba90: 6175 6c74 2069 7320 4e6f 6e65 2c20 7768  ault is None, wh
-0001baa0: 6963 680a 2020 2020 2020 2020 2020 2020  ich.            
-0001bab0: 6d65 616e 7320 7468 6520 636f 6d62 696e  means the combin
-0001bac0: 6564 2072 6174 656d 6170 2077 696c 6c20  ed ratemap will 
-0001bad0: 6265 2075 7365 642e 2050 6c65 6173 6520  be used. Please 
-0001bae0: 6e6f 7465 2074 6861 7420 696e 7374 206d  note that inst m
-0001baf0: 7573 7420 616c 736f 2062 6520 7365 7420  ust also be set 
-0001bb00: 746f 2075 7365 2074 6869 7320 6f70 7469  to use this opti
-0001bb10: 6f6e 2e0a 2020 2020 2020 2020 3a70 6172  on..        :par
-0001bb20: 616d 2073 7472 2069 6e73 743a 2054 6865  am str inst: The
-0001bb30: 2069 6e73 7472 756d 656e 7420 6f66 2061   instrument of a
-0001bb40: 2073 7065 6369 6669 6320 7261 7465 6d61   specific ratema
-0001bb50: 7020 746f 2075 7365 2066 6f72 2074 6865  p to use for the
-0001bb60: 2053 4e52 2063 616c 6375 6c61 7469 6f6e   SNR calculation
-0001bb70: 2e20 4465 6661 756c 7420 6973 204e 6f6e  . Default is Non
-0001bb80: 652c 2077 6869 6368 0a20 2020 2020 2020  e, which.       
-0001bb90: 2020 2020 206d 6561 6e73 2074 6865 2063       means the c
-0001bba0: 6f6d 6269 6e65 6420 7261 7465 6d61 7020  ombined ratemap 
-0001bbb0: 7769 6c6c 2062 6520 7573 6564 2e0a 2020  will be used..  
-0001bbc0: 2020 2020 2020 3a70 6172 616d 2062 6f6f        :param boo
-0001bbd0: 6c20 7073 665f 636f 7272 3a20 5365 7473  l psf_corr: Sets
-0001bbe0: 2077 6865 7468 6572 2079 6f75 2077 6973   whether you wis
-0001bbf0: 6820 746f 2075 7365 2061 2050 5346 2063  h to use a PSF c
-0001bc00: 6f72 7265 6374 6564 2072 6174 656d 6170  orrected ratemap
-0001bc10: 206f 7220 6e6f 742e 0a20 2020 2020 2020   or not..       
-0001bc20: 203a 7061 7261 6d20 7374 7220 7073 665f   :param str psf_
-0001bc30: 6d6f 6465 6c3a 2049 6620 7468 6520 7261  model: If the ra
-0001bc40: 7465 6d61 7020 796f 7520 7761 6e74 2074  temap you want t
-0001bc50: 6f20 7573 6520 6973 2050 5346 2063 6f72  o use is PSF cor
-0001bc60: 7265 6374 6564 2c20 7468 6973 2069 7320  rected, this is 
-0001bc70: 7468 6520 5053 4620 6d6f 6465 6c20 7573  the PSF model us
-0001bc80: 6564 2e0a 2020 2020 2020 2020 3a70 6172  ed..        :par
-0001bc90: 616d 2069 6e74 2070 7366 5f62 696e 733a  am int psf_bins:
-0001bca0: 2049 6620 7468 6520 7261 7465 6d61 7020   If the ratemap 
-0001bcb0: 796f 7520 7761 6e74 2074 6f20 7573 6520  you want to use 
-0001bcc0: 6973 2050 5346 2063 6f72 7265 6374 6564  is PSF corrected
-0001bcd0: 2c20 7468 6973 2069 7320 7468 6520 6e75  , this is the nu
-0001bce0: 6d62 6572 206f 6620 5053 4673 2070 6572  mber of PSFs per
-0001bcf0: 0a20 2020 2020 2020 2020 2020 2073 6964  .            sid
-0001bd00: 6520 696e 2074 6865 2050 5346 2067 7269  e in the PSF gri
-0001bd10: 642e 0a20 2020 2020 2020 203a 7061 7261  d..        :para
-0001bd20: 6d20 7374 7220 7073 665f 616c 676f 3a20  m str psf_algo: 
-0001bd30: 4966 2074 6865 2072 6174 656d 6170 2079  If the ratemap y
-0001bd40: 6f75 2077 616e 7420 746f 2075 7365 2069  ou want to use i
-0001bd50: 7320 5053 4620 636f 7272 6563 7465 642c  s PSF corrected,
-0001bd60: 2074 6869 7320 6973 2074 6865 2061 6c67   this is the alg
-0001bd70: 6f72 6974 686d 2075 7365 642e 0a20 2020  orithm used..   
-0001bd80: 2020 2020 203a 7061 7261 6d20 696e 7420       :param int 
-0001bd90: 7073 665f 6974 6572 3a20 4966 2074 6865  psf_iter: If the
-0001bda0: 2072 6174 656d 6170 2079 6f75 2077 616e   ratemap you wan
-0001bdb0: 7420 746f 2075 7365 2069 7320 5053 4620  t to use is PSF 
-0001bdc0: 636f 7272 6563 7465 642c 2074 6869 7320  corrected, this 
-0001bdd0: 6973 2074 6865 206e 756d 6265 7220 6f66  is the number of
-0001bde0: 2069 7465 7261 7469 6f6e 732e 0a20 2020   iterations..   
-0001bdf0: 2020 2020 203a 7061 7261 6d20 626f 6f6c       :param bool
-0001be00: 2061 6c6c 6f77 5f6e 6567 6174 6976 653a   allow_negative:
-0001be10: 2053 686f 756c 6420 7069 7865 6c73 2069   Should pixels i
-0001be20: 6e20 7468 6520 6261 636b 6772 6f75 6e64  n the background
-0001be30: 2073 7562 7472 6163 7465 6420 636f 756e   subtracted coun
-0001be40: 7420 6d61 7020 6265 2061 6c6c 6f77 6564  t map be allowed
-0001be50: 2074 6f20 676f 2062 656c 6f77 0a20 2020   to go below.   
-0001be60: 2020 2020 2020 2020 207a 6572 6f2c 2077           zero, w
-0001be70: 6869 6368 2072 6573 756c 7473 2069 6e20  hich results in 
-0001be80: 6120 6c6f 7765 7220 7369 676e 616c 2074  a lower signal t
-0001be90: 6f20 6e6f 6973 6520 2861 6e64 2063 616e  o noise (and can
-0001bea0: 2072 6573 756c 7420 696e 2061 206e 6567   result in a neg
-0001beb0: 6174 6976 6520 7369 676e 616c 2074 6f20  ative signal to 
-0001bec0: 6e6f 6973 6529 2e0a 2020 2020 2020 2020  noise)..        
-0001bed0: 3a70 6172 616d 2062 6f6f 6c20 6578 705f  :param bool exp_
-0001bee0: 636f 7272 3a20 5368 6f75 6c64 2073 6967  corr: Should sig
-0001bef0: 6e61 6c20 746f 206e 6f69 7365 7320 6265  nal to noises be
-0001bf00: 206d 6561 7375 7265 6420 7769 7468 2065   measured with e
-0001bf10: 7870 6f73 7572 6520 7469 6d65 2063 6f72  xposure time cor
-0001bf20: 7265 6374 696f 6e2c 2064 6566 6175 6c74  rection, default
-0001bf30: 2069 7320 5472 7565 2e20 490a 2020 2020   is True. I.    
-0001bf40: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
-0001bf50: 6420 7468 6174 2074 6869 7320 6265 2074  d that this be t
-0001bf60: 7275 6520 666f 7220 636f 6d62 696e 6564  rue for combined
-0001bf70: 206f 6273 6572 7661 7469 6f6e 732c 2061   observations, a
-0001bf80: 7320 6578 706f 7375 7265 2074 696d 6520  s exposure time 
-0001bf90: 636f 756c 6420 6368 616e 6765 2071 7569  could change qui
-0001bfa0: 7465 2064 7261 6d61 7469 6361 6c6c 790a  te dramatically.
-0001bfb0: 2020 2020 2020 2020 2020 2020 6163 726f              acro
-0001bfc0: 7373 2074 6865 2063 6f6d 6269 6e65 6420  ss the combined 
-0001bfd0: 7072 6f64 7563 742e 0a20 2020 2020 2020  product..       
-0001bfe0: 203a 7265 7475 726e 3a20 5468 6520 7369   :return: The si
-0001bff0: 676e 616c 2074 6f20 6e6f 6973 6520 7261  gnal to noise ra
-0001c000: 7469 6f2e 0a20 2020 2020 2020 203a 7274  tio..        :rt
-0001c010: 7970 653a 2066 6c6f 6174 0a20 2020 2020  ype: float.     
-0001c020: 2020 2022 2222 0a20 2020 2020 2020 2023     """.        #
-0001c030: 2043 6865 636b 696e 6720 6966 2074 6865   Checking if the
-0001c040: 2075 7365 7220 7061 7373 6564 2061 6e79   user passed any
-0001c050: 2065 6e65 7267 7920 6c69 6d69 7473 206f   energy limits o
-0001c060: 6620 7468 6569 7220 6f77 6e0a 2020 2020  f their own.    
-0001c070: 2020 2020 6966 206c 6f5f 656e 2069 7320      if lo_en is 
-0001c080: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0001c090: 2020 6c6f 5f65 6e20 3d20 7365 6c66 2e5f    lo_en = self._
-0001c0a0: 7065 616b 5f6c 6f5f 656e 0a20 2020 2020  peak_lo_en.     
-0001c0b0: 2020 2069 6620 6869 5f65 6e20 6973 204e     if hi_en is N
-0001c0c0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0001c0d0: 2068 695f 656e 203d 2073 656c 662e 5f70   hi_en = self._p
-0001c0e0: 6561 6b5f 6869 5f65 6e0a 0a20 2020 2020  eak_hi_en..     
-0001c0f0: 2020 2023 2050 6172 7369 6e67 2074 6865     # Parsing the
-0001c100: 204f 6273 4944 2061 6e64 2069 6e73 7472   ObsID and instr
-0001c110: 756d 656e 7420 6f70 7469 6f6e 732c 2073  ument options, s
-0001c120: 6565 2069 6620 7468 6579 2077 616e 7420  ee if they want 
-0001c130: 746f 2075 7365 2061 2073 7065 6369 6669  to use a specifi
-0001c140: 6320 7261 7465 6d61 700a 2020 2020 2020  c ratemap.      
-0001c150: 2020 6966 2061 6c6c 285b 6f62 735f 6964    if all([obs_id
-0001c160: 2069 7320 4e6f 6e65 2c20 696e 7374 2069   is None, inst i
-0001c170: 7320 4e6f 6e65 5d29 3a0a 2020 2020 2020  s None]):.      
-0001c180: 2020 2020 2020 2320 4865 7265 2074 6865        # Here the
-0001c190: 2075 7365 7220 6861 736e 2774 2073 6574   user hasn't set
-0001c1a0: 204f 6273 4944 206f 7220 696e 7374 7275   ObsID or instru
-0001c1b0: 6d65 6e74 2c20 736f 2077 6520 7573 6520  ment, so we use 
-0001c1c0: 7468 6520 636f 6d62 696e 6564 2064 6174  the combined dat
-0001c1d0: 610a 2020 2020 2020 2020 2020 2020 7274  a.            rt
-0001c1e0: 203d 2073 656c 662e 6765 745f 636f 6d62   = self.get_comb
-0001c1f0: 696e 6564 5f72 6174 656d 6170 7328 6c6f  ined_ratemaps(lo
-0001c200: 5f65 6e2c 2068 695f 656e 2c20 7073 665f  _en, hi_en, psf_
-0001c210: 636f 7272 2c20 7073 665f 6d6f 6465 6c2c  corr, psf_model,
-0001c220: 2070 7366 5f62 696e 732c 2070 7366 5f61   psf_bins, psf_a
-0001c230: 6c67 6f2c 2070 7366 5f69 7465 7229 0a0a  lgo, psf_iter)..
-0001c240: 2020 2020 2020 2020 656c 6966 2061 6c6c          elif all
-0001c250: 285b 6f62 735f 6964 2069 7320 6e6f 7420  ([obs_id is not 
-0001c260: 4e6f 6e65 2c20 696e 7374 2069 7320 6e6f  None, inst is no
-0001c270: 7420 4e6f 6e65 5d29 3a0a 2020 2020 2020  t None]):.      
-0001c280: 2020 2020 2020 2320 426f 7468 204f 6273        # Both Obs
-0001c290: 4944 2061 6e64 2069 6e73 7472 756d 656e  ID and instrumen
-0001c2a0: 7420 6861 7665 2062 6565 6e20 7365 7420  t have been set 
-0001c2b0: 6279 2074 6865 2075 7365 720a 2020 2020  by the user.    
-0001c2c0: 2020 2020 2020 2020 7274 203d 2073 656c          rt = sel
-0001c2d0: 662e 6765 745f 7261 7465 6d61 7073 286f  f.get_ratemaps(o
-0001c2e0: 6273 5f69 642c 2069 6e73 742c 206c 6f5f  bs_id, inst, lo_
-0001c2f0: 656e 2c20 6869 5f65 6e2c 2070 7366 5f63  en, hi_en, psf_c
-0001c300: 6f72 722c 2070 7366 5f6d 6f64 656c 2c20  orr, psf_model, 
-0001c310: 7073 665f 6269 6e73 2c20 7073 665f 616c  psf_bins, psf_al
-0001c320: 676f 2c20 7073 665f 6974 6572 290a 2020  go, psf_iter).  
-0001c330: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0001c340: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
-0001c350: 6c75 6545 7272 6f72 2822 4966 2079 6f75  lueError("If you
-0001c360: 2077 6973 6820 746f 2075 7365 2061 2073   wish to use a s
-0001c370: 7065 6369 6669 6320 7261 7465 6d61 7020  pecific ratemap 
-0001c380: 666f 7220 7b73 7d27 7320 7369 676e 616c  for {s}'s signal
-0001c390: 2074 6f20 6e6f 6973 6520 6361 6c63 756c   to noise calcul
-0001c3a0: 6174 696f 6e2c 2070 6c65 6173 6520 220a  ation, please ".
-0001c3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c3c0: 2020 2020 2020 2020 2020 2020 2022 2070               " p
-0001c3d0: 6173 7320 626f 7468 206f 6273 5f69 6420  ass both obs_id 
-0001c3e0: 616e 6420 696e 7374 2e22 2e66 6f72 6d61  and inst.".forma
-0001c3f0: 7428 733d 7365 6c66 2e6e 616d 6529 290a  t(s=self.name)).
-0001c400: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
-0001c410: 7374 616e 6365 286f 7574 6572 5f72 6164  stance(outer_rad
-0001c420: 6975 732c 2073 7472 293a 0a20 2020 2020  ius, str):.     
-0001c430: 2020 2020 2020 2023 2047 7261 6273 2074         # Grabs t
-0001c440: 6865 2069 6e74 6572 6c6f 7065 7220 7265  he interloper re
-0001c450: 6d6f 7665 6420 736f 7572 6365 2061 6e64  moved source and
-0001c460: 2062 6163 6b67 726f 756e 6420 7265 6769   background regi
-0001c470: 6f6e 206d 6173 6b73 2e20 4966 2074 6865  on masks. If the
-0001c480: 204f 6273 4944 2069 7320 4e6f 6e65 2074   ObsID is None t
-0001c490: 6865 2067 6574 5f6d 6173 6b0a 2020 2020  he get_mask.    
-0001c4a0: 2020 2020 2020 2020 2320 206d 6574 686f          #  metho
-0001c4b0: 6420 756e 6465 7273 7461 6e64 7320 7468  d understands th
-0001c4c0: 6174 206d 6561 6e73 2069 7420 7368 6f75  at means it shou
-0001c4d0: 6c64 2072 6574 7572 6e20 7468 6520 6d61  ld return the ma
-0001c4e0: 736b 2066 6f72 2074 6865 2063 6f6d 6269  sk for the combi
-0001c4f0: 6e65 6420 6461 7461 0a20 2020 2020 2020  ned data.       
-0001c500: 2020 2020 2073 7263 5f6d 6173 6b2c 2062       src_mask, b
-0001c510: 636b 5f6d 6173 6b20 3d20 7365 6c66 2e67  ck_mask = self.g
-0001c520: 6574 5f6d 6173 6b28 6f75 7465 725f 7261  et_mask(outer_ra
-0001c530: 6469 7573 2c20 6f62 735f 6964 2c20 6365  dius, obs_id, ce
-0001c540: 6e74 7261 6c5f 636f 6f72 6429 0a20 2020  ntral_coord).   
-0001c550: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0001c560: 2020 2020 2020 2023 2048 6572 6520 7765         # Here we
-0001c570: 2068 6176 6520 7468 6520 6361 7365 2077   have the case w
-0001c580: 6865 7265 2074 6865 2075 7365 7220 6861  here the user ha
-0001c590: 7320 7061 7373 6564 2061 2063 7573 746f  s passed a custo
-0001c5a0: 6d20 6f75 7465 7220 7261 6469 7573 2c20  m outer radius, 
-0001c5b0: 736f 2077 6520 6e65 6564 2074 6f20 6765  so we need to ge
-0001c5c0: 6e65 7261 7465 2061 0a20 2020 2020 2020  nerate a.       
-0001c5d0: 2020 2020 2023 2020 6375 7374 6f6d 206d       #  custom m
-0001c5e0: 6173 6b20 666f 7220 6974 0a20 2020 2020  ask for it.     
-0001c5f0: 2020 2020 2020 2073 7263 5f6d 6173 6b20         src_mask 
-0001c600: 3d20 7365 6c66 2e67 6574 5f63 7573 746f  = self.get_custo
-0001c610: 6d5f 6d61 736b 286f 7574 6572 5f72 6164  m_mask(outer_rad
-0001c620: 6975 732c 206f 6273 5f69 643d 6f62 735f  ius, obs_id=obs_
-0001c630: 6964 2c20 6365 6e74 7261 6c5f 636f 6f72  id, central_coor
-0001c640: 643d 6365 6e74 7261 6c5f 636f 6f72 6429  d=central_coord)
-0001c650: 0a20 2020 2020 2020 2020 2020 2062 636b  .            bck
-0001c660: 5f6d 6173 6b20 3d20 7365 6c66 2e67 6574  _mask = self.get
-0001c670: 5f63 7573 746f 6d5f 6d61 736b 286f 7574  _custom_mask(out
-0001c680: 6572 5f72 6164 6975 732a 7365 6c66 2e5f  er_radius*self._
-0001c690: 6261 636b 5f6f 7574 5f66 6163 746f 722c  back_out_factor,
-0001c6a0: 206f 7574 6572 5f72 6164 6975 732a 7365   outer_radius*se
-0001c6b0: 6c66 2e5f 6261 636b 5f69 6e6e 5f66 6163  lf._back_inn_fac
-0001c6c0: 746f 722c 0a20 2020 2020 2020 2020 2020  tor,.           
-0001c6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c6f0: 206f 6273 5f69 643d 6f62 735f 6964 2c20   obs_id=obs_id, 
-0001c700: 6365 6e74 7261 6c5f 636f 6f72 643d 6365  central_coord=ce
-0001c710: 6e74 7261 6c5f 636f 6f72 6429 0a0a 2020  ntral_coord)..  
-0001c720: 2020 2020 2020 2320 5765 2075 7365 2074        # We use t
-0001c730: 6865 2072 6174 656d 6170 2773 2062 7569  he ratemap's bui
-0001c740: 6c74 2069 6e20 7369 676e 616c 2074 6f20  lt in signal to 
-0001c750: 6e6f 6973 6520 6361 6c63 756c 6174 696f  noise calculatio
-0001c760: 6e20 6d65 7468 6f64 0a20 2020 2020 2020  n method.       
-0001c770: 2073 6e20 3d20 7274 2e73 6967 6e61 6c5f   sn = rt.signal_
-0001c780: 746f 5f6e 6f69 7365 2873 7263 5f6d 6173  to_noise(src_mas
-0001c790: 6b2c 2062 636b 5f6d 6173 6b2c 2065 7870  k, bck_mask, exp
-0001c7a0: 5f63 6f72 722c 2061 6c6c 6f77 5f6e 6567  _corr, allow_neg
-0001c7b0: 6174 6976 6529 0a0a 2020 2020 2020 2020  ative)..        
-0001c7c0: 7265 7475 726e 2073 6e0a 0a20 2020 2064  return sn..    d
-0001c7d0: 6566 2067 6574 5f63 6f75 6e74 7328 7365  ef get_counts(se
-0001c7e0: 6c66 2c20 6f75 7465 725f 7261 6469 7573  lf, outer_radius
-0001c7f0: 3a20 556e 696f 6e5b 5175 616e 7469 7479  : Union[Quantity
-0001c800: 2c20 7374 725d 2c20 6365 6e74 7261 6c5f  , str], central_
-0001c810: 636f 6f72 643a 2051 7561 6e74 6974 7920  coord: Quantity 
-0001c820: 3d20 4e6f 6e65 2c20 6c6f 5f65 6e3a 2051  = None, lo_en: Q
-0001c830: 7561 6e74 6974 7920 3d20 4e6f 6e65 2c0a  uantity = None,.
+00016d30: 2020 2073 656c 662e 5f73 7570 705f 7761     self._supp_wa
+00016d40: 726e 2e61 7070 656e 6428 7761 726e 5f74  rn.append(warn_t
+00016d50: 6578 7429 0a0a 2020 2020 2020 2020 2020  ext)..          
+00016d60: 2020 2020 2020 2020 2020 656c 6966 206c            elif l
+00016d70: 656e 2869 6e74 6572 696d 5f72 6567 2920  en(interim_reg) 
+00016d80: 3e20 3120 616e 6420 736f 7572 6365 5f74  > 1 and source_t
+00016d90: 7970 6520 3d3d 2022 6578 7422 3a0a 2020  ype == "ext":.  
+00016da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016db0: 2020 2020 2020 7261 6973 6520 4d75 6c74        raise Mult
+00016dc0: 6970 6c65 4d61 7463 6845 7272 6f72 2822  ipleMatchError("
+00016dd0: 4d6f 7265 2074 6861 6e20 6f6e 6520 6d61  More than one ma
+00016de0: 7463 6820 666f 7220 7b6e 7d20 6973 2066  tch for {n} is f
+00016df0: 6f75 6e64 2069 6e20 7468 6520 7265 6769  ound in the regi
+00016e00: 6f6e 2066 696c 6520 220a 2020 2020 2020  on file ".      
+00016e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016e30: 2020 2020 2020 2020 2020 2022 666f 7220             "for 
+00016e40: 6f62 7365 7276 6174 696f 6e20 7b6f 7d2c  observation {o},
+00016e50: 2074 6869 7320 6361 6e6e 6f74 2079 6574   this cannot yet
+00016e60: 2062 6520 6465 616c 7420 7769 7468 2022   be dealt with "
+00016e70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016ea0: 2020 2266 6f72 2065 7874 656e 6465 6420    "for extended 
+00016eb0: 736f 7572 6365 732e 222e 666f 726d 6174  sources.".format
+00016ec0: 286f 3d6f 6273 2c20 6e3d 7365 6c66 2e6e  (o=obs, n=self.n
+00016ed0: 616d 6529 290a 0a20 2020 2020 2020 2020  ame))..         
+00016ee0: 2020 2020 2020 2023 2041 6c74 206d 6174         # Alt mat
+00016ef0: 6368 2069 7320 7573 6564 2066 6f72 2077  ch is used for w
+00016f00: 6865 6e20 7468 6572 6520 6973 2061 2073  hen there is a s
+00016f10: 6563 6f6e 6461 7279 206d 6174 6368 2074  econdary match t
+00016f20: 6f20 6120 706f 696e 7420 736f 7572 6365  o a point source
+00016f30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016f40: 2061 6c74 5f6d 6174 6368 5f72 6567 203d   alt_match_reg =
+00016f50: 205b 656e 7472 7920 666f 7220 656e 7472   [entry for entr
+00016f60: 7920 696e 2069 6e69 745f 7265 6769 6f6e  y in init_region
+00016f70: 5f6d 6174 6368 6573 2069 6620 656e 7472  _matches if entr
+00016f80: 7920 213d 2072 6573 756c 7473 5f64 6963  y != results_dic
+00016f90: 745b 6f62 735d 5d0a 2020 2020 2020 2020  t[obs]].        
+00016fa0: 2020 2020 2020 2020 616c 745f 6d61 7463          alt_matc
+00016fb0: 685f 6469 6374 5b6f 6273 5d20 3d20 616c  h_dict[obs] = al
+00016fc0: 745f 6d61 7463 685f 7265 670a 0a20 2020  t_match_reg..   
+00016fd0: 2020 2020 2020 2020 2020 2020 2023 2054               # T
+00016fe0: 6865 7365 2061 7265 2061 6c6c 2074 6865  hese are all the
+00016ff0: 2073 6f75 7263 6573 2074 6861 7420 6172   sources that ar
+00017000: 656e 2774 2061 206d 6174 6368 2c20 616e  en't a match, an
+00017010: 6420 736f 2073 686f 756c 6420 6265 2072  d so should be r
+00017020: 656d 6f76 6564 2066 726f 6d20 616e 7920  emoved from any 
+00017030: 616e 616c 7973 6973 0a20 2020 2020 2020  analysis.       
+00017040: 2020 2020 2020 2020 206e 6f74 5f73 6f75           not_sou
+00017050: 7263 655f 7265 6720 3d20 5b72 6567 2066  rce_reg = [reg f
+00017060: 6f72 2072 6567 2069 6e20 7365 6c66 2e5f  or reg in self._
+00017070: 696e 6974 6961 6c5f 7265 6769 6f6e 735b  initial_regions[
+00017080: 6f62 735d 2069 6620 7265 6720 213d 2072  obs] if reg != r
+00017090: 6573 756c 7473 5f64 6963 745b 6f62 735d  esults_dict[obs]
+000170a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000170b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000170c0: 2020 2061 6e64 2072 6567 206e 6f74 2069     and reg not i
+000170d0: 6e20 616c 745f 6d61 7463 685f 7265 675d  n alt_match_reg]
+000170e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000170f0: 2061 6e74 695f 7265 7375 6c74 735f 6469   anti_results_di
+00017100: 6374 5b6f 6273 5d20 3d20 6e6f 745f 736f  ct[obs] = not_so
+00017110: 7572 6365 5f72 6567 0a0a 2020 2020 2020  urce_reg..      
+00017120: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00017130: 2020 2020 2020 2020 2020 2020 7265 7375              resu
+00017140: 6c74 735f 6469 6374 5b6f 6273 5d20 3d20  lts_dict[obs] = 
+00017150: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+00017160: 2020 2020 2061 6c74 5f6d 6174 6368 5f64       alt_match_d
+00017170: 6963 745b 6f62 735d 203d 205b 5d0a 2020  ict[obs] = [].  
+00017180: 2020 2020 2020 2020 2020 2020 2020 616e                an
+00017190: 7469 5f72 6573 756c 7473 5f64 6963 745b  ti_results_dict[
+000171a0: 6f62 735d 203d 205b 5d0a 0a20 2020 2020  obs] = []..     
+000171b0: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
+000171c0: 735f 6469 6374 2c20 616c 745f 6d61 7463  s_dict, alt_matc
+000171d0: 685f 6469 6374 2c20 616e 7469 5f72 6573  h_dict, anti_res
+000171e0: 756c 7473 5f64 6963 740a 0a20 2020 2040  ults_dict..    @
+000171f0: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
+00017200: 2064 6574 6563 7465 6428 7365 6c66 2920   detected(self) 
+00017210: 2d3e 2064 6963 743a 0a20 2020 2020 2020  -> dict:.       
+00017220: 2022 2222 0a20 2020 2020 2020 2041 2070   """.        A p
+00017230: 726f 7065 7274 7920 6765 7474 6572 2074  roperty getter t
+00017240: 6f20 7265 7475 726e 2069 6620 6120 6d61  o return if a ma
+00017250: 7463 6820 6f66 2074 6865 2063 6f72 7265  tch of the corre
+00017260: 6374 2074 7970 6520 6861 7320 6265 656e  ct type has been
+00017270: 2066 6f75 6e64 2e0a 0a20 2020 2020 2020   found...       
+00017280: 203a 7265 7475 726e 3a20 5468 6520 6465   :return: The de
+00017290: 7465 6374 6564 2062 6f6f 6c65 616e 2061  tected boolean a
+000172a0: 7474 7269 6275 7465 2e0a 2020 2020 2020  ttribute..      
+000172b0: 2020 3a72 7479 7065 3a20 626f 6f6c 0a20    :rtype: bool. 
+000172c0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+000172d0: 2020 2069 6620 7365 6c66 2e5f 6465 7465     if self._dete
+000172e0: 6374 6564 2069 7320 4e6f 6e65 3a0a 2020  cted is None:.  
+000172f0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00017300: 5661 6c75 6545 7272 6f72 2822 6465 7465  ValueError("dete
+00017310: 6374 6564 2069 7320 6375 7272 656e 746c  cted is currentl
+00017320: 7920 4e6f 6e65 2c20 4261 7365 536f 7572  y None, BaseSour
+00017330: 6365 206f 626a 6563 7473 2064 6f6e 2774  ce objects don't
+00017340: 2068 6176 6520 7468 6520 7479 7065 2022   have the type "
+00017350: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017360: 2020 2020 2020 2020 2020 2020 2020 2263                "c
+00017370: 6f6e 7465 7874 206e 6565 6465 6420 746f  ontext needed to
+00017380: 2064 6566 696e 6520 6966 2074 6865 2073   define if the s
+00017390: 6f75 7263 6520 6973 2064 6574 6563 7465  ource is detecte
+000173a0: 6420 6f72 206e 6f74 2e22 290a 2020 2020  d or not.").    
+000173b0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000173c0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+000173d0: 662e 5f64 6574 6563 7465 640a 0a20 2020  f._detected..   
+000173e0: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
+000173f0: 6566 206d 6174 6368 6564 5f72 6567 696f  ef matched_regio
+00017400: 6e73 2873 656c 6629 202d 3e20 6469 6374  ns(self) -> dict
+00017410: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+00017420: 2020 2020 2020 5072 6f70 6572 7479 2067        Property g
+00017430: 6574 7465 7220 666f 7220 7468 6520 6d61  etter for the ma
+00017440: 7463 6865 6420 7265 6769 6f6e 7320 6173  tched regions as
+00017450: 736f 6369 6174 6564 2077 6974 6820 7468  sociated with th
+00017460: 6973 2070 6172 7469 6375 6c61 7220 736f  is particular so
+00017470: 7572 6365 2e0a 0a20 2020 2020 2020 203a  urce...        :
+00017480: 7265 7475 726e 3a20 4120 6469 6374 696f  return: A dictio
+00017490: 6e61 7279 206f 6620 6d61 7463 6869 6e67  nary of matching
+000174a0: 2072 6567 696f 6e73 2c20 6f72 204e 6f6e   regions, or Non
+000174b0: 6520 6966 2073 7563 6820 6120 6d61 7463  e if such a matc
+000174c0: 6820 6861 7320 6e6f 7420 6265 656e 2070  h has not been p
+000174d0: 6572 666f 726d 6564 2e0a 2020 2020 2020  erformed..      
+000174e0: 2020 3a72 7479 7065 3a20 6469 6374 0a20    :rtype: dict. 
+000174f0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00017500: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
+00017510: 7265 6769 6f6e 730a 0a20 2020 2064 6566  regions..    def
+00017520: 2073 6f75 7263 655f 6261 636b 5f72 6567   source_back_reg
+00017530: 696f 6e73 2873 656c 662c 2072 6567 5f74  ions(self, reg_t
+00017540: 7970 653a 2073 7472 2c20 6f62 735f 6964  ype: str, obs_id
+00017550: 3a20 7374 7220 3d20 4e6f 6e65 2c20 6365  : str = None, ce
+00017560: 6e74 7261 6c5f 636f 6f72 643a 2051 7561  ntral_coord: Qua
+00017570: 6e74 6974 7920 3d20 4e6f 6e65 2920 5c0a  ntity = None) \.
+00017580: 2020 2020 2020 2020 2020 2020 2d3e 2054              -> T
+00017590: 7570 6c65 5b53 6b79 5265 6769 6f6e 2c20  uple[SkyRegion, 
+000175a0: 536b 7952 6567 696f 6e5d 3a0a 2020 2020  SkyRegion]:.    
+000175b0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+000175c0: 4120 6d65 7468 6f64 2074 6f20 7265 7472  A method to retr
+000175d0: 6965 7665 2073 6f75 7263 6520 7265 6769  ieve source regi
+000175e0: 6f6e 2061 6e64 2062 6163 6b67 726f 756e  on and backgroun
+000175f0: 6420 7265 6769 6f6e 206f 626a 6563 7473  d region objects
+00017600: 2066 6f72 2061 2067 6976 656e 2073 6f75   for a given sou
+00017610: 7263 6520 7479 7065 2077 6974 6820 610a  rce type with a.
+00017620: 2020 2020 2020 2020 6769 7665 6e20 6365          given ce
+00017630: 6e74 7261 6c20 636f 6f72 6469 6e61 7465  ntral coordinate
+00017640: 2e0a 0a20 2020 2020 2020 203a 7061 7261  ...        :para
+00017650: 6d20 7374 7220 7265 675f 7479 7065 3a20  m str reg_type: 
+00017660: 5468 6520 7479 7065 206f 6620 7265 6769  The type of regi
+00017670: 6f6e 2077 6869 6368 2077 6520 7769 7368  on which we wish
+00017680: 2074 6f20 6765 7420 6672 6f6d 2074 6865   to get from the
+00017690: 2073 6f75 7263 652e 0a20 2020 2020 2020   source..       
+000176a0: 203a 7061 7261 6d20 7374 7220 6f62 735f   :param str obs_
+000176b0: 6964 3a20 5468 6520 4f62 7349 4420 7468  id: The ObsID th
+000176c0: 6174 2074 6865 2072 6567 696f 6e20 6973  at the region is
+000176d0: 2061 7373 6f63 6961 7465 6420 7769 7468   associated with
+000176e0: 2028 6966 2061 7070 726f 7072 6961 7465   (if appropriate
+000176f0: 292e 0a20 2020 2020 2020 203a 7061 7261  )..        :para
+00017700: 6d20 5175 616e 7469 7479 2063 656e 7472  m Quantity centr
+00017710: 616c 5f63 6f6f 7264 3a20 5468 6520 6365  al_coord: The ce
+00017720: 6e74 7261 6c20 636f 6f72 6469 6e61 7465  ntral coordinate
+00017730: 206f 6620 7468 6520 7265 6769 6f6e 2e0a   of the region..
+00017740: 2020 2020 2020 2020 3a72 6574 7572 6e3a          :return:
+00017750: 2054 6865 206d 6574 686f 6420 7265 7475   The method retu
+00017760: 726e 7320 626f 7468 2074 6865 2073 6f75  rns both the sou
+00017770: 7263 6520 7265 6769 6f6e 2061 6e64 2074  rce region and t
+00017780: 6865 2061 7373 6f63 6961 7465 6420 6261  he associated ba
+00017790: 636b 6772 6f75 6e64 2072 6567 696f 6e2e  ckground region.
+000177a0: 0a20 2020 2020 2020 203a 7274 7970 653a  .        :rtype:
+000177b0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+000177c0: 2020 2020 2023 2044 6f69 6e67 2061 6e20       # Doing an 
+000177d0: 696e 6974 6961 6c20 6368 6563 6b20 736f  initial check so
+000177e0: 2049 2063 616e 2074 6872 6f77 2061 2077   I can throw a w
+000177f0: 6172 6e69 6e67 2069 6620 7468 6520 7573  arning if the us
+00017800: 6572 2077 616e 7473 2061 2072 6567 696f  er wants a regio
+00017810: 6e2d 6c69 7374 2072 6567 696f 6e20 414e  n-list region AN
+00017820: 4420 6861 7320 7375 7070 6c69 6564 0a20  D has supplied. 
+00017830: 2020 2020 2020 2023 2020 6375 7374 6f6d         #  custom
+00017840: 2063 656e 7472 616c 2063 6f6f 7264 696e   central coordin
+00017850: 6174 6573 0a20 2020 2020 2020 2069 6620  ates.        if 
+00017860: 7265 675f 7479 7065 203d 3d20 2272 6567  reg_type == "reg
+00017870: 696f 6e22 2061 6e64 2063 656e 7472 616c  ion" and central
+00017880: 5f63 6f6f 7264 2069 7320 6e6f 7420 4e6f  _coord is not No
+00017890: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+000178a0: 7761 726e 2822 596f 7520 6361 6e6e 6f74  warn("You cannot
+000178b0: 2075 7365 2063 7573 746f 6d20 6365 6e74   use custom cent
+000178c0: 7261 6c20 636f 6f72 6469 6e61 7465 7320  ral coordinates 
+000178d0: 7769 7468 2061 2072 6567 696f 6e20 6672  with a region fr
+000178e0: 6f6d 2073 7570 706c 6965 6420 7265 6769  om supplied regi
+000178f0: 6f6e 2066 696c 6573 222c 2073 7461 636b  on files", stack
+00017900: 6c65 7665 6c3d 3229 0a0a 2020 2020 2020  level=2)..      
+00017910: 2020 6966 2063 656e 7472 616c 5f63 6f6f    if central_coo
+00017920: 7264 2069 7320 4e6f 6e65 3a0a 2020 2020  rd is None:.    
+00017930: 2020 2020 2020 2020 6365 6e74 7261 6c5f          central_
+00017940: 636f 6f72 6420 3d20 7365 6c66 2e5f 6465  coord = self._de
+00017950: 6661 756c 745f 636f 6f72 640a 0a20 2020  fault_coord..   
+00017960: 2020 2020 2069 6620 7479 7065 2863 656e       if type(cen
+00017970: 7472 616c 5f63 6f6f 7264 2920 3d3d 2051  tral_coord) == Q
+00017980: 7561 6e74 6974 793a 0a20 2020 2020 2020  uantity:.       
+00017990: 2020 2020 2063 656e 7472 6520 3d20 536b       centre = Sk
+000179a0: 7943 6f6f 7264 282a 6365 6e74 7261 6c5f  yCoord(*central_
+000179b0: 636f 6f72 642e 746f 2822 6465 6722 2929  coord.to("deg"))
+000179c0: 0a20 2020 2020 2020 2065 6c69 6620 7479  .        elif ty
+000179d0: 7065 2863 656e 7472 616c 5f63 6f6f 7264  pe(central_coord
+000179e0: 2920 3d3d 2053 6b79 436f 6f72 643a 0a20  ) == SkyCoord:. 
+000179f0: 2020 2020 2020 2020 2020 2063 656e 7472             centr
+00017a00: 6520 3d20 6365 6e74 7261 6c5f 636f 6f72  e = central_coor
+00017a10: 640a 2020 2020 2020 2020 656c 7365 3a0a  d.        else:.
+00017a20: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00017a30: 6520 5479 7065 4572 726f 7228 2263 656e  e TypeError("cen
+00017a40: 7472 616c 5f63 6f6f 7264 206d 7573 7420  tral_coord must 
+00017a50: 6265 206f 6620 7479 7065 2051 7561 6e74  be of type Quant
+00017a60: 6974 7920 6f72 2053 6b79 436f 6f72 642e  ity or SkyCoord.
+00017a70: 2229 0a0a 2020 2020 2020 2020 2320 496e  ")..        # In
+00017a80: 2063 6173 6520 636f 6d62 696e 6564 2067   case combined g
+00017a90: 6574 7320 7061 7373 6564 2061 7320 7468  ets passed as th
+00017aa0: 6520 4f62 7349 4420 6174 2061 6e79 2070  e ObsID at any p
+00017ab0: 6f69 6e74 0a20 2020 2020 2020 2069 6620  oint.        if 
+00017ac0: 6f62 735f 6964 203d 3d20 2263 6f6d 6269  obs_id == "combi
+00017ad0: 6e65 6422 3a0a 2020 2020 2020 2020 2020  ned":.          
+00017ae0: 2020 6f62 735f 6964 203d 204e 6f6e 650a    obs_id = None.
+00017af0: 0a20 2020 2020 2020 2023 2054 6865 2073  .        # The s
+00017b00: 6561 7263 6820 7261 6469 7573 2077 6f6e  earch radius won
+00017b10: 2774 2062 6520 7573 6564 2062 7920 7468  't be used by th
+00017b20: 6520 7573 6572 2c20 6a75 7374 2070 6561  e user, just pea
+00017b30: 6b20 6669 6e64 696e 6720 736f 6c75 7469  k finding soluti
+00017b40: 6f6e 730a 2020 2020 2020 2020 616c 6c6f  ons.        allo
+00017b50: 7765 645f 7274 7970 6520 3d20 5b22 7232  wed_rtype = ["r2
+00017b60: 3530 3022 2c20 2272 3530 3022 2c20 2272  500", "r500", "r
+00017b70: 3230 3022 2c20 2272 6567 696f 6e22 2c20  200", "region", 
+00017b80: 2263 7573 746f 6d22 2c20 2273 6561 7263  "custom", "searc
+00017b90: 6822 2c20 2270 6f69 6e74 225d 0a20 2020  h", "point"].   
+00017ba0: 2020 2020 2069 6620 7479 7065 2873 656c       if type(sel
+00017bb0: 6629 203d 3d20 4261 7365 536f 7572 6365  f) == BaseSource
+00017bc0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+00017bd0: 6973 6520 5479 7065 4572 726f 7228 2242  ise TypeError("B
+00017be0: 6173 6553 6f75 7263 6520 636c 6173 7320  aseSource class 
+00017bf0: 646f 6573 206e 6f74 2068 6176 6520 7468  does not have th
+00017c00: 6520 6e65 6365 7373 6172 7920 696e 666f  e necessary info
+00017c10: 726d 6174 696f 6e20 220a 2020 2020 2020  rmation ".      
+00017c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017c30: 2020 2020 2020 2274 6f20 7365 6c65 6374        "to select
+00017c40: 2061 2073 6f75 7263 6520 7265 6769 6f6e   a source region
+00017c50: 2e22 290a 2020 2020 2020 2020 656c 6966  .").        elif
+00017c60: 206f 6273 5f69 6420 6973 206e 6f74 204e   obs_id is not N
+00017c70: 6f6e 6520 616e 6420 6f62 735f 6964 206e  one and obs_id n
+00017c80: 6f74 2069 6e20 7365 6c66 2e6f 6273 5f69  ot in self.obs_i
+00017c90: 6473 3a0a 2020 2020 2020 2020 2020 2020  ds:.            
+00017ca0: 7261 6973 6520 4e6f 7441 7373 6f63 6961  raise NotAssocia
+00017cb0: 7465 6445 7272 6f72 2822 5468 6520 4f62  tedError("The Ob
+00017cc0: 7349 4420 7b6f 7d20 6973 206e 6f74 2061  sID {o} is not a
+00017cd0: 7373 6f63 6961 7465 6420 7769 7468 207b  ssociated with {
+00017ce0: 737d 2e22 2e66 6f72 6d61 7428 6f3d 6f62  s}.".format(o=ob
+00017cf0: 735f 6964 2c20 733d 7365 6c66 2e6e 616d  s_id, s=self.nam
+00017d00: 6529 290a 2020 2020 2020 2020 656c 6966  e)).        elif
+00017d10: 2072 6567 5f74 7970 6520 6e6f 7420 696e   reg_type not in
+00017d20: 2061 6c6c 6f77 6564 5f72 7479 7065 3a0a   allowed_rtype:.
+00017d30: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00017d40: 6520 5661 6c75 6545 7272 6f72 2822 5468  e ValueError("Th
+00017d50: 6520 6f6e 6c79 2061 6c6c 6f77 6564 2072  e only allowed r
+00017d60: 6567 696f 6e20 7479 7065 7320 6172 6520  egion types are 
+00017d70: 7b7d 222e 666f 726d 6174 2822 2c20 222e  {}".format(", ".
+00017d80: 6a6f 696e 2861 6c6c 6f77 6564 5f72 7479  join(allowed_rty
+00017d90: 7065 2929 290a 2020 2020 2020 2020 656c  pe))).        el
+00017da0: 6966 2072 6567 5f74 7970 6520 3d3d 2022  if reg_type == "
+00017db0: 7265 6769 6f6e 2220 616e 6420 6f62 735f  region" and obs_
+00017dc0: 6964 2069 7320 4e6f 6e65 3a0a 2020 2020  id is None:.    
+00017dd0: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
+00017de0: 6c75 6545 7272 6f72 2822 4f62 7349 4420  lueError("ObsID 
+00017df0: 6361 6e6e 6f74 2062 6520 4e6f 6e65 2077  cannot be None w
+00017e00: 6865 6e20 6765 7474 696e 6720 7265 6769  hen getting regi
+00017e10: 6f6e 2066 696c 6520 7265 6769 6f6e 732e  on file regions.
+00017e20: 2229 0a20 2020 2020 2020 2065 6c69 6620  ").        elif 
+00017e30: 7265 675f 7479 7065 203d 3d20 2272 6567  reg_type == "reg
+00017e40: 696f 6e22 2061 6e64 206f 6273 5f69 6420  ion" and obs_id 
+00017e50: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00017e60: 2020 2020 2020 2020 2073 7263 5f72 6567           src_reg
+00017e70: 203d 2073 656c 662e 5f72 6567 696f 6e73   = self._regions
+00017e80: 5b6f 6273 5f69 645d 0a20 2020 2020 2020  [obs_id].       
+00017e90: 2065 6c69 6620 7265 675f 7479 7065 2069   elif reg_type i
+00017ea0: 6e20 5b22 7232 3530 3022 2c20 2272 3530  n ["r2500", "r50
+00017eb0: 3022 2c20 2272 3230 3022 5d20 616e 6420  0", "r200"] and 
+00017ec0: 7265 675f 7479 7065 206e 6f74 2069 6e20  reg_type not in 
+00017ed0: 7365 6c66 2e5f 7261 6469 693a 0a20 2020  self._radii:.   
+00017ee0: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
+00017ef0: 616c 7565 4572 726f 7228 2254 6865 7265  alueError("There
+00017f00: 2069 7320 6e6f 207b 727d 2061 7373 6f63   is no {r} assoc
+00017f10: 6961 7465 6420 7769 7468 207b 737d 222e  iated with {s}".
+00017f20: 666f 726d 6174 2872 3d72 6567 5f74 7970  format(r=reg_typ
+00017f30: 652c 2073 3d73 656c 662e 6e61 6d65 2929  e, s=self.name))
+00017f40: 0a20 2020 2020 2020 2065 6c69 6620 7265  .        elif re
+00017f50: 675f 7479 7065 2021 3d20 2272 6567 696f  g_type != "regio
+00017f60: 6e22 2061 6e64 2072 6567 5f74 7970 6520  n" and reg_type 
+00017f70: 696e 2073 656c 662e 5f72 6164 6969 3a0a  in self._radii:.
+00017f80: 2020 2020 2020 2020 2020 2020 2320 5765              # We
+00017f90: 206b 6e6f 7720 666f 7220 6365 7274 6169   know for certai
+00017fa0: 6e20 7468 6174 2074 6865 2072 6164 6975  n that the radiu
+00017fb0: 7320 7769 6c6c 2062 6520 696e 2064 6567  s will be in deg
+00017fc0: 7265 6573 2c20 6275 7420 6974 2068 6173  rees, but it has
+00017fd0: 2074 6f20 6265 2063 6f6e 7665 7274 6564   to be converted
+00017fe0: 2074 6f20 6465 6772 6565 730a 2020 2020   to degrees.    
+00017ff0: 2020 2020 2020 2020 2320 2062 6566 6f72          #  befor
+00018000: 6520 6265 696e 6720 7374 6f72 6564 2069  e being stored i
+00018010: 6e20 7468 6520 7261 6469 6920 6174 7472  n the radii attr
+00018020: 6962 7574 650a 2020 2020 2020 2020 2020  ibute.          
+00018030: 2020 7261 6469 7573 203d 2073 656c 662e    radius = self.
+00018040: 5f72 6164 6969 5b72 6567 5f74 7970 655d  _radii[reg_type]
+00018050: 0a20 2020 2020 2020 2020 2020 2073 7263  .            src
+00018060: 5f72 6567 203d 2043 6972 636c 6553 6b79  _reg = CircleSky
+00018070: 5265 6769 6f6e 2863 656e 7472 652c 2072  Region(centre, r
+00018080: 6164 6975 732e 746f 2827 6465 6727 2929  adius.to('deg'))
+00018090: 0a20 2020 2020 2020 2065 6c69 6620 7265  .        elif re
+000180a0: 675f 7479 7065 2021 3d20 2272 6567 696f  g_type != "regio
+000180b0: 6e22 2061 6e64 2072 6567 5f74 7970 6520  n" and reg_type 
+000180c0: 6e6f 7420 696e 2073 656c 662e 5f72 6164  not in self._rad
+000180d0: 6969 3a0a 2020 2020 2020 2020 2020 2020  ii:.            
+000180e0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+000180f0: 2822 7b7d 2069 7320 6120 7661 6c69 6420  ("{} is a valid 
+00018100: 7265 6769 6f6e 2074 7970 652c 2062 7574  region type, but
+00018110: 2069 7320 6e6f 7420 6173 736f 6369 6174   is not associat
+00018120: 6564 2077 6974 6820 7468 6973 2022 0a20  ed with this ". 
+00018130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018140: 2020 2020 2020 2020 2020 2020 2273 6f75              "sou
+00018150: 7263 652e 222e 666f 726d 6174 2872 6567  rce.".format(reg
+00018160: 5f74 7970 6529 290a 2020 2020 2020 2020  _type)).        
+00018170: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00018180: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+00018190: 6f72 2822 4f48 204e 4f22 290a 0a20 2020  or("OH NO")..   
+000181a0: 2020 2020 2023 2048 6572 6520 6973 2077       # Here is w
+000181b0: 6865 7265 2077 6520 696e 6974 6961 6c69  here we initiali
+000181c0: 7365 2074 6865 2062 6163 6b67 726f 756e  se the backgroun
+000181d0: 6420 7265 6769 6f6e 732c 2066 6972 7374  d regions, first
+000181e0: 2069 6e20 7069 7865 6c20 636f 6f72 6473   in pixel coords
+000181f0: 2c20 7468 656e 2063 6f6e 7665 7274 696e  , then convertin
+00018200: 6720 746f 2072 612d 6465 632e 0a20 2020  g to ra-dec..   
+00018210: 2020 2020 2023 2054 4f44 4f20 5665 7269       # TODO Veri
+00018220: 6679 2074 6861 7420 6a75 7374 2075 7369  fy that just usi
+00018230: 6e67 2074 6865 2066 6972 7374 2069 6d61  ng the first ima
+00018240: 6765 2069 7320 6f6b 6179 0a20 2020 2020  ge is okay.     
+00018250: 2020 2069 6d20 3d20 7365 6c66 2e67 6574     im = self.get
+00018260: 5f70 726f 6475 6374 7328 2269 6d61 6765  _products("image
+00018270: 2229 5b30 5d0a 2020 2020 2020 2020 7372  ")[0].        sr
+00018280: 635f 7069 785f 7265 6720 3d20 7372 635f  c_pix_reg = src_
+00018290: 7265 672e 746f 5f70 6978 656c 2869 6d2e  reg.to_pixel(im.
+000182a0: 7261 6465 635f 7763 7329 0a20 2020 2020  radec_wcs).     
+000182b0: 2020 2023 2054 4f44 4f20 5472 7920 616e     # TODO Try an
+000182c0: 6420 7265 6d65 6d62 6572 2077 6879 2049  d remember why I
+000182d0: 2068 6164 2074 6f20 636f 6e76 6572 7420   had to convert 
+000182e0: 746f 2070 6978 656c 2072 6567 696f 6e73  to pixel regions
+000182f0: 2074 6f20 6d61 6b65 2069 7420 776f 726b   to make it work
+00018300: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
+00018310: 7374 616e 6365 2873 7263 5f72 6567 2c20  stance(src_reg, 
+00018320: 456c 6c69 7073 6553 6b79 5265 6769 6f6e  EllipseSkyRegion
+00018330: 293a 0a20 2020 2020 2020 2020 2020 2023  ):.            #
+00018340: 2048 6572 6520 7765 206d 756c 7469 706c   Here we multipl
+00018350: 7920 7468 6520 696e 6e65 7220 7769 6474  y the inner widt
+00018360: 682f 6865 6967 6874 2062 7920 312e 3035  h/height by 1.05
+00018370: 2028 746f 206a 7573 7420 736c 6967 6874   (to just slight
+00018380: 6c79 2063 6c65 6172 2074 6865 2073 6f75  ly clear the sou
+00018390: 7263 6520 7265 6769 6f6e 292c 0a20 2020  rce region),.   
+000183a0: 2020 2020 2020 2020 2023 2020 616e 6420           #  and 
+000183b0: 7468 6520 6f75 7465 7220 7769 6474 682f  the outer width/
+000183c0: 6865 6967 6874 2062 7920 312e 3520 2873  height by 1.5 (s
+000183d0: 7461 6e64 6172 6420 666f 7220 5843 5329  tandard for XCS)
+000183e0: 202d 2064 6566 6175 6c74 2076 616c 7565   - default value
+000183f0: 730a 2020 2020 2020 2020 2020 2020 2320  s.            # 
+00018400: 4964 6561 6c6c 7920 7468 6973 2077 6f75  Ideally this wou
+00018410: 6c64 2062 6520 616e 2061 6e6e 756c 7573  ld be an annulus
+00018420: 2072 6567 696f 6e2c 2062 7574 2074 6865   region, but the
+00018430: 7920 6172 6520 6275 6767 6564 2069 6e20  y are bugged in 
+00018440: 7265 6769 6f6e 7320 7630 2e34 2c20 736f  regions v0.4, so
+00018450: 2077 6520 6d75 7374 2062 6f64 6765 0a20   we must bodge. 
+00018460: 2020 2020 2020 2020 2020 2069 6e5f 7265             in_re
+00018470: 6720 3d20 456c 6c69 7073 6550 6978 656c  g = EllipsePixel
+00018480: 5265 6769 6f6e 2873 7263 5f70 6978 5f72  Region(src_pix_r
+00018490: 6567 2e63 656e 7465 722c 2073 7263 5f70  eg.center, src_p
+000184a0: 6978 5f72 6567 2e77 6964 7468 202a 2073  ix_reg.width * s
+000184b0: 656c 662e 5f62 6163 6b5f 696e 6e5f 6661  elf._back_inn_fa
+000184c0: 6374 6f72 2c0a 2020 2020 2020 2020 2020  ctor,.          
+000184d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000184e0: 2020 2020 2020 2020 2020 2020 2020 7372                sr
+000184f0: 635f 7069 785f 7265 672e 6865 6967 6874  c_pix_reg.height
+00018500: 202a 2073 656c 662e 5f62 6163 6b5f 696e   * self._back_in
+00018510: 6e5f 6661 6374 6f72 2c20 7372 635f 7069  n_factor, src_pi
+00018520: 785f 7265 672e 616e 676c 6529 0a20 2020  x_reg.angle).   
+00018530: 2020 2020 2020 2020 206f 7574 5f72 6567           out_reg
+00018540: 203d 2045 6c6c 6970 7365 5069 7865 6c52   = EllipsePixelR
+00018550: 6567 696f 6e28 7372 635f 7069 785f 7265  egion(src_pix_re
+00018560: 672e 6365 6e74 6572 2c20 7372 635f 7069  g.center, src_pi
+00018570: 785f 7265 672e 7769 6474 6820 2a20 7365  x_reg.width * se
+00018580: 6c66 2e5f 6261 636b 5f6f 7574 5f66 6163  lf._back_out_fac
+00018590: 746f 722c 0a20 2020 2020 2020 2020 2020  tor,.           
+000185a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000185b0: 2020 2020 2020 2020 2020 2020 2020 7372                sr
+000185c0: 635f 7069 785f 7265 672e 6865 6967 6874  c_pix_reg.height
+000185d0: 202a 2073 656c 662e 5f62 6163 6b5f 6f75   * self._back_ou
+000185e0: 745f 6661 6374 6f72 2c20 7372 635f 7069  t_factor, src_pi
+000185f0: 785f 7265 672e 616e 676c 6529 0a20 2020  x_reg.angle).   
+00018600: 2020 2020 2020 2020 2062 636b 5f72 6567           bck_reg
+00018610: 203d 206f 7574 5f72 6567 2e73 796d 6d65   = out_reg.symme
+00018620: 7472 6963 5f64 6966 6665 7265 6e63 6528  tric_difference(
+00018630: 696e 5f72 6567 290a 2020 2020 2020 2020  in_reg).        
+00018640: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
+00018650: 7372 635f 7265 672c 2043 6972 636c 6553  src_reg, CircleS
+00018660: 6b79 5265 6769 6f6e 293a 0a20 2020 2020  kyRegion):.     
+00018670: 2020 2020 2020 2069 6e5f 7265 6720 3d20         in_reg = 
+00018680: 4369 7263 6c65 5069 7865 6c52 6567 696f  CirclePixelRegio
+00018690: 6e28 7372 635f 7069 785f 7265 672e 6365  n(src_pix_reg.ce
+000186a0: 6e74 6572 2c20 7372 635f 7069 785f 7265  nter, src_pix_re
+000186b0: 672e 7261 6469 7573 202a 2073 656c 662e  g.radius * self.
+000186c0: 5f62 6163 6b5f 696e 6e5f 6661 6374 6f72  _back_inn_factor
+000186d0: 290a 2020 2020 2020 2020 2020 2020 6f75  ).            ou
+000186e0: 745f 7265 6720 3d20 4369 7263 6c65 5069  t_reg = CirclePi
+000186f0: 7865 6c52 6567 696f 6e28 7372 635f 7069  xelRegion(src_pi
+00018700: 785f 7265 672e 6365 6e74 6572 2c20 7372  x_reg.center, sr
+00018710: 635f 7069 785f 7265 672e 7261 6469 7573  c_pix_reg.radius
+00018720: 202a 2073 656c 662e 5f62 6163 6b5f 6f75   * self._back_ou
+00018730: 745f 6661 6374 6f72 290a 2020 2020 2020  t_factor).      
+00018740: 2020 2020 2020 6263 6b5f 7265 6720 3d20        bck_reg = 
+00018750: 6f75 745f 7265 672e 7379 6d6d 6574 7269  out_reg.symmetri
+00018760: 635f 6469 6666 6572 656e 6365 2869 6e5f  c_difference(in_
+00018770: 7265 6729 0a0a 2020 2020 2020 2020 6263  reg)..        bc
+00018780: 6b5f 7265 6720 3d20 6263 6b5f 7265 672e  k_reg = bck_reg.
+00018790: 746f 5f73 6b79 2869 6d2e 7261 6465 635f  to_sky(im.radec_
+000187a0: 7763 7329 0a0a 2020 2020 2020 2020 7265  wcs)..        re
+000187b0: 7475 726e 2073 7263 5f72 6567 2c20 6263  turn src_reg, bc
+000187c0: 6b5f 7265 670a 0a20 2020 2064 6566 2077  k_reg..    def w
+000187d0: 6974 6869 6e5f 7265 6769 6f6e 2873 656c  ithin_region(sel
+000187e0: 662c 2072 6567 696f 6e3a 2053 6b79 5265  f, region: SkyRe
+000187f0: 6769 6f6e 2920 2d3e 204c 6973 745b 536b  gion) -> List[Sk
+00018800: 7952 6567 696f 6e5d 3a0a 2020 2020 2020  yRegion]:.      
+00018810: 2020 2222 220a 2020 2020 2020 2020 5468    """.        Th
+00018820: 6973 206d 6574 686f 6420 6669 6e64 7320  is method finds 
+00018830: 696e 7465 726c 6f70 6572 2073 6f75 7263  interloper sourc
+00018840: 6573 2074 6861 7420 6c69 6520 7769 7468  es that lie with
+00018850: 696e 2074 6865 2075 7365 7220 7375 7070  in the user supp
+00018860: 6c69 6564 2072 6567 696f 6e2e 0a0a 2020  lied region...  
+00018870: 2020 2020 2020 3a70 6172 616d 2053 6b79        :param Sky
+00018880: 5265 6769 6f6e 2072 6567 696f 6e3a 2054  Region region: T
+00018890: 6865 2072 6567 696f 6e20 696e 2077 6869  he region in whi
+000188a0: 6368 2077 6520 7769 7368 2074 6f20 7365  ch we wish to se
+000188b0: 6172 6368 2066 6f72 2069 6e74 6572 6c6f  arch for interlo
+000188c0: 7065 7220 736f 7572 6365 7320 2866 6f72  per sources (for
+000188d0: 2069 6e73 7461 6e63 650a 2020 2020 2020   instance.      
+000188e0: 2020 2020 2020 6120 736f 7572 6365 2072        a source r
+000188f0: 6567 696f 6e20 6f72 2062 6163 6b67 726f  egion or backgro
+00018900: 756e 6420 7265 6769 6f6e 292e 0a20 2020  und region)..   
+00018910: 2020 2020 203a 7265 7475 726e 3a20 4120       :return: A 
+00018920: 6c69 7374 206f 6620 7265 6769 6f6e 7320  list of regions 
+00018930: 7468 6174 206c 6965 2077 6974 6869 6e20  that lie within 
+00018940: 7468 6520 7573 6572 2073 7570 706c 6965  the user supplie
+00018950: 6420 7265 6769 6f6e 2e0a 2020 2020 2020  d region..      
+00018960: 2020 3a72 7479 7065 3a20 4c69 7374 5b53    :rtype: List[S
+00018970: 6b79 5265 6769 6f6e 5d0a 2020 2020 2020  kyRegion].      
+00018980: 2020 2222 220a 2020 2020 2020 2020 696d    """.        im
+00018990: 203d 2073 656c 662e 6765 745f 7072 6f64   = self.get_prod
+000189a0: 7563 7473 2822 696d 6167 6522 295b 305d  ucts("image")[0]
+000189b0: 0a0a 2020 2020 2020 2020 6372 6f73 736f  ..        crosso
+000189c0: 7665 7220 3d20 6e70 2e61 7272 6179 285b  ver = np.array([
+000189d0: 7265 6769 6f6e 2e69 6e74 6572 7365 6374  region.intersect
+000189e0: 696f 6e28 7229 2e74 6f5f 7069 7865 6c28  ion(r).to_pixel(
+000189f0: 696d 2e72 6164 6563 5f77 6373 292e 746f  im.radec_wcs).to
+00018a00: 5f6d 6173 6b28 292e 6461 7461 2e73 756d  _mask().data.sum
+00018a10: 2829 2021 3d20 300a 2020 2020 2020 2020  () != 0.        
+00018a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018a30: 2020 2020 2020 666f 7220 7220 696e 2073        for r in s
+00018a40: 656c 662e 5f69 6e74 6572 6c6f 7065 725f  elf._interloper_
+00018a50: 7265 6769 6f6e 735d 290a 2020 2020 2020  regions]).      
+00018a60: 2020 7265 675f 7769 7468 696e 203d 206e    reg_within = n
+00018a70: 702e 6172 7261 7928 7365 6c66 2e5f 696e  p.array(self._in
+00018a80: 7465 726c 6f70 6572 5f72 6567 696f 6e73  terloper_regions
+00018a90: 295b 6372 6f73 736f 7665 725d 0a0a 2020  )[crossover]..  
+00018aa0: 2020 2020 2020 7265 7475 726e 2072 6567        return reg
+00018ab0: 5f77 6974 6869 6e0a 0a20 2020 2064 6566  _within..    def
+00018ac0: 2067 6574 5f69 6e74 6572 6c6f 7065 725f   get_interloper_
+00018ad0: 7265 6769 6f6e 7328 7365 6c66 2c20 666c  regions(self, fl
+00018ae0: 6174 7465 6e65 643a 2062 6f6f 6c20 3d20  attened: bool = 
+00018af0: 4661 6c73 6529 202d 3e20 556e 696f 6e5b  False) -> Union[
+00018b00: 4c69 7374 2c20 4469 6374 5d3a 0a20 2020  List, Dict]:.   
+00018b10: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00018b20: 2054 6869 7320 6765 7420 6d65 7468 6f64   This get method
+00018b30: 2070 726f 7669 6465 7320 6120 7761 7920   provides a way 
+00018b40: 746f 2061 6363 6573 7320 7468 6520 7265  to access the re
+00018b50: 6769 6f6e 7320 7468 6174 2068 6176 6520  gions that have 
+00018b60: 6265 656e 2064 6573 6967 6e61 7465 6420  been designated 
+00018b70: 6173 2069 6e74 6572 6c6f 7065 7273 2028  as interlopers (
+00018b80: 692e 652e 0a20 2020 2020 2020 206e 6f74  i.e..        not
+00018b90: 2074 6865 2073 6f75 7263 6520 7265 6769   the source regi
+00018ba0: 6f6e 2074 6861 7420 6120 7061 7274 6963  on that a partic
+00018bb0: 756c 6172 2053 6f75 7263 6520 6861 7320  ular Source has 
+00018bc0: 6265 656e 2064 6573 6967 6e61 7465 6420  been designated 
+00018bd0: 746f 2069 6e76 6573 7469 6761 7465 2920  to investigate) 
+00018be0: 666f 7220 616c 6c20 6f62 7365 7276 6174  for all observat
+00018bf0: 696f 6e73 2e0a 2020 2020 2020 2020 5468  ions..        Th
+00018c00: 6579 2063 616e 2065 6974 6865 7220 6265  ey can either be
+00018c10: 2072 6574 7269 6576 6564 2069 6e20 6120   retrieved in a 
+00018c20: 6469 6374 696f 6e61 7279 2077 6974 6820  dictionary with 
+00018c30: 4f62 7349 4473 2061 7320 7468 6520 6b65  ObsIDs as the ke
+00018c40: 7973 2c20 6f72 2061 2066 6c61 7474 656e  ys, or a flatten
+00018c50: 6564 2073 696e 676c 6520 6c69 7374 2077  ed single list w
+00018c60: 6974 6820 6e6f 0a20 2020 2020 2020 204f  ith no.        O
+00018c70: 6273 4944 2063 6f6e 7465 7874 2e0a 0a20  bsID context... 
+00018c80: 2020 2020 2020 203a 7061 7261 6d20 626f         :param bo
+00018c90: 6f6c 2066 6c61 7474 656e 6564 3a20 4966  ol flattened: If
+00018ca0: 2074 7275 6520 7468 656e 2074 6865 2072   true then the r
+00018cb0: 6567 696f 6e73 2061 7265 2072 6574 7572  egions are retur
+00018cc0: 6e65 6420 6173 2061 2073 696e 676c 6520  ned as a single 
+00018cd0: 6c69 7374 206f 6620 7265 6769 6f6e 206f  list of region o
+00018ce0: 626a 6563 7473 2e20 4f74 6865 7277 6973  bjects. Otherwis
+00018cf0: 650a 2020 2020 2020 2020 2020 2020 7468  e.            th
+00018d00: 6579 2061 7265 2072 6574 7572 6e65 6420  ey are returned 
+00018d10: 6173 2061 2064 6963 7469 6f6e 6172 7920  as a dictionary 
+00018d20: 7769 7468 204f 6273 4944 7320 6173 206b  with ObsIDs as k
+00018d30: 6579 732e 2044 6566 6175 6c74 2069 7320  eys. Default is 
+00018d40: 4661 6c73 652e 0a20 2020 2020 2020 203a  False..        :
+00018d50: 7265 7475 726e 3a20 4569 7468 6572 2061  return: Either a
+00018d60: 206c 6973 7420 6f66 2072 6567 696f 6e20   list of region 
+00018d70: 6f62 6a65 6374 732c 206f 7220 6120 6469  objects, or a di
+00018d80: 6374 696f 6e61 7279 2077 6974 6820 4f62  ctionary with Ob
+00018d90: 7349 4473 2061 7320 6b65 7973 2e0a 2020  sIDs as keys..  
+00018da0: 2020 2020 2020 3a72 7479 7065 3a20 556e        :rtype: Un
+00018db0: 696f 6e5b 4c69 7374 2c44 6963 745d 0a20  ion[List,Dict]. 
+00018dc0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00018dd0: 2020 2069 6620 7479 7065 2873 656c 6629     if type(self)
+00018de0: 203d 3d20 4261 7365 536f 7572 6365 3a0a   == BaseSource:.
+00018df0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00018e00: 6520 5479 7065 4572 726f 7228 2242 6173  e TypeError("Bas
+00018e10: 6553 6f75 7263 6520 6f62 6a65 6374 7320  eSource objects 
+00018e20: 646f 6e27 7420 6861 7665 2065 6e6f 7567  don't have enoug
+00018e30: 6820 696e 666f 726d 6174 696f 6e20 746f  h information to
+00018e40: 206b 6e6f 7720 7768 6963 6820 736f 7572   know which sour
+00018e50: 6365 7320 220a 2020 2020 2020 2020 2020  ces ".          
+00018e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018e70: 2020 2261 7265 2069 6e74 6572 6c6f 7065    "are interlope
+00018e80: 7273 2e22 290a 0a20 2020 2020 2020 2023  rs.")..        #
+00018e90: 2049 6620 666c 6174 7465 6e65 6420 7468   If flattened th
+00018ea0: 656e 2061 206c 6973 7420 6973 2072 6574  en a list is ret
+00018eb0: 7572 6e65 6420 7261 7468 6572 2074 6861  urned rather tha
+00018ec0: 6e20 7468 6520 6f72 6967 696e 616c 2064  n the original d
+00018ed0: 6963 7469 6f6e 6172 7920 7769 7468 0a20  ictionary with. 
+00018ee0: 2020 2020 2020 2069 6620 6e6f 7420 666c         if not fl
+00018ef0: 6174 7465 6e65 643a 0a20 2020 2020 2020  attened:.       
+00018f00: 2020 2020 2072 6574 5f72 6567 203d 2073       ret_reg = s
+00018f10: 656c 662e 5f6f 7468 6572 5f72 6567 696f  elf._other_regio
+00018f20: 6e73 0a20 2020 2020 2020 2065 6c73 653a  ns.        else:
+00018f30: 0a20 2020 2020 2020 2020 2020 2023 2049  .            # I
+00018f40: 7465 7261 7465 2074 6872 6f75 6768 2074  terate through t
+00018f50: 6865 204f 6273 4944 7320 696e 2074 6865  he ObsIDs in the
+00018f60: 2064 6963 7469 6f6e 6172 7920 616e 6420   dictionary and 
+00018f70: 6164 6420 7468 6520 7265 7375 6c74 696e  add the resultin
+00018f80: 6720 6c69 7374 7320 746f 6765 7468 6572  g lists together
+00018f90: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00018fa0: 5f72 6567 203d 205b 5d0a 2020 2020 2020  _reg = [].      
+00018fb0: 2020 2020 2020 666f 7220 6f20 696e 2073        for o in s
+00018fc0: 656c 662e 5f6f 7468 6572 5f72 6567 696f  elf._other_regio
+00018fd0: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
+00018fe0: 2020 2020 7265 745f 7265 6720 2b3d 2073      ret_reg += s
+00018ff0: 656c 662e 5f6f 7468 6572 5f72 6567 696f  elf._other_regio
+00019000: 6e73 5b6f 5d0a 0a20 2020 2020 2020 2072  ns[o]..        r
+00019010: 6574 7572 6e20 7265 745f 7265 670a 0a20  eturn ret_reg.. 
+00019020: 2020 2064 6566 2067 6574 5f73 6f75 7263     def get_sourc
+00019030: 655f 6d61 736b 2873 656c 662c 2072 6567  e_mask(self, reg
+00019040: 5f74 7970 653a 2073 7472 2c20 6f62 735f  _type: str, obs_
+00019050: 6964 3a20 7374 7220 3d20 4e6f 6e65 2c20  id: str = None, 
+00019060: 6365 6e74 7261 6c5f 636f 6f72 643a 2051  central_coord: Q
+00019070: 7561 6e74 6974 7920 3d20 4e6f 6e65 2920  uantity = None) 
+00019080: 5c0a 2020 2020 2020 2020 2020 2020 2d3e  \.            ->
+00019090: 2054 7570 6c65 5b6e 702e 6e64 6172 7261   Tuple[np.ndarra
+000190a0: 792c 206e 702e 6e64 6172 7261 795d 3a0a  y, np.ndarray]:.
+000190b0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+000190c0: 2020 2020 4d65 7468 6f64 2074 6f20 7265      Method to re
+000190d0: 7472 6965 7665 2073 6f75 7263 6520 616e  trieve source an
+000190e0: 6420 6261 636b 6772 6f75 6e64 206d 6173  d background mas
+000190f0: 6b73 2066 6f72 2074 6865 2067 6976 656e  ks for the given
+00019100: 2072 6567 696f 6e20 7479 7065 2e0a 0a20   region type... 
+00019110: 2020 2020 2020 203a 7061 7261 6d20 7374         :param st
+00019120: 7220 7265 675f 7479 7065 3a20 5468 6520  r reg_type: The 
+00019130: 7479 7065 206f 6620 7265 6769 6f6e 2066  type of region f
+00019140: 6f72 2077 6869 6368 2074 6f20 7265 7472  or which to retr
+00019150: 6965 7665 2074 6865 206d 6173 6b2e 0a20  ieve the mask.. 
+00019160: 2020 2020 2020 203a 7061 7261 6d20 7374         :param st
+00019170: 7220 6f62 735f 6964 3a20 5468 6520 4f62  r obs_id: The Ob
+00019180: 7349 4420 7468 6174 2074 6865 206d 6173  sID that the mas
+00019190: 6b20 6973 2061 7373 6f63 6961 7465 6420  k is associated 
+000191a0: 7769 7468 2028 6966 2061 7070 726f 7072  with (if appropr
+000191b0: 6961 7465 292e 0a20 2020 2020 2020 203a  iate)..        :
+000191c0: 7061 7261 6d20 5175 616e 7469 7479 2063  param Quantity c
+000191d0: 656e 7472 616c 5f63 6f6f 7264 3a20 5468  entral_coord: Th
+000191e0: 6520 6365 6e74 7261 6c20 636f 6f72 6469  e central coordi
+000191f0: 6e61 7465 206f 6620 7468 6520 7265 6769  nate of the regi
+00019200: 6f6e 2e0a 2020 2020 2020 2020 3a72 6574  on..        :ret
+00019210: 7572 6e3a 2054 6865 2073 6f75 7263 6520  urn: The source 
+00019220: 616e 6420 6261 636b 6772 6f75 6e64 206d  and background m
+00019230: 6173 6b73 2066 6f72 2074 6865 2072 6571  asks for the req
+00019240: 7565 7374 6564 204f 6273 4944 2028 6f72  uested ObsID (or
+00019250: 2074 6865 2063 6f6d 6269 6e65 6420 696d   the combined im
+00019260: 6167 6520 6966 206e 6f20 4f62 7349 4429  age if no ObsID)
+00019270: 2e0a 2020 2020 2020 2020 3a72 7479 7065  ..        :rtype
+00019280: 3a20 5475 706c 655b 6e70 2e6e 6461 7272  : Tuple[np.ndarr
+00019290: 6179 2c20 6e70 2e6e 6461 7272 6179 5d0a  ay, np.ndarray].
+000192a0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+000192b0: 2020 2020 6966 206f 6273 5f69 6420 3d3d      if obs_id ==
+000192c0: 2022 636f 6d62 696e 6564 223a 0a20 2020   "combined":.   
+000192d0: 2020 2020 2020 2020 206f 6273 5f69 6420           obs_id 
+000192e0: 3d20 4e6f 6e65 0a0a 2020 2020 2020 2020  = None..        
+000192f0: 6966 2063 656e 7472 616c 5f63 6f6f 7264  if central_coord
+00019300: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+00019310: 2020 2020 2020 6365 6e74 7261 6c5f 636f        central_co
+00019320: 6f72 6420 3d20 7365 6c66 2e5f 6465 6661  ord = self._defa
+00019330: 756c 745f 636f 6f72 640a 0a20 2020 2020  ult_coord..     
+00019340: 2020 2023 2044 6f6e 2774 206e 6565 6420     # Don't need 
+00019350: 746f 2064 6f20 6120 6275 6e63 6820 6f66  to do a bunch of
+00019360: 2063 6865 636b 732c 2062 6563 6175 7365   checks, because
+00019370: 2074 6865 206d 6574 686f 6420 4920 6361   the method I ca
+00019380: 6c6c 2074 6f20 6d61 6b65 2074 6865 0a20  ll to make the. 
+00019390: 2020 2020 2020 2023 2020 6d61 736b 2064         #  mask d
+000193a0: 6f65 7320 616c 6c20 7468 6520 6368 6563  oes all the chec
+000193b0: 6b73 2061 6e79 7761 790a 2020 2020 2020  ks anyway.      
+000193c0: 2020 7372 635f 7265 672c 2062 636b 5f72    src_reg, bck_r
+000193d0: 6567 203d 2073 656c 662e 736f 7572 6365  eg = self.source
+000193e0: 5f62 6163 6b5f 7265 6769 6f6e 7328 7265  _back_regions(re
+000193f0: 675f 7479 7065 2c20 6f62 735f 6964 2c20  g_type, obs_id, 
+00019400: 6365 6e74 7261 6c5f 636f 6f72 6429 0a0a  central_coord)..
+00019410: 2020 2020 2020 2020 2320 4920 6173 7375          # I assu
+00019420: 6d65 2074 6861 7420 6966 206e 6f20 4f62  me that if no Ob
+00019430: 7349 4420 6973 2073 7570 706c 6965 642c  sID is supplied,
+00019440: 2074 6865 6e20 7468 6520 7573 6572 2077   then the user w
+00019450: 6973 6865 7320 746f 2068 6176 6520 6120  ishes to have a 
+00019460: 6d61 736b 2066 6f72 2074 6865 2063 6f6d  mask for the com
+00019470: 6269 6e65 6420 6461 7461 0a20 2020 2020  bined data.     
+00019480: 2020 2069 6620 6f62 735f 6964 2069 7320     if obs_id is 
+00019490: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+000194a0: 2020 636f 6d62 5f69 6d61 6765 7320 3d20    comb_images = 
+000194b0: 7365 6c66 2e67 6574 5f70 726f 6475 6374  self.get_product
+000194c0: 7328 2263 6f6d 6269 6e65 645f 696d 6167  s("combined_imag
+000194d0: 6522 290a 2020 2020 2020 2020 2020 2020  e").            
+000194e0: 6966 206c 656e 2863 6f6d 625f 696d 6167  if len(comb_imag
+000194f0: 6573 2920 213d 2030 3a0a 2020 2020 2020  es) != 0:.      
+00019500: 2020 2020 2020 2020 2020 6d61 736b 5f69            mask_i
+00019510: 6d61 6765 203d 2063 6f6d 625f 696d 6167  mage = comb_imag
+00019520: 6573 5b30 5d0a 2020 2020 2020 2020 2020  es[0].          
+00019530: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00019540: 2020 2020 2020 2020 7261 6973 6520 4e6f          raise No
+00019550: 5072 6f64 7563 7441 7661 696c 6162 6c65  ProductAvailable
+00019560: 4572 726f 7228 2254 6865 7265 2061 7265  Error("There are
+00019570: 206e 6f20 636f 6d62 696e 6564 2070 726f   no combined pro
+00019580: 6475 6374 7320 6176 6169 6c61 626c 6520  ducts available 
+00019590: 746f 2067 656e 6572 6174 6520 6120 6d61  to generate a ma
+000195a0: 736b 2066 6f72 2e22 290a 2020 2020 2020  sk for.").      
+000195b0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000195c0: 2020 2020 2320 4a75 7374 2067 7261 6220      # Just grab 
+000195d0: 7468 6520 6669 7273 7420 696e 7374 7275  the first instru
+000195e0: 6d65 6e74 2074 6861 7420 636f 6d65 7320  ment that comes 
+000195f0: 6f75 7420 7468 6520 6765 7420 6d65 7468  out the get meth
+00019600: 6f64 2c20 7468 6520 6d61 736b 7320 7368  od, the masks sh
+00019610: 6f75 6c64 2062 6520 7468 6520 7361 6d65  ould be the same
+00019620: 2e0a 2020 2020 2020 2020 2020 2020 6d61  ..            ma
+00019630: 736b 5f69 6d61 6765 203d 2073 656c 662e  sk_image = self.
+00019640: 6765 745f 7072 6f64 7563 7473 2822 696d  get_products("im
+00019650: 6167 6522 2c20 6f62 735f 6964 295b 305d  age", obs_id)[0]
+00019660: 0a0a 2020 2020 2020 2020 6d61 736b 203d  ..        mask =
+00019670: 2073 7263 5f72 6567 2e74 6f5f 7069 7865   src_reg.to_pixe
+00019680: 6c28 6d61 736b 5f69 6d61 6765 2e72 6164  l(mask_image.rad
+00019690: 6563 5f77 6373 292e 746f 5f6d 6173 6b28  ec_wcs).to_mask(
+000196a0: 292e 746f 5f69 6d61 6765 286d 6173 6b5f  ).to_image(mask_
+000196b0: 696d 6167 652e 7368 6170 6529 0a20 2020  image.shape).   
+000196c0: 2020 2020 2062 6163 6b5f 6d61 736b 203d       back_mask =
+000196d0: 2062 636b 5f72 6567 2e74 6f5f 7069 7865   bck_reg.to_pixe
+000196e0: 6c28 6d61 736b 5f69 6d61 6765 2e72 6164  l(mask_image.rad
+000196f0: 6563 5f77 6373 292e 746f 5f6d 6173 6b28  ec_wcs).to_mask(
+00019700: 292e 746f 5f69 6d61 6765 286d 6173 6b5f  ).to_image(mask_
+00019710: 696d 6167 652e 7368 6170 6529 0a0a 2020  image.shape)..  
+00019720: 2020 2020 2020 2320 4966 2074 6865 206d        # If the m
+00019730: 6173 6b73 2061 7265 204e 6f6e 652c 2074  asks are None, t
+00019740: 6865 6e20 7468 6579 2061 7265 2073 6574  hen they are set
+00019750: 2074 6f20 616e 2061 7272 6179 206f 6620   to an array of 
+00019760: 7a65 726f 730a 2020 2020 2020 2020 6966  zeros.        if
+00019770: 206d 6173 6b20 6973 204e 6f6e 653a 0a20   mask is None:. 
+00019780: 2020 2020 2020 2020 2020 206d 6173 6b20             mask 
+00019790: 3d20 6e70 2e7a 6572 6f73 286d 6173 6b5f  = np.zeros(mask_
+000197a0: 696d 6167 652e 7368 6170 6529 0a20 2020  image.shape).   
+000197b0: 2020 2020 2069 6620 6261 636b 5f6d 6173       if back_mas
+000197c0: 6b20 6973 204e 6f6e 653a 0a20 2020 2020  k is None:.     
+000197d0: 2020 2020 2020 2062 6163 6b5f 6d61 736b         back_mask
+000197e0: 203d 206e 702e 7a65 726f 7328 6d61 736b   = np.zeros(mask
+000197f0: 5f69 6d61 6765 2e73 6861 7065 290a 0a20  _image.shape).. 
+00019800: 2020 2020 2020 2072 6574 7572 6e20 6d61         return ma
+00019810: 736b 2c20 6261 636b 5f6d 6173 6b0a 0a20  sk, back_mask.. 
+00019820: 2020 2064 6566 205f 6765 6e65 7261 7465     def _generate
+00019830: 5f69 6e74 6572 6c6f 7065 725f 6d61 736b  _interloper_mask
+00019840: 2873 656c 662c 206d 6173 6b5f 696d 6167  (self, mask_imag
+00019850: 653a 2049 6d61 6765 2920 2d3e 206e 6461  e: Image) -> nda
+00019860: 7272 6179 3a0a 2020 2020 2020 2020 2222  rray:.        ""
+00019870: 220a 2020 2020 2020 2020 496e 7465 726e  ".        Intern
+00019880: 616c 206d 6574 686f 6420 7468 6174 206d  al method that m
+00019890: 616b 6573 2069 6e74 6572 6c6f 7065 7220  akes interloper 
+000198a0: 6d61 736b 7320 696e 2074 6865 2066 6972  masks in the fir
+000198b0: 7374 2070 6c61 6365 3b20 4920 616c 6c6f  st place; I allo
+000198c0: 7720 7468 6973 2062 6563 6175 7365 2069  w this because i
+000198d0: 6e74 6572 6c6f 7065 720a 2020 2020 2020  nterloper.      
+000198e0: 2020 6d61 736b 7320 7769 6c6c 206e 6576    masks will nev
+000198f0: 6572 2063 6861 6e67 652c 2073 6f20 6361  er change, so ca
+00019900: 6e20 6265 2073 6166 656c 7920 6765 6e65  n be safely gene
+00019910: 7261 7465 6420 616e 6420 7374 6f72 6564  rated and stored
+00019920: 2069 6e20 616e 2069 6e69 7420 6f66 2061   in an init of a
+00019930: 2073 6f75 7263 6520 636c 6173 732e 0a0a   source class...
+00019940: 2020 2020 2020 2020 3a70 6172 616d 2049          :param I
+00019950: 6d61 6765 206d 6173 6b5f 696d 6167 653a  mage mask_image:
+00019960: 2054 6865 2069 6d61 6765 2066 6f72 2077   The image for w
+00019970: 6869 6368 2074 6f20 6372 6561 7465 2074  hich to create t
+00019980: 6865 2069 6e74 6572 6c6f 7065 7220 6d61  he interloper ma
+00019990: 736b 2e0a 2020 2020 2020 2020 3a72 6574  sk..        :ret
+000199a0: 7572 6e3a 2041 206e 756d 7079 2061 7272  urn: A numpy arr
+000199b0: 6179 206f 6620 3073 2061 6e64 2031 7320  ay of 0s and 1s 
+000199c0: 7768 6963 6820 6163 7473 2061 7320 6120  which acts as a 
+000199d0: 6d61 736b 2074 6f20 7265 6d6f 7665 2069  mask to remove i
+000199e0: 6e74 6572 6c6f 7065 7220 736f 7572 6365  nterloper source
+000199f0: 732e 0a20 2020 2020 2020 203a 7274 7970  s..        :rtyp
+00019a00: 653a 206e 6461 7272 6179 0a20 2020 2020  e: ndarray.     
+00019a10: 2020 2022 2222 0a20 2020 2020 2020 206d     """.        m
+00019a20: 6173 6b73 203d 205b 5d0a 2020 2020 2020  asks = [].      
+00019a30: 2020 666f 7220 7220 696e 2073 656c 662e    for r in self.
+00019a40: 5f69 6e74 6572 6c6f 7065 725f 7265 6769  _interloper_regi
+00019a50: 6f6e 733a 0a20 2020 2020 2020 2020 2020  ons:.           
+00019a60: 2069 6620 7220 6973 206e 6f74 204e 6f6e   if r is not Non
+00019a70: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00019a80: 2020 2023 2054 6865 2063 656e 7472 616c     # The central
+00019a90: 2063 6f6f 7264 696e 6174 6520 6f66 2074   coordinate of t
+00019aa0: 6865 2063 7572 7265 6e74 2072 6567 696f  he current regio
+00019ab0: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
+00019ac0: 2020 6320 3d20 5175 616e 7469 7479 285b    c = Quantity([
+00019ad0: 722e 6365 6e74 6572 2e72 612e 7661 6c75  r.center.ra.valu
+00019ae0: 652c 2072 2e63 656e 7465 722e 6465 632e  e, r.center.dec.
+00019af0: 7661 6c75 655d 2c20 2764 6567 2729 0a20  value], 'deg'). 
+00019b00: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00019b10: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00019b20: 2020 2020 2020 2020 2320 4368 6563 6b73          # Checks
+00019b30: 2069 6620 7468 6520 6365 6e74 7261 6c20   if the central 
+00019b40: 636f 6f72 6469 6e61 7465 2063 616e 2062  coordinate can b
+00019b50: 6520 636f 6e76 6572 7465 6420 746f 2070  e converted to p
+00019b60: 6978 656c 7320 666f 7220 7468 6520 6d61  ixels for the ma
+00019b70: 736b 5f69 6d61 6765 2c20 6966 2069 7420  sk_image, if it 
+00019b80: 6661 696c 7320 7468 656e 0a20 2020 2020  fails then.     
+00019b90: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00019ba0: 2020 6974 7320 6c69 6b65 6c79 206f 6666    its likely off
+00019bb0: 206f 6620 7468 6520 696d 6167 652c 2061   of the image, a
+00019bc0: 7320 6120 5661 6c75 6545 7272 6f72 2077  s a ValueError w
+00019bd0: 696c 6c20 6265 2074 6872 6f77 6e20 6966  ill be thrown if
+00019be0: 2061 2070 6978 656c 2063 6f6f 7264 696e   a pixel coordin
+00019bf0: 6174 6520 6973 206c 6573 730a 2020 2020  ate is less.    
+00019c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019c10: 2320 2074 6861 6e20 7a65 726f 2c20 6f72  #  than zero, or
+00019c20: 2067 7265 6174 6572 2074 6861 6e20 7468   greater than th
+00019c30: 6520 7369 7a65 206f 6620 7468 6520 696d  e size of the im
+00019c40: 6167 6520 696e 2074 6861 7420 6178 6973  age in that axis
+00019c50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019c60: 2020 2020 2063 7020 3d20 6d61 736b 5f69       cp = mask_i
+00019c70: 6d61 6765 2e63 6f6f 7264 5f63 6f6e 7628  mage.coord_conv(
+00019c80: 632c 2027 7069 7827 290a 2020 2020 2020  c, 'pix').      
+00019c90: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+00019ca0: 203d 2072 2e74 6f5f 7069 7865 6c28 6d61   = r.to_pixel(ma
+00019cb0: 736b 5f69 6d61 6765 2e72 6164 6563 5f77  sk_image.radec_w
+00019cc0: 6373 290a 0a20 2020 2020 2020 2020 2020  cs)..           
+00019cd0: 2020 2020 2020 2020 2023 2049 6620 7468           # If th
+00019ce0: 6520 726f 7461 7469 6f6e 2061 6e67 6c65  e rotation angle
+00019cf0: 2069 7320 7a65 726f 2074 6865 6e20 7468   is zero then th
+00019d00: 6520 636f 6e76 6572 7369 6f6e 2074 6f20  e conversion to 
+00019d10: 6d61 736b 2062 7920 7468 6520 7265 6769  mask by the regi
+00019d20: 6f6e 7320 6d6f 6475 6c65 2077 696c 6c20  ons module will 
+00019d30: 6265 2075 7073 6574 2c0a 2020 2020 2020  be upset,.      
+00019d40: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00019d50: 2073 6f20 4920 7065 7274 7572 6220 7468   so I perturb th
+00019d60: 6520 616e 676c 6520 6279 2030 2e31 2064  e angle by 0.1 d
+00019d70: 6567 7265 6573 0a20 2020 2020 2020 2020  egrees.         
+00019d80: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+00019d90: 696e 7374 616e 6365 2870 722c 2045 6c6c  instance(pr, Ell
+00019da0: 6970 7365 5069 7865 6c52 6567 696f 6e29  ipsePixelRegion)
+00019db0: 2061 6e64 2070 722e 616e 676c 652e 7661   and pr.angle.va
+00019dc0: 6c75 6520 3d3d 2030 3a0a 2020 2020 2020  lue == 0:.      
+00019dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019de0: 2020 7072 2e61 6e67 6c65 202b 3d20 5175    pr.angle += Qu
+00019df0: 616e 7469 7479 2830 2e31 2c20 2764 6567  antity(0.1, 'deg
+00019e00: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
+00019e10: 2020 2020 2020 206d 6173 6b73 2e61 7070         masks.app
+00019e20: 656e 6428 7072 2e74 6f5f 6d61 736b 2829  end(pr.to_mask()
+00019e30: 2e74 6f5f 696d 6167 6528 6d61 736b 5f69  .to_image(mask_i
+00019e40: 6d61 6765 2e73 6861 7065 2929 0a20 2020  mage.shape)).   
+00019e50: 2020 2020 2020 2020 2020 2020 2065 7863               exc
+00019e60: 6570 7420 5661 6c75 6545 7272 6f72 3a0a  ept ValueError:.
+00019e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019e80: 2020 2020 7061 7373 0a0a 2020 2020 2020      pass..      
+00019e90: 2020 2320 6d61 736b 7320 3d20 5b72 6567    # masks = [reg
+00019ea0: 2e74 6f5f 7069 7865 6c28 6d61 736b 5f69  .to_pixel(mask_i
+00019eb0: 6d61 6765 2e72 6164 6563 5f77 6373 292e  mage.radec_wcs).
+00019ec0: 746f 5f6d 6173 6b28 292e 746f 5f69 6d61  to_mask().to_ima
+00019ed0: 6765 286d 6173 6b5f 696d 6167 652e 7368  ge(mask_image.sh
+00019ee0: 6170 6529 0a20 2020 2020 2020 2023 2020  ape).        #  
+00019ef0: 2020 2020 2020 2020 666f 7220 7265 6720          for reg 
+00019f00: 696e 2073 656c 662e 5f69 6e74 6572 6c6f  in self._interlo
+00019f10: 7065 725f 7265 6769 6f6e 7320 6966 2072  per_regions if r
+00019f20: 6567 2069 7320 6e6f 7420 4e6f 6e65 5d0a  eg is not None].
+00019f30: 2020 2020 2020 2020 696e 7465 726c 6f70          interlop
+00019f40: 6572 7320 3d20 7375 6d28 5b6d 2066 6f72  ers = sum([m for
+00019f50: 206d 2069 6e20 6d61 736b 7320 6966 206d   m in masks if m
+00019f60: 2069 7320 6e6f 7420 4e6f 6e65 5d29 0a0a   is not None])..
+00019f70: 2020 2020 2020 2020 6d61 736b 203d 206e          mask = n
+00019f80: 702e 6f6e 6573 286d 6173 6b5f 696d 6167  p.ones(mask_imag
+00019f90: 652e 7368 6170 6529 0a20 2020 2020 2020  e.shape).       
+00019fa0: 206d 6173 6b5b 696e 7465 726c 6f70 6572   mask[interloper
+00019fb0: 7320 213d 2030 5d20 3d20 300a 0a20 2020  s != 0] = 0..   
+00019fc0: 2020 2020 2072 6574 7572 6e20 6d61 736b       return mask
+00019fd0: 0a0a 2020 2020 6465 6620 6765 745f 696e  ..    def get_in
+00019fe0: 7465 726c 6f70 6572 5f6d 6173 6b28 7365  terloper_mask(se
+00019ff0: 6c66 2c20 6f62 735f 6964 3a20 7374 7220  lf, obs_id: str 
+0001a000: 3d20 4e6f 6e65 2920 2d3e 206e 6461 7272  = None) -> ndarr
+0001a010: 6179 3a0a 2020 2020 2020 2020 2222 220a  ay:.        """.
+0001a020: 2020 2020 2020 2020 5265 7475 726e 7320          Returns 
+0001a030: 6120 6d61 736b 2066 6f72 2061 2067 6976  a mask for a giv
+0001a040: 656e 204f 6273 4944 2028 6f72 2063 6f6d  en ObsID (or com
+0001a050: 6269 6e65 6420 6461 7461 2069 6620 6e6f  bined data if no
+0001a060: 204f 6273 4944 2067 6976 656e 2920 7468   ObsID given) th
+0001a070: 6174 2077 696c 6c20 7265 6d6f 7665 2061  at will remove a
+0001a080: 6e79 2073 6f75 7263 6573 0a20 2020 2020  ny sources.     
+0001a090: 2020 2074 6861 7420 6861 7665 206e 6f74     that have not
+0001a0a0: 2062 6565 6e20 6964 656e 7469 6669 6564   been identified
+0001a0b0: 2061 7320 7468 6520 736f 7572 6365 206f   as the source o
+0001a0c0: 6620 696e 7465 7265 7374 2e0a 0a20 2020  f interest...   
+0001a0d0: 2020 2020 203a 7061 7261 6d20 7374 7220       :param str 
+0001a0e0: 6f62 735f 6964 3a20 5468 6520 4f62 7349  obs_id: The ObsI
+0001a0f0: 4420 7468 6174 2074 6865 206d 6173 6b20  D that the mask 
+0001a100: 6973 2061 7373 6f63 6961 7465 6420 7769  is associated wi
+0001a110: 7468 2028 6966 2061 7070 726f 7072 6961  th (if appropria
+0001a120: 7465 292e 0a20 2020 2020 2020 203a 7265  te)..        :re
+0001a130: 7475 726e 3a20 4120 6e75 6d70 7920 6172  turn: A numpy ar
+0001a140: 7261 7920 6f66 2030 7320 616e 6420 3173  ray of 0s and 1s
+0001a150: 2077 6869 6368 2061 6374 7320 6173 2061   which acts as a
+0001a160: 206d 6173 6b20 746f 2072 656d 6f76 6520   mask to remove 
+0001a170: 696e 7465 726c 6f70 6572 2073 6f75 7263  interloper sourc
+0001a180: 6573 2e0a 2020 2020 2020 2020 3a72 7479  es..        :rty
+0001a190: 7065 3a20 6e64 6172 7261 790a 2020 2020  pe: ndarray.    
+0001a1a0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0001a1b0: 6966 2074 7970 6528 7365 6c66 2920 3d3d  if type(self) ==
+0001a1c0: 2042 6173 6553 6f75 7263 653a 0a20 2020   BaseSource:.   
+0001a1d0: 2020 2020 2020 2020 2072 6169 7365 2054           raise T
+0001a1e0: 7970 6545 7272 6f72 2822 4261 7365 536f  ypeError("BaseSo
+0001a1f0: 7572 6365 206f 626a 6563 7473 2064 6f6e  urce objects don
+0001a200: 2774 2068 6176 6520 656e 6f75 6768 2069  't have enough i
+0001a210: 6e66 6f72 6d61 7469 6f6e 2074 6f20 6b6e  nformation to kn
+0001a220: 6f77 2077 6869 6368 2073 6f75 7263 6573  ow which sources
+0001a230: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+0001a240: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0001a250: 6172 6520 696e 7465 726c 6f70 6572 732e  are interlopers.
+0001a260: 2229 0a0a 2020 2020 2020 2020 6966 206f  ")..        if o
+0001a270: 6273 5f69 6420 6973 206e 6f74 204e 6f6e  bs_id is not Non
+0001a280: 6520 616e 6420 6f62 735f 6964 2021 3d20  e and obs_id != 
+0001a290: 2263 6f6d 6269 6e65 6422 2061 6e64 206f  "combined" and o
+0001a2a0: 6273 5f69 6420 6e6f 7420 696e 2073 656c  bs_id not in sel
+0001a2b0: 662e 6f62 735f 6964 733a 0a20 2020 2020  f.obs_ids:.     
+0001a2c0: 2020 2020 2020 2072 6169 7365 204e 6f74         raise Not
+0001a2d0: 4173 736f 6369 6174 6564 4572 726f 7228  AssociatedError(
+0001a2e0: 227b 6f7d 2069 7320 6e6f 7420 6173 736f  "{o} is not asso
+0001a2f0: 6369 6174 6564 2077 6974 6820 7b73 7d3b  ciated with {s};
+0001a300: 206f 6e6c 7920 7b61 7d20 6172 6520 220a   only {a} are ".
+0001a310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a330: 2020 2020 2022 6176 6169 6c61 626c 6522       "available"
+0001a340: 2e66 6f72 6d61 7428 6f3d 6f62 735f 6964  .format(o=obs_id
+0001a350: 2c20 733d 7365 6c66 2e6e 616d 652c 2061  , s=self.name, a
+0001a360: 3d22 2c20 222e 6a6f 696e 2873 656c 662e  =", ".join(self.
+0001a370: 6f62 735f 6964 7329 2929 0a20 2020 2020  obs_ids))).     
+0001a380: 2020 2065 6c69 6620 6f62 735f 6964 2069     elif obs_id i
+0001a390: 7320 6e6f 7420 4e6f 6e65 2061 6e64 206f  s not None and o
+0001a3a0: 6273 5f69 6420 213d 2022 636f 6d62 696e  bs_id != "combin
+0001a3b0: 6564 223a 0a20 2020 2020 2020 2020 2020  ed":.           
+0001a3c0: 206d 6173 6b20 3d20 7365 6c66 2e5f 696e   mask = self._in
+0001a3d0: 7465 726c 6f70 6572 5f6d 6173 6b73 5b6f  terloper_masks[o
+0001a3e0: 6273 5f69 645d 0a20 2020 2020 2020 2065  bs_id].        e
+0001a3f0: 6c69 6620 6f62 735f 6964 2069 7320 4e6f  lif obs_id is No
+0001a400: 6e65 206f 7220 6f62 735f 6964 203d 3d20  ne or obs_id == 
+0001a410: 2263 6f6d 6269 6e65 6422 2061 6e64 2022  "combined" and "
+0001a420: 636f 6d62 696e 6564 2220 6e6f 7420 696e  combined" not in
+0001a430: 2073 656c 662e 5f69 6e74 6572 6c6f 7065   self._interlope
+0001a440: 725f 6d61 736b 733a 0a20 2020 2020 2020  r_masks:.       
+0001a450: 2020 2020 2063 6f6d 625f 696d 7320 3d20       comb_ims = 
+0001a460: 7365 6c66 2e67 6574 5f70 726f 6475 6374  self.get_product
+0001a470: 7328 2263 6f6d 6269 6e65 645f 696d 6167  s("combined_imag
+0001a480: 6522 290a 2020 2020 2020 2020 2020 2020  e").            
+0001a490: 6966 206c 656e 2863 6f6d 625f 696d 7329  if len(comb_ims)
+0001a4a0: 203d 3d20 303a 0a20 2020 2020 2020 2020   == 0:.         
+0001a4b0: 2020 2020 2020 2072 6169 7365 204e 6f50         raise NoP
+0001a4c0: 726f 6475 6374 4176 6169 6c61 626c 6545  roductAvailableE
+0001a4d0: 7272 6f72 2822 5468 6572 6520 6172 6520  rror("There are 
+0001a4e0: 6e6f 2063 6f6d 6269 6e65 6420 696d 6167  no combined imag
+0001a4f0: 6573 2061 7661 696c 6162 6c65 2066 6f72  es available for
+0001a500: 2077 6869 6368 2074 6f20 6665 7463 6822   which to fetch"
+0001a510: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001a520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a530: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0001a540: 2069 6e74 6572 6c6f 7065 7220 6d61 736b   interloper mask
+0001a550: 732e 2229 0a20 2020 2020 2020 2020 2020  s.").           
+0001a560: 2069 6d20 3d20 636f 6d62 5f69 6d73 5b30   im = comb_ims[0
+0001a570: 5d0a 2020 2020 2020 2020 2020 2020 6d61  ].            ma
+0001a580: 736b 203d 2073 656c 662e 5f67 656e 6572  sk = self._gener
+0001a590: 6174 655f 696e 7465 726c 6f70 6572 5f6d  ate_interloper_m
+0001a5a0: 6173 6b28 696d 290a 2020 2020 2020 2020  ask(im).        
+0001a5b0: 2020 2020 7365 6c66 2e5f 696e 7465 726c      self._interl
+0001a5c0: 6f70 6572 5f6d 6173 6b73 5b22 636f 6d62  oper_masks["comb
+0001a5d0: 696e 6564 225d 203d 206d 6173 6b0a 2020  ined"] = mask.  
+0001a5e0: 2020 2020 2020 656c 6966 206f 6273 5f69        elif obs_i
+0001a5f0: 6420 6973 204e 6f6e 6520 6f72 206f 6273  d is None or obs
+0001a600: 5f69 6420 3d3d 2022 636f 6d62 696e 6564  _id == "combined
+0001a610: 2220 616e 6420 2263 6f6d 6269 6e65 6422  " and "combined"
+0001a620: 2069 6e20 7365 6c66 2e5f 696e 7465 726c   in self._interl
+0001a630: 6f70 6572 5f6d 6173 6b73 3a0a 2020 2020  oper_masks:.    
+0001a640: 2020 2020 2020 2020 6d61 736b 203d 2073          mask = s
+0001a650: 656c 662e 5f69 6e74 6572 6c6f 7065 725f  elf._interloper_
+0001a660: 6d61 736b 735b 2263 6f6d 6269 6e65 6422  masks["combined"
+0001a670: 5d0a 0a20 2020 2020 2020 2072 6574 7572  ]..        retur
+0001a680: 6e20 6d61 736b 0a0a 2020 2020 6465 6620  n mask..    def 
+0001a690: 6765 745f 6d61 736b 2873 656c 662c 2072  get_mask(self, r
+0001a6a0: 6567 5f74 7970 653a 2073 7472 2c20 6f62  eg_type: str, ob
+0001a6b0: 735f 6964 3a20 7374 7220 3d20 4e6f 6e65  s_id: str = None
+0001a6c0: 2c20 6365 6e74 7261 6c5f 636f 6f72 643a  , central_coord:
+0001a6d0: 2051 7561 6e74 6974 7920 3d20 4e6f 6e65   Quantity = None
+0001a6e0: 2920 2d3e 205c 0a20 2020 2020 2020 2020  ) -> \.         
+0001a6f0: 2020 2054 7570 6c65 5b6e 702e 6e64 6172     Tuple[np.ndar
+0001a700: 7261 792c 206e 702e 6e64 6172 7261 795d  ray, np.ndarray]
+0001a710: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+0001a720: 2020 2020 2020 4d65 7468 6f64 2074 6f20        Method to 
+0001a730: 7265 7472 6965 7665 2073 6f75 7263 6520  retrieve source 
+0001a740: 616e 6420 6261 636b 6772 6f75 6e64 206d  and background m
+0001a750: 6173 6b73 2066 6f72 2074 6865 2067 6976  asks for the giv
+0001a760: 656e 2072 6567 696f 6e20 7479 7065 2c20  en region type, 
+0001a770: 5749 5448 2049 4e54 4552 4c4f 5045 5253  WITH INTERLOPERS
+0001a780: 2052 454d 4f56 4544 2e0a 0a20 2020 2020   REMOVED...     
+0001a790: 2020 203a 7061 7261 6d20 7374 7220 7265     :param str re
+0001a7a0: 675f 7479 7065 3a20 5468 6520 7479 7065  g_type: The type
+0001a7b0: 206f 6620 7265 6769 6f6e 2066 6f72 2077   of region for w
+0001a7c0: 6869 6368 2074 6f20 7265 7472 6965 7665  hich to retrieve
+0001a7d0: 2074 6865 2069 6e74 6572 6c6f 7065 7220   the interloper 
+0001a7e0: 636f 7272 6563 7465 6420 6d61 736b 2e0a  corrected mask..
+0001a7f0: 2020 2020 2020 2020 3a70 6172 616d 2073          :param s
+0001a800: 7472 206f 6273 5f69 643a 2054 6865 204f  tr obs_id: The O
+0001a810: 6273 4944 2074 6861 7420 7468 6520 6d61  bsID that the ma
+0001a820: 736b 2069 7320 6173 736f 6369 6174 6564  sk is associated
+0001a830: 2077 6974 6820 2869 6620 6170 7072 6f70   with (if approp
+0001a840: 7269 6174 6529 2e0a 2020 2020 2020 2020  riate)..        
+0001a850: 3a70 6172 616d 2051 7561 6e74 6974 7920  :param Quantity 
+0001a860: 6365 6e74 7261 6c5f 636f 6f72 643a 2054  central_coord: T
+0001a870: 6865 2063 656e 7472 616c 2063 6f6f 7264  he central coord
+0001a880: 696e 6174 6520 6f66 2074 6865 2072 6567  inate of the reg
+0001a890: 696f 6e2e 0a20 2020 2020 2020 203a 7265  ion..        :re
+0001a8a0: 7475 726e 3a20 5468 6520 736f 7572 6365  turn: The source
+0001a8b0: 2061 6e64 2062 6163 6b67 726f 756e 6420   and background 
+0001a8c0: 6d61 736b 7320 666f 7220 7468 6520 7265  masks for the re
+0001a8d0: 7175 6573 7465 6420 4f62 7349 4420 286f  quested ObsID (o
+0001a8e0: 7220 7468 6520 636f 6d62 696e 6564 2069  r the combined i
+0001a8f0: 6d61 6765 2069 6620 6e6f 204f 6273 4944  mage if no ObsID
+0001a900: 292e 0a20 2020 2020 2020 203a 7274 7970  )..        :rtyp
+0001a910: 653a 2054 7570 6c65 5b6e 702e 6e64 6172  e: Tuple[np.ndar
+0001a920: 7261 792c 206e 702e 6e64 6172 7261 795d  ray, np.ndarray]
+0001a930: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0001a940: 2020 2020 2023 2047 7261 6273 2074 6865       # Grabs the
+0001a950: 2073 6f75 7263 6520 6d61 736b 7320 7769   source masks wi
+0001a960: 7468 6f75 7420 696e 7465 726c 6f70 6572  thout interloper
+0001a970: 7320 7265 6d6f 7665 640a 2020 2020 2020  s removed.      
+0001a980: 2020 7372 635f 6d61 736b 2c20 6263 6b5f    src_mask, bck_
+0001a990: 6d61 736b 203d 2073 656c 662e 6765 745f  mask = self.get_
+0001a9a0: 736f 7572 6365 5f6d 6173 6b28 7265 675f  source_mask(reg_
+0001a9b0: 7479 7065 2c20 6f62 735f 6964 2c20 6365  type, obs_id, ce
+0001a9c0: 6e74 7261 6c5f 636f 6f72 6429 0a20 2020  ntral_coord).   
+0001a9d0: 2020 2020 2023 2047 7261 6273 2074 6865       # Grabs the
+0001a9e0: 2069 6e74 6572 6c6f 7065 7220 6d61 736b   interloper mask
+0001a9f0: 0a20 2020 2020 2020 2069 6e74 6572 6c6f  .        interlo
+0001aa00: 7065 725f 6d61 736b 203d 2073 656c 662e  per_mask = self.
+0001aa10: 6765 745f 696e 7465 726c 6f70 6572 5f6d  get_interloper_m
+0001aa20: 6173 6b28 6f62 735f 6964 290a 0a20 2020  ask(obs_id)..   
+0001aa30: 2020 2020 2023 204d 756c 7469 706c 6965       # Multiplie
+0001aa40: 7320 7468 6520 756e 636f 7272 6563 7465  s the uncorrecte
+0001aa50: 6420 736f 7572 6365 2061 6e64 2062 6163  d source and bac
+0001aa60: 6b67 726f 756e 6420 6d61 736b 7320 7769  kground masks wi
+0001aa70: 7468 2074 6865 2069 6e74 6572 6c6f 7065  th the interlope
+0001aa80: 7220 6d61 736b 7320 746f 2063 6f72 7265  r masks to corre
+0001aa90: 6374 0a20 2020 2020 2020 2023 2020 666f  ct.        #  fo
+0001aaa0: 7220 696e 7465 726c 6f70 6572 2073 6f75  r interloper sou
+0001aab0: 7263 6573 0a20 2020 2020 2020 2074 6f74  rces.        tot
+0001aac0: 616c 5f73 7263 5f6d 6173 6b20 3d20 7372  al_src_mask = sr
+0001aad0: 635f 6d61 736b 202a 2069 6e74 6572 6c6f  c_mask * interlo
+0001aae0: 7065 725f 6d61 736b 0a20 2020 2020 2020  per_mask.       
+0001aaf0: 2074 6f74 616c 5f62 636b 5f6d 6173 6b20   total_bck_mask 
+0001ab00: 3d20 6263 6b5f 6d61 736b 202a 2069 6e74  = bck_mask * int
+0001ab10: 6572 6c6f 7065 725f 6d61 736b 0a0a 2020  erloper_mask..  
+0001ab20: 2020 2020 2020 7265 7475 726e 2074 6f74        return tot
+0001ab30: 616c 5f73 7263 5f6d 6173 6b2c 2074 6f74  al_src_mask, tot
+0001ab40: 616c 5f62 636b 5f6d 6173 6b0a 0a20 2020  al_bck_mask..   
+0001ab50: 2064 6566 2067 6574 5f63 7573 746f 6d5f   def get_custom_
+0001ab60: 6d61 736b 2873 656c 662c 206f 7574 6572  mask(self, outer
+0001ab70: 5f72 6164 3a20 5175 616e 7469 7479 2c20  _rad: Quantity, 
+0001ab80: 696e 6e65 725f 7261 643a 2051 7561 6e74  inner_rad: Quant
+0001ab90: 6974 7920 3d20 5175 616e 7469 7479 2830  ity = Quantity(0
+0001aba0: 2c20 2761 7263 7365 6327 292c 206f 6273  , 'arcsec'), obs
+0001abb0: 5f69 643a 2073 7472 203d 204e 6f6e 652c  _id: str = None,
+0001abc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001abd0: 2020 2020 2020 2020 2063 656e 7472 616c           central
+0001abe0: 5f63 6f6f 7264 3a20 5175 616e 7469 7479  _coord: Quantity
+0001abf0: 203d 204e 6f6e 652c 2072 656d 6f76 655f   = None, remove_
+0001ac00: 696e 7465 726c 6f70 6572 733a 2062 6f6f  interlopers: boo
+0001ac10: 6c20 3d20 5472 7565 2920 2d3e 206e 702e  l = True) -> np.
+0001ac20: 6e64 6172 7261 793a 0a20 2020 2020 2020  ndarray:.       
+0001ac30: 2022 2222 0a20 2020 2020 2020 2041 2073   """.        A s
+0001ac40: 696d 706c 652c 2062 7574 2070 6f77 6572  imple, but power
+0001ac50: 6675 6c20 6d65 7468 6f64 2c20 746f 2067  ful method, to g
+0001ac60: 656e 6572 6174 6520 6d61 736b 2061 206d  enerate mask a m
+0001ac70: 6173 6b20 7769 7468 696e 2061 2063 7573  ask within a cus
+0001ac80: 746f 6d20 7261 6469 7573 2066 6f72 2061  tom radius for a
+0001ac90: 2067 6976 656e 204f 6273 4944 2e0a 0a20   given ObsID... 
+0001aca0: 2020 2020 2020 203a 7061 7261 6d20 5175         :param Qu
+0001acb0: 616e 7469 7479 206f 7574 6572 5f72 6164  antity outer_rad
+0001acc0: 3a20 5468 6520 6f75 7465 7220 7261 6469  : The outer radi
+0001acd0: 7573 206f 6620 7468 6520 6d61 736b 2e0a  us of the mask..
+0001ace0: 2020 2020 2020 2020 3a70 6172 616d 2051          :param Q
+0001acf0: 7561 6e74 6974 7920 696e 6e65 725f 7261  uantity inner_ra
+0001ad00: 643a 2054 6865 2069 6e6e 6572 2072 6164  d: The inner rad
+0001ad10: 6975 7320 6f66 2074 6865 206d 6173 6b2c  ius of the mask,
+0001ad20: 2074 6865 2064 6566 6175 6c74 2069 7320   the default is 
+0001ad30: 7a65 726f 2061 7263 7365 636f 6e64 732e  zero arcseconds.
+0001ad40: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+0001ad50: 7374 7220 6f62 735f 6964 3a20 5468 6520  str obs_id: The 
+0001ad60: 4f62 7349 4420 666f 7220 7768 6963 6820  ObsID for which 
+0001ad70: 746f 2067 656e 6572 6174 6520 7468 6520  to generate the 
+0001ad80: 6d61 736b 2c20 6465 6661 756c 7420 6973  mask, default is
+0001ad90: 204e 6f6e 6520 7768 6963 6820 7769 6c6c   None which will
+0001ada0: 2072 6574 7572 6e20 6120 6d61 736b 0a20   return a mask. 
+0001adb0: 2020 2020 2020 2020 2020 2067 656e 6572             gener
+0001adc0: 6174 6564 2066 726f 6d20 6120 636f 6d62  ated from a comb
+0001add0: 696e 6564 2069 6d61 6765 2e0a 2020 2020  ined image..    
+0001ade0: 2020 2020 3a70 6172 616d 2051 7561 6e74      :param Quant
+0001adf0: 6974 7920 6365 6e74 7261 6c5f 636f 6f72  ity central_coor
+0001ae00: 643a 2054 6865 2063 656e 7472 616c 2063  d: The central c
+0001ae10: 6f6f 7264 696e 6174 6573 206f 6620 7468  oordinates of th
+0001ae20: 6520 6d61 736b 2c20 7468 6520 6465 6661  e mask, the defa
+0001ae30: 756c 7420 6973 204e 6f6e 6520 7768 6963  ult is None whic
+0001ae40: 680a 2020 2020 2020 2020 2020 2020 7769  h.            wi
+0001ae50: 6c6c 2075 7365 2074 6865 2064 6566 6175  ll use the defau
+0001ae60: 6c74 2063 6f6f 7264 696e 6174 6573 206f  lt coordinates o
+0001ae70: 6620 7468 6520 736f 7572 6365 2e0a 2020  f the source..  
+0001ae80: 2020 2020 2020 3a70 6172 616d 2062 6f6f        :param boo
+0001ae90: 6c20 7265 6d6f 7665 5f69 6e74 6572 6c6f  l remove_interlo
+0001aea0: 7065 7273 3a20 5768 6574 6865 7220 616e  pers: Whether an
+0001aeb0: 2069 6e74 6572 6c6f 7065 7220 6d61 736b   interloper mask
+0001aec0: 2073 686f 756c 6420 6265 2063 6f6d 6269   should be combi
+0001aed0: 6e65 6420 7769 7468 2074 6865 2063 7573  ned with the cus
+0001aee0: 746f 6d20 6d61 736b 2074 6f0a 2020 2020  tom mask to.    
+0001aef0: 2020 2020 2020 2020 7265 6d6f 7665 2069          remove i
+0001af00: 6e74 6572 6c6f 7065 7220 706f 696e 7420  nterloper point 
+0001af10: 736f 7572 6365 732e 0a20 2020 2020 2020  sources..       
+0001af20: 203a 7265 7475 726e 3a20 4120 6e75 6d70   :return: A nump
+0001af30: 7920 6172 7261 7920 636f 6e74 6169 6e69  y array containi
+0001af40: 6e67 2074 6865 2064 6573 6972 6564 206d  ng the desired m
+0001af50: 6173 6b2e 0a20 2020 2020 2020 203a 7274  ask..        :rt
+0001af60: 7970 653a 206e 702e 6e64 6172 7261 790a  ype: np.ndarray.
+0001af70: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0001af80: 2020 2020 6966 2063 656e 7472 616c 5f63      if central_c
+0001af90: 6f6f 7264 2069 7320 4e6f 6e65 3a0a 2020  oord is None:.  
+0001afa0: 2020 2020 2020 2020 2020 6365 6e74 7261            centra
+0001afb0: 6c5f 636f 6f72 6420 3d20 7365 6c66 2e5f  l_coord = self._
+0001afc0: 6465 6661 756c 745f 636f 6f72 640a 0a20  default_coord.. 
+0001afd0: 2020 2020 2020 2069 6620 6f62 735f 6964         if obs_id
+0001afe0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+0001aff0: 2020 2020 2020 2320 446f 6573 6e27 7420        # Doesn't 
+0001b000: 6d61 7474 6572 2077 6869 6368 2063 6f6d  matter which com
+0001b010: 6269 6e65 6420 7261 7465 6d61 702c 206a  bined ratemap, j
+0001b020: 7573 7420 6e65 6564 2074 6865 2073 697a  ust need the siz
+0001b030: 6520 616e 6420 636f 6f72 6420 636f 6e76  e and coord conv
+0001b040: 6572 7369 6f6e 2070 6f77 6572 730a 2020  ersion powers.  
+0001b050: 2020 2020 2020 2020 2020 7274 203d 2073            rt = s
+0001b060: 656c 662e 6765 745f 636f 6d62 696e 6564  elf.get_combined
+0001b070: 5f72 6174 656d 6170 7328 290a 2020 2020  _ratemaps().    
+0001b080: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0001b090: 2020 2020 2020 2320 4167 6169 6e20 736f        # Again so
+0001b0a0: 206c 6f6e 6720 6173 2074 6865 2069 6d61   long as the ima
+0001b0b0: 6765 206d 6174 6368 6573 2074 6865 204f  ge matches the O
+0001b0c0: 6273 4944 2070 6173 7365 6420 696e 2062  bsID passed in b
+0001b0d0: 7920 7468 6520 7573 6572 2049 2064 6f6e  y the user I don
+0001b0e0: 2774 2063 6172 6520 7768 6174 2069 6e73  't care what ins
+0001b0f0: 7472 756d 656e 740a 2020 2020 2020 2020  trument.        
+0001b100: 2020 2020 2320 2069 7473 2066 726f 6d0a      #  its from.
+0001b110: 2020 2020 2020 2020 2020 2020 7274 203d              rt =
+0001b120: 2073 656c 662e 6765 745f 7261 7465 6d61   self.get_ratema
+0001b130: 7073 286f 6273 5f69 643d 6f62 735f 6964  ps(obs_id=obs_id
+0001b140: 290a 0a20 2020 2020 2020 2023 2049 6620  )..        # If 
+0001b150: 6974 7320 6e6f 7420 616e 2069 6e73 7461  its not an insta
+0001b160: 6e63 6520 6f66 2052 6174 654d 6170 2074  nce of RateMap t
+0001b170: 6861 7420 6d65 616e 7320 6120 6c69 7374  hat means a list
+0001b180: 206f 6620 5261 7465 4d61 7073 2068 6173   of RateMaps has
+0001b190: 2062 6565 6e20 7265 7475 726e 6564 2c20   been returned, 
+0001b1a0: 616e 6420 6173 2049 206f 6e6c 7920 7761  and as I only wa
+0001b1b0: 6e74 0a20 2020 2020 2020 2023 2020 7468  nt.        #  th
+0001b1c0: 6520 5743 5320 696e 666f 726d 6174 696f  e WCS informatio
+0001b1d0: 6e20 616e 6420 7468 6520 7368 6170 6520  n and the shape 
+0001b1e0: 6f66 2074 6865 2069 6d61 6765 2049 2064  of the image I d
+0001b1f0: 6f6e 2774 2063 6172 6520 7768 6963 6820  on't care which 
+0001b200: 6f6e 6520 7765 2075 7365 0a20 2020 2020  one we use.     
+0001b210: 2020 2069 6620 6e6f 7420 6973 696e 7374     if not isinst
+0001b220: 616e 6365 2872 742c 2052 6174 654d 6170  ance(rt, RateMap
+0001b230: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+0001b240: 7420 3d20 7274 5b30 5d0a 0a20 2020 2020  t = rt[0]..     
+0001b250: 2020 2023 2043 6f6e 7665 7274 2074 6865     # Convert the
+0001b260: 2069 6e6e 6572 2061 6e64 206f 7574 6572   inner and outer
+0001b270: 2072 6164 6969 2074 6f20 6465 6772 6565   radii to degree
+0001b280: 7320 736f 2074 6865 7920 6361 6e20 6265  s so they can be
+0001b290: 2065 6173 696c 7920 636f 6e76 6572 7465   easily converte
+0001b2a0: 6420 746f 2070 6978 656c 730a 2020 2020  d to pixels.    
+0001b2b0: 2020 2020 6f75 7465 725f 7261 6420 3d20      outer_rad = 
+0001b2c0: 7365 6c66 2e63 6f6e 7665 7274 5f72 6164  self.convert_rad
+0001b2d0: 6975 7328 6f75 7465 725f 7261 642c 2027  ius(outer_rad, '
+0001b2e0: 6465 6727 290a 2020 2020 2020 2020 696e  deg').        in
+0001b2f0: 6e65 725f 7261 6420 3d20 7365 6c66 2e63  ner_rad = self.c
+0001b300: 6f6e 7665 7274 5f72 6164 6975 7328 696e  onvert_radius(in
+0001b310: 6e65 725f 7261 642c 2027 6465 6727 290a  ner_rad, 'deg').
+0001b320: 2020 2020 2020 2020 7069 785f 746f 5f64          pix_to_d
+0001b330: 6567 203d 2070 6978 5f64 6567 5f73 6361  eg = pix_deg_sca
+0001b340: 6c65 2863 656e 7472 616c 5f63 6f6f 7264  le(central_coord
+0001b350: 2c20 7274 2e72 6164 6563 5f77 6373 290a  , rt.radec_wcs).
+0001b360: 0a20 2020 2020 2020 2023 204d 616b 696e  .        # Makin
+0001b370: 6720 7375 7265 2074 6865 2069 6e6e 6572  g sure the inner
+0001b380: 2061 6e64 206f 7574 6572 2072 6164 6969   and outer radii
+0001b390: 2061 7265 2077 686f 6c65 2069 6e74 6567   are whole integ
+0001b3a0: 6572 206e 756d 6265 7273 2c20 6173 2074  er numbers, as t
+0001b3b0: 6865 7920 6172 6520 6e6f 7720 696e 2070  hey are now in p
+0001b3c0: 6978 656c 2075 6e69 7473 0a20 2020 2020  ixel units.     
+0001b3d0: 2020 206f 7574 6572 5f72 6164 203d 206e     outer_rad = n
+0001b3e0: 702e 6172 7261 7928 5b69 6e74 286e 702e  p.array([int(np.
+0001b3f0: 6365 696c 286f 7574 6572 5f72 6164 202f  ceil(outer_rad /
+0001b400: 2070 6978 5f74 6f5f 6465 6729 2e76 616c   pix_to_deg).val
+0001b410: 7565 295d 290a 2020 2020 2020 2020 696e  ue)]).        in
+0001b420: 6e65 725f 7261 6420 3d20 6e70 2e61 7272  ner_rad = np.arr
+0001b430: 6179 285b 696e 7428 6e70 2e66 6c6f 6f72  ay([int(np.floor
+0001b440: 2869 6e6e 6572 5f72 6164 202f 2070 6978  (inner_rad / pix
+0001b450: 5f74 6f5f 6465 6729 2e76 616c 7565 295d  _to_deg).value)]
+0001b460: 290a 2020 2020 2020 2020 2320 436f 6e76  ).        # Conv
+0001b470: 6572 7420 7468 6520 6368 6f73 656e 2063  ert the chosen c
+0001b480: 656e 7472 616c 2063 6f6f 7264 696e 6174  entral coordinat
+0001b490: 6573 2074 6f20 7069 7865 6c73 0a20 2020  es to pixels.   
+0001b4a0: 2020 2020 2070 6978 5f63 656e 7472 6520       pix_centre 
+0001b4b0: 3d20 7274 2e63 6f6f 7264 5f63 6f6e 7628  = rt.coord_conv(
+0001b4c0: 6365 6e74 7261 6c5f 636f 6f72 642c 2027  central_coord, '
+0001b4d0: 7069 7827 290a 0a20 2020 2020 2020 2023  pix')..        #
+0001b4e0: 2047 656e 6572 6174 6520 6f75 7220 6375   Generate our cu
+0001b4f0: 7374 6f6d 206d 6173 6b0a 2020 2020 2020  stom mask.      
+0001b500: 2020 6375 7374 6f6d 5f6d 6173 6b20 3d20    custom_mask = 
+0001b510: 616e 6e75 6c61 725f 6d61 736b 2870 6978  annular_mask(pix
+0001b520: 5f63 656e 7472 652c 2069 6e6e 6572 5f72  _centre, inner_r
+0001b530: 6164 2c20 6f75 7465 725f 7261 642c 2072  ad, outer_rad, r
+0001b540: 742e 7368 6170 6529 0a0a 2020 2020 2020  t.shape)..      
+0001b550: 2020 2320 416e 6420 6170 706c 7969 6e67    # And applying
+0001b560: 2061 6e20 696e 7465 726c 6f70 6572 206d   an interloper m
+0001b570: 6173 6b20 6966 2074 6865 2075 7365 7220  ask if the user 
+0001b580: 7761 6e74 7320 7468 6174 2e0a 2020 2020  wants that..    
+0001b590: 2020 2020 6966 2072 656d 6f76 655f 696e      if remove_in
+0001b5a0: 7465 726c 6f70 6572 733a 0a20 2020 2020  terlopers:.     
+0001b5b0: 2020 2020 2020 2069 6e74 6572 6c6f 7065         interlope
+0001b5c0: 725f 6d61 736b 203d 2073 656c 662e 6765  r_mask = self.ge
+0001b5d0: 745f 696e 7465 726c 6f70 6572 5f6d 6173  t_interloper_mas
+0001b5e0: 6b28 6f62 735f 6964 290a 2020 2020 2020  k(obs_id).      
+0001b5f0: 2020 2020 2020 6375 7374 6f6d 5f6d 6173        custom_mas
+0001b600: 6b20 3d20 6375 7374 6f6d 5f6d 6173 6b2a  k = custom_mask*
+0001b610: 696e 7465 726c 6f70 6572 5f6d 6173 6b0a  interloper_mask.
+0001b620: 2020 2020 2020 2020 7265 7475 726e 2063          return c
+0001b630: 7573 746f 6d5f 6d61 736b 0a0a 2020 2020  ustom_mask..    
+0001b640: 6465 6620 6765 745f 736e 7228 7365 6c66  def get_snr(self
+0001b650: 2c20 6f75 7465 725f 7261 6469 7573 3a20  , outer_radius: 
+0001b660: 556e 696f 6e5b 5175 616e 7469 7479 2c20  Union[Quantity, 
+0001b670: 7374 725d 2c20 6365 6e74 7261 6c5f 636f  str], central_co
+0001b680: 6f72 643a 2051 7561 6e74 6974 7920 3d20  ord: Quantity = 
+0001b690: 4e6f 6e65 2c20 6c6f 5f65 6e3a 2051 7561  None, lo_en: Qua
+0001b6a0: 6e74 6974 7920 3d20 4e6f 6e65 2c0a 2020  ntity = None,.  
+0001b6b0: 2020 2020 2020 2020 2020 2020 2020 6869                hi
+0001b6c0: 5f65 6e3a 2051 7561 6e74 6974 7920 3d20  _en: Quantity = 
+0001b6d0: 4e6f 6e65 2c20 6f62 735f 6964 3a20 7374  None, obs_id: st
+0001b6e0: 7220 3d20 4e6f 6e65 2c20 696e 7374 3a20  r = None, inst: 
+0001b6f0: 7374 7220 3d20 4e6f 6e65 2c20 7073 665f  str = None, psf_
+0001b700: 636f 7272 3a20 626f 6f6c 203d 2046 616c  corr: bool = Fal
+0001b710: 7365 2c0a 2020 2020 2020 2020 2020 2020  se,.            
+0001b720: 2020 2020 7073 665f 6d6f 6465 6c3a 2073      psf_model: s
+0001b730: 7472 203d 2022 454c 4c42 4554 4122 2c20  tr = "ELLBETA", 
+0001b740: 7073 665f 6269 6e73 3a20 696e 7420 3d20  psf_bins: int = 
+0001b750: 342c 2070 7366 5f61 6c67 6f3a 2073 7472  4, psf_algo: str
+0001b760: 203d 2022 726c 222c 2070 7366 5f69 7465   = "rl", psf_ite
+0001b770: 723a 2069 6e74 203d 2031 352c 0a20 2020  r: int = 15,.   
+0001b780: 2020 2020 2020 2020 2020 2020 2061 6c6c               all
+0001b790: 6f77 5f6e 6567 6174 6976 653a 2062 6f6f  ow_negative: boo
+0001b7a0: 6c20 3d20 4661 6c73 652c 2020 6578 705f  l = False,  exp_
+0001b7b0: 636f 7272 3a20 626f 6f6c 203d 2054 7275  corr: bool = Tru
+0001b7c0: 6529 202d 3e20 666c 6f61 743a 0a20 2020  e) -> float:.   
+0001b7d0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0001b7e0: 2054 6869 7320 7461 6b65 7320 6120 7265   This takes a re
+0001b7f0: 6769 6f6e 2074 7970 6520 616e 6420 6365  gion type and ce
+0001b800: 6e74 7261 6c20 636f 6f72 6469 6e61 7465  ntral coordinate
+0001b810: 2061 6e64 2063 616c 6375 6c61 7465 7320   and calculates 
+0001b820: 7468 6520 7369 676e 616c 2074 6f20 6e6f  the signal to no
+0001b830: 6973 6520 7261 7469 6f2e 0a20 2020 2020  ise ratio..     
+0001b840: 2020 2054 6865 2062 6163 6b67 726f 756e     The backgroun
+0001b850: 6420 7265 6769 6f6e 2069 7320 636f 6e73  d region is cons
+0001b860: 7472 7563 7465 6420 7573 696e 6720 7468  tructed using th
+0001b870: 6520 6261 636b 5f69 6e6e 5f72 6164 5f66  e back_inn_rad_f
+0001b880: 6163 746f 7220 616e 6420 6261 636b 5f6f  actor and back_o
+0001b890: 7574 5f72 6164 5f66 6163 746f 720a 2020  ut_rad_factor.  
+0001b8a0: 2020 2020 2020 7661 6c75 6573 2c20 7468        values, th
+0001b8b0: 6520 6465 6661 756c 7473 206f 6620 7768  e defaults of wh
+0001b8c0: 6963 6820 6172 6520 312e 3035 2a72 6164  ich are 1.05*rad
+0001b8d0: 6975 7320 616e 6420 312e 352a 7261 6469  ius and 1.5*radi
+0001b8e0: 7573 2072 6573 7065 6374 6976 656c 792e  us respectively.
+0001b8f0: 0a0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
+0001b900: 2051 7561 6e74 6974 792f 7374 7220 6f75   Quantity/str ou
+0001b910: 7465 725f 7261 6469 7573 3a20 5468 6520  ter_radius: The 
+0001b920: 7261 6469 7573 2074 6861 7420 534e 5220  radius that SNR 
+0001b930: 7368 6f75 6c64 2062 6520 6361 6c63 756c  should be calcul
+0001b940: 6174 6564 2077 6974 6869 6e2c 2074 6869  ated within, thi
+0001b950: 7320 6361 6e20 6569 7468 6572 2062 6520  s can either be 
+0001b960: 610a 2020 2020 2020 2020 2020 2020 6e61  a.            na
+0001b970: 6d65 6420 7261 6469 7573 2073 7563 6820  med radius such 
+0001b980: 6173 2072 3530 302c 206f 7220 616e 2061  as r500, or an a
+0001b990: 7374 726f 7079 2051 7561 6e74 6974 792e  stropy Quantity.
+0001b9a0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+0001b9b0: 5175 616e 7469 7479 2063 656e 7472 616c  Quantity central
+0001b9c0: 5f63 6f6f 7264 3a20 5468 6520 6365 6e74  _coord: The cent
+0001b9d0: 7261 6c20 636f 6f72 6469 6e61 7465 206f  ral coordinate o
+0001b9e0: 6620 7468 6520 7265 6769 6f6e 2e0a 2020  f the region..  
+0001b9f0: 2020 2020 2020 3a70 6172 616d 2051 7561        :param Qua
+0001ba00: 6e74 6974 7920 6c6f 5f65 6e3a 2054 6865  ntity lo_en: The
+0001ba10: 206c 6f77 6572 2065 6e65 7267 7920 626f   lower energy bo
+0001ba20: 756e 6420 6f66 2074 6865 2072 6174 656d  und of the ratem
+0001ba30: 6170 2074 6f20 7573 6520 746f 2063 616c  ap to use to cal
+0001ba40: 6375 6c61 7465 2074 6865 2053 4e52 2e20  culate the SNR. 
+0001ba50: 4465 6661 756c 7420 6973 204e 6f6e 652c  Default is None,
+0001ba60: 0a20 2020 2020 2020 2020 2020 2069 6e20  .            in 
+0001ba70: 7768 6963 6820 6361 7365 2074 6865 206c  which case the l
+0001ba80: 6f77 6572 2065 6e65 7267 7920 626f 756e  ower energy boun
+0001ba90: 6420 666f 7220 7065 616b 2066 696e 6469  d for peak findi
+0001baa0: 6e67 2077 696c 6c20 6265 2075 7365 6420  ng will be used 
+0001bab0: 2864 6566 6175 6c74 2069 7320 302e 356b  (default is 0.5k
+0001bac0: 6556 292e 0a20 2020 2020 2020 203a 7061  eV)..        :pa
+0001bad0: 7261 6d20 5175 616e 7469 7479 2068 695f  ram Quantity hi_
+0001bae0: 656e 3a20 5468 6520 7570 7065 7220 656e  en: The upper en
+0001baf0: 6572 6779 2062 6f75 6e64 206f 6620 7468  ergy bound of th
+0001bb00: 6520 7261 7465 6d61 7020 746f 2075 7365  e ratemap to use
+0001bb10: 2074 6f20 6361 6c63 756c 6174 6520 7468   to calculate th
+0001bb20: 6520 534e 522e 2044 6566 6175 6c74 2069  e SNR. Default i
+0001bb30: 7320 4e6f 6e65 2c0a 2020 2020 2020 2020  s None,.        
+0001bb40: 2020 2020 696e 2077 6869 6368 2063 6173      in which cas
+0001bb50: 6520 7468 6520 7570 7065 7220 656e 6572  e the upper ener
+0001bb60: 6779 2062 6f75 6e64 2066 6f72 2070 6561  gy bound for pea
+0001bb70: 6b20 6669 6e64 696e 6720 7769 6c6c 2062  k finding will b
+0001bb80: 6520 7573 6564 2028 6465 6661 756c 7420  e used (default 
+0001bb90: 6973 2032 2e30 6b65 5629 2e0a 2020 2020  is 2.0keV)..    
+0001bba0: 2020 2020 3a70 6172 616d 2073 7472 206f      :param str o
+0001bbb0: 6273 5f69 643a 2041 6e20 4f62 7349 4420  bs_id: An ObsID 
+0001bbc0: 6f66 2061 2073 7065 6369 6669 6320 7261  of a specific ra
+0001bbd0: 7465 6d61 7020 746f 2075 7365 2066 6f72  temap to use for
+0001bbe0: 2074 6865 2053 4e52 2063 616c 6375 6c61   the SNR calcula
+0001bbf0: 7469 6f6e 2e20 4465 6661 756c 7420 6973  tion. Default is
+0001bc00: 204e 6f6e 652c 2077 6869 6368 0a20 2020   None, which.   
+0001bc10: 2020 2020 2020 2020 206d 6561 6e73 2074           means t
+0001bc20: 6865 2063 6f6d 6269 6e65 6420 7261 7465  he combined rate
+0001bc30: 6d61 7020 7769 6c6c 2062 6520 7573 6564  map will be used
+0001bc40: 2e20 506c 6561 7365 206e 6f74 6520 7468  . Please note th
+0001bc50: 6174 2069 6e73 7420 6d75 7374 2061 6c73  at inst must als
+0001bc60: 6f20 6265 2073 6574 2074 6f20 7573 6520  o be set to use 
+0001bc70: 7468 6973 206f 7074 696f 6e2e 0a20 2020  this option..   
+0001bc80: 2020 2020 203a 7061 7261 6d20 7374 7220       :param str 
+0001bc90: 696e 7374 3a20 5468 6520 696e 7374 7275  inst: The instru
+0001bca0: 6d65 6e74 206f 6620 6120 7370 6563 6966  ment of a specif
+0001bcb0: 6963 2072 6174 656d 6170 2074 6f20 7573  ic ratemap to us
+0001bcc0: 6520 666f 7220 7468 6520 534e 5220 6361  e for the SNR ca
+0001bcd0: 6c63 756c 6174 696f 6e2e 2044 6566 6175  lculation. Defau
+0001bce0: 6c74 2069 7320 4e6f 6e65 2c20 7768 6963  lt is None, whic
+0001bcf0: 680a 2020 2020 2020 2020 2020 2020 6d65  h.            me
+0001bd00: 616e 7320 7468 6520 636f 6d62 696e 6564  ans the combined
+0001bd10: 2072 6174 656d 6170 2077 696c 6c20 6265   ratemap will be
+0001bd20: 2075 7365 642e 0a20 2020 2020 2020 203a   used..        :
+0001bd30: 7061 7261 6d20 626f 6f6c 2070 7366 5f63  param bool psf_c
+0001bd40: 6f72 723a 2053 6574 7320 7768 6574 6865  orr: Sets whethe
+0001bd50: 7220 796f 7520 7769 7368 2074 6f20 7573  r you wish to us
+0001bd60: 6520 6120 5053 4620 636f 7272 6563 7465  e a PSF correcte
+0001bd70: 6420 7261 7465 6d61 7020 6f72 206e 6f74  d ratemap or not
+0001bd80: 2e0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
+0001bd90: 2073 7472 2070 7366 5f6d 6f64 656c 3a20   str psf_model: 
+0001bda0: 4966 2074 6865 2072 6174 656d 6170 2079  If the ratemap y
+0001bdb0: 6f75 2077 616e 7420 746f 2075 7365 2069  ou want to use i
+0001bdc0: 7320 5053 4620 636f 7272 6563 7465 642c  s PSF corrected,
+0001bdd0: 2074 6869 7320 6973 2074 6865 2050 5346   this is the PSF
+0001bde0: 206d 6f64 656c 2075 7365 642e 0a20 2020   model used..   
+0001bdf0: 2020 2020 203a 7061 7261 6d20 696e 7420       :param int 
+0001be00: 7073 665f 6269 6e73 3a20 4966 2074 6865  psf_bins: If the
+0001be10: 2072 6174 656d 6170 2079 6f75 2077 616e   ratemap you wan
+0001be20: 7420 746f 2075 7365 2069 7320 5053 4620  t to use is PSF 
+0001be30: 636f 7272 6563 7465 642c 2074 6869 7320  corrected, this 
+0001be40: 6973 2074 6865 206e 756d 6265 7220 6f66  is the number of
+0001be50: 2050 5346 7320 7065 720a 2020 2020 2020   PSFs per.      
+0001be60: 2020 2020 2020 7369 6465 2069 6e20 7468        side in th
+0001be70: 6520 5053 4620 6772 6964 2e0a 2020 2020  e PSF grid..    
+0001be80: 2020 2020 3a70 6172 616d 2073 7472 2070      :param str p
+0001be90: 7366 5f61 6c67 6f3a 2049 6620 7468 6520  sf_algo: If the 
+0001bea0: 7261 7465 6d61 7020 796f 7520 7761 6e74  ratemap you want
+0001beb0: 2074 6f20 7573 6520 6973 2050 5346 2063   to use is PSF c
+0001bec0: 6f72 7265 6374 6564 2c20 7468 6973 2069  orrected, this i
+0001bed0: 7320 7468 6520 616c 676f 7269 7468 6d20  s the algorithm 
+0001bee0: 7573 6564 2e0a 2020 2020 2020 2020 3a70  used..        :p
+0001bef0: 6172 616d 2069 6e74 2070 7366 5f69 7465  aram int psf_ite
+0001bf00: 723a 2049 6620 7468 6520 7261 7465 6d61  r: If the ratema
+0001bf10: 7020 796f 7520 7761 6e74 2074 6f20 7573  p you want to us
+0001bf20: 6520 6973 2050 5346 2063 6f72 7265 6374  e is PSF correct
+0001bf30: 6564 2c20 7468 6973 2069 7320 7468 6520  ed, this is the 
+0001bf40: 6e75 6d62 6572 206f 6620 6974 6572 6174  number of iterat
+0001bf50: 696f 6e73 2e0a 2020 2020 2020 2020 3a70  ions..        :p
+0001bf60: 6172 616d 2062 6f6f 6c20 616c 6c6f 775f  aram bool allow_
+0001bf70: 6e65 6761 7469 7665 3a20 5368 6f75 6c64  negative: Should
+0001bf80: 2070 6978 656c 7320 696e 2074 6865 2062   pixels in the b
+0001bf90: 6163 6b67 726f 756e 6420 7375 6274 7261  ackground subtra
+0001bfa0: 6374 6564 2063 6f75 6e74 206d 6170 2062  cted count map b
+0001bfb0: 6520 616c 6c6f 7765 6420 746f 2067 6f20  e allowed to go 
+0001bfc0: 6265 6c6f 770a 2020 2020 2020 2020 2020  below.          
+0001bfd0: 2020 7a65 726f 2c20 7768 6963 6820 7265    zero, which re
+0001bfe0: 7375 6c74 7320 696e 2061 206c 6f77 6572  sults in a lower
+0001bff0: 2073 6967 6e61 6c20 746f 206e 6f69 7365   signal to noise
+0001c000: 2028 616e 6420 6361 6e20 7265 7375 6c74   (and can result
+0001c010: 2069 6e20 6120 6e65 6761 7469 7665 2073   in a negative s
+0001c020: 6967 6e61 6c20 746f 206e 6f69 7365 292e  ignal to noise).
+0001c030: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+0001c040: 626f 6f6c 2065 7870 5f63 6f72 723a 2053  bool exp_corr: S
+0001c050: 686f 756c 6420 7369 676e 616c 2074 6f20  hould signal to 
+0001c060: 6e6f 6973 6573 2062 6520 6d65 6173 7572  noises be measur
+0001c070: 6564 2077 6974 6820 6578 706f 7375 7265  ed with exposure
+0001c080: 2074 696d 6520 636f 7272 6563 7469 6f6e   time correction
+0001c090: 2c20 6465 6661 756c 7420 6973 2054 7275  , default is Tru
+0001c0a0: 652e 2049 0a20 2020 2020 2020 2020 2020  e. I.           
+0001c0b0: 2072 6563 6f6d 6d65 6e64 2074 6861 7420   recommend that 
+0001c0c0: 7468 6973 2062 6520 7472 7565 2066 6f72  this be true for
+0001c0d0: 2063 6f6d 6269 6e65 6420 6f62 7365 7276   combined observ
+0001c0e0: 6174 696f 6e73 2c20 6173 2065 7870 6f73  ations, as expos
+0001c0f0: 7572 6520 7469 6d65 2063 6f75 6c64 2063  ure time could c
+0001c100: 6861 6e67 6520 7175 6974 6520 6472 616d  hange quite dram
+0001c110: 6174 6963 616c 6c79 0a20 2020 2020 2020  atically.       
+0001c120: 2020 2020 2061 6372 6f73 7320 7468 6520       across the 
+0001c130: 636f 6d62 696e 6564 2070 726f 6475 6374  combined product
+0001c140: 2e0a 2020 2020 2020 2020 3a72 6574 7572  ..        :retur
+0001c150: 6e3a 2054 6865 2073 6967 6e61 6c20 746f  n: The signal to
+0001c160: 206e 6f69 7365 2072 6174 696f 2e0a 2020   noise ratio..  
+0001c170: 2020 2020 2020 3a72 7479 7065 3a20 666c        :rtype: fl
+0001c180: 6f61 740a 2020 2020 2020 2020 2222 220a  oat.        """.
+0001c190: 2020 2020 2020 2020 2320 4368 6563 6b69          # Checki
+0001c1a0: 6e67 2069 6620 7468 6520 7573 6572 2070  ng if the user p
+0001c1b0: 6173 7365 6420 616e 7920 656e 6572 6779  assed any energy
+0001c1c0: 206c 696d 6974 7320 6f66 2074 6865 6972   limits of their
+0001c1d0: 206f 776e 0a20 2020 2020 2020 2069 6620   own.        if 
+0001c1e0: 6c6f 5f65 6e20 6973 204e 6f6e 653a 0a20  lo_en is None:. 
+0001c1f0: 2020 2020 2020 2020 2020 206c 6f5f 656e             lo_en
+0001c200: 203d 2073 656c 662e 5f70 6561 6b5f 6c6f   = self._peak_lo
+0001c210: 5f65 6e0a 2020 2020 2020 2020 6966 2068  _en.        if h
+0001c220: 695f 656e 2069 7320 4e6f 6e65 3a0a 2020  i_en is None:.  
+0001c230: 2020 2020 2020 2020 2020 6869 5f65 6e20            hi_en 
+0001c240: 3d20 7365 6c66 2e5f 7065 616b 5f68 695f  = self._peak_hi_
+0001c250: 656e 0a0a 2020 2020 2020 2020 2320 5061  en..        # Pa
+0001c260: 7273 696e 6720 7468 6520 4f62 7349 4420  rsing the ObsID 
+0001c270: 616e 6420 696e 7374 7275 6d65 6e74 206f  and instrument o
+0001c280: 7074 696f 6e73 2c20 7365 6520 6966 2074  ptions, see if t
+0001c290: 6865 7920 7761 6e74 2074 6f20 7573 6520  hey want to use 
+0001c2a0: 6120 7370 6563 6966 6963 2072 6174 656d  a specific ratem
+0001c2b0: 6170 0a20 2020 2020 2020 2069 6620 616c  ap.        if al
+0001c2c0: 6c28 5b6f 6273 5f69 6420 6973 204e 6f6e  l([obs_id is Non
+0001c2d0: 652c 2069 6e73 7420 6973 204e 6f6e 655d  e, inst is None]
+0001c2e0: 293a 0a20 2020 2020 2020 2020 2020 2023  ):.            #
+0001c2f0: 2048 6572 6520 7468 6520 7573 6572 2068   Here the user h
+0001c300: 6173 6e27 7420 7365 7420 4f62 7349 4420  asn't set ObsID 
+0001c310: 6f72 2069 6e73 7472 756d 656e 742c 2073  or instrument, s
+0001c320: 6f20 7765 2075 7365 2074 6865 2063 6f6d  o we use the com
+0001c330: 6269 6e65 6420 6461 7461 0a20 2020 2020  bined data.     
+0001c340: 2020 2020 2020 2072 7420 3d20 7365 6c66         rt = self
+0001c350: 2e67 6574 5f63 6f6d 6269 6e65 645f 7261  .get_combined_ra
+0001c360: 7465 6d61 7073 286c 6f5f 656e 2c20 6869  temaps(lo_en, hi
+0001c370: 5f65 6e2c 2070 7366 5f63 6f72 722c 2070  _en, psf_corr, p
+0001c380: 7366 5f6d 6f64 656c 2c20 7073 665f 6269  sf_model, psf_bi
+0001c390: 6e73 2c20 7073 665f 616c 676f 2c20 7073  ns, psf_algo, ps
+0001c3a0: 665f 6974 6572 290a 0a20 2020 2020 2020  f_iter)..       
+0001c3b0: 2065 6c69 6620 616c 6c28 5b6f 6273 5f69   elif all([obs_i
+0001c3c0: 6420 6973 206e 6f74 204e 6f6e 652c 2069  d is not None, i
+0001c3d0: 6e73 7420 6973 206e 6f74 204e 6f6e 655d  nst is not None]
+0001c3e0: 293a 0a20 2020 2020 2020 2020 2020 2023  ):.            #
+0001c3f0: 2042 6f74 6820 4f62 7349 4420 616e 6420   Both ObsID and 
+0001c400: 696e 7374 7275 6d65 6e74 2068 6176 6520  instrument have 
+0001c410: 6265 656e 2073 6574 2062 7920 7468 6520  been set by the 
+0001c420: 7573 6572 0a20 2020 2020 2020 2020 2020  user.           
+0001c430: 2072 7420 3d20 7365 6c66 2e67 6574 5f72   rt = self.get_r
+0001c440: 6174 656d 6170 7328 6f62 735f 6964 2c20  atemaps(obs_id, 
+0001c450: 696e 7374 2c20 6c6f 5f65 6e2c 2068 695f  inst, lo_en, hi_
+0001c460: 656e 2c20 7073 665f 636f 7272 2c20 7073  en, psf_corr, ps
+0001c470: 665f 6d6f 6465 6c2c 2070 7366 5f62 696e  f_model, psf_bin
+0001c480: 732c 2070 7366 5f61 6c67 6f2c 2070 7366  s, psf_algo, psf
+0001c490: 5f69 7465 7229 0a20 2020 2020 2020 2065  _iter).        e
+0001c4a0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0001c4b0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+0001c4c0: 7228 2249 6620 796f 7520 7769 7368 2074  r("If you wish t
+0001c4d0: 6f20 7573 6520 6120 7370 6563 6966 6963  o use a specific
+0001c4e0: 2072 6174 656d 6170 2066 6f72 207b 737d   ratemap for {s}
+0001c4f0: 2773 2073 6967 6e61 6c20 746f 206e 6f69  's signal to noi
+0001c500: 7365 2063 616c 6375 6c61 7469 6f6e 2c20  se calculation, 
+0001c510: 706c 6561 7365 2022 0a20 2020 2020 2020  please ".       
+0001c520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c530: 2020 2020 2020 2220 7061 7373 2062 6f74        " pass bot
+0001c540: 6820 6f62 735f 6964 2061 6e64 2069 6e73  h obs_id and ins
+0001c550: 742e 222e 666f 726d 6174 2873 3d73 656c  t.".format(s=sel
+0001c560: 662e 6e61 6d65 2929 0a0a 2020 2020 2020  f.name))..      
+0001c570: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+0001c580: 6f75 7465 725f 7261 6469 7573 2c20 7374  outer_radius, st
+0001c590: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+0001c5a0: 2320 4772 6162 7320 7468 6520 696e 7465  # Grabs the inte
+0001c5b0: 726c 6f70 6572 2072 656d 6f76 6564 2073  rloper removed s
+0001c5c0: 6f75 7263 6520 616e 6420 6261 636b 6772  ource and backgr
+0001c5d0: 6f75 6e64 2072 6567 696f 6e20 6d61 736b  ound region mask
+0001c5e0: 732e 2049 6620 7468 6520 4f62 7349 4420  s. If the ObsID 
+0001c5f0: 6973 204e 6f6e 6520 7468 6520 6765 745f  is None the get_
+0001c600: 6d61 736b 0a20 2020 2020 2020 2020 2020  mask.           
+0001c610: 2023 2020 6d65 7468 6f64 2075 6e64 6572   #  method under
+0001c620: 7374 616e 6473 2074 6861 7420 6d65 616e  stands that mean
+0001c630: 7320 6974 2073 686f 756c 6420 7265 7475  s it should retu
+0001c640: 726e 2074 6865 206d 6173 6b20 666f 7220  rn the mask for 
+0001c650: 7468 6520 636f 6d62 696e 6564 2064 6174  the combined dat
+0001c660: 610a 2020 2020 2020 2020 2020 2020 7372  a.            sr
+0001c670: 635f 6d61 736b 2c20 6263 6b5f 6d61 736b  c_mask, bck_mask
+0001c680: 203d 2073 656c 662e 6765 745f 6d61 736b   = self.get_mask
+0001c690: 286f 7574 6572 5f72 6164 6975 732c 206f  (outer_radius, o
+0001c6a0: 6273 5f69 642c 2063 656e 7472 616c 5f63  bs_id, central_c
+0001c6b0: 6f6f 7264 290a 2020 2020 2020 2020 656c  oord).        el
+0001c6c0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0001c6d0: 2320 4865 7265 2077 6520 6861 7665 2074  # Here we have t
+0001c6e0: 6865 2063 6173 6520 7768 6572 6520 7468  he case where th
+0001c6f0: 6520 7573 6572 2068 6173 2070 6173 7365  e user has passe
+0001c700: 6420 6120 6375 7374 6f6d 206f 7574 6572  d a custom outer
+0001c710: 2072 6164 6975 732c 2073 6f20 7765 206e   radius, so we n
+0001c720: 6565 6420 746f 2067 656e 6572 6174 6520  eed to generate 
+0001c730: 610a 2020 2020 2020 2020 2020 2020 2320  a.            # 
+0001c740: 2063 7573 746f 6d20 6d61 736b 2066 6f72   custom mask for
+0001c750: 2069 740a 2020 2020 2020 2020 2020 2020   it.            
+0001c760: 7372 635f 6d61 736b 203d 2073 656c 662e  src_mask = self.
+0001c770: 6765 745f 6375 7374 6f6d 5f6d 6173 6b28  get_custom_mask(
+0001c780: 6f75 7465 725f 7261 6469 7573 2c20 6f62  outer_radius, ob
+0001c790: 735f 6964 3d6f 6273 5f69 642c 2063 656e  s_id=obs_id, cen
+0001c7a0: 7472 616c 5f63 6f6f 7264 3d63 656e 7472  tral_coord=centr
+0001c7b0: 616c 5f63 6f6f 7264 290a 2020 2020 2020  al_coord).      
+0001c7c0: 2020 2020 2020 6263 6b5f 6d61 736b 203d        bck_mask =
+0001c7d0: 2073 656c 662e 6765 745f 6375 7374 6f6d   self.get_custom
+0001c7e0: 5f6d 6173 6b28 6f75 7465 725f 7261 6469  _mask(outer_radi
+0001c7f0: 7573 2a73 656c 662e 5f62 6163 6b5f 6f75  us*self._back_ou
+0001c800: 745f 6661 6374 6f72 2c20 6f75 7465 725f  t_factor, outer_
+0001c810: 7261 6469 7573 2a73 656c 662e 5f62 6163  radius*self._bac
+0001c820: 6b5f 696e 6e5f 6661 6374 6f72 2c0a 2020  k_inn_factor,.  
+0001c830: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001c840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c850: 2020 2068 695f 656e 3a20 5175 616e 7469     hi_en: Quanti
-0001c860: 7479 203d 204e 6f6e 652c 206f 6273 5f69  ty = None, obs_i
-0001c870: 643a 2073 7472 203d 204e 6f6e 652c 2069  d: str = None, i
-0001c880: 6e73 743a 2073 7472 203d 204e 6f6e 652c  nst: str = None,
-0001c890: 2070 7366 5f63 6f72 723a 2062 6f6f 6c20   psf_corr: bool 
-0001c8a0: 3d20 4661 6c73 652c 0a20 2020 2020 2020  = False,.       
-0001c8b0: 2020 2020 2020 2020 2020 2020 7073 665f              psf_
-0001c8c0: 6d6f 6465 6c3a 2073 7472 203d 2022 454c  model: str = "EL
-0001c8d0: 4c42 4554 4122 2c20 7073 665f 6269 6e73  LBETA", psf_bins
-0001c8e0: 3a20 696e 7420 3d20 342c 2070 7366 5f61  : int = 4, psf_a
-0001c8f0: 6c67 6f3a 2073 7472 203d 2022 726c 222c  lgo: str = "rl",
-0001c900: 2070 7366 5f69 7465 723a 2069 6e74 203d   psf_iter: int =
-0001c910: 2031 3529 202d 3e20 5175 616e 7469 7479   15) -> Quantity
-0001c920: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-0001c930: 2020 2020 2020 5468 6973 2074 616b 6573        This takes
-0001c940: 2061 2072 6567 696f 6e20 7479 7065 2061   a region type a
-0001c950: 6e64 2063 656e 7472 616c 2063 6f6f 7264  nd central coord
-0001c960: 696e 6174 6520 616e 6420 6361 6c63 756c  inate and calcul
-0001c970: 6174 6573 2074 6865 2062 6163 6b67 726f  ates the backgro
-0001c980: 756e 6420 7375 6274 7261 6374 6564 2058  und subtracted X
-0001c990: 2d72 6179 2063 6f75 6e74 732e 0a20 2020  -ray counts..   
-0001c9a0: 2020 2020 2054 6865 2062 6163 6b67 726f       The backgro
-0001c9b0: 756e 6420 7265 6769 6f6e 2069 7320 636f  und region is co
-0001c9c0: 6e73 7472 7563 7465 6420 7573 696e 6720  nstructed using 
-0001c9d0: 7468 6520 6261 636b 5f69 6e6e 5f72 6164  the back_inn_rad
-0001c9e0: 5f66 6163 746f 7220 616e 6420 6261 636b  _factor and back
-0001c9f0: 5f6f 7574 5f72 6164 5f66 6163 746f 720a  _out_rad_factor.
-0001ca00: 2020 2020 2020 2020 7661 6c75 6573 2c20          values, 
-0001ca10: 7468 6520 6465 6661 756c 7473 206f 6620  the defaults of 
-0001ca20: 7768 6963 6820 6172 6520 312e 3035 2a72  which are 1.05*r
-0001ca30: 6164 6975 7320 616e 6420 312e 352a 7261  adius and 1.5*ra
-0001ca40: 6469 7573 2072 6573 7065 6374 6976 656c  dius respectivel
-0001ca50: 792e 0a0a 2020 2020 2020 2020 3a70 6172  y...        :par
-0001ca60: 616d 2051 7561 6e74 6974 792f 7374 7220  am Quantity/str 
-0001ca70: 6f75 7465 725f 7261 6469 7573 3a20 5468  outer_radius: Th
-0001ca80: 6520 7261 6469 7573 2074 6861 7420 636f  e radius that co
-0001ca90: 756e 7473 2073 686f 756c 6420 6265 2063  unts should be c
-0001caa0: 616c 6375 6c61 7465 6420 7769 7468 696e  alculated within
-0001cab0: 2c20 7468 6973 2063 616e 2065 6974 6865  , this can eithe
-0001cac0: 7220 6265 2061 0a20 2020 2020 2020 2020  r be a.         
-0001cad0: 2020 206e 616d 6564 2072 6164 6975 7320     named radius 
-0001cae0: 7375 6368 2061 7320 7235 3030 2c20 6f72  such as r500, or
-0001caf0: 2061 6e20 6173 7472 6f70 7920 5175 616e   an astropy Quan
-0001cb00: 7469 7479 2e0a 2020 2020 2020 2020 3a70  tity..        :p
-0001cb10: 6172 616d 2051 7561 6e74 6974 7920 6365  aram Quantity ce
-0001cb20: 6e74 7261 6c5f 636f 6f72 643a 2054 6865  ntral_coord: The
-0001cb30: 2063 656e 7472 616c 2063 6f6f 7264 696e   central coordin
-0001cb40: 6174 6520 6f66 2074 6865 2072 6567 696f  ate of the regio
-0001cb50: 6e2e 0a20 2020 2020 2020 203a 7061 7261  n..        :para
-0001cb60: 6d20 5175 616e 7469 7479 206c 6f5f 656e  m Quantity lo_en
-0001cb70: 3a20 5468 6520 6c6f 7765 7220 656e 6572  : The lower ener
-0001cb80: 6779 2062 6f75 6e64 206f 6620 7468 6520  gy bound of the 
-0001cb90: 7261 7465 6d61 7020 746f 2075 7365 2074  ratemap to use t
-0001cba0: 6f20 6361 6c63 756c 6174 6520 7468 6520  o calculate the 
-0001cbb0: 636f 756e 7473 2e20 4465 6661 756c 7420  counts. Default 
-0001cbc0: 6973 204e 6f6e 652c 0a20 2020 2020 2020  is None,.       
-0001cbd0: 2020 2020 2069 6e20 7768 6963 6820 6361       in which ca
-0001cbe0: 7365 2074 6865 206c 6f77 6572 2065 6e65  se the lower ene
-0001cbf0: 7267 7920 626f 756e 6420 666f 7220 7065  rgy bound for pe
-0001cc00: 616b 2066 696e 6469 6e67 2077 696c 6c20  ak finding will 
-0001cc10: 6265 2075 7365 6420 2864 6566 6175 6c74  be used (default
-0001cc20: 2069 7320 302e 356b 6556 292e 0a20 2020   is 0.5keV)..   
-0001cc30: 2020 2020 203a 7061 7261 6d20 5175 616e       :param Quan
-0001cc40: 7469 7479 2068 695f 656e 3a20 5468 6520  tity hi_en: The 
-0001cc50: 7570 7065 7220 656e 6572 6779 2062 6f75  upper energy bou
-0001cc60: 6e64 206f 6620 7468 6520 7261 7465 6d61  nd of the ratema
-0001cc70: 7020 746f 2075 7365 2074 6f20 6361 6c63  p to use to calc
-0001cc80: 756c 6174 6520 7468 6520 636f 756e 7473  ulate the counts
-0001cc90: 2e20 4465 6661 756c 7420 6973 204e 6f6e  . Default is Non
-0001cca0: 652c 0a20 2020 2020 2020 2020 2020 2069  e,.            i
-0001ccb0: 6e20 7768 6963 6820 6361 7365 2074 6865  n which case the
-0001ccc0: 2075 7070 6572 2065 6e65 7267 7920 626f   upper energy bo
-0001ccd0: 756e 6420 666f 7220 7065 616b 2066 696e  und for peak fin
-0001cce0: 6469 6e67 2077 696c 6c20 6265 2075 7365  ding will be use
-0001ccf0: 6420 2864 6566 6175 6c74 2069 7320 322e  d (default is 2.
-0001cd00: 306b 6556 292e 0a20 2020 2020 2020 203a  0keV)..        :
-0001cd10: 7061 7261 6d20 7374 7220 6f62 735f 6964  param str obs_id
-0001cd20: 3a20 416e 204f 6273 4944 206f 6620 6120  : An ObsID of a 
-0001cd30: 7370 6563 6966 6963 2072 6174 656d 6170  specific ratemap
-0001cd40: 2074 6f20 7573 6520 666f 7220 7468 6520   to use for the 
-0001cd50: 636f 756e 7473 2063 616c 6375 6c61 7469  counts calculati
-0001cd60: 6f6e 2e20 4465 6661 756c 7420 6973 204e  on. Default is N
-0001cd70: 6f6e 652c 2077 6869 6368 0a20 2020 2020  one, which.     
-0001cd80: 2020 2020 2020 206d 6561 6e73 2074 6865         means the
-0001cd90: 2063 6f6d 6269 6e65 6420 7261 7465 6d61   combined ratema
-0001cda0: 7020 7769 6c6c 2062 6520 7573 6564 2e20  p will be used. 
-0001cdb0: 506c 6561 7365 206e 6f74 6520 7468 6174  Please note that
-0001cdc0: 2069 6e73 7420 6d75 7374 2061 6c73 6f20   inst must also 
-0001cdd0: 6265 2073 6574 2074 6f20 7573 6520 7468  be set to use th
-0001cde0: 6973 206f 7074 696f 6e2e 0a20 2020 2020  is option..     
-0001cdf0: 2020 203a 7061 7261 6d20 7374 7220 696e     :param str in
-0001ce00: 7374 3a20 5468 6520 696e 7374 7275 6d65  st: The instrume
-0001ce10: 6e74 206f 6620 6120 7370 6563 6966 6963  nt of a specific
-0001ce20: 2072 6174 656d 6170 2074 6f20 7573 6520   ratemap to use 
-0001ce30: 666f 7220 7468 6520 636f 756e 7473 2063  for the counts c
-0001ce40: 616c 6375 6c61 7469 6f6e 2e20 4465 6661  alculation. Defa
-0001ce50: 756c 7420 6973 204e 6f6e 652c 2077 6869  ult is None, whi
-0001ce60: 6368 0a20 2020 2020 2020 2020 2020 206d  ch.            m
-0001ce70: 6561 6e73 2074 6865 2063 6f6d 6269 6e65  eans the combine
-0001ce80: 6420 7261 7465 6d61 7020 7769 6c6c 2062  d ratemap will b
-0001ce90: 6520 7573 6564 2e0a 2020 2020 2020 2020  e used..        
-0001cea0: 3a70 6172 616d 2062 6f6f 6c20 7073 665f  :param bool psf_
-0001ceb0: 636f 7272 3a20 5365 7473 2077 6865 7468  corr: Sets wheth
-0001cec0: 6572 2079 6f75 2077 6973 6820 746f 2075  er you wish to u
-0001ced0: 7365 2061 2050 5346 2063 6f72 7265 6374  se a PSF correct
-0001cee0: 6564 2072 6174 656d 6170 206f 7220 6e6f  ed ratemap or no
-0001cef0: 742e 0a20 2020 2020 2020 203a 7061 7261  t..        :para
-0001cf00: 6d20 7374 7220 7073 665f 6d6f 6465 6c3a  m str psf_model:
-0001cf10: 2049 6620 7468 6520 7261 7465 6d61 7020   If the ratemap 
-0001cf20: 796f 7520 7761 6e74 2074 6f20 7573 6520  you want to use 
-0001cf30: 6973 2050 5346 2063 6f72 7265 6374 6564  is PSF corrected
-0001cf40: 2c20 7468 6973 2069 7320 7468 6520 5053  , this is the PS
-0001cf50: 4620 6d6f 6465 6c20 7573 6564 2e0a 2020  F model used..  
-0001cf60: 2020 2020 2020 3a70 6172 616d 2069 6e74        :param int
-0001cf70: 2070 7366 5f62 696e 733a 2049 6620 7468   psf_bins: If th
-0001cf80: 6520 7261 7465 6d61 7020 796f 7520 7761  e ratemap you wa
-0001cf90: 6e74 2074 6f20 7573 6520 6973 2050 5346  nt to use is PSF
-0001cfa0: 2063 6f72 7265 6374 6564 2c20 7468 6973   corrected, this
-0001cfb0: 2069 7320 7468 6520 6e75 6d62 6572 206f   is the number o
-0001cfc0: 6620 5053 4673 2070 6572 0a20 2020 2020  f PSFs per.     
-0001cfd0: 2020 2020 2020 2073 6964 6520 696e 2074         side in t
-0001cfe0: 6865 2050 5346 2067 7269 642e 0a20 2020  he PSF grid..   
-0001cff0: 2020 2020 203a 7061 7261 6d20 7374 7220       :param str 
-0001d000: 7073 665f 616c 676f 3a20 4966 2074 6865  psf_algo: If the
-0001d010: 2072 6174 656d 6170 2079 6f75 2077 616e   ratemap you wan
-0001d020: 7420 746f 2075 7365 2069 7320 5053 4620  t to use is PSF 
-0001d030: 636f 7272 6563 7465 642c 2074 6869 7320  corrected, this 
-0001d040: 6973 2074 6865 2061 6c67 6f72 6974 686d  is the algorithm
-0001d050: 2075 7365 642e 0a20 2020 2020 2020 203a   used..        :
-0001d060: 7061 7261 6d20 696e 7420 7073 665f 6974  param int psf_it
-0001d070: 6572 3a20 4966 2074 6865 2072 6174 656d  er: If the ratem
-0001d080: 6170 2079 6f75 2077 616e 7420 746f 2075  ap you want to u
-0001d090: 7365 2069 7320 5053 4620 636f 7272 6563  se is PSF correc
-0001d0a0: 7465 642c 2074 6869 7320 6973 2074 6865  ted, this is the
-0001d0b0: 206e 756d 6265 7220 6f66 2069 7465 7261   number of itera
-0001d0c0: 7469 6f6e 732e 0a20 2020 2020 2020 203a  tions..        :
-0001d0d0: 7265 7475 726e 3a20 5468 6520 6261 636b  return: The back
-0001d0e0: 6772 6f75 6e64 2073 7562 7472 6163 7465  ground subtracte
-0001d0f0: 6420 636f 756e 7473 2e0a 2020 2020 2020  d counts..      
-0001d100: 2020 3a72 7479 7065 3a20 5175 616e 7469    :rtype: Quanti
-0001d110: 7479 0a20 2020 2020 2020 2022 2222 0a20  ty.        """. 
-0001d120: 2020 2020 2020 2023 2043 6865 636b 696e         # Checkin
-0001d130: 6720 6966 2074 6865 2075 7365 7220 7061  g if the user pa
-0001d140: 7373 6564 2061 6e79 2065 6e65 7267 7920  ssed any energy 
-0001d150: 6c69 6d69 7473 206f 6620 7468 6569 7220  limits of their 
-0001d160: 6f77 6e0a 2020 2020 2020 2020 6966 206c  own.        if l
-0001d170: 6f5f 656e 2069 7320 4e6f 6e65 3a0a 2020  o_en is None:.  
-0001d180: 2020 2020 2020 2020 2020 6c6f 5f65 6e20            lo_en 
-0001d190: 3d20 7365 6c66 2e5f 7065 616b 5f6c 6f5f  = self._peak_lo_
-0001d1a0: 656e 0a20 2020 2020 2020 2069 6620 6869  en.        if hi
-0001d1b0: 5f65 6e20 6973 204e 6f6e 653a 0a20 2020  _en is None:.   
-0001d1c0: 2020 2020 2020 2020 2068 695f 656e 203d           hi_en =
-0001d1d0: 2073 656c 662e 5f70 6561 6b5f 6869 5f65   self._peak_hi_e
-0001d1e0: 6e0a 0a20 2020 2020 2020 2023 2050 6172  n..        # Par
-0001d1f0: 7369 6e67 2074 6865 204f 6273 4944 2061  sing the ObsID a
-0001d200: 6e64 2069 6e73 7472 756d 656e 7420 6f70  nd instrument op
-0001d210: 7469 6f6e 732c 2073 6565 2069 6620 7468  tions, see if th
-0001d220: 6579 2077 616e 7420 746f 2075 7365 2061  ey want to use a
-0001d230: 2073 7065 6369 6669 6320 7261 7465 6d61   specific ratema
-0001d240: 700a 2020 2020 2020 2020 6966 2061 6c6c  p.        if all
-0001d250: 285b 6f62 735f 6964 2069 7320 4e6f 6e65  ([obs_id is None
-0001d260: 2c20 696e 7374 2069 7320 4e6f 6e65 5d29  , inst is None])
-0001d270: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-0001d280: 4865 7265 2074 6865 2075 7365 7220 6861  Here the user ha
-0001d290: 736e 2774 2073 6574 204f 6273 4944 206f  sn't set ObsID o
-0001d2a0: 7220 696e 7374 7275 6d65 6e74 2c20 736f  r instrument, so
-0001d2b0: 2077 6520 7573 6520 7468 6520 636f 6d62   we use the comb
-0001d2c0: 696e 6564 2064 6174 610a 2020 2020 2020  ined data.      
-0001d2d0: 2020 2020 2020 7274 203d 2073 656c 662e        rt = self.
-0001d2e0: 6765 745f 636f 6d62 696e 6564 5f72 6174  get_combined_rat
-0001d2f0: 656d 6170 7328 6c6f 5f65 6e2c 2068 695f  emaps(lo_en, hi_
-0001d300: 656e 2c20 7073 665f 636f 7272 2c20 7073  en, psf_corr, ps
-0001d310: 665f 6d6f 6465 6c2c 2070 7366 5f62 696e  f_model, psf_bin
-0001d320: 732c 2070 7366 5f61 6c67 6f2c 2070 7366  s, psf_algo, psf
-0001d330: 5f69 7465 7229 0a0a 2020 2020 2020 2020  _iter)..        
-0001d340: 656c 6966 2061 6c6c 285b 6f62 735f 6964  elif all([obs_id
-0001d350: 2069 7320 6e6f 7420 4e6f 6e65 2c20 696e   is not None, in
-0001d360: 7374 2069 7320 6e6f 7420 4e6f 6e65 5d29  st is not None])
-0001d370: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-0001d380: 426f 7468 204f 6273 4944 2061 6e64 2069  Both ObsID and i
-0001d390: 6e73 7472 756d 656e 7420 6861 7665 2062  nstrument have b
-0001d3a0: 6565 6e20 7365 7420 6279 2074 6865 2075  een set by the u
-0001d3b0: 7365 720a 2020 2020 2020 2020 2020 2020  ser.            
-0001d3c0: 7274 203d 2073 656c 662e 6765 745f 7261  rt = self.get_ra
-0001d3d0: 7465 6d61 7073 286f 6273 5f69 642c 2069  temaps(obs_id, i
-0001d3e0: 6e73 742c 206c 6f5f 656e 2c20 6869 5f65  nst, lo_en, hi_e
-0001d3f0: 6e2c 2070 7366 5f63 6f72 722c 2070 7366  n, psf_corr, psf
-0001d400: 5f6d 6f64 656c 2c20 7073 665f 6269 6e73  _model, psf_bins
-0001d410: 2c20 7073 665f 616c 676f 2c20 7073 665f  , psf_algo, psf_
-0001d420: 6974 6572 290a 2020 2020 2020 2020 656c  iter).        el
-0001d430: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0001d440: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-0001d450: 2822 4966 2079 6f75 2077 6973 6820 746f  ("If you wish to
-0001d460: 2075 7365 2061 2073 7065 6369 6669 6320   use a specific 
-0001d470: 7261 7465 6d61 7020 666f 7220 7b73 7d27  ratemap for {s}'
-0001d480: 7320 7369 676e 616c 2074 6f20 6e6f 6973  s signal to nois
-0001d490: 6520 6361 6c63 756c 6174 696f 6e2c 2070  e calculation, p
-0001d4a0: 6c65 6173 6520 220a 2020 2020 2020 2020  lease ".        
-0001d4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d4c0: 2020 2020 2022 2070 6173 7320 626f 7468       " pass both
-0001d4d0: 206f 6273 5f69 6420 616e 6420 696e 7374   obs_id and inst
-0001d4e0: 2e22 2e66 6f72 6d61 7428 733d 7365 6c66  .".format(s=self
-0001d4f0: 2e6e 616d 6529 290a 0a20 2020 2020 2020  .name))..       
-0001d500: 2069 6620 6973 696e 7374 616e 6365 286f   if isinstance(o
-0001d510: 7574 6572 5f72 6164 6975 732c 2073 7472  uter_radius, str
-0001d520: 293a 0a20 2020 2020 2020 2020 2020 2023  ):.            #
-0001d530: 2047 7261 6273 2074 6865 2069 6e74 6572   Grabs the inter
-0001d540: 6c6f 7065 7220 7265 6d6f 7665 6420 736f  loper removed so
-0001d550: 7572 6365 2061 6e64 2062 6163 6b67 726f  urce and backgro
-0001d560: 756e 6420 7265 6769 6f6e 206d 6173 6b73  und region masks
-0001d570: 2e20 4966 2074 6865 204f 6273 4944 2069  . If the ObsID i
-0001d580: 7320 4e6f 6e65 2074 6865 2067 6574 5f6d  s None the get_m
-0001d590: 6173 6b0a 2020 2020 2020 2020 2020 2020  ask.            
-0001d5a0: 2320 206d 6574 686f 6420 756e 6465 7273  #  method unders
-0001d5b0: 7461 6e64 7320 7468 6174 206d 6561 6e73  tands that means
-0001d5c0: 2069 7420 7368 6f75 6c64 2072 6574 7572   it should retur
-0001d5d0: 6e20 7468 6520 6d61 736b 2066 6f72 2074  n the mask for t
-0001d5e0: 6865 2063 6f6d 6269 6e65 6420 6461 7461  he combined data
-0001d5f0: 0a20 2020 2020 2020 2020 2020 2073 7263  .            src
-0001d600: 5f6d 6173 6b2c 2062 636b 5f6d 6173 6b20  _mask, bck_mask 
-0001d610: 3d20 7365 6c66 2e67 6574 5f6d 6173 6b28  = self.get_mask(
-0001d620: 6f75 7465 725f 7261 6469 7573 2c20 6f62  outer_radius, ob
-0001d630: 735f 6964 2c20 6365 6e74 7261 6c5f 636f  s_id, central_co
-0001d640: 6f72 6429 0a20 2020 2020 2020 2065 6c73  ord).        els
-0001d650: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
-0001d660: 2048 6572 6520 7765 2068 6176 6520 7468   Here we have th
-0001d670: 6520 6361 7365 2077 6865 7265 2074 6865  e case where the
-0001d680: 2075 7365 7220 6861 7320 7061 7373 6564   user has passed
-0001d690: 2061 2063 7573 746f 6d20 6f75 7465 7220   a custom outer 
-0001d6a0: 7261 6469 7573 2c20 736f 2077 6520 6e65  radius, so we ne
-0001d6b0: 6564 2074 6f20 6765 6e65 7261 7465 2061  ed to generate a
-0001d6c0: 0a20 2020 2020 2020 2020 2020 2023 2020  .            #  
-0001d6d0: 6375 7374 6f6d 206d 6173 6b20 666f 7220  custom mask for 
-0001d6e0: 6974 0a20 2020 2020 2020 2020 2020 2073  it.            s
-0001d6f0: 7263 5f6d 6173 6b20 3d20 7365 6c66 2e67  rc_mask = self.g
-0001d700: 6574 5f63 7573 746f 6d5f 6d61 736b 286f  et_custom_mask(o
-0001d710: 7574 6572 5f72 6164 6975 732c 206f 6273  uter_radius, obs
-0001d720: 5f69 643d 6f62 735f 6964 2c20 6365 6e74  _id=obs_id, cent
-0001d730: 7261 6c5f 636f 6f72 643d 6365 6e74 7261  ral_coord=centra
-0001d740: 6c5f 636f 6f72 6429 0a20 2020 2020 2020  l_coord).       
-0001d750: 2020 2020 2062 636b 5f6d 6173 6b20 3d20       bck_mask = 
-0001d760: 7365 6c66 2e67 6574 5f63 7573 746f 6d5f  self.get_custom_
-0001d770: 6d61 736b 286f 7574 6572 5f72 6164 6975  mask(outer_radiu
-0001d780: 732a 7365 6c66 2e5f 6261 636b 5f6f 7574  s*self._back_out
-0001d790: 5f66 6163 746f 722c 206f 7574 6572 5f72  _factor, outer_r
-0001d7a0: 6164 6975 732a 7365 6c66 2e5f 6261 636b  adius*self._back
-0001d7b0: 5f69 6e6e 5f66 6163 746f 722c 0a20 2020  _inn_factor,.   
-0001d7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d7e0: 2020 2020 2020 2020 206f 6273 5f69 643d           obs_id=
-0001d7f0: 6f62 735f 6964 2c20 6365 6e74 7261 6c5f  obs_id, central_
-0001d800: 636f 6f72 643d 6365 6e74 7261 6c5f 636f  coord=central_co
-0001d810: 6f72 6429 0a0a 2020 2020 2020 2020 2320  ord)..        # 
-0001d820: 5765 2075 7365 2074 6865 2072 6174 656d  We use the ratem
-0001d830: 6170 2773 2062 7569 6c74 2069 6e20 6261  ap's built in ba
-0001d840: 636b 6772 6f75 6e64 2073 7562 7472 6163  ckground subtrac
-0001d850: 7465 6420 636f 756e 7473 2063 616c 6375  ted counts calcu
-0001d860: 6c61 7469 6f6e 206d 6574 686f 640a 2020  lation method.  
-0001d870: 2020 2020 2020 636e 7473 203d 2072 742e        cnts = rt.
-0001d880: 6261 636b 6772 6f75 6e64 5f73 7562 7472  background_subtr
-0001d890: 6163 7465 645f 636f 756e 7473 2873 7263  acted_counts(src
-0001d8a0: 5f6d 6173 6b2c 2062 636b 5f6d 6173 6b29  _mask, bck_mask)
-0001d8b0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-0001d8c0: 2063 6e74 730a 0a20 2020 2064 6566 2072   cnts..    def r
-0001d8d0: 6567 696f 6e73 5f77 6974 6869 6e5f 7261  egions_within_ra
-0001d8e0: 6469 6928 7365 6c66 2c20 696e 6e65 725f  dii(self, inner_
-0001d8f0: 7261 6469 7573 3a20 5175 616e 7469 7479  radius: Quantity
-0001d900: 2c20 6f75 7465 725f 7261 6469 7573 3a20  , outer_radius: 
-0001d910: 5175 616e 7469 7479 2c20 6465 675f 6365  Quantity, deg_ce
-0001d920: 6e74 7261 6c5f 636f 6f72 643a 2051 7561  ntral_coord: Qua
-0001d930: 6e74 6974 792c 0a20 2020 2020 2020 2020  ntity,.         
+0001c850: 2020 2020 2020 2020 2020 6f62 735f 6964            obs_id
+0001c860: 3d6f 6273 5f69 642c 2063 656e 7472 616c  =obs_id, central
+0001c870: 5f63 6f6f 7264 3d63 656e 7472 616c 5f63  _coord=central_c
+0001c880: 6f6f 7264 290a 0a20 2020 2020 2020 2023  oord)..        #
+0001c890: 2057 6520 7573 6520 7468 6520 7261 7465   We use the rate
+0001c8a0: 6d61 7027 7320 6275 696c 7420 696e 2073  map's built in s
+0001c8b0: 6967 6e61 6c20 746f 206e 6f69 7365 2063  ignal to noise c
+0001c8c0: 616c 6375 6c61 7469 6f6e 206d 6574 686f  alculation metho
+0001c8d0: 640a 2020 2020 2020 2020 736e 203d 2072  d.        sn = r
+0001c8e0: 742e 7369 676e 616c 5f74 6f5f 6e6f 6973  t.signal_to_nois
+0001c8f0: 6528 7372 635f 6d61 736b 2c20 6263 6b5f  e(src_mask, bck_
+0001c900: 6d61 736b 2c20 6578 705f 636f 7272 2c20  mask, exp_corr, 
+0001c910: 616c 6c6f 775f 6e65 6761 7469 7665 290a  allow_negative).
+0001c920: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0001c930: 736e 0a0a 2020 2020 6465 6620 6765 745f  sn..    def get_
+0001c940: 636f 756e 7473 2873 656c 662c 206f 7574  counts(self, out
+0001c950: 6572 5f72 6164 6975 733a 2055 6e69 6f6e  er_radius: Union
+0001c960: 5b51 7561 6e74 6974 792c 2073 7472 5d2c  [Quantity, str],
+0001c970: 2063 656e 7472 616c 5f63 6f6f 7264 3a20   central_coord: 
+0001c980: 5175 616e 7469 7479 203d 204e 6f6e 652c  Quantity = None,
+0001c990: 206c 6f5f 656e 3a20 5175 616e 7469 7479   lo_en: Quantity
+0001c9a0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+0001c9b0: 2020 2020 2020 2020 2020 2020 6869 5f65              hi_e
+0001c9c0: 6e3a 2051 7561 6e74 6974 7920 3d20 4e6f  n: Quantity = No
+0001c9d0: 6e65 2c20 6f62 735f 6964 3a20 7374 7220  ne, obs_id: str 
+0001c9e0: 3d20 4e6f 6e65 2c20 696e 7374 3a20 7374  = None, inst: st
+0001c9f0: 7220 3d20 4e6f 6e65 2c20 7073 665f 636f  r = None, psf_co
+0001ca00: 7272 3a20 626f 6f6c 203d 2046 616c 7365  rr: bool = False
+0001ca10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001ca20: 2020 2020 2070 7366 5f6d 6f64 656c 3a20       psf_model: 
+0001ca30: 7374 7220 3d20 2245 4c4c 4245 5441 222c  str = "ELLBETA",
+0001ca40: 2070 7366 5f62 696e 733a 2069 6e74 203d   psf_bins: int =
+0001ca50: 2034 2c20 7073 665f 616c 676f 3a20 7374   4, psf_algo: st
+0001ca60: 7220 3d20 2272 6c22 2c20 7073 665f 6974  r = "rl", psf_it
+0001ca70: 6572 3a20 696e 7420 3d20 3135 2920 2d3e  er: int = 15) ->
+0001ca80: 2051 7561 6e74 6974 793a 0a20 2020 2020   Quantity:.     
+0001ca90: 2020 2022 2222 0a20 2020 2020 2020 2054     """.        T
+0001caa0: 6869 7320 7461 6b65 7320 6120 7265 6769  his takes a regi
+0001cab0: 6f6e 2074 7970 6520 616e 6420 6365 6e74  on type and cent
+0001cac0: 7261 6c20 636f 6f72 6469 6e61 7465 2061  ral coordinate a
+0001cad0: 6e64 2063 616c 6375 6c61 7465 7320 7468  nd calculates th
+0001cae0: 6520 6261 636b 6772 6f75 6e64 2073 7562  e background sub
+0001caf0: 7472 6163 7465 6420 582d 7261 7920 636f  tracted X-ray co
+0001cb00: 756e 7473 2e0a 2020 2020 2020 2020 5468  unts..        Th
+0001cb10: 6520 6261 636b 6772 6f75 6e64 2072 6567  e background reg
+0001cb20: 696f 6e20 6973 2063 6f6e 7374 7275 6374  ion is construct
+0001cb30: 6564 2075 7369 6e67 2074 6865 2062 6163  ed using the bac
+0001cb40: 6b5f 696e 6e5f 7261 645f 6661 6374 6f72  k_inn_rad_factor
+0001cb50: 2061 6e64 2062 6163 6b5f 6f75 745f 7261   and back_out_ra
+0001cb60: 645f 6661 6374 6f72 0a20 2020 2020 2020  d_factor.       
+0001cb70: 2076 616c 7565 732c 2074 6865 2064 6566   values, the def
+0001cb80: 6175 6c74 7320 6f66 2077 6869 6368 2061  aults of which a
+0001cb90: 7265 2031 2e30 352a 7261 6469 7573 2061  re 1.05*radius a
+0001cba0: 6e64 2031 2e35 2a72 6164 6975 7320 7265  nd 1.5*radius re
+0001cbb0: 7370 6563 7469 7665 6c79 2e0a 0a20 2020  spectively...   
+0001cbc0: 2020 2020 203a 7061 7261 6d20 5175 616e       :param Quan
+0001cbd0: 7469 7479 2f73 7472 206f 7574 6572 5f72  tity/str outer_r
+0001cbe0: 6164 6975 733a 2054 6865 2072 6164 6975  adius: The radiu
+0001cbf0: 7320 7468 6174 2063 6f75 6e74 7320 7368  s that counts sh
+0001cc00: 6f75 6c64 2062 6520 6361 6c63 756c 6174  ould be calculat
+0001cc10: 6564 2077 6974 6869 6e2c 2074 6869 7320  ed within, this 
+0001cc20: 6361 6e20 6569 7468 6572 2062 6520 610a  can either be a.
+0001cc30: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+0001cc40: 6420 7261 6469 7573 2073 7563 6820 6173  d radius such as
+0001cc50: 2072 3530 302c 206f 7220 616e 2061 7374   r500, or an ast
+0001cc60: 726f 7079 2051 7561 6e74 6974 792e 0a20  ropy Quantity.. 
+0001cc70: 2020 2020 2020 203a 7061 7261 6d20 5175         :param Qu
+0001cc80: 616e 7469 7479 2063 656e 7472 616c 5f63  antity central_c
+0001cc90: 6f6f 7264 3a20 5468 6520 6365 6e74 7261  oord: The centra
+0001cca0: 6c20 636f 6f72 6469 6e61 7465 206f 6620  l coordinate of 
+0001ccb0: 7468 6520 7265 6769 6f6e 2e0a 2020 2020  the region..    
+0001ccc0: 2020 2020 3a70 6172 616d 2051 7561 6e74      :param Quant
+0001ccd0: 6974 7920 6c6f 5f65 6e3a 2054 6865 206c  ity lo_en: The l
+0001cce0: 6f77 6572 2065 6e65 7267 7920 626f 756e  ower energy boun
+0001ccf0: 6420 6f66 2074 6865 2072 6174 656d 6170  d of the ratemap
+0001cd00: 2074 6f20 7573 6520 746f 2063 616c 6375   to use to calcu
+0001cd10: 6c61 7465 2074 6865 2063 6f75 6e74 732e  late the counts.
+0001cd20: 2044 6566 6175 6c74 2069 7320 4e6f 6e65   Default is None
+0001cd30: 2c0a 2020 2020 2020 2020 2020 2020 696e  ,.            in
+0001cd40: 2077 6869 6368 2063 6173 6520 7468 6520   which case the 
+0001cd50: 6c6f 7765 7220 656e 6572 6779 2062 6f75  lower energy bou
+0001cd60: 6e64 2066 6f72 2070 6561 6b20 6669 6e64  nd for peak find
+0001cd70: 696e 6720 7769 6c6c 2062 6520 7573 6564  ing will be used
+0001cd80: 2028 6465 6661 756c 7420 6973 2030 2e35   (default is 0.5
+0001cd90: 6b65 5629 2e0a 2020 2020 2020 2020 3a70  keV)..        :p
+0001cda0: 6172 616d 2051 7561 6e74 6974 7920 6869  aram Quantity hi
+0001cdb0: 5f65 6e3a 2054 6865 2075 7070 6572 2065  _en: The upper e
+0001cdc0: 6e65 7267 7920 626f 756e 6420 6f66 2074  nergy bound of t
+0001cdd0: 6865 2072 6174 656d 6170 2074 6f20 7573  he ratemap to us
+0001cde0: 6520 746f 2063 616c 6375 6c61 7465 2074  e to calculate t
+0001cdf0: 6865 2063 6f75 6e74 732e 2044 6566 6175  he counts. Defau
+0001ce00: 6c74 2069 7320 4e6f 6e65 2c0a 2020 2020  lt is None,.    
+0001ce10: 2020 2020 2020 2020 696e 2077 6869 6368          in which
+0001ce20: 2063 6173 6520 7468 6520 7570 7065 7220   case the upper 
+0001ce30: 656e 6572 6779 2062 6f75 6e64 2066 6f72  energy bound for
+0001ce40: 2070 6561 6b20 6669 6e64 696e 6720 7769   peak finding wi
+0001ce50: 6c6c 2062 6520 7573 6564 2028 6465 6661  ll be used (defa
+0001ce60: 756c 7420 6973 2032 2e30 6b65 5629 2e0a  ult is 2.0keV)..
+0001ce70: 2020 2020 2020 2020 3a70 6172 616d 2073          :param s
+0001ce80: 7472 206f 6273 5f69 643a 2041 6e20 4f62  tr obs_id: An Ob
+0001ce90: 7349 4420 6f66 2061 2073 7065 6369 6669  sID of a specifi
+0001cea0: 6320 7261 7465 6d61 7020 746f 2075 7365  c ratemap to use
+0001ceb0: 2066 6f72 2074 6865 2063 6f75 6e74 7320   for the counts 
+0001cec0: 6361 6c63 756c 6174 696f 6e2e 2044 6566  calculation. Def
+0001ced0: 6175 6c74 2069 7320 4e6f 6e65 2c20 7768  ault is None, wh
+0001cee0: 6963 680a 2020 2020 2020 2020 2020 2020  ich.            
+0001cef0: 6d65 616e 7320 7468 6520 636f 6d62 696e  means the combin
+0001cf00: 6564 2072 6174 656d 6170 2077 696c 6c20  ed ratemap will 
+0001cf10: 6265 2075 7365 642e 2050 6c65 6173 6520  be used. Please 
+0001cf20: 6e6f 7465 2074 6861 7420 696e 7374 206d  note that inst m
+0001cf30: 7573 7420 616c 736f 2062 6520 7365 7420  ust also be set 
+0001cf40: 746f 2075 7365 2074 6869 7320 6f70 7469  to use this opti
+0001cf50: 6f6e 2e0a 2020 2020 2020 2020 3a70 6172  on..        :par
+0001cf60: 616d 2073 7472 2069 6e73 743a 2054 6865  am str inst: The
+0001cf70: 2069 6e73 7472 756d 656e 7420 6f66 2061   instrument of a
+0001cf80: 2073 7065 6369 6669 6320 7261 7465 6d61   specific ratema
+0001cf90: 7020 746f 2075 7365 2066 6f72 2074 6865  p to use for the
+0001cfa0: 2063 6f75 6e74 7320 6361 6c63 756c 6174   counts calculat
+0001cfb0: 696f 6e2e 2044 6566 6175 6c74 2069 7320  ion. Default is 
+0001cfc0: 4e6f 6e65 2c20 7768 6963 680a 2020 2020  None, which.    
+0001cfd0: 2020 2020 2020 2020 6d65 616e 7320 7468          means th
+0001cfe0: 6520 636f 6d62 696e 6564 2072 6174 656d  e combined ratem
+0001cff0: 6170 2077 696c 6c20 6265 2075 7365 642e  ap will be used.
+0001d000: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+0001d010: 626f 6f6c 2070 7366 5f63 6f72 723a 2053  bool psf_corr: S
+0001d020: 6574 7320 7768 6574 6865 7220 796f 7520  ets whether you 
+0001d030: 7769 7368 2074 6f20 7573 6520 6120 5053  wish to use a PS
+0001d040: 4620 636f 7272 6563 7465 6420 7261 7465  F corrected rate
+0001d050: 6d61 7020 6f72 206e 6f74 2e0a 2020 2020  map or not..    
+0001d060: 2020 2020 3a70 6172 616d 2073 7472 2070      :param str p
+0001d070: 7366 5f6d 6f64 656c 3a20 4966 2074 6865  sf_model: If the
+0001d080: 2072 6174 656d 6170 2079 6f75 2077 616e   ratemap you wan
+0001d090: 7420 746f 2075 7365 2069 7320 5053 4620  t to use is PSF 
+0001d0a0: 636f 7272 6563 7465 642c 2074 6869 7320  corrected, this 
+0001d0b0: 6973 2074 6865 2050 5346 206d 6f64 656c  is the PSF model
+0001d0c0: 2075 7365 642e 0a20 2020 2020 2020 203a   used..        :
+0001d0d0: 7061 7261 6d20 696e 7420 7073 665f 6269  param int psf_bi
+0001d0e0: 6e73 3a20 4966 2074 6865 2072 6174 656d  ns: If the ratem
+0001d0f0: 6170 2079 6f75 2077 616e 7420 746f 2075  ap you want to u
+0001d100: 7365 2069 7320 5053 4620 636f 7272 6563  se is PSF correc
+0001d110: 7465 642c 2074 6869 7320 6973 2074 6865  ted, this is the
+0001d120: 206e 756d 6265 7220 6f66 2050 5346 7320   number of PSFs 
+0001d130: 7065 720a 2020 2020 2020 2020 2020 2020  per.            
+0001d140: 7369 6465 2069 6e20 7468 6520 5053 4620  side in the PSF 
+0001d150: 6772 6964 2e0a 2020 2020 2020 2020 3a70  grid..        :p
+0001d160: 6172 616d 2073 7472 2070 7366 5f61 6c67  aram str psf_alg
+0001d170: 6f3a 2049 6620 7468 6520 7261 7465 6d61  o: If the ratema
+0001d180: 7020 796f 7520 7761 6e74 2074 6f20 7573  p you want to us
+0001d190: 6520 6973 2050 5346 2063 6f72 7265 6374  e is PSF correct
+0001d1a0: 6564 2c20 7468 6973 2069 7320 7468 6520  ed, this is the 
+0001d1b0: 616c 676f 7269 7468 6d20 7573 6564 2e0a  algorithm used..
+0001d1c0: 2020 2020 2020 2020 3a70 6172 616d 2069          :param i
+0001d1d0: 6e74 2070 7366 5f69 7465 723a 2049 6620  nt psf_iter: If 
+0001d1e0: 7468 6520 7261 7465 6d61 7020 796f 7520  the ratemap you 
+0001d1f0: 7761 6e74 2074 6f20 7573 6520 6973 2050  want to use is P
+0001d200: 5346 2063 6f72 7265 6374 6564 2c20 7468  SF corrected, th
+0001d210: 6973 2069 7320 7468 6520 6e75 6d62 6572  is is the number
+0001d220: 206f 6620 6974 6572 6174 696f 6e73 2e0a   of iterations..
+0001d230: 2020 2020 2020 2020 3a72 6574 7572 6e3a          :return:
+0001d240: 2054 6865 2062 6163 6b67 726f 756e 6420   The background 
+0001d250: 7375 6274 7261 6374 6564 2063 6f75 6e74  subtracted count
+0001d260: 732e 0a20 2020 2020 2020 203a 7274 7970  s..        :rtyp
+0001d270: 653a 2051 7561 6e74 6974 790a 2020 2020  e: Quantity.    
+0001d280: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0001d290: 2320 4368 6563 6b69 6e67 2069 6620 7468  # Checking if th
+0001d2a0: 6520 7573 6572 2070 6173 7365 6420 616e  e user passed an
+0001d2b0: 7920 656e 6572 6779 206c 696d 6974 7320  y energy limits 
+0001d2c0: 6f66 2074 6865 6972 206f 776e 0a20 2020  of their own.   
+0001d2d0: 2020 2020 2069 6620 6c6f 5f65 6e20 6973       if lo_en is
+0001d2e0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0001d2f0: 2020 206c 6f5f 656e 203d 2073 656c 662e     lo_en = self.
+0001d300: 5f70 6561 6b5f 6c6f 5f65 6e0a 2020 2020  _peak_lo_en.    
+0001d310: 2020 2020 6966 2068 695f 656e 2069 7320      if hi_en is 
+0001d320: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0001d330: 2020 6869 5f65 6e20 3d20 7365 6c66 2e5f    hi_en = self._
+0001d340: 7065 616b 5f68 695f 656e 0a0a 2020 2020  peak_hi_en..    
+0001d350: 2020 2020 2320 5061 7273 696e 6720 7468      # Parsing th
+0001d360: 6520 4f62 7349 4420 616e 6420 696e 7374  e ObsID and inst
+0001d370: 7275 6d65 6e74 206f 7074 696f 6e73 2c20  rument options, 
+0001d380: 7365 6520 6966 2074 6865 7920 7761 6e74  see if they want
+0001d390: 2074 6f20 7573 6520 6120 7370 6563 6966   to use a specif
+0001d3a0: 6963 2072 6174 656d 6170 0a20 2020 2020  ic ratemap.     
+0001d3b0: 2020 2069 6620 616c 6c28 5b6f 6273 5f69     if all([obs_i
+0001d3c0: 6420 6973 204e 6f6e 652c 2069 6e73 7420  d is None, inst 
+0001d3d0: 6973 204e 6f6e 655d 293a 0a20 2020 2020  is None]):.     
+0001d3e0: 2020 2020 2020 2023 2048 6572 6520 7468         # Here th
+0001d3f0: 6520 7573 6572 2068 6173 6e27 7420 7365  e user hasn't se
+0001d400: 7420 4f62 7349 4420 6f72 2069 6e73 7472  t ObsID or instr
+0001d410: 756d 656e 742c 2073 6f20 7765 2075 7365  ument, so we use
+0001d420: 2074 6865 2063 6f6d 6269 6e65 6420 6461   the combined da
+0001d430: 7461 0a20 2020 2020 2020 2020 2020 2072  ta.            r
+0001d440: 7420 3d20 7365 6c66 2e67 6574 5f63 6f6d  t = self.get_com
+0001d450: 6269 6e65 645f 7261 7465 6d61 7073 286c  bined_ratemaps(l
+0001d460: 6f5f 656e 2c20 6869 5f65 6e2c 2070 7366  o_en, hi_en, psf
+0001d470: 5f63 6f72 722c 2070 7366 5f6d 6f64 656c  _corr, psf_model
+0001d480: 2c20 7073 665f 6269 6e73 2c20 7073 665f  , psf_bins, psf_
+0001d490: 616c 676f 2c20 7073 665f 6974 6572 290a  algo, psf_iter).
+0001d4a0: 0a20 2020 2020 2020 2065 6c69 6620 616c  .        elif al
+0001d4b0: 6c28 5b6f 6273 5f69 6420 6973 206e 6f74  l([obs_id is not
+0001d4c0: 204e 6f6e 652c 2069 6e73 7420 6973 206e   None, inst is n
+0001d4d0: 6f74 204e 6f6e 655d 293a 0a20 2020 2020  ot None]):.     
+0001d4e0: 2020 2020 2020 2023 2042 6f74 6820 4f62         # Both Ob
+0001d4f0: 7349 4420 616e 6420 696e 7374 7275 6d65  sID and instrume
+0001d500: 6e74 2068 6176 6520 6265 656e 2073 6574  nt have been set
+0001d510: 2062 7920 7468 6520 7573 6572 0a20 2020   by the user.   
+0001d520: 2020 2020 2020 2020 2072 7420 3d20 7365           rt = se
+0001d530: 6c66 2e67 6574 5f72 6174 656d 6170 7328  lf.get_ratemaps(
+0001d540: 6f62 735f 6964 2c20 696e 7374 2c20 6c6f  obs_id, inst, lo
+0001d550: 5f65 6e2c 2068 695f 656e 2c20 7073 665f  _en, hi_en, psf_
+0001d560: 636f 7272 2c20 7073 665f 6d6f 6465 6c2c  corr, psf_model,
+0001d570: 2070 7366 5f62 696e 732c 2070 7366 5f61   psf_bins, psf_a
+0001d580: 6c67 6f2c 2070 7366 5f69 7465 7229 0a20  lgo, psf_iter). 
+0001d590: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0001d5a0: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
+0001d5b0: 616c 7565 4572 726f 7228 2249 6620 796f  alueError("If yo
+0001d5c0: 7520 7769 7368 2074 6f20 7573 6520 6120  u wish to use a 
+0001d5d0: 7370 6563 6966 6963 2072 6174 656d 6170  specific ratemap
+0001d5e0: 2066 6f72 207b 737d 2773 2073 6967 6e61   for {s}'s signa
+0001d5f0: 6c20 746f 206e 6f69 7365 2063 616c 6375  l to noise calcu
+0001d600: 6c61 7469 6f6e 2c20 706c 6561 7365 2022  lation, please "
+0001d610: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d620: 2020 2020 2020 2020 2020 2020 2020 2220                " 
+0001d630: 7061 7373 2062 6f74 6820 6f62 735f 6964  pass both obs_id
+0001d640: 2061 6e64 2069 6e73 742e 222e 666f 726d   and inst.".form
+0001d650: 6174 2873 3d73 656c 662e 6e61 6d65 2929  at(s=self.name))
+0001d660: 0a0a 2020 2020 2020 2020 6966 2069 7369  ..        if isi
+0001d670: 6e73 7461 6e63 6528 6f75 7465 725f 7261  nstance(outer_ra
+0001d680: 6469 7573 2c20 7374 7229 3a0a 2020 2020  dius, str):.    
+0001d690: 2020 2020 2020 2020 2320 4772 6162 7320          # Grabs 
+0001d6a0: 7468 6520 696e 7465 726c 6f70 6572 2072  the interloper r
+0001d6b0: 656d 6f76 6564 2073 6f75 7263 6520 616e  emoved source an
+0001d6c0: 6420 6261 636b 6772 6f75 6e64 2072 6567  d background reg
+0001d6d0: 696f 6e20 6d61 736b 732e 2049 6620 7468  ion masks. If th
+0001d6e0: 6520 4f62 7349 4420 6973 204e 6f6e 6520  e ObsID is None 
+0001d6f0: 7468 6520 6765 745f 6d61 736b 0a20 2020  the get_mask.   
+0001d700: 2020 2020 2020 2020 2023 2020 6d65 7468           #  meth
+0001d710: 6f64 2075 6e64 6572 7374 616e 6473 2074  od understands t
+0001d720: 6861 7420 6d65 616e 7320 6974 2073 686f  hat means it sho
+0001d730: 756c 6420 7265 7475 726e 2074 6865 206d  uld return the m
+0001d740: 6173 6b20 666f 7220 7468 6520 636f 6d62  ask for the comb
+0001d750: 696e 6564 2064 6174 610a 2020 2020 2020  ined data.      
+0001d760: 2020 2020 2020 7372 635f 6d61 736b 2c20        src_mask, 
+0001d770: 6263 6b5f 6d61 736b 203d 2073 656c 662e  bck_mask = self.
+0001d780: 6765 745f 6d61 736b 286f 7574 6572 5f72  get_mask(outer_r
+0001d790: 6164 6975 732c 206f 6273 5f69 642c 2063  adius, obs_id, c
+0001d7a0: 656e 7472 616c 5f63 6f6f 7264 290a 2020  entral_coord).  
+0001d7b0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0001d7c0: 2020 2020 2020 2020 2320 4865 7265 2077          # Here w
+0001d7d0: 6520 6861 7665 2074 6865 2063 6173 6520  e have the case 
+0001d7e0: 7768 6572 6520 7468 6520 7573 6572 2068  where the user h
+0001d7f0: 6173 2070 6173 7365 6420 6120 6375 7374  as passed a cust
+0001d800: 6f6d 206f 7574 6572 2072 6164 6975 732c  om outer radius,
+0001d810: 2073 6f20 7765 206e 6565 6420 746f 2067   so we need to g
+0001d820: 656e 6572 6174 6520 610a 2020 2020 2020  enerate a.      
+0001d830: 2020 2020 2020 2320 2063 7573 746f 6d20        #  custom 
+0001d840: 6d61 736b 2066 6f72 2069 740a 2020 2020  mask for it.    
+0001d850: 2020 2020 2020 2020 7372 635f 6d61 736b          src_mask
+0001d860: 203d 2073 656c 662e 6765 745f 6375 7374   = self.get_cust
+0001d870: 6f6d 5f6d 6173 6b28 6f75 7465 725f 7261  om_mask(outer_ra
+0001d880: 6469 7573 2c20 6f62 735f 6964 3d6f 6273  dius, obs_id=obs
+0001d890: 5f69 642c 2063 656e 7472 616c 5f63 6f6f  _id, central_coo
+0001d8a0: 7264 3d63 656e 7472 616c 5f63 6f6f 7264  rd=central_coord
+0001d8b0: 290a 2020 2020 2020 2020 2020 2020 6263  ).            bc
+0001d8c0: 6b5f 6d61 736b 203d 2073 656c 662e 6765  k_mask = self.ge
+0001d8d0: 745f 6375 7374 6f6d 5f6d 6173 6b28 6f75  t_custom_mask(ou
+0001d8e0: 7465 725f 7261 6469 7573 2a73 656c 662e  ter_radius*self.
+0001d8f0: 5f62 6163 6b5f 6f75 745f 6661 6374 6f72  _back_out_factor
+0001d900: 2c20 6f75 7465 725f 7261 6469 7573 2a73  , outer_radius*s
+0001d910: 656c 662e 5f62 6163 6b5f 696e 6e5f 6661  elf._back_inn_fa
+0001d920: 6374 6f72 2c0a 2020 2020 2020 2020 2020  ctor,.          
+0001d930: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001d940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d950: 2020 2020 7265 6769 6f6e 735f 746f 5f73      regions_to_s
-0001d960: 6561 7263 683a 2055 6e69 6f6e 5b6e 702e  earch: Union[np.
-0001d970: 6e64 6172 7261 792c 206c 6973 745d 203d  ndarray, list] =
-0001d980: 204e 6f6e 6529 202d 3e20 6e70 2e6e 6461   None) -> np.nda
-0001d990: 7272 6179 3a0a 2020 2020 2020 2020 2222  rray:.        ""
-0001d9a0: 220a 2020 2020 2020 2020 5468 6973 2066  ".        This f
-0001d9b0: 756e 6374 696f 6e20 6669 6e64 7320 616e  unction finds an
-0001d9c0: 6420 7265 7475 726e 7320 616e 7920 696e  d returns any in
-0001d9d0: 7465 726c 6f70 6572 2072 6567 696f 6e73  terloper regions
-0001d9e0: 2028 6279 2064 6566 6175 6c74 2920 7468   (by default) th
-0001d9f0: 6174 2068 6176 6520 616e 7920 7061 7274  at have any part
-0001da00: 206f 6620 7468 6569 7220 626f 756e 6461   of their bounda
-0001da10: 7279 0a20 2020 2020 2020 2077 6974 6869  ry.        withi
-0001da20: 6e20 7468 6520 7370 6563 6966 6965 6420  n the specified 
-0001da30: 7261 6469 692c 2063 656e 7465 7265 6420  radii, centered 
-0001da40: 6f6e 2074 6865 2073 7065 6369 6669 6564  on the specified
-0001da50: 2063 656e 7472 616c 2063 6f6f 7264 696e   central coordin
-0001da60: 6174 652e 2055 7365 7273 206d 6179 2061  ate. Users may a
-0001da70: 6c73 6f20 7061 7373 2074 6865 6972 206f  lso pass their o
-0001da80: 776e 0a20 2020 2020 2020 2061 7272 6179  wn.        array
-0001da90: 206f 6620 7265 6769 6f6e 7320 746f 2063   of regions to c
-0001daa0: 6865 636b 2e0a 0a20 2020 2020 2020 203a  heck...        :
-0001dab0: 7061 7261 6d20 5175 616e 7469 7479 2069  param Quantity i
-0001dac0: 6e6e 6572 5f72 6164 6975 733a 2054 6865  nner_radius: The
-0001dad0: 2069 6e6e 6572 2072 6164 6975 7320 6f66   inner radius of
-0001dae0: 2074 6865 2061 7265 6120 746f 2073 6561   the area to sea
-0001daf0: 7263 6820 666f 7220 696e 7465 726c 6f70  rch for interlop
-0001db00: 6572 7320 696e 2e0a 2020 2020 2020 2020  ers in..        
-0001db10: 3a70 6172 616d 2051 7561 6e74 6974 7920  :param Quantity 
-0001db20: 6f75 7465 725f 7261 6469 7573 3a20 5468  outer_radius: Th
-0001db30: 6520 6f75 7465 7220 7261 6469 7573 206f  e outer radius o
-0001db40: 6620 7468 6520 6172 6561 2074 6f20 7365  f the area to se
-0001db50: 6172 6368 2066 6f72 2069 6e74 6572 6c6f  arch for interlo
-0001db60: 7065 7273 2069 6e2e 0a20 2020 2020 2020  pers in..       
-0001db70: 203a 7061 7261 6d20 5175 616e 7469 7479   :param Quantity
-0001db80: 2064 6567 5f63 656e 7472 616c 5f63 6f6f   deg_central_coo
-0001db90: 7264 3a20 5468 6520 6365 6e74 7261 6c20  rd: The central 
-0001dba0: 636f 6f72 6469 6e61 7465 2028 494e 2044  coordinate (IN D
-0001dbb0: 4547 5245 4553 2920 6f66 2074 6865 2061  EGREES) of the a
-0001dbc0: 7265 6120 746f 2073 6561 7263 6820 666f  rea to search fo
-0001dbd0: 720a 2020 2020 2020 2020 2020 2020 696e  r.            in
-0001dbe0: 7465 726c 6f70 6572 7320 696e 2e0a 2020  terlopers in..  
-0001dbf0: 2020 2020 2020 3a70 6172 616d 206e 702e        :param np.
-0001dc00: 6e64 6172 7261 792f 6c69 7374 2072 6567  ndarray/list reg
-0001dc10: 696f 6e73 5f74 6f5f 7365 6172 6368 3a20  ions_to_search: 
-0001dc20: 416e 206f 7074 696f 6e61 6c20 7061 7261  An optional para
-0001dc30: 6d65 7465 7220 7468 6174 2061 6c6c 6f77  meter that allow
-0001dc40: 7320 7468 6520 7573 6572 2074 6f20 7061  s the user to pa
-0001dc50: 7373 2061 2073 7065 6369 6669 630a 2020  ss a specific.  
-0001dc60: 2020 2020 2020 2020 2020 6c69 7374 206f            list o
-0001dc70: 6620 7265 6769 6f6e 7320 746f 2063 6865  f regions to che
-0001dc80: 636b 2e20 4465 6661 756c 7420 6973 204e  ck. Default is N
-0001dc90: 6f6e 652c 2069 6e20 7768 6963 6820 6361  one, in which ca
-0001dca0: 7365 2074 6865 2069 6e74 6572 6c6f 7065  se the interlope
-0001dcb0: 725f 7265 6769 6f6e 7320 696e 7465 726e  r_regions intern
-0001dcc0: 616c 206c 6973 740a 2020 2020 2020 2020  al list.        
-0001dcd0: 2020 2020 7769 6c6c 2062 6520 7573 6564      will be used
-0001dce0: 2e0a 2020 2020 2020 2020 3a72 6574 7572  ..        :retur
-0001dcf0: 6e3a 2041 206e 756d 7079 2061 7272 6179  n: A numpy array
-0001dd00: 206f 6620 7468 6520 696e 7465 726c 6f70   of the interlop
-0001dd10: 6572 2072 6567 696f 6e73 2028 6f72 2075  er regions (or u
-0001dd20: 7365 7220 7061 7373 6564 2072 6567 696f  ser passed regio
-0001dd30: 6e73 2920 7769 7468 696e 2074 6865 2073  ns) within the s
-0001dd40: 7065 6369 6669 6564 2061 7265 612e 0a20  pecified area.. 
-0001dd50: 2020 2020 2020 203a 7274 7970 653a 206e         :rtype: n
-0001dd60: 702e 6e64 6172 7261 790a 2020 2020 2020  p.ndarray.      
-0001dd70: 2020 2222 220a 2020 2020 2020 2020 6465    """.        de
-0001dd80: 6620 7065 7269 6d65 7465 725f 706f 696e  f perimeter_poin
-0001dd90: 7473 2872 6567 5f63 656e 5f78 3a20 666c  ts(reg_cen_x: fl
-0001dda0: 6f61 742c 2072 6567 5f63 656e 5f79 3a20  oat, reg_cen_y: 
-0001ddb0: 666c 6f61 742c 2072 6567 5f6d 616a 6f72  float, reg_major
-0001ddc0: 5f72 6164 3a20 666c 6f61 742c 2072 6567  _rad: float, reg
-0001ddd0: 5f6d 696e 6f72 5f72 6164 3a20 666c 6f61  _minor_rad: floa
-0001dde0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
-0001ddf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001de00: 726f 7461 7469 6f6e 3a20 666c 6f61 7429  rotation: float)
-0001de10: 202d 3e20 6e70 2e6e 6461 7272 6179 3a0a   -> np.ndarray:.
-0001de20: 2020 2020 2020 2020 2020 2020 2222 220a              """.
-0001de30: 2020 2020 2020 2020 2020 2020 416e 2069              An i
-0001de40: 6e74 6572 6e61 6c20 6675 6e63 7469 6f6e  nternal function
-0001de50: 2074 6f20 6765 6e65 7261 7465 2074 6869   to generate thi
-0001de60: 7274 7920 782d 7920 706f 7369 7469 6f6e  rty x-y position
-0001de70: 7320 6f6e 2074 6865 2062 6f75 6e64 6172  s on the boundar
-0001de80: 7920 6f66 2061 2070 6172 7469 6375 6c61  y of a particula
-0001de90: 7220 7265 6769 6f6e 2e0a 0a20 2020 2020  r region...     
-0001dea0: 2020 2020 2020 203a 7061 7261 6d20 666c         :param fl
-0001deb0: 6f61 7420 7265 675f 6365 6e5f 783a 2054  oat reg_cen_x: T
-0001dec0: 6865 2078 2070 6f73 6974 696f 6e20 6f66  he x position of
-0001ded0: 2074 6865 2063 656e 7472 6520 6f66 2074   the centre of t
-0001dee0: 6865 2072 6567 696f 6e2c 2069 6e20 6465  he region, in de
-0001def0: 6772 6565 732e 0a20 2020 2020 2020 2020  grees..         
-0001df00: 2020 203a 7061 7261 6d20 666c 6f61 7420     :param float 
-0001df10: 7265 675f 6365 6e5f 793a 2054 6865 2079  reg_cen_y: The y
-0001df20: 2070 6f73 6974 696f 6e20 6f66 2074 6865   position of the
-0001df30: 2063 656e 7472 6520 6f66 2074 6865 2072   centre of the r
-0001df40: 6567 696f 6e2c 2069 6e20 6465 6772 6565  egion, in degree
-0001df50: 730a 2020 2020 2020 2020 2020 2020 3a70  s.            :p
-0001df60: 6172 616d 2066 6c6f 6174 2072 6567 5f6d  aram float reg_m
-0001df70: 616a 6f72 5f72 6164 3a20 5468 6520 7365  ajor_rad: The se
-0001df80: 6d69 2d6d 616a 6f72 2061 7869 7320 6f66  mi-major axis of
-0001df90: 2074 6865 2072 6567 696f 6e2c 2069 6e20   the region, in 
-0001dfa0: 6465 6772 6565 732e 0a20 2020 2020 2020  degrees..       
-0001dfb0: 2020 2020 203a 7061 7261 6d20 666c 6f61       :param floa
-0001dfc0: 7420 7265 675f 6d69 6e6f 725f 7261 643a  t reg_minor_rad:
-0001dfd0: 2054 6865 2073 656d 692d 6d69 6e6f 7220   The semi-minor 
-0001dfe0: 6178 6973 206f 6620 7468 6520 7265 6769  axis of the regi
-0001dff0: 6f6e 2c20 696e 2064 6567 7265 6573 2e0a  on, in degrees..
-0001e000: 2020 2020 2020 2020 2020 2020 3a70 6172              :par
-0001e010: 616d 2066 6c6f 6174 2072 6f74 6174 696f  am float rotatio
-0001e020: 6e3a 2054 6865 2072 6f74 6174 696f 6e20  n: The rotation 
-0001e030: 6f66 2074 6865 2072 6567 696f 6e2c 2069  of the region, i
-0001e040: 6e20 7261 6469 616e 732e 0a20 2020 2020  n radians..     
-0001e050: 2020 2020 2020 203a 7265 7475 726e 3a20         :return: 
-0001e060: 416e 2061 7272 6179 206f 6620 7468 6972  An array of thir
-0001e070: 7479 2078 2d79 2063 6f6f 7264 696e 6174  ty x-y coordinat
-0001e080: 6573 206f 6e20 7468 6520 626f 756e 6461  es on the bounda
-0001e090: 7279 206f 6620 7468 6520 7265 6769 6f6e  ry of the region
-0001e0a0: 2e0a 2020 2020 2020 2020 2020 2020 3a72  ..            :r
-0001e0b0: 7479 7065 3a20 6e70 2e6e 6461 7272 6179  type: np.ndarray
-0001e0c0: 0a20 2020 2020 2020 2020 2020 2022 2222  .            """
-0001e0d0: 0a20 2020 2020 2020 2020 2020 2023 204a  .            # J
-0001e0e0: 7573 7420 7468 6520 6e75 6d70 7920 6172  ust the numpy ar
-0001e0f0: 7261 7920 6f66 2061 6e67 6c65 7320 2869  ray of angles (i
-0001e100: 6e20 7261 6469 616e 7329 2074 6f20 6669  n radians) to fi
-0001e110: 6e64 2074 6865 2078 2d79 2070 6f69 6e74  nd the x-y point
-0001e120: 7320 6f66 0a20 2020 2020 2020 2020 2020  s of.           
-0001e130: 2061 6e67 7320 3d20 6e70 2e6c 696e 7370   angs = np.linsp
-0001e140: 6163 6528 302c 2032 202a 206e 702e 7069  ace(0, 2 * np.pi
-0001e150: 2c20 3330 290a 0a20 2020 2020 2020 2020  , 30)..         
-0001e160: 2020 2023 2054 6869 7320 6973 206a 7573     # This is jus
-0001e170: 7420 7468 6520 7061 7261 6d65 7472 6963  t the parametric
-0001e180: 2065 7175 6174 696f 6e20 6f66 2061 6e20   equation of an 
-0001e190: 656c 6c69 7073 6520 2d20 4920 6f6e 6c79  ellipse - I only
-0001e1a0: 2069 6e63 6c75 6465 2074 6865 2064 6973   include the dis
-0001e1b0: 706c 6163 656d 656e 7420 746f 2074 6865  placement to the
-0001e1c0: 0a20 2020 2020 2020 2020 2020 2023 2020  .            #  
-0001e1d0: 6365 6e74 7261 6c20 636f 6f72 6469 6e61  central coordina
-0001e1e0: 7465 7320 6f66 2074 6865 2072 6567 696f  tes of the regio
-0001e1f0: 6e20 4146 5445 5220 6974 2068 6173 2062  n AFTER it has b
-0001e200: 6565 6e20 726f 7461 7465 640a 2020 2020  een rotated.    
-0001e210: 2020 2020 2020 2020 7820 3d20 7265 675f          x = reg_
-0001e220: 6d61 6a6f 725f 7261 6420 2a20 6e70 2e63  major_rad * np.c
-0001e230: 6f73 2861 6e67 7329 0a20 2020 2020 2020  os(angs).       
-0001e240: 2020 2020 2079 203d 2072 6567 5f6d 696e       y = reg_min
-0001e250: 6f72 5f72 6164 202a 206e 702e 7369 6e28  or_rad * np.sin(
-0001e260: 616e 6773 290a 0a20 2020 2020 2020 2020  angs)..         
-0001e270: 2020 2023 2053 6574 7320 6f66 2074 6865     # Sets of the
-0001e280: 2072 6f74 6174 696f 6e20 6d61 7472 6978   rotation matrix
-0001e290: 0a20 2020 2020 2020 2020 2020 2072 6f74  .            rot
-0001e2a0: 5f6d 6174 203d 206e 702e 6172 7261 7928  _mat = np.array(
-0001e2b0: 5b5b 6e70 2e63 6f73 2872 6f74 6174 696f  [[np.cos(rotatio
-0001e2c0: 6e29 2c20 2d31 202a 206e 702e 7369 6e28  n), -1 * np.sin(
-0001e2d0: 726f 7461 7469 6f6e 295d 2c20 5b6e 702e  rotation)], [np.
-0001e2e0: 7369 6e28 726f 7461 7469 6f6e 292c 206e  sin(rotation), n
-0001e2f0: 702e 636f 7328 726f 7461 7469 6f6e 295d  p.cos(rotation)]
-0001e300: 5d29 0a0a 2020 2020 2020 2020 2020 2020  ])..            
-0001e310: 2320 4a75 7374 2072 6f74 6174 6573 2074  # Just rotates t
-0001e320: 6865 2065 6467 6520 636f 6f72 6469 6e61  he edge coordina
-0001e330: 7465 7320 746f 206d 6174 6368 2074 6865  tes to match the
-0001e340: 206b 6e6f 776e 2072 6f74 6174 696f 6e20   known rotation 
-0001e350: 6f66 2074 6869 7320 7061 7274 6963 756c  of this particul
-0001e360: 6172 2072 6567 696f 6e0a 2020 2020 2020  ar region.      
-0001e370: 2020 2020 2020 6564 6765 5f63 6f6f 7264        edge_coord
-0001e380: 7320 3d20 2872 6f74 5f6d 6174 2040 206e  s = (rot_mat @ n
-0001e390: 702e 7673 7461 636b 285b 782c 2079 5d29  p.vstack([x, y])
-0001e3a0: 292e 540a 0a20 2020 2020 2020 2020 2020  ).T..           
-0001e3b0: 2023 204e 6f77 2049 2072 652d 6365 6e74   # Now I re-cent
-0001e3c0: 7265 2074 6865 2072 6567 696f 6e0a 2020  re the region.  
-0001e3d0: 2020 2020 2020 2020 2020 6564 6765 5f63            edge_c
-0001e3e0: 6f6f 7264 735b 3a2c 2030 5d20 2b3d 2072  oords[:, 0] += r
-0001e3f0: 6567 5f63 656e 5f78 0a20 2020 2020 2020  eg_cen_x.       
-0001e400: 2020 2020 2065 6467 655f 636f 6f72 6473       edge_coords
-0001e410: 5b3a 2c20 315d 202b 3d20 7265 675f 6365  [:, 1] += reg_ce
-0001e420: 6e5f 790a 0a20 2020 2020 2020 2020 2020  n_y..           
-0001e430: 2072 6574 7572 6e20 6564 6765 5f63 6f6f   return edge_coo
-0001e440: 7264 730a 0a20 2020 2020 2020 2069 6620  rds..        if 
-0001e450: 6465 675f 6365 6e74 7261 6c5f 636f 6f72  deg_central_coor
-0001e460: 642e 756e 6974 2021 3d20 6465 673a 0a20  d.unit != deg:. 
-0001e470: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0001e480: 2055 6e69 7443 6f6e 7665 7273 696f 6e45   UnitConversionE
-0001e490: 7272 6f72 2822 5468 6520 6365 6e74 7261  rror("The centra
-0001e4a0: 6c20 636f 6f72 6469 6e61 7465 206d 7573  l coordinate mus
-0001e4b0: 7420 6265 2069 6e20 6465 6772 6565 7320  t be in degrees 
-0001e4c0: 666f 7220 7468 6973 2066 756e 6374 696f  for this functio
-0001e4d0: 6e2e 2229 0a0a 2020 2020 2020 2020 2320  n.")..        # 
-0001e4e0: 4966 206e 6f20 6375 7374 6f6d 2072 6567  If no custom reg
-0001e4f0: 696f 6e73 2061 7272 6179 2077 6173 2070  ions array was p
-0001e500: 6173 7365 642c 2077 6520 7573 6520 7468  assed, we use th
-0001e510: 6520 696e 7465 726e 616c 2061 7272 6179  e internal array
-0001e520: 206f 6620 696e 7465 726c 6f70 6572 2072   of interloper r
-0001e530: 6567 696f 6e73 0a20 2020 2020 2020 2069  egions.        i
-0001e540: 6620 7265 6769 6f6e 735f 746f 5f73 6561  f regions_to_sea
-0001e550: 7263 6820 6973 204e 6f6e 653a 0a20 2020  rch is None:.   
-0001e560: 2020 2020 2020 2020 2072 6567 696f 6e73           regions
-0001e570: 5f74 6f5f 7365 6172 6368 203d 2073 656c  _to_search = sel
-0001e580: 662e 5f69 6e74 6572 6c6f 7065 725f 7265  f._interloper_re
-0001e590: 6769 6f6e 732e 636f 7079 2829 0a0a 2020  gions.copy()..  
-0001e5a0: 2020 2020 2020 696e 6e65 725f 7261 6469        inner_radi
-0001e5b0: 7573 203d 2073 656c 662e 636f 6e76 6572  us = self.conver
-0001e5c0: 745f 7261 6469 7573 2869 6e6e 6572 5f72  t_radius(inner_r
-0001e5d0: 6164 6975 732c 2027 6465 6727 290a 2020  adius, 'deg').  
-0001e5e0: 2020 2020 2020 6f75 7465 725f 7261 6469        outer_radi
-0001e5f0: 7573 203d 2073 656c 662e 636f 6e76 6572  us = self.conver
-0001e600: 745f 7261 6469 7573 286f 7574 6572 5f72  t_radius(outer_r
-0001e610: 6164 6975 732c 2027 6465 6727 290a 0a20  adius, 'deg').. 
-0001e620: 2020 2020 2020 2023 2054 6865 6e20 7765         # Then we
-0001e630: 2063 616e 2063 6865 636b 2074 6f20 6d61   can check to ma
-0001e640: 6b65 2073 7572 6520 7468 6174 2074 6865  ke sure that the
-0001e650: 206f 7574 6572 2072 6164 6975 7320 6973   outer radius is
-0001e660: 206c 6172 6765 7220 7468 616e 2074 6865   larger than the
-0001e670: 2069 6e6e 6572 2072 6164 6975 730a 2020   inner radius.  
-0001e680: 2020 2020 2020 6966 2069 6e6e 6572 5f72        if inner_r
-0001e690: 6164 6975 7320 3e3d 206f 7574 6572 5f72  adius >= outer_r
-0001e6a0: 6164 6975 733a 0a20 2020 2020 2020 2020  adius:.         
-0001e6b0: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-0001e6c0: 726f 7228 2269 6e6e 6572 5f72 6164 6975  ror("inner_radiu
-0001e6d0: 7320 6361 6e6e 6f74 2062 6520 6c61 7267  s cannot be larg
-0001e6e0: 6572 2074 6861 6e20 6f72 2065 7175 616c  er than or equal
-0001e6f0: 2074 6f20 6f75 7465 725f 7261 6469 7573   to outer_radius
-0001e700: 222e 666f 726d 6174 2873 3d73 656c 662e  ".format(s=self.
-0001e710: 6e61 6d65 2929 0a0a 2020 2020 2020 2020  name))..        
-0001e720: 2320 4920 7468 696e 6b20 6d79 206c 6173  # I think my las
-0001e730: 7420 6174 7465 6d70 7420 6174 2074 6869  t attempt at thi
-0001e740: 7320 7479 7065 206f 6620 6675 6e63 7469  s type of functi
-0001e750: 6f6e 2077 6173 206d 6164 6520 7265 616c  on was made real
-0001e760: 6c79 2073 6c6f 7720 6279 2073 6f6d 6574  ly slow by somet
-0001e770: 6869 6e67 2074 6f20 7769 7468 2074 6865  hing to with the
-0001e780: 2072 6567 696f 6e73 0a20 2020 2020 2020   regions.       
-0001e790: 2023 2020 6d6f 6475 6c65 2c20 736f 2049   #  module, so I
-0001e7a0: 276d 2067 6f69 6e67 2074 6f20 7472 7920  'm going to try 
-0001e7b0: 616e 6420 6d6f 7665 2061 7761 7920 6672  and move away fr
-0001e7c0: 6f6d 2074 6861 7420 6865 7265 0a20 2020  om that here.   
-0001e7d0: 2020 2020 2023 2054 6869 7320 6973 2068       # This is h
-0001e7e0: 6f72 7269 626c 6520 4920 6b6e 6f77 2c20  orrible I know, 
-0001e7f0: 6275 7420 6974 2062 6173 6963 616c 6c79  but it basically
-0001e800: 2067 656e 6572 6174 6573 2070 6f69 6e74   generates point
-0001e810: 7320 6f6e 2074 6865 2062 6f75 6e64 6172  s on the boundar
-0001e820: 7920 6f66 2065 6163 6820 696e 7465 726c  y of each interl
-0001e830: 6f70 6572 2c20 616e 6420 7468 656e 0a20  oper, and then. 
-0001e840: 2020 2020 2020 2023 2020 6361 6c63 756c         #  calcul
-0001e850: 6174 6573 2074 6865 6972 2064 6973 7461  ates their dista
-0001e860: 6e63 6520 6672 6f6d 2074 6865 2063 656e  nce from the cen
-0001e870: 7472 616c 2063 6f6f 7264 696e 6174 652e  tral coordinate.
-0001e880: 2053 6f20 796f 7520 656e 6420 7570 2077   So you end up w
-0001e890: 6974 6820 616e 204e 7833 3020 2862 6563  ith an Nx30 (bec
-0001e8a0: 6175 7365 2033 3020 6973 0a20 2020 2020  ause 30 is.     
-0001e8b0: 2020 2023 2020 686f 7720 6d61 6e79 2070     #  how many p
-0001e8c0: 6f69 6e74 7320 4920 6765 6e65 7261 7465  oints I generate
-0001e8d0: 2920 616e 6420 4e20 6973 2074 6865 206e  ) and N is the n
-0001e8e0: 756d 6265 7220 6f66 2070 6f74 656e 7469  umber of potenti
-0001e8f0: 616c 2069 6e74 6572 6c6f 7065 7273 0a20  al interlopers. 
-0001e900: 2020 2020 2020 2069 6e74 5f64 6973 7473         int_dists
-0001e910: 203d 206e 702e 6172 7261 7928 5b6e 702e   = np.array([np.
-0001e920: 7371 7274 286e 702e 7375 6d28 2870 6572  sqrt(np.sum((per
-0001e930: 696d 6574 6572 5f70 6f69 6e74 7328 722e  imeter_points(r.
-0001e940: 6365 6e74 6572 2e72 612e 7661 6c75 652c  center.ra.value,
-0001e950: 2072 2e63 656e 7465 722e 6465 632e 7661   r.center.dec.va
-0001e960: 6c75 652c 0a20 2020 2020 2020 2020 2020  lue,.           
-0001e970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e9a0: 2020 2020 722e 7769 6474 682e 746f 2827      r.width.to('
-0001e9b0: 6465 6727 292e 7661 6c75 652f 322c 0a20  deg').value/2,. 
-0001e9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e9f0: 2020 2020 2020 2020 2020 2020 2020 722e                r.
-0001ea00: 6865 6967 6874 2e74 6f28 2764 6567 2729  height.to('deg')
-0001ea10: 2e76 616c 7565 2f32 2c20 722e 616e 676c  .value/2, r.angl
-0001ea20: 652e 746f 2827 7261 6427 292e 7661 6c75  e.to('rad').valu
-0001ea30: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-0001ea40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ea50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ea60: 202d 2064 6567 5f63 656e 7472 616c 5f63   - deg_central_c
-0001ea70: 6f6f 7264 2e76 616c 7565 2920 2a2a 2032  oord.value) ** 2
-0001ea80: 2c20 6178 6973 3d31 2929 0a20 2020 2020  , axis=1)).     
-0001ea90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001eaa0: 2020 2020 2020 2020 2066 6f72 2072 2069           for r i
-0001eab0: 6e20 7265 6769 6f6e 735f 746f 5f73 6561  n regions_to_sea
-0001eac0: 7263 685d 290a 0a20 2020 2020 2020 2023  rch])..        #
-0001ead0: 2046 696e 6473 2077 6869 6368 206f 6620   Finds which of 
-0001eae0: 7468 6520 706f 7373 6962 6c65 2069 6e74  the possible int
-0001eaf0: 6572 6c6f 7065 7273 2068 6176 6520 616e  erlopers have an
-0001eb00: 7920 7061 7274 206f 6620 7468 6569 7220  y part of their 
-0001eb10: 626f 756e 6461 7279 2077 6974 6869 6e20  boundary within 
-0001eb20: 7468 6520 616e 6e75 6c75 7320 696e 2063  the annulus in c
-0001eb30: 6f6e 7369 6465 7261 7469 6f6e 0a20 2020  onsideration.   
-0001eb40: 2020 2020 2069 6e74 5f77 6974 6869 6e20       int_within 
-0001eb50: 3d20 6e70 2e75 6e69 7175 6528 6e70 2e77  = np.unique(np.w
-0001eb60: 6865 7265 2828 696e 745f 6469 7374 7320  here((int_dists 
-0001eb70: 3c20 6f75 7465 725f 7261 6469 7573 2e76  < outer_radius.v
-0001eb80: 616c 7565 2920 2620 2869 6e74 5f64 6973  alue) & (int_dis
-0001eb90: 7473 203e 2069 6e6e 6572 5f72 6164 6975  ts > inner_radiu
-0001eba0: 732e 7661 6c75 6529 295b 305d 290a 0a20  s.value))[0]).. 
-0001ebb0: 2020 2020 2020 2072 6574 7572 6e20 6e70         return np
-0001ebc0: 2e61 7272 6179 2872 6567 696f 6e73 5f74  .array(regions_t
-0001ebd0: 6f5f 7365 6172 6368 295b 696e 745f 7769  o_search)[int_wi
-0001ebe0: 7468 696e 5d0a 0a20 2020 2040 7374 6174  thin]..    @stat
-0001ebf0: 6963 6d65 7468 6f64 0a20 2020 2064 6566  icmethod.    def
-0001ec00: 205f 696e 7465 726c 6f70 6572 5f73 6173   _interloper_sas
-0001ec10: 5f73 7472 696e 6728 7265 673a 2045 6c6c  _string(reg: Ell
-0001ec20: 6970 7365 536b 7952 6567 696f 6e2c 2069  ipseSkyRegion, i
-0001ec30: 6d3a 2049 6d61 6765 2c20 6f75 7470 7574  m: Image, output
-0001ec40: 5f75 6e69 743a 2055 6e69 6f6e 5b55 6e69  _unit: Union[Uni
-0001ec50: 7442 6173 652c 2073 7472 5d29 202d 3e20  tBase, str]) -> 
-0001ec60: 7374 723a 0a20 2020 2020 2020 2022 2222  str:.        """
-0001ec70: 0a20 2020 2020 2020 2043 6f6e 7665 7274  .        Convert
-0001ec80: 7320 656c 6c69 7073 6520 736b 7920 7265  s ellipse sky re
-0001ec90: 6769 6f6e 7320 696e 746f 2053 4153 2072  gions into SAS r
-0001eca0: 6567 696f 6e20 7374 7269 6e67 7320 666f  egion strings fo
-0001ecb0: 7220 7573 6520 696e 2053 4153 2074 6173  r use in SAS tas
-0001ecc0: 6b73 2e0a 0a20 2020 2020 2020 203a 7061  ks...        :pa
-0001ecd0: 7261 6d20 456c 6c69 7073 6553 6b79 5265  ram EllipseSkyRe
-0001ece0: 6769 6f6e 2072 6567 3a20 5468 6520 696e  gion reg: The in
-0001ecf0: 7465 726c 6f70 6572 2072 6567 696f 6e20  terloper region 
-0001ed00: 746f 2067 656e 6572 6174 6520 6120 5341  to generate a SA
-0001ed10: 5320 7374 7269 6e67 2066 6f72 0a20 2020  S string for.   
-0001ed20: 2020 2020 203a 7061 7261 6d20 496d 6167       :param Imag
-0001ed30: 6520 696d 3a20 5468 6520 5847 4120 696d  e im: The XGA im
-0001ed40: 6167 6520 746f 2075 7365 2066 6f72 2063  age to use for c
-0001ed50: 6f6f 7264 696e 6174 6520 636f 6e76 6572  oordinate conver
-0001ed60: 7369 6f6e 2e0a 2020 2020 2020 2020 3a70  sion..        :p
-0001ed70: 6172 616d 2055 6e69 7442 6173 652f 7374  aram UnitBase/st
-0001ed80: 7220 6f75 7470 7574 5f75 6e69 743a 2054  r output_unit: T
-0001ed90: 6865 206f 7574 7075 7420 756e 6974 2066  he output unit f
-0001eda0: 6f72 2074 6869 7320 5341 5320 7265 6769  or this SAS regi
-0001edb0: 6f6e 2c20 6569 7468 6572 2078 6d6d 5f73  on, either xmm_s
-0001edc0: 6b79 206f 7220 786d 6d5f 6465 742e 0a20  ky or xmm_det.. 
-0001edd0: 2020 2020 2020 203a 7265 7475 726e 3a20         :return: 
-0001ede0: 5468 6520 5341 5320 7374 7269 6e67 2072  The SAS string r
-0001edf0: 6567 696f 6e20 666f 7220 7468 6973 2069  egion for this i
-0001ee00: 6e74 6572 6c6f 7065 720a 2020 2020 2020  nterloper.      
-0001ee10: 2020 3a72 7479 7065 3a20 7374 720a 2020    :rtype: str.  
-0001ee20: 2020 2020 2020 2222 220a 0a20 2020 2020        """..     
-0001ee30: 2020 2069 6620 6f75 7470 7574 5f75 6e69     if output_uni
-0001ee40: 7420 3d3d 2078 6d6d 5f64 6574 3a0a 2020  t == xmm_det:.  
-0001ee50: 2020 2020 2020 2020 2020 635f 7374 7220            c_str 
-0001ee60: 3d20 2244 4554 582c 4445 5459 220a 2020  = "DETX,DETY".  
-0001ee70: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0001ee80: 4e6f 7449 6d70 6c65 6d65 6e74 6564 4572  NotImplementedEr
-0001ee90: 726f 7228 2254 6869 7320 636f 6f72 6469  ror("This coordi
-0001eea0: 6e61 7465 2073 7973 7465 6d20 6973 206e  nate system is n
-0001eeb0: 6f74 2079 6574 2073 7570 706f 7274 6564  ot yet supported
-0001eec0: 2c20 616e 6420 6973 6e27 7420 6120 7072  , and isn't a pr
-0001eed0: 696f 7269 7479 2e20 506c 6561 7365 2022  iority. Please "
-0001eee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001eef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ef00: 2020 2020 2020 2022 7375 626d 6974 2061         "submit a
-0001ef10: 6e20 6973 7375 6520 6f6e 2068 7474 7073  n issue on https
-0001ef20: 3a2f 2f67 6974 6875 622e 636f 6d2f 4461  ://github.com/Da
-0001ef30: 7669 6454 332f 5847 412f 6973 7375 6573  vidT3/XGA/issues
-0001ef40: 2069 6620 796f 7520 7061 7274 6963 756c   if you particul
-0001ef50: 6172 6c79 2022 0a20 2020 2020 2020 2020  arly ".         
-0001ef60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ef70: 2020 2020 2020 2020 2020 2020 2022 7761               "wa
-0001ef80: 6e74 2074 6869 732e 2229 0a20 2020 2020  nt this.").     
-0001ef90: 2020 2065 6c69 6620 6f75 7470 7574 5f75     elif output_u
-0001efa0: 6e69 7420 3d3d 2078 6d6d 5f73 6b79 3a0a  nit == xmm_sky:.
-0001efb0: 2020 2020 2020 2020 2020 2020 635f 7374              c_st
-0001efc0: 7220 3d20 2258 2c59 220a 2020 2020 2020  r = "X,Y".      
-0001efd0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0001efe0: 2020 2020 7261 6973 6520 4e6f 7449 6d70      raise NotImp
-0001eff0: 6c65 6d65 6e74 6564 4572 726f 7228 224f  lementedError("O
-0001f000: 6e6c 7920 6465 7465 6374 6f72 2061 6e64  nly detector and
-0001f010: 2073 6b79 2063 6f6f 7264 696e 6174 6573   sky coordinates
-0001f020: 2061 7265 2063 7572 7265 6e74 6c79 2022   are currently "
-0001f030: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f050: 2020 2020 2020 2022 7375 7070 6f72 7465         "supporte
-0001f060: 6420 666f 7220 6765 6e65 7261 7469 6e67  d for generating
-0001f070: 2053 4153 2072 6567 696f 6e20 7374 7269   SAS region stri
-0001f080: 6e67 732e 2229 0a0a 2020 2020 2020 2020  ngs.")..        
-0001f090: 6365 6e20 3d20 5175 616e 7469 7479 285b  cen = Quantity([
-0001f0a0: 7265 672e 6365 6e74 6572 2e72 612e 7661  reg.center.ra.va
-0001f0b0: 6c75 652c 2072 6567 2e63 656e 7465 722e  lue, reg.center.
-0001f0c0: 6465 632e 7661 6c75 655d 2c20 2764 6567  dec.value], 'deg
-0001f0d0: 2729 0a20 2020 2020 2020 2073 6b79 5f74  ').        sky_t
-0001f0e0: 6f5f 6465 6720 3d20 736b 795f 6465 675f  o_deg = sky_deg_
-0001f0f0: 7363 616c 6528 696d 2c20 6365 6e29 2e76  scale(im, cen).v
-0001f100: 616c 7565 0a20 2020 2020 2020 2063 6f6e  alue.        con
-0001f110: 765f 6365 6e20 3d20 696d 2e63 6f6f 7264  v_cen = im.coord
-0001f120: 5f63 6f6e 7628 6365 6e2c 206f 7574 7075  _conv(cen, outpu
-0001f130: 745f 756e 6974 290a 2020 2020 2020 2020  t_unit).        
-0001f140: 2320 4861 7665 2074 6f20 6469 7669 6465  # Have to divide
-0001f150: 2074 6865 2077 6964 7468 2062 7920 7477   the width by tw
-0001f160: 6f2c 2049 206e 6565 6420 746f 206b 6e6f  o, I need to kno
-0001f170: 7720 7468 6520 6861 6c66 2d77 6964 7468  w the half-width
-0001f180: 2066 6f72 2053 4153 2072 6567 696f 6e73   for SAS regions
-0001f190: 2c20 7468 656e 2063 6f6e 7665 7274 0a20  , then convert. 
-0001f1a0: 2020 2020 2020 2023 2020 6672 6f6d 2064         #  from d
-0001f1b0: 6567 7265 6573 2074 6f20 584d 4d20 736b  egrees to XMM sk
-0001f1c0: 7920 636f 6f72 6469 6e61 7465 7320 7573  y coordinates us
-0001f1d0: 696e 6720 7468 6520 6661 6374 6f72 2077  ing the factor w
-0001f1e0: 6520 6361 6c63 756c 6174 6564 2069 6e20  e calculated in 
-0001f1f0: 7468 6520 6d61 696e 2066 756e 6374 696f  the main functio
-0001f200: 6e0a 2020 2020 2020 2020 7720 3d20 2872  n.        w = (r
-0001f210: 6567 2e77 6964 7468 2e74 6f28 2764 6567  eg.width.to('deg
-0001f220: 2729 2e76 616c 7565 202f 2032 202f 2073  ').value / 2 / s
-0001f230: 6b79 5f74 6f5f 6465 6729 2e72 6f75 6e64  ky_to_deg).round
-0001f240: 2834 290a 2020 2020 2020 2020 2320 5765  (4).        # We
-0001f250: 2064 6f20 7468 6520 7361 6d65 2066 6f72   do the same for
-0001f260: 2074 6865 2068 6569 6768 740a 2020 2020   the height.    
-0001f270: 2020 2020 6820 3d20 2872 6567 2e68 6569      h = (reg.hei
-0001f280: 6768 742e 746f 2827 6465 6727 292e 7661  ght.to('deg').va
-0001f290: 6c75 6520 2f20 3220 2f20 736b 795f 746f  lue / 2 / sky_to
-0001f2a0: 5f64 6567 292e 726f 756e 6428 3429 0a20  _deg).round(4). 
-0001f2b0: 2020 2020 2020 2069 6620 7720 3d3d 2068         if w == h
-0001f2c0: 3a0a 2020 2020 2020 2020 2020 2020 7368  :.            sh
-0001f2d0: 6170 655f 7374 7220 3d20 2228 287b 747d  ape_str = "(({t}
-0001f2e0: 2920 494e 2063 6972 636c 6528 7b63 787d  ) IN circle({cx}
-0001f2f0: 2c7b 6379 7d2c 7b72 7d29 2922 0a20 2020  ,{cy},{r}))".   
-0001f300: 2020 2020 2020 2020 2073 6861 7065 5f73           shape_s
-0001f310: 7472 203d 2073 6861 7065 5f73 7472 2e66  tr = shape_str.f
-0001f320: 6f72 6d61 7428 743d 635f 7374 722c 2063  ormat(t=c_str, c
-0001f330: 783d 636f 6e76 5f63 656e 5b30 5d2e 726f  x=conv_cen[0].ro
-0001f340: 756e 6428 3429 2e76 616c 7565 2c20 6379  und(4).value, cy
-0001f350: 3d63 6f6e 765f 6365 6e5b 315d 2e72 6f75  =conv_cen[1].rou
-0001f360: 6e64 2834 292e 7661 6c75 652c 2072 3d68  nd(4).value, r=h
-0001f370: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-0001f380: 2020 2020 2020 2020 2020 2020 2320 5468              # Th
-0001f390: 6520 726f 7461 7469 6f6e 2061 6e67 6c65  e rotation angle
-0001f3a0: 2066 726f 6d20 7468 6520 7265 6769 6f6e   from the region
-0001f3b0: 206f 626a 6563 7420 6973 2069 6e20 6465   object is in de
-0001f3c0: 6772 6565 7320 616c 7265 6164 790a 2020  grees already.  
-0001f3d0: 2020 2020 2020 2020 2020 7368 6170 655f            shape_
-0001f3e0: 7374 7220 3d20 2228 287b 747d 2920 494e  str = "(({t}) IN
-0001f3f0: 2065 6c6c 6970 7365 287b 6378 7d2c 7b63   ellipse({cx},{c
-0001f400: 797d 2c7b 777d 2c7b 687d 2c7b 726f 747d  y},{w},{h},{rot}
-0001f410: 2929 222e 666f 726d 6174 2874 3d63 5f73  ))".format(t=c_s
-0001f420: 7472 2c20 6378 3d63 6f6e 765f 6365 6e5b  tr, cx=conv_cen[
-0001f430: 305d 2e72 6f75 6e64 2834 292e 7661 6c75  0].round(4).valu
-0001f440: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0001f450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f490: 6379 3d63 6f6e 765f 6365 6e5b 315d 2e72  cy=conv_cen[1].r
-0001f4a0: 6f75 6e64 2834 292e 7661 6c75 652c 2077  ound(4).value, w
-0001f4b0: 3d77 2c20 683d 682c 0a20 2020 2020 2020  =w, h=h,.       
-0001f4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f500: 2020 2020 2020 726f 743d 7265 672e 616e        rot=reg.an
-0001f510: 676c 652e 726f 756e 6428 3429 2e76 616c  gle.round(4).val
-0001f520: 7565 290a 2020 2020 2020 2020 7265 7475  ue).        retu
-0001f530: 726e 2073 6861 7065 5f73 7472 0a0a 2020  rn shape_str..  
-0001f540: 2020 6465 6620 6765 745f 616e 6e75 6c61    def get_annula
-0001f550: 725f 7361 735f 7265 6769 6f6e 2873 656c  r_sas_region(sel
-0001f560: 662c 2069 6e6e 6572 5f72 6164 6975 733a  f, inner_radius:
-0001f570: 2051 7561 6e74 6974 792c 206f 7574 6572   Quantity, outer
-0001f580: 5f72 6164 6975 733a 2051 7561 6e74 6974  _radius: Quantit
-0001f590: 792c 206f 6273 5f69 643a 2073 7472 2c20  y, obs_id: str, 
-0001f5a0: 696e 7374 3a20 7374 722c 0a20 2020 2020  inst: str,.     
+0001d950: 2020 6f62 735f 6964 3d6f 6273 5f69 642c    obs_id=obs_id,
+0001d960: 2063 656e 7472 616c 5f63 6f6f 7264 3d63   central_coord=c
+0001d970: 656e 7472 616c 5f63 6f6f 7264 290a 0a20  entral_coord).. 
+0001d980: 2020 2020 2020 2023 2057 6520 7573 6520         # We use 
+0001d990: 7468 6520 7261 7465 6d61 7027 7320 6275  the ratemap's bu
+0001d9a0: 696c 7420 696e 2062 6163 6b67 726f 756e  ilt in backgroun
+0001d9b0: 6420 7375 6274 7261 6374 6564 2063 6f75  d subtracted cou
+0001d9c0: 6e74 7320 6361 6c63 756c 6174 696f 6e20  nts calculation 
+0001d9d0: 6d65 7468 6f64 0a20 2020 2020 2020 2063  method.        c
+0001d9e0: 6e74 7320 3d20 7274 2e62 6163 6b67 726f  nts = rt.backgro
+0001d9f0: 756e 645f 7375 6274 7261 6374 6564 5f63  und_subtracted_c
+0001da00: 6f75 6e74 7328 7372 635f 6d61 736b 2c20  ounts(src_mask, 
+0001da10: 6263 6b5f 6d61 736b 290a 0a20 2020 2020  bck_mask)..     
+0001da20: 2020 2072 6574 7572 6e20 636e 7473 0a0a     return cnts..
+0001da30: 2020 2020 6465 6620 7265 6769 6f6e 735f      def regions_
+0001da40: 7769 7468 696e 5f72 6164 6969 2873 656c  within_radii(sel
+0001da50: 662c 2069 6e6e 6572 5f72 6164 6975 733a  f, inner_radius:
+0001da60: 2051 7561 6e74 6974 792c 206f 7574 6572   Quantity, outer
+0001da70: 5f72 6164 6975 733a 2051 7561 6e74 6974  _radius: Quantit
+0001da80: 792c 2064 6567 5f63 656e 7472 616c 5f63  y, deg_central_c
+0001da90: 6f6f 7264 3a20 5175 616e 7469 7479 2c0a  oord: Quantity,.
+0001daa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dab0: 2020 2020 2020 2020 2020 2020 2072 6567               reg
+0001dac0: 696f 6e73 5f74 6f5f 7365 6172 6368 3a20  ions_to_search: 
+0001dad0: 556e 696f 6e5b 6e70 2e6e 6461 7272 6179  Union[np.ndarray
+0001dae0: 2c20 6c69 7374 5d20 3d20 4e6f 6e65 2920  , list] = None) 
+0001daf0: 2d3e 206e 702e 6e64 6172 7261 793a 0a20  -> np.ndarray:. 
+0001db00: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0001db10: 2020 2054 6869 7320 6675 6e63 7469 6f6e     This function
+0001db20: 2066 696e 6473 2061 6e64 2072 6574 7572   finds and retur
+0001db30: 6e73 2061 6e79 2069 6e74 6572 6c6f 7065  ns any interlope
+0001db40: 7220 7265 6769 6f6e 7320 2862 7920 6465  r regions (by de
+0001db50: 6661 756c 7429 2074 6861 7420 6861 7665  fault) that have
+0001db60: 2061 6e79 2070 6172 7420 6f66 2074 6865   any part of the
+0001db70: 6972 2062 6f75 6e64 6172 790a 2020 2020  ir boundary.    
+0001db80: 2020 2020 7769 7468 696e 2074 6865 2073      within the s
+0001db90: 7065 6369 6669 6564 2072 6164 6969 2c20  pecified radii, 
+0001dba0: 6365 6e74 6572 6564 206f 6e20 7468 6520  centered on the 
+0001dbb0: 7370 6563 6966 6965 6420 6365 6e74 7261  specified centra
+0001dbc0: 6c20 636f 6f72 6469 6e61 7465 2e20 5573  l coordinate. Us
+0001dbd0: 6572 7320 6d61 7920 616c 736f 2070 6173  ers may also pas
+0001dbe0: 7320 7468 6569 7220 6f77 6e0a 2020 2020  s their own.    
+0001dbf0: 2020 2020 6172 7261 7920 6f66 2072 6567      array of reg
+0001dc00: 696f 6e73 2074 6f20 6368 6563 6b2e 0a0a  ions to check...
+0001dc10: 2020 2020 2020 2020 3a70 6172 616d 2051          :param Q
+0001dc20: 7561 6e74 6974 7920 696e 6e65 725f 7261  uantity inner_ra
+0001dc30: 6469 7573 3a20 5468 6520 696e 6e65 7220  dius: The inner 
+0001dc40: 7261 6469 7573 206f 6620 7468 6520 6172  radius of the ar
+0001dc50: 6561 2074 6f20 7365 6172 6368 2066 6f72  ea to search for
+0001dc60: 2069 6e74 6572 6c6f 7065 7273 2069 6e2e   interlopers in.
+0001dc70: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+0001dc80: 5175 616e 7469 7479 206f 7574 6572 5f72  Quantity outer_r
+0001dc90: 6164 6975 733a 2054 6865 206f 7574 6572  adius: The outer
+0001dca0: 2072 6164 6975 7320 6f66 2074 6865 2061   radius of the a
+0001dcb0: 7265 6120 746f 2073 6561 7263 6820 666f  rea to search fo
+0001dcc0: 7220 696e 7465 726c 6f70 6572 7320 696e  r interlopers in
+0001dcd0: 2e0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
+0001dce0: 2051 7561 6e74 6974 7920 6465 675f 6365   Quantity deg_ce
+0001dcf0: 6e74 7261 6c5f 636f 6f72 643a 2054 6865  ntral_coord: The
+0001dd00: 2063 656e 7472 616c 2063 6f6f 7264 696e   central coordin
+0001dd10: 6174 6520 2849 4e20 4445 4752 4545 5329  ate (IN DEGREES)
+0001dd20: 206f 6620 7468 6520 6172 6561 2074 6f20   of the area to 
+0001dd30: 7365 6172 6368 2066 6f72 0a20 2020 2020  search for.     
+0001dd40: 2020 2020 2020 2069 6e74 6572 6c6f 7065         interlope
+0001dd50: 7273 2069 6e2e 0a20 2020 2020 2020 203a  rs in..        :
+0001dd60: 7061 7261 6d20 6e70 2e6e 6461 7272 6179  param np.ndarray
+0001dd70: 2f6c 6973 7420 7265 6769 6f6e 735f 746f  /list regions_to
+0001dd80: 5f73 6561 7263 683a 2041 6e20 6f70 7469  _search: An opti
+0001dd90: 6f6e 616c 2070 6172 616d 6574 6572 2074  onal parameter t
+0001dda0: 6861 7420 616c 6c6f 7773 2074 6865 2075  hat allows the u
+0001ddb0: 7365 7220 746f 2070 6173 7320 6120 7370  ser to pass a sp
+0001ddc0: 6563 6966 6963 0a20 2020 2020 2020 2020  ecific.         
+0001ddd0: 2020 206c 6973 7420 6f66 2072 6567 696f     list of regio
+0001dde0: 6e73 2074 6f20 6368 6563 6b2e 2044 6566  ns to check. Def
+0001ddf0: 6175 6c74 2069 7320 4e6f 6e65 2c20 696e  ault is None, in
+0001de00: 2077 6869 6368 2063 6173 6520 7468 6520   which case the 
+0001de10: 696e 7465 726c 6f70 6572 5f72 6567 696f  interloper_regio
+0001de20: 6e73 2069 6e74 6572 6e61 6c20 6c69 7374  ns internal list
+0001de30: 0a20 2020 2020 2020 2020 2020 2077 696c  .            wil
+0001de40: 6c20 6265 2075 7365 642e 0a20 2020 2020  l be used..     
+0001de50: 2020 203a 7265 7475 726e 3a20 4120 6e75     :return: A nu
+0001de60: 6d70 7920 6172 7261 7920 6f66 2074 6865  mpy array of the
+0001de70: 2069 6e74 6572 6c6f 7065 7220 7265 6769   interloper regi
+0001de80: 6f6e 7320 286f 7220 7573 6572 2070 6173  ons (or user pas
+0001de90: 7365 6420 7265 6769 6f6e 7329 2077 6974  sed regions) wit
+0001dea0: 6869 6e20 7468 6520 7370 6563 6966 6965  hin the specifie
+0001deb0: 6420 6172 6561 2e0a 2020 2020 2020 2020  d area..        
+0001dec0: 3a72 7479 7065 3a20 6e70 2e6e 6461 7272  :rtype: np.ndarr
+0001ded0: 6179 0a20 2020 2020 2020 2022 2222 0a20  ay.        """. 
+0001dee0: 2020 2020 2020 2064 6566 2070 6572 696d         def perim
+0001def0: 6574 6572 5f70 6f69 6e74 7328 7265 675f  eter_points(reg_
+0001df00: 6365 6e5f 783a 2066 6c6f 6174 2c20 7265  cen_x: float, re
+0001df10: 675f 6365 6e5f 793a 2066 6c6f 6174 2c20  g_cen_y: float, 
+0001df20: 7265 675f 6d61 6a6f 725f 7261 643a 2066  reg_major_rad: f
+0001df30: 6c6f 6174 2c20 7265 675f 6d69 6e6f 725f  loat, reg_minor_
+0001df40: 7261 643a 2066 6c6f 6174 2c0a 2020 2020  rad: float,.    
+0001df50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001df60: 2020 2020 2020 2020 2072 6f74 6174 696f           rotatio
+0001df70: 6e3a 2066 6c6f 6174 2920 2d3e 206e 702e  n: float) -> np.
+0001df80: 6e64 6172 7261 793a 0a20 2020 2020 2020  ndarray:.       
+0001df90: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0001dfa0: 2020 2020 2041 6e20 696e 7465 726e 616c       An internal
+0001dfb0: 2066 756e 6374 696f 6e20 746f 2067 656e   function to gen
+0001dfc0: 6572 6174 6520 7468 6972 7479 2078 2d79  erate thirty x-y
+0001dfd0: 2070 6f73 6974 696f 6e73 206f 6e20 7468   positions on th
+0001dfe0: 6520 626f 756e 6461 7279 206f 6620 6120  e boundary of a 
+0001dff0: 7061 7274 6963 756c 6172 2072 6567 696f  particular regio
+0001e000: 6e2e 0a0a 2020 2020 2020 2020 2020 2020  n...            
+0001e010: 3a70 6172 616d 2066 6c6f 6174 2072 6567  :param float reg
+0001e020: 5f63 656e 5f78 3a20 5468 6520 7820 706f  _cen_x: The x po
+0001e030: 7369 7469 6f6e 206f 6620 7468 6520 6365  sition of the ce
+0001e040: 6e74 7265 206f 6620 7468 6520 7265 6769  ntre of the regi
+0001e050: 6f6e 2c20 696e 2064 6567 7265 6573 2e0a  on, in degrees..
+0001e060: 2020 2020 2020 2020 2020 2020 3a70 6172              :par
+0001e070: 616d 2066 6c6f 6174 2072 6567 5f63 656e  am float reg_cen
+0001e080: 5f79 3a20 5468 6520 7920 706f 7369 7469  _y: The y positi
+0001e090: 6f6e 206f 6620 7468 6520 6365 6e74 7265  on of the centre
+0001e0a0: 206f 6620 7468 6520 7265 6769 6f6e 2c20   of the region, 
+0001e0b0: 696e 2064 6567 7265 6573 0a20 2020 2020  in degrees.     
+0001e0c0: 2020 2020 2020 203a 7061 7261 6d20 666c         :param fl
+0001e0d0: 6f61 7420 7265 675f 6d61 6a6f 725f 7261  oat reg_major_ra
+0001e0e0: 643a 2054 6865 2073 656d 692d 6d61 6a6f  d: The semi-majo
+0001e0f0: 7220 6178 6973 206f 6620 7468 6520 7265  r axis of the re
+0001e100: 6769 6f6e 2c20 696e 2064 6567 7265 6573  gion, in degrees
+0001e110: 2e0a 2020 2020 2020 2020 2020 2020 3a70  ..            :p
+0001e120: 6172 616d 2066 6c6f 6174 2072 6567 5f6d  aram float reg_m
+0001e130: 696e 6f72 5f72 6164 3a20 5468 6520 7365  inor_rad: The se
+0001e140: 6d69 2d6d 696e 6f72 2061 7869 7320 6f66  mi-minor axis of
+0001e150: 2074 6865 2072 6567 696f 6e2c 2069 6e20   the region, in 
+0001e160: 6465 6772 6565 732e 0a20 2020 2020 2020  degrees..       
+0001e170: 2020 2020 203a 7061 7261 6d20 666c 6f61       :param floa
+0001e180: 7420 726f 7461 7469 6f6e 3a20 5468 6520  t rotation: The 
+0001e190: 726f 7461 7469 6f6e 206f 6620 7468 6520  rotation of the 
+0001e1a0: 7265 6769 6f6e 2c20 696e 2072 6164 6961  region, in radia
+0001e1b0: 6e73 2e0a 2020 2020 2020 2020 2020 2020  ns..            
+0001e1c0: 3a72 6574 7572 6e3a 2041 6e20 6172 7261  :return: An arra
+0001e1d0: 7920 6f66 2074 6869 7274 7920 782d 7920  y of thirty x-y 
+0001e1e0: 636f 6f72 6469 6e61 7465 7320 6f6e 2074  coordinates on t
+0001e1f0: 6865 2062 6f75 6e64 6172 7920 6f66 2074  he boundary of t
+0001e200: 6865 2072 6567 696f 6e2e 0a20 2020 2020  he region..     
+0001e210: 2020 2020 2020 203a 7274 7970 653a 206e         :rtype: n
+0001e220: 702e 6e64 6172 7261 790a 2020 2020 2020  p.ndarray.      
+0001e230: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0001e240: 2020 2020 2020 2320 4a75 7374 2074 6865        # Just the
+0001e250: 206e 756d 7079 2061 7272 6179 206f 6620   numpy array of 
+0001e260: 616e 676c 6573 2028 696e 2072 6164 6961  angles (in radia
+0001e270: 6e73 2920 746f 2066 696e 6420 7468 6520  ns) to find the 
+0001e280: 782d 7920 706f 696e 7473 206f 660a 2020  x-y points of.  
+0001e290: 2020 2020 2020 2020 2020 616e 6773 203d            angs =
+0001e2a0: 206e 702e 6c69 6e73 7061 6365 2830 2c20   np.linspace(0, 
+0001e2b0: 3220 2a20 6e70 2e70 692c 2033 3029 0a0a  2 * np.pi, 30)..
+0001e2c0: 2020 2020 2020 2020 2020 2020 2320 5468              # Th
+0001e2d0: 6973 2069 7320 6a75 7374 2074 6865 2070  is is just the p
+0001e2e0: 6172 616d 6574 7269 6320 6571 7561 7469  arametric equati
+0001e2f0: 6f6e 206f 6620 616e 2065 6c6c 6970 7365  on of an ellipse
+0001e300: 202d 2049 206f 6e6c 7920 696e 636c 7564   - I only includ
+0001e310: 6520 7468 6520 6469 7370 6c61 6365 6d65  e the displaceme
+0001e320: 6e74 2074 6f20 7468 650a 2020 2020 2020  nt to the.      
+0001e330: 2020 2020 2020 2320 2063 656e 7472 616c        #  central
+0001e340: 2063 6f6f 7264 696e 6174 6573 206f 6620   coordinates of 
+0001e350: 7468 6520 7265 6769 6f6e 2041 4654 4552  the region AFTER
+0001e360: 2069 7420 6861 7320 6265 656e 2072 6f74   it has been rot
+0001e370: 6174 6564 0a20 2020 2020 2020 2020 2020  ated.           
+0001e380: 2078 203d 2072 6567 5f6d 616a 6f72 5f72   x = reg_major_r
+0001e390: 6164 202a 206e 702e 636f 7328 616e 6773  ad * np.cos(angs
+0001e3a0: 290a 2020 2020 2020 2020 2020 2020 7920  ).            y 
+0001e3b0: 3d20 7265 675f 6d69 6e6f 725f 7261 6420  = reg_minor_rad 
+0001e3c0: 2a20 6e70 2e73 696e 2861 6e67 7329 0a0a  * np.sin(angs)..
+0001e3d0: 2020 2020 2020 2020 2020 2020 2320 5365              # Se
+0001e3e0: 7473 206f 6620 7468 6520 726f 7461 7469  ts of the rotati
+0001e3f0: 6f6e 206d 6174 7269 780a 2020 2020 2020  on matrix.      
+0001e400: 2020 2020 2020 726f 745f 6d61 7420 3d20        rot_mat = 
+0001e410: 6e70 2e61 7272 6179 285b 5b6e 702e 636f  np.array([[np.co
+0001e420: 7328 726f 7461 7469 6f6e 292c 202d 3120  s(rotation), -1 
+0001e430: 2a20 6e70 2e73 696e 2872 6f74 6174 696f  * np.sin(rotatio
+0001e440: 6e29 5d2c 205b 6e70 2e73 696e 2872 6f74  n)], [np.sin(rot
+0001e450: 6174 696f 6e29 2c20 6e70 2e63 6f73 2872  ation), np.cos(r
+0001e460: 6f74 6174 696f 6e29 5d5d 290a 0a20 2020  otation)]])..   
+0001e470: 2020 2020 2020 2020 2023 204a 7573 7420           # Just 
+0001e480: 726f 7461 7465 7320 7468 6520 6564 6765  rotates the edge
+0001e490: 2063 6f6f 7264 696e 6174 6573 2074 6f20   coordinates to 
+0001e4a0: 6d61 7463 6820 7468 6520 6b6e 6f77 6e20  match the known 
+0001e4b0: 726f 7461 7469 6f6e 206f 6620 7468 6973  rotation of this
+0001e4c0: 2070 6172 7469 6375 6c61 7220 7265 6769   particular regi
+0001e4d0: 6f6e 0a20 2020 2020 2020 2020 2020 2065  on.            e
+0001e4e0: 6467 655f 636f 6f72 6473 203d 2028 726f  dge_coords = (ro
+0001e4f0: 745f 6d61 7420 4020 6e70 2e76 7374 6163  t_mat @ np.vstac
+0001e500: 6b28 5b78 2c20 795d 2929 2e54 0a0a 2020  k([x, y])).T..  
+0001e510: 2020 2020 2020 2020 2020 2320 4e6f 7720            # Now 
+0001e520: 4920 7265 2d63 656e 7472 6520 7468 6520  I re-centre the 
+0001e530: 7265 6769 6f6e 0a20 2020 2020 2020 2020  region.         
+0001e540: 2020 2065 6467 655f 636f 6f72 6473 5b3a     edge_coords[:
+0001e550: 2c20 305d 202b 3d20 7265 675f 6365 6e5f  , 0] += reg_cen_
+0001e560: 780a 2020 2020 2020 2020 2020 2020 6564  x.            ed
+0001e570: 6765 5f63 6f6f 7264 735b 3a2c 2031 5d20  ge_coords[:, 1] 
+0001e580: 2b3d 2072 6567 5f63 656e 5f79 0a0a 2020  += reg_cen_y..  
+0001e590: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0001e5a0: 2065 6467 655f 636f 6f72 6473 0a0a 2020   edge_coords..  
+0001e5b0: 2020 2020 2020 6966 2064 6567 5f63 656e        if deg_cen
+0001e5c0: 7472 616c 5f63 6f6f 7264 2e75 6e69 7420  tral_coord.unit 
+0001e5d0: 213d 2064 6567 3a0a 2020 2020 2020 2020  != deg:.        
+0001e5e0: 2020 2020 7261 6973 6520 556e 6974 436f      raise UnitCo
+0001e5f0: 6e76 6572 7369 6f6e 4572 726f 7228 2254  nversionError("T
+0001e600: 6865 2063 656e 7472 616c 2063 6f6f 7264  he central coord
+0001e610: 696e 6174 6520 6d75 7374 2062 6520 696e  inate must be in
+0001e620: 2064 6567 7265 6573 2066 6f72 2074 6869   degrees for thi
+0001e630: 7320 6675 6e63 7469 6f6e 2e22 290a 0a20  s function.").. 
+0001e640: 2020 2020 2020 2023 2049 6620 6e6f 2063         # If no c
+0001e650: 7573 746f 6d20 7265 6769 6f6e 7320 6172  ustom regions ar
+0001e660: 7261 7920 7761 7320 7061 7373 6564 2c20  ray was passed, 
+0001e670: 7765 2075 7365 2074 6865 2069 6e74 6572  we use the inter
+0001e680: 6e61 6c20 6172 7261 7920 6f66 2069 6e74  nal array of int
+0001e690: 6572 6c6f 7065 7220 7265 6769 6f6e 730a  erloper regions.
+0001e6a0: 2020 2020 2020 2020 6966 2072 6567 696f          if regio
+0001e6b0: 6e73 5f74 6f5f 7365 6172 6368 2069 7320  ns_to_search is 
+0001e6c0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0001e6d0: 2020 7265 6769 6f6e 735f 746f 5f73 6561    regions_to_sea
+0001e6e0: 7263 6820 3d20 7365 6c66 2e5f 696e 7465  rch = self._inte
+0001e6f0: 726c 6f70 6572 5f72 6567 696f 6e73 2e63  rloper_regions.c
+0001e700: 6f70 7928 290a 0a20 2020 2020 2020 2069  opy()..        i
+0001e710: 6e6e 6572 5f72 6164 6975 7320 3d20 7365  nner_radius = se
+0001e720: 6c66 2e63 6f6e 7665 7274 5f72 6164 6975  lf.convert_radiu
+0001e730: 7328 696e 6e65 725f 7261 6469 7573 2c20  s(inner_radius, 
+0001e740: 2764 6567 2729 0a20 2020 2020 2020 206f  'deg').        o
+0001e750: 7574 6572 5f72 6164 6975 7320 3d20 7365  uter_radius = se
+0001e760: 6c66 2e63 6f6e 7665 7274 5f72 6164 6975  lf.convert_radiu
+0001e770: 7328 6f75 7465 725f 7261 6469 7573 2c20  s(outer_radius, 
+0001e780: 2764 6567 2729 0a0a 2020 2020 2020 2020  'deg')..        
+0001e790: 2320 5468 656e 2077 6520 6361 6e20 6368  # Then we can ch
+0001e7a0: 6563 6b20 746f 206d 616b 6520 7375 7265  eck to make sure
+0001e7b0: 2074 6861 7420 7468 6520 6f75 7465 7220   that the outer 
+0001e7c0: 7261 6469 7573 2069 7320 6c61 7267 6572  radius is larger
+0001e7d0: 2074 6861 6e20 7468 6520 696e 6e65 7220   than the inner 
+0001e7e0: 7261 6469 7573 0a20 2020 2020 2020 2069  radius.        i
+0001e7f0: 6620 696e 6e65 725f 7261 6469 7573 203e  f inner_radius >
+0001e800: 3d20 6f75 7465 725f 7261 6469 7573 3a0a  = outer_radius:.
+0001e810: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0001e820: 6520 5661 6c75 6545 7272 6f72 2822 696e  e ValueError("in
+0001e830: 6e65 725f 7261 6469 7573 2063 616e 6e6f  ner_radius canno
+0001e840: 7420 6265 206c 6172 6765 7220 7468 616e  t be larger than
+0001e850: 206f 7220 6571 7561 6c20 746f 206f 7574   or equal to out
+0001e860: 6572 5f72 6164 6975 7322 2e66 6f72 6d61  er_radius".forma
+0001e870: 7428 733d 7365 6c66 2e6e 616d 6529 290a  t(s=self.name)).
+0001e880: 0a20 2020 2020 2020 2023 2049 2074 6869  .        # I thi
+0001e890: 6e6b 206d 7920 6c61 7374 2061 7474 656d  nk my last attem
+0001e8a0: 7074 2061 7420 7468 6973 2074 7970 6520  pt at this type 
+0001e8b0: 6f66 2066 756e 6374 696f 6e20 7761 7320  of function was 
+0001e8c0: 6d61 6465 2072 6561 6c6c 7920 736c 6f77  made really slow
+0001e8d0: 2062 7920 736f 6d65 7468 696e 6720 746f   by something to
+0001e8e0: 2077 6974 6820 7468 6520 7265 6769 6f6e   with the region
+0001e8f0: 730a 2020 2020 2020 2020 2320 206d 6f64  s.        #  mod
+0001e900: 756c 652c 2073 6f20 4927 6d20 676f 696e  ule, so I'm goin
+0001e910: 6720 746f 2074 7279 2061 6e64 206d 6f76  g to try and mov
+0001e920: 6520 6177 6179 2066 726f 6d20 7468 6174  e away from that
+0001e930: 2068 6572 650a 2020 2020 2020 2020 2320   here.        # 
+0001e940: 5468 6973 2069 7320 686f 7272 6962 6c65  This is horrible
+0001e950: 2049 206b 6e6f 772c 2062 7574 2069 7420   I know, but it 
+0001e960: 6261 7369 6361 6c6c 7920 6765 6e65 7261  basically genera
+0001e970: 7465 7320 706f 696e 7473 206f 6e20 7468  tes points on th
+0001e980: 6520 626f 756e 6461 7279 206f 6620 6561  e boundary of ea
+0001e990: 6368 2069 6e74 6572 6c6f 7065 722c 2061  ch interloper, a
+0001e9a0: 6e64 2074 6865 6e0a 2020 2020 2020 2020  nd then.        
+0001e9b0: 2320 2063 616c 6375 6c61 7465 7320 7468  #  calculates th
+0001e9c0: 6569 7220 6469 7374 616e 6365 2066 726f  eir distance fro
+0001e9d0: 6d20 7468 6520 6365 6e74 7261 6c20 636f  m the central co
+0001e9e0: 6f72 6469 6e61 7465 2e20 536f 2079 6f75  ordinate. So you
+0001e9f0: 2065 6e64 2075 7020 7769 7468 2061 6e20   end up with an 
+0001ea00: 4e78 3330 2028 6265 6361 7573 6520 3330  Nx30 (because 30
+0001ea10: 2069 730a 2020 2020 2020 2020 2320 2068   is.        #  h
+0001ea20: 6f77 206d 616e 7920 706f 696e 7473 2049  ow many points I
+0001ea30: 2067 656e 6572 6174 6529 2061 6e64 204e   generate) and N
+0001ea40: 2069 7320 7468 6520 6e75 6d62 6572 206f   is the number o
+0001ea50: 6620 706f 7465 6e74 6961 6c20 696e 7465  f potential inte
+0001ea60: 726c 6f70 6572 730a 2020 2020 2020 2020  rlopers.        
+0001ea70: 696e 745f 6469 7374 7320 3d20 6e70 2e61  int_dists = np.a
+0001ea80: 7272 6179 285b 6e70 2e73 7172 7428 6e70  rray([np.sqrt(np
+0001ea90: 2e73 756d 2828 7065 7269 6d65 7465 725f  .sum((perimeter_
+0001eaa0: 706f 696e 7473 2872 2e63 656e 7465 722e  points(r.center.
+0001eab0: 7261 2e76 616c 7565 2c20 722e 6365 6e74  ra.value, r.cent
+0001eac0: 6572 2e64 6563 2e76 616c 7565 2c0a 2020  er.dec.value,.  
+0001ead0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001eae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001eaf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001eb00: 2020 2020 2020 2020 2020 2020 2072 2e77               r.w
+0001eb10: 6964 7468 2e74 6f28 2764 6567 2729 2e76  idth.to('deg').v
+0001eb20: 616c 7565 2f32 2c0a 2020 2020 2020 2020  alue/2,.        
+0001eb30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001eb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001eb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001eb60: 2020 2020 2020 2072 2e68 6569 6768 742e         r.height.
+0001eb70: 746f 2827 6465 6727 292e 7661 6c75 652f  to('deg').value/
+0001eb80: 322c 2072 2e61 6e67 6c65 2e74 6f28 2772  2, r.angle.to('r
+0001eb90: 6164 2729 2e76 616c 7565 290a 2020 2020  ad').value).    
+0001eba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ebb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ebc0: 2020 2020 2020 2020 2020 2d20 6465 675f            - deg_
+0001ebd0: 6365 6e74 7261 6c5f 636f 6f72 642e 7661  central_coord.va
+0001ebe0: 6c75 6529 202a 2a20 322c 2061 7869 733d  lue) ** 2, axis=
+0001ebf0: 3129 290a 2020 2020 2020 2020 2020 2020  1)).            
+0001ec00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ec10: 2020 666f 7220 7220 696e 2072 6567 696f    for r in regio
+0001ec20: 6e73 5f74 6f5f 7365 6172 6368 5d29 0a0a  ns_to_search])..
+0001ec30: 2020 2020 2020 2020 2320 4669 6e64 7320          # Finds 
+0001ec40: 7768 6963 6820 6f66 2074 6865 2070 6f73  which of the pos
+0001ec50: 7369 626c 6520 696e 7465 726c 6f70 6572  sible interloper
+0001ec60: 7320 6861 7665 2061 6e79 2070 6172 7420  s have any part 
+0001ec70: 6f66 2074 6865 6972 2062 6f75 6e64 6172  of their boundar
+0001ec80: 7920 7769 7468 696e 2074 6865 2061 6e6e  y within the ann
+0001ec90: 756c 7573 2069 6e20 636f 6e73 6964 6572  ulus in consider
+0001eca0: 6174 696f 6e0a 2020 2020 2020 2020 696e  ation.        in
+0001ecb0: 745f 7769 7468 696e 203d 206e 702e 756e  t_within = np.un
+0001ecc0: 6971 7565 286e 702e 7768 6572 6528 2869  ique(np.where((i
+0001ecd0: 6e74 5f64 6973 7473 203c 206f 7574 6572  nt_dists < outer
+0001ece0: 5f72 6164 6975 732e 7661 6c75 6529 2026  _radius.value) &
+0001ecf0: 2028 696e 745f 6469 7374 7320 3e20 696e   (int_dists > in
+0001ed00: 6e65 725f 7261 6469 7573 2e76 616c 7565  ner_radius.value
+0001ed10: 2929 5b30 5d29 0a0a 2020 2020 2020 2020  ))[0])..        
+0001ed20: 7265 7475 726e 206e 702e 6172 7261 7928  return np.array(
+0001ed30: 7265 6769 6f6e 735f 746f 5f73 6561 7263  regions_to_searc
+0001ed40: 6829 5b69 6e74 5f77 6974 6869 6e5d 0a0a  h)[int_within]..
+0001ed50: 2020 2020 4073 7461 7469 636d 6574 686f      @staticmetho
+0001ed60: 640a 2020 2020 6465 6620 5f69 6e74 6572  d.    def _inter
+0001ed70: 6c6f 7065 725f 7361 735f 7374 7269 6e67  loper_sas_string
+0001ed80: 2872 6567 3a20 456c 6c69 7073 6553 6b79  (reg: EllipseSky
+0001ed90: 5265 6769 6f6e 2c20 696d 3a20 496d 6167  Region, im: Imag
+0001eda0: 652c 206f 7574 7075 745f 756e 6974 3a20  e, output_unit: 
+0001edb0: 556e 696f 6e5b 556e 6974 4261 7365 2c20  Union[UnitBase, 
+0001edc0: 7374 725d 2920 2d3e 2073 7472 3a0a 2020  str]) -> str:.  
+0001edd0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0001ede0: 2020 436f 6e76 6572 7473 2065 6c6c 6970    Converts ellip
+0001edf0: 7365 2073 6b79 2072 6567 696f 6e73 2069  se sky regions i
+0001ee00: 6e74 6f20 5341 5320 7265 6769 6f6e 2073  nto SAS region s
+0001ee10: 7472 696e 6773 2066 6f72 2075 7365 2069  trings for use i
+0001ee20: 6e20 5341 5320 7461 736b 732e 0a0a 2020  n SAS tasks...  
+0001ee30: 2020 2020 2020 3a70 6172 616d 2045 6c6c        :param Ell
+0001ee40: 6970 7365 536b 7952 6567 696f 6e20 7265  ipseSkyRegion re
+0001ee50: 673a 2054 6865 2069 6e74 6572 6c6f 7065  g: The interlope
+0001ee60: 7220 7265 6769 6f6e 2074 6f20 6765 6e65  r region to gene
+0001ee70: 7261 7465 2061 2053 4153 2073 7472 696e  rate a SAS strin
+0001ee80: 6720 666f 720a 2020 2020 2020 2020 3a70  g for.        :p
+0001ee90: 6172 616d 2049 6d61 6765 2069 6d3a 2054  aram Image im: T
+0001eea0: 6865 2058 4741 2069 6d61 6765 2074 6f20  he XGA image to 
+0001eeb0: 7573 6520 666f 7220 636f 6f72 6469 6e61  use for coordina
+0001eec0: 7465 2063 6f6e 7665 7273 696f 6e2e 0a20  te conversion.. 
+0001eed0: 2020 2020 2020 203a 7061 7261 6d20 556e         :param Un
+0001eee0: 6974 4261 7365 2f73 7472 206f 7574 7075  itBase/str outpu
+0001eef0: 745f 756e 6974 3a20 5468 6520 6f75 7470  t_unit: The outp
+0001ef00: 7574 2075 6e69 7420 666f 7220 7468 6973  ut unit for this
+0001ef10: 2053 4153 2072 6567 696f 6e2c 2065 6974   SAS region, eit
+0001ef20: 6865 7220 786d 6d5f 736b 7920 6f72 2078  her xmm_sky or x
+0001ef30: 6d6d 5f64 6574 2e0a 2020 2020 2020 2020  mm_det..        
+0001ef40: 3a72 6574 7572 6e3a 2054 6865 2053 4153  :return: The SAS
+0001ef50: 2073 7472 696e 6720 7265 6769 6f6e 2066   string region f
+0001ef60: 6f72 2074 6869 7320 696e 7465 726c 6f70  or this interlop
+0001ef70: 6572 0a20 2020 2020 2020 203a 7274 7970  er.        :rtyp
+0001ef80: 653a 2073 7472 0a20 2020 2020 2020 2022  e: str.        "
+0001ef90: 2222 0a0a 2020 2020 2020 2020 6966 206f  ""..        if o
+0001efa0: 7574 7075 745f 756e 6974 203d 3d20 786d  utput_unit == xm
+0001efb0: 6d5f 6465 743a 0a20 2020 2020 2020 2020  m_det:.         
+0001efc0: 2020 2063 5f73 7472 203d 2022 4445 5458     c_str = "DETX
+0001efd0: 2c44 4554 5922 0a20 2020 2020 2020 2020  ,DETY".         
+0001efe0: 2020 2072 6169 7365 204e 6f74 496d 706c     raise NotImpl
+0001eff0: 656d 656e 7465 6445 7272 6f72 2822 5468  ementedError("Th
+0001f000: 6973 2063 6f6f 7264 696e 6174 6520 7379  is coordinate sy
+0001f010: 7374 656d 2069 7320 6e6f 7420 7965 7420  stem is not yet 
+0001f020: 7375 7070 6f72 7465 642c 2061 6e64 2069  supported, and i
+0001f030: 736e 2774 2061 2070 7269 6f72 6974 792e  sn't a priority.
+0001f040: 2050 6c65 6173 6520 220a 2020 2020 2020   Please ".      
+0001f050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f070: 2273 7562 6d69 7420 616e 2069 7373 7565  "submit an issue
+0001f080: 206f 6e20 6874 7470 733a 2f2f 6769 7468   on https://gith
+0001f090: 7562 2e63 6f6d 2f44 6176 6964 5433 2f58  ub.com/DavidT3/X
+0001f0a0: 4741 2f69 7373 7565 7320 6966 2079 6f75  GA/issues if you
+0001f0b0: 2070 6172 7469 6375 6c61 726c 7920 220a   particularly ".
+0001f0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f0e0: 2020 2020 2020 2277 616e 7420 7468 6973        "want this
+0001f0f0: 2e22 290a 2020 2020 2020 2020 656c 6966  .").        elif
+0001f100: 206f 7574 7075 745f 756e 6974 203d 3d20   output_unit == 
+0001f110: 786d 6d5f 736b 793a 0a20 2020 2020 2020  xmm_sky:.       
+0001f120: 2020 2020 2063 5f73 7472 203d 2022 582c       c_str = "X,
+0001f130: 5922 0a20 2020 2020 2020 2065 6c73 653a  Y".        else:
+0001f140: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+0001f150: 7365 204e 6f74 496d 706c 656d 656e 7465  se NotImplemente
+0001f160: 6445 7272 6f72 2822 4f6e 6c79 2064 6574  dError("Only det
+0001f170: 6563 746f 7220 616e 6420 736b 7920 636f  ector and sky co
+0001f180: 6f72 6469 6e61 7465 7320 6172 6520 6375  ordinates are cu
+0001f190: 7272 656e 746c 7920 220a 2020 2020 2020  rrently ".      
+0001f1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f1c0: 2273 7570 706f 7274 6564 2066 6f72 2067  "supported for g
+0001f1d0: 656e 6572 6174 696e 6720 5341 5320 7265  enerating SAS re
+0001f1e0: 6769 6f6e 2073 7472 696e 6773 2e22 290a  gion strings.").
+0001f1f0: 0a20 2020 2020 2020 2063 656e 203d 2051  .        cen = Q
+0001f200: 7561 6e74 6974 7928 5b72 6567 2e63 656e  uantity([reg.cen
+0001f210: 7465 722e 7261 2e76 616c 7565 2c20 7265  ter.ra.value, re
+0001f220: 672e 6365 6e74 6572 2e64 6563 2e76 616c  g.center.dec.val
+0001f230: 7565 5d2c 2027 6465 6727 290a 2020 2020  ue], 'deg').    
+0001f240: 2020 2020 736b 795f 746f 5f64 6567 203d      sky_to_deg =
+0001f250: 2073 6b79 5f64 6567 5f73 6361 6c65 2869   sky_deg_scale(i
+0001f260: 6d2c 2063 656e 292e 7661 6c75 650a 2020  m, cen).value.  
+0001f270: 2020 2020 2020 636f 6e76 5f63 656e 203d        conv_cen =
+0001f280: 2069 6d2e 636f 6f72 645f 636f 6e76 2863   im.coord_conv(c
+0001f290: 656e 2c20 6f75 7470 7574 5f75 6e69 7429  en, output_unit)
+0001f2a0: 0a20 2020 2020 2020 2023 2048 6176 6520  .        # Have 
+0001f2b0: 746f 2064 6976 6964 6520 7468 6520 7769  to divide the wi
+0001f2c0: 6474 6820 6279 2074 776f 2c20 4920 6e65  dth by two, I ne
+0001f2d0: 6564 2074 6f20 6b6e 6f77 2074 6865 2068  ed to know the h
+0001f2e0: 616c 662d 7769 6474 6820 666f 7220 5341  alf-width for SA
+0001f2f0: 5320 7265 6769 6f6e 732c 2074 6865 6e20  S regions, then 
+0001f300: 636f 6e76 6572 740a 2020 2020 2020 2020  convert.        
+0001f310: 2320 2066 726f 6d20 6465 6772 6565 7320  #  from degrees 
+0001f320: 746f 2058 4d4d 2073 6b79 2063 6f6f 7264  to XMM sky coord
+0001f330: 696e 6174 6573 2075 7369 6e67 2074 6865  inates using the
+0001f340: 2066 6163 746f 7220 7765 2063 616c 6375   factor we calcu
+0001f350: 6c61 7465 6420 696e 2074 6865 206d 6169  lated in the mai
+0001f360: 6e20 6675 6e63 7469 6f6e 0a20 2020 2020  n function.     
+0001f370: 2020 2077 203d 2028 7265 672e 7769 6474     w = (reg.widt
+0001f380: 682e 746f 2827 6465 6727 292e 7661 6c75  h.to('deg').valu
+0001f390: 6520 2f20 3220 2f20 736b 795f 746f 5f64  e / 2 / sky_to_d
+0001f3a0: 6567 292e 726f 756e 6428 3429 0a20 2020  eg).round(4).   
+0001f3b0: 2020 2020 2023 2057 6520 646f 2074 6865       # We do the
+0001f3c0: 2073 616d 6520 666f 7220 7468 6520 6865   same for the he
+0001f3d0: 6967 6874 0a20 2020 2020 2020 2068 203d  ight.        h =
+0001f3e0: 2028 7265 672e 6865 6967 6874 2e74 6f28   (reg.height.to(
+0001f3f0: 2764 6567 2729 2e76 616c 7565 202f 2032  'deg').value / 2
+0001f400: 202f 2073 6b79 5f74 6f5f 6465 6729 2e72   / sky_to_deg).r
+0001f410: 6f75 6e64 2834 290a 2020 2020 2020 2020  ound(4).        
+0001f420: 6966 2077 203d 3d20 683a 0a20 2020 2020  if w == h:.     
+0001f430: 2020 2020 2020 2073 6861 7065 5f73 7472         shape_str
+0001f440: 203d 2022 2828 7b74 7d29 2049 4e20 6369   = "(({t}) IN ci
+0001f450: 7263 6c65 287b 6378 7d2c 7b63 797d 2c7b  rcle({cx},{cy},{
+0001f460: 727d 2929 220a 2020 2020 2020 2020 2020  r}))".          
+0001f470: 2020 7368 6170 655f 7374 7220 3d20 7368    shape_str = sh
+0001f480: 6170 655f 7374 722e 666f 726d 6174 2874  ape_str.format(t
+0001f490: 3d63 5f73 7472 2c20 6378 3d63 6f6e 765f  =c_str, cx=conv_
+0001f4a0: 6365 6e5b 305d 2e72 6f75 6e64 2834 292e  cen[0].round(4).
+0001f4b0: 7661 6c75 652c 2063 793d 636f 6e76 5f63  value, cy=conv_c
+0001f4c0: 656e 5b31 5d2e 726f 756e 6428 3429 2e76  en[1].round(4).v
+0001f4d0: 616c 7565 2c20 723d 6829 0a20 2020 2020  alue, r=h).     
+0001f4e0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0001f4f0: 2020 2020 2023 2054 6865 2072 6f74 6174       # The rotat
+0001f500: 696f 6e20 616e 676c 6520 6672 6f6d 2074  ion angle from t
+0001f510: 6865 2072 6567 696f 6e20 6f62 6a65 6374  he region object
+0001f520: 2069 7320 696e 2064 6567 7265 6573 2061   is in degrees a
+0001f530: 6c72 6561 6479 0a20 2020 2020 2020 2020  lready.         
+0001f540: 2020 2073 6861 7065 5f73 7472 203d 2022     shape_str = "
+0001f550: 2828 7b74 7d29 2049 4e20 656c 6c69 7073  (({t}) IN ellips
+0001f560: 6528 7b63 787d 2c7b 6379 7d2c 7b77 7d2c  e({cx},{cy},{w},
+0001f570: 7b68 7d2c 7b72 6f74 7d29 2922 2e66 6f72  {h},{rot}))".for
+0001f580: 6d61 7428 743d 635f 7374 722c 2063 783d  mat(t=c_str, cx=
+0001f590: 636f 6e76 5f63 656e 5b30 5d2e 726f 756e  conv_cen[0].roun
+0001f5a0: 6428 3429 2e76 616c 7565 2c0a 2020 2020  d(4).value,.    
 0001f5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f5c0: 2020 2020 2020 2020 2020 6f75 7470 7574            output
-0001f5d0: 5f75 6e69 743a 2055 6e69 6f6e 5b55 6e69  _unit: Union[Uni
-0001f5e0: 7442 6173 652c 2073 7472 5d20 3d20 786d  tBase, str] = xm
-0001f5f0: 6d5f 736b 792c 2072 6f74 5f61 6e67 6c65  m_sky, rot_angle
-0001f600: 3a20 5175 616e 7469 7479 203d 2051 7561  : Quantity = Qua
-0001f610: 6e74 6974 7928 302c 2027 6465 6727 292c  ntity(0, 'deg'),
-0001f620: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001f5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f5f0: 2020 2020 2020 2020 2063 793d 636f 6e76           cy=conv
+0001f600: 5f63 656e 5b31 5d2e 726f 756e 6428 3429  _cen[1].round(4)
+0001f610: 2e76 616c 7565 2c20 773d 772c 2068 3d68  .value, w=w, h=h
+0001f620: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 0001f630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f640: 696e 7465 726c 6f70 6572 5f72 6567 696f  interloper_regio
-0001f650: 6e73 3a20 6e70 2e6e 6461 7272 6179 203d  ns: np.ndarray =
-0001f660: 204e 6f6e 652c 2063 656e 7472 616c 5f63   None, central_c
-0001f670: 6f6f 7264 3a20 5175 616e 7469 7479 203d  oord: Quantity =
-0001f680: 204e 6f6e 6529 202d 3e20 7374 723a 0a20   None) -> str:. 
-0001f690: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0001f6a0: 2020 2041 206d 6574 686f 6420 746f 2067     A method to g
-0001f6b0: 656e 6572 6174 6520 6120 5341 5320 7265  enerate a SAS re
-0001f6c0: 6769 6f6e 2073 7472 696e 6720 666f 7220  gion string for 
-0001f6d0: 616e 2061 7262 6974 7261 7279 2063 6972  an arbitrary cir
-0001f6e0: 6375 6c61 7220 6f72 2065 6c6c 6970 7469  cular or ellipti
-0001f6f0: 6361 6c20 616e 6e75 6c61 7220 7265 6769  cal annular regi
-0001f700: 6f6e 2c20 7769 7468 0a20 2020 2020 2020  on, with.       
-0001f710: 2069 6e74 6572 6c6f 7065 7220 736f 7572   interloper sour
-0001f720: 6365 7320 7265 6d6f 7665 642e 0a0a 2020  ces removed...  
-0001f730: 2020 2020 2020 3a70 6172 616d 2051 7561        :param Qua
-0001f740: 6e74 6974 7920 696e 6e65 725f 7261 6469  ntity inner_radi
-0001f750: 7573 3a20 5468 6520 696e 6e65 7220 7261  us: The inner ra
-0001f760: 6469 7573 2f72 6164 6969 206f 6620 7468  dius/radii of th
-0001f770: 6520 7265 6769 6f6e 2079 6f75 2077 6973  e region you wis
-0001f780: 6820 746f 2067 656e 6572 6174 6520 696e  h to generate in
-0001f790: 2053 4153 2c20 6966 2074 6865 0a20 2020   SAS, if the.   
-0001f7a0: 2020 2020 2020 2020 2071 7561 6e74 6974           quantit
-0001f7b0: 7920 6861 7320 6d75 6c74 6970 6c65 2065  y has multiple e
-0001f7c0: 6c65 6d65 6e74 7320 7468 656e 2061 6e20  lements then an 
-0001f7d0: 656c 6c69 7074 6963 616c 2072 6567 696f  elliptical regio
-0001f7e0: 6e20 7769 6c6c 2062 6520 6765 6e65 7261  n will be genera
-0001f7f0: 7465 642c 2077 6974 6820 7468 6520 6669  ted, with the fi
-0001f800: 7273 7420 656c 656d 656e 740a 2020 2020  rst element.    
-0001f810: 2020 2020 2020 2020 6265 696e 6720 7468          being th
-0001f820: 6520 696e 6e65 7220 7261 6469 7573 206f  e inner radius o
-0001f830: 6e20 7468 6520 7365 6d69 2d6d 616a 6f72  n the semi-major
-0001f840: 2061 7869 732c 2061 6e64 2074 6865 2073   axis, and the s
-0001f850: 6563 6f6e 6420 6f6e 2074 6865 2073 656d  econd on the sem
-0001f860: 692d 6d69 6e6f 7220 6178 6973 2e0a 2020  i-minor axis..  
-0001f870: 2020 2020 2020 3a70 6172 616d 2051 7561        :param Qua
-0001f880: 6e74 6974 7920 6f75 7465 725f 7261 6469  ntity outer_radi
-0001f890: 7573 3a20 5468 6520 696e 6e65 7220 6f75  us: The inner ou
-0001f8a0: 7465 725f 7261 6469 7573 2f72 6164 6969  ter_radius/radii
-0001f8b0: 206f 6620 7468 6520 7265 6769 6f6e 2079   of the region y
-0001f8c0: 6f75 2077 6973 6820 746f 2067 656e 6572  ou wish to gener
-0001f8d0: 6174 6520 696e 2053 4153 2c20 6966 2074  ate in SAS, if t
-0001f8e0: 6865 0a20 2020 2020 2020 2020 2020 2071  he.            q
-0001f8f0: 7561 6e74 6974 7920 6861 7320 6d75 6c74  uantity has mult
-0001f900: 6970 6c65 2065 6c65 6d65 6e74 7320 7468  iple elements th
-0001f910: 656e 2061 6e20 656c 6c69 7074 6963 616c  en an elliptical
-0001f920: 2072 6567 696f 6e20 7769 6c6c 2062 6520   region will be 
-0001f930: 6765 6e65 7261 7465 642c 2077 6974 6820  generated, with 
-0001f940: 7468 6520 6669 7273 7420 656c 656d 656e  the first elemen
-0001f950: 740a 2020 2020 2020 2020 2020 2020 6265  t.            be
-0001f960: 696e 6720 7468 6520 6f75 7465 7220 7261  ing the outer ra
-0001f970: 6469 7573 206f 6e20 7468 6520 7365 6d69  dius on the semi
-0001f980: 2d6d 616a 6f72 2061 7869 732c 2061 6e64  -major axis, and
-0001f990: 2074 6865 2073 6563 6f6e 6420 6f6e 2074   the second on t
-0001f9a0: 6865 2073 656d 692d 6d69 6e6f 7220 6178  he semi-minor ax
-0001f9b0: 6973 2e0a 2020 2020 2020 2020 3a70 6172  is..        :par
-0001f9c0: 616d 2073 7472 206f 6273 5f69 643a 2054  am str obs_id: T
-0001f9d0: 6865 204f 6273 4944 206f 6620 7468 6520  he ObsID of the 
-0001f9e0: 6f62 7365 7276 6174 696f 6e20 796f 7520  observation you 
-0001f9f0: 7769 7368 2074 6f20 6765 6e65 7261 7465  wish to generate
-0001fa00: 2074 6865 2053 4153 2072 6567 696f 6e20   the SAS region 
-0001fa10: 666f 722e 0a20 2020 2020 2020 203a 7061  for..        :pa
-0001fa20: 7261 6d20 7374 7220 696e 7374 3a20 5468  ram str inst: Th
-0001fa30: 6520 696e 7374 7275 6d65 6e74 206f 6620  e instrument of 
-0001fa40: 7468 6520 6f62 7365 7276 6174 696f 6e20  the observation 
-0001fa50: 796f 7520 746f 2067 656e 6572 6174 6520  you to generate 
-0001fa60: 7468 6520 5341 5320 7265 6769 6f6e 2066  the SAS region f
-0001fa70: 6f72 2e0a 2020 2020 2020 2020 3a70 6172  or..        :par
-0001fa80: 616d 2055 6e69 7442 6173 652f 7374 7220  am UnitBase/str 
-0001fa90: 6f75 7470 7574 5f75 6e69 743a 2054 6865  output_unit: The
-0001faa0: 206f 7574 7075 7420 756e 6974 2066 6f72   output unit for
-0001fab0: 2074 6869 7320 5341 5320 7265 6769 6f6e   this SAS region
-0001fac0: 2c20 6569 7468 6572 2078 6d6d 5f73 6b79  , either xmm_sky
-0001fad0: 206f 7220 786d 6d5f 6465 742e 0a20 2020   or xmm_det..   
-0001fae0: 2020 2020 203a 7061 7261 6d20 6e70 2e6e       :param np.n
-0001faf0: 6461 7272 6179 2069 6e74 6572 6c6f 7065  darray interlope
-0001fb00: 725f 7265 6769 6f6e 733a 2054 6865 2069  r_regions: The i
-0001fb10: 6e74 6572 6c6f 7065 7220 7265 6769 6f6e  nterloper region
-0001fb20: 7320 746f 2072 656d 6f76 6520 6672 6f6d  s to remove from
-0001fb30: 2074 6865 2073 6f75 7263 6520 7265 6769   the source regi
-0001fb40: 6f6e 2c0a 2020 2020 2020 2020 2020 2020  on,.            
-0001fb50: 6465 6661 756c 7420 6973 204e 6f6e 652c  default is None,
-0001fb60: 2069 6e20 7768 6963 6820 6361 7365 2074   in which case t
-0001fb70: 6865 2066 756e 6374 696f 6e20 7769 6c6c  he function will
-0001fb80: 2072 756e 2073 656c 662e 7265 6769 6f6e   run self.region
-0001fb90: 735f 7769 7468 696e 5f72 6164 6969 2e0a  s_within_radii..
-0001fba0: 2020 2020 2020 2020 3a70 6172 616d 2051          :param Q
-0001fbb0: 7561 6e74 6974 7920 726f 745f 616e 676c  uantity rot_angl
-0001fbc0: 653a 2054 6865 2072 6f74 6174 696f 6e20  e: The rotation 
-0001fbd0: 616e 676c 6520 6f66 2074 6865 2073 6f75  angle of the sou
-0001fbe0: 7263 6520 7265 6769 6f6e 2c20 6465 6661  rce region, defa
-0001fbf0: 756c 7420 6973 207a 6572 6f20 6465 6772  ult is zero degr
-0001fc00: 6565 732e 0a20 2020 2020 2020 203a 7061  ees..        :pa
-0001fc10: 7261 6d20 5175 616e 7469 7479 2063 656e  ram Quantity cen
-0001fc20: 7472 616c 5f63 6f6f 7264 3a20 5468 6520  tral_coord: The 
-0001fc30: 636f 6f72 6469 6e61 7465 206f 6e20 7768  coordinate on wh
-0001fc40: 6963 6820 746f 2063 656e 7472 6520 7468  ich to centre th
-0001fc50: 6520 736f 7572 6365 2072 6567 696f 6e2c  e source region,
-0001fc60: 2064 6566 6175 6c74 2069 730a 2020 2020   default is.    
-0001fc70: 2020 2020 2020 2020 4e6f 6e65 2069 6e20          None in 
-0001fc80: 7768 6963 6820 6361 7365 2074 6865 2066  which case the f
-0001fc90: 756e 6374 696f 6e20 7769 6c6c 2075 7365  unction will use
-0001fca0: 2074 6865 2064 6566 6175 6c74 5f63 6f6f   the default_coo
-0001fcb0: 7264 206f 6620 7468 6520 736f 7572 6365  rd of the source
-0001fcc0: 206f 626a 6563 742e 0a20 2020 2020 2020   object..       
-0001fcd0: 203a 7265 7475 726e 3a20 4120 7374 7269   :return: A stri
-0001fce0: 6e67 2066 6f72 2075 7365 2069 6e20 6120  ng for use in a 
-0001fcf0: 5341 5320 726f 7574 696e 6520 7468 6174  SAS routine that
-0001fd00: 2064 6573 6372 6962 6573 2074 6865 2073   describes the s
-0001fd10: 6f75 7263 6520 7265 6769 6f6e 2c20 616e  ource region, an
-0001fd20: 6420 7468 6520 7265 6769 6f6e 730a 2020  d the regions.  
-0001fd30: 2020 2020 2020 2020 2020 746f 2063 7574            to cut
-0001fd40: 206f 7574 206f 6620 6974 2e0a 2020 2020   out of it..    
-0001fd50: 2020 2020 3a72 7479 7065 3a20 7374 720a      :rtype: str.
-0001fd60: 2020 2020 2020 2020 2222 220a 0a20 2020          """..   
-0001fd70: 2020 2020 2069 6620 6365 6e74 7261 6c5f       if central_
-0001fd80: 636f 6f72 6420 6973 204e 6f6e 653a 0a20  coord is None:. 
-0001fd90: 2020 2020 2020 2020 2020 2063 656e 7472             centr
-0001fda0: 616c 5f63 6f6f 7264 203d 2073 656c 662e  al_coord = self.
-0001fdb0: 5f64 6566 6175 6c74 5f63 6f6f 7264 0a0a  _default_coord..
-0001fdc0: 2020 2020 2020 2020 2320 5468 6573 6520          # These 
-0001fdd0: 6368 6563 6b73 2f63 6f6e 7665 7273 696f  checks/conversio
-0001fde0: 6e73 2061 7265 2061 6c72 6561 6479 2064  ns are already d
-0001fdf0: 6f6e 6520 6279 2074 6865 2065 7673 656c  one by the evsel
-0001fe00: 6563 745f 7370 6563 7472 756d 2063 6f6d  ect_spectrum com
-0001fe10: 6d61 6e64 2c20 6275 7420 4920 646f 6e27  mand, but I don'
-0001fe20: 740a 2020 2020 2020 2020 2320 206d 696e  t.        #  min
-0001fe30: 6420 646f 696e 6720 7468 656d 2061 6761  d doing them aga
-0001fe40: 696e 0a20 2020 2020 2020 2069 6e6e 6572  in.        inner
-0001fe50: 5f72 6164 6975 7320 3d20 7365 6c66 2e63  _radius = self.c
-0001fe60: 6f6e 7665 7274 5f72 6164 6975 7328 696e  onvert_radius(in
-0001fe70: 6e65 725f 7261 6469 7573 2c20 2764 6567  ner_radius, 'deg
-0001fe80: 2729 0a20 2020 2020 2020 206f 7574 6572  ').        outer
-0001fe90: 5f72 6164 6975 7320 3d20 7365 6c66 2e63  _radius = self.c
-0001fea0: 6f6e 7665 7274 5f72 6164 6975 7328 6f75  onvert_radius(ou
-0001feb0: 7465 725f 7261 6469 7573 2c20 2764 6567  ter_radius, 'deg
-0001fec0: 2729 0a0a 2020 2020 2020 2020 2320 5468  ')..        # Th
-0001fed0: 656e 2077 6520 6361 6e20 6368 6563 6b20  en we can check 
-0001fee0: 746f 206d 616b 6520 7375 7265 2074 6861  to make sure tha
-0001fef0: 7420 7468 6520 6f75 7465 7220 7261 6469  t the outer radi
-0001ff00: 7573 2069 7320 6c61 7267 6572 2074 6861  us is larger tha
-0001ff10: 6e20 7468 6520 696e 6e65 7220 7261 6469  n the inner radi
-0001ff20: 7573 0a20 2020 2020 2020 2069 6620 696e  us.        if in
-0001ff30: 6e65 725f 7261 6469 7573 2e69 7373 6361  ner_radius.issca
-0001ff40: 6c61 7220 616e 6420 696e 6e65 725f 7261  lar and inner_ra
-0001ff50: 6469 7573 203e 3d20 6f75 7465 725f 7261  dius >= outer_ra
-0001ff60: 6469 7573 3a0a 2020 2020 2020 2020 2020  dius:.          
-0001ff70: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
-0001ff80: 6f72 2822 4120 5341 5320 6369 7263 756c  or("A SAS circul
-0001ff90: 6172 2072 6567 696f 6e20 666f 7220 7b73  ar region for {s
-0001ffa0: 7d20 6361 6e6e 6f74 2068 6176 6520 616e  } cannot have an
-0001ffb0: 2069 6e6e 6572 5f72 6164 6975 7320 6c61   inner_radius la
-0001ffc0: 7267 6572 2074 6861 6e20 6f72 2065 7175  rger than or equ
-0001ffd0: 616c 2074 6f20 6974 7320 220a 2020 2020  al to its ".    
-0001ffe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fff0: 2020 2020 2020 2020 2022 6f75 7465 725f           "outer_
-00020000: 7261 6469 7573 222e 666f 726d 6174 2873  radius".format(s
-00020010: 3d73 656c 662e 6e61 6d65 2929 0a20 2020  =self.name)).   
-00020020: 2020 2020 2065 6c69 6620 6e6f 7420 696e       elif not in
-00020030: 6e65 725f 7261 6469 7573 2e69 7373 6361  ner_radius.issca
-00020040: 6c61 7220 616e 6420 2869 6e6e 6572 5f72  lar and (inner_r
-00020050: 6164 6975 735b 305d 203e 3d20 6f75 7465  adius[0] >= oute
-00020060: 725f 7261 6469 7573 5b30 5d20 6f72 2069  r_radius[0] or i
-00020070: 6e6e 6572 5f72 6164 6975 735b 315d 203e  nner_radius[1] >
-00020080: 3d20 6f75 7465 725f 7261 6469 7573 5b31  = outer_radius[1
-00020090: 5d29 3a0a 2020 2020 2020 2020 2020 2020  ]):.            
-000200a0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-000200b0: 2822 4120 5341 5320 656c 6c69 7074 6963  ("A SAS elliptic
-000200c0: 616c 2072 6567 696f 6e20 666f 7220 7b73  al region for {s
-000200d0: 7d20 6361 6e6e 6f74 2068 6176 6520 696e  } cannot have in
-000200e0: 6e65 7220 7261 6469 6920 6c61 7267 6572  ner radii larger
-000200f0: 2074 6861 6e20 6f72 2065 7175 616c 2074   than or equal t
-00020100: 6f20 6974 7320 220a 2020 2020 2020 2020  o its ".        
-00020110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020120: 2020 2020 2022 6f75 7465 7220 7261 6469       "outer radi
-00020130: 6922 2e66 6f72 6d61 7428 733d 7365 6c66  i".format(s=self
-00020140: 2e6e 616d 6529 290a 0a20 2020 2020 2020  .name))..       
-00020150: 2069 6620 6f75 7470 7574 5f75 6e69 7420   if output_unit 
-00020160: 3d3d 2078 6d6d 5f64 6574 3a0a 2020 2020  == xmm_det:.    
-00020170: 2020 2020 2020 2020 635f 7374 7220 3d20          c_str = 
-00020180: 2244 4554 582c 4445 5459 220a 2020 2020  "DETX,DETY".    
-00020190: 2020 2020 2020 2020 7261 6973 6520 4e6f          raise No
-000201a0: 7449 6d70 6c65 6d65 6e74 6564 4572 726f  tImplementedErro
-000201b0: 7228 2254 6869 7320 636f 6f72 6469 6e61  r("This coordina
-000201c0: 7465 2073 7973 7465 6d20 6973 206e 6f74  te system is not
-000201d0: 2079 6574 2073 7570 706f 7274 6564 2c20   yet supported, 
-000201e0: 616e 6420 6973 6e27 7420 6120 7072 696f  and isn't a prio
-000201f0: 7269 7479 2e20 506c 6561 7365 2022 0a20  rity. Please ". 
-00020200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020220: 2020 2020 2022 7375 626d 6974 2061 6e20       "submit an 
-00020230: 6973 7375 6520 6f6e 2068 7474 7073 3a2f  issue on https:/
-00020240: 2f67 6974 6875 622e 636f 6d2f 4461 7669  /github.com/Davi
-00020250: 6454 332f 5847 412f 6973 7375 6573 2069  dT3/XGA/issues i
-00020260: 6620 796f 7520 7061 7274 6963 756c 6172  f you particular
-00020270: 6c79 2022 0a20 2020 2020 2020 2020 2020  ly ".           
-00020280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020290: 2020 2020 2020 2020 2020 2022 7761 6e74             "want
-000202a0: 2074 6869 732e 2229 0a20 2020 2020 2020   this.").       
-000202b0: 2065 6c69 6620 6f75 7470 7574 5f75 6e69   elif output_uni
-000202c0: 7420 3d3d 2078 6d6d 5f73 6b79 3a0a 2020  t == xmm_sky:.  
-000202d0: 2020 2020 2020 2020 2020 635f 7374 7220            c_str 
-000202e0: 3d20 2258 2c59 220a 2020 2020 2020 2020  = "X,Y".        
-000202f0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00020300: 2020 7261 6973 6520 4e6f 7449 6d70 6c65    raise NotImple
-00020310: 6d65 6e74 6564 4572 726f 7228 224f 6e6c  mentedError("Onl
-00020320: 7920 6465 7465 6374 6f72 2061 6e64 2073  y detector and s
-00020330: 6b79 2063 6f6f 7264 696e 6174 6573 2061  ky coordinates a
-00020340: 7265 2063 7572 7265 6e74 6c79 2022 0a20  re currently ". 
-00020350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020370: 2020 2020 2022 7375 7070 6f72 7465 6420       "supported 
-00020380: 666f 7220 6765 6e65 7261 7469 6e67 2053  for generating S
-00020390: 4153 2072 6567 696f 6e20 7374 7269 6e67  AS region string
-000203a0: 732e 2229 0a0a 2020 2020 2020 2020 2320  s.")..        # 
-000203b0: 5765 206e 6565 6420 6120 6d61 7463 6869  We need a matchi
-000203c0: 6e67 2069 6d61 6765 2074 6f20 7065 7266  ng image to perf
-000203d0: 6f72 6d20 7468 6520 636f 6f72 6469 6e61  orm the coordina
-000203e0: 7465 2063 6f6e 7665 7273 696f 6e20 7765  te conversion we
-000203f0: 2072 6571 7569 7265 0a20 2020 2020 2020   require.       
-00020400: 2072 656c 5f69 6d20 3d20 7365 6c66 2e67   rel_im = self.g
-00020410: 6574 5f70 726f 6475 6374 7328 2269 6d61  et_products("ima
-00020420: 6765 222c 206f 6273 5f69 642c 2069 6e73  ge", obs_id, ins
-00020430: 7429 5b30 5d0a 2020 2020 2020 2020 2320  t)[0].        # 
-00020440: 5765 2063 616e 2073 6574 206f 7572 206f  We can set our o
-00020450: 776e 206f 6666 7365 7420 7661 6c75 6520  wn offset value 
-00020460: 7768 656e 2077 6520 6361 6c6c 2074 6869  when we call thi
-00020470: 7320 6675 6e63 7469 6f6e 2c20 6275 7420  s function, but 
-00020480: 4920 646f 6e27 7420 7468 696e 6b20 4920  I don't think I 
-00020490: 6e65 6564 2074 6f0a 2020 2020 2020 2020  need to.        
-000204a0: 736b 795f 746f 5f64 6567 203d 2073 6b79  sky_to_deg = sky
-000204b0: 5f64 6567 5f73 6361 6c65 2872 656c 5f69  _deg_scale(rel_i
-000204c0: 6d2c 2063 656e 7472 616c 5f63 6f6f 7264  m, central_coord
-000204d0: 292e 7661 6c75 650a 0a20 2020 2020 2020  ).value..       
-000204e0: 2023 2057 6520 6e65 6564 206f 7572 2063   # We need our c
-000204f0: 686f 7365 6e20 6365 6e74 7261 6c20 636f  hosen central co
-00020500: 6f72 6469 6e61 7465 7320 696e 2074 6865  ordinates in the
-00020510: 2072 6967 6874 2075 6e69 7473 206f 6620   right units of 
-00020520: 636f 7572 7365 0a20 2020 2020 2020 2078  course.        x
-00020530: 6d6d 5f63 656e 7472 616c 5f63 6f6f 7264  mm_central_coord
-00020540: 203d 2072 656c 5f69 6d2e 636f 6f72 645f   = rel_im.coord_
-00020550: 636f 6e76 2863 656e 7472 616c 5f63 6f6f  conv(central_coo
-00020560: 7264 2c20 6f75 7470 7574 5f75 6e69 7429  rd, output_unit)
-00020570: 0a20 2020 2020 2020 2023 2041 6e64 206a  .        # And j
-00020580: 7573 7420 746f 206d 616b 6520 7375 7265  ust to make sure
-00020590: 2074 6865 2063 656e 7472 616c 2063 6f6f   the central coo
-000205a0: 7264 696e 6174 6573 2061 7265 2069 6e20  rdinates are in 
-000205b0: 6465 6772 6565 730a 2020 2020 2020 2020  degrees.        
-000205c0: 6465 675f 6365 6e74 7261 6c5f 636f 6f72  deg_central_coor
-000205d0: 6420 3d20 7265 6c5f 696d 2e63 6f6f 7264  d = rel_im.coord
-000205e0: 5f63 6f6e 7628 6365 6e74 7261 6c5f 636f  _conv(central_co
-000205f0: 6f72 642c 2064 6567 290a 0a20 2020 2020  ord, deg)..     
-00020600: 2020 2023 2049 6620 7468 6520 7573 6572     # If the user
-00020610: 2064 6f65 736e 2774 2070 6173 7320 616e   doesn't pass an
-00020620: 7920 7265 6769 6f6e 732c 2074 6865 6e20  y regions, then 
-00020630: 7765 2068 6176 6520 746f 2066 696e 6420  we have to find 
-00020640: 7468 656d 206f 7572 7365 6c76 6573 2e20  them ourselves. 
-00020650: 4920 6465 6369 6465 6420 746f 2061 6c6c  I decided to all
-00020660: 6f77 2074 6869 730a 2020 2020 2020 2020  ow this.        
-00020670: 2320 2073 6f20 7468 6174 2077 6974 6869  #  so that withi
-00020680: 6e5f 7261 6469 6920 6361 6e20 6a75 7374  n_radii can just
-00020690: 2062 6520 6361 6c6c 6564 206f 6e63 6520   be called once 
-000206a0: 6578 7465 726e 616c 6c79 2066 6f72 2061  externally for a
-000206b0: 2073 6574 206f 6620 4f62 7349 442d 696e   set of ObsID-in
-000206c0: 7374 7275 6d65 6e74 2063 6f6d 6269 6e61  strument combina
-000206d0: 7469 6f6e 732c 0a20 2020 2020 2020 2023  tions,.        #
-000206e0: 2020 6c69 6b65 2069 6e20 6576 7365 6c65    like in evsele
-000206f0: 6374 5f73 7065 6374 7275 6d20 666f 7220  ct_spectrum for 
-00020700: 696e 7374 616e 6365 2e0a 2020 2020 2020  instance..      
-00020710: 2020 6966 2069 6e74 6572 6c6f 7065 725f    if interloper_
-00020720: 7265 6769 6f6e 7320 6973 204e 6f6e 6520  regions is None 
-00020730: 616e 6420 696e 6e65 725f 7261 6469 7573  and inner_radius
-00020740: 2e69 7373 6361 6c61 723a 0a20 2020 2020  .isscalar:.     
-00020750: 2020 2020 2020 2069 6e74 6572 6c6f 7065         interlope
-00020760: 725f 7265 6769 6f6e 7320 3d20 7365 6c66  r_regions = self
-00020770: 2e72 6567 696f 6e73 5f77 6974 6869 6e5f  .regions_within_
-00020780: 7261 6469 6928 696e 6e65 725f 7261 6469  radii(inner_radi
-00020790: 7573 2c20 6f75 7465 725f 7261 6469 7573  us, outer_radius
-000207a0: 2c20 6465 675f 6365 6e74 7261 6c5f 636f  , deg_central_co
-000207b0: 6f72 6429 0a20 2020 2020 2020 2065 6c69  ord).        eli
-000207c0: 6620 696e 7465 726c 6f70 6572 5f72 6567  f interloper_reg
-000207d0: 696f 6e73 2069 7320 4e6f 6e65 2061 6e64  ions is None and
-000207e0: 206e 6f74 2069 6e6e 6572 5f72 6164 6975   not inner_radiu
-000207f0: 732e 6973 7363 616c 6172 3a0a 2020 2020  s.isscalar:.    
-00020800: 2020 2020 2020 2020 696e 7465 726c 6f70          interlop
-00020810: 6572 5f72 6567 696f 6e73 203d 2073 656c  er_regions = sel
-00020820: 662e 7265 6769 6f6e 735f 7769 7468 696e  f.regions_within
-00020830: 5f72 6164 6969 286d 696e 2869 6e6e 6572  _radii(min(inner
-00020840: 5f72 6164 6975 7329 2c20 6d61 7828 6f75  _radius), max(ou
-00020850: 7465 725f 7261 6469 7573 292c 2064 6567  ter_radius), deg
-00020860: 5f63 656e 7472 616c 5f63 6f6f 7264 290a  _central_coord).
-00020870: 0a20 2020 2020 2020 2023 2053 6f20 6e6f  .        # So no
-00020880: 7720 7765 2063 6f6e 7665 7274 206f 7572  w we convert our
-00020890: 2069 6e74 6572 6c6f 7065 7220 7265 6769   interloper regi
-000208a0: 6f6e 7320 696e 746f 2074 6865 6972 2053  ons into their S
-000208b0: 4153 2065 7175 6976 616c 656e 7473 0a20  AS equivalents. 
-000208c0: 2020 2020 2020 2073 6173 5f69 6e74 6572         sas_inter
-000208d0: 6c6f 7065 7220 3d20 5b73 656c 662e 5f69  loper = [self._i
-000208e0: 6e74 6572 6c6f 7065 725f 7361 735f 7374  nterloper_sas_st
-000208f0: 7269 6e67 2869 2c20 7265 6c5f 696d 2c20  ring(i, rel_im, 
-00020900: 6f75 7470 7574 5f75 6e69 7429 2066 6f72  output_unit) for
-00020910: 2069 2069 6e20 696e 7465 726c 6f70 6572   i in interloper
-00020920: 5f72 6567 696f 6e73 5d0a 0a20 2020 2020  _regions]..     
-00020930: 2020 2069 6620 696e 6e65 725f 7261 6469     if inner_radi
-00020940: 7573 2e69 7373 6361 6c61 7220 616e 6420  us.isscalar and 
-00020950: 696e 6e65 725f 7261 6469 7573 2e76 616c  inner_radius.val
-00020960: 7565 2021 3d20 303a 0a20 2020 2020 2020  ue != 0:.       
-00020970: 2020 2020 2023 2041 6e64 2077 6520 6e65       # And we ne
-00020980: 6564 2074 6f20 6465 6669 6e65 2061 2053  ed to define a S
-00020990: 4153 2073 7472 696e 6720 666f 7220 7468  AS string for th
-000209a0: 6520 6163 7475 616c 2072 6567 696f 6e20  e actual region 
-000209b0: 6f66 2069 6e74 6572 6573 740a 2020 2020  of interest.    
-000209c0: 2020 2020 2020 2020 7361 735f 736f 7572          sas_sour
-000209d0: 6365 5f61 7265 6120 3d20 2228 287b 747d  ce_area = "(({t}
-000209e0: 2920 494e 2061 6e6e 756c 7573 287b 6378  ) IN annulus({cx
-000209f0: 7d2c 7b63 797d 2c7b 7269 7d2c 7b72 6f7d  },{cy},{ri},{ro}
-00020a00: 2929 220a 2020 2020 2020 2020 2020 2020  ))".            
-00020a10: 7361 735f 736f 7572 6365 5f61 7265 6120  sas_source_area 
-00020a20: 3d20 7361 735f 736f 7572 6365 5f61 7265  = sas_source_are
-00020a30: 612e 666f 726d 6174 2874 3d63 5f73 7472  a.format(t=c_str
-00020a40: 2c20 6378 3d78 6d6d 5f63 656e 7472 616c  , cx=xmm_central
-00020a50: 5f63 6f6f 7264 5b30 5d2e 726f 756e 6428  _coord[0].round(
-00020a60: 3429 2e76 616c 7565 2c0a 2020 2020 2020  4).value,.      
-00020a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020a90: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00020aa0: 793d 786d 6d5f 6365 6e74 7261 6c5f 636f  y=xmm_central_co
-00020ab0: 6f72 645b 315d 2e72 6f75 6e64 2834 292e  ord[1].round(4).
-00020ac0: 7661 6c75 652c 0a20 2020 2020 2020 2020  value,.         
-00020ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020af0: 2020 2020 2020 2020 2020 2020 7269 3d28              ri=(
-00020b00: 696e 6e65 725f 7261 6469 7573 2e76 616c  inner_radius.val
-00020b10: 7565 2f73 6b79 5f74 6f5f 6465 6729 2e72  ue/sky_to_deg).r
-00020b20: 6f75 6e64 2834 292c 0a20 2020 2020 2020  ound(4),.       
-00020b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020b50: 2020 2020 2020 2020 2020 2020 2020 726f                ro
-00020b60: 3d28 6f75 7465 725f 7261 6469 7573 2e76  =(outer_radius.v
-00020b70: 616c 7565 2f73 6b79 5f74 6f5f 6465 6729  alue/sky_to_deg)
-00020b80: 2e72 6f75 6e64 2834 2929 0a20 2020 2020  .round(4)).     
-00020b90: 2020 2023 2049 6620 7468 6520 696e 6e65     # If the inne
-00020ba0: 7220 7261 6469 7573 2069 7320 7a65 726f  r radius is zero
-00020bb0: 2074 6865 6e20 7765 2077 7269 7465 2061   then we write a
-00020bc0: 2063 6972 636c 6520 7265 6769 6f6e 2c20   circle region, 
-00020bd0: 6265 6361 7573 6520 6974 2073 6565 6d73  because it seems
-00020be0: 2074 6861 7427 7320 6120 4c4f 5420 6661   that's a LOT fa
-00020bf0: 7374 6572 2069 6e20 5341 530a 2020 2020  ster in SAS.    
-00020c00: 2020 2020 656c 6966 2069 6e6e 6572 5f72      elif inner_r
-00020c10: 6164 6975 732e 6973 7363 616c 6172 2061  adius.isscalar a
-00020c20: 6e64 2069 6e6e 6572 5f72 6164 6975 732e  nd inner_radius.
-00020c30: 7661 6c75 6520 3d3d 2030 3a0a 2020 2020  value == 0:.    
-00020c40: 2020 2020 2020 2020 7361 735f 736f 7572          sas_sour
-00020c50: 6365 5f61 7265 6120 3d20 2228 287b 747d  ce_area = "(({t}
-00020c60: 2920 494e 2063 6972 636c 6528 7b63 787d  ) IN circle({cx}
-00020c70: 2c7b 6379 7d2c 7b72 7d29 2922 0a20 2020  ,{cy},{r}))".   
-00020c80: 2020 2020 2020 2020 2073 6173 5f73 6f75           sas_sou
-00020c90: 7263 655f 6172 6561 203d 2073 6173 5f73  rce_area = sas_s
-00020ca0: 6f75 7263 655f 6172 6561 2e66 6f72 6d61  ource_area.forma
-00020cb0: 7428 743d 635f 7374 722c 2063 783d 786d  t(t=c_str, cx=xm
-00020cc0: 6d5f 6365 6e74 7261 6c5f 636f 6f72 645b  m_central_coord[
-00020cd0: 305d 2e72 6f75 6e64 2834 292e 7661 6c75  0].round(4).valu
-00020ce0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00020cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020d10: 2020 2020 2020 2020 6379 3d78 6d6d 5f63          cy=xmm_c
-00020d20: 656e 7472 616c 5f63 6f6f 7264 5b31 5d2e  entral_coord[1].
-00020d30: 726f 756e 6428 3429 2e76 616c 7565 2c0a  round(4).value,.
-00020d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020d70: 2020 2020 2072 3d28 6f75 7465 725f 7261       r=(outer_ra
-00020d80: 6469 7573 2e76 616c 7565 2f73 6b79 5f74  dius.value/sky_t
-00020d90: 6f5f 6465 6729 2e72 6f75 6e64 2834 2929  o_deg).round(4))
-00020da0: 0a20 2020 2020 2020 2065 6c69 6620 6e6f  .        elif no
-00020db0: 7420 696e 6e65 725f 7261 6469 7573 2e69  t inner_radius.i
-00020dc0: 7373 6361 6c61 7220 616e 6420 696e 6e65  sscalar and inne
-00020dd0: 725f 7261 6469 7573 5b30 5d2e 7661 6c75  r_radius[0].valu
-00020de0: 6520 213d 2030 3a0a 2020 2020 2020 2020  e != 0:.        
-00020df0: 2020 2020 7361 735f 736f 7572 6365 5f61      sas_source_a
-00020e00: 7265 6120 3d20 2228 287b 747d 2920 494e  rea = "(({t}) IN
-00020e10: 2065 6c6c 6970 7461 6e6e 756c 7573 287b   elliptannulus({
-00020e20: 6378 7d2c 7b63 797d 2c7b 7769 7d2c 7b68  cx},{cy},{wi},{h
-00020e30: 697d 2c7b 776f 7d2c 7b68 6f7d 2c7b 726f  i},{wo},{ho},{ro
-00020e40: 747d 2c7b 726f 747d 2929 220a 2020 2020  t},{rot}))".    
-00020e50: 2020 2020 2020 2020 7361 735f 736f 7572          sas_sour
-00020e60: 6365 5f61 7265 6120 3d20 7361 735f 736f  ce_area = sas_so
-00020e70: 7572 6365 5f61 7265 612e 666f 726d 6174  urce_area.format
-00020e80: 2874 3d63 5f73 7472 2c20 6378 3d78 6d6d  (t=c_str, cx=xmm
-00020e90: 5f63 656e 7472 616c 5f63 6f6f 7264 5b30  _central_coord[0
-00020ea0: 5d2e 726f 756e 6428 3429 2e76 616c 7565  ].round(4).value
-00020eb0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001f640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f660: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0001f670: 6f74 3d72 6567 2e61 6e67 6c65 2e72 6f75  ot=reg.angle.rou
+0001f680: 6e64 2834 292e 7661 6c75 6529 0a20 2020  nd(4).value).   
+0001f690: 2020 2020 2072 6574 7572 6e20 7368 6170       return shap
+0001f6a0: 655f 7374 720a 0a20 2020 2064 6566 2067  e_str..    def g
+0001f6b0: 6574 5f61 6e6e 756c 6172 5f73 6173 5f72  et_annular_sas_r
+0001f6c0: 6567 696f 6e28 7365 6c66 2c20 696e 6e65  egion(self, inne
+0001f6d0: 725f 7261 6469 7573 3a20 5175 616e 7469  r_radius: Quanti
+0001f6e0: 7479 2c20 6f75 7465 725f 7261 6469 7573  ty, outer_radius
+0001f6f0: 3a20 5175 616e 7469 7479 2c20 6f62 735f  : Quantity, obs_
+0001f700: 6964 3a20 7374 722c 2069 6e73 743a 2073  id: str, inst: s
+0001f710: 7472 2c0a 2020 2020 2020 2020 2020 2020  tr,.            
+0001f720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f730: 2020 206f 7574 7075 745f 756e 6974 3a20     output_unit: 
+0001f740: 556e 696f 6e5b 556e 6974 4261 7365 2c20  Union[UnitBase, 
+0001f750: 7374 725d 203d 2078 6d6d 5f73 6b79 2c20  str] = xmm_sky, 
+0001f760: 726f 745f 616e 676c 653a 2051 7561 6e74  rot_angle: Quant
+0001f770: 6974 7920 3d20 5175 616e 7469 7479 2830  ity = Quantity(0
+0001f780: 2c20 2764 6567 2729 2c0a 2020 2020 2020  , 'deg'),.      
+0001f790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f7a0: 2020 2020 2020 2020 2069 6e74 6572 6c6f           interlo
+0001f7b0: 7065 725f 7265 6769 6f6e 733a 206e 702e  per_regions: np.
+0001f7c0: 6e64 6172 7261 7920 3d20 4e6f 6e65 2c20  ndarray = None, 
+0001f7d0: 6365 6e74 7261 6c5f 636f 6f72 643a 2051  central_coord: Q
+0001f7e0: 7561 6e74 6974 7920 3d20 4e6f 6e65 2920  uantity = None) 
+0001f7f0: 2d3e 2073 7472 3a0a 2020 2020 2020 2020  -> str:.        
+0001f800: 2222 220a 2020 2020 2020 2020 4120 6d65  """.        A me
+0001f810: 7468 6f64 2074 6f20 6765 6e65 7261 7465  thod to generate
+0001f820: 2061 2053 4153 2072 6567 696f 6e20 7374   a SAS region st
+0001f830: 7269 6e67 2066 6f72 2061 6e20 6172 6269  ring for an arbi
+0001f840: 7472 6172 7920 6369 7263 756c 6172 206f  trary circular o
+0001f850: 7220 656c 6c69 7074 6963 616c 2061 6e6e  r elliptical ann
+0001f860: 756c 6172 2072 6567 696f 6e2c 2077 6974  ular region, wit
+0001f870: 680a 2020 2020 2020 2020 696e 7465 726c  h.        interl
+0001f880: 6f70 6572 2073 6f75 7263 6573 2072 656d  oper sources rem
+0001f890: 6f76 6564 2e0a 0a20 2020 2020 2020 203a  oved...        :
+0001f8a0: 7061 7261 6d20 5175 616e 7469 7479 2069  param Quantity i
+0001f8b0: 6e6e 6572 5f72 6164 6975 733a 2054 6865  nner_radius: The
+0001f8c0: 2069 6e6e 6572 2072 6164 6975 732f 7261   inner radius/ra
+0001f8d0: 6469 6920 6f66 2074 6865 2072 6567 696f  dii of the regio
+0001f8e0: 6e20 796f 7520 7769 7368 2074 6f20 6765  n you wish to ge
+0001f8f0: 6e65 7261 7465 2069 6e20 5341 532c 2069  nerate in SAS, i
+0001f900: 6620 7468 650a 2020 2020 2020 2020 2020  f the.          
+0001f910: 2020 7175 616e 7469 7479 2068 6173 206d    quantity has m
+0001f920: 756c 7469 706c 6520 656c 656d 656e 7473  ultiple elements
+0001f930: 2074 6865 6e20 616e 2065 6c6c 6970 7469   then an ellipti
+0001f940: 6361 6c20 7265 6769 6f6e 2077 696c 6c20  cal region will 
+0001f950: 6265 2067 656e 6572 6174 6564 2c20 7769  be generated, wi
+0001f960: 7468 2074 6865 2066 6972 7374 2065 6c65  th the first ele
+0001f970: 6d65 6e74 0a20 2020 2020 2020 2020 2020  ment.           
+0001f980: 2062 6569 6e67 2074 6865 2069 6e6e 6572   being the inner
+0001f990: 2072 6164 6975 7320 6f6e 2074 6865 2073   radius on the s
+0001f9a0: 656d 692d 6d61 6a6f 7220 6178 6973 2c20  emi-major axis, 
+0001f9b0: 616e 6420 7468 6520 7365 636f 6e64 206f  and the second o
+0001f9c0: 6e20 7468 6520 7365 6d69 2d6d 696e 6f72  n the semi-minor
+0001f9d0: 2061 7869 732e 0a20 2020 2020 2020 203a   axis..        :
+0001f9e0: 7061 7261 6d20 5175 616e 7469 7479 206f  param Quantity o
+0001f9f0: 7574 6572 5f72 6164 6975 733a 2054 6865  uter_radius: The
+0001fa00: 2069 6e6e 6572 206f 7574 6572 5f72 6164   inner outer_rad
+0001fa10: 6975 732f 7261 6469 6920 6f66 2074 6865  ius/radii of the
+0001fa20: 2072 6567 696f 6e20 796f 7520 7769 7368   region you wish
+0001fa30: 2074 6f20 6765 6e65 7261 7465 2069 6e20   to generate in 
+0001fa40: 5341 532c 2069 6620 7468 650a 2020 2020  SAS, if the.    
+0001fa50: 2020 2020 2020 2020 7175 616e 7469 7479          quantity
+0001fa60: 2068 6173 206d 756c 7469 706c 6520 656c   has multiple el
+0001fa70: 656d 656e 7473 2074 6865 6e20 616e 2065  ements then an e
+0001fa80: 6c6c 6970 7469 6361 6c20 7265 6769 6f6e  lliptical region
+0001fa90: 2077 696c 6c20 6265 2067 656e 6572 6174   will be generat
+0001faa0: 6564 2c20 7769 7468 2074 6865 2066 6972  ed, with the fir
+0001fab0: 7374 2065 6c65 6d65 6e74 0a20 2020 2020  st element.     
+0001fac0: 2020 2020 2020 2062 6569 6e67 2074 6865         being the
+0001fad0: 206f 7574 6572 2072 6164 6975 7320 6f6e   outer radius on
+0001fae0: 2074 6865 2073 656d 692d 6d61 6a6f 7220   the semi-major 
+0001faf0: 6178 6973 2c20 616e 6420 7468 6520 7365  axis, and the se
+0001fb00: 636f 6e64 206f 6e20 7468 6520 7365 6d69  cond on the semi
+0001fb10: 2d6d 696e 6f72 2061 7869 732e 0a20 2020  -minor axis..   
+0001fb20: 2020 2020 203a 7061 7261 6d20 7374 7220       :param str 
+0001fb30: 6f62 735f 6964 3a20 5468 6520 4f62 7349  obs_id: The ObsI
+0001fb40: 4420 6f66 2074 6865 206f 6273 6572 7661  D of the observa
+0001fb50: 7469 6f6e 2079 6f75 2077 6973 6820 746f  tion you wish to
+0001fb60: 2067 656e 6572 6174 6520 7468 6520 5341   generate the SA
+0001fb70: 5320 7265 6769 6f6e 2066 6f72 2e0a 2020  S region for..  
+0001fb80: 2020 2020 2020 3a70 6172 616d 2073 7472        :param str
+0001fb90: 2069 6e73 743a 2054 6865 2069 6e73 7472   inst: The instr
+0001fba0: 756d 656e 7420 6f66 2074 6865 206f 6273  ument of the obs
+0001fbb0: 6572 7661 7469 6f6e 2079 6f75 2074 6f20  ervation you to 
+0001fbc0: 6765 6e65 7261 7465 2074 6865 2053 4153  generate the SAS
+0001fbd0: 2072 6567 696f 6e20 666f 722e 0a20 2020   region for..   
+0001fbe0: 2020 2020 203a 7061 7261 6d20 556e 6974       :param Unit
+0001fbf0: 4261 7365 2f73 7472 206f 7574 7075 745f  Base/str output_
+0001fc00: 756e 6974 3a20 5468 6520 6f75 7470 7574  unit: The output
+0001fc10: 2075 6e69 7420 666f 7220 7468 6973 2053   unit for this S
+0001fc20: 4153 2072 6567 696f 6e2c 2065 6974 6865  AS region, eithe
+0001fc30: 7220 786d 6d5f 736b 7920 6f72 2078 6d6d  r xmm_sky or xmm
+0001fc40: 5f64 6574 2e0a 2020 2020 2020 2020 3a70  _det..        :p
+0001fc50: 6172 616d 206e 702e 6e64 6172 7261 7920  aram np.ndarray 
+0001fc60: 696e 7465 726c 6f70 6572 5f72 6567 696f  interloper_regio
+0001fc70: 6e73 3a20 5468 6520 696e 7465 726c 6f70  ns: The interlop
+0001fc80: 6572 2072 6567 696f 6e73 2074 6f20 7265  er regions to re
+0001fc90: 6d6f 7665 2066 726f 6d20 7468 6520 736f  move from the so
+0001fca0: 7572 6365 2072 6567 696f 6e2c 0a20 2020  urce region,.   
+0001fcb0: 2020 2020 2020 2020 2064 6566 6175 6c74           default
+0001fcc0: 2069 7320 4e6f 6e65 2c20 696e 2077 6869   is None, in whi
+0001fcd0: 6368 2063 6173 6520 7468 6520 6675 6e63  ch case the func
+0001fce0: 7469 6f6e 2077 696c 6c20 7275 6e20 7365  tion will run se
+0001fcf0: 6c66 2e72 6567 696f 6e73 5f77 6974 6869  lf.regions_withi
+0001fd00: 6e5f 7261 6469 692e 0a20 2020 2020 2020  n_radii..       
+0001fd10: 203a 7061 7261 6d20 5175 616e 7469 7479   :param Quantity
+0001fd20: 2072 6f74 5f61 6e67 6c65 3a20 5468 6520   rot_angle: The 
+0001fd30: 726f 7461 7469 6f6e 2061 6e67 6c65 206f  rotation angle o
+0001fd40: 6620 7468 6520 736f 7572 6365 2072 6567  f the source reg
+0001fd50: 696f 6e2c 2064 6566 6175 6c74 2069 7320  ion, default is 
+0001fd60: 7a65 726f 2064 6567 7265 6573 2e0a 2020  zero degrees..  
+0001fd70: 2020 2020 2020 3a70 6172 616d 2051 7561        :param Qua
+0001fd80: 6e74 6974 7920 6365 6e74 7261 6c5f 636f  ntity central_co
+0001fd90: 6f72 643a 2054 6865 2063 6f6f 7264 696e  ord: The coordin
+0001fda0: 6174 6520 6f6e 2077 6869 6368 2074 6f20  ate on which to 
+0001fdb0: 6365 6e74 7265 2074 6865 2073 6f75 7263  centre the sourc
+0001fdc0: 6520 7265 6769 6f6e 2c20 6465 6661 756c  e region, defaul
+0001fdd0: 7420 6973 0a20 2020 2020 2020 2020 2020  t is.           
+0001fde0: 204e 6f6e 6520 696e 2077 6869 6368 2063   None in which c
+0001fdf0: 6173 6520 7468 6520 6675 6e63 7469 6f6e  ase the function
+0001fe00: 2077 696c 6c20 7573 6520 7468 6520 6465   will use the de
+0001fe10: 6661 756c 745f 636f 6f72 6420 6f66 2074  fault_coord of t
+0001fe20: 6865 2073 6f75 7263 6520 6f62 6a65 6374  he source object
+0001fe30: 2e0a 2020 2020 2020 2020 3a72 6574 7572  ..        :retur
+0001fe40: 6e3a 2041 2073 7472 696e 6720 666f 7220  n: A string for 
+0001fe50: 7573 6520 696e 2061 2053 4153 2072 6f75  use in a SAS rou
+0001fe60: 7469 6e65 2074 6861 7420 6465 7363 7269  tine that descri
+0001fe70: 6265 7320 7468 6520 736f 7572 6365 2072  bes the source r
+0001fe80: 6567 696f 6e2c 2061 6e64 2074 6865 2072  egion, and the r
+0001fe90: 6567 696f 6e73 0a20 2020 2020 2020 2020  egions.         
+0001fea0: 2020 2074 6f20 6375 7420 6f75 7420 6f66     to cut out of
+0001feb0: 2069 742e 0a20 2020 2020 2020 203a 7274   it..        :rt
+0001fec0: 7970 653a 2073 7472 0a20 2020 2020 2020  ype: str.       
+0001fed0: 2022 2222 0a0a 2020 2020 2020 2020 6966   """..        if
+0001fee0: 2063 656e 7472 616c 5f63 6f6f 7264 2069   central_coord i
+0001fef0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0001ff00: 2020 2020 6365 6e74 7261 6c5f 636f 6f72      central_coor
+0001ff10: 6420 3d20 7365 6c66 2e5f 6465 6661 756c  d = self._defaul
+0001ff20: 745f 636f 6f72 640a 0a20 2020 2020 2020  t_coord..       
+0001ff30: 2023 2054 6865 7365 2063 6865 636b 732f   # These checks/
+0001ff40: 636f 6e76 6572 7369 6f6e 7320 6172 6520  conversions are 
+0001ff50: 616c 7265 6164 7920 646f 6e65 2062 7920  already done by 
+0001ff60: 7468 6520 6576 7365 6c65 6374 5f73 7065  the evselect_spe
+0001ff70: 6374 7275 6d20 636f 6d6d 616e 642c 2062  ctrum command, b
+0001ff80: 7574 2049 2064 6f6e 2774 0a20 2020 2020  ut I don't.     
+0001ff90: 2020 2023 2020 6d69 6e64 2064 6f69 6e67     #  mind doing
+0001ffa0: 2074 6865 6d20 6167 6169 6e0a 2020 2020   them again.    
+0001ffb0: 2020 2020 696e 6e65 725f 7261 6469 7573      inner_radius
+0001ffc0: 203d 2073 656c 662e 636f 6e76 6572 745f   = self.convert_
+0001ffd0: 7261 6469 7573 2869 6e6e 6572 5f72 6164  radius(inner_rad
+0001ffe0: 6975 732c 2027 6465 6727 290a 2020 2020  ius, 'deg').    
+0001fff0: 2020 2020 6f75 7465 725f 7261 6469 7573      outer_radius
+00020000: 203d 2073 656c 662e 636f 6e76 6572 745f   = self.convert_
+00020010: 7261 6469 7573 286f 7574 6572 5f72 6164  radius(outer_rad
+00020020: 6975 732c 2027 6465 6727 290a 0a20 2020  ius, 'deg')..   
+00020030: 2020 2020 2023 2054 6865 6e20 7765 2063       # Then we c
+00020040: 616e 2063 6865 636b 2074 6f20 6d61 6b65  an check to make
+00020050: 2073 7572 6520 7468 6174 2074 6865 206f   sure that the o
+00020060: 7574 6572 2072 6164 6975 7320 6973 206c  uter radius is l
+00020070: 6172 6765 7220 7468 616e 2074 6865 2069  arger than the i
+00020080: 6e6e 6572 2072 6164 6975 730a 2020 2020  nner radius.    
+00020090: 2020 2020 6966 2069 6e6e 6572 5f72 6164      if inner_rad
+000200a0: 6975 732e 6973 7363 616c 6172 2061 6e64  ius.isscalar and
+000200b0: 2069 6e6e 6572 5f72 6164 6975 7320 3e3d   inner_radius >=
+000200c0: 206f 7574 6572 5f72 6164 6975 733a 0a20   outer_radius:. 
+000200d0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+000200e0: 2056 616c 7565 4572 726f 7228 2241 2053   ValueError("A S
+000200f0: 4153 2063 6972 6375 6c61 7220 7265 6769  AS circular regi
+00020100: 6f6e 2066 6f72 207b 737d 2063 616e 6e6f  on for {s} canno
+00020110: 7420 6861 7665 2061 6e20 696e 6e65 725f  t have an inner_
+00020120: 7261 6469 7573 206c 6172 6765 7220 7468  radius larger th
+00020130: 616e 206f 7220 6571 7561 6c20 746f 2069  an or equal to i
+00020140: 7473 2022 0a20 2020 2020 2020 2020 2020  ts ".           
+00020150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020160: 2020 226f 7574 6572 5f72 6164 6975 7322    "outer_radius"
+00020170: 2e66 6f72 6d61 7428 733d 7365 6c66 2e6e  .format(s=self.n
+00020180: 616d 6529 290a 2020 2020 2020 2020 656c  ame)).        el
+00020190: 6966 206e 6f74 2069 6e6e 6572 5f72 6164  if not inner_rad
+000201a0: 6975 732e 6973 7363 616c 6172 2061 6e64  ius.isscalar and
+000201b0: 2028 696e 6e65 725f 7261 6469 7573 5b30   (inner_radius[0
+000201c0: 5d20 3e3d 206f 7574 6572 5f72 6164 6975  ] >= outer_radiu
+000201d0: 735b 305d 206f 7220 696e 6e65 725f 7261  s[0] or inner_ra
+000201e0: 6469 7573 5b31 5d20 3e3d 206f 7574 6572  dius[1] >= outer
+000201f0: 5f72 6164 6975 735b 315d 293a 0a20 2020  _radius[1]):.   
+00020200: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
+00020210: 616c 7565 4572 726f 7228 2241 2053 4153  alueError("A SAS
+00020220: 2065 6c6c 6970 7469 6361 6c20 7265 6769   elliptical regi
+00020230: 6f6e 2066 6f72 207b 737d 2063 616e 6e6f  on for {s} canno
+00020240: 7420 6861 7665 2069 6e6e 6572 2072 6164  t have inner rad
+00020250: 6969 206c 6172 6765 7220 7468 616e 206f  ii larger than o
+00020260: 7220 6571 7561 6c20 746f 2069 7473 2022  r equal to its "
+00020270: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020280: 2020 2020 2020 2020 2020 2020 2020 226f                "o
+00020290: 7574 6572 2072 6164 6969 222e 666f 726d  uter radii".form
+000202a0: 6174 2873 3d73 656c 662e 6e61 6d65 2929  at(s=self.name))
+000202b0: 0a0a 2020 2020 2020 2020 6966 206f 7574  ..        if out
+000202c0: 7075 745f 756e 6974 203d 3d20 786d 6d5f  put_unit == xmm_
+000202d0: 6465 743a 0a20 2020 2020 2020 2020 2020  det:.           
+000202e0: 2063 5f73 7472 203d 2022 4445 5458 2c44   c_str = "DETX,D
+000202f0: 4554 5922 0a20 2020 2020 2020 2020 2020  ETY".           
+00020300: 2072 6169 7365 204e 6f74 496d 706c 656d   raise NotImplem
+00020310: 656e 7465 6445 7272 6f72 2822 5468 6973  entedError("This
+00020320: 2063 6f6f 7264 696e 6174 6520 7379 7374   coordinate syst
+00020330: 656d 2069 7320 6e6f 7420 7965 7420 7375  em is not yet su
+00020340: 7070 6f72 7465 642c 2061 6e64 2069 736e  pported, and isn
+00020350: 2774 2061 2070 7269 6f72 6974 792e 2050  't a priority. P
+00020360: 6c65 6173 6520 220a 2020 2020 2020 2020  lease ".        
+00020370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020380: 2020 2020 2020 2020 2020 2020 2020 2273                "s
+00020390: 7562 6d69 7420 616e 2069 7373 7565 206f  ubmit an issue o
+000203a0: 6e20 6874 7470 733a 2f2f 6769 7468 7562  n https://github
+000203b0: 2e63 6f6d 2f44 6176 6964 5433 2f58 4741  .com/DavidT3/XGA
+000203c0: 2f69 7373 7565 7320 6966 2079 6f75 2070  /issues if you p
+000203d0: 6172 7469 6375 6c61 726c 7920 220a 2020  articularly ".  
+000203e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000203f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020400: 2020 2020 2277 616e 7420 7468 6973 2e22      "want this."
+00020410: 290a 2020 2020 2020 2020 656c 6966 206f  ).        elif o
+00020420: 7574 7075 745f 756e 6974 203d 3d20 786d  utput_unit == xm
+00020430: 6d5f 736b 793a 0a20 2020 2020 2020 2020  m_sky:.         
+00020440: 2020 2063 5f73 7472 203d 2022 582c 5922     c_str = "X,Y"
+00020450: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00020460: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00020470: 204e 6f74 496d 706c 656d 656e 7465 6445   NotImplementedE
+00020480: 7272 6f72 2822 4f6e 6c79 2064 6574 6563  rror("Only detec
+00020490: 746f 7220 616e 6420 736b 7920 636f 6f72  tor and sky coor
+000204a0: 6469 6e61 7465 7320 6172 6520 6375 7272  dinates are curr
+000204b0: 656e 746c 7920 220a 2020 2020 2020 2020  ently ".        
+000204c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000204d0: 2020 2020 2020 2020 2020 2020 2020 2273                "s
+000204e0: 7570 706f 7274 6564 2066 6f72 2067 656e  upported for gen
+000204f0: 6572 6174 696e 6720 5341 5320 7265 6769  erating SAS regi
+00020500: 6f6e 2073 7472 696e 6773 2e22 290a 0a20  on strings.").. 
+00020510: 2020 2020 2020 2023 2057 6520 6e65 6564         # We need
+00020520: 2061 206d 6174 6368 696e 6720 696d 6167   a matching imag
+00020530: 6520 746f 2070 6572 666f 726d 2074 6865  e to perform the
+00020540: 2063 6f6f 7264 696e 6174 6520 636f 6e76   coordinate conv
+00020550: 6572 7369 6f6e 2077 6520 7265 7175 6972  ersion we requir
+00020560: 650a 2020 2020 2020 2020 7265 6c5f 696d  e.        rel_im
+00020570: 203d 2073 656c 662e 6765 745f 7072 6f64   = self.get_prod
+00020580: 7563 7473 2822 696d 6167 6522 2c20 6f62  ucts("image", ob
+00020590: 735f 6964 2c20 696e 7374 295b 305d 0a20  s_id, inst)[0]. 
+000205a0: 2020 2020 2020 2023 2057 6520 6361 6e20         # We can 
+000205b0: 7365 7420 6f75 7220 6f77 6e20 6f66 6673  set our own offs
+000205c0: 6574 2076 616c 7565 2077 6865 6e20 7765  et value when we
+000205d0: 2063 616c 6c20 7468 6973 2066 756e 6374   call this funct
+000205e0: 696f 6e2c 2062 7574 2049 2064 6f6e 2774  ion, but I don't
+000205f0: 2074 6869 6e6b 2049 206e 6565 6420 746f   think I need to
+00020600: 0a20 2020 2020 2020 2073 6b79 5f74 6f5f  .        sky_to_
+00020610: 6465 6720 3d20 736b 795f 6465 675f 7363  deg = sky_deg_sc
+00020620: 616c 6528 7265 6c5f 696d 2c20 6365 6e74  ale(rel_im, cent
+00020630: 7261 6c5f 636f 6f72 6429 2e76 616c 7565  ral_coord).value
+00020640: 0a0a 2020 2020 2020 2020 2320 5765 206e  ..        # We n
+00020650: 6565 6420 6f75 7220 6368 6f73 656e 2063  eed our chosen c
+00020660: 656e 7472 616c 2063 6f6f 7264 696e 6174  entral coordinat
+00020670: 6573 2069 6e20 7468 6520 7269 6768 7420  es in the right 
+00020680: 756e 6974 7320 6f66 2063 6f75 7273 650a  units of course.
+00020690: 2020 2020 2020 2020 786d 6d5f 6365 6e74          xmm_cent
+000206a0: 7261 6c5f 636f 6f72 6420 3d20 7265 6c5f  ral_coord = rel_
+000206b0: 696d 2e63 6f6f 7264 5f63 6f6e 7628 6365  im.coord_conv(ce
+000206c0: 6e74 7261 6c5f 636f 6f72 642c 206f 7574  ntral_coord, out
+000206d0: 7075 745f 756e 6974 290a 2020 2020 2020  put_unit).      
+000206e0: 2020 2320 416e 6420 6a75 7374 2074 6f20    # And just to 
+000206f0: 6d61 6b65 2073 7572 6520 7468 6520 6365  make sure the ce
+00020700: 6e74 7261 6c20 636f 6f72 6469 6e61 7465  ntral coordinate
+00020710: 7320 6172 6520 696e 2064 6567 7265 6573  s are in degrees
+00020720: 0a20 2020 2020 2020 2064 6567 5f63 656e  .        deg_cen
+00020730: 7472 616c 5f63 6f6f 7264 203d 2072 656c  tral_coord = rel
+00020740: 5f69 6d2e 636f 6f72 645f 636f 6e76 2863  _im.coord_conv(c
+00020750: 656e 7472 616c 5f63 6f6f 7264 2c20 6465  entral_coord, de
+00020760: 6729 0a0a 2020 2020 2020 2020 2320 4966  g)..        # If
+00020770: 2074 6865 2075 7365 7220 646f 6573 6e27   the user doesn'
+00020780: 7420 7061 7373 2061 6e79 2072 6567 696f  t pass any regio
+00020790: 6e73 2c20 7468 656e 2077 6520 6861 7665  ns, then we have
+000207a0: 2074 6f20 6669 6e64 2074 6865 6d20 6f75   to find them ou
+000207b0: 7273 656c 7665 732e 2049 2064 6563 6964  rselves. I decid
+000207c0: 6564 2074 6f20 616c 6c6f 7720 7468 6973  ed to allow this
+000207d0: 0a20 2020 2020 2020 2023 2020 736f 2074  .        #  so t
+000207e0: 6861 7420 7769 7468 696e 5f72 6164 6969  hat within_radii
+000207f0: 2063 616e 206a 7573 7420 6265 2063 616c   can just be cal
+00020800: 6c65 6420 6f6e 6365 2065 7874 6572 6e61  led once externa
+00020810: 6c6c 7920 666f 7220 6120 7365 7420 6f66  lly for a set of
+00020820: 204f 6273 4944 2d69 6e73 7472 756d 656e   ObsID-instrumen
+00020830: 7420 636f 6d62 696e 6174 696f 6e73 2c0a  t combinations,.
+00020840: 2020 2020 2020 2020 2320 206c 696b 6520          #  like 
+00020850: 696e 2065 7673 656c 6563 745f 7370 6563  in evselect_spec
+00020860: 7472 756d 2066 6f72 2069 6e73 7461 6e63  trum for instanc
+00020870: 652e 0a20 2020 2020 2020 2069 6620 696e  e..        if in
+00020880: 7465 726c 6f70 6572 5f72 6567 696f 6e73  terloper_regions
+00020890: 2069 7320 4e6f 6e65 2061 6e64 2069 6e6e   is None and inn
+000208a0: 6572 5f72 6164 6975 732e 6973 7363 616c  er_radius.isscal
+000208b0: 6172 3a0a 2020 2020 2020 2020 2020 2020  ar:.            
+000208c0: 696e 7465 726c 6f70 6572 5f72 6567 696f  interloper_regio
+000208d0: 6e73 203d 2073 656c 662e 7265 6769 6f6e  ns = self.region
+000208e0: 735f 7769 7468 696e 5f72 6164 6969 2869  s_within_radii(i
+000208f0: 6e6e 6572 5f72 6164 6975 732c 206f 7574  nner_radius, out
+00020900: 6572 5f72 6164 6975 732c 2064 6567 5f63  er_radius, deg_c
+00020910: 656e 7472 616c 5f63 6f6f 7264 290a 2020  entral_coord).  
+00020920: 2020 2020 2020 656c 6966 2069 6e74 6572        elif inter
+00020930: 6c6f 7065 725f 7265 6769 6f6e 7320 6973  loper_regions is
+00020940: 204e 6f6e 6520 616e 6420 6e6f 7420 696e   None and not in
+00020950: 6e65 725f 7261 6469 7573 2e69 7373 6361  ner_radius.issca
+00020960: 6c61 723a 0a20 2020 2020 2020 2020 2020  lar:.           
+00020970: 2069 6e74 6572 6c6f 7065 725f 7265 6769   interloper_regi
+00020980: 6f6e 7320 3d20 7365 6c66 2e72 6567 696f  ons = self.regio
+00020990: 6e73 5f77 6974 6869 6e5f 7261 6469 6928  ns_within_radii(
+000209a0: 6d69 6e28 696e 6e65 725f 7261 6469 7573  min(inner_radius
+000209b0: 292c 206d 6178 286f 7574 6572 5f72 6164  ), max(outer_rad
+000209c0: 6975 7329 2c20 6465 675f 6365 6e74 7261  ius), deg_centra
+000209d0: 6c5f 636f 6f72 6429 0a0a 2020 2020 2020  l_coord)..      
+000209e0: 2020 2320 536f 206e 6f77 2077 6520 636f    # So now we co
+000209f0: 6e76 6572 7420 6f75 7220 696e 7465 726c  nvert our interl
+00020a00: 6f70 6572 2072 6567 696f 6e73 2069 6e74  oper regions int
+00020a10: 6f20 7468 6569 7220 5341 5320 6571 7569  o their SAS equi
+00020a20: 7661 6c65 6e74 730a 2020 2020 2020 2020  valents.        
+00020a30: 7361 735f 696e 7465 726c 6f70 6572 203d  sas_interloper =
+00020a40: 205b 7365 6c66 2e5f 696e 7465 726c 6f70   [self._interlop
+00020a50: 6572 5f73 6173 5f73 7472 696e 6728 692c  er_sas_string(i,
+00020a60: 2072 656c 5f69 6d2c 206f 7574 7075 745f   rel_im, output_
+00020a70: 756e 6974 2920 666f 7220 6920 696e 2069  unit) for i in i
+00020a80: 6e74 6572 6c6f 7065 725f 7265 6769 6f6e  nterloper_region
+00020a90: 735d 0a0a 2020 2020 2020 2020 6966 2069  s]..        if i
+00020aa0: 6e6e 6572 5f72 6164 6975 732e 6973 7363  nner_radius.issc
+00020ab0: 616c 6172 2061 6e64 2069 6e6e 6572 5f72  alar and inner_r
+00020ac0: 6164 6975 732e 7661 6c75 6520 213d 2030  adius.value != 0
+00020ad0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+00020ae0: 416e 6420 7765 206e 6565 6420 746f 2064  And we need to d
+00020af0: 6566 696e 6520 6120 5341 5320 7374 7269  efine a SAS stri
+00020b00: 6e67 2066 6f72 2074 6865 2061 6374 7561  ng for the actua
+00020b10: 6c20 7265 6769 6f6e 206f 6620 696e 7465  l region of inte
+00020b20: 7265 7374 0a20 2020 2020 2020 2020 2020  rest.           
+00020b30: 2073 6173 5f73 6f75 7263 655f 6172 6561   sas_source_area
+00020b40: 203d 2022 2828 7b74 7d29 2049 4e20 616e   = "(({t}) IN an
+00020b50: 6e75 6c75 7328 7b63 787d 2c7b 6379 7d2c  nulus({cx},{cy},
+00020b60: 7b72 697d 2c7b 726f 7d29 2922 0a20 2020  {ri},{ro}))".   
+00020b70: 2020 2020 2020 2020 2073 6173 5f73 6f75           sas_sou
+00020b80: 7263 655f 6172 6561 203d 2073 6173 5f73  rce_area = sas_s
+00020b90: 6f75 7263 655f 6172 6561 2e66 6f72 6d61  ource_area.forma
+00020ba0: 7428 743d 635f 7374 722c 2063 783d 786d  t(t=c_str, cx=xm
+00020bb0: 6d5f 6365 6e74 7261 6c5f 636f 6f72 645b  m_central_coord[
+00020bc0: 305d 2e72 6f75 6e64 2834 292e 7661 6c75  0].round(4).valu
+00020bd0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00020be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020c00: 2020 2020 2020 2020 6379 3d78 6d6d 5f63          cy=xmm_c
+00020c10: 656e 7472 616c 5f63 6f6f 7264 5b31 5d2e  entral_coord[1].
+00020c20: 726f 756e 6428 3429 2e76 616c 7565 2c0a  round(4).value,.
+00020c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020c60: 2020 2020 2072 693d 2869 6e6e 6572 5f72       ri=(inner_r
+00020c70: 6164 6975 732e 7661 6c75 652f 736b 795f  adius.value/sky_
+00020c80: 746f 5f64 6567 292e 726f 756e 6428 3429  to_deg).round(4)
+00020c90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00020ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020cc0: 2020 2020 2020 2072 6f3d 286f 7574 6572         ro=(outer
+00020cd0: 5f72 6164 6975 732e 7661 6c75 652f 736b  _radius.value/sk
+00020ce0: 795f 746f 5f64 6567 292e 726f 756e 6428  y_to_deg).round(
+00020cf0: 3429 290a 2020 2020 2020 2020 2320 4966  4)).        # If
+00020d00: 2074 6865 2069 6e6e 6572 2072 6164 6975   the inner radiu
+00020d10: 7320 6973 207a 6572 6f20 7468 656e 2077  s is zero then w
+00020d20: 6520 7772 6974 6520 6120 6369 7263 6c65  e write a circle
+00020d30: 2072 6567 696f 6e2c 2062 6563 6175 7365   region, because
+00020d40: 2069 7420 7365 656d 7320 7468 6174 2773   it seems that's
+00020d50: 2061 204c 4f54 2066 6173 7465 7220 696e   a LOT faster in
+00020d60: 2053 4153 0a20 2020 2020 2020 2065 6c69   SAS.        eli
+00020d70: 6620 696e 6e65 725f 7261 6469 7573 2e69  f inner_radius.i
+00020d80: 7373 6361 6c61 7220 616e 6420 696e 6e65  sscalar and inne
+00020d90: 725f 7261 6469 7573 2e76 616c 7565 203d  r_radius.value =
+00020da0: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
+00020db0: 2073 6173 5f73 6f75 7263 655f 6172 6561   sas_source_area
+00020dc0: 203d 2022 2828 7b74 7d29 2049 4e20 6369   = "(({t}) IN ci
+00020dd0: 7263 6c65 287b 6378 7d2c 7b63 797d 2c7b  rcle({cx},{cy},{
+00020de0: 727d 2929 220a 2020 2020 2020 2020 2020  r}))".          
+00020df0: 2020 7361 735f 736f 7572 6365 5f61 7265    sas_source_are
+00020e00: 6120 3d20 7361 735f 736f 7572 6365 5f61  a = sas_source_a
+00020e10: 7265 612e 666f 726d 6174 2874 3d63 5f73  rea.format(t=c_s
+00020e20: 7472 2c20 6378 3d78 6d6d 5f63 656e 7472  tr, cx=xmm_centr
+00020e30: 616c 5f63 6f6f 7264 5b30 5d2e 726f 756e  al_coord[0].roun
+00020e40: 6428 3429 2e76 616c 7565 2c0a 2020 2020  d(4).value,.    
+00020e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020e80: 2063 793d 786d 6d5f 6365 6e74 7261 6c5f   cy=xmm_central_
+00020e90: 636f 6f72 645b 315d 2e72 6f75 6e64 2834  coord[1].round(4
+00020ea0: 292e 7661 6c75 652c 0a20 2020 2020 2020  ).value,.       
+00020eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00020ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020ee0: 2020 2020 2020 2063 793d 786d 6d5f 6365         cy=xmm_ce
-00020ef0: 6e74 7261 6c5f 636f 6f72 645b 315d 2e72  ntral_coord[1].r
-00020f00: 6f75 6e64 2834 292e 7661 6c75 652c 0a20  ound(4).value,. 
-00020f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020f40: 2020 2020 7769 3d28 696e 6e65 725f 7261      wi=(inner_ra
-00020f50: 6469 7573 5b30 5d2e 7661 6c75 652f 736b  dius[0].value/sk
-00020f60: 795f 746f 5f64 6567 292e 726f 756e 6428  y_to_deg).round(
-00020f70: 3429 2c0a 2020 2020 2020 2020 2020 2020  4),.            
-00020f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020fa0: 2020 2020 2020 2020 2068 693d 2869 6e6e           hi=(inn
-00020fb0: 6572 5f72 6164 6975 735b 315d 2e76 616c  er_radius[1].val
-00020fc0: 7565 2f73 6b79 5f74 6f5f 6465 6729 2e72  ue/sky_to_deg).r
-00020fd0: 6f75 6e64 2834 292c 0a20 2020 2020 2020  ound(4),.       
-00020fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021000: 2020 2020 2020 2020 2020 2020 2020 776f                wo
-00021010: 3d28 6f75 7465 725f 7261 6469 7573 5b30  =(outer_radius[0
-00021020: 5d2e 7661 6c75 652f 736b 795f 746f 5f64  ].value/sky_to_d
-00021030: 6567 292e 726f 756e 6428 3429 2c0a 2020  eg).round(4),.  
+00020ed0: 2020 2020 2020 2020 2020 2020 2020 723d                r=
+00020ee0: 286f 7574 6572 5f72 6164 6975 732e 7661  (outer_radius.va
+00020ef0: 6c75 652f 736b 795f 746f 5f64 6567 292e  lue/sky_to_deg).
+00020f00: 726f 756e 6428 3429 290a 2020 2020 2020  round(4)).      
+00020f10: 2020 656c 6966 206e 6f74 2069 6e6e 6572    elif not inner
+00020f20: 5f72 6164 6975 732e 6973 7363 616c 6172  _radius.isscalar
+00020f30: 2061 6e64 2069 6e6e 6572 5f72 6164 6975   and inner_radiu
+00020f40: 735b 305d 2e76 616c 7565 2021 3d20 303a  s[0].value != 0:
+00020f50: 0a20 2020 2020 2020 2020 2020 2073 6173  .            sas
+00020f60: 5f73 6f75 7263 655f 6172 6561 203d 2022  _source_area = "
+00020f70: 2828 7b74 7d29 2049 4e20 656c 6c69 7074  (({t}) IN ellipt
+00020f80: 616e 6e75 6c75 7328 7b63 787d 2c7b 6379  annulus({cx},{cy
+00020f90: 7d2c 7b77 697d 2c7b 6869 7d2c 7b77 6f7d  },{wi},{hi},{wo}
+00020fa0: 2c7b 686f 7d2c 7b72 6f74 7d2c 7b72 6f74  ,{ho},{rot},{rot
+00020fb0: 7d29 2922 0a20 2020 2020 2020 2020 2020  }))".           
+00020fc0: 2073 6173 5f73 6f75 7263 655f 6172 6561   sas_source_area
+00020fd0: 203d 2073 6173 5f73 6f75 7263 655f 6172   = sas_source_ar
+00020fe0: 6561 2e66 6f72 6d61 7428 743d 635f 7374  ea.format(t=c_st
+00020ff0: 722c 2063 783d 786d 6d5f 6365 6e74 7261  r, cx=xmm_centra
+00021000: 6c5f 636f 6f72 645b 305d 2e72 6f75 6e64  l_coord[0].round
+00021010: 2834 292e 7661 6c75 652c 0a20 2020 2020  (4).value,.     
+00021020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021030: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00021040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021070: 2020 2068 6f3d 286f 7574 6572 5f72 6164     ho=(outer_rad
-00021080: 6975 735b 315d 2e76 616c 7565 2f73 6b79  ius[1].value/sky
-00021090: 5f74 6f5f 6465 6729 2e72 6f75 6e64 2834  _to_deg).round(4
-000210a0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-000210b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000210c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000210d0: 2020 2020 2020 2020 726f 743d 726f 745f          rot=rot_
-000210e0: 616e 676c 652e 746f 2827 6465 6727 292e  angle.to('deg').
-000210f0: 726f 756e 6428 3429 2e76 616c 7565 290a  round(4).value).
-00021100: 2020 2020 2020 2020 656c 6966 206e 6f74          elif not
-00021110: 2069 6e6e 6572 5f72 6164 6975 732e 6973   inner_radius.is
-00021120: 7363 616c 6172 2061 6e64 2069 6e6e 6572  scalar and inner
-00021130: 5f72 6164 6975 735b 305d 2e76 616c 7565  _radius[0].value
-00021140: 203d 3d20 303a 0a20 2020 2020 2020 2020   == 0:.         
-00021150: 2020 2073 6173 5f73 6f75 7263 655f 6172     sas_source_ar
-00021160: 6561 203d 2022 2828 7b74 7d29 2049 4e20  ea = "(({t}) IN 
-00021170: 656c 6c69 7073 6528 7b63 787d 2c7b 6379  ellipse({cx},{cy
-00021180: 7d2c 7b77 7d2c 7b68 7d2c 7b72 6f74 7d29  },{w},{h},{rot})
-00021190: 2922 0a20 2020 2020 2020 2020 2020 2073  )".            s
-000211a0: 6173 5f73 6f75 7263 655f 6172 6561 203d  as_source_area =
-000211b0: 2073 6173 5f73 6f75 7263 655f 6172 6561   sas_source_area
-000211c0: 2e66 6f72 6d61 7428 743d 635f 7374 722c  .format(t=c_str,
-000211d0: 2063 783d 786d 6d5f 6365 6e74 7261 6c5f   cx=xmm_central_
-000211e0: 636f 6f72 645b 305d 2e72 6f75 6e64 2834  coord[0].round(4
-000211f0: 292e 7661 6c75 652c 0a20 2020 2020 2020  ).value,.       
-00021200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021050: 6379 3d78 6d6d 5f63 656e 7472 616c 5f63  cy=xmm_central_c
+00021060: 6f6f 7264 5b31 5d2e 726f 756e 6428 3429  oord[1].round(4)
+00021070: 2e76 616c 7565 2c0a 2020 2020 2020 2020  .value,.        
+00021080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000210a0: 2020 2020 2020 2020 2020 2020 2077 693d               wi=
+000210b0: 2869 6e6e 6572 5f72 6164 6975 735b 305d  (inner_radius[0]
+000210c0: 2e76 616c 7565 2f73 6b79 5f74 6f5f 6465  .value/sky_to_de
+000210d0: 6729 2e72 6f75 6e64 2834 292c 0a20 2020  g).round(4),.   
+000210e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000210f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021110: 2020 6869 3d28 696e 6e65 725f 7261 6469    hi=(inner_radi
+00021120: 7573 5b31 5d2e 7661 6c75 652f 736b 795f  us[1].value/sky_
+00021130: 746f 5f64 6567 292e 726f 756e 6428 3429  to_deg).round(4)
+00021140: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00021150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021170: 2020 2020 2020 2077 6f3d 286f 7574 6572         wo=(outer
+00021180: 5f72 6164 6975 735b 305d 2e76 616c 7565  _radius[0].value
+00021190: 2f73 6b79 5f74 6f5f 6465 6729 2e72 6f75  /sky_to_deg).rou
+000211a0: 6e64 2834 292c 0a20 2020 2020 2020 2020  nd(4),.         
+000211b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000211c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000211d0: 2020 2020 2020 2020 2020 2020 686f 3d28              ho=(
+000211e0: 6f75 7465 725f 7261 6469 7573 5b31 5d2e  outer_radius[1].
+000211f0: 7661 6c75 652f 736b 795f 746f 5f64 6567  value/sky_to_deg
+00021200: 292e 726f 756e 6428 3429 2c0a 2020 2020  ).round(4),.    
 00021210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021220: 2020 2020 2020 2020 2020 2020 2020 6379                cy
-00021230: 3d78 6d6d 5f63 656e 7472 616c 5f63 6f6f  =xmm_central_coo
-00021240: 7264 5b31 5d2e 726f 756e 6428 3429 2e76  rd[1].round(4).v
-00021250: 616c 7565 2c0a 2020 2020 2020 2020 2020  alue,.          
-00021260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021280: 2020 2020 2020 2020 2020 2077 3d28 6f75             w=(ou
-00021290: 7465 725f 7261 6469 7573 5b30 5d2e 7661  ter_radius[0].va
-000212a0: 6c75 6520 2f20 736b 795f 746f 5f64 6567  lue / sky_to_deg
-000212b0: 292e 726f 756e 6428 3429 2c0a 2020 2020  ).round(4),.    
-000212c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000212d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000212e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000212f0: 2068 3d28 6f75 7465 725f 7261 6469 7573   h=(outer_radius
-00021300: 5b31 5d2e 7661 6c75 6520 2f20 736b 795f  [1].value / sky_
-00021310: 746f 5f64 6567 292e 726f 756e 6428 3429  to_deg).round(4)
-00021320: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00021330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021350: 2020 2020 2020 2072 6f74 3d72 6f74 5f61         rot=rot_a
-00021360: 6e67 6c65 2e74 6f28 2764 6567 2729 2e72  ngle.to('deg').r
-00021370: 6f75 6e64 2834 292e 7661 6c75 6529 0a0a  ound(4).value)..
-00021380: 2020 2020 2020 2020 2320 436f 6d62 696e          # Combin
-00021390: 696e 6720 7468 6520 736f 7572 6365 2072  ing the source r
-000213a0: 6567 696f 6e20 7769 7468 2074 6865 2072  egion with the r
-000213b0: 6567 696f 6e73 2077 6520 6e65 6564 2074  egions we need t
-000213c0: 6f20 6375 7420 6f75 740a 2020 2020 2020  o cut out.      
-000213d0: 2020 6966 206c 656e 2873 6173 5f69 6e74    if len(sas_int
-000213e0: 6572 6c6f 7065 7229 203d 3d20 303a 0a20  erloper) == 0:. 
-000213f0: 2020 2020 2020 2020 2020 2066 696e 616c             final
-00021400: 5f73 7263 203d 2073 6173 5f73 6f75 7263  _src = sas_sourc
-00021410: 655f 6172 6561 0a20 2020 2020 2020 2065  e_area.        e
-00021420: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00021430: 2066 696e 616c 5f73 7263 203d 2073 6173   final_src = sas
-00021440: 5f73 6f75 7263 655f 6172 6561 202b 2022  _source_area + "
-00021450: 2026 2621 2022 202b 2022 2026 2621 2022   &&! " + " &&! "
-00021460: 2e6a 6f69 6e28 7361 735f 696e 7465 726c  .join(sas_interl
-00021470: 6f70 6572 290a 0a20 2020 2020 2020 2072  oper)..        r
-00021480: 6574 7572 6e20 6669 6e61 6c5f 7372 630a  eturn final_src.
-00021490: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
-000214a0: 2020 2064 6566 206e 4828 7365 6c66 2920     def nH(self) 
-000214b0: 2d3e 2051 7561 6e74 6974 793a 0a20 2020  -> Quantity:.   
-000214c0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-000214d0: 2050 726f 7065 7274 7920 6765 7474 6572   Property getter
-000214e0: 2066 6f72 206e 6575 7472 616c 2068 7964   for neutral hyd
-000214f0: 726f 6765 6e20 636f 6c75 6d6e 2061 7474  rogen column att
-00021500: 7269 6275 7465 2e0a 0a20 2020 2020 2020  ribute...       
-00021510: 203a 7265 7475 726e 3a20 4e65 7574 7261   :return: Neutra
-00021520: 6c20 6879 6472 6f67 656e 2063 6f6c 756d  l hydrogen colum
-00021530: 6e20 7375 7266 6163 6520 6465 6e73 6974  n surface densit
-00021540: 792e 0a20 2020 2020 2020 203a 7274 7970  y..        :rtyp
-00021550: 653a 2051 7561 6e74 6974 790a 2020 2020  e: Quantity.    
-00021560: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00021570: 7265 7475 726e 2073 656c 662e 5f6e 480a  return self._nH.
-00021580: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
-00021590: 2020 2064 6566 2072 6564 7368 6966 7428     def redshift(
-000215a0: 7365 6c66 2920 2d3e 2066 6c6f 6174 3a0a  self) -> float:.
-000215b0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-000215c0: 2020 2020 5072 6f70 6572 7479 2067 6574      Property get
-000215d0: 7465 7220 666f 7220 7468 6520 7265 6473  ter for the reds
-000215e0: 6869 6674 206f 6620 7468 6973 2073 6f75  hift of this sou
-000215f0: 7263 6520 6f62 6a65 6374 2e0a 0a20 2020  rce object...   
-00021600: 2020 2020 203a 7265 7475 726e 3a20 5265       :return: Re
-00021610: 6473 6869 6674 2076 616c 7565 0a20 2020  dshift value.   
-00021620: 2020 2020 203a 7274 7970 653a 2066 6c6f       :rtype: flo
-00021630: 6174 0a20 2020 2020 2020 2022 2222 0a20  at.        """. 
-00021640: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-00021650: 6c66 2e5f 7265 6473 6869 6674 0a0a 2020  lf._redshift..  
-00021660: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
-00021670: 6465 6620 6f6e 5f61 7869 735f 6f62 735f  def on_axis_obs_
-00021680: 6964 7328 7365 6c66 2920 2d3e 206c 6973  ids(self) -> lis
-00021690: 743a 0a20 2020 2020 2020 2022 2222 0a20  t:.        """. 
-000216a0: 2020 2020 2020 2054 6869 7320 6d65 7468         This meth
-000216b0: 6f64 2072 6574 7572 6e73 2061 6e20 6172  od returns an ar
-000216c0: 7261 7920 6f66 204f 6273 4944 7320 7468  ray of ObsIDs th
-000216d0: 6174 2074 6869 7320 736f 7572 6365 2069  at this source i
-000216e0: 7320 6170 7072 6f78 696d 6174 656c 7920  s approximately 
-000216f0: 6f6e 2061 7869 7320 696e 2e0a 0a20 2020  on axis in...   
-00021700: 2020 2020 203a 7265 7475 726e 3a20 4f62       :return: Ob
-00021710: 7349 4473 2066 6f72 2077 6869 6368 2074  sIDs for which t
-00021720: 6865 2073 6f75 7263 6520 6973 2061 7070  he source is app
-00021730: 726f 7869 6d61 7465 6c79 206f 6e20 6178  roximately on ax
-00021740: 6973 2e0a 2020 2020 2020 2020 3a72 7479  is..        :rty
-00021750: 7065 3a20 6c69 7374 0a20 2020 2020 2020  pe: list.       
-00021760: 2022 2222 0a20 2020 2020 2020 2072 6574   """.        ret
-00021770: 7572 6e20 7365 6c66 2e5f 6f6e 6178 6973  urn self._onaxis
-00021780: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
-00021790: 2020 2020 6465 6620 636f 736d 6f28 7365      def cosmo(se
-000217a0: 6c66 2920 2d3e 2043 6f73 6d6f 6c6f 6779  lf) -> Cosmology
-000217b0: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-000217c0: 2020 2020 2020 5468 6973 206d 6574 686f        This metho
-000217d0: 6420 7265 7475 726e 7320 7768 6174 6576  d returns whatev
-000217e0: 6572 2063 6f73 6d6f 6c6f 6779 206f 626a  er cosmology obj
-000217f0: 6563 7420 6973 2061 7373 6f63 6961 7465  ect is associate
-00021800: 6420 7769 7468 2074 6869 7320 736f 7572  d with this sour
-00021810: 6365 206f 626a 6563 742e 0a0a 2020 2020  ce object...    
-00021820: 2020 2020 3a72 6574 7572 6e3a 2041 6e20      :return: An 
-00021830: 6173 7472 6f70 7920 636f 736d 6f6c 6f67  astropy cosmolog
-00021840: 7920 6f62 6a65 6374 2073 7065 6369 6669  y object specifi
-00021850: 6564 2066 6f72 2074 6869 7320 736f 7572  ed for this sour
-00021860: 6365 206f 6e20 696e 6974 6961 6c69 7a61  ce on initializa
-00021870: 7469 6f6e 2e0a 2020 2020 2020 2020 3a72  tion..        :r
-00021880: 7479 7065 3a20 436f 736d 6f6c 6f67 790a  type: Cosmology.
-00021890: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-000218a0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-000218b0: 5f63 6f73 6d6f 0a0a 2020 2020 2320 5468  _cosmo..    # Th
-000218c0: 6973 2069 7320 7573 6564 2074 6f20 6e61  is is used to na
-000218d0: 6d65 2066 696c 6573 2061 6e64 2064 6972  me files and dir
-000218e0: 6563 746f 7269 6573 2073 6f20 7468 6973  ectories so this
-000218f0: 2069 7320 6e6f 7420 616c 6c6f 7765 6420   is not allowed 
-00021900: 746f 2063 6861 6e67 652e 0a20 2020 2040  to change..    @
-00021910: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
-00021920: 206e 616d 6528 7365 6c66 2920 2d3e 2073   name(self) -> s
-00021930: 7472 3a0a 2020 2020 2020 2020 2222 220a  tr:.        """.
-00021940: 2020 2020 2020 2020 5468 6520 6e61 6d65          The name
-00021950: 206f 6620 7468 6520 736f 7572 6365 2c20   of the source, 
-00021960: 6569 7468 6572 2067 6976 656e 2061 7420  either given at 
-00021970: 696e 6974 6961 6c69 7361 7469 6f6e 206f  initialisation o
-00021980: 7220 6765 6e65 7261 7465 6420 6672 6f6d  r generated from
-00021990: 2074 6865 2075 7365 722d 7375 7070 6c69   the user-suppli
-000219a0: 6564 2063 6f6f 7264 696e 6174 6573 2e0a  ed coordinates..
-000219b0: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
-000219c0: 3a20 5468 6520 6e61 6d65 206f 6620 7468  : The name of th
-000219d0: 6520 736f 7572 6365 2e0a 2020 2020 2020  e source..      
-000219e0: 2020 3a72 7479 7065 3a20 7374 720a 2020    :rtype: str.  
-000219f0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00021a00: 2020 7265 7475 726e 2073 656c 662e 5f6e    return self._n
-00021a10: 616d 650a 0a20 2020 2064 6566 2061 6464  ame..    def add
-00021a20: 5f66 6974 5f64 6174 6128 7365 6c66 2c20  _fit_data(self, 
-00021a30: 6d6f 6465 6c3a 2073 7472 2c20 7461 625f  model: str, tab_
-00021a40: 6c69 6e65 2c20 6c75 6d73 3a20 6469 6374  line, lums: dict
-00021a50: 2c20 7370 6563 5f73 746f 7261 6765 5f6b  , spec_storage_k
-00021a60: 6579 3a20 7374 7229 3a0a 2020 2020 2020  ey: str):.      
-00021a70: 2020 2222 220a 2020 2020 2020 2020 4120    """.        A 
-00021a80: 6d65 7468 6f64 2074 6861 7420 7374 6f72  method that stor
-00021a90: 6573 2066 6974 2072 6573 756c 7473 2061  es fit results a
-00021aa0: 6e64 2067 6c6f 6261 6c20 696e 666f 726d  nd global inform
-00021ab0: 6174 696f 6e20 6162 6f75 7420 6120 7468  ation about a th
-00021ac0: 6520 7365 7420 6f66 2073 7065 6374 7261  e set of spectra
-00021ad0: 2069 6e20 6120 736f 7572 6365 206f 626a   in a source obj
-00021ae0: 6563 742e 0a20 2020 2020 2020 2041 6e79  ect..        Any
-00021af0: 2076 6172 6961 626c 6520 7061 7261 6d65   variable parame
-00021b00: 7465 7273 2069 6e20 7468 6520 6669 7420  ters in the fit 
-00021b10: 6172 6520 7374 6f72 6564 2069 6e20 616e  are stored in an
-00021b20: 2069 6e74 6572 6e61 6c20 6469 6374 696f   internal dictio
-00021b30: 6e61 7279 2073 7472 7563 7475 7265 2c20  nary structure, 
-00021b40: 6173 2061 7265 2061 6e79 206c 756d 696e  as are any lumin
-00021b50: 6f73 6974 6965 730a 2020 2020 2020 2020  osities.        
-00021b60: 6361 6c63 756c 6174 6564 2e20 4f74 6865  calculated. Othe
-00021b70: 7220 7061 7261 6d65 7465 7273 206f 6620  r parameters of 
-00021b80: 696e 7465 7265 7374 2061 7265 2073 746f  interest are sto
-00021b90: 7265 2069 6e20 6f74 6865 7220 696e 7465  re in other inte
-00021ba0: 726e 616c 2061 7474 7269 6275 7465 732e  rnal attributes.
-00021bb0: 2054 6869 7320 7072 6f62 6162 6c79 2073   This probably s
-00021bc0: 686f 756c 646e 2774 0a20 2020 2020 2020  houldn't.       
-00021bd0: 2065 7665 7220 6265 2075 7365 6420 6279   ever be used by
-00021be0: 2074 6865 2075 7365 722c 206a 7573 7420   the user, just 
-00021bf0: 6f74 6865 7220 7061 7274 7320 6f66 2058  other parts of X
-00021c00: 4741 2c20 6865 6e63 6520 7768 7920 4927  GA, hence why I'
-00021c10: 7665 2061 736b 6564 2066 6f72 2061 2073  ve asked for a s
-00021c20: 7065 635f 7374 6f72 6167 655f 6b65 7920  pec_storage_key 
-00021c30: 746f 2062 6520 7061 7373 6564 0a20 2020  to be passed.   
-00021c40: 2020 2020 2069 6e20 7261 7468 6572 2074       in rather t
-00021c50: 6861 6e20 616c 6c20 7468 6520 7370 6563  han all the spec
-00021c60: 7472 756d 2063 6f6e 6669 6775 7261 7469  trum configurati
-00021c70: 6f6e 206f 7074 696f 6e73 2069 6e64 6976  on options indiv
-00021c80: 6964 7561 6c6c 792e 0a0a 2020 2020 2020  idually...      
-00021c90: 2020 3a70 6172 616d 2073 7472 206d 6f64    :param str mod
-00021ca0: 656c 3a20 5468 6520 5853 5045 4320 6465  el: The XSPEC de
-00021cb0: 6669 6e69 7469 6f6e 206f 6620 7468 6520  finition of the 
-00021cc0: 6d6f 6465 6c20 7573 6564 2074 6f20 7065  model used to pe
-00021cd0: 7266 6f72 6d20 7468 6520 6669 742e 2065  rform the fit. e
-00021ce0: 2e67 2e20 636f 6e73 7461 6e74 2a74 6261  .g. constant*tba
-00021cf0: 6273 2a61 7065 630a 2020 2020 2020 2020  bs*apec.        
-00021d00: 3a70 6172 616d 2074 6162 5f6c 696e 653a  :param tab_line:
-00021d10: 2054 6865 2074 6162 6c65 206c 696e 6520   The table line 
-00021d20: 7769 7468 2074 6865 2066 6974 2064 6174  with the fit dat
-00021d30: 612e 0a20 2020 2020 2020 203a 7061 7261  a..        :para
-00021d40: 6d20 6469 6374 206c 756d 733a 2054 6865  m dict lums: The
-00021d50: 2076 6172 696f 7573 206c 756d 696e 6f73   various luminos
-00021d60: 6974 6965 7320 6d65 6173 7572 6564 2064  ities measured d
-00021d70: 7572 696e 6720 7468 6520 6669 742e 0a20  uring the fit.. 
-00021d80: 2020 2020 2020 203a 7061 7261 6d20 7374         :param st
-00021d90: 7220 7370 6563 5f73 746f 7261 6765 5f6b  r spec_storage_k
-00021da0: 6579 3a20 5468 6520 7374 6f72 6167 6520  ey: The storage 
-00021db0: 6b65 7920 6f66 2061 6e79 2073 7065 6374  key of any spect
-00021dc0: 7275 6d20 7468 6174 2077 6173 2075 7365  rum that was use
-00021dd0: 6420 696e 2074 6869 7320 7061 7274 6963  d in this partic
-00021de0: 756c 6172 2066 6974 2e20 5468 650a 2020  ular fit. The.  
-00021df0: 2020 2020 2020 2020 2020 4f62 7349 4420            ObsID 
-00021e00: 616e 6420 696e 7374 7275 6d65 6e74 2075  and instrument u
-00021e10: 7365 6420 646f 6e27 7420 6d61 7474 6572  sed don't matter
-00021e20: 2c20 6173 2074 6865 2073 746f 7261 6765  , as the storage
-00021e30: 206b 6579 2077 696c 6c20 6265 2074 6865   key will be the
-00021e40: 2073 616d 6520 616e 6420 6973 2062 6173   same and is bas
-00021e50: 6564 206f 6666 206f 6620 7468 650a 2020  ed off of the.  
-00021e60: 2020 2020 2020 2020 2020 7365 7474 696e            settin
-00021e70: 6773 2077 6865 6e20 7468 6520 7370 6563  gs when the spec
-00021e80: 7472 6120 7765 7265 2067 656e 6572 6174  tra were generat
-00021e90: 6564 2e0a 2020 2020 2020 2020 2222 220a  ed..        """.
-00021ea0: 2020 2020 2020 2020 2320 4a75 7374 2068          # Just h
-00021eb0: 6561 6465 7273 2074 6861 7420 7769 6c6c  eaders that will
-00021ec0: 2061 6c77 6179 7320 6265 2070 7265 7365   always be prese
-00021ed0: 6e74 2069 6e20 7461 625f 6c69 6e65 2074  nt in tab_line t
-00021ee0: 6861 7420 6172 6520 6e6f 7420 6669 7420  hat are not fit 
-00021ef0: 7061 7261 6d65 7465 7273 0a20 2020 2020  parameters.     
-00021f00: 2020 206e 6f74 5f70 6172 203d 205b 274d     not_par = ['M
-00021f10: 4f44 454c 272c 2027 544f 5441 4c5f 4558  ODEL', 'TOTAL_EX
-00021f20: 504f 5355 5245 272c 2027 544f 5441 4c5f  POSURE', 'TOTAL_
-00021f30: 434f 554e 545f 5241 5445 272c 2027 544f  COUNT_RATE', 'TO
-00021f40: 5441 4c5f 434f 554e 545f 5241 5445 5f45  TAL_COUNT_RATE_E
-00021f50: 5252 272c 0a20 2020 2020 2020 2020 2020  RR',.           
-00021f60: 2020 2020 2020 2020 274e 554d 5f55 4e4c          'NUM_UNL
-00021f70: 494e 4b45 445f 5448 4157 4544 5f56 4152  INKED_THAWED_VAR
-00021f80: 5327 2c20 2746 4954 5f53 5441 5449 5354  S', 'FIT_STATIST
-00021f90: 4943 272c 2027 5445 5354 5f53 5441 5449  IC', 'TEST_STATI
-00021fa0: 5354 4943 272c 2027 444f 4627 5d0a 0a20  STIC', 'DOF'].. 
-00021fb0: 2020 2020 2020 2023 2056 6172 696f 7573         # Various
-00021fc0: 2067 6c6f 6261 6c20 7661 6c75 6573 206f   global values o
-00021fd0: 6620 696e 7465 7265 7374 0a20 2020 2020  f interest.     
-00021fe0: 2020 2073 656c 662e 5f74 6f74 616c 5f65     self._total_e
-00021ff0: 7870 5b73 7065 635f 7374 6f72 6167 655f  xp[spec_storage_
-00022000: 6b65 795d 203d 2066 6c6f 6174 2874 6162  key] = float(tab
-00022010: 5f6c 696e 655b 2254 4f54 414c 5f45 5850  _line["TOTAL_EXP
-00022020: 4f53 5552 4522 5d29 0a20 2020 2020 2020  OSURE"]).       
-00022030: 2069 6620 7370 6563 5f73 746f 7261 6765   if spec_storage
-00022040: 5f6b 6579 206e 6f74 2069 6e20 7365 6c66  _key not in self
-00022050: 2e5f 746f 7461 6c5f 636f 756e 745f 7261  ._total_count_ra
-00022060: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
-00022070: 7365 6c66 2e5f 746f 7461 6c5f 636f 756e  self._total_coun
-00022080: 745f 7261 7465 5b73 7065 635f 7374 6f72  t_rate[spec_stor
-00022090: 6167 655f 6b65 795d 203d 207b 7d0a 2020  age_key] = {}.  
-000220a0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-000220b0: 7465 7374 5f73 7461 745b 7370 6563 5f73  test_stat[spec_s
-000220c0: 746f 7261 6765 5f6b 6579 5d20 3d20 7b7d  torage_key] = {}
-000220d0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-000220e0: 662e 5f64 6f66 5b73 7065 635f 7374 6f72  f._dof[spec_stor
-000220f0: 6167 655f 6b65 795d 203d 207b 7d0a 2020  age_key] = {}.  
-00022100: 2020 2020 2020 7365 6c66 2e5f 746f 7461        self._tota
-00022110: 6c5f 636f 756e 745f 7261 7465 5b73 7065  l_count_rate[spe
-00022120: 635f 7374 6f72 6167 655f 6b65 795d 5b6d  c_storage_key][m
-00022130: 6f64 656c 5d20 3d20 5b66 6c6f 6174 2874  odel] = [float(t
-00022140: 6162 5f6c 696e 655b 2254 4f54 414c 5f43  ab_line["TOTAL_C
-00022150: 4f55 4e54 5f52 4154 4522 5d29 2c0a 2020  OUNT_RATE"]),.  
-00022160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022190: 2020 2020 2020 2020 2066 6c6f 6174 2874           float(t
-000221a0: 6162 5f6c 696e 655b 2254 4f54 414c 5f43  ab_line["TOTAL_C
-000221b0: 4f55 4e54 5f52 4154 455f 4552 5222 5d29  OUNT_RATE_ERR"])
-000221c0: 5d0a 2020 2020 2020 2020 7365 6c66 2e5f  ].        self._
-000221d0: 7465 7374 5f73 7461 745b 7370 6563 5f73  test_stat[spec_s
-000221e0: 746f 7261 6765 5f6b 6579 5d5b 6d6f 6465  torage_key][mode
-000221f0: 6c5d 203d 2066 6c6f 6174 2874 6162 5f6c  l] = float(tab_l
-00022200: 696e 655b 2254 4553 545f 5354 4154 4953  ine["TEST_STATIS
-00022210: 5449 4322 5d29 0a20 2020 2020 2020 2073  TIC"]).        s
-00022220: 656c 662e 5f64 6f66 5b73 7065 635f 7374  elf._dof[spec_st
-00022230: 6f72 6167 655f 6b65 795d 5b6d 6f64 656c  orage_key][model
-00022240: 5d20 3d20 666c 6f61 7428 7461 625f 6c69  ] = float(tab_li
-00022250: 6e65 5b22 444f 4622 5d29 0a0a 2020 2020  ne["DOF"])..    
-00022260: 2020 2020 2320 5468 6520 7061 7261 6d65      # The parame
-00022270: 7465 7273 2061 7661 696c 6162 6c65 2077  ters available w
-00022280: 696c 6c20 6f62 7669 6f75 736c 7920 6265  ill obviously be
-00022290: 2064 796e 616d 6963 2c20 736f 2068 6176   dynamic, so hav
-000222a0: 6520 746f 2066 696e 6420 6f75 7420 7768  e to find out wh
-000222b0: 6174 2074 6865 7920 6172 6520 616e 6420  at they are and 
-000222c0: 7468 656e 0a20 2020 2020 2020 2023 2020  then.        #  
-000222d0: 7468 656e 2066 6f72 2065 6163 6820 7265  then for each re
-000222e0: 7375 6c74 2066 696e 6420 7468 6520 2b2d  sult find the +-
-000222f0: 2065 7272 6f72 730a 2020 2020 2020 2020   errors.        
-00022300: 7061 725f 6865 6164 6572 7320 3d20 5b6e  par_headers = [n
-00022310: 2066 6f72 206e 2069 6e20 7461 625f 6c69   for n in tab_li
-00022320: 6e65 2e64 7479 7065 2e6e 616d 6573 2069  ne.dtype.names i
-00022330: 6620 6e20 6e6f 7420 696e 206e 6f74 5f70  f n not in not_p
-00022340: 6172 5d0a 2020 2020 2020 2020 6d6f 645f  ar].        mod_
-00022350: 7265 7320 3d20 7b7d 0a20 2020 2020 2020  res = {}.       
-00022360: 2066 6f72 2070 6172 2069 6e20 7061 725f   for par in par_
-00022370: 6865 6164 6572 733a 0a20 2020 2020 2020  headers:.       
-00022380: 2020 2020 2023 2054 6865 2070 6172 616d       # The param
-00022390: 6574 6572 206e 616d 6520 616e 6420 7468  eter name and th
-000223a0: 6520 7061 7261 6d65 7465 7220 696e 6465  e parameter inde
-000223b0: 7820 7573 6564 2062 7920 5853 5045 4320  x used by XSPEC 
-000223c0: 6172 6520 7365 7061 7261 7465 6420 6279  are separated by
-000223d0: 207c 0a20 2020 2020 2020 2020 2020 2070   |.            p
-000223e0: 6172 5f69 6e66 6f20 3d20 7061 722e 7370  ar_info = par.sp
-000223f0: 6c69 7428 227c 2229 0a20 2020 2020 2020  lit("|").       
-00022400: 2020 2020 2070 6172 5f6e 616d 6520 3d20       par_name = 
-00022410: 7061 725f 696e 666f 5b30 5d0a 0a20 2020  par_info[0]..   
-00022420: 2020 2020 2020 2020 2023 2054 6865 2070           # The p
-00022430: 6172 616d 6574 6572 2069 6e64 6578 2063  arameter index c
-00022440: 616e 2061 6c73 6f20 6861 7665 2061 6e20  an also have an 
-00022450: 2d20 6f72 202b 2061 6674 6572 2069 7420  - or + after it 
-00022460: 6966 2074 6865 2065 6e74 7279 2069 6e20  if the entry in 
-00022470: 7175 6573 7469 6f6e 2069 7320 616e 2075  question is an u
-00022480: 6e63 6572 7461 696e 7479 0a20 2020 2020  ncertainty.     
-00022490: 2020 2020 2020 2069 6620 7061 725f 696e         if par_in
-000224a0: 666f 5b31 5d5b 2d31 5d20 3d3d 2022 2d22  fo[1][-1] == "-"
-000224b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000224c0: 2020 6964 656e 7420 3d20 7061 725f 696e    ident = par_in
-000224d0: 666f 5b31 5d5b 3a2d 315d 0a20 2020 2020  fo[1][:-1].     
-000224e0: 2020 2020 2020 2020 2020 2070 6f73 203d             pos =
-000224f0: 2031 0a20 2020 2020 2020 2020 2020 2065   1.            e
-00022500: 6c69 6620 7061 725f 696e 666f 5b31 5d5b  lif par_info[1][
-00022510: 2d31 5d20 3d3d 2022 2b22 3a0a 2020 2020  -1] == "+":.    
-00022520: 2020 2020 2020 2020 2020 2020 6964 656e              iden
-00022530: 7420 3d20 7061 725f 696e 666f 5b31 5d5b  t = par_info[1][
-00022540: 3a2d 315d 0a20 2020 2020 2020 2020 2020  :-1].           
-00022550: 2020 2020 2070 6f73 203d 2032 0a20 2020       pos = 2.   
-00022560: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00022570: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00022580: 6465 6e74 203d 2070 6172 5f69 6e66 6f5b  dent = par_info[
-00022590: 315d 0a20 2020 2020 2020 2020 2020 2020  1].             
-000225a0: 2020 2070 6f73 203d 2030 0a0a 2020 2020     pos = 0..    
-000225b0: 2020 2020 2020 2020 2320 5365 7473 2075          # Sets u
-000225c0: 7020 7468 6520 6469 6374 696f 6e61 7279  p the dictionary
-000225d0: 2073 7472 7563 7475 7265 2066 6f72 2074   structure for t
-000225e0: 6865 2072 6573 756c 7473 0a20 2020 2020  he results.     
-000225f0: 2020 2020 2020 2069 6620 7061 725f 6e61         if par_na
-00022600: 6d65 206e 6f74 2069 6e20 6d6f 645f 7265  me not in mod_re
-00022610: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00022620: 2020 206d 6f64 5f72 6573 5b70 6172 5f6e     mod_res[par_n
-00022630: 616d 655d 203d 207b 6964 656e 743a 205b  ame] = {ident: [
-00022640: 302c 2030 2c20 305d 7d0a 2020 2020 2020  0, 0, 0]}.      
-00022650: 2020 2020 2020 656c 6966 2069 6465 6e74        elif ident
-00022660: 206e 6f74 2069 6e20 6d6f 645f 7265 735b   not in mod_res[
-00022670: 7061 725f 6e61 6d65 5d3a 0a20 2020 2020  par_name]:.     
-00022680: 2020 2020 2020 2020 2020 206d 6f64 5f72             mod_r
-00022690: 6573 5b70 6172 5f6e 616d 655d 5b69 6465  es[par_name][ide
-000226a0: 6e74 5d20 3d20 5b30 2c20 302c 2030 5d0a  nt] = [0, 0, 0].
-000226b0: 0a20 2020 2020 2020 2020 2020 206d 6f64  .            mod
-000226c0: 5f72 6573 5b70 6172 5f6e 616d 655d 5b69  _res[par_name][i
-000226d0: 6465 6e74 5d5b 706f 735d 203d 2066 6c6f  dent][pos] = flo
-000226e0: 6174 2874 6162 5f6c 696e 655b 7061 725d  at(tab_line[par]
-000226f0: 290a 0a20 2020 2020 2020 2023 2053 746f  )..        # Sto
-00022700: 7269 6e67 2074 6865 2066 6974 2072 6573  ring the fit res
-00022710: 756c 7473 0a20 2020 2020 2020 2069 6620  ults.        if 
-00022720: 7370 6563 5f73 746f 7261 6765 5f6b 6579  spec_storage_key
-00022730: 206e 6f74 2069 6e20 7365 6c66 2e5f 6669   not in self._fi
-00022740: 745f 7265 7375 6c74 733a 0a20 2020 2020  t_results:.     
-00022750: 2020 2020 2020 2073 656c 662e 5f66 6974         self._fit
-00022760: 5f72 6573 756c 7473 5b73 7065 635f 7374  _results[spec_st
-00022770: 6f72 6167 655f 6b65 795d 203d 207b 7d0a  orage_key] = {}.
-00022780: 2020 2020 2020 2020 7365 6c66 2e5f 6669          self._fi
-00022790: 745f 7265 7375 6c74 735b 7370 6563 5f73  t_results[spec_s
-000227a0: 746f 7261 6765 5f6b 6579 5d5b 6d6f 6465  torage_key][mode
-000227b0: 6c5d 203d 206d 6f64 5f72 6573 0a0a 2020  l] = mod_res..  
-000227c0: 2020 2020 2020 2320 416e 6420 6e6f 7720        # And now 
-000227d0: 7374 6f72 696e 6720 7468 6520 6c75 6d69  storing the lumi
-000227e0: 6e6f 7369 7479 2072 6573 756c 7473 0a20  nosity results. 
-000227f0: 2020 2020 2020 2069 6620 7370 6563 5f73         if spec_s
-00022800: 746f 7261 6765 5f6b 6579 206e 6f74 2069  torage_key not i
-00022810: 6e20 7365 6c66 2e5f 6c75 6d69 6e6f 7369  n self._luminosi
-00022820: 7469 6573 3a0a 2020 2020 2020 2020 2020  ties:.          
-00022830: 2020 7365 6c66 2e5f 6c75 6d69 6e6f 7369    self._luminosi
-00022840: 7469 6573 5b73 7065 635f 7374 6f72 6167  ties[spec_storag
-00022850: 655f 6b65 795d 203d 207b 7d0a 2020 2020  e_key] = {}.    
-00022860: 2020 2020 7365 6c66 2e5f 6c75 6d69 6e6f      self._lumino
-00022870: 7369 7469 6573 5b73 7065 635f 7374 6f72  sities[spec_stor
-00022880: 6167 655f 6b65 795d 5b6d 6f64 656c 5d20  age_key][model] 
-00022890: 3d20 6c75 6d73 0a0a 2020 2020 6465 6620  = lums..    def 
-000228a0: 6765 745f 7265 7375 6c74 7328 7365 6c66  get_results(self
-000228b0: 2c20 6f75 7465 725f 7261 6469 7573 3a20  , outer_radius: 
-000228c0: 556e 696f 6e5b 7374 722c 2051 7561 6e74  Union[str, Quant
-000228d0: 6974 795d 2c20 6d6f 6465 6c3a 2073 7472  ity], model: str
-000228e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000228f0: 2020 2020 2020 696e 6e65 725f 7261 6469        inner_radi
-00022900: 7573 3a20 556e 696f 6e5b 7374 722c 2051  us: Union[str, Q
-00022910: 7561 6e74 6974 795d 203d 2051 7561 6e74  uantity] = Quant
-00022920: 6974 7928 302c 2027 6172 6373 6563 2729  ity(0, 'arcsec')
-00022930: 2c20 7061 723a 2073 7472 203d 204e 6f6e  , par: str = Non
-00022940: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00022950: 2020 2020 2020 2067 726f 7570 5f73 7065         group_spe
-00022960: 633a 2062 6f6f 6c20 3d20 5472 7565 2c20  c: bool = True, 
-00022970: 6d69 6e5f 636f 756e 7473 3a20 696e 7420  min_counts: int 
-00022980: 3d20 352c 206d 696e 5f73 6e3a 2066 6c6f  = 5, min_sn: flo
-00022990: 6174 203d 204e 6f6e 652c 206f 7665 725f  at = None, over_
-000229a0: 7361 6d70 6c65 3a20 666c 6f61 7420 3d20  sample: float = 
-000229b0: 4e6f 6e65 293a 0a20 2020 2020 2020 2022  None):.        "
-000229c0: 2222 0a20 2020 2020 2020 2049 6d70 6f72  "".        Impor
-000229d0: 7461 6e74 206d 6574 686f 6420 7468 6174  tant method that
-000229e0: 2077 696c 6c20 7265 7472 6965 7665 2066   will retrieve f
-000229f0: 6974 2072 6573 756c 7473 2066 726f 6d20  it results from 
-00022a00: 7468 6520 736f 7572 6365 206f 626a 6563  the source objec
-00022a10: 742e 2045 6974 6865 7220 666f 7220 6120  t. Either for a 
-00022a20: 7370 6563 6966 6963 0a20 2020 2020 2020  specific.       
-00022a30: 2070 6172 616d 6574 6572 206f 6620 6120   parameter of a 
-00022a40: 6769 7665 6e20 7265 6769 6f6e 2d6d 6f64  given region-mod
-00022a50: 656c 2063 6f6d 6269 6e61 7469 6f6e 2c20  el combination, 
-00022a60: 6f72 2066 6f72 2061 6c6c 206f 6620 7468  or for all of th
-00022a70: 656d 2e20 4966 2061 2073 7065 6369 6669  em. If a specifi
-00022a80: 6320 7061 7261 6d65 7465 7220 6973 2072  c parameter is r
-00022a90: 6571 7565 7374 6564 2c0a 2020 2020 2020  equested,.      
-00022aa0: 2020 616c 6c20 6d61 7463 6869 6e67 2076    all matching v
-00022ab0: 616c 7565 7320 6672 6f6d 2074 6865 2066  alues from the f
-00022ac0: 6974 2077 696c 6c20 6265 2072 6574 7572  it will be retur
-00022ad0: 6e65 6420 696e 2061 6e20 4e20 726f 772c  ned in an N row,
-00022ae0: 2033 2063 6f6c 756d 6e20 6e75 6d70 7920   3 column numpy 
-00022af0: 6172 7261 7920 2863 6f6c 756d 6e20 3020  array (column 0 
-00022b00: 6973 2074 6865 2076 616c 7565 2c0a 2020  is the value,.  
-00022b10: 2020 2020 2020 636f 6c75 6d6e 2031 2069        column 1 i
-00022b20: 7320 6572 722d 2c20 616e 6420 636f 6c75  s err-, and colu
-00022b30: 6d6e 2032 2069 7320 6572 722b 292e 2049  mn 2 is err+). I
-00022b40: 6620 6e6f 2070 6172 616d 6574 6572 2069  f no parameter i
-00022b50: 7320 7370 6563 6966 6965 642c 2074 6865  s specified, the
-00022b60: 2072 6574 7572 6e20 7769 6c6c 2062 6520   return will be 
-00022b70: 6120 6469 6374 696f 6e61 7279 0a20 2020  a dictionary.   
-00022b80: 2020 2020 206f 6620 7375 6368 206e 756d       of such num
-00022b90: 7079 2061 7272 6179 732c 2077 6974 6820  py arrays, with 
-00022ba0: 7468 6520 6b65 7973 2063 6f72 7265 7370  the keys corresp
-00022bb0: 6f6e 6469 6e67 2074 6f20 7061 7261 6d65  onding to parame
-00022bc0: 7465 7220 6e61 6d65 732e 0a0a 2020 2020  ter names...    
-00022bd0: 2020 2020 3a70 6172 616d 2073 7472 2f51      :param str/Q
-00022be0: 7561 6e74 6974 7920 6f75 7465 725f 7261  uantity outer_ra
-00022bf0: 6469 7573 3a20 5468 6520 6e61 6d65 206f  dius: The name o
-00022c00: 7220 7661 6c75 6520 6f66 2074 6865 206f  r value of the o
-00022c10: 7574 6572 2072 6164 6975 7320 7468 6174  uter radius that
-00022c20: 2077 6173 2075 7365 6420 666f 7220 7468   was used for th
-00022c30: 6520 6765 6e65 7261 7469 6f6e 206f 660a  e generation of.
-00022c40: 2020 2020 2020 2020 2020 2020 7468 6520              the 
-00022c50: 7370 6563 7472 6120 7768 6963 6820 7765  spectra which we
-00022c60: 7265 2066 6974 7465 6420 746f 2070 726f  re fitted to pro
-00022c70: 6475 6365 2074 6865 2064 6573 6972 6564  duce the desired
-00022c80: 2072 6573 756c 7420 2866 6f72 2069 6e73   result (for ins
-00022c90: 7461 6e63 6520 2772 3230 3027 2077 6f75  tance 'r200' wou
-00022ca0: 6c64 2062 6520 6163 6365 7074 6162 6c65  ld be acceptable
-00022cb0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00022cc0: 2061 2047 616c 6178 7943 6c75 7374 6572   a GalaxyCluster
-00022cd0: 2c20 6f72 2051 7561 6e74 6974 7928 3130  , or Quantity(10
-00022ce0: 3030 2c20 276b 7063 2729 292e 2049 6620  00, 'kpc')). If 
-00022cf0: 2772 6567 696f 6e27 2069 7320 6368 6f73  'region' is chos
-00022d00: 656e 2028 746f 2075 7365 2074 6865 2072  en (to use the r
-00022d10: 6567 696f 6e73 2069 6e0a 2020 2020 2020  egions in.      
-00022d20: 2020 2020 2020 7265 6769 6f6e 2066 696c        region fil
-00022d30: 6573 292c 2074 6865 6e20 616e 7920 696e  es), then any in
-00022d40: 6e65 7220 7261 6469 7573 2077 696c 6c20  ner radius will 
-00022d50: 6265 2069 676e 6f72 6564 2e0a 2020 2020  be ignored..    
-00022d60: 2020 2020 3a70 6172 616d 2073 7472 206d      :param str m
-00022d70: 6f64 656c 3a20 5468 6520 6e61 6d65 206f  odel: The name o
-00022d80: 6620 7468 6520 6669 7474 6564 206d 6f64  f the fitted mod
-00022d90: 656c 2074 6861 7420 796f 7527 7265 2072  el that you're r
-00022da0: 6571 7565 7374 696e 6720 7468 6520 7265  equesting the re
-00022db0: 7375 6c74 730a 2020 2020 2020 2020 2020  sults.          
-00022dc0: 2020 6672 6f6d 2028 652e 672e 2063 6f6e    from (e.g. con
-00022dd0: 7374 616e 742a 7462 6162 732a 6170 6563  stant*tbabs*apec
-00022de0: 292e 0a20 2020 2020 2020 203a 7061 7261  )..        :para
-00022df0: 6d20 7374 722f 5175 616e 7469 7479 2069  m str/Quantity i
-00022e00: 6e6e 6572 5f72 6164 6975 733a 2054 6865  nner_radius: The
-00022e10: 206e 616d 6520 6f72 2076 616c 7565 206f   name or value o
-00022e20: 6620 7468 6520 696e 6e65 7220 7261 6469  f the inner radi
-00022e30: 7573 2074 6861 7420 7761 7320 7573 6564  us that was used
-00022e40: 2066 6f72 2074 6865 2067 656e 6572 6174   for the generat
-00022e50: 696f 6e20 6f66 0a20 2020 2020 2020 2020  ion of.         
-00022e60: 2020 2074 6865 2073 7065 6374 7261 2077     the spectra w
-00022e70: 6869 6368 2077 6572 6520 6669 7474 6564  hich were fitted
-00022e80: 2074 6f20 7072 6f64 7563 6520 7468 6520   to produce the 
-00022e90: 6465 7369 7265 6420 7265 7375 6c74 2028  desired result (
-00022ea0: 666f 7220 696e 7374 616e 6365 2027 7235  for instance 'r5
-00022eb0: 3030 2720 776f 756c 6420 6265 2061 6363  00' would be acc
-00022ec0: 6570 7461 626c 650a 2020 2020 2020 2020  eptable.        
-00022ed0: 2020 2020 666f 7220 6120 4761 6c61 7879      for a Galaxy
-00022ee0: 436c 7573 7465 722c 206f 7220 5175 616e  Cluster, or Quan
-00022ef0: 7469 7479 2833 3030 2c20 276b 7063 2729  tity(300, 'kpc')
-00022f00: 292e 2042 7920 6465 6661 756c 7420 7468  ). By default th
-00022f10: 6973 2069 7320 7a65 726f 2061 7263 7365  is is zero arcse
-00022f20: 636f 6e64 732c 2072 6573 756c 7469 6e67  conds, resulting
-00022f30: 2069 6e20 610a 2020 2020 2020 2020 2020   in a.          
-00022f40: 2020 6369 7263 756c 6172 2073 7065 6374    circular spect
-00022f50: 7275 6d2e 0a20 2020 2020 2020 203a 7061  rum..        :pa
-00022f60: 7261 6d20 7374 7220 7061 723a 2054 6865  ram str par: The
-00022f70: 206e 616d 6520 6f66 2074 6865 2070 6172   name of the par
-00022f80: 616d 6574 6572 2079 6f75 2077 616e 7420  ameter you want 
-00022f90: 6120 7265 7375 6c74 2066 6f72 2e0a 2020  a result for..  
-00022fa0: 2020 2020 2020 3a70 6172 616d 2062 6f6f        :param boo
-00022fb0: 6c20 6772 6f75 705f 7370 6563 3a20 5768  l group_spec: Wh
-00022fc0: 6574 6865 7220 7468 6520 7370 6563 7472  ether the spectr
-00022fd0: 6120 7468 6174 2077 6572 6520 6669 7474  a that were fitt
-00022fe0: 6564 2066 6f72 2074 6865 2064 6573 6972  ed for the desir
-00022ff0: 6564 2072 6573 756c 7420 7765 7265 2067  ed result were g
-00023000: 726f 7570 6564 2e0a 2020 2020 2020 2020  rouped..        
-00023010: 3a70 6172 616d 2066 6c6f 6174 206d 696e  :param float min
-00023020: 5f63 6f75 6e74 733a 2054 6865 206d 696e  _counts: The min
-00023030: 696d 756d 2063 6f75 6e74 7320 7065 7220  imum counts per 
-00023040: 6368 616e 6e65 6c2c 2069 6620 7468 6520  channel, if the 
-00023050: 7370 6563 7472 6120 7468 6174 2077 6572  spectra that wer
-00023060: 6520 6669 7474 6564 2066 6f72 2074 6865  e fitted for the
-00023070: 0a20 2020 2020 2020 2020 2020 2064 6573  .            des
-00023080: 6972 6564 2072 6573 756c 7420 7765 7265  ired result were
-00023090: 2067 726f 7570 6564 2062 7920 6d69 6e69   grouped by mini
-000230a0: 6d75 6d20 636f 756e 7473 2e0a 2020 2020  mum counts..    
-000230b0: 2020 2020 3a70 6172 616d 2066 6c6f 6174      :param float
-000230c0: 206d 696e 5f73 6e3a 2054 6865 206d 696e   min_sn: The min
-000230d0: 696d 756d 2073 6967 6e61 6c20 746f 206e  imum signal to n
-000230e0: 6f69 7365 2070 6572 2063 6861 6e6e 656c  oise per channel
-000230f0: 2c20 6966 2074 6865 2073 7065 6374 7261  , if the spectra
-00023100: 2074 6861 7420 7765 7265 2066 6974 7465   that were fitte
-00023110: 6420 666f 7220 7468 650a 2020 2020 2020  d for the.      
-00023120: 2020 2020 2020 6465 7369 7265 6420 7265        desired re
-00023130: 7375 6c74 2077 6572 6520 6772 6f75 7065  sult were groupe
-00023140: 6420 6279 206d 696e 696d 756d 2073 6967  d by minimum sig
-00023150: 6e61 6c20 746f 206e 6f69 7365 2e0a 2020  nal to noise..  
-00023160: 2020 2020 2020 3a70 6172 616d 2066 6c6f        :param flo
-00023170: 6174 206f 7665 725f 7361 6d70 6c65 3a20  at over_sample: 
-00023180: 5468 6520 6c65 7665 6c20 6f66 206f 7665  The level of ove
-00023190: 7273 616d 706c 696e 6720 6170 706c 6965  rsampling applie
-000231a0: 6420 6f6e 2074 6865 2073 7065 6374 7261  d on the spectra
-000231b0: 2074 6861 7420 7765 7265 2066 6974 7465   that were fitte
-000231c0: 642e 0a20 2020 2020 2020 203a 7265 7475  d..        :retu
-000231d0: 726e 3a20 5468 6520 7265 7175 6573 7465  rn: The requeste
-000231e0: 6420 7265 7375 6c74 2076 616c 7565 2c20  d result value, 
-000231f0: 616e 6420 756e 6365 7274 6169 6e74 6965  and uncertaintie
-00023200: 732e 0a20 2020 2020 2020 2022 2222 0a20  s..        """. 
-00023210: 2020 2020 2020 2023 2046 6972 7374 2049         # First I
-00023220: 2077 616e 7420 746f 2072 6574 7269 6576   want to retriev
-00023230: 6520 7468 6520 7370 6563 7472 6120 7468  e the spectra th
-00023240: 6174 2077 6572 6520 6669 7474 6564 2074  at were fitted t
-00023250: 6f20 7072 6f64 7563 6520 7468 6520 7265  o produce the re
-00023260: 7375 6c74 2074 6865 7927 7265 206c 6f6f  sult they're loo
-00023270: 6b69 6e67 2066 6f72 2c0a 2020 2020 2020  king for,.      
-00023280: 2020 2320 2062 6563 6175 7365 2074 6865    #  because the
-00023290: 6e20 4920 6361 6e20 6a75 7374 2067 7261  n I can just gra
-000232a0: 6220 7468 6520 7374 6f72 6167 6520 6b65  b the storage ke
-000232b0: 7920 6672 6f6d 206f 6e65 206f 6620 7468  y from one of th
-000232c0: 656d 0a20 2020 2020 2020 2073 7065 6373  em.        specs
-000232d0: 203d 2073 656c 662e 6765 745f 7370 6563   = self.get_spec
-000232e0: 7472 6128 6f75 7465 725f 7261 6469 7573  tra(outer_radius
-000232f0: 2c20 4e6f 6e65 2c20 4e6f 6e65 2c20 696e  , None, None, in
-00023300: 6e65 725f 7261 6469 7573 2c20 6772 6f75  ner_radius, grou
-00023310: 705f 7370 6563 2c20 6d69 6e5f 636f 756e  p_spec, min_coun
-00023320: 7473 2c20 6d69 6e5f 736e 2c20 6f76 6572  ts, min_sn, over
-00023330: 5f73 616d 706c 6529 0a20 2020 2020 2020  _sample).       
-00023340: 2023 2049 206a 7573 7420 7461 6b65 2074   # I just take t
-00023350: 6865 2066 6972 7374 2073 7065 6374 7275  he first spectru
-00023360: 6d20 696e 2074 6865 206c 6973 7420 6265  m in the list be
-00023370: 6361 7573 6520 7468 6520 7374 6f72 6167  cause the storag
-00023380: 6520 6b65 7920 7769 6c6c 2062 6520 7468  e key will be th
-00023390: 6520 7361 6d65 2066 6f72 2061 6c6c 206f  e same for all o
-000233a0: 6620 7468 656d 0a20 2020 2020 2020 2069  f them.        i
-000233b0: 6620 6973 696e 7374 616e 6365 2873 7065  f isinstance(spe
-000233c0: 6373 2c20 6c69 7374 293a 0a20 2020 2020  cs, list):.     
-000233d0: 2020 2020 2020 2073 746f 7261 6765 5f6b         storage_k
-000233e0: 6579 203d 2073 7065 6373 5b30 5d2e 7374  ey = specs[0].st
-000233f0: 6f72 6167 655f 6b65 790a 2020 2020 2020  orage_key.      
-00023400: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00023410: 2020 2020 7374 6f72 6167 655f 6b65 7920      storage_key 
-00023420: 3d20 7370 6563 732e 7374 6f72 6167 655f  = specs.storage_
-00023430: 6b65 790a 0a20 2020 2020 2020 2023 2042  key..        # B
-00023440: 756e 6368 206f 6620 6368 6563 6b73 2074  unch of checks t
-00023450: 6f20 6d61 6b65 2073 7572 6520 7468 6520  o make sure the 
-00023460: 7265 7175 6573 7465 6420 7265 7375 6c74  requested result
-00023470: 7320 6163 7475 616c 6c79 2065 7869 7374  s actually exist
-00023480: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
-00023490: 7365 6c66 2e5f 6669 745f 7265 7375 6c74  self._fit_result
-000234a0: 7329 203d 3d20 303a 0a20 2020 2020 2020  s) == 0:.       
-000234b0: 2020 2020 2072 6169 7365 204d 6f64 656c       raise Model
-000234c0: 4e6f 7441 7373 6f63 6961 7465 6445 7272  NotAssociatedErr
-000234d0: 6f72 2822 5468 6572 6520 6172 6520 6e6f  or("There are no
-000234e0: 2058 5350 4543 2066 6974 7320 6173 736f   XSPEC fits asso
-000234f0: 6369 6174 6564 2077 6974 6820 7b73 7d22  ciated with {s}"
-00023500: 2e66 6f72 6d61 7428 733d 7365 6c66 2e6e  .format(s=self.n
-00023510: 616d 6529 290a 2020 2020 2020 2020 656c  ame)).        el
-00023520: 6966 2073 746f 7261 6765 5f6b 6579 206e  if storage_key n
-00023530: 6f74 2069 6e20 7365 6c66 2e5f 6669 745f  ot in self._fit_
-00023540: 7265 7375 6c74 733a 0a20 2020 2020 2020  results:.       
-00023550: 2020 2020 2072 6169 7365 204d 6f64 656c       raise Model
-00023560: 4e6f 7441 7373 6f63 6961 7465 6445 7272  NotAssociatedErr
-00023570: 6f72 2822 5468 6f73 6520 7370 6563 7472  or("Those spectr
-00023580: 6120 6861 7665 206e 6f20 6173 736f 6369  a have no associ
-00023590: 6174 6564 2058 5350 4543 2066 6974 2074  ated XSPEC fit t
-000235a0: 6f20 7b73 7d22 2e66 6f72 6d61 7428 733d  o {s}".format(s=
-000235b0: 7365 6c66 2e6e 616d 6529 290a 2020 2020  self.name)).    
-000235c0: 2020 2020 656c 6966 206d 6f64 656c 206e      elif model n
-000235d0: 6f74 2069 6e20 7365 6c66 2e5f 6669 745f  ot in self._fit_
-000235e0: 7265 7375 6c74 735b 7374 6f72 6167 655f  results[storage_
-000235f0: 6b65 795d 3a0a 2020 2020 2020 2020 2020  key]:.          
-00023600: 2020 6176 5f6d 6f64 7320 3d20 222c 2022    av_mods = ", "
-00023610: 2e6a 6f69 6e28 7365 6c66 2e5f 6669 745f  .join(self._fit_
-00023620: 7265 7375 6c74 735b 7374 6f72 6167 655f  results[storage_
-00023630: 6b65 795d 2e6b 6579 7328 2929 0a20 2020  key].keys()).   
-00023640: 2020 2020 2020 2020 2072 6169 7365 204d           raise M
-00023650: 6f64 656c 4e6f 7441 7373 6f63 6961 7465  odelNotAssociate
-00023660: 6445 7272 6f72 2822 7b6d 7d20 6861 7320  dError("{m} has 
-00023670: 6e6f 7420 6265 656e 2066 6974 7465 6420  not been fitted 
-00023680: 746f 2074 686f 7365 2073 7065 6374 7261  to those spectra
-00023690: 206f 6620 7b73 7d3b 2061 7661 696c 6162   of {s}; availab
-000236a0: 6c65 2022 0a20 2020 2020 2020 2020 2020  le ".           
-000236b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000236c0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-000236d0: 6d6f 6465 6c73 2061 7265 207b 617d 222e  models are {a}".
-000236e0: 666f 726d 6174 286d 3d6d 6f64 656c 2c20  format(m=model, 
-000236f0: 733d 7365 6c66 2e6e 616d 652c 2061 3d61  s=self.name, a=a
-00023700: 765f 6d6f 6473 2929 0a20 2020 2020 2020  v_mods)).       
-00023710: 2065 6c69 6620 7061 7220 6973 206e 6f74   elif par is not
-00023720: 204e 6f6e 6520 616e 6420 7061 7220 6e6f   None and par no
-00023730: 7420 696e 2073 656c 662e 5f66 6974 5f72  t in self._fit_r
-00023740: 6573 756c 7473 5b73 746f 7261 6765 5f6b  esults[storage_k
-00023750: 6579 5d5b 6d6f 6465 6c5d 3a0a 2020 2020  ey][model]:.    
-00023760: 2020 2020 2020 2020 6176 5f70 6172 7320          av_pars 
-00023770: 3d20 222c 2022 2e6a 6f69 6e28 7365 6c66  = ", ".join(self
-00023780: 2e5f 6669 745f 7265 7375 6c74 735b 7374  ._fit_results[st
-00023790: 6f72 6167 655f 6b65 795d 5b6d 6f64 656c  orage_key][model
-000237a0: 5d2e 6b65 7973 2829 290a 2020 2020 2020  ].keys()).      
-000237b0: 2020 2020 2020 7261 6973 6520 5061 7261        raise Para
-000237c0: 6d65 7465 724e 6f74 4173 736f 6369 6174  meterNotAssociat
-000237d0: 6564 4572 726f 7228 227b 707d 2077 6173  edError("{p} was
-000237e0: 206e 6f74 2061 2066 7265 6520 7061 7261   not a free para
-000237f0: 6d65 7465 7220 696e 2074 6865 207b 6d7d  meter in the {m}
-00023800: 2066 6974 2074 6f20 7b73 7d2c 2022 0a20   fit to {s}, ". 
+00021220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021240: 2072 6f74 3d72 6f74 5f61 6e67 6c65 2e74   rot=rot_angle.t
+00021250: 6f28 2764 6567 2729 2e72 6f75 6e64 2834  o('deg').round(4
+00021260: 292e 7661 6c75 6529 0a20 2020 2020 2020  ).value).       
+00021270: 2065 6c69 6620 6e6f 7420 696e 6e65 725f   elif not inner_
+00021280: 7261 6469 7573 2e69 7373 6361 6c61 7220  radius.isscalar 
+00021290: 616e 6420 696e 6e65 725f 7261 6469 7573  and inner_radius
+000212a0: 5b30 5d2e 7661 6c75 6520 3d3d 2030 3a0a  [0].value == 0:.
+000212b0: 2020 2020 2020 2020 2020 2020 7361 735f              sas_
+000212c0: 736f 7572 6365 5f61 7265 6120 3d20 2228  source_area = "(
+000212d0: 287b 747d 2920 494e 2065 6c6c 6970 7365  ({t}) IN ellipse
+000212e0: 287b 6378 7d2c 7b63 797d 2c7b 777d 2c7b  ({cx},{cy},{w},{
+000212f0: 687d 2c7b 726f 747d 2929 220a 2020 2020  h},{rot}))".    
+00021300: 2020 2020 2020 2020 7361 735f 736f 7572          sas_sour
+00021310: 6365 5f61 7265 6120 3d20 7361 735f 736f  ce_area = sas_so
+00021320: 7572 6365 5f61 7265 612e 666f 726d 6174  urce_area.format
+00021330: 2874 3d63 5f73 7472 2c20 6378 3d78 6d6d  (t=c_str, cx=xmm
+00021340: 5f63 656e 7472 616c 5f63 6f6f 7264 5b30  _central_coord[0
+00021350: 5d2e 726f 756e 6428 3429 2e76 616c 7565  ].round(4).value
+00021360: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00021370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021390: 2020 2020 2020 2063 793d 786d 6d5f 6365         cy=xmm_ce
+000213a0: 6e74 7261 6c5f 636f 6f72 645b 315d 2e72  ntral_coord[1].r
+000213b0: 6f75 6e64 2834 292e 7661 6c75 652c 0a20  ound(4).value,. 
+000213c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000213d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000213e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000213f0: 2020 2020 773d 286f 7574 6572 5f72 6164      w=(outer_rad
+00021400: 6975 735b 305d 2e76 616c 7565 202f 2073  ius[0].value / s
+00021410: 6b79 5f74 6f5f 6465 6729 2e72 6f75 6e64  ky_to_deg).round
+00021420: 2834 292c 0a20 2020 2020 2020 2020 2020  (4),.           
+00021430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021450: 2020 2020 2020 2020 2020 683d 286f 7574            h=(out
+00021460: 6572 5f72 6164 6975 735b 315d 2e76 616c  er_radius[1].val
+00021470: 7565 202f 2073 6b79 5f74 6f5f 6465 6729  ue / sky_to_deg)
+00021480: 2e72 6f75 6e64 2834 292c 0a20 2020 2020  .round(4),.     
+00021490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000214a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000214b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000214c0: 726f 743d 726f 745f 616e 676c 652e 746f  rot=rot_angle.to
+000214d0: 2827 6465 6727 292e 726f 756e 6428 3429  ('deg').round(4)
+000214e0: 2e76 616c 7565 290a 0a20 2020 2020 2020  .value)..       
+000214f0: 2023 2043 6f6d 6269 6e69 6e67 2074 6865   # Combining the
+00021500: 2073 6f75 7263 6520 7265 6769 6f6e 2077   source region w
+00021510: 6974 6820 7468 6520 7265 6769 6f6e 7320  ith the regions 
+00021520: 7765 206e 6565 6420 746f 2063 7574 206f  we need to cut o
+00021530: 7574 0a20 2020 2020 2020 2069 6620 6c65  ut.        if le
+00021540: 6e28 7361 735f 696e 7465 726c 6f70 6572  n(sas_interloper
+00021550: 2920 3d3d 2030 3a0a 2020 2020 2020 2020  ) == 0:.        
+00021560: 2020 2020 6669 6e61 6c5f 7372 6320 3d20      final_src = 
+00021570: 7361 735f 736f 7572 6365 5f61 7265 610a  sas_source_area.
+00021580: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00021590: 2020 2020 2020 2020 2020 6669 6e61 6c5f            final_
+000215a0: 7372 6320 3d20 7361 735f 736f 7572 6365  src = sas_source
+000215b0: 5f61 7265 6120 2b20 2220 2626 2120 2220  _area + " &&! " 
+000215c0: 2b20 2220 2626 2120 222e 6a6f 696e 2873  + " &&! ".join(s
+000215d0: 6173 5f69 6e74 6572 6c6f 7065 7229 0a0a  as_interloper)..
+000215e0: 2020 2020 2020 2020 7265 7475 726e 2066          return f
+000215f0: 696e 616c 5f73 7263 0a0a 2020 2020 4070  inal_src..    @p
+00021600: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
+00021610: 6e48 2873 656c 6629 202d 3e20 5175 616e  nH(self) -> Quan
+00021620: 7469 7479 3a0a 2020 2020 2020 2020 2222  tity:.        ""
+00021630: 220a 2020 2020 2020 2020 5072 6f70 6572  ".        Proper
+00021640: 7479 2067 6574 7465 7220 666f 7220 6e65  ty getter for ne
+00021650: 7574 7261 6c20 6879 6472 6f67 656e 2063  utral hydrogen c
+00021660: 6f6c 756d 6e20 6174 7472 6962 7574 652e  olumn attribute.
+00021670: 0a0a 2020 2020 2020 2020 3a72 6574 7572  ..        :retur
+00021680: 6e3a 204e 6575 7472 616c 2068 7964 726f  n: Neutral hydro
+00021690: 6765 6e20 636f 6c75 6d6e 2073 7572 6661  gen column surfa
+000216a0: 6365 2064 656e 7369 7479 2e0a 2020 2020  ce density..    
+000216b0: 2020 2020 3a72 7479 7065 3a20 5175 616e      :rtype: Quan
+000216c0: 7469 7479 0a20 2020 2020 2020 2022 2222  tity.        """
+000216d0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000216e0: 7365 6c66 2e5f 6e48 0a0a 2020 2020 4070  self._nH..    @p
+000216f0: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
+00021700: 7265 6473 6869 6674 2873 656c 6629 202d  redshift(self) -
+00021710: 3e20 666c 6f61 743a 0a20 2020 2020 2020  > float:.       
+00021720: 2022 2222 0a20 2020 2020 2020 2050 726f   """.        Pro
+00021730: 7065 7274 7920 6765 7474 6572 2066 6f72  perty getter for
+00021740: 2074 6865 2072 6564 7368 6966 7420 6f66   the redshift of
+00021750: 2074 6869 7320 736f 7572 6365 206f 626a   this source obj
+00021760: 6563 742e 0a0a 2020 2020 2020 2020 3a72  ect...        :r
+00021770: 6574 7572 6e3a 2052 6564 7368 6966 7420  eturn: Redshift 
+00021780: 7661 6c75 650a 2020 2020 2020 2020 3a72  value.        :r
+00021790: 7479 7065 3a20 666c 6f61 740a 2020 2020  type: float.    
+000217a0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+000217b0: 7265 7475 726e 2073 656c 662e 5f72 6564  return self._red
+000217c0: 7368 6966 740a 0a20 2020 2040 7072 6f70  shift..    @prop
+000217d0: 6572 7479 0a20 2020 2064 6566 206f 6e5f  erty.    def on_
+000217e0: 6178 6973 5f6f 6273 5f69 6473 2873 656c  axis_obs_ids(sel
+000217f0: 6629 202d 3e20 6c69 7374 3a0a 2020 2020  f) -> list:.    
+00021800: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00021810: 5468 6973 206d 6574 686f 6420 7265 7475  This method retu
+00021820: 726e 7320 616e 2061 7272 6179 206f 6620  rns an array of 
+00021830: 4f62 7349 4473 2074 6861 7420 7468 6973  ObsIDs that this
+00021840: 2073 6f75 7263 6520 6973 2061 7070 726f   source is appro
+00021850: 7869 6d61 7465 6c79 206f 6e20 6178 6973  ximately on axis
+00021860: 2069 6e2e 0a0a 2020 2020 2020 2020 3a72   in...        :r
+00021870: 6574 7572 6e3a 204f 6273 4944 7320 666f  eturn: ObsIDs fo
+00021880: 7220 7768 6963 6820 7468 6520 736f 7572  r which the sour
+00021890: 6365 2069 7320 6170 7072 6f78 696d 6174  ce is approximat
+000218a0: 656c 7920 6f6e 2061 7869 732e 0a20 2020  ely on axis..   
+000218b0: 2020 2020 203a 7274 7970 653a 206c 6973       :rtype: lis
+000218c0: 740a 2020 2020 2020 2020 2222 220a 2020  t.        """.  
+000218d0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+000218e0: 662e 5f6f 6e61 7869 730a 0a20 2020 2040  f._onaxis..    @
+000218f0: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
+00021900: 2063 6f73 6d6f 2873 656c 6629 202d 3e20   cosmo(self) -> 
+00021910: 436f 736d 6f6c 6f67 793a 0a20 2020 2020  Cosmology:.     
+00021920: 2020 2022 2222 0a20 2020 2020 2020 2054     """.        T
+00021930: 6869 7320 6d65 7468 6f64 2072 6574 7572  his method retur
+00021940: 6e73 2077 6861 7465 7665 7220 636f 736d  ns whatever cosm
+00021950: 6f6c 6f67 7920 6f62 6a65 6374 2069 7320  ology object is 
+00021960: 6173 736f 6369 6174 6564 2077 6974 6820  associated with 
+00021970: 7468 6973 2073 6f75 7263 6520 6f62 6a65  this source obje
+00021980: 6374 2e0a 0a20 2020 2020 2020 203a 7265  ct...        :re
+00021990: 7475 726e 3a20 416e 2061 7374 726f 7079  turn: An astropy
+000219a0: 2063 6f73 6d6f 6c6f 6779 206f 626a 6563   cosmology objec
+000219b0: 7420 7370 6563 6966 6965 6420 666f 7220  t specified for 
+000219c0: 7468 6973 2073 6f75 7263 6520 6f6e 2069  this source on i
+000219d0: 6e69 7469 616c 697a 6174 696f 6e2e 0a20  nitialization.. 
+000219e0: 2020 2020 2020 203a 7274 7970 653a 2043         :rtype: C
+000219f0: 6f73 6d6f 6c6f 6779 0a20 2020 2020 2020  osmology.       
+00021a00: 2022 2222 0a20 2020 2020 2020 2072 6574   """.        ret
+00021a10: 7572 6e20 7365 6c66 2e5f 636f 736d 6f0a  urn self._cosmo.
+00021a20: 0a20 2020 2023 2054 6869 7320 6973 2075  .    # This is u
+00021a30: 7365 6420 746f 206e 616d 6520 6669 6c65  sed to name file
+00021a40: 7320 616e 6420 6469 7265 6374 6f72 6965  s and directorie
+00021a50: 7320 736f 2074 6869 7320 6973 206e 6f74  s so this is not
+00021a60: 2061 6c6c 6f77 6564 2074 6f20 6368 616e   allowed to chan
+00021a70: 6765 2e0a 2020 2020 4070 726f 7065 7274  ge..    @propert
+00021a80: 790a 2020 2020 6465 6620 6e61 6d65 2873  y.    def name(s
+00021a90: 656c 6629 202d 3e20 7374 723a 0a20 2020  elf) -> str:.   
+00021aa0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00021ab0: 2054 6865 206e 616d 6520 6f66 2074 6865   The name of the
+00021ac0: 2073 6f75 7263 652c 2065 6974 6865 7220   source, either 
+00021ad0: 6769 7665 6e20 6174 2069 6e69 7469 616c  given at initial
+00021ae0: 6973 6174 696f 6e20 6f72 2067 656e 6572  isation or gener
+00021af0: 6174 6564 2066 726f 6d20 7468 6520 7573  ated from the us
+00021b00: 6572 2d73 7570 706c 6965 6420 636f 6f72  er-supplied coor
+00021b10: 6469 6e61 7465 732e 0a0a 2020 2020 2020  dinates...      
+00021b20: 2020 3a72 6574 7572 6e3a 2054 6865 206e    :return: The n
+00021b30: 616d 6520 6f66 2074 6865 2073 6f75 7263  ame of the sourc
+00021b40: 652e 0a20 2020 2020 2020 203a 7274 7970  e..        :rtyp
+00021b50: 653a 2073 7472 0a20 2020 2020 2020 2022  e: str.        "
+00021b60: 2222 0a20 2020 2020 2020 2072 6574 7572  "".        retur
+00021b70: 6e20 7365 6c66 2e5f 6e61 6d65 0a0a 2020  n self._name..  
+00021b80: 2020 6465 6620 6164 645f 6669 745f 6461    def add_fit_da
+00021b90: 7461 2873 656c 662c 206d 6f64 656c 3a20  ta(self, model: 
+00021ba0: 7374 722c 2074 6162 5f6c 696e 652c 206c  str, tab_line, l
+00021bb0: 756d 733a 2064 6963 742c 2073 7065 635f  ums: dict, spec_
+00021bc0: 7374 6f72 6167 655f 6b65 793a 2073 7472  storage_key: str
+00021bd0: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
+00021be0: 2020 2020 2020 2041 206d 6574 686f 6420         A method 
+00021bf0: 7468 6174 2073 746f 7265 7320 6669 7420  that stores fit 
+00021c00: 7265 7375 6c74 7320 616e 6420 676c 6f62  results and glob
+00021c10: 616c 2069 6e66 6f72 6d61 7469 6f6e 2061  al information a
+00021c20: 626f 7574 2061 2074 6865 2073 6574 206f  bout a the set o
+00021c30: 6620 7370 6563 7472 6120 696e 2061 2073  f spectra in a s
+00021c40: 6f75 7263 6520 6f62 6a65 6374 2e0a 2020  ource object..  
+00021c50: 2020 2020 2020 416e 7920 7661 7269 6162        Any variab
+00021c60: 6c65 2070 6172 616d 6574 6572 7320 696e  le parameters in
+00021c70: 2074 6865 2066 6974 2061 7265 2073 746f   the fit are sto
+00021c80: 7265 6420 696e 2061 6e20 696e 7465 726e  red in an intern
+00021c90: 616c 2064 6963 7469 6f6e 6172 7920 7374  al dictionary st
+00021ca0: 7275 6374 7572 652c 2061 7320 6172 6520  ructure, as are 
+00021cb0: 616e 7920 6c75 6d69 6e6f 7369 7469 6573  any luminosities
+00021cc0: 0a20 2020 2020 2020 2063 616c 6375 6c61  .        calcula
+00021cd0: 7465 642e 204f 7468 6572 2070 6172 616d  ted. Other param
+00021ce0: 6574 6572 7320 6f66 2069 6e74 6572 6573  eters of interes
+00021cf0: 7420 6172 6520 7374 6f72 6520 696e 206f  t are store in o
+00021d00: 7468 6572 2069 6e74 6572 6e61 6c20 6174  ther internal at
+00021d10: 7472 6962 7574 6573 2e20 5468 6973 2070  tributes. This p
+00021d20: 726f 6261 626c 7920 7368 6f75 6c64 6e27  robably shouldn'
+00021d30: 740a 2020 2020 2020 2020 6576 6572 2062  t.        ever b
+00021d40: 6520 7573 6564 2062 7920 7468 6520 7573  e used by the us
+00021d50: 6572 2c20 6a75 7374 206f 7468 6572 2070  er, just other p
+00021d60: 6172 7473 206f 6620 5847 412c 2068 656e  arts of XGA, hen
+00021d70: 6365 2077 6879 2049 2776 6520 6173 6b65  ce why I've aske
+00021d80: 6420 666f 7220 6120 7370 6563 5f73 746f  d for a spec_sto
+00021d90: 7261 6765 5f6b 6579 2074 6f20 6265 2070  rage_key to be p
+00021da0: 6173 7365 640a 2020 2020 2020 2020 696e  assed.        in
+00021db0: 2072 6174 6865 7220 7468 616e 2061 6c6c   rather than all
+00021dc0: 2074 6865 2073 7065 6374 7275 6d20 636f   the spectrum co
+00021dd0: 6e66 6967 7572 6174 696f 6e20 6f70 7469  nfiguration opti
+00021de0: 6f6e 7320 696e 6469 7669 6475 616c 6c79  ons individually
+00021df0: 2e0a 0a20 2020 2020 2020 203a 7061 7261  ...        :para
+00021e00: 6d20 7374 7220 6d6f 6465 6c3a 2054 6865  m str model: The
+00021e10: 2058 5350 4543 2064 6566 696e 6974 696f   XSPEC definitio
+00021e20: 6e20 6f66 2074 6865 206d 6f64 656c 2075  n of the model u
+00021e30: 7365 6420 746f 2070 6572 666f 726d 2074  sed to perform t
+00021e40: 6865 2066 6974 2e20 652e 672e 2063 6f6e  he fit. e.g. con
+00021e50: 7374 616e 742a 7462 6162 732a 6170 6563  stant*tbabs*apec
+00021e60: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+00021e70: 7461 625f 6c69 6e65 3a20 5468 6520 7461  tab_line: The ta
+00021e80: 626c 6520 6c69 6e65 2077 6974 6820 7468  ble line with th
+00021e90: 6520 6669 7420 6461 7461 2e0a 2020 2020  e fit data..    
+00021ea0: 2020 2020 3a70 6172 616d 2064 6963 7420      :param dict 
+00021eb0: 6c75 6d73 3a20 5468 6520 7661 7269 6f75  lums: The variou
+00021ec0: 7320 6c75 6d69 6e6f 7369 7469 6573 206d  s luminosities m
+00021ed0: 6561 7375 7265 6420 6475 7269 6e67 2074  easured during t
+00021ee0: 6865 2066 6974 2e0a 2020 2020 2020 2020  he fit..        
+00021ef0: 3a70 6172 616d 2073 7472 2073 7065 635f  :param str spec_
+00021f00: 7374 6f72 6167 655f 6b65 793a 2054 6865  storage_key: The
+00021f10: 2073 746f 7261 6765 206b 6579 206f 6620   storage key of 
+00021f20: 616e 7920 7370 6563 7472 756d 2074 6861  any spectrum tha
+00021f30: 7420 7761 7320 7573 6564 2069 6e20 7468  t was used in th
+00021f40: 6973 2070 6172 7469 6375 6c61 7220 6669  is particular fi
+00021f50: 742e 2054 6865 0a20 2020 2020 2020 2020  t. The.         
+00021f60: 2020 204f 6273 4944 2061 6e64 2069 6e73     ObsID and ins
+00021f70: 7472 756d 656e 7420 7573 6564 2064 6f6e  trument used don
+00021f80: 2774 206d 6174 7465 722c 2061 7320 7468  't matter, as th
+00021f90: 6520 7374 6f72 6167 6520 6b65 7920 7769  e storage key wi
+00021fa0: 6c6c 2062 6520 7468 6520 7361 6d65 2061  ll be the same a
+00021fb0: 6e64 2069 7320 6261 7365 6420 6f66 6620  nd is based off 
+00021fc0: 6f66 2074 6865 0a20 2020 2020 2020 2020  of the.         
+00021fd0: 2020 2073 6574 7469 6e67 7320 7768 656e     settings when
+00021fe0: 2074 6865 2073 7065 6374 7261 2077 6572   the spectra wer
+00021ff0: 6520 6765 6e65 7261 7465 642e 0a20 2020  e generated..   
+00022000: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00022010: 2023 204a 7573 7420 6865 6164 6572 7320   # Just headers 
+00022020: 7468 6174 2077 696c 6c20 616c 7761 7973  that will always
+00022030: 2062 6520 7072 6573 656e 7420 696e 2074   be present in t
+00022040: 6162 5f6c 696e 6520 7468 6174 2061 7265  ab_line that are
+00022050: 206e 6f74 2066 6974 2070 6172 616d 6574   not fit paramet
+00022060: 6572 730a 2020 2020 2020 2020 6e6f 745f  ers.        not_
+00022070: 7061 7220 3d20 5b27 4d4f 4445 4c27 2c20  par = ['MODEL', 
+00022080: 2754 4f54 414c 5f45 5850 4f53 5552 4527  'TOTAL_EXPOSURE'
+00022090: 2c20 2754 4f54 414c 5f43 4f55 4e54 5f52  , 'TOTAL_COUNT_R
+000220a0: 4154 4527 2c20 2754 4f54 414c 5f43 4f55  ATE', 'TOTAL_COU
+000220b0: 4e54 5f52 4154 455f 4552 5227 2c0a 2020  NT_RATE_ERR',.  
+000220c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000220d0: 2027 4e55 4d5f 554e 4c49 4e4b 4544 5f54   'NUM_UNLINKED_T
+000220e0: 4841 5745 445f 5641 5253 272c 2027 4649  HAWED_VARS', 'FI
+000220f0: 545f 5354 4154 4953 5449 4327 2c20 2754  T_STATISTIC', 'T
+00022100: 4553 545f 5354 4154 4953 5449 4327 2c20  EST_STATISTIC', 
+00022110: 2744 4f46 275d 0a0a 2020 2020 2020 2020  'DOF']..        
+00022120: 2320 5661 7269 6f75 7320 676c 6f62 616c  # Various global
+00022130: 2076 616c 7565 7320 6f66 2069 6e74 6572   values of inter
+00022140: 6573 740a 2020 2020 2020 2020 7365 6c66  est.        self
+00022150: 2e5f 746f 7461 6c5f 6578 705b 7370 6563  ._total_exp[spec
+00022160: 5f73 746f 7261 6765 5f6b 6579 5d20 3d20  _storage_key] = 
+00022170: 666c 6f61 7428 7461 625f 6c69 6e65 5b22  float(tab_line["
+00022180: 544f 5441 4c5f 4558 504f 5355 5245 225d  TOTAL_EXPOSURE"]
+00022190: 290a 2020 2020 2020 2020 6966 2073 7065  ).        if spe
+000221a0: 635f 7374 6f72 6167 655f 6b65 7920 6e6f  c_storage_key no
+000221b0: 7420 696e 2073 656c 662e 5f74 6f74 616c  t in self._total
+000221c0: 5f63 6f75 6e74 5f72 6174 653a 0a20 2020  _count_rate:.   
+000221d0: 2020 2020 2020 2020 2073 656c 662e 5f74           self._t
+000221e0: 6f74 616c 5f63 6f75 6e74 5f72 6174 655b  otal_count_rate[
+000221f0: 7370 6563 5f73 746f 7261 6765 5f6b 6579  spec_storage_key
+00022200: 5d20 3d20 7b7d 0a20 2020 2020 2020 2020  ] = {}.         
+00022210: 2020 2073 656c 662e 5f74 6573 745f 7374     self._test_st
+00022220: 6174 5b73 7065 635f 7374 6f72 6167 655f  at[spec_storage_
+00022230: 6b65 795d 203d 207b 7d0a 2020 2020 2020  key] = {}.      
+00022240: 2020 2020 2020 7365 6c66 2e5f 646f 665b        self._dof[
+00022250: 7370 6563 5f73 746f 7261 6765 5f6b 6579  spec_storage_key
+00022260: 5d20 3d20 7b7d 0a20 2020 2020 2020 2073  ] = {}.        s
+00022270: 656c 662e 5f74 6f74 616c 5f63 6f75 6e74  elf._total_count
+00022280: 5f72 6174 655b 7370 6563 5f73 746f 7261  _rate[spec_stora
+00022290: 6765 5f6b 6579 5d5b 6d6f 6465 6c5d 203d  ge_key][model] =
+000222a0: 205b 666c 6f61 7428 7461 625f 6c69 6e65   [float(tab_line
+000222b0: 5b22 544f 5441 4c5f 434f 554e 545f 5241  ["TOTAL_COUNT_RA
+000222c0: 5445 225d 292c 0a20 2020 2020 2020 2020  TE"]),.         
+000222d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000222e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000222f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022300: 2020 666c 6f61 7428 7461 625f 6c69 6e65    float(tab_line
+00022310: 5b22 544f 5441 4c5f 434f 554e 545f 5241  ["TOTAL_COUNT_RA
+00022320: 5445 5f45 5252 225d 295d 0a20 2020 2020  TE_ERR"])].     
+00022330: 2020 2073 656c 662e 5f74 6573 745f 7374     self._test_st
+00022340: 6174 5b73 7065 635f 7374 6f72 6167 655f  at[spec_storage_
+00022350: 6b65 795d 5b6d 6f64 656c 5d20 3d20 666c  key][model] = fl
+00022360: 6f61 7428 7461 625f 6c69 6e65 5b22 5445  oat(tab_line["TE
+00022370: 5354 5f53 5441 5449 5354 4943 225d 290a  ST_STATISTIC"]).
+00022380: 2020 2020 2020 2020 7365 6c66 2e5f 646f          self._do
+00022390: 665b 7370 6563 5f73 746f 7261 6765 5f6b  f[spec_storage_k
+000223a0: 6579 5d5b 6d6f 6465 6c5d 203d 2066 6c6f  ey][model] = flo
+000223b0: 6174 2874 6162 5f6c 696e 655b 2244 4f46  at(tab_line["DOF
+000223c0: 225d 290a 0a20 2020 2020 2020 2023 2054  "])..        # T
+000223d0: 6865 2070 6172 616d 6574 6572 7320 6176  he parameters av
+000223e0: 6169 6c61 626c 6520 7769 6c6c 206f 6276  ailable will obv
+000223f0: 696f 7573 6c79 2062 6520 6479 6e61 6d69  iously be dynami
+00022400: 632c 2073 6f20 6861 7665 2074 6f20 6669  c, so have to fi
+00022410: 6e64 206f 7574 2077 6861 7420 7468 6579  nd out what they
+00022420: 2061 7265 2061 6e64 2074 6865 6e0a 2020   are and then.  
+00022430: 2020 2020 2020 2320 2074 6865 6e20 666f        #  then fo
+00022440: 7220 6561 6368 2072 6573 756c 7420 6669  r each result fi
+00022450: 6e64 2074 6865 202b 2d20 6572 726f 7273  nd the +- errors
+00022460: 0a20 2020 2020 2020 2070 6172 5f68 6561  .        par_hea
+00022470: 6465 7273 203d 205b 6e20 666f 7220 6e20  ders = [n for n 
+00022480: 696e 2074 6162 5f6c 696e 652e 6474 7970  in tab_line.dtyp
+00022490: 652e 6e61 6d65 7320 6966 206e 206e 6f74  e.names if n not
+000224a0: 2069 6e20 6e6f 745f 7061 725d 0a20 2020   in not_par].   
+000224b0: 2020 2020 206d 6f64 5f72 6573 203d 207b       mod_res = {
+000224c0: 7d0a 2020 2020 2020 2020 666f 7220 7061  }.        for pa
+000224d0: 7220 696e 2070 6172 5f68 6561 6465 7273  r in par_headers
+000224e0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+000224f0: 5468 6520 7061 7261 6d65 7465 7220 6e61  The parameter na
+00022500: 6d65 2061 6e64 2074 6865 2070 6172 616d  me and the param
+00022510: 6574 6572 2069 6e64 6578 2075 7365 6420  eter index used 
+00022520: 6279 2058 5350 4543 2061 7265 2073 6570  by XSPEC are sep
+00022530: 6172 6174 6564 2062 7920 7c0a 2020 2020  arated by |.    
+00022540: 2020 2020 2020 2020 7061 725f 696e 666f          par_info
+00022550: 203d 2070 6172 2e73 706c 6974 2822 7c22   = par.split("|"
+00022560: 290a 2020 2020 2020 2020 2020 2020 7061  ).            pa
+00022570: 725f 6e61 6d65 203d 2070 6172 5f69 6e66  r_name = par_inf
+00022580: 6f5b 305d 0a0a 2020 2020 2020 2020 2020  o[0]..          
+00022590: 2020 2320 5468 6520 7061 7261 6d65 7465    # The paramete
+000225a0: 7220 696e 6465 7820 6361 6e20 616c 736f  r index can also
+000225b0: 2068 6176 6520 616e 202d 206f 7220 2b20   have an - or + 
+000225c0: 6166 7465 7220 6974 2069 6620 7468 6520  after it if the 
+000225d0: 656e 7472 7920 696e 2071 7565 7374 696f  entry in questio
+000225e0: 6e20 6973 2061 6e20 756e 6365 7274 6169  n is an uncertai
+000225f0: 6e74 790a 2020 2020 2020 2020 2020 2020  nty.            
+00022600: 6966 2070 6172 5f69 6e66 6f5b 315d 5b2d  if par_info[1][-
+00022610: 315d 203d 3d20 222d 223a 0a20 2020 2020  1] == "-":.     
+00022620: 2020 2020 2020 2020 2020 2069 6465 6e74             ident
+00022630: 203d 2070 6172 5f69 6e66 6f5b 315d 5b3a   = par_info[1][:
+00022640: 2d31 5d0a 2020 2020 2020 2020 2020 2020  -1].            
+00022650: 2020 2020 706f 7320 3d20 310a 2020 2020      pos = 1.    
+00022660: 2020 2020 2020 2020 656c 6966 2070 6172          elif par
+00022670: 5f69 6e66 6f5b 315d 5b2d 315d 203d 3d20  _info[1][-1] == 
+00022680: 222b 223a 0a20 2020 2020 2020 2020 2020  "+":.           
+00022690: 2020 2020 2069 6465 6e74 203d 2070 6172       ident = par
+000226a0: 5f69 6e66 6f5b 315d 5b3a 2d31 5d0a 2020  _info[1][:-1].  
+000226b0: 2020 2020 2020 2020 2020 2020 2020 706f                po
+000226c0: 7320 3d20 320a 2020 2020 2020 2020 2020  s = 2.          
+000226d0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000226e0: 2020 2020 2020 2020 6964 656e 7420 3d20          ident = 
+000226f0: 7061 725f 696e 666f 5b31 5d0a 2020 2020  par_info[1].    
+00022700: 2020 2020 2020 2020 2020 2020 706f 7320              pos 
+00022710: 3d20 300a 0a20 2020 2020 2020 2020 2020  = 0..           
+00022720: 2023 2053 6574 7320 7570 2074 6865 2064   # Sets up the d
+00022730: 6963 7469 6f6e 6172 7920 7374 7275 6374  ictionary struct
+00022740: 7572 6520 666f 7220 7468 6520 7265 7375  ure for the resu
+00022750: 6c74 730a 2020 2020 2020 2020 2020 2020  lts.            
+00022760: 6966 2070 6172 5f6e 616d 6520 6e6f 7420  if par_name not 
+00022770: 696e 206d 6f64 5f72 6573 3a0a 2020 2020  in mod_res:.    
+00022780: 2020 2020 2020 2020 2020 2020 6d6f 645f              mod_
+00022790: 7265 735b 7061 725f 6e61 6d65 5d20 3d20  res[par_name] = 
+000227a0: 7b69 6465 6e74 3a20 5b30 2c20 302c 2030  {ident: [0, 0, 0
+000227b0: 5d7d 0a20 2020 2020 2020 2020 2020 2065  ]}.            e
+000227c0: 6c69 6620 6964 656e 7420 6e6f 7420 696e  lif ident not in
+000227d0: 206d 6f64 5f72 6573 5b70 6172 5f6e 616d   mod_res[par_nam
+000227e0: 655d 3a0a 2020 2020 2020 2020 2020 2020  e]:.            
+000227f0: 2020 2020 6d6f 645f 7265 735b 7061 725f      mod_res[par_
+00022800: 6e61 6d65 5d5b 6964 656e 745d 203d 205b  name][ident] = [
+00022810: 302c 2030 2c20 305d 0a0a 2020 2020 2020  0, 0, 0]..      
+00022820: 2020 2020 2020 6d6f 645f 7265 735b 7061        mod_res[pa
+00022830: 725f 6e61 6d65 5d5b 6964 656e 745d 5b70  r_name][ident][p
+00022840: 6f73 5d20 3d20 666c 6f61 7428 7461 625f  os] = float(tab_
+00022850: 6c69 6e65 5b70 6172 5d29 0a0a 2020 2020  line[par])..    
+00022860: 2020 2020 2320 5374 6f72 696e 6720 7468      # Storing th
+00022870: 6520 6669 7420 7265 7375 6c74 730a 2020  e fit results.  
+00022880: 2020 2020 2020 6966 2073 7065 635f 7374        if spec_st
+00022890: 6f72 6167 655f 6b65 7920 6e6f 7420 696e  orage_key not in
+000228a0: 2073 656c 662e 5f66 6974 5f72 6573 756c   self._fit_resul
+000228b0: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
+000228c0: 7365 6c66 2e5f 6669 745f 7265 7375 6c74  self._fit_result
+000228d0: 735b 7370 6563 5f73 746f 7261 6765 5f6b  s[spec_storage_k
+000228e0: 6579 5d20 3d20 7b7d 0a20 2020 2020 2020  ey] = {}.       
+000228f0: 2073 656c 662e 5f66 6974 5f72 6573 756c   self._fit_resul
+00022900: 7473 5b73 7065 635f 7374 6f72 6167 655f  ts[spec_storage_
+00022910: 6b65 795d 5b6d 6f64 656c 5d20 3d20 6d6f  key][model] = mo
+00022920: 645f 7265 730a 0a20 2020 2020 2020 2023  d_res..        #
+00022930: 2041 6e64 206e 6f77 2073 746f 7269 6e67   And now storing
+00022940: 2074 6865 206c 756d 696e 6f73 6974 7920   the luminosity 
+00022950: 7265 7375 6c74 730a 2020 2020 2020 2020  results.        
+00022960: 6966 2073 7065 635f 7374 6f72 6167 655f  if spec_storage_
+00022970: 6b65 7920 6e6f 7420 696e 2073 656c 662e  key not in self.
+00022980: 5f6c 756d 696e 6f73 6974 6965 733a 0a20  _luminosities:. 
+00022990: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000229a0: 5f6c 756d 696e 6f73 6974 6965 735b 7370  _luminosities[sp
+000229b0: 6563 5f73 746f 7261 6765 5f6b 6579 5d20  ec_storage_key] 
+000229c0: 3d20 7b7d 0a20 2020 2020 2020 2073 656c  = {}.        sel
+000229d0: 662e 5f6c 756d 696e 6f73 6974 6965 735b  f._luminosities[
+000229e0: 7370 6563 5f73 746f 7261 6765 5f6b 6579  spec_storage_key
+000229f0: 5d5b 6d6f 6465 6c5d 203d 206c 756d 730a  ][model] = lums.
+00022a00: 0a20 2020 2064 6566 2067 6574 5f72 6573  .    def get_res
+00022a10: 756c 7473 2873 656c 662c 206f 7574 6572  ults(self, outer
+00022a20: 5f72 6164 6975 733a 2055 6e69 6f6e 5b73  _radius: Union[s
+00022a30: 7472 2c20 5175 616e 7469 7479 5d2c 206d  tr, Quantity], m
+00022a40: 6f64 656c 3a20 7374 722c 0a20 2020 2020  odel: str,.     
+00022a50: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00022a60: 6e6e 6572 5f72 6164 6975 733a 2055 6e69  nner_radius: Uni
+00022a70: 6f6e 5b73 7472 2c20 5175 616e 7469 7479  on[str, Quantity
+00022a80: 5d20 3d20 5175 616e 7469 7479 2830 2c20  ] = Quantity(0, 
+00022a90: 2761 7263 7365 6327 292c 2070 6172 3a20  'arcsec'), par: 
+00022aa0: 7374 7220 3d20 4e6f 6e65 2c0a 2020 2020  str = None,.    
+00022ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022ac0: 6772 6f75 705f 7370 6563 3a20 626f 6f6c  group_spec: bool
+00022ad0: 203d 2054 7275 652c 206d 696e 5f63 6f75   = True, min_cou
+00022ae0: 6e74 733a 2069 6e74 203d 2035 2c20 6d69  nts: int = 5, mi
+00022af0: 6e5f 736e 3a20 666c 6f61 7420 3d20 4e6f  n_sn: float = No
+00022b00: 6e65 2c20 6f76 6572 5f73 616d 706c 653a  ne, over_sample:
+00022b10: 2066 6c6f 6174 203d 204e 6f6e 6529 3a0a   float = None):.
+00022b20: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00022b30: 2020 2020 496d 706f 7274 616e 7420 6d65      Important me
+00022b40: 7468 6f64 2074 6861 7420 7769 6c6c 2072  thod that will r
+00022b50: 6574 7269 6576 6520 6669 7420 7265 7375  etrieve fit resu
+00022b60: 6c74 7320 6672 6f6d 2074 6865 2073 6f75  lts from the sou
+00022b70: 7263 6520 6f62 6a65 6374 2e20 4569 7468  rce object. Eith
+00022b80: 6572 2066 6f72 2061 2073 7065 6369 6669  er for a specifi
+00022b90: 630a 2020 2020 2020 2020 7061 7261 6d65  c.        parame
+00022ba0: 7465 7220 6f66 2061 2067 6976 656e 2072  ter of a given r
+00022bb0: 6567 696f 6e2d 6d6f 6465 6c20 636f 6d62  egion-model comb
+00022bc0: 696e 6174 696f 6e2c 206f 7220 666f 7220  ination, or for 
+00022bd0: 616c 6c20 6f66 2074 6865 6d2e 2049 6620  all of them. If 
+00022be0: 6120 7370 6563 6966 6963 2070 6172 616d  a specific param
+00022bf0: 6574 6572 2069 7320 7265 7175 6573 7465  eter is requeste
+00022c00: 642c 0a20 2020 2020 2020 2061 6c6c 206d  d,.        all m
+00022c10: 6174 6368 696e 6720 7661 6c75 6573 2066  atching values f
+00022c20: 726f 6d20 7468 6520 6669 7420 7769 6c6c  rom the fit will
+00022c30: 2062 6520 7265 7475 726e 6564 2069 6e20   be returned in 
+00022c40: 616e 204e 2072 6f77 2c20 3320 636f 6c75  an N row, 3 colu
+00022c50: 6d6e 206e 756d 7079 2061 7272 6179 2028  mn numpy array (
+00022c60: 636f 6c75 6d6e 2030 2069 7320 7468 6520  column 0 is the 
+00022c70: 7661 6c75 652c 0a20 2020 2020 2020 2063  value,.        c
+00022c80: 6f6c 756d 6e20 3120 6973 2065 7272 2d2c  olumn 1 is err-,
+00022c90: 2061 6e64 2063 6f6c 756d 6e20 3220 6973   and column 2 is
+00022ca0: 2065 7272 2b29 2e20 4966 206e 6f20 7061   err+). If no pa
+00022cb0: 7261 6d65 7465 7220 6973 2073 7065 6369  rameter is speci
+00022cc0: 6669 6564 2c20 7468 6520 7265 7475 726e  fied, the return
+00022cd0: 2077 696c 6c20 6265 2061 2064 6963 7469   will be a dicti
+00022ce0: 6f6e 6172 790a 2020 2020 2020 2020 6f66  onary.        of
+00022cf0: 2073 7563 6820 6e75 6d70 7920 6172 7261   such numpy arra
+00022d00: 7973 2c20 7769 7468 2074 6865 206b 6579  ys, with the key
+00022d10: 7320 636f 7272 6573 706f 6e64 696e 6720  s corresponding 
+00022d20: 746f 2070 6172 616d 6574 6572 206e 616d  to parameter nam
+00022d30: 6573 2e0a 0a20 2020 2020 2020 203a 7061  es...        :pa
+00022d40: 7261 6d20 7374 722f 5175 616e 7469 7479  ram str/Quantity
+00022d50: 206f 7574 6572 5f72 6164 6975 733a 2054   outer_radius: T
+00022d60: 6865 206e 616d 6520 6f72 2076 616c 7565  he name or value
+00022d70: 206f 6620 7468 6520 6f75 7465 7220 7261   of the outer ra
+00022d80: 6469 7573 2074 6861 7420 7761 7320 7573  dius that was us
+00022d90: 6564 2066 6f72 2074 6865 2067 656e 6572  ed for the gener
+00022da0: 6174 696f 6e20 6f66 0a20 2020 2020 2020  ation of.       
+00022db0: 2020 2020 2074 6865 2073 7065 6374 7261       the spectra
+00022dc0: 2077 6869 6368 2077 6572 6520 6669 7474   which were fitt
+00022dd0: 6564 2074 6f20 7072 6f64 7563 6520 7468  ed to produce th
+00022de0: 6520 6465 7369 7265 6420 7265 7375 6c74  e desired result
+00022df0: 2028 666f 7220 696e 7374 616e 6365 2027   (for instance '
+00022e00: 7232 3030 2720 776f 756c 6420 6265 2061  r200' would be a
+00022e10: 6363 6570 7461 626c 650a 2020 2020 2020  cceptable.      
+00022e20: 2020 2020 2020 666f 7220 6120 4761 6c61        for a Gala
+00022e30: 7879 436c 7573 7465 722c 206f 7220 5175  xyCluster, or Qu
+00022e40: 616e 7469 7479 2831 3030 302c 2027 6b70  antity(1000, 'kp
+00022e50: 6327 2929 2e20 4966 2027 7265 6769 6f6e  c')). If 'region
+00022e60: 2720 6973 2063 686f 7365 6e20 2874 6f20  ' is chosen (to 
+00022e70: 7573 6520 7468 6520 7265 6769 6f6e 7320  use the regions 
+00022e80: 696e 0a20 2020 2020 2020 2020 2020 2072  in.            r
+00022e90: 6567 696f 6e20 6669 6c65 7329 2c20 7468  egion files), th
+00022ea0: 656e 2061 6e79 2069 6e6e 6572 2072 6164  en any inner rad
+00022eb0: 6975 7320 7769 6c6c 2062 6520 6967 6e6f  ius will be igno
+00022ec0: 7265 642e 0a20 2020 2020 2020 203a 7061  red..        :pa
+00022ed0: 7261 6d20 7374 7220 6d6f 6465 6c3a 2054  ram str model: T
+00022ee0: 6865 206e 616d 6520 6f66 2074 6865 2066  he name of the f
+00022ef0: 6974 7465 6420 6d6f 6465 6c20 7468 6174  itted model that
+00022f00: 2079 6f75 2772 6520 7265 7175 6573 7469   you're requesti
+00022f10: 6e67 2074 6865 2072 6573 756c 7473 0a20  ng the results. 
+00022f20: 2020 2020 2020 2020 2020 2066 726f 6d20             from 
+00022f30: 2865 2e67 2e20 636f 6e73 7461 6e74 2a74  (e.g. constant*t
+00022f40: 6261 6273 2a61 7065 6329 2e0a 2020 2020  babs*apec)..    
+00022f50: 2020 2020 3a70 6172 616d 2073 7472 2f51      :param str/Q
+00022f60: 7561 6e74 6974 7920 696e 6e65 725f 7261  uantity inner_ra
+00022f70: 6469 7573 3a20 5468 6520 6e61 6d65 206f  dius: The name o
+00022f80: 7220 7661 6c75 6520 6f66 2074 6865 2069  r value of the i
+00022f90: 6e6e 6572 2072 6164 6975 7320 7468 6174  nner radius that
+00022fa0: 2077 6173 2075 7365 6420 666f 7220 7468   was used for th
+00022fb0: 6520 6765 6e65 7261 7469 6f6e 206f 660a  e generation of.
+00022fc0: 2020 2020 2020 2020 2020 2020 7468 6520              the 
+00022fd0: 7370 6563 7472 6120 7768 6963 6820 7765  spectra which we
+00022fe0: 7265 2066 6974 7465 6420 746f 2070 726f  re fitted to pro
+00022ff0: 6475 6365 2074 6865 2064 6573 6972 6564  duce the desired
+00023000: 2072 6573 756c 7420 2866 6f72 2069 6e73   result (for ins
+00023010: 7461 6e63 6520 2772 3530 3027 2077 6f75  tance 'r500' wou
+00023020: 6c64 2062 6520 6163 6365 7074 6162 6c65  ld be acceptable
+00023030: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+00023040: 2061 2047 616c 6178 7943 6c75 7374 6572   a GalaxyCluster
+00023050: 2c20 6f72 2051 7561 6e74 6974 7928 3330  , or Quantity(30
+00023060: 302c 2027 6b70 6327 2929 2e20 4279 2064  0, 'kpc')). By d
+00023070: 6566 6175 6c74 2074 6869 7320 6973 207a  efault this is z
+00023080: 6572 6f20 6172 6373 6563 6f6e 6473 2c20  ero arcseconds, 
+00023090: 7265 7375 6c74 696e 6720 696e 2061 0a20  resulting in a. 
+000230a0: 2020 2020 2020 2020 2020 2063 6972 6375             circu
+000230b0: 6c61 7220 7370 6563 7472 756d 2e0a 2020  lar spectrum..  
+000230c0: 2020 2020 2020 3a70 6172 616d 2073 7472        :param str
+000230d0: 2070 6172 3a20 5468 6520 6e61 6d65 206f   par: The name o
+000230e0: 6620 7468 6520 7061 7261 6d65 7465 7220  f the parameter 
+000230f0: 796f 7520 7761 6e74 2061 2072 6573 756c  you want a resul
+00023100: 7420 666f 722e 0a20 2020 2020 2020 203a  t for..        :
+00023110: 7061 7261 6d20 626f 6f6c 2067 726f 7570  param bool group
+00023120: 5f73 7065 633a 2057 6865 7468 6572 2074  _spec: Whether t
+00023130: 6865 2073 7065 6374 7261 2074 6861 7420  he spectra that 
+00023140: 7765 7265 2066 6974 7465 6420 666f 7220  were fitted for 
+00023150: 7468 6520 6465 7369 7265 6420 7265 7375  the desired resu
+00023160: 6c74 2077 6572 6520 6772 6f75 7065 642e  lt were grouped.
+00023170: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+00023180: 666c 6f61 7420 6d69 6e5f 636f 756e 7473  float min_counts
+00023190: 3a20 5468 6520 6d69 6e69 6d75 6d20 636f  : The minimum co
+000231a0: 756e 7473 2070 6572 2063 6861 6e6e 656c  unts per channel
+000231b0: 2c20 6966 2074 6865 2073 7065 6374 7261  , if the spectra
+000231c0: 2074 6861 7420 7765 7265 2066 6974 7465   that were fitte
+000231d0: 6420 666f 7220 7468 650a 2020 2020 2020  d for the.      
+000231e0: 2020 2020 2020 6465 7369 7265 6420 7265        desired re
+000231f0: 7375 6c74 2077 6572 6520 6772 6f75 7065  sult were groupe
+00023200: 6420 6279 206d 696e 696d 756d 2063 6f75  d by minimum cou
+00023210: 6e74 732e 0a20 2020 2020 2020 203a 7061  nts..        :pa
+00023220: 7261 6d20 666c 6f61 7420 6d69 6e5f 736e  ram float min_sn
+00023230: 3a20 5468 6520 6d69 6e69 6d75 6d20 7369  : The minimum si
+00023240: 676e 616c 2074 6f20 6e6f 6973 6520 7065  gnal to noise pe
+00023250: 7220 6368 616e 6e65 6c2c 2069 6620 7468  r channel, if th
+00023260: 6520 7370 6563 7472 6120 7468 6174 2077  e spectra that w
+00023270: 6572 6520 6669 7474 6564 2066 6f72 2074  ere fitted for t
+00023280: 6865 0a20 2020 2020 2020 2020 2020 2064  he.            d
+00023290: 6573 6972 6564 2072 6573 756c 7420 7765  esired result we
+000232a0: 7265 2067 726f 7570 6564 2062 7920 6d69  re grouped by mi
+000232b0: 6e69 6d75 6d20 7369 676e 616c 2074 6f20  nimum signal to 
+000232c0: 6e6f 6973 652e 0a20 2020 2020 2020 203a  noise..        :
+000232d0: 7061 7261 6d20 666c 6f61 7420 6f76 6572  param float over
+000232e0: 5f73 616d 706c 653a 2054 6865 206c 6576  _sample: The lev
+000232f0: 656c 206f 6620 6f76 6572 7361 6d70 6c69  el of oversampli
+00023300: 6e67 2061 7070 6c69 6564 206f 6e20 7468  ng applied on th
+00023310: 6520 7370 6563 7472 6120 7468 6174 2077  e spectra that w
+00023320: 6572 6520 6669 7474 6564 2e0a 2020 2020  ere fitted..    
+00023330: 2020 2020 3a72 6574 7572 6e3a 2054 6865      :return: The
+00023340: 2072 6571 7565 7374 6564 2072 6573 756c   requested resul
+00023350: 7420 7661 6c75 652c 2061 6e64 2075 6e63  t value, and unc
+00023360: 6572 7461 696e 7469 6573 2e0a 2020 2020  ertainties..    
+00023370: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00023380: 2320 4669 7273 7420 4920 7761 6e74 2074  # First I want t
+00023390: 6f20 7265 7472 6965 7665 2074 6865 2073  o retrieve the s
+000233a0: 7065 6374 7261 2074 6861 7420 7765 7265  pectra that were
+000233b0: 2066 6974 7465 6420 746f 2070 726f 6475   fitted to produ
+000233c0: 6365 2074 6865 2072 6573 756c 7420 7468  ce the result th
+000233d0: 6579 2772 6520 6c6f 6f6b 696e 6720 666f  ey're looking fo
+000233e0: 722c 0a20 2020 2020 2020 2023 2020 6265  r,.        #  be
+000233f0: 6361 7573 6520 7468 656e 2049 2063 616e  cause then I can
+00023400: 206a 7573 7420 6772 6162 2074 6865 2073   just grab the s
+00023410: 746f 7261 6765 206b 6579 2066 726f 6d20  torage key from 
+00023420: 6f6e 6520 6f66 2074 6865 6d0a 2020 2020  one of them.    
+00023430: 2020 2020 7370 6563 7320 3d20 7365 6c66      specs = self
+00023440: 2e67 6574 5f73 7065 6374 7261 286f 7574  .get_spectra(out
+00023450: 6572 5f72 6164 6975 732c 204e 6f6e 652c  er_radius, None,
+00023460: 204e 6f6e 652c 2069 6e6e 6572 5f72 6164   None, inner_rad
+00023470: 6975 732c 2067 726f 7570 5f73 7065 632c  ius, group_spec,
+00023480: 206d 696e 5f63 6f75 6e74 732c 206d 696e   min_counts, min
+00023490: 5f73 6e2c 206f 7665 725f 7361 6d70 6c65  _sn, over_sample
+000234a0: 290a 2020 2020 2020 2020 2320 4920 6a75  ).        # I ju
+000234b0: 7374 2074 616b 6520 7468 6520 6669 7273  st take the firs
+000234c0: 7420 7370 6563 7472 756d 2069 6e20 7468  t spectrum in th
+000234d0: 6520 6c69 7374 2062 6563 6175 7365 2074  e list because t
+000234e0: 6865 2073 746f 7261 6765 206b 6579 2077  he storage key w
+000234f0: 696c 6c20 6265 2074 6865 2073 616d 6520  ill be the same 
+00023500: 666f 7220 616c 6c20 6f66 2074 6865 6d0a  for all of them.
+00023510: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+00023520: 7461 6e63 6528 7370 6563 732c 206c 6973  tance(specs, lis
+00023530: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
+00023540: 7374 6f72 6167 655f 6b65 7920 3d20 7370  storage_key = sp
+00023550: 6563 735b 305d 2e73 746f 7261 6765 5f6b  ecs[0].storage_k
+00023560: 6579 0a20 2020 2020 2020 2065 6c73 653a  ey.        else:
+00023570: 0a20 2020 2020 2020 2020 2020 2073 746f  .            sto
+00023580: 7261 6765 5f6b 6579 203d 2073 7065 6373  rage_key = specs
+00023590: 2e73 746f 7261 6765 5f6b 6579 0a0a 2020  .storage_key..  
+000235a0: 2020 2020 2020 2320 4275 6e63 6820 6f66        # Bunch of
+000235b0: 2063 6865 636b 7320 746f 206d 616b 6520   checks to make 
+000235c0: 7375 7265 2074 6865 2072 6571 7565 7374  sure the request
+000235d0: 6564 2072 6573 756c 7473 2061 6374 7561  ed results actua
+000235e0: 6c6c 7920 6578 6973 740a 2020 2020 2020  lly exist.      
+000235f0: 2020 6966 206c 656e 2873 656c 662e 5f66    if len(self._f
+00023600: 6974 5f72 6573 756c 7473 2920 3d3d 2030  it_results) == 0
+00023610: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+00023620: 6973 6520 4d6f 6465 6c4e 6f74 4173 736f  ise ModelNotAsso
+00023630: 6369 6174 6564 4572 726f 7228 2254 6865  ciatedError("The
+00023640: 7265 2061 7265 206e 6f20 5853 5045 4320  re are no XSPEC 
+00023650: 6669 7473 2061 7373 6f63 6961 7465 6420  fits associated 
+00023660: 7769 7468 207b 737d 222e 666f 726d 6174  with {s}".format
+00023670: 2873 3d73 656c 662e 6e61 6d65 2929 0a20  (s=self.name)). 
+00023680: 2020 2020 2020 2065 6c69 6620 7374 6f72         elif stor
+00023690: 6167 655f 6b65 7920 6e6f 7420 696e 2073  age_key not in s
+000236a0: 656c 662e 5f66 6974 5f72 6573 756c 7473  elf._fit_results
+000236b0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+000236c0: 6973 6520 4d6f 6465 6c4e 6f74 4173 736f  ise ModelNotAsso
+000236d0: 6369 6174 6564 4572 726f 7228 2254 686f  ciatedError("Tho
+000236e0: 7365 2073 7065 6374 7261 2068 6176 6520  se spectra have 
+000236f0: 6e6f 2061 7373 6f63 6961 7465 6420 5853  no associated XS
+00023700: 5045 4320 6669 7420 746f 207b 737d 222e  PEC fit to {s}".
+00023710: 666f 726d 6174 2873 3d73 656c 662e 6e61  format(s=self.na
+00023720: 6d65 2929 0a20 2020 2020 2020 2065 6c69  me)).        eli
+00023730: 6620 6d6f 6465 6c20 6e6f 7420 696e 2073  f model not in s
+00023740: 656c 662e 5f66 6974 5f72 6573 756c 7473  elf._fit_results
+00023750: 5b73 746f 7261 6765 5f6b 6579 5d3a 0a20  [storage_key]:. 
+00023760: 2020 2020 2020 2020 2020 2061 765f 6d6f             av_mo
+00023770: 6473 203d 2022 2c20 222e 6a6f 696e 2873  ds = ", ".join(s
+00023780: 656c 662e 5f66 6974 5f72 6573 756c 7473  elf._fit_results
+00023790: 5b73 746f 7261 6765 5f6b 6579 5d2e 6b65  [storage_key].ke
+000237a0: 7973 2829 290a 2020 2020 2020 2020 2020  ys()).          
+000237b0: 2020 7261 6973 6520 4d6f 6465 6c4e 6f74    raise ModelNot
+000237c0: 4173 736f 6369 6174 6564 4572 726f 7228  AssociatedError(
+000237d0: 227b 6d7d 2068 6173 206e 6f74 2062 6565  "{m} has not bee
+000237e0: 6e20 6669 7474 6564 2074 6f20 7468 6f73  n fitted to thos
+000237f0: 6520 7370 6563 7472 6120 6f66 207b 737d  e spectra of {s}
+00023800: 3b20 6176 6169 6c61 626c 6520 220a 2020  ; available ".  
 00023810: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00023820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023830: 2020 2020 2020 2020 2020 2020 2022 7468               "th
-00023840: 6520 6f70 7469 6f6e 7320 6172 6520 7b61  e options are {a
-00023850: 7d22 2e66 6f72 6d61 7428 703d 7061 722c  }".format(p=par,
-00023860: 206d 3d6d 6f64 656c 2c20 733d 7365 6c66   m=model, s=self
-00023870: 2e6e 616d 652c 2061 3d61 765f 7061 7273  .name, a=av_pars
-00023880: 2929 0a0a 2020 2020 2020 2020 2320 5265  ))..        # Re
-00023890: 6164 206f 7574 2069 6e74 6f20 7661 7269  ad out into vari
-000238a0: 6162 6c65 2066 6f72 2072 6561 6461 6269  able for readabi
-000238b0: 6c69 7469 6573 2073 616b 650a 2020 2020  lities sake.    
-000238c0: 2020 2020 6669 745f 6461 7461 203d 2073      fit_data = s
-000238d0: 656c 662e 5f66 6974 5f72 6573 756c 7473  elf._fit_results
-000238e0: 5b73 746f 7261 6765 5f6b 6579 5d5b 6d6f  [storage_key][mo
-000238f0: 6465 6c5d 0a20 2020 2020 2020 2070 726f  del].        pro
-00023900: 635f 6461 7461 203d 207b 7d20 2023 2057  c_data = {}  # W
-00023910: 6865 7265 2074 6865 206f 7574 7075 7420  here the output 
-00023920: 7769 6c6c 2069 7665 0a20 2020 2020 2020  will ive.       
-00023930: 2066 6f72 2070 5f6b 6579 2069 6e20 6669   for p_key in fi
-00023940: 745f 6461 7461 3a0a 2020 2020 2020 2020  t_data:.        
-00023950: 2020 2020 2320 5573 6564 2074 6f20 7368      # Used to sh
-00023960: 6170 6520 7468 6520 6e75 6d70 7920 6172  ape the numpy ar
-00023970: 7261 7920 7468 6520 6461 7461 2069 7320  ray the data is 
-00023980: 7472 616e 7366 6572 7265 6420 696e 746f  transferred into
-00023990: 0a20 2020 2020 2020 2020 2020 206e 756d  .            num
-000239a0: 5f65 6e74 7269 6573 203d 206c 656e 2866  _entries = len(f
-000239b0: 6974 5f64 6174 615b 705f 6b65 795d 290a  it_data[p_key]).
-000239c0: 2020 2020 2020 2020 2020 2020 2320 2745              # 'E
-000239d0: 6d70 7479 2720 6e65 7720 6172 7261 7920  mpty' new array 
-000239e0: 746f 2077 7269 7465 206f 7574 2074 6865  to write out the
-000239f0: 2072 6573 756c 7473 2069 6e74 6f2c 2064   results into, d
-00023a00: 6f6e 6520 6c69 6b65 2074 6869 7320 6265  one like this be
-00023a10: 6361 7573 6520 7265 7375 6c74 7320 6172  cause results ar
-00023a20: 6520 7374 6f72 6564 0a20 2020 2020 2020  e stored.       
-00023a30: 2020 2020 2023 2020 696e 206e 6573 7465       #  in neste
-00023a40: 6420 6469 6374 696f 6e61 7269 6573 2077  d dictionaries w
-00023a50: 6974 6820 7468 6569 7220 5853 5045 4320  ith their XSPEC 
-00023a60: 7061 7261 6d65 7465 7220 6e75 6d62 6572  parameter number
-00023a70: 2061 7320 616e 2065 7874 7261 206b 6579   as an extra key
-00023a80: 0a20 2020 2020 2020 2020 2020 206e 6577  .            new
-00023a90: 5f64 6174 6120 3d20 6e70 2e7a 6572 6f73  _data = np.zeros
-00023aa0: 2828 6e75 6d5f 656e 7472 6965 732c 2033  ((num_entries, 3
-00023ab0: 2929 0a0a 2020 2020 2020 2020 2020 2020  ))..            
-00023ac0: 2320 4966 2061 2070 6172 616d 6574 6572  # If a parameter
-00023ad0: 2069 7320 756e 6c69 6e6b 6564 2069 6e20   is unlinked in 
-00023ae0: 6120 6669 7420 7769 7468 206d 756c 7469  a fit with multi
-00023af0: 706c 6520 7370 6563 7472 6120 286c 696b  ple spectra (lik
-00023b00: 6520 6e6f 726d 616c 6973 6174 696f 6e20  e normalisation 
-00023b10: 666f 7220 696e 7374 616e 6365 292c 0a20  for instance),. 
-00023b20: 2020 2020 2020 2020 2020 2023 2020 7468             #  th
-00023b30: 6572 6520 6361 6e20 6265 204e 2065 6e74  ere can be N ent
-00023b40: 7269 6573 2066 6f72 2074 6865 2073 616d  ries for the sam
-00023b50: 6520 7061 7261 6d65 7465 722c 2077 7269  e parameter, wri
-00023b60: 7469 6e67 2074 6865 6d20 6f75 7420 696e  ting them out in
-00023b70: 206f 7264 6572 2074 6f20 6120 6e75 6d70   order to a nump
-00023b80: 7920 6172 7261 790a 2020 2020 2020 2020  y array.        
-00023b90: 2020 2020 666f 7220 696e 6372 2c20 7061      for incr, pa
-00023ba0: 725f 696e 6465 7820 696e 2065 6e75 6d65  r_index in enume
-00023bb0: 7261 7465 2866 6974 5f64 6174 615b 705f  rate(fit_data[p_
-00023bc0: 6b65 795d 293a 0a20 2020 2020 2020 2020  key]):.         
-00023bd0: 2020 2020 2020 206e 6577 5f64 6174 615b         new_data[
-00023be0: 696e 6372 2c20 3a5d 203d 2066 6974 5f64  incr, :] = fit_d
-00023bf0: 6174 615b 705f 6b65 795d 5b70 6172 5f69  ata[p_key][par_i
-00023c00: 6e64 6578 5d0a 0a20 2020 2020 2020 2020  ndex]..         
-00023c10: 2020 2023 204a 7573 7420 6d61 6b65 7320     # Just makes 
-00023c20: 7468 6520 6f75 7470 7574 2061 206c 6974  the output a lit
-00023c30: 746c 6520 6e69 6365 7220 6966 2074 6865  tle nicer if the
-00023c40: 7265 2069 7320 6f6e 6c79 206f 6e65 2065  re is only one e
-00023c50: 6e74 7279 0a20 2020 2020 2020 2020 2020  ntry.           
-00023c60: 2069 6620 6e65 775f 6461 7461 2e73 6861   if new_data.sha
-00023c70: 7065 5b30 5d20 3d3d 2031 3a0a 2020 2020  pe[0] == 1:.    
-00023c80: 2020 2020 2020 2020 2020 2020 7072 6f63              proc
-00023c90: 5f64 6174 615b 705f 6b65 795d 203d 206e  _data[p_key] = n
-00023ca0: 6577 5f64 6174 615b 305d 0a20 2020 2020  ew_data[0].     
-00023cb0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00023cc0: 2020 2020 2020 2020 2020 2020 2070 726f               pro
-00023cd0: 635f 6461 7461 5b70 5f6b 6579 5d20 3d20  c_data[p_key] = 
-00023ce0: 6e65 775f 6461 7461 0a0a 2020 2020 2020  new_data..      
-00023cf0: 2020 2320 4966 206e 6f20 7370 6563 6966    # If no specif
-00023d00: 6963 2070 6172 616d 6574 6572 2077 6173  ic parameter was
-00023d10: 2072 6571 7565 7374 6564 2c20 7468 6520   requested, the 
-00023d20: 7573 6572 2067 6574 7320 616c 6c20 6f66  user gets all of
-00023d30: 2074 6865 6d0a 2020 2020 2020 2020 6966   them.        if
-00023d40: 2070 6172 2069 7320 4e6f 6e65 3a0a 2020   par is None:.  
-00023d50: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00023d60: 2070 726f 635f 6461 7461 0a20 2020 2020   proc_data.     
-00023d70: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00023d80: 2020 2020 2072 6574 7572 6e20 7072 6f63       return proc
-00023d90: 5f64 6174 615b 7061 725d 0a0a 2020 2020  _data[par]..    
-00023da0: 6465 6620 6765 745f 6c75 6d69 6e6f 7369  def get_luminosi
-00023db0: 7469 6573 2873 656c 662c 206f 7574 6572  ties(self, outer
-00023dc0: 5f72 6164 6975 733a 2055 6e69 6f6e 5b73  _radius: Union[s
-00023dd0: 7472 2c20 5175 616e 7469 7479 5d2c 206d  tr, Quantity], m
-00023de0: 6f64 656c 3a20 7374 722c 0a20 2020 2020  odel: str,.     
-00023df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023e00: 2020 2020 696e 6e65 725f 7261 6469 7573      inner_radius
-00023e10: 3a20 556e 696f 6e5b 7374 722c 2051 7561  : Union[str, Qua
-00023e20: 6e74 6974 795d 203d 2051 7561 6e74 6974  ntity] = Quantit
-00023e30: 7928 302c 2027 6172 6373 6563 2729 2c20  y(0, 'arcsec'), 
-00023e40: 6c6f 5f65 6e3a 2051 7561 6e74 6974 7920  lo_en: Quantity 
-00023e50: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-00023e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023e70: 2068 695f 656e 3a20 5175 616e 7469 7479   hi_en: Quantity
-00023e80: 203d 204e 6f6e 652c 2067 726f 7570 5f73   = None, group_s
-00023e90: 7065 633a 2062 6f6f 6c20 3d20 5472 7565  pec: bool = True
-00023ea0: 2c20 6d69 6e5f 636f 756e 7473 3a20 696e  , min_counts: in
-00023eb0: 7420 3d20 352c 206d 696e 5f73 6e3a 2066  t = 5, min_sn: f
-00023ec0: 6c6f 6174 203d 204e 6f6e 652c 0a20 2020  loat = None,.   
-00023ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023ee0: 2020 2020 2020 6f76 6572 5f73 616d 706c        over_sampl
-00023ef0: 653a 2066 6c6f 6174 203d 204e 6f6e 6529  e: float = None)
-00023f00: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-00023f10: 2020 2020 2020 4765 7420 6d65 7468 6f64        Get method
-00023f20: 2066 6f72 206c 756d 696e 6f73 6974 6965   for luminositie
-00023f30: 7320 6361 6c63 756c 6174 6564 2066 726f  s calculated fro
-00023f40: 6d20 6d6f 6465 6c20 6669 7473 2074 6f20  m model fits to 
-00023f50: 7370 6563 7472 6120 6173 736f 6369 6174  spectra associat
-00023f60: 6564 2077 6974 6820 7468 6973 2073 6f75  ed with this sou
-00023f70: 7263 652e 0a20 2020 2020 2020 2045 6974  rce..        Eit
-00023f80: 6865 7220 666f 7220 6769 7665 6e20 656e  her for given en
-00023f90: 6572 6779 206c 696d 6974 7320 2874 6861  ergy limits (tha
-00023fa0: 7420 6d75 7374 2068 6176 6520 6265 656e  t must have been
-00023fb0: 2073 7065 6369 6669 6564 2077 6865 6e20   specified when 
-00023fc0: 7468 6520 6669 7420 7761 7320 6669 7273  the fit was firs
-00023fd0: 7420 7065 7266 6f72 6d65 6429 2c20 6f72  t performed), or
-00023fe0: 0a20 2020 2020 2020 2066 6f72 2061 6c6c  .        for all
-00023ff0: 206c 756d 696e 6f73 6974 6965 7320 6173   luminosities as
-00024000: 736f 6369 6174 6564 2077 6974 6820 7468  sociated with th
-00024010: 6174 206d 6f64 656c 2e20 4c75 6d69 6e6f  at model. Lumino
-00024020: 7369 7469 6573 2061 7265 2072 6574 7572  sities are retur
-00024030: 6e65 6420 6173 2061 2033 2063 6f6c 756d  ned as a 3 colum
-00024040: 6e20 6e75 6d70 7920 6172 7261 793b 0a20  n numpy array;. 
-00024050: 2020 2020 2020 2074 6865 2030 7468 2063         the 0th c
-00024060: 6f6c 756d 6e20 6973 2074 6865 2076 616c  olumn is the val
-00024070: 7565 2c20 7468 6520 3173 7420 636f 6c75  ue, the 1st colu
-00024080: 6d6e 2069 7320 7468 6520 6572 722d 2c20  mn is the err-, 
-00024090: 616e 6420 7468 6520 326e 6420 6973 2065  and the 2nd is e
-000240a0: 7272 2b2e 0a0a 2020 2020 2020 2020 3a70  rr+...        :p
-000240b0: 6172 616d 2073 7472 2f51 7561 6e74 6974  aram str/Quantit
-000240c0: 7920 6f75 7465 725f 7261 6469 7573 3a20  y outer_radius: 
-000240d0: 5468 6520 6e61 6d65 206f 7220 7661 6c75  The name or valu
-000240e0: 6520 6f66 2074 6865 206f 7574 6572 2072  e of the outer r
-000240f0: 6164 6975 7320 7468 6174 2077 6173 2075  adius that was u
-00024100: 7365 6420 666f 7220 7468 6520 6765 6e65  sed for the gene
-00024110: 7261 7469 6f6e 206f 660a 2020 2020 2020  ration of.      
-00024120: 2020 2020 2020 7468 6520 7370 6563 7472        the spectr
-00024130: 6120 7768 6963 6820 7765 7265 2066 6974  a which were fit
-00024140: 7465 6420 746f 2070 726f 6475 6365 2074  ted to produce t
-00024150: 6865 2064 6573 6972 6564 2072 6573 756c  he desired resul
-00024160: 7420 2866 6f72 2069 6e73 7461 6e63 6520  t (for instance 
-00024170: 2772 3230 3027 2077 6f75 6c64 2062 6520  'r200' would be 
-00024180: 6163 6365 7074 6162 6c65 0a20 2020 2020  acceptable.     
-00024190: 2020 2020 2020 2066 6f72 2061 2047 616c         for a Gal
-000241a0: 6178 7943 6c75 7374 6572 2c20 6f72 2051  axyCluster, or Q
-000241b0: 7561 6e74 6974 7928 3130 3030 2c20 276b  uantity(1000, 'k
-000241c0: 7063 2729 292e 2049 6620 2772 6567 696f  pc')). If 'regio
-000241d0: 6e27 2069 7320 6368 6f73 656e 2028 746f  n' is chosen (to
-000241e0: 2075 7365 2074 6865 2072 6567 696f 6e73   use the regions
-000241f0: 2069 6e0a 2020 2020 2020 2020 2020 2020   in.            
-00024200: 7265 6769 6f6e 2066 696c 6573 292c 2074  region files), t
-00024210: 6865 6e20 616e 7920 696e 6e65 7220 7261  hen any inner ra
-00024220: 6469 7573 2077 696c 6c20 6265 2069 676e  dius will be ign
-00024230: 6f72 6564 2e0a 2020 2020 2020 2020 3a70  ored..        :p
-00024240: 6172 616d 2073 7472 206d 6f64 656c 3a20  aram str model: 
-00024250: 5468 6520 6e61 6d65 206f 6620 7468 6520  The name of the 
-00024260: 6669 7474 6564 206d 6f64 656c 2074 6861  fitted model tha
-00024270: 7420 796f 7527 7265 2072 6571 7565 7374  t you're request
-00024280: 696e 6720 7468 6520 6c75 6d69 6e6f 7369  ing the luminosi
-00024290: 7469 6573 0a20 2020 2020 2020 2020 2020  ties.           
-000242a0: 2066 726f 6d20 2865 2e67 2e20 636f 6e73   from (e.g. cons
-000242b0: 7461 6e74 2a74 6261 6273 2a61 7065 6329  tant*tbabs*apec)
-000242c0: 2e0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
-000242d0: 2073 7472 2f51 7561 6e74 6974 7920 696e   str/Quantity in
-000242e0: 6e65 725f 7261 6469 7573 3a20 5468 6520  ner_radius: The 
-000242f0: 6e61 6d65 206f 7220 7661 6c75 6520 6f66  name or value of
-00024300: 2074 6865 2069 6e6e 6572 2072 6164 6975   the inner radiu
-00024310: 7320 7468 6174 2077 6173 2075 7365 6420  s that was used 
-00024320: 666f 7220 7468 6520 6765 6e65 7261 7469  for the generati
-00024330: 6f6e 206f 660a 2020 2020 2020 2020 2020  on of.          
-00024340: 2020 7468 6520 7370 6563 7472 6120 7768    the spectra wh
-00024350: 6963 6820 7765 7265 2066 6974 7465 6420  ich were fitted 
-00024360: 746f 2070 726f 6475 6365 2074 6865 2064  to produce the d
-00024370: 6573 6972 6564 2072 6573 756c 7420 2866  esired result (f
-00024380: 6f72 2069 6e73 7461 6e63 6520 2772 3530  or instance 'r50
-00024390: 3027 2077 6f75 6c64 2062 6520 6163 6365  0' would be acce
-000243a0: 7074 6162 6c65 0a20 2020 2020 2020 2020  ptable.         
-000243b0: 2020 2066 6f72 2061 2047 616c 6178 7943     for a GalaxyC
-000243c0: 6c75 7374 6572 2c20 6f72 2051 7561 6e74  luster, or Quant
-000243d0: 6974 7928 3330 302c 2027 6b70 6327 2929  ity(300, 'kpc'))
-000243e0: 2e20 4279 2064 6566 6175 6c74 2074 6869  . By default thi
-000243f0: 7320 6973 207a 6572 6f20 6172 6373 6563  s is zero arcsec
-00024400: 6f6e 6473 2c20 7265 7375 6c74 696e 6720  onds, resulting 
-00024410: 696e 2061 0a20 2020 2020 2020 2020 2020  in a.           
-00024420: 2063 6972 6375 6c61 7220 7370 6563 7472   circular spectr
-00024430: 756d 2e0a 2020 2020 2020 2020 3a70 6172  um..        :par
-00024440: 616d 2051 7561 6e74 6974 7920 6c6f 5f65  am Quantity lo_e
-00024450: 6e3a 2054 6865 206c 6f77 6572 2065 6e65  n: The lower ene
-00024460: 7267 7920 6c69 6d69 7420 666f 7220 7468  rgy limit for th
-00024470: 6520 6465 7369 7265 6420 6c75 6d69 6e6f  e desired lumino
-00024480: 7369 7479 206d 6561 7375 7265 6d65 6e74  sity measurement
-00024490: 2e0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
-000244a0: 2051 7561 6e74 6974 7920 6869 5f65 6e3a   Quantity hi_en:
-000244b0: 2054 6865 2075 7070 6572 2065 6e65 7267   The upper energ
-000244c0: 7920 6c69 6d69 7420 666f 7220 7468 6520  y limit for the 
-000244d0: 6465 7369 7265 6420 6c75 6d69 6e6f 7369  desired luminosi
-000244e0: 7479 206d 6561 7375 7265 6d65 6e74 2e0a  ty measurement..
-000244f0: 2020 2020 2020 2020 3a70 6172 616d 2062          :param b
-00024500: 6f6f 6c20 6772 6f75 705f 7370 6563 3a20  ool group_spec: 
-00024510: 5768 6574 6865 7220 7468 6520 7370 6563  Whether the spec
-00024520: 7472 6120 7468 6174 2077 6572 6520 6669  tra that were fi
-00024530: 7474 6564 2066 6f72 2074 6865 2064 6573  tted for the des
-00024540: 6972 6564 2072 6573 756c 7420 7765 7265  ired result were
-00024550: 2067 726f 7570 6564 2e0a 2020 2020 2020   grouped..      
-00024560: 2020 3a70 6172 616d 2066 6c6f 6174 206d    :param float m
-00024570: 696e 5f63 6f75 6e74 733a 2054 6865 206d  in_counts: The m
-00024580: 696e 696d 756d 2063 6f75 6e74 7320 7065  inimum counts pe
-00024590: 7220 6368 616e 6e65 6c2c 2069 6620 7468  r channel, if th
-000245a0: 6520 7370 6563 7472 6120 7468 6174 2077  e spectra that w
-000245b0: 6572 6520 6669 7474 6564 2066 6f72 2074  ere fitted for t
-000245c0: 6865 0a20 2020 2020 2020 2020 2020 2064  he.            d
-000245d0: 6573 6972 6564 2072 6573 756c 7420 7765  esired result we
-000245e0: 7265 2067 726f 7570 6564 2062 7920 6d69  re grouped by mi
-000245f0: 6e69 6d75 6d20 636f 756e 7473 2e0a 2020  nimum counts..  
-00024600: 2020 2020 2020 3a70 6172 616d 2066 6c6f        :param flo
-00024610: 6174 206d 696e 5f73 6e3a 2054 6865 206d  at min_sn: The m
-00024620: 696e 696d 756d 2073 6967 6e61 6c20 746f  inimum signal to
-00024630: 206e 6f69 7365 2070 6572 2063 6861 6e6e   noise per chann
-00024640: 656c 2c20 6966 2074 6865 2073 7065 6374  el, if the spect
-00024650: 7261 2074 6861 7420 7765 7265 2066 6974  ra that were fit
-00024660: 7465 6420 666f 7220 7468 650a 2020 2020  ted for the.    
-00024670: 2020 2020 2020 2020 6465 7369 7265 6420          desired 
-00024680: 7265 7375 6c74 2077 6572 6520 6772 6f75  result were grou
-00024690: 7065 6420 6279 206d 696e 696d 756d 2073  ped by minimum s
-000246a0: 6967 6e61 6c20 746f 206e 6f69 7365 2e0a  ignal to noise..
-000246b0: 2020 2020 2020 2020 3a70 6172 616d 2066          :param f
-000246c0: 6c6f 6174 206f 7665 725f 7361 6d70 6c65  loat over_sample
-000246d0: 3a20 5468 6520 6c65 7665 6c20 6f66 206f  : The level of o
-000246e0: 7665 7273 616d 706c 696e 6720 6170 706c  versampling appl
-000246f0: 6965 6420 6f6e 2074 6865 2073 7065 6374  ied on the spect
-00024700: 7261 2074 6861 7420 7765 7265 2066 6974  ra that were fit
-00024710: 7465 642e 0a20 2020 2020 2020 203a 7265  ted..        :re
-00024720: 7475 726e 3a20 5468 6520 7265 7175 6573  turn: The reques
-00024730: 7465 6420 6c75 6d69 6e6f 7369 7479 2076  ted luminosity v
-00024740: 616c 7565 2c20 616e 6420 756e 6365 7274  alue, and uncert
-00024750: 6169 6e74 6965 732e 0a20 2020 2020 2020  ainties..       
-00024760: 2022 2222 0a20 2020 2020 2020 2023 2046   """.        # F
-00024770: 6972 7374 2049 2077 616e 7420 746f 2072  irst I want to r
-00024780: 6574 7269 6576 6520 7468 6520 7370 6563  etrieve the spec
-00024790: 7472 6120 7468 6174 2077 6572 6520 6669  tra that were fi
-000247a0: 7474 6564 2074 6f20 7072 6f64 7563 6520  tted to produce 
-000247b0: 7468 6520 7265 7375 6c74 2074 6865 7927  the result they'
-000247c0: 7265 206c 6f6f 6b69 6e67 2066 6f72 2c0a  re looking for,.
-000247d0: 2020 2020 2020 2020 2320 2062 6563 6175          #  becau
-000247e0: 7365 2074 6865 6e20 4920 6361 6e20 6a75  se then I can ju
-000247f0: 7374 2067 7261 6220 7468 6520 7374 6f72  st grab the stor
-00024800: 6167 6520 6b65 7920 6672 6f6d 206f 6e65  age key from one
-00024810: 206f 6620 7468 656d 0a20 2020 2020 2020   of them.       
-00024820: 2073 7065 6373 203d 2073 656c 662e 6765   specs = self.ge
-00024830: 745f 7370 6563 7472 6128 6f75 7465 725f  t_spectra(outer_
-00024840: 7261 6469 7573 2c20 4e6f 6e65 2c20 4e6f  radius, None, No
-00024850: 6e65 2c20 696e 6e65 725f 7261 6469 7573  ne, inner_radius
-00024860: 2c20 6772 6f75 705f 7370 6563 2c20 6d69  , group_spec, mi
-00024870: 6e5f 636f 756e 7473 2c20 6d69 6e5f 736e  n_counts, min_sn
-00024880: 2c20 6f76 6572 5f73 616d 706c 6529 0a20  , over_sample). 
-00024890: 2020 2020 2020 2023 2049 206a 7573 7420         # I just 
-000248a0: 7461 6b65 2074 6865 2066 6972 7374 2073  take the first s
-000248b0: 7065 6374 7275 6d20 696e 2074 6865 206c  pectrum in the l
-000248c0: 6973 7420 6265 6361 7573 6520 7468 6520  ist because the 
-000248d0: 7374 6f72 6167 6520 6b65 7920 7769 6c6c  storage key will
-000248e0: 2062 6520 7468 6520 7361 6d65 2066 6f72   be the same for
-000248f0: 2061 6c6c 206f 6620 7468 656d 0a20 2020   all of them.   
-00024900: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
-00024910: 6365 2873 7065 6373 2c20 6c69 7374 293a  ce(specs, list):
-00024920: 0a20 2020 2020 2020 2020 2020 2073 746f  .            sto
-00024930: 7261 6765 5f6b 6579 203d 2073 7065 6373  rage_key = specs
-00024940: 5b30 5d2e 7374 6f72 6167 655f 6b65 790a  [0].storage_key.
-00024950: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00024960: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
-00024970: 655f 6b65 7920 3d20 7370 6563 732e 7374  e_key = specs.st
-00024980: 6f72 6167 655f 6b65 790a 0a20 2020 2020  orage_key..     
-00024990: 2020 2023 2043 6865 636b 696e 6720 7468     # Checking th
-000249a0: 6520 696e 7075 7420 656e 6572 6779 206c  e input energy l
-000249b0: 696d 6974 7320 6172 6520 7661 6c69 642c  imits are valid,
-000249c0: 2061 6e64 2061 7373 656d 626c 6573 2074   and assembles t
-000249d0: 6865 206b 6579 2074 6f20 6c6f 6f6b 2066  he key to look f
-000249e0: 6f72 206c 756d 7320 696e 2074 686f 7365  or lums in those
-000249f0: 2065 6e65 7267 790a 2020 2020 2020 2020   energy.        
-00024a00: 2320 2062 6f75 6e64 732e 2049 6620 7468  #  bounds. If th
-00024a10: 6520 6c69 6d69 7473 2061 7265 206e 6f6e  e limits are non
-00024a20: 6520 7468 656e 2073 6f20 6973 2074 6865  e then so is the
-00024a30: 2065 6e65 7267 7920 6b65 790a 2020 2020   energy key.    
-00024a40: 2020 2020 6966 206c 6f5f 656e 2069 7320      if lo_en is 
-00024a50: 6e6f 7420 4e6f 6e65 2061 6e64 2068 695f  not None and hi_
-00024a60: 656e 2069 7320 6e6f 7420 4e6f 6e65 2061  en is not None a
-00024a70: 6e64 206c 6f5f 656e 203e 2068 695f 656e  nd lo_en > hi_en
-00024a80: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-00024a90: 6973 6520 5661 6c75 6545 7272 6f72 2822  ise ValueError("
-00024aa0: 5468 6520 6c6f 7720 656e 6572 6779 206c  The low energy l
-00024ab0: 696d 6974 2063 616e 6e6f 7420 6265 2067  imit cannot be g
-00024ac0: 7265 6174 6572 2074 6861 6e20 7468 6520  reater than the 
-00024ad0: 6869 6768 2065 6e65 7267 7920 6c69 6d69  high energy limi
-00024ae0: 7422 290a 2020 2020 2020 2020 656c 6966  t").        elif
-00024af0: 206c 6f5f 656e 2069 7320 6e6f 7420 4e6f   lo_en is not No
-00024b00: 6e65 2061 6e64 2068 695f 656e 2069 7320  ne and hi_en is 
-00024b10: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00024b20: 2020 2020 2020 656e 5f6b 6579 203d 2022        en_key = "
-00024b30: 626f 756e 645f 7b6c 7d2d 7b75 7d22 2e66  bound_{l}-{u}".f
-00024b40: 6f72 6d61 7428 6c3d 6c6f 5f65 6e2e 746f  ormat(l=lo_en.to
-00024b50: 2822 6b65 5622 292e 7661 6c75 652c 2075  ("keV").value, u
-00024b60: 3d68 695f 656e 2e74 6f28 226b 6556 2229  =hi_en.to("keV")
-00024b70: 2e76 616c 7565 290a 2020 2020 2020 2020  .value).        
-00024b80: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00024b90: 2020 656e 5f6b 6579 203d 204e 6f6e 650a    en_key = None.
-00024ba0: 0a20 2020 2020 2020 2023 2043 6865 636b  .        # Check
-00024bb0: 7320 7468 6174 2074 6865 2072 6571 7565  s that the reque
-00024bc0: 7374 6564 2072 6567 696f 6e2c 206d 6f64  sted region, mod
-00024bd0: 656c 2061 6e64 2065 6e65 7267 7920 6261  el and energy ba
-00024be0: 6e64 2061 6374 7561 6c6c 7920 6578 6973  nd actually exis
-00024bf0: 740a 2020 2020 2020 2020 6966 206c 656e  t.        if len
-00024c00: 2873 656c 662e 5f6c 756d 696e 6f73 6974  (self._luminosit
-00024c10: 6965 7329 203d 3d20 303a 0a20 2020 2020  ies) == 0:.     
-00024c20: 2020 2020 2020 2072 6169 7365 204d 6f64         raise Mod
-00024c30: 656c 4e6f 7441 7373 6f63 6961 7465 6445  elNotAssociatedE
-00024c40: 7272 6f72 2822 5468 6572 6520 6172 6520  rror("There are 
-00024c50: 6e6f 2058 5350 4543 2066 6974 7320 6173  no XSPEC fits as
-00024c60: 736f 6369 6174 6564 2077 6974 6820 7b73  sociated with {s
-00024c70: 7d22 2e66 6f72 6d61 7428 733d 7365 6c66  }".format(s=self
-00024c80: 2e6e 616d 6529 290a 2020 2020 2020 2020  .name)).        
-00024c90: 656c 6966 2073 746f 7261 6765 5f6b 6579  elif storage_key
-00024ca0: 206e 6f74 2069 6e20 7365 6c66 2e5f 6c75   not in self._lu
-00024cb0: 6d69 6e6f 7369 7469 6573 3a0a 2020 2020  minosities:.    
-00024cc0: 2020 2020 2020 2020 7261 6973 6520 4d6f          raise Mo
-00024cd0: 6465 6c4e 6f74 4173 736f 6369 6174 6564  delNotAssociated
-00024ce0: 4572 726f 7228 2254 6865 7365 2073 7065  Error("These spe
-00024cf0: 6374 7261 2068 6176 6520 6e6f 2061 7373  ctra have no ass
-00024d00: 6f63 6961 7465 6420 5853 5045 4320 6669  ociated XSPEC fi
-00024d10: 7420 746f 207b 737d 2e22 2e66 6f72 6d61  t to {s}.".forma
-00024d20: 7428 733d 7365 6c66 2e6e 616d 6529 290a  t(s=self.name)).
-00024d30: 2020 2020 2020 2020 656c 6966 206d 6f64          elif mod
-00024d40: 656c 206e 6f74 2069 6e20 7365 6c66 2e5f  el not in self._
-00024d50: 6c75 6d69 6e6f 7369 7469 6573 5b73 746f  luminosities[sto
-00024d60: 7261 6765 5f6b 6579 5d3a 0a20 2020 2020  rage_key]:.     
-00024d70: 2020 2020 2020 2061 765f 6d6f 6473 203d         av_mods =
-00024d80: 2022 2c20 222e 6a6f 696e 2873 656c 662e   ", ".join(self.
-00024d90: 5f6c 756d 696e 6f73 6974 6965 735b 7374  _luminosities[st
-00024da0: 6f72 6167 655f 6b65 795d 2e6b 6579 7328  orage_key].keys(
-00024db0: 2929 0a20 2020 2020 2020 2020 2020 2072  )).            r
-00024dc0: 6169 7365 204d 6f64 656c 4e6f 7441 7373  aise ModelNotAss
-00024dd0: 6f63 6961 7465 6445 7272 6f72 2822 7b6d  ociatedError("{m
-00024de0: 7d20 6861 7320 6e6f 7420 6265 656e 2066  } has not been f
-00024df0: 6974 7465 6420 746f 2074 6865 7365 2073  itted to these s
-00024e00: 7065 6374 7261 206f 6620 7b73 7d3b 2022  pectra of {s}; "
-00024e10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00024e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024e30: 2020 2020 2020 2020 2020 2022 6176 6169             "avai
-00024e40: 6c61 626c 6520 6d6f 6465 6c73 2061 7265  lable models are
-00024e50: 207b 617d 222e 666f 726d 6174 286d 3d6d   {a}".format(m=m
-00024e60: 6f64 656c 2c20 733d 7365 6c66 2e6e 616d  odel, s=self.nam
-00024e70: 652c 2061 3d61 765f 6d6f 6473 2929 0a20  e, a=av_mods)). 
-00024e80: 2020 2020 2020 2065 6c69 6620 656e 5f6b         elif en_k
-00024e90: 6579 2069 7320 6e6f 7420 4e6f 6e65 2061  ey is not None a
-00024ea0: 6e64 2065 6e5f 6b65 7920 6e6f 7420 696e  nd en_key not in
-00024eb0: 2073 656c 662e 5f6c 756d 696e 6f73 6974   self._luminosit
-00024ec0: 6965 735b 7374 6f72 6167 655f 6b65 795d  ies[storage_key]
-00024ed0: 5b6d 6f64 656c 5d3a 0a20 2020 2020 2020  [model]:.       
-00024ee0: 2020 2020 2061 765f 6261 6e64 7320 3d20       av_bands = 
-00024ef0: 222c 2022 2e6a 6f69 6e28 5b65 6e2e 7370  ", ".join([en.sp
-00024f00: 6c69 7428 225f 2229 5b2d 315d 202b 2022  lit("_")[-1] + "
-00024f10: 6b65 5622 2066 6f72 2065 6e20 696e 2073  keV" for en in s
-00024f20: 656c 662e 5f6c 756d 696e 6f73 6974 6965  elf._luminositie
-00024f30: 735b 7374 6f72 6167 655f 6b65 795d 5b6d  s[storage_key][m
-00024f40: 6f64 656c 5d2e 6b65 7973 2829 5d29 0a20  odel].keys()]). 
-00024f50: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00024f60: 2050 6172 616d 6574 6572 4e6f 7441 7373   ParameterNotAss
-00024f70: 6f63 6961 7465 6445 7272 6f72 2822 7b6c  ociatedError("{l
-00024f80: 7d2d 7b75 7d6b 6556 2077 6173 206e 6f74  }-{u}keV was not
-00024f90: 2061 6e20 656e 6572 6779 2062 616e 6420   an energy band 
-00024fa0: 666f 7220 7468 6520 6669 7420 7769 7468  for the fit with
-00024fb0: 207b 6d7d 3b20 6176 6169 6c61 626c 6520   {m}; available 
-00024fc0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00024fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024ff0: 2265 6e65 7267 7920 6261 6e64 7320 6172  "energy bands ar
-00025000: 6520 7b62 7d22 2e66 6f72 6d61 7428 6c3d  e {b}".format(l=
-00025010: 6c6f 5f65 6e2e 746f 2822 6b65 5622 292e  lo_en.to("keV").
-00025020: 7661 6c75 652c 0a20 2020 2020 2020 2020  value,.         
-00025030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025070: 2020 2075 3d68 695f 656e 2e74 6f28 226b     u=hi_en.to("k
-00025080: 6556 2229 2e76 616c 7565 2c0a 2020 2020  eV").value,.    
-00025090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000250a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000250b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000250c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000250d0: 2020 2020 2020 2020 6d3d 6d6f 6465 6c2c          m=model,
-000250e0: 2062 3d61 765f 6261 6e64 7329 290a 0a20   b=av_bands)).. 
-000250f0: 2020 2020 2020 2023 2049 6620 6e6f 206c         # If no l
-00025100: 696d 6974 7320 7370 6563 6966 6965 642c  imits specified,
-00025110: 7468 6520 7573 6572 2067 6574 7320 616c  the user gets al
-00025120: 6c20 7468 6520 6c75 6d69 6e6f 7369 7469  l the luminositi
-00025130: 6573 2c20 6f74 6865 7277 6973 6520 7468  es, otherwise th
-00025140: 6579 2067 6574 2074 6865 206f 6e65 2074  ey get the one t
-00025150: 6865 7920 6173 6b65 6420 666f 720a 2020  hey asked for.  
-00025160: 2020 2020 2020 6966 2065 6e5f 6b65 7920        if en_key 
-00025170: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-00025180: 2020 2020 2070 6172 7365 645f 6c75 6d73       parsed_lums
-00025190: 203d 207b 7d0a 2020 2020 2020 2020 2020   = {}.          
-000251a0: 2020 666f 7220 6c75 6d5f 6b65 7920 696e    for lum_key in
-000251b0: 2073 656c 662e 5f6c 756d 696e 6f73 6974   self._luminosit
-000251c0: 6965 735b 7374 6f72 6167 655f 6b65 795d  ies[storage_key]
-000251d0: 5b6d 6f64 656c 5d3a 0a20 2020 2020 2020  [model]:.       
-000251e0: 2020 2020 2020 2020 206c 756d 5f76 616c           lum_val
-000251f0: 7565 203d 2073 656c 662e 5f6c 756d 696e  ue = self._lumin
-00025200: 6f73 6974 6965 735b 7374 6f72 6167 655f  osities[storage_
-00025210: 6b65 795d 5b6d 6f64 656c 5d5b 6c75 6d5f  key][model][lum_
-00025220: 6b65 795d 0a20 2020 2020 2020 2020 2020  key].           
-00025230: 2020 2020 2070 6172 7365 645f 6c75 6d20       parsed_lum 
-00025240: 3d20 5175 616e 7469 7479 285b 6c75 6d2e  = Quantity([lum.
-00025250: 7661 6c75 6520 666f 7220 6c75 6d20 696e  value for lum in
-00025260: 206c 756d 5f76 616c 7565 5d2c 206c 756d   lum_value], lum
-00025270: 5f76 616c 7565 5b30 5d2e 756e 6974 290a  _value[0].unit).
-00025280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025290: 7061 7273 6564 5f6c 756d 735b 6c75 6d5f  parsed_lums[lum_
-000252a0: 6b65 795d 203d 2070 6172 7365 645f 6c75  key] = parsed_lu
-000252b0: 6d0a 2020 2020 2020 2020 2020 2020 7265  m.            re
-000252c0: 7475 726e 2070 6172 7365 645f 6c75 6d73  turn parsed_lums
-000252d0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-000252e0: 2020 2020 2020 2020 2020 206c 756d 5f76             lum_v
-000252f0: 616c 7565 203d 2073 656c 662e 5f6c 756d  alue = self._lum
-00025300: 696e 6f73 6974 6965 735b 7374 6f72 6167  inosities[storag
-00025310: 655f 6b65 795d 5b6d 6f64 656c 5d5b 656e  e_key][model][en
-00025320: 5f6b 6579 5d0a 2020 2020 2020 2020 2020  _key].          
-00025330: 2020 7061 7273 6564 5f6c 756d 203d 2051    parsed_lum = Q
-00025340: 7561 6e74 6974 7928 5b6c 756d 2e76 616c  uantity([lum.val
-00025350: 7565 2066 6f72 206c 756d 2069 6e20 6c75  ue for lum in lu
-00025360: 6d5f 7661 6c75 655d 2c20 6c75 6d5f 7661  m_value], lum_va
-00025370: 6c75 655b 305d 2e75 6e69 7429 0a20 2020  lue[0].unit).   
-00025380: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00025390: 7061 7273 6564 5f6c 756d 0a0a 2020 2020  parsed_lum..    
-000253a0: 6465 6620 636f 6e76 6572 745f 7261 6469  def convert_radi
-000253b0: 7573 2873 656c 662c 2072 6164 6975 733a  us(self, radius:
-000253c0: 2051 7561 6e74 6974 792c 206f 7574 5f75   Quantity, out_u
-000253d0: 6e69 743a 2055 6e69 6f6e 5b55 6e69 742c  nit: Union[Unit,
-000253e0: 2073 7472 5d20 3d20 2764 6567 2729 202d   str] = 'deg') -
-000253f0: 3e20 5175 616e 7469 7479 3a0a 2020 2020  > Quantity:.    
-00025400: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00025410: 4120 7369 6d70 6c65 206d 6574 686f 6420  A simple method 
-00025420: 746f 2063 6f6e 7665 7274 2072 6164 6969  to convert radii
-00025430: 2062 6574 7765 656e 2064 6966 6665 7265   between differe
-00025440: 6e74 2064 6973 7461 6e63 6520 756e 6974  nt distance unit
-00025450: 732c 2069 7420 6175 746f 6d61 7469 6361  s, it automatica
-00025460: 6c6c 7920 6368 6563 6b73 2077 6865 7468  lly checks wheth
-00025470: 6572 0a20 2020 2020 2020 2074 6865 2072  er.        the r
-00025480: 6571 7565 7374 6564 2063 6f6e 7665 7273  equested convers
-00025490: 696f 6e20 6973 2070 6f73 7369 626c 652c  ion is possible,
-000254a0: 2067 6976 656e 2061 7661 696c 6162 6c65   given available
-000254b0: 2069 6e66 6f72 6d61 7469 6f6e 2e20 466f   information. Fo
-000254c0: 7220 696e 7374 616e 6365 2069 7420 776f  r instance it wo
-000254d0: 756c 6420 6661 696c 2069 6620 796f 750a  uld fail if you.
-000254e0: 2020 2020 2020 2020 7265 7175 6573 7465          requeste
-000254f0: 6420 6120 636f 6e76 6572 7369 6f6e 2066  d a conversion f
-00025500: 726f 6d20 6172 6373 6563 6f6e 6473 2074  rom arcseconds t
-00025510: 6f20 6120 7072 6f70 6572 2064 6973 7461  o a proper dista
-00025520: 6e63 6520 6966 206e 6f20 7265 6473 6869  nce if no redshi
-00025530: 6674 2069 6e66 6f72 6d61 7469 6f6e 2077  ft information w
-00025540: 6572 6520 6176 6169 6c61 626c 652e 0a0a  ere available...
-00025550: 2020 2020 2020 2020 3a70 6172 616d 2051          :param Q
-00025560: 7561 6e74 6974 7920 7261 6469 7573 3a20  uantity radius: 
-00025570: 5468 6520 7261 6469 7573 2074 6f20 636f  The radius to co
-00025580: 6e76 6572 7420 746f 2061 206e 6577 2075  nvert to a new u
-00025590: 6e69 742e 0a20 2020 2020 2020 203a 7061  nit..        :pa
-000255a0: 7261 6d20 556e 6974 2f73 7472 206f 7574  ram Unit/str out
-000255b0: 5f75 6e69 743a 2054 6865 2075 6e69 7420  _unit: The unit 
-000255c0: 746f 2063 6f6e 7665 7274 2074 6865 2069  to convert the i
-000255d0: 6e70 7574 2072 6164 6975 7320 746f 2e0a  nput radius to..
-000255e0: 2020 2020 2020 2020 3a72 6574 7572 6e3a          :return:
-000255f0: 2054 6865 2063 6f6e 7665 7274 6564 2072   The converted r
-00025600: 6164 6975 730a 2020 2020 2020 2020 3a72  adius.        :r
-00025610: 7479 7065 3a20 5175 616e 7469 7479 0a20  type: Quantity. 
-00025620: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00025630: 2020 2023 2049 6620 6120 7374 7269 6e67     # If a string
-00025640: 2072 6570 7265 7365 6e74 6174 696f 6e20   representation 
-00025650: 7761 7320 7061 7373 6564 2c20 7765 206d  was passed, we m
-00025660: 616b 6520 6974 2061 6e20 6173 7472 6f70  ake it an astrop
-00025670: 7920 756e 6974 0a20 2020 2020 2020 2069  y unit.        i
-00025680: 6620 6973 696e 7374 616e 6365 286f 7574  f isinstance(out
-00025690: 5f75 6e69 742c 2073 7472 293a 0a20 2020  _unit, str):.   
-000256a0: 2020 2020 2020 2020 206f 7574 5f75 6e69           out_uni
-000256b0: 7420 3d20 556e 6974 286f 7574 5f75 6e69  t = Unit(out_uni
-000256c0: 7429 0a0a 2020 2020 2020 2020 6966 206f  t)..        if o
-000256d0: 7574 5f75 6e69 742e 6973 5f65 7175 6976  ut_unit.is_equiv
-000256e0: 616c 656e 7428 276b 7063 2729 2061 6e64  alent('kpc') and
-000256f0: 2073 656c 662e 5f72 6564 7368 6966 7420   self._redshift 
-00025700: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-00025710: 2020 2020 2072 6169 7365 2055 6e69 7443       raise UnitC
-00025720: 6f6e 7665 7273 696f 6e45 7272 6f72 2822  onversionError("
-00025730: 596f 7520 6361 6e6e 6f74 2063 6f6e 7665  You cannot conve
-00025740: 7274 2074 6f20 7468 6973 2075 6e69 7420  rt to this unit 
-00025750: 7769 7468 6f75 7420 7265 6473 6869 6674  without redshift
-00025760: 2069 6e66 6f72 6d61 7469 6f6e 2e22 290a   information.").
-00025770: 0a20 2020 2020 2020 2069 6620 7261 6469  .        if radi
-00025780: 7573 2e75 6e69 742e 6973 5f65 7175 6976  us.unit.is_equiv
-00025790: 616c 656e 7428 2764 6567 2729 2061 6e64  alent('deg') and
-000257a0: 206f 7574 5f75 6e69 742e 6973 5f65 7175   out_unit.is_equ
-000257b0: 6976 616c 656e 7428 2764 6567 2729 3a0a  ivalent('deg'):.
-000257c0: 2020 2020 2020 2020 2020 2020 6f75 745f              out_
-000257d0: 7261 6420 3d20 7261 6469 7573 2e74 6f28  rad = radius.to(
-000257e0: 6f75 745f 756e 6974 290a 2020 2020 2020  out_unit).      
-000257f0: 2020 656c 6966 2072 6164 6975 732e 756e    elif radius.un
-00025800: 6974 2e69 735f 6571 7569 7661 6c65 6e74  it.is_equivalent
-00025810: 2827 6465 6727 2920 616e 6420 6f75 745f  ('deg') and out_
-00025820: 756e 6974 2e69 735f 6571 7569 7661 6c65  unit.is_equivale
-00025830: 6e74 2827 6b70 6327 293a 0a20 2020 2020  nt('kpc'):.     
-00025840: 2020 2020 2020 206f 7574 5f72 6164 203d         out_rad =
-00025850: 2061 6e67 5f74 6f5f 7261 6428 7261 6469   ang_to_rad(radi
-00025860: 7573 2c20 7365 6c66 2e5f 7265 6473 6869  us, self._redshi
-00025870: 6674 2c20 7365 6c66 2e5f 636f 736d 6f29  ft, self._cosmo)
-00025880: 2e74 6f28 6f75 745f 756e 6974 290a 2020  .to(out_unit).  
-00025890: 2020 2020 2020 656c 6966 2072 6164 6975        elif radiu
-000258a0: 732e 756e 6974 2e69 735f 6571 7569 7661  s.unit.is_equiva
-000258b0: 6c65 6e74 2827 6b70 6327 2920 616e 6420  lent('kpc') and 
-000258c0: 6f75 745f 756e 6974 2e69 735f 6571 7569  out_unit.is_equi
-000258d0: 7661 6c65 6e74 2827 6b70 6327 293a 0a20  valent('kpc'):. 
-000258e0: 2020 2020 2020 2020 2020 206f 7574 5f72             out_r
-000258f0: 6164 203d 2072 6164 6975 732e 746f 286f  ad = radius.to(o
-00025900: 7574 5f75 6e69 7429 0a20 2020 2020 2020  ut_unit).       
-00025910: 2065 6c69 6620 7261 6469 7573 2e75 6e69   elif radius.uni
-00025920: 742e 6973 5f65 7175 6976 616c 656e 7428  t.is_equivalent(
-00025930: 276b 7063 2729 2061 6e64 206f 7574 5f75  'kpc') and out_u
-00025940: 6e69 742e 6973 5f65 7175 6976 616c 656e  nit.is_equivalen
-00025950: 7428 2764 6567 2729 3a0a 2020 2020 2020  t('deg'):.      
-00025960: 2020 2020 2020 6f75 745f 7261 6420 3d20        out_rad = 
-00025970: 7261 645f 746f 5f61 6e67 2872 6164 6975  rad_to_ang(radiu
-00025980: 732c 2073 656c 662e 5f72 6564 7368 6966  s, self._redshif
-00025990: 742c 2073 656c 662e 5f63 6f73 6d6f 292e  t, self._cosmo).
-000259a0: 746f 286f 7574 5f75 6e69 7429 0a20 2020  to(out_unit).   
-000259b0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-000259c0: 2020 2020 2020 2072 6169 7365 2055 6e69         raise Uni
-000259d0: 7443 6f6e 7665 7273 696f 6e45 7272 6f72  tConversionError
-000259e0: 2822 4361 6e6e 6f74 2075 6e64 6572 7374  ("Cannot underst
-000259f0: 616e 6420 7b7d 2061 7320 6120 6469 7374  and {} as a dist
-00025a00: 616e 6365 2075 6e69 7422 2e66 6f72 6d61  ance unit".forma
-00025a10: 7428 7374 7228 6f75 745f 756e 6974 2929  t(str(out_unit))
-00025a20: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
-00025a30: 6e20 6f75 745f 7261 640a 0a20 2020 2064  n out_rad..    d
-00025a40: 6566 2067 6574 5f72 6164 6975 7328 7365  ef get_radius(se
-00025a50: 6c66 2c20 7261 645f 6e61 6d65 3a20 7374  lf, rad_name: st
-00025a60: 722c 206f 7574 5f75 6e69 743a 2055 6e69  r, out_unit: Uni
-00025a70: 6f6e 5b55 6e69 742c 2073 7472 5d20 3d20  on[Unit, str] = 
-00025a80: 2764 6567 2729 202d 3e20 5175 616e 7469  'deg') -> Quanti
-00025a90: 7479 3a0a 2020 2020 2020 2020 2222 220a  ty:.        """.
-00025aa0: 2020 2020 2020 2020 416c 6c6f 7773 2061          Allows a
-00025ab0: 2072 6164 6975 7320 6173 736f 6369 6174   radius associat
-00025ac0: 6564 2077 6974 6820 7468 6973 2073 6f75  ed with this sou
-00025ad0: 7263 6520 746f 2062 6520 7265 7472 6965  rce to be retrie
-00025ae0: 7665 6420 696e 2073 7065 6369 6669 6564  ved in specified
-00025af0: 2064 6973 7461 6e63 6520 756e 6974 732e   distance units.
-00025b00: 204e 6f74 650a 2020 2020 2020 2020 7468   Note.        th
-00025b10: 6174 2070 6879 7369 6361 6c20 6469 7374  at physical dist
-00025b20: 616e 6365 2075 6e69 7473 2073 7563 6820  ance units such 
-00025b30: 6173 206b 696c 6f70 6172 7365 6373 206d  as kiloparsecs m
-00025b40: 6179 206f 6e6c 7920 6265 2075 7365 6420  ay only be used 
-00025b50: 6966 2074 6865 2073 6f75 7263 6520 6861  if the source ha
-00025b60: 730a 2020 2020 2020 2020 7265 6473 6869  s.        redshi
-00025b70: 6674 2069 6e66 6f72 6d61 7469 6f6e 2e0a  ft information..
-00025b80: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-00025b90: 7374 7220 7261 645f 6e61 6d65 3a20 5468  str rad_name: Th
-00025ba0: 6520 6e61 6d65 206f 6620 7468 6520 6465  e name of the de
-00025bb0: 7369 7265 6420 7261 6469 7573 2c20 7232  sired radius, r2
-00025bc0: 3030 2066 6f72 2069 6e73 7461 6e63 652e  00 for instance.
-00025bd0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-00025be0: 556e 6974 2f73 7472 206f 7574 5f75 6e69  Unit/str out_uni
-00025bf0: 743a 2041 6e20 6173 7472 6f70 7920 756e  t: An astropy un
-00025c00: 6974 2c20 6569 7468 6572 2061 2055 6e69  it, either a Uni
-00025c10: 7420 696e 7374 616e 6365 206f 7220 6120  t instance or a 
-00025c20: 7374 7269 6e67 0a20 2020 2020 2020 2020  string.         
-00025c30: 2020 2072 6570 7265 7365 6e74 6174 696f     representatio
-00025c40: 6e2e 2044 6566 6175 6c74 2069 7320 6465  n. Default is de
-00025c50: 6772 6565 732e 0a20 2020 2020 2020 203a  grees..        :
-00025c60: 7265 7475 726e 3a20 5468 6520 6465 7369  return: The desi
-00025c70: 7265 6420 7261 6469 7573 2069 6e20 7468  red radius in th
-00025c80: 6520 6465 7369 7265 6420 756e 6974 732e  e desired units.
-00025c90: 0a20 2020 2020 2020 203a 7274 7970 653a  .        :rtype:
-00025ca0: 2051 7561 6e74 6974 790a 2020 2020 2020   Quantity.      
-00025cb0: 2020 2222 220a 0a20 2020 2020 2020 2023    """..        #
-00025cc0: 2049 6e20 6361 7365 2073 6f6d 6562 6f64   In case somebod
-00025cd0: 7920 7479 7065 7320 696e 2052 3530 3020  y types in R500 
-00025ce0: 7261 7468 6572 2074 6861 6e20 7235 3030  rather than r500
-00025cf0: 2066 6f72 2069 6e73 7461 6e63 652e 0a20   for instance.. 
-00025d00: 2020 2020 2020 2072 6164 5f6e 616d 6520         rad_name 
-00025d10: 3d20 7261 645f 6e61 6d65 2e6c 6f77 6572  = rad_name.lower
-00025d20: 2829 0a20 2020 2020 2020 2069 6620 7261  ().        if ra
-00025d30: 645f 6e61 6d65 206e 6f74 2069 6e20 7365  d_name not in se
-00025d40: 6c66 2e5f 7261 6469 693a 0a20 2020 2020  lf._radii:.     
-00025d50: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-00025d60: 7565 4572 726f 7228 2254 6865 7265 2069  ueError("There i
-00025d70: 7320 6e6f 207b 727d 2072 6164 6975 7320  s no {r} radius 
-00025d80: 6173 736f 6369 6174 6564 2077 6974 6820  associated with 
-00025d90: 7468 6973 206f 626a 6563 742e 222e 666f  this object.".fo
-00025da0: 726d 6174 2872 3d72 6164 5f6e 616d 6529  rmat(r=rad_name)
-00025db0: 290a 0a20 2020 2020 2020 206f 7574 5f72  )..        out_r
-00025dc0: 6164 203d 2073 656c 662e 636f 6e76 6572  ad = self.conver
-00025dd0: 745f 7261 6469 7573 2873 656c 662e 5f72  t_radius(self._r
-00025de0: 6164 6969 5b72 6164 5f6e 616d 655d 2c20  adii[rad_name], 
-00025df0: 6f75 745f 756e 6974 290a 0a20 2020 2020  out_unit)..     
-00025e00: 2020 2072 6574 7572 6e20 6f75 745f 7261     return out_ra
-00025e10: 640a 0a20 2020 2040 7072 6f70 6572 7479  d..    @property
-00025e20: 0a20 2020 2064 6566 206e 756d 5f70 6e5f  .    def num_pn_
-00025e30: 6f62 7328 7365 6c66 2920 2d3e 2069 6e74  obs(self) -> int
-00025e40: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-00025e50: 2020 2020 2020 4765 7474 6572 206d 6574        Getter met
-00025e60: 686f 6420 7468 6174 2067 6976 6573 2074  hod that gives t
-00025e70: 6865 206e 756d 6265 7220 6f66 2050 4e20  he number of PN 
-00025e80: 6f62 7365 7276 6174 696f 6e73 2e0a 0a20  observations... 
-00025e90: 2020 2020 2020 203a 7265 7475 726e 3a20         :return: 
-00025ea0: 496e 7465 6765 7220 6e75 6d62 6572 206f  Integer number o
-00025eb0: 6620 504e 206f 6273 6572 7661 7469 6f6e  f PN observation
-00025ec0: 7320 6173 736f 6369 6174 6564 2077 6974  s associated wit
-00025ed0: 6820 7468 6973 2073 6f75 7263 650a 2020  h this source.  
-00025ee0: 2020 2020 2020 3a72 7479 7065 3a20 696e        :rtype: in
-00025ef0: 740a 2020 2020 2020 2020 2222 220a 2020  t.        """.  
-00025f00: 2020 2020 2020 7265 7475 726e 206c 656e        return len
-00025f10: 285b 6f20 666f 7220 6f20 696e 2073 656c  ([o for o in sel
-00025f20: 662e 6f62 735f 6964 7320 6966 2027 706e  f.obs_ids if 'pn
-00025f30: 2720 696e 2073 656c 662e 5f70 726f 6475  ' in self._produ
-00025f40: 6374 735b 6f5d 5d29 0a0a 2020 2020 4070  cts[o]])..    @p
-00025f50: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
-00025f60: 6e75 6d5f 6d6f 7331 5f6f 6273 2873 656c  num_mos1_obs(sel
-00025f70: 6629 202d 3e20 696e 743a 0a20 2020 2020  f) -> int:.     
-00025f80: 2020 2022 2222 0a20 2020 2020 2020 2047     """.        G
-00025f90: 6574 7465 7220 6d65 7468 6f64 2074 6861  etter method tha
-00025fa0: 7420 6769 7665 7320 7468 6520 6e75 6d62  t gives the numb
-00025fb0: 6572 206f 6620 4d4f 5331 206f 6273 6572  er of MOS1 obser
-00025fc0: 7661 7469 6f6e 732e 0a0a 2020 2020 2020  vations...      
-00025fd0: 2020 3a72 6574 7572 6e3a 2049 6e74 6567    :return: Integ
-00025fe0: 6572 206e 756d 6265 7220 6f66 204d 4f53  er number of MOS
-00025ff0: 3120 6f62 7365 7276 6174 696f 6e73 2061  1 observations a
-00026000: 7373 6f63 6961 7465 6420 7769 7468 2074  ssociated with t
-00026010: 6869 7320 736f 7572 6365 0a20 2020 2020  his source.     
-00026020: 2020 203a 7274 7970 653a 2069 6e74 0a20     :rtype: int. 
-00026030: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00026040: 2020 2072 6574 7572 6e20 6c65 6e28 5b6f     return len([o
-00026050: 2066 6f72 206f 2069 6e20 7365 6c66 2e6f   for o in self.o
-00026060: 6273 5f69 6473 2069 6620 276d 6f73 3127  bs_ids if 'mos1'
-00026070: 2069 6e20 7365 6c66 2e5f 7072 6f64 7563   in self._produc
-00026080: 7473 5b6f 5d5d 290a 0a20 2020 2040 7072  ts[o]])..    @pr
-00026090: 6f70 6572 7479 0a20 2020 2064 6566 206e  operty.    def n
-000260a0: 756d 5f6d 6f73 325f 6f62 7328 7365 6c66  um_mos2_obs(self
-000260b0: 2920 2d3e 2069 6e74 3a0a 2020 2020 2020  ) -> int:.      
-000260c0: 2020 2222 220a 2020 2020 2020 2020 4765    """.        Ge
-000260d0: 7474 6572 206d 6574 686f 6420 7468 6174  tter method that
-000260e0: 2067 6976 6573 2074 6865 206e 756d 6265   gives the numbe
-000260f0: 7220 6f66 204d 4f53 3220 6f62 7365 7276  r of MOS2 observ
-00026100: 6174 696f 6e73 2e0a 0a20 2020 2020 2020  ations...       
-00026110: 203a 7265 7475 726e 3a20 496e 7465 6765   :return: Intege
-00026120: 7220 6e75 6d62 6572 206f 6620 4d4f 5332  r number of MOS2
-00026130: 206f 6273 6572 7661 7469 6f6e 7320 6173   observations as
-00026140: 736f 6369 6174 6564 2077 6974 6820 7468  sociated with th
-00026150: 6973 2073 6f75 7263 650a 2020 2020 2020  is source.      
-00026160: 2020 3a72 7479 7065 3a20 696e 740a 2020    :rtype: int.  
-00026170: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00026180: 2020 7265 7475 726e 206c 656e 285b 6f20    return len([o 
-00026190: 666f 7220 6f20 696e 2073 656c 662e 6f62  for o in self.ob
-000261a0: 735f 6964 7320 6966 2027 6d6f 7332 2720  s_ids if 'mos2' 
-000261b0: 696e 2073 656c 662e 5f70 726f 6475 6374  in self._product
-000261c0: 735b 6f5d 5d29 0a0a 2020 2020 2320 4173  s[o]])..    # As
-000261d0: 2074 6869 7320 6973 2061 6e20 696e 7472   this is an intr
-000261e0: 696e 7369 6320 7072 6f70 6572 7479 206f  insic property o
-000261f0: 6620 7768 6963 6820 6d61 7463 6865 6420  f which matched 
-00026200: 6f62 7365 7276 6174 696f 6e73 2061 7265  observations are
-00026210: 2076 616c 6964 2c20 7468 6572 6520 7769   valid, there wi
-00026220: 6c6c 2062 6520 6e6f 2073 6574 7465 720a  ll be no setter.
-00026230: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
-00026240: 2020 6465 6620 696e 7374 7275 6d65 6e74    def instrument
-00026250: 7328 7365 6c66 2920 2d3e 2044 6963 743a  s(self) -> Dict:
-00026260: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00026270: 2020 2020 2041 2070 726f 7065 7274 7920       A property 
-00026280: 6f66 2061 2073 6f75 7263 6520 7468 6174  of a source that
-00026290: 2064 6574 6169 6c73 2077 6869 6368 2069   details which i
-000262a0: 6e73 7472 756d 656e 7473 2068 6176 6520  nstruments have 
-000262b0: 7661 6c69 6420 6461 7461 2066 6f72 2077  valid data for w
-000262c0: 6869 6368 206f 6273 6572 7661 7469 6f6e  hich observation
-000262d0: 732e 0a0a 2020 2020 2020 2020 3a72 6574  s...        :ret
-000262e0: 7572 6e3a 2041 2064 6963 7469 6f6e 6172  urn: A dictionar
-000262f0: 7920 6f66 204f 6273 4944 7320 616e 6420  y of ObsIDs and 
-00026300: 7468 6569 7220 6173 736f 6369 6174 6564  their associated
-00026310: 2076 616c 6964 2069 6e73 7472 756d 656e   valid instrumen
-00026320: 7473 2e0a 2020 2020 2020 2020 3a72 7479  ts..        :rty
-00026330: 7065 3a20 4469 6374 0a20 2020 2020 2020  pe: Dict.       
-00026340: 2022 2222 0a20 2020 2020 2020 2072 6574   """.        ret
-00026350: 7572 6e20 7365 6c66 2e5f 696e 7374 7275  urn self._instru
-00026360: 6d65 6e74 730a 0a20 2020 2040 7072 6f70  ments..    @prop
-00026370: 6572 7479 0a20 2020 2064 6566 2064 6973  erty.    def dis
-00026380: 6173 736f 6369 6174 6564 2873 656c 6629  associated(self)
-00026390: 202d 3e20 626f 6f6c 3a0a 2020 2020 2020   -> bool:.      
-000263a0: 2020 2222 220a 2020 2020 2020 2020 5072    """.        Pr
-000263b0: 6f70 6572 7479 2074 6861 7420 6465 7363  operty that desc
-000263c0: 7269 6265 7320 7768 6574 6865 7220 7468  ribes whether th
-000263d0: 6973 2073 6f75 7263 6520 6861 7320 6861  is source has ha
-000263e0: 6420 4f62 7349 4473 2064 6973 6173 736f  d ObsIDs disasso
-000263f0: 6369 6174 6564 2066 726f 6d20 6974 2e0a  ciated from it..
-00026400: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
-00026410: 3a20 4120 626f 6f6c 6561 6e20 666c 6167  : A boolean flag
-00026420: 2c20 5472 7565 206d 6561 6e73 2074 6861  , True means tha
-00026430: 7420 4f62 7349 4473 2f69 6e73 7472 756d  t ObsIDs/instrum
-00026440: 656e 7473 2068 6176 6520 6265 656e 2072  ents have been r
-00026450: 656d 6f76 6564 2c20 4661 6c73 6520 6d65  emoved, False me
-00026460: 616e 7320 7468 6579 2068 6176 656e 2774  ans they haven't
-00026470: 2e0a 2020 2020 2020 2020 3a72 7479 7065  ..        :rtype
-00026480: 3a20 626f 6f6c 0a20 2020 2020 2020 2022  : bool.        "
-00026490: 2222 0a20 2020 2020 2020 2072 6574 7572  "".        retur
-000264a0: 6e20 7365 6c66 2e5f 6469 7361 7373 6f63  n self._disassoc
-000264b0: 6961 7465 640a 0a20 2020 2040 7072 6f70  iated..    @prop
-000264c0: 6572 7479 0a20 2020 2064 6566 2064 6973  erty.    def dis
-000264d0: 6173 736f 6369 6174 6564 5f6f 6273 2873  associated_obs(s
-000264e0: 656c 6629 202d 3e20 6469 6374 3a0a 2020  elf) -> dict:.  
-000264f0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00026500: 2020 5072 6f70 6572 7479 2074 6861 7420    Property that 
-00026510: 6465 7461 696c 7320 6578 6163 746c 7920  details exactly 
-00026520: 7768 6174 2064 6174 6120 6861 7320 6265  what data has be
-00026530: 656e 2064 6973 6173 736f 6369 6174 6564  en disassociated
-00026540: 2066 726f 6d20 7468 6973 2073 6f75 7263   from this sourc
-00026550: 652c 2069 6620 616e 792e 0a0a 2020 2020  e, if any...    
-00026560: 2020 2020 3a72 6574 7572 6e3a 2044 6963      :return: Dic
-00026570: 7469 6f6e 6172 7920 6465 7363 7269 6269  tionary describi
-00026580: 6e67 2077 6869 6368 2069 6e73 7472 756d  ng which instrum
-00026590: 656e 7473 206f 6620 7768 6963 6820 4f62  ents of which Ob
-000265a0: 7349 4473 2068 6176 6520 6265 656e 2064  sIDs have been d
-000265b0: 6973 6173 736f 6369 6174 6564 2066 726f  isassociated fro
-000265c0: 6d20 7468 6973 2073 6f75 7263 652e 0a20  m this source.. 
-000265d0: 2020 2020 2020 203a 7274 7970 653a 2064         :rtype: d
-000265e0: 6963 740a 2020 2020 2020 2020 2222 220a  ict.        """.
-000265f0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00026600: 656c 662e 5f64 6973 6173 736f 6369 6174  elf._disassociat
-00026610: 6564 5f6f 6273 0a0a 2020 2020 6465 6620  ed_obs..    def 
-00026620: 6469 7361 7373 6f63 6961 7465 5f6f 6273  disassociate_obs
-00026630: 2873 656c 662c 2074 6f5f 7265 6d6f 7665  (self, to_remove
-00026640: 3a20 556e 696f 6e5b 6469 6374 2c20 7374  : Union[dict, st
-00026650: 722c 206c 6973 745d 293a 0a20 2020 2020  r, list]):.     
-00026660: 2020 2022 2222 0a20 2020 2020 2020 204d     """.        M
-00026670: 6574 686f 6420 7468 6174 2075 7365 7320  ethod that uses 
-00026680: 7468 6520 7375 7070 6c69 6564 2064 6963  the supplied dic
-00026690: 7469 6f6e 6172 7920 746f 2073 6166 656c  tionary to safel
-000266a0: 7920 7265 6d6f 7665 2064 6174 6120 6672  y remove data fr
-000266b0: 6f6d 2074 6865 2073 6f75 7263 652e 2054  om the source. T
-000266c0: 6869 7320 6461 7461 2077 696c 6c20 6e6f  his data will no
-000266d0: 206c 6f6e 6765 720a 2020 2020 2020 2020   longer.        
-000266e0: 6265 2075 7365 6420 696e 2061 6e79 2061  be used in any a
-000266f0: 6e61 6c79 7365 732c 2061 6e64 2077 6f75  nalyses, and wou
-00026700: 6c64 2074 7970 6963 616c 6c79 2062 6520  ld typically be 
-00026710: 7265 6d6f 7665 6420 6265 6361 7573 6520  removed because 
-00026720: 6974 2069 7320 6f66 2070 6f6f 7220 7175  it is of poor qu
-00026730: 616c 6974 792c 206f 7220 646f 6573 6e27  ality, or doesn'
-00026740: 7420 636f 6e74 7269 6275 7465 0a20 2020  t contribute.   
-00026750: 2020 2020 2065 6e6f 7567 6820 746f 206a       enough to j
-00026760: 7573 7469 6679 2069 7473 2070 7265 7365  ustify its prese
-00026770: 6e63 652e 0a0a 2020 2020 2020 2020 3a70  nce...        :p
-00026780: 6172 616d 2064 6963 742f 7374 722f 6c69  aram dict/str/li
-00026790: 7374 2074 6f5f 7265 6d6f 7665 3a20 4569  st to_remove: Ei
-000267a0: 7468 6572 2061 2064 6963 7469 6f6e 6172  ther a dictionar
-000267b0: 7920 6f66 206f 6273 6572 7661 7469 6f6e  y of observation
-000267c0: 7320 746f 2072 656d 6f76 652c 2028 696e  s to remove, (in
-000267d0: 2074 6865 2073 7479 6c65 206f 660a 2020   the style of.  
-000267e0: 2020 2020 2020 2020 2020 7468 6520 736f            the so
-000267f0: 7572 6365 2e69 6e73 7472 756d 656e 7473  urce.instruments
-00026800: 2064 6963 7469 6f6e 6172 7920 7769 7468   dictionary with
-00026810: 2074 6865 2074 6f70 206c 6576 656c 206b   the top level k
-00026820: 6579 7320 6265 696e 6720 4f62 7349 4473  eys being ObsIDs
-00026830: 2c20 616e 6420 7468 6520 6c6f 7765 7220  , and the lower 
-00026840: 6c65 7665 6c73 0a20 2020 2020 2020 2020  levels.         
-00026850: 2020 2062 6569 6e67 2069 6e73 7472 756d     being instrum
-00026860: 656e 7420 6e61 6d65 7329 2c20 6120 7374  ent names), a st
-00026870: 7269 6e67 2063 6f6e 7461 696e 696e 6720  ring containing 
-00026880: 616e 204f 6273 4944 2c20 6f72 2061 206c  an ObsID, or a l
-00026890: 6973 7420 6f66 204f 6273 4944 732e 0a20  ist of ObsIDs.. 
-000268a0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-000268b0: 2020 2023 2055 7365 7273 2063 616e 2070     # Users can p
-000268c0: 6173 7320 6a75 7374 2061 6e20 4f62 7349  ass just an ObsI
-000268d0: 4420 7374 7269 6e67 2c20 6275 7420 7765  D string, but we
-000268e0: 2074 6865 6e20 6e65 6564 2074 6f20 636f   then need to co
-000268f0: 6e76 6572 7420 6974 2074 6f20 7468 6520  nvert it to the 
-00026900: 666f 726d 0a20 2020 2020 2020 2023 2020  form.        #  
-00026910: 7468 6174 2074 6865 2072 6573 7420 6f66  that the rest of
-00026920: 2074 6865 2066 756e 6374 696f 6e20 7265   the function re
-00026930: 7175 6972 6573 0a20 2020 2020 2020 2069  quires.        i
-00026940: 6620 6973 696e 7374 616e 6365 2874 6f5f  f isinstance(to_
-00026950: 7265 6d6f 7665 2c20 7374 7229 3a0a 2020  remove, str):.  
-00026960: 2020 2020 2020 2020 2020 746f 5f72 656d            to_rem
-00026970: 6f76 6520 3d20 7b74 6f5f 7265 6d6f 7665  ove = {to_remove
-00026980: 3a20 6465 6570 636f 7079 2873 656c 662e  : deepcopy(self.
-00026990: 696e 7374 7275 6d65 6e74 735b 746f 5f72  instruments[to_r
-000269a0: 656d 6f76 655d 297d 0a20 2020 2020 2020  emove])}.       
-000269b0: 2023 2048 6572 6520 6973 2077 6865 7265   # Here is where
-000269c0: 2074 6865 7920 6861 7665 206a 7573 7420   they have just 
-000269d0: 7061 7373 6564 2061 206c 6973 7420 6f66  passed a list of
-000269e0: 204f 6273 4944 732c 2061 6e64 2077 6520   ObsIDs, and we 
-000269f0: 6e65 6564 2074 6f20 6669 6c6c 2069 6e20  need to fill in 
-00026a00: 7468 6520 626c 616e 6b73 2077 6974 6820  the blanks with 
-00026a10: 7468 6520 696e 7374 7275 6d65 6e74 730a  the instruments.
-00026a20: 2020 2020 2020 2020 2320 2063 7572 7265          #  curre
-00026a30: 6e74 6c79 206c 6f61 6465 6420 666f 7220  ntly loaded for 
-00026a40: 7468 6f73 6520 4f62 7349 4473 0a20 2020  those ObsIDs.   
-00026a50: 2020 2020 2065 6c69 6620 6973 696e 7374       elif isinst
-00026a60: 616e 6365 2874 6f5f 7265 6d6f 7665 2c20  ance(to_remove, 
-00026a70: 6c69 7374 293a 0a20 2020 2020 2020 2020  list):.         
-00026a80: 2020 2074 6f5f 7265 6d6f 7665 203d 207b     to_remove = {
-00026a90: 6f3a 2064 6565 7063 6f70 7928 7365 6c66  o: deepcopy(self
-00026aa0: 2e69 6e73 7472 756d 656e 7473 5b6f 5d29  .instruments[o])
-00026ab0: 2066 6f72 206f 2069 6e20 746f 5f72 656d   for o in to_rem
-00026ac0: 6f76 657d 0a20 2020 2020 2020 2023 2048  ove}.        # H
-00026ad0: 6572 6520 6465 616c 7320 7769 7468 2077  ere deals with w
-00026ae0: 6865 6e20 736f 6d65 6f6e 6520 6d69 6768  hen someone migh
-00026af0: 7420 6861 7665 2070 6173 7365 6420 6120  t have passed a 
-00026b00: 6469 6374 696f 6e61 7279 2077 6865 7265  dictionary where
-00026b10: 2074 6865 7265 2069 7320 6120 7369 6e67   there is a sing
-00026b20: 6c65 2069 6e73 7472 756d 656e 742c 2061  le instrument, a
-00026b30: 6e64 0a20 2020 2020 2020 2023 2020 7468  nd.        #  th
-00026b40: 6579 2068 6176 656e 2774 2070 7574 2069  ey haven't put i
-00026b50: 7420 696e 2061 206c 6973 743b 2065 2e67  t in a list; e.g
-00026b60: 2e20 7b27 3032 3031 3930 3335 3031 273a  . {'0201903501':
-00026b70: 2027 706e 277d 2e20 5468 6973 2064 6574   'pn'}. This det
-00026b80: 6563 7473 2069 6e73 7461 6e63 6573 206c  ects instances l
-00026b90: 696b 6520 7468 6174 2061 6e64 2074 6865  ike that and the
-00026ba0: 6e0a 2020 2020 2020 2020 2320 2070 7574  n.        #  put
-00026bb0: 7320 7468 6520 696e 6469 7669 6475 616c  s the individual
-00026bc0: 2069 6e73 7472 756d 656e 7420 696e 2061   instrument in a
-00026bd0: 206c 6973 7420 6173 2069 7320 6578 7065   list as is expe
-00026be0: 6374 6564 2062 7920 7468 6520 7265 7374  cted by the rest
-00026bf0: 206f 6620 7468 6520 6675 6e63 7469 6f6e   of the function
-00026c00: 0a20 2020 2020 2020 2065 6c69 6620 6973  .        elif is
-00026c10: 696e 7374 616e 6365 2874 6f5f 7265 6d6f  instance(to_remo
-00026c20: 7665 2c20 6469 6374 2920 616e 6420 6e6f  ve, dict) and no
-00026c30: 7420 616c 6c28 5b69 7369 6e73 7461 6e63  t all([isinstanc
-00026c40: 6528 762c 206c 6973 7429 2066 6f72 2076  e(v, list) for v
-00026c50: 2069 6e20 746f 5f72 656d 6f76 652e 7661   in to_remove.va
-00026c60: 6c75 6573 2829 5d29 3a0a 2020 2020 2020  lues()]):.      
-00026c70: 2020 2020 2020 6e65 775f 746f 5f72 656d        new_to_rem
-00026c80: 6f76 6520 3d20 7b7d 0a20 2020 2020 2020  ove = {}.       
-00026c90: 2020 2020 2066 6f72 206f 2069 6e20 746f       for o in to
-00026ca0: 5f72 656d 6f76 653a 0a20 2020 2020 2020  _remove:.       
-00026cb0: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-00026cc0: 6973 696e 7374 616e 6365 2874 6f5f 7265  isinstance(to_re
-00026cd0: 6d6f 7665 5b6f 5d2c 206c 6973 7429 3a0a  move[o], list):.
-00026ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026cf0: 2020 2020 6e65 775f 746f 5f72 656d 6f76      new_to_remov
-00026d00: 655b 6f5d 203d 205b 6465 6570 636f 7079  e[o] = [deepcopy
-00026d10: 2874 6f5f 7265 6d6f 7665 5b6f 5d29 5d0a  (to_remove[o])].
-00026d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026d30: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00026d40: 2020 2020 2020 2020 2020 6e65 775f 746f            new_to
-00026d50: 5f72 656d 6f76 655b 6f5d 203d 2064 6565  _remove[o] = dee
-00026d60: 7063 6f70 7928 746f 5f72 656d 6f76 655b  pcopy(to_remove[
-00026d70: 6f5d 290a 0a20 2020 2020 2020 2020 2020  o])..           
-00026d80: 2023 2049 2075 7365 2064 6565 7063 6f70   # I use deepcop
-00026d90: 7920 6167 6169 6e20 6265 6361 7573 6520  y again because 
-00026da0: 7468 6572 6520 6861 7665 2062 6565 6e20  there have been 
-00026db0: 6973 7375 6573 2077 6974 6820 7468 6973  issues with this
-00026dc0: 2066 756e 6374 696f 6e20 7374 696c 6c20   function still 
-00026dd0: 706f 696e 7469 6e67 2074 6f20 6f6c 6420  pointing to old 
-00026de0: 6d65 6d6f 7279 0a20 2020 2020 2020 2020  memory.         
-00026df0: 2020 2023 2020 6164 6472 6573 7365 732c     #  addresses,
-00026e00: 2073 6f20 4927 6d20 7175 6974 6520 7061   so I'm quite pa
-00026e10: 7261 6e6f 6964 2069 6e20 7468 6973 2062  ranoid in this b
-00026e20: 6974 206f 6620 636f 6465 0a20 2020 2020  it of code.     
-00026e30: 2020 2020 2020 2074 6f5f 7265 6d6f 7665         to_remove
-00026e40: 203d 2064 6565 7063 6f70 7928 6e65 775f   = deepcopy(new_
-00026e50: 746f 5f72 656d 6f76 6529 0a0a 2020 2020  to_remove)..    
-00026e60: 2020 2020 2320 5765 2061 6c73 6f20 6368      # We also ch
-00026e70: 6563 6b20 746f 206d 616b 6520 7375 7265  eck to make sure
-00026e80: 2074 6861 7420 7468 6520 6461 7461 2077   that the data w
-00026e90: 6527 7265 2062 6569 6e67 2061 736b 6564  e're being asked
-00026ea0: 2074 6f20 7265 6d6f 7665 2061 6374 7561   to remove actua
-00026eb0: 6c6c 7920 6973 2061 7373 6f63 6961 7465  lly is associate
-00026ec0: 6420 7769 7468 2074 6865 0a20 2020 2020  d with the.     
-00026ed0: 2020 2023 2020 736f 7572 6365 2e20 5765     #  source. We
-00026ee0: 2073 6861 6c6c 2062 6520 666f 7267 6976   shall be forgiv
-00026ef0: 696e 6720 6966 2069 7420 6973 6e27 742c  ing if it isn't,
-00026f00: 2061 6e64 206a 7573 7420 6973 7375 6520   and just issue 
-00026f10: 6120 7761 726e 696e 6720 746f 206c 6574  a warning to let
-00026f20: 2074 6865 2075 7365 7220 6b6e 6f77 2074   the user know t
-00026f30: 6861 7420 7468 6579 2061 7265 0a20 2020  hat they are.   
-00026f40: 2020 2020 2023 2020 6173 7375 6d69 6e67       #  assuming
-00026f50: 2064 6174 6120 7761 7320 6865 7265 2074   data was here t
-00026f60: 6861 7420 6163 7475 616c 6c79 2069 736e  hat actually isn
-00026f70: 2774 2070 7265 7365 6e74 0a20 2020 2020  't present.     
-00026f80: 2020 2023 2049 7465 7261 7469 6e67 2074     # Iterating t
-00026f90: 6872 6f75 6768 2074 6865 206b 6579 7320  hrough the keys 
-00026fa0: 284f 6273 4944 7329 2069 6e20 746f 5f72  (ObsIDs) in to_r
-00026fb0: 656d 6f76 650a 2020 2020 2020 2020 666f  emove.        fo
-00026fc0: 7220 6f20 696e 2074 6f5f 7265 6d6f 7665  r o in to_remove
-00026fd0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00026fe0: 206f 206e 6f74 2069 6e20 7365 6c66 2e6f   o not in self.o
-00026ff0: 6273 5f69 6473 3a0a 2020 2020 2020 2020  bs_ids:.        
-00027000: 2020 2020 2020 2020 7761 726e 2822 7b6f          warn("{o
-00027010: 7d20 6461 7461 2063 616e 6e6f 7420 6265  } data cannot be
-00027020: 2072 656d 6f76 6564 2066 726f 6d20 7b73   removed from {s
-00027030: 7d20 6173 2074 6865 7920 6172 6520 6e6f  } as they are no
-00027040: 7420 6173 736f 6369 6174 6564 2077 6974  t associated wit
-00027050: 6820 220a 2020 2020 2020 2020 2020 2020  h ".            
-00027060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027070: 2020 2269 742e 222e 666f 726d 6174 286f    "it.".format(o
-00027080: 3d6f 2c20 733d 7365 6c66 2e6e 616d 6529  =o, s=self.name)
-00027090: 2c20 7374 6163 6b6c 6576 656c 3d32 290a  , stacklevel=2).
-000270a0: 2020 2020 2020 2020 2020 2020 2320 4368              # Ch
-000270b0: 6563 6b20 746f 2073 6565 2077 6865 7468  eck to see wheth
-000270c0: 6572 2061 6e79 206f 6620 7468 6520 696e  er any of the in
-000270d0: 7374 7275 6d65 6e74 7320 666f 7220 6f20  struments for o 
-000270e0: 6172 6520 6e6f 7420 6163 7475 616c 6c79  are not actually
-000270f0: 2061 7373 6f63 6961 7465 6420 7769 7468   associated with
-00027100: 2074 6865 2073 6f75 7263 650a 2020 2020   the source.    
-00027110: 2020 2020 2020 2020 656c 6966 2061 6e79          elif any
-00027120: 285b 6920 6e6f 7420 696e 2073 656c 662e  ([i not in self.
-00027130: 696e 7374 7275 6d65 6e74 735b 6f5d 2066  instruments[o] f
-00027140: 6f72 2069 2069 6e20 746f 5f72 656d 6f76  or i in to_remov
-00027150: 655b 6f5d 5d29 3a0a 2020 2020 2020 2020  e[o]]):.        
-00027160: 2020 2020 2020 2020 6261 645f 6c69 7374          bad_list
-00027170: 203d 205b 6920 666f 7220 6920 696e 2074   = [i for i in t
-00027180: 6f5f 7265 6d6f 7665 5b6f 5d20 6966 2069  o_remove[o] if i
-00027190: 206e 6f74 2069 6e20 7365 6c66 2e69 6e73   not in self.ins
-000271a0: 7472 756d 656e 7473 5b6f 5d5d 0a20 2020  truments[o]].   
-000271b0: 2020 2020 2020 2020 2020 2020 2062 6164               bad
-000271c0: 5f73 7472 203d 2022 2f22 2e6a 6f69 6e28  _str = "/".join(
-000271d0: 6261 645f 6c69 7374 290a 2020 2020 2020  bad_list).      
-000271e0: 2020 2020 2020 2020 2020 7761 726e 2822            warn("
-000271f0: 7b6f 7d2d 7b69 627d 2064 6174 6120 6361  {o}-{ib} data ca
-00027200: 6e6e 6f74 2062 6520 7265 6d6f 7665 6420  nnot be removed 
-00027210: 6672 6f6d 207b 737d 2061 7320 7468 6579  from {s} as they
-00027220: 2061 7265 206e 6f74 2061 7373 6f63 6961   are not associa
-00027230: 7465 6420 220a 2020 2020 2020 2020 2020  ted ".          
-00027240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027250: 2020 2020 2277 6974 6820 6974 2e22 2e66      "with it.".f
-00027260: 6f72 6d61 7428 6f3d 6f2c 2069 623d 6261  ormat(o=o, ib=ba
-00027270: 645f 7374 722c 2073 3d73 656c 662e 6e61  d_str, s=self.na
-00027280: 6d65 292c 2073 7461 636b 6c65 7665 6c3d  me), stacklevel=
-00027290: 3229 0a0a 2020 2020 2020 2020 2320 5365  2)..        # Se
-000272a0: 7473 2074 6865 2061 7474 7269 6275 7465  ts the attribute
-000272b0: 2074 6861 7420 7465 6c6c 7320 7573 2077   that tells us w
-000272c0: 6865 7468 6572 2061 6e79 2064 6174 6120  hether any data 
-000272d0: 6861 7320 6265 656e 2072 656d 6f76 6564  has been removed
-000272e0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-000272f0: 7365 6c66 2e5f 6469 7361 7373 6f63 6961  self._disassocia
-00027300: 7465 643a 0a20 2020 2020 2020 2020 2020  ted:.           
-00027310: 2073 656c 662e 5f64 6973 6173 736f 6369   self._disassoci
-00027320: 6174 6564 203d 2054 7275 650a 0a20 2020  ated = True..   
-00027330: 2020 2020 2023 2057 6520 7761 6e74 2074       # We want t
-00027340: 6f20 7374 6f72 6520 6b6e 6f77 6c65 6467  o store knowledg
-00027350: 6520 6f66 2077 6861 7420 6461 7461 2068  e of what data h
-00027360: 6173 2062 6565 6e20 7265 6d6f 7665 642c  as been removed,
-00027370: 2069 6620 7468 6572 6520 6861 736e 2774   if there hasn't
-00027380: 2062 6565 6e20 616e 7974 6869 6e67 2074   been anything t
-00027390: 616b 656e 2061 7761 7920 7965 740a 2020  aken away yet.  
-000273a0: 2020 2020 2020 2320 2074 6865 6e20 7765        #  then we
-000273b0: 2063 616e 206a 7573 7420 7365 7420 6974   can just set it
-000273c0: 2065 7175 616c 2074 6f20 7468 6520 746f   equal to the to
-000273d0: 5f72 656d 6f76 6520 6469 6374 696f 6e61  _remove dictiona
-000273e0: 7279 0a20 2020 2020 2020 2069 6620 6c65  ry.        if le
-000273f0: 6e28 7365 6c66 2e5f 6469 7361 7373 6f63  n(self._disassoc
-00027400: 6961 7465 645f 6f62 7329 203d 3d20 303a  iated_obs) == 0:
-00027410: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00027420: 662e 5f64 6973 6173 736f 6369 6174 6564  f._disassociated
-00027430: 5f6f 6273 203d 2074 6f5f 7265 6d6f 7665  _obs = to_remove
-00027440: 0a20 2020 2020 2020 2023 204f 7468 6572  .        # Other
-00027450: 7769 7365 2077 6520 6861 7665 2074 6f20  wise we have to 
-00027460: 6164 6420 7468 6520 6461 7461 2074 6f20  add the data to 
-00027470: 7468 6520 6578 6973 7469 6e67 2064 6963  the existing dic
-00027480: 7469 6f6e 6172 7920 7374 7275 6374 7572  tionary structur
-00027490: 650a 2020 2020 2020 2020 656c 7365 3a0a  e.        else:.
-000274a0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-000274b0: 6f20 696e 2074 6f5f 7265 6d6f 7665 3a0a  o in to_remove:.
-000274c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000274d0: 6966 206f 206e 6f74 2069 6e20 7365 6c66  if o not in self
-000274e0: 2e5f 6469 7361 7373 6f63 6961 7465 645f  ._disassociated_
-000274f0: 6f62 733a 0a20 2020 2020 2020 2020 2020  obs:.           
-00027500: 2020 2020 2020 2020 2073 656c 662e 5f64           self._d
-00027510: 6973 6173 736f 6369 6174 6564 5f6f 6273  isassociated_obs
-00027520: 5b6f 5d20 3d20 746f 5f72 656d 6f76 655b  [o] = to_remove[
-00027530: 6f5d 0a20 2020 2020 2020 2020 2020 2020  o].             
-00027540: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00027550: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00027560: 662e 5f64 6973 6173 736f 6369 6174 6564  f._disassociated
-00027570: 5f6f 6273 5b6f 5d20 2b3d 2074 6f5f 7265  _obs[o] += to_re
-00027580: 6d6f 7665 5b6f 5d0a 0a20 2020 2020 2020  move[o]..       
-00027590: 2023 2049 6620 7765 2772 6520 756e 2d61   # If we're un-a
-000275a0: 7373 6f63 6961 7469 6e67 2063 6572 7461  ssociating certa
-000275b0: 696e 206f 6273 6572 7661 7469 6f6e 732c  in observations,
-000275c0: 206f 6464 7320 6f6e 2074 6865 2063 6f6d   odds on the com
-000275d0: 6269 6e65 6420 7072 6f64 7563 7473 2061  bined products a
-000275e0: 7265 206e 6f20 6c6f 6e67 6572 2076 616c  re no longer val
-000275f0: 6964 0a20 2020 2020 2020 2069 6620 2263  id.        if "c
-00027600: 6f6d 6269 6e65 6422 2069 6e20 7365 6c66  ombined" in self
-00027610: 2e5f 7072 6f64 7563 7473 3a0a 2020 2020  ._products:.    
-00027620: 2020 2020 2020 2020 6465 6c20 7365 6c66          del self
-00027630: 2e5f 7072 6f64 7563 7473 5b22 636f 6d62  ._products["comb
-00027640: 696e 6564 225d 0a20 2020 2020 2020 2020  ined"].         
-00027650: 2020 2069 6620 2263 6f6d 6269 6e65 6422     if "combined"
-00027660: 2069 6e20 7365 6c66 2e5f 696e 7465 726c   in self._interl
-00027670: 6f70 6572 5f6d 6173 6b73 3a0a 2020 2020  oper_masks:.    
-00027680: 2020 2020 2020 2020 2020 2020 6465 6c20              del 
-00027690: 7365 6c66 2e5f 696e 7465 726c 6f70 6572  self._interloper
-000276a0: 5f6d 6173 6b73 5b22 636f 6d62 696e 6564  _masks["combined
-000276b0: 225d 0a20 2020 2020 2020 2020 2020 2073  "].            s
-000276c0: 656c 662e 5f66 6974 5f72 6573 756c 7473  elf._fit_results
-000276d0: 203d 207b 7d0a 2020 2020 2020 2020 2020   = {}.          
-000276e0: 2020 7365 6c66 2e5f 7465 7374 5f73 7461    self._test_sta
-000276f0: 7420 3d20 7b7d 0a20 2020 2020 2020 2020  t = {}.         
-00027700: 2020 2073 656c 662e 5f64 6f66 203d 207b     self._dof = {
-00027710: 7d0a 2020 2020 2020 2020 2020 2020 7365  }.            se
-00027720: 6c66 2e5f 746f 7461 6c5f 636f 756e 745f  lf._total_count_
-00027730: 7261 7465 203d 207b 7d0a 2020 2020 2020  rate = {}.      
-00027740: 2020 2020 2020 7365 6c66 2e5f 746f 7461        self._tota
-00027750: 6c5f 6578 7020 3d20 7b7d 0a20 2020 2020  l_exp = {}.     
-00027760: 2020 2020 2020 2073 656c 662e 5f6c 756d         self._lum
-00027770: 696e 6f73 6974 6965 7320 3d20 7b7d 0a0a  inosities = {}..
-00027780: 2020 2020 2020 2020 666f 7220 6f20 696e          for o in
-00027790: 2074 6f5f 7265 6d6f 7665 3a0a 2020 2020   to_remove:.    
-000277a0: 2020 2020 2020 2020 666f 7220 6920 696e          for i in
-000277b0: 2074 6f5f 7265 6d6f 7665 5b6f 5d3a 0a20   to_remove[o]:. 
-000277c0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-000277d0: 656c 2073 656c 662e 5f70 726f 6475 6374  el self._product
-000277e0: 735b 6f5d 5b69 5d0a 2020 2020 2020 2020  s[o][i].        
-000277f0: 2020 2020 2020 2020 6465 6c20 7365 6c66          del self
-00027800: 2e5f 696e 7374 7275 6d65 6e74 735b 6f5d  ._instruments[o]
-00027810: 5b73 656c 662e 5f69 6e73 7472 756d 656e  [self._instrumen
-00027820: 7473 5b6f 5d2e 696e 6465 7828 6929 5d0a  ts[o].index(i)].
-00027830: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00027840: 6c65 6e28 7365 6c66 2e5f 696e 7374 7275  len(self._instru
-00027850: 6d65 6e74 735b 6f5d 2920 3d3d 2030 3a0a  ments[o]) == 0:.
-00027860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027870: 6465 6c20 7365 6c66 2e5f 7072 6f64 7563  del self._produc
-00027880: 7473 5b6f 5d0a 2020 2020 2020 2020 2020  ts[o].          
-00027890: 2020 2020 2020 6465 6c20 7365 6c66 2e5f        del self._
-000278a0: 6465 7465 6374 6564 5b6f 5d0a 2020 2020  detected[o].    
-000278b0: 2020 2020 2020 2020 2020 2020 6465 6c20              del 
-000278c0: 7365 6c66 2e5f 696e 6974 6961 6c5f 7265  self._initial_re
-000278d0: 6769 6f6e 735b 6f5d 0a20 2020 2020 2020  gions[o].       
-000278e0: 2020 2020 2020 2020 2064 656c 2073 656c           del sel
-000278f0: 662e 5f69 6e69 7469 616c 5f72 6567 696f  f._initial_regio
-00027900: 6e5f 6d61 7463 6865 735b 6f5d 0a20 2020  n_matches[o].   
-00027910: 2020 2020 2020 2020 2020 2020 2064 656c               del
-00027920: 2073 656c 662e 5f72 6567 696f 6e73 5b6f   self._regions[o
-00027930: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00027940: 2020 6465 6c20 7365 6c66 2e5f 6f74 6865    del self._othe
-00027950: 725f 7265 6769 6f6e 735b 6f5d 0a20 2020  r_regions[o].   
-00027960: 2020 2020 2020 2020 2020 2020 2064 656c               del
-00027970: 2073 656c 662e 5f61 6c74 5f6d 6174 6368   self._alt_match
-00027980: 5f72 6567 696f 6e73 5b6f 5d0a 2020 2020  _regions[o].    
-00027990: 2020 2020 2020 2020 2020 2020 2320 5468              # Th
-000279a0: 6573 6520 6172 6520 6d61 6465 206f 6e20  ese are made on 
-000279b0: 6465 6d61 6e64 2c20 736f 206e 6565 6420  demand, so need 
-000279c0: 746f 2063 6865 636b 2069 6620 6974 7320  to check if its 
-000279d0: 6163 7475 616c 6c79 2070 7265 7365 6e74  actually present
-000279e0: 2066 6972 7374 0a20 2020 2020 2020 2020   first.         
-000279f0: 2020 2020 2020 2069 6620 6f20 696e 2073         if o in s
-00027a00: 656c 662e 5f69 6e74 6572 6c6f 7065 725f  elf._interloper_
-00027a10: 6d61 736b 733a 0a20 2020 2020 2020 2020  masks:.         
-00027a20: 2020 2020 2020 2020 2020 2064 656c 2073             del s
-00027a30: 656c 662e 5f69 6e74 6572 6c6f 7065 725f  elf._interloper_
-00027a40: 6d61 736b 735b 6f5d 0a20 2020 2020 2020  masks[o].       
-00027a50: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-00027a60: 2e5f 7065 616b 7320 6973 206e 6f74 204e  ._peaks is not N
-00027a70: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00027a80: 2020 2020 2020 2020 2064 656c 2073 656c           del sel
-00027a90: 662e 5f70 6561 6b73 5b6f 5d0a 0a20 2020  f._peaks[o]..   
-00027aa0: 2020 2020 2020 2020 2020 2020 2064 656c               del
-00027ab0: 2073 656c 662e 5f6f 6273 5b73 656c 662e   self._obs[self.
-00027ac0: 5f6f 6273 2e69 6e64 6578 286f 295d 0a20  _obs.index(o)]. 
-00027ad0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00027ae0: 6620 6f20 696e 2073 656c 662e 5f6f 6e61  f o in self._ona
-00027af0: 7869 733a 0a20 2020 2020 2020 2020 2020  xis:.           
-00027b00: 2020 2020 2020 2020 2064 656c 2073 656c           del sel
-00027b10: 662e 5f6f 6e61 7869 735b 7365 6c66 2e5f  f._onaxis[self._
-00027b20: 6f6e 6178 6973 2e69 6e64 6578 286f 295d  onaxis.index(o)]
-00027b30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00027b40: 2064 656c 2073 656c 662e 5f69 6e73 7472   del self._instr
-00027b50: 756d 656e 7473 5b6f 5d0a 0a20 2020 2020  uments[o]..     
-00027b60: 2020 2069 6620 6c65 6e28 7365 6c66 2e5f     if len(self._
-00027b70: 6f62 7329 203d 3d20 303a 0a20 2020 2020  obs) == 0:.     
-00027b80: 2020 2020 2020 2072 6169 7365 204e 6f56         raise NoV
-00027b90: 616c 6964 4f62 7365 7276 6174 696f 6e73  alidObservations
-00027ba0: 4572 726f 7228 224e 6f20 6f62 7365 7276  Error("No observ
-00027bb0: 6174 696f 6e73 2072 656d 6169 6e20 6173  ations remain as
-00027bc0: 736f 6369 6174 6564 2077 6974 6820 7b7d  sociated with {}
-00027bd0: 2061 6674 6572 2063 6c65 616e 696e 6722   after cleaning"
-00027be0: 2e66 6f72 6d61 7428 7365 6c66 2e6e 616d  .format(self.nam
-00027bf0: 6529 290a 0a20 2020 2020 2020 2023 2057  e))..        # W
-00027c00: 6520 6174 7465 6d70 7420 746f 206c 6f61  e attempt to loa
-00027c10: 6420 696e 206d 6174 6368 696e 6720 5847  d in matching XG
-00027c20: 4120 7072 6f64 7563 7473 2069 6620 7468  A products if th
-00027c30: 6174 2077 6173 2074 6865 2062 6568 6176  at was the behav
-00027c40: 696f 7572 2073 6574 2062 7920 6c6f 6164  iour set by load
-00027c50: 5f70 726f 6475 6374 7320 6f6e 2069 6e69  _products on ini
-00027c60: 740a 2020 2020 2020 2020 6966 2073 656c  t.        if sel
-00027c70: 662e 5f6c 6f61 645f 7072 6f64 7563 7473  f._load_products
-00027c80: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00027c90: 6c66 2e5f 6578 6973 7469 6e67 5f78 6761  lf._existing_xga
-00027ca0: 5f70 726f 6475 6374 7328 7365 6c66 2e5f  _products(self._
-00027cb0: 6c6f 6164 5f66 6974 7329 0a0a 2020 2020  load_fits)..    
-00027cc0: 4070 726f 7065 7274 790a 2020 2020 6465  @property.    de
-00027cd0: 6620 6c75 6d69 6e6f 7369 7479 5f64 6973  f luminosity_dis
-00027ce0: 7461 6e63 6528 7365 6c66 2920 2d3e 2051  tance(self) -> Q
-00027cf0: 7561 6e74 6974 793a 0a20 2020 2020 2020  uantity:.       
-00027d00: 2022 2222 0a20 2020 2020 2020 2054 656c   """.        Tel
-00027d10: 6c73 2074 6865 2075 7365 7220 7468 6520  ls the user the 
-00027d20: 6c75 6d69 6e6f 7369 7479 2064 6973 7461  luminosity dista
-00027d30: 6e63 6520 746f 2074 6865 2073 6f75 7263  nce to the sourc
-00027d40: 6520 6966 2061 2072 6564 7368 6966 7420  e if a redshift 
-00027d50: 7761 7320 7375 7070 6c69 6564 2c20 6966  was supplied, if
-00027d60: 206e 6f74 2072 6574 7572 6e73 204e 6f6e   not returns Non
-00027d70: 652e 0a0a 2020 2020 2020 2020 3a72 6574  e...        :ret
-00027d80: 7572 6e3a 2054 6865 206c 756d 696e 6f73  urn: The luminos
-00027d90: 6974 7920 6469 7374 616e 6365 2074 6f20  ity distance to 
-00027da0: 7468 6520 736f 7572 6365 2c20 6361 6c63  the source, calc
-00027db0: 756c 6174 6564 2075 7369 6e67 2074 6865  ulated using the
-00027dc0: 2063 6f73 6d6f 6c6f 6779 2061 7373 6f63   cosmology assoc
-00027dd0: 6961 7465 6420 7769 7468 2074 6869 7320  iated with this 
-00027de0: 736f 7572 6365 2e0a 2020 2020 2020 2020  source..        
-00027df0: 3a72 7479 7065 3a20 5175 616e 7469 7479  :rtype: Quantity
-00027e00: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00027e10: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-00027e20: 2e5f 6c75 6d5f 6469 7374 0a0a 2020 2020  ._lum_dist..    
-00027e30: 4070 726f 7065 7274 790a 2020 2020 6465  @property.    de
-00027e40: 6620 616e 6775 6c61 725f 6469 616d 6574  f angular_diamet
-00027e50: 6572 5f64 6973 7461 6e63 6528 7365 6c66  er_distance(self
-00027e60: 2920 2d3e 2051 7561 6e74 6974 793a 0a20  ) -> Quantity:. 
-00027e70: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00027e80: 2020 2054 656c 6c73 2074 6865 2075 7365     Tells the use
-00027e90: 7220 7468 6520 616e 6775 6c61 7220 6469  r the angular di
-00027ea0: 616d 6574 6572 2064 6973 7461 6e63 6520  ameter distance 
-00027eb0: 746f 2074 6865 2073 6f75 7263 6520 6966  to the source if
-00027ec0: 2061 2072 6564 7368 6966 7420 7761 7320   a redshift was 
-00027ed0: 7375 7070 6c69 6564 2c20 6966 206e 6f74  supplied, if not
-00027ee0: 2072 6574 7572 6e73 204e 6f6e 652e 0a0a   returns None...
-00027ef0: 2020 2020 2020 2020 3a72 6574 7572 6e3a          :return:
-00027f00: 2054 6865 2061 6e67 756c 6172 2064 6961   The angular dia
-00027f10: 6d65 7465 7220 6469 7374 616e 6365 2074  meter distance t
-00027f20: 6f20 7468 6520 736f 7572 6365 2c20 6361  o the source, ca
-00027f30: 6c63 756c 6174 6564 2075 7369 6e67 2074  lculated using t
-00027f40: 6865 2063 6f73 6d6f 6c6f 6779 0a20 2020  he cosmology.   
-00027f50: 2020 2020 2020 2020 2061 7373 6f63 6961           associa
-00027f60: 7465 6420 7769 7468 2074 6869 7320 736f  ted with this so
-00027f70: 7572 6365 2e0a 2020 2020 2020 2020 3a72  urce..        :r
-00027f80: 7479 7065 3a20 5175 616e 7469 7479 0a20  type: Quantity. 
-00027f90: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00027fa0: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
-00027fb0: 616e 675f 6469 616d 5f64 6973 740a 0a20  ang_diam_dist.. 
-00027fc0: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
-00027fd0: 2064 6566 2062 6163 6b67 726f 756e 645f   def background_
-00027fe0: 7261 6469 7573 5f66 6163 746f 7273 2873  radius_factors(s
-00027ff0: 656c 6629 202d 3e20 6e64 6172 7261 793a  elf) -> ndarray:
-00028000: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00028010: 2020 2020 2054 6865 2066 6163 746f 7273       The factors
-00028020: 2062 7920 7768 6963 6820 746f 206d 756c   by which to mul
-00028030: 7469 706c 7920 6f75 7465 7220 7261 6469  tiply outer radi
-00028040: 7573 2062 7920 746f 2067 6574 2069 6e6e  us by to get inn
-00028050: 6572 2061 6e64 206f 7574 6572 2072 6164  er and outer rad
-00028060: 6969 2066 6f72 2062 6163 6b67 726f 756e  ii for backgroun
-00028070: 6420 7265 6769 6f6e 732e 0a0a 2020 2020  d regions...    
-00028080: 2020 2020 3a72 6574 7572 6e3a 2041 6e20      :return: An 
-00028090: 6172 7261 7920 6f66 2074 6865 2074 776f  array of the two
-000280a0: 2066 6163 746f 7273 2e0a 2020 2020 2020   factors..      
-000280b0: 2020 3a72 7479 7065 3a20 6e64 6172 7261    :rtype: ndarra
-000280c0: 790a 2020 2020 2020 2020 2222 220a 2020  y.        """.  
-000280d0: 2020 2020 2020 7265 7475 726e 206e 702e        return np.
-000280e0: 6172 7261 7928 5b73 656c 662e 5f62 6163  array([self._bac
-000280f0: 6b5f 696e 6e5f 6661 6374 6f72 2c20 7365  k_inn_factor, se
-00028100: 6c66 2e5f 6261 636b 5f6f 7574 5f66 6163  lf._back_out_fac
-00028110: 746f 725d 290a 0a20 2020 2064 6566 206f  tor])..    def o
-00028120: 6273 5f63 6865 636b 2873 656c 662c 2072  bs_check(self, r
-00028130: 6567 5f74 7970 653a 2073 7472 2c20 7468  eg_type: str, th
-00028140: 7265 7368 6f6c 645f 6672 6163 7469 6f6e  reshold_fraction
-00028150: 3a20 666c 6f61 7420 3d20 302e 3529 202d  : float = 0.5) -
-00028160: 3e20 4469 6374 3a0a 2020 2020 2020 2020  > Dict:.        
-00028170: 2222 220a 2020 2020 2020 2020 5468 6973  """.        This
-00028180: 206d 6574 686f 6420 7573 6573 2065 7870   method uses exp
-00028190: 6f73 7572 6520 6d61 7073 2061 6e64 2072  osure maps and r
-000281a0: 6567 696f 6e20 6d61 736b 7320 746f 2064  egion masks to d
-000281b0: 6574 6572 6d69 6e65 2077 6869 6368 204f  etermine which O
-000281c0: 6273 4944 2f69 6e73 7472 756d 656e 7420  bsID/instrument 
-000281d0: 636f 6d62 696e 6174 696f 6e73 0a20 2020  combinations.   
-000281e0: 2020 2020 2061 7265 206e 6f74 2063 6f6e       are not con
-000281f0: 7472 6962 7574 696e 6720 746f 2074 6865  tributing to the
-00028200: 2061 6e61 6c79 7369 732e 2049 7420 6361   analysis. It ca
-00028210: 6c63 756c 6174 6573 2074 6865 2061 7265  lculates the are
-00028220: 6120 696e 7465 7273 6563 7469 6f6e 206f  a intersection o
-00028230: 6620 7468 6520 6d61 736b 2061 6e64 2065  f the mask and e
-00028240: 7870 6f73 7572 650a 2020 2020 2020 2020  xposure.        
-00028250: 6d61 7073 2c20 616e 6420 6966 2028 666f  maps, and if (fo
-00028260: 7220 6120 6769 7665 6e20 4f62 7349 442d  r a given ObsID-
-00028270: 496e 7374 7275 6d65 6e74 2920 7468 6520  Instrument) the 
-00028280: 7261 7469 6f20 6f66 2074 6861 7420 6172  ratio of that ar
-00028290: 6561 2074 6f20 7468 6520 6675 6c6c 2061  ea to the full a
-000282a0: 7265 6120 6f66 2074 6865 2072 6567 696f  rea of the regio
-000282b0: 6e0a 2020 2020 2020 2020 6361 6c63 756c  n.        calcul
-000282c0: 6174 6564 2069 7320 6c65 7373 2074 6861  ated is less tha
-000282d0: 6e20 7468 6520 7468 7265 7368 6f6c 6420  n the threshold 
-000282e0: 6672 6163 7469 6f6e 2c20 7468 6174 204f  fraction, that O
-000282f0: 6273 4944 2d69 6e73 7472 756d 656e 7420  bsID-instrument 
-00028300: 7769 6c6c 2062 6520 696e 636c 7564 6564  will be included
-00028310: 2069 6e20 7468 6520 7265 7475 726e 6564   in the returned
-00028320: 0a20 2020 2020 2020 2072 656a 6563 7469  .        rejecti
-00028330: 6f6e 2064 6963 7469 6f6e 6172 792e 0a0a  on dictionary...
-00028340: 2020 2020 2020 2020 3a70 6172 616d 2073          :param s
-00028350: 7472 2072 6567 5f74 7970 653a 2054 6865  tr reg_type: The
-00028360: 2072 6567 696f 6e20 7479 7065 2066 6f72   region type for
-00028370: 2077 6869 6368 2074 6f20 6361 6c63 756c   which to calcul
-00028380: 6174 6520 7468 6520 6172 6561 2069 6e74  ate the area int
-00028390: 6572 7365 6374 696f 6e2e 0a20 2020 2020  ersection..     
-000283a0: 2020 203a 7061 7261 6d20 666c 6f61 7420     :param float 
-000283b0: 7468 7265 7368 6f6c 645f 6672 6163 7469  threshold_fracti
-000283c0: 6f6e 3a20 496e 7465 7273 6563 7469 6f6e  on: Intersection
-000283d0: 2061 7265 612f 2066 756c 6c20 7265 6769   area/ full regi
-000283e0: 6f6e 2061 7265 6120 7261 7469 6f73 2062  on area ratios b
-000283f0: 656c 6f77 2074 6869 7320 7661 6c75 6520  elow this value 
-00028400: 7769 6c6c 206d 6561 6e20 616e 0a20 2020  will mean an.   
-00028410: 2020 2020 2020 2020 204f 6273 4944 2d49           ObsID-I
-00028420: 6e73 7472 756d 656e 7420 6973 2072 656a  nstrument is rej
-00028430: 6563 7465 642e 0a20 2020 2020 2020 203a  ected..        :
-00028440: 7265 7475 726e 3a20 4120 6469 6374 696f  return: A dictio
-00028450: 6e61 7279 206f 6620 4f62 7349 4420 6b65  nary of ObsID ke
-00028460: 7973 206f 6e20 7468 6520 746f 7020 6c65  ys on the top le
-00028470: 7665 6c2c 2074 6865 6e20 696e 7374 7275  vel, then instru
-00028480: 6d65 6e74 7320 6120 6c65 7665 6c20 646f  ments a level do
-00028490: 776e 2c20 7468 6174 0a20 2020 2020 2020  wn, that.       
-000284a0: 2020 2020 2073 686f 756c 6420 6265 2072       should be r
-000284b0: 656a 6563 7465 6420 6163 636f 7264 696e  ejected accordin
-000284c0: 6720 746f 2074 6865 2063 7269 7465 7269  g to the criteri
-000284d0: 6120 7375 7070 6c69 6564 2074 6f20 7468  a supplied to th
-000284e0: 6973 206d 6574 686f 642e 0a20 2020 2020  is method..     
-000284f0: 2020 203a 7274 7970 653a 2044 6963 740a     :rtype: Dict.
-00028500: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00028510: 2020 2020 2320 4167 6169 6e20 646f 6e27      # Again don'
-00028520: 7420 7061 7274 6963 756c 6172 6c79 2077  t particularly w
-00028530: 616e 7420 746f 2064 6f20 7468 6973 206c  ant to do this l
-00028540: 6f63 616c 2069 6d70 6f72 742c 2062 7574  ocal import, but
-00028550: 2069 7473 206a 7573 7420 6561 7369 6572   its just easier
-00028560: 0a20 2020 2020 2020 2066 726f 6d20 7867  .        from xg
-00028570: 612e 7361 7320 696d 706f 7274 2065 6578  a.sas import eex
-00028580: 706d 6170 0a0a 2020 2020 2020 2020 2320  pmap..        # 
-00028590: 476f 696e 6720 746f 2065 6e73 7572 6520  Going to ensure 
-000285a0: 7468 6174 2069 6e64 6976 6964 7561 6c20  that individual 
-000285b0: 6578 706f 7375 7265 206d 6170 7320 6578  exposure maps ex
-000285c0: 6973 7420 666f 7220 6561 6368 206f 6620  ist for each of 
-000285d0: 7468 6520 4f62 7349 442f 696e 7374 7275  the ObsID/instru
-000285e0: 6d65 6e74 2063 6f6d 6269 6e61 7469 6f6e  ment combination
-000285f0: 730a 2020 2020 2020 2020 2320 2066 6972  s.        #  fir
-00028600: 7374 2c20 7468 656e 2063 6865 636b 696e  st, then checkin
-00028610: 6720 7768 6572 6520 7468 6520 736f 7572  g where the sour
-00028620: 6365 206c 6965 7320 6f6e 2074 6865 2065  ce lies on the e
-00028630: 7870 6f73 7572 6520 6d61 700a 2020 2020  xposure map.    
-00028640: 2020 2020 6565 7870 6d61 7028 7365 6c66      eexpmap(self
-00028650: 2c20 7365 6c66 2e5f 7065 616b 5f6c 6f5f  , self._peak_lo_
-00028660: 656e 2c20 7365 6c66 2e5f 7065 616b 5f68  en, self._peak_h
-00028670: 695f 656e 290a 0a20 2020 2020 2020 2065  i_en)..        e
-00028680: 7874 7261 5f6b 6579 203d 2022 626f 756e  xtra_key = "boun
-00028690: 645f 7b6c 7d2d 7b75 7d22 2e66 6f72 6d61  d_{l}-{u}".forma
-000286a0: 7428 6c3d 7365 6c66 2e5f 7065 616b 5f6c  t(l=self._peak_l
-000286b0: 6f5f 656e 2e74 6f28 226b 6556 2229 2e76  o_en.to("keV").v
-000286c0: 616c 7565 2c20 753d 7365 6c66 2e5f 7065  alue, u=self._pe
-000286d0: 616b 5f68 695f 656e 2e74 6f28 226b 6556  ak_hi_en.to("keV
-000286e0: 2229 2e76 616c 7565 290a 0a20 2020 2020  ").value)..     
-000286f0: 2020 2061 7265 6120 3d20 7b6f 3a20 7b7d     area = {o: {}
-00028700: 2066 6f72 206f 2069 6e20 7365 6c66 2e6f   for o in self.o
-00028710: 6273 5f69 6473 7d0a 2020 2020 2020 2020  bs_ids}.        
-00028720: 6675 6c6c 5f61 7265 6120 3d20 7b6f 3a20  full_area = {o: 
-00028730: 7b7d 2066 6f72 206f 2069 6e20 7365 6c66  {} for o in self
-00028740: 2e6f 6273 5f69 6473 7d0a 2020 2020 2020  .obs_ids}.      
-00028750: 2020 666f 7220 6f20 696e 2073 656c 662e    for o in self.
-00028760: 6f62 735f 6964 733a 0a20 2020 2020 2020  obs_ids:.       
-00028770: 2020 2020 2023 2045 7870 6f73 7572 6520       # Exposure 
-00028780: 6d61 7073 206f 6620 7468 6520 7065 616b  maps of the peak
-00028790: 2066 696e 6469 6e67 2065 6e65 7267 7920   finding energy 
-000287a0: 7261 6e67 6520 666f 7220 7468 6973 204f  range for this O
-000287b0: 6273 4944 0a20 2020 2020 2020 2020 2020  bsID.           
-000287c0: 2065 7870 5f6d 6170 7320 3d20 7365 6c66   exp_maps = self
-000287d0: 2e67 6574 5f70 726f 6475 6374 7328 2265  .get_products("e
-000287e0: 7870 6d61 7022 2c20 6f2c 2065 7874 7261  xpmap", o, extra
-000287f0: 5f6b 6579 3d65 7874 7261 5f6b 6579 290a  _key=extra_key).
-00028800: 2020 2020 2020 2020 2020 2020 6d20 3d20              m = 
-00028810: 7365 6c66 2e67 6574 5f73 6f75 7263 655f  self.get_source_
-00028820: 6d61 736b 2872 6567 5f74 7970 652c 206f  mask(reg_type, o
-00028830: 2c20 6365 6e74 7261 6c5f 636f 6f72 643d  , central_coord=
-00028840: 7365 6c66 2e5f 6465 6661 756c 745f 636f  self._default_co
-00028850: 6f72 6429 5b30 5d0a 2020 2020 2020 2020  ord)[0].        
-00028860: 2020 2020 6675 6c6c 5f61 7265 615b 6f5d      full_area[o]
-00028870: 203d 206d 2e73 756d 2829 0a0a 2020 2020   = m.sum()..    
-00028880: 2020 2020 2020 2020 666f 7220 6578 2069          for ex i
-00028890: 6e20 6578 705f 6d61 7073 3a0a 2020 2020  n exp_maps:.    
-000288a0: 2020 2020 2020 2020 2020 2020 2320 4772              # Gr
-000288b0: 6162 7320 6578 706f 7375 7265 206d 6170  abs exposure map
-000288c0: 2064 6174 612c 2074 6865 6e20 616c 7465   data, then alte
-000288d0: 7273 2069 7420 736f 2061 6e79 7468 696e  rs it so anythin
-000288e0: 6720 7468 6174 2069 736e 2774 207a 6572  g that isn't zer
-000288f0: 6f20 6973 2061 206f 6e65 0a20 2020 2020  o is a one.     
-00028900: 2020 2020 2020 2020 2020 2065 785f 6461             ex_da
-00028910: 7461 203d 2065 782e 6461 7461 2e63 6f70  ta = ex.data.cop
-00028920: 7928 290a 2020 2020 2020 2020 2020 2020  y().            
-00028930: 2020 2020 6578 5f64 6174 615b 6578 5f64      ex_data[ex_d
-00028940: 6174 6120 3e20 305d 203d 2031 0a20 2020  ata > 0] = 1.   
-00028950: 2020 2020 2020 2020 2020 2020 2023 2057               # W
-00028960: 6520 646f 2074 6869 7320 6265 6361 7573  e do this becaus
-00028970: 6520 6974 2074 6865 6e20 6265 636f 6d65  e it then become
-00028980: 7320 7665 7279 2065 6173 7920 746f 2063  s very easy to c
-00028990: 616c 6375 6c61 7465 2074 6865 2069 6e74  alculate the int
-000289a0: 6572 7365 6374 696f 6e20 6172 6561 206f  ersection area o
-000289b0: 6620 7468 6520 6d61 736b 0a20 2020 2020  f the mask.     
-000289c0: 2020 2020 2020 2020 2020 2023 2020 7769             #  wi
-000289d0: 7468 2074 6865 2058 4d4d 2063 6869 7073  th the XMM chips
-000289e0: 2e20 4a75 7374 206d 6173 6b20 7468 6520  . Just mask the 
-000289f0: 6d6f 6469 6669 6564 2065 7870 6d61 702c  modified expmap,
-00028a00: 2074 6865 6e20 7375 6d2e 0a20 2020 2020   then sum..     
-00028a10: 2020 2020 2020 2020 2020 2061 7265 615b             area[
-00028a20: 6f5d 5b65 782e 696e 7374 7275 6d65 6e74  o][ex.instrument
-00028a30: 5d20 3d20 2865 785f 6461 7461 202a 206d  ] = (ex_data * m
-00028a40: 292e 7375 6d28 290a 0a20 2020 2020 2020  ).sum()..       
-00028a50: 2069 6620 6d61 7828 6c69 7374 2866 756c   if max(list(ful
-00028a60: 6c5f 6172 6561 2e76 616c 7565 7328 2929  l_area.values())
-00028a70: 2920 3d3d 2030 3a0a 2020 2020 2020 2020  ) == 0:.        
-00028a80: 2020 2020 2320 4576 6572 7974 6869 6e67      # Everything
-00028a90: 2068 6173 2074 6f20 6265 2072 656a 6563   has to be rejec
-00028aa0: 7465 6420 696e 2074 6869 7320 6361 7365  ted in this case
-00028ab0: 0a20 2020 2020 2020 2020 2020 2072 656a  .            rej
-00028ac0: 6563 745f 6469 6374 203d 2064 6565 7063  ect_dict = deepc
-00028ad0: 6f70 7928 7365 6c66 2e5f 696e 7374 7275  opy(self._instru
-00028ae0: 6d65 6e74 7329 0a20 2020 2020 2020 2065  ments).        e
-00028af0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00028b00: 2072 656a 6563 745f 6469 6374 203d 207b   reject_dict = {
-00028b10: 7d0a 2020 2020 2020 2020 2020 2020 666f  }.            fo
-00028b20: 7220 6f20 696e 2061 7265 613a 0a20 2020  r o in area:.   
-00028b30: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00028b40: 2069 2069 6e20 6172 6561 5b6f 5d3a 0a20   i in area[o]:. 
-00028b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028b60: 2020 2069 6620 6675 6c6c 5f61 7265 615b     if full_area[
-00028b70: 6f5d 2021 3d20 303a 0a20 2020 2020 2020  o] != 0:.       
-00028b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028b90: 2066 7261 6320 3d20 2861 7265 615b 6f5d   frac = (area[o]
-00028ba0: 5b69 5d20 2f20 6675 6c6c 5f61 7265 615b  [i] / full_area[
-00028bb0: 6f5d 290a 2020 2020 2020 2020 2020 2020  o]).            
-00028bc0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00028bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028be0: 2020 2020 2020 6672 6163 203d 2030 0a20        frac = 0. 
-00028bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028c00: 2020 2069 6620 6672 6163 203c 3d20 7468     if frac <= th
-00028c10: 7265 7368 6f6c 645f 6672 6163 7469 6f6e  reshold_fraction
-00028c20: 2061 6e64 206f 206e 6f74 2069 6e20 7265   and o not in re
-00028c30: 6a65 6374 5f64 6963 743a 0a20 2020 2020  ject_dict:.     
-00028c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028c50: 2020 2072 656a 6563 745f 6469 6374 5b6f     reject_dict[o
-00028c60: 5d20 3d20 5b69 5d0a 2020 2020 2020 2020  ] = [i].        
-00028c70: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-00028c80: 2066 7261 6320 3c3d 2074 6872 6573 686f   frac <= thresho
-00028c90: 6c64 5f66 7261 6374 696f 6e20 616e 6420  ld_fraction and 
-00028ca0: 6f20 696e 2072 656a 6563 745f 6469 6374  o in reject_dict
-00028cb0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00028cc0: 2020 2020 2020 2020 2020 7265 6a65 6374            reject
-00028cd0: 5f64 6963 745b 6f5d 2e61 7070 656e 6428  _dict[o].append(
-00028ce0: 6929 0a0a 2020 2020 2020 2020 7265 7475  i)..        retu
-00028cf0: 726e 2072 656a 6563 745f 6469 6374 0a0a  rn reject_dict..
-00028d00: 2020 2020 2320 416e 6420 6865 7265 2049      # And here I
-00028d10: 276d 2061 6464 696e 6720 6120 6275 6e63  'm adding a bunc
-00028d20: 6820 6f66 2067 6574 206d 6574 686f 6473  h of get methods
-00028d30: 2074 6861 7420 7368 6f75 6c64 206d 6561   that should mea
-00028d40: 6e20 7468 6520 7573 6572 206e 6576 6572  n the user never
-00028d50: 2068 6173 2074 6f20 7573 6520 6765 745f   has to use get_
-00028d60: 7072 6f64 7563 7473 2c20 666f 720a 2020  products, for.  
-00028d70: 2020 2320 2069 6e64 6976 6964 7561 6c20    #  individual 
-00028d80: 7072 6f64 7563 7420 7479 7065 732e 2049  product types. I
-00028d90: 7420 7769 6c6c 2061 6c73 6f20 6d65 616e  t will also mean
-00028da0: 2074 6861 7420 7468 6579 2077 696c 6c20   that they will 
-00028db0: 6e65 7665 7220 6861 7665 2074 6f20 6669  never have to fi
-00028dc0: 6775 7265 206f 7574 2065 7874 7261 206b  gure out extra k
-00028dd0: 6579 7320 7468 656d 7365 6c76 6573 0a20  eys themselves. 
-00028de0: 2020 2023 2020 616e 6420 4920 6361 6e20     #  and I can 
-00028df0: 6d61 6b65 206c 6973 7473 206f 6620 3120  make lists of 1 
-00028e00: 7072 6f64 7563 7420 7265 7475 726e 206a  product return j
-00028e10: 7573 7420 6173 2074 6865 2070 726f 6475  ust as the produ
-00028e20: 6374 2077 6974 686f 7574 2062 6569 6e67  ct without being
-00028e30: 2061 2062 7265 616b 696e 6720 6368 616e   a breaking chan
-00028e40: 6765 0a20 2020 2064 6566 2067 6574 5f73  ge.    def get_s
-00028e50: 7065 6374 7261 2873 656c 662c 206f 7574  pectra(self, out
-00028e60: 6572 5f72 6164 6975 733a 2055 6e69 6f6e  er_radius: Union
-00028e70: 5b73 7472 2c20 5175 616e 7469 7479 5d2c  [str, Quantity],
-00028e80: 206f 6273 5f69 643a 2073 7472 203d 204e   obs_id: str = N
-00028e90: 6f6e 652c 2069 6e73 743a 2073 7472 203d  one, inst: str =
-00028ea0: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
-00028eb0: 2020 2020 2020 2020 2020 2069 6e6e 6572             inner
-00028ec0: 5f72 6164 6975 733a 2055 6e69 6f6e 5b73  _radius: Union[s
-00028ed0: 7472 2c20 5175 616e 7469 7479 5d20 3d20  tr, Quantity] = 
-00028ee0: 5175 616e 7469 7479 2830 2c20 2761 7263  Quantity(0, 'arc
-00028ef0: 7365 6327 292c 2067 726f 7570 5f73 7065  sec'), group_spe
-00028f00: 633a 2062 6f6f 6c20 3d20 5472 7565 2c0a  c: bool = True,.
-00028f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028f20: 2020 2020 6d69 6e5f 636f 756e 7473 3a20      min_counts: 
-00028f30: 696e 7420 3d20 352c 206d 696e 5f73 6e3a  int = 5, min_sn:
-00028f40: 2066 6c6f 6174 203d 204e 6f6e 652c 0a20   float = None,. 
-00028f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028f60: 2020 206f 7665 725f 7361 6d70 6c65 3a20     over_sample: 
-00028f70: 666c 6f61 7420 3d20 4e6f 6e65 2920 2d3e  float = None) ->
-00028f80: 2055 6e69 6f6e 5b53 7065 6374 7275 6d2c   Union[Spectrum,
-00028f90: 204c 6973 745b 5370 6563 7472 756d 5d5d   List[Spectrum]]
-00028fa0: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-00028fb0: 2020 2020 2020 4120 7573 6566 756c 206d        A useful m
-00028fc0: 6574 686f 6420 7468 6174 2077 7261 7073  ethod that wraps
-00028fd0: 2074 6865 2067 6574 5f70 726f 6475 6374   the get_product
-00028fe0: 7320 6675 6e63 7469 6f6e 2074 6f20 616c  s function to al
-00028ff0: 6c6f 7720 796f 7520 746f 2065 6173 696c  low you to easil
-00029000: 7920 7265 7472 6965 7665 2058 4741 2053  y retrieve XGA S
-00029010: 7065 6374 7275 6d20 6f62 6a65 6374 732e  pectrum objects.
-00029020: 0a20 2020 2020 2020 2053 696d 706c 7920  .        Simply 
-00029030: 7061 7373 2074 6865 2064 6573 6972 6564  pass the desired
-00029040: 204f 6273 4944 2f69 6e73 7472 756d 656e   ObsID/instrumen
-00029050: 742c 2061 6e64 2074 6865 2073 616d 6520  t, and the same 
-00029060: 7365 7474 696e 6773 2079 6f75 2075 7365  settings you use
-00029070: 6420 746f 2067 656e 6572 6174 6520 7468  d to generate th
-00029080: 6520 7370 6563 7472 756d 0a20 2020 2020  e spectrum.     
-00029090: 2020 2069 6e20 6576 7365 6c65 6374 5f73     in evselect_s
-000290a0: 7065 6374 7275 6d2c 2061 6e64 2074 6865  pectrum, and the
-000290b0: 2073 7065 6374 7261 2875 6d29 2077 696c   spectra(um) wil
-000290c0: 6c20 6265 2070 726f 7669 6465 6420 746f  l be provided to
-000290d0: 2079 6f75 2e20 4966 206e 6f20 6d61 7463   you. If no matc
-000290e0: 6820 6973 2066 6f75 6e64 2074 6865 6e20  h is found then 
-000290f0: 610a 2020 2020 2020 2020 4e6f 5072 6f64  a.        NoProd
-00029100: 7563 7441 7661 696c 6162 6c65 4572 726f  uctAvailableErro
-00029110: 7220 7769 6c6c 2062 6520 7261 6973 6564  r will be raised
-00029120: 2e0a 0a20 2020 2020 2020 203a 7061 7261  ...        :para
-00029130: 6d20 7374 722f 5175 616e 7469 7479 206f  m str/Quantity o
-00029140: 7574 6572 5f72 6164 6975 733a 2054 6865  uter_radius: The
-00029150: 206e 616d 6520 6f72 2076 616c 7565 206f   name or value o
-00029160: 6620 7468 6520 6f75 7465 7220 7261 6469  f the outer radi
-00029170: 7573 2074 6861 7420 7761 7320 7573 6564  us that was used
-00029180: 2066 6f72 2074 6865 2067 656e 6572 6174   for the generat
-00029190: 696f 6e20 6f66 0a20 2020 2020 2020 2020  ion of.         
-000291a0: 2020 2074 6865 2073 7065 6374 7275 6d20     the spectrum 
-000291b0: 2866 6f72 2069 6e73 7461 6e63 6520 2772  (for instance 'r
-000291c0: 3230 3027 2077 6f75 6c64 2062 6520 6163  200' would be ac
-000291d0: 6365 7074 6162 6c65 2066 6f72 2061 2047  ceptable for a G
-000291e0: 616c 6178 7943 6c75 7374 6572 2c20 6f72  alaxyCluster, or
-000291f0: 2051 7561 6e74 6974 7928 3130 3030 2c20   Quantity(1000, 
-00029200: 276b 7063 2729 292e 2049 660a 2020 2020  'kpc')). If.    
-00029210: 2020 2020 2020 2020 2772 6567 696f 6e27          'region'
-00029220: 2069 7320 6368 6f73 656e 2028 746f 2075   is chosen (to u
-00029230: 7365 2074 6865 2072 6567 696f 6e73 2069  se the regions i
-00029240: 6e20 7265 6769 6f6e 2066 696c 6573 292c  n region files),
-00029250: 2074 6865 6e20 616e 7920 696e 6e65 7220   then any inner 
-00029260: 7261 6469 7573 2077 696c 6c20 6265 2069  radius will be i
-00029270: 676e 6f72 6564 2e0a 2020 2020 2020 2020  gnored..        
-00029280: 3a70 6172 616d 2073 7472 206f 6273 5f69  :param str obs_i
-00029290: 643a 204f 7074 696f 6e61 6c6c 792c 2061  d: Optionally, a
-000292a0: 2073 7065 6369 6669 6320 6f62 735f 6964   specific obs_id
-000292b0: 2074 6f20 7365 6172 6368 2066 6f72 2063   to search for c
-000292c0: 616e 2062 6520 7375 7070 6c69 6564 2e20  an be supplied. 
-000292d0: 5468 6520 6465 6661 756c 7420 6973 204e  The default is N
-000292e0: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
-000292f0: 2077 6869 6368 206d 6561 6e73 2061 6c6c   which means all
-00029300: 2073 7065 6374 7261 206d 6174 6368 696e   spectra matchin
-00029310: 6720 7468 6520 6f74 6865 7220 6372 6974  g the other crit
-00029320: 6572 6961 2077 696c 6c20 6265 2072 6574  eria will be ret
-00029330: 7572 6e65 642e 0a20 2020 2020 2020 203a  urned..        :
-00029340: 7061 7261 6d20 7374 7220 696e 7374 3a20  param str inst: 
-00029350: 4f70 7469 6f6e 616c 6c79 2c20 6120 7370  Optionally, a sp
-00029360: 6563 6966 6963 2069 6e73 7472 756d 656e  ecific instrumen
-00029370: 7420 746f 2073 6561 7263 6820 666f 7220  t to search for 
-00029380: 6361 6e20 6265 2073 7570 706c 6965 642e  can be supplied.
-00029390: 2054 6865 2064 6566 6175 6c74 2069 7320   The default is 
-000293a0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
-000293b0: 2020 7768 6963 6820 6d65 616e 7320 616c    which means al
-000293c0: 6c20 7370 6563 7472 6120 6d61 7463 6869  l spectra matchi
-000293d0: 6e67 2074 6865 206f 7468 6572 2063 7269  ng the other cri
-000293e0: 7465 7269 6120 7769 6c6c 2062 6520 7265  teria will be re
-000293f0: 7475 726e 6564 2e0a 2020 2020 2020 2020  turned..        
-00029400: 3a70 6172 616d 2073 7472 2f51 7561 6e74  :param str/Quant
-00029410: 6974 7920 696e 6e65 725f 7261 6469 7573  ity inner_radius
-00029420: 3a20 5468 6520 6e61 6d65 206f 7220 7661  : The name or va
-00029430: 6c75 6520 6f66 2074 6865 2069 6e6e 6572  lue of the inner
-00029440: 2072 6164 6975 7320 7468 6174 2077 6173   radius that was
-00029450: 2075 7365 6420 666f 7220 7468 6520 6765   used for the ge
-00029460: 6e65 7261 7469 6f6e 206f 660a 2020 2020  neration of.    
-00029470: 2020 2020 2020 2020 7468 6520 7370 6563          the spec
-00029480: 7472 756d 2028 666f 7220 696e 7374 616e  trum (for instan
-00029490: 6365 2027 7235 3030 2720 776f 756c 6420  ce 'r500' would 
-000294a0: 6265 2061 6363 6570 7461 626c 6520 666f  be acceptable fo
-000294b0: 7220 6120 4761 6c61 7879 436c 7573 7465  r a GalaxyCluste
-000294c0: 722c 206f 7220 5175 616e 7469 7479 2833  r, or Quantity(3
-000294d0: 3030 2c20 276b 7063 2729 292e 2042 790a  00, 'kpc')). By.
-000294e0: 2020 2020 2020 2020 2020 2020 6465 6661              defa
-000294f0: 756c 7420 7468 6973 2069 7320 7a65 726f  ult this is zero
-00029500: 2061 7263 7365 636f 6e64 732c 2072 6573   arcseconds, res
-00029510: 756c 7469 6e67 2069 6e20 6120 6369 7263  ulting in a circ
-00029520: 756c 6172 2073 7065 6374 7275 6d2e 0a20  ular spectrum.. 
-00029530: 2020 2020 2020 203a 7061 7261 6d20 626f         :param bo
-00029540: 6f6c 2067 726f 7570 5f73 7065 633a 2057  ol group_spec: W
-00029550: 6173 2074 6865 2073 7065 6374 7275 6d20  as the spectrum 
-00029560: 796f 7520 7769 7368 2074 6f20 7265 7472  you wish to retr
-00029570: 6965 7665 2067 726f 7570 6564 3f0a 2020  ieve grouped?.  
-00029580: 2020 2020 2020 3a70 6172 616d 2066 6c6f        :param flo
-00029590: 6174 206d 696e 5f63 6f75 6e74 733a 2049  at min_counts: I
-000295a0: 6620 7468 6520 7370 6563 7472 756d 2079  f the spectrum y
-000295b0: 6f75 2077 6973 6820 746f 2072 6574 7269  ou wish to retri
-000295c0: 6576 6520 7761 7320 6772 6f75 7065 6420  eve was grouped 
-000295d0: 6f6e 206d 696e 696d 756d 2063 6f75 6e74  on minimum count
-000295e0: 732c 2077 6861 7420 7761 730a 2020 2020  s, what was.    
-000295f0: 2020 2020 2020 2020 7468 6520 6d69 6e69          the mini
-00029600: 6d75 6d20 6e75 6d62 6572 206f 6620 636f  mum number of co
-00029610: 756e 7473 3f0a 2020 2020 2020 2020 3a70  unts?.        :p
-00029620: 6172 616d 2066 6c6f 6174 206d 696e 5f73  aram float min_s
-00029630: 6e3a 2049 6620 7468 6520 7370 6563 7472  n: If the spectr
-00029640: 756d 2079 6f75 2077 6973 6820 746f 2072  um you wish to r
-00029650: 6574 7269 6576 6520 7761 7320 6772 6f75  etrieve was grou
-00029660: 7065 6420 6f6e 206d 696e 696d 756d 2073  ped on minimum s
-00029670: 6967 6e61 6c20 746f 206e 6f69 7365 2c20  ignal to noise, 
-00029680: 7768 6174 2077 6173 0a20 2020 2020 2020  what was.       
-00029690: 2020 2020 2074 6865 206d 696e 696d 756d       the minimum
-000296a0: 2073 6967 6e61 6c20 746f 206e 6f69 7365   signal to noise
-000296b0: 2e0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
-000296c0: 2066 6c6f 6174 206f 7665 725f 7361 6d70   float over_samp
-000296d0: 6c65 3a20 4966 2074 6865 2073 7065 6374  le: If the spect
-000296e0: 7275 6d20 796f 7520 7769 7368 2074 6f20  rum you wish to 
-000296f0: 7265 7472 6965 7665 2077 6173 206f 7665  retrieve was ove
-00029700: 7220 7361 6d70 6c65 642c 2077 6861 7420  r sampled, what 
-00029710: 7761 7320 7468 6520 6c65 7665 6c20 6f66  was the level of
-00029720: 0a20 2020 2020 2020 2020 2020 206f 7665  .            ove
-00029730: 7220 7361 6d70 6c69 6e67 2075 7365 643f  r sampling used?
-00029740: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
-00029750: 3a20 416e 2058 4741 2053 7065 6374 7275  : An XGA Spectru
-00029760: 6d20 6f62 6a65 6374 2028 6966 2074 6865  m object (if the
-00029770: 7265 2069 7320 616e 2065 7861 6374 206d  re is an exact m
-00029780: 6174 6368 292c 206f 7220 6120 6c69 7374  atch), or a list
-00029790: 206f 6620 5847 4120 5370 6563 7472 756d   of XGA Spectrum
-000297a0: 206f 626a 6563 7473 2028 6966 2074 6865   objects (if the
-000297b0: 7265 0a20 2020 2020 2020 2020 2020 2077  re.            w
-000297c0: 6572 6520 6d75 6c74 6970 6c65 206d 6174  ere multiple mat
-000297d0: 6368 696e 6720 7072 6f64 7563 7473 292e  ching products).
-000297e0: 0a20 2020 2020 2020 203a 7274 7970 653a  .        :rtype:
-000297f0: 2055 6e69 6f6e 5b53 7065 6374 7275 6d2c   Union[Spectrum,
-00029800: 204c 6973 745b 5370 6563 7472 756d 5d5d   List[Spectrum]]
-00029810: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00029820: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
-00029830: 6365 2869 6e6e 6572 5f72 6164 6975 732c  ce(inner_radius,
-00029840: 2051 7561 6e74 6974 7929 3a0a 2020 2020   Quantity):.    
-00029850: 2020 2020 2020 2020 696e 6e5f 7261 645f          inn_rad_
-00029860: 6e75 6d20 3d20 7365 6c66 2e63 6f6e 7665  num = self.conve
-00029870: 7274 5f72 6164 6975 7328 696e 6e65 725f  rt_radius(inner_
-00029880: 7261 6469 7573 2c20 2764 6567 2729 0a20  radius, 'deg'). 
-00029890: 2020 2020 2020 2065 6c69 6620 6973 696e         elif isin
-000298a0: 7374 616e 6365 2869 6e6e 6572 5f72 6164  stance(inner_rad
-000298b0: 6975 732c 2073 7472 293a 0a20 2020 2020  ius, str):.     
-000298c0: 2020 2020 2020 2069 6e6e 5f72 6164 5f6e         inn_rad_n
-000298d0: 756d 203d 2073 656c 662e 6765 745f 7261  um = self.get_ra
-000298e0: 6469 7573 2869 6e6e 6572 5f72 6164 6975  dius(inner_radiu
-000298f0: 732c 2027 6465 6727 290a 2020 2020 2020  s, 'deg').      
-00029900: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00029910: 2020 2020 7261 6973 6520 5479 7065 4572      raise TypeEr
-00029920: 726f 7228 2259 6f75 206d 6179 206f 6e6c  ror("You may onl
-00029930: 7920 7061 7373 2061 2071 7561 6e74 6974  y pass a quantit
-00029940: 7920 6f72 2061 2073 7472 696e 6720 6173  y or a string as
-00029950: 2069 6e6e 6572 5f72 6164 6975 7322 290a   inner_radius").
-00029960: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
-00029970: 7374 616e 6365 286f 7574 6572 5f72 6164  stance(outer_rad
-00029980: 6975 732c 2051 7561 6e74 6974 7929 3a0a  ius, Quantity):.
-00029990: 2020 2020 2020 2020 2020 2020 6f75 745f              out_
-000299a0: 7261 645f 6e75 6d20 3d20 7365 6c66 2e63  rad_num = self.c
-000299b0: 6f6e 7665 7274 5f72 6164 6975 7328 6f75  onvert_radius(ou
-000299c0: 7465 725f 7261 6469 7573 2c20 2764 6567  ter_radius, 'deg
-000299d0: 2729 0a20 2020 2020 2020 2065 6c69 6620  ').        elif 
-000299e0: 6973 696e 7374 616e 6365 286f 7574 6572  isinstance(outer
-000299f0: 5f72 6164 6975 732c 2073 7472 293a 0a20  _radius, str):. 
-00029a00: 2020 2020 2020 2020 2020 206f 7574 5f72             out_r
-00029a10: 6164 5f6e 756d 203d 2073 656c 662e 6765  ad_num = self.ge
-00029a20: 745f 7261 6469 7573 286f 7574 6572 5f72  t_radius(outer_r
-00029a30: 6164 6975 732c 2027 6465 6727 290a 2020  adius, 'deg').  
-00029a40: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00029a50: 2020 2020 2020 2020 7261 6973 6520 5479          raise Ty
-00029a60: 7065 4572 726f 7228 2259 6f75 206d 6179  peError("You may
-00029a70: 206f 6e6c 7920 7061 7373 2061 2071 7561   only pass a qua
-00029a80: 6e74 6974 7920 6f72 2061 2073 7472 696e  ntity or a strin
-00029a90: 6720 6173 206f 7574 6572 5f72 6164 6975  g as outer_radiu
-00029aa0: 7322 290a 0a20 2020 2020 2020 2069 6620  s")..        if 
-00029ab0: 6f76 6572 5f73 616d 706c 6520 6973 206e  over_sample is n
-00029ac0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-00029ad0: 2020 2020 206f 7665 725f 7361 6d70 6c65       over_sample
-00029ae0: 203d 2069 6e74 286f 7665 725f 7361 6d70   = int(over_samp
-00029af0: 6c65 290a 2020 2020 2020 2020 6966 206d  le).        if m
-00029b00: 696e 5f63 6f75 6e74 7320 6973 206e 6f74  in_counts is not
-00029b10: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00029b20: 2020 206d 696e 5f63 6f75 6e74 7320 3d20     min_counts = 
-00029b30: 696e 7428 6d69 6e5f 636f 756e 7473 290a  int(min_counts).
-00029b40: 2020 2020 2020 2020 6966 206d 696e 5f73          if min_s
-00029b50: 6e20 6973 206e 6f74 204e 6f6e 653a 0a20  n is not None:. 
-00029b60: 2020 2020 2020 2020 2020 206d 696e 5f73             min_s
-00029b70: 6e20 3d20 666c 6f61 7428 6d69 6e5f 736e  n = float(min_sn
-00029b80: 290a 0a20 2020 2020 2020 2023 2053 6574  )..        # Set
-00029b90: 7320 7570 2074 6865 2065 7874 7261 2070  s up the extra p
-00029ba0: 6172 7420 6f66 2074 6865 2073 746f 7261  art of the stora
-00029bb0: 6765 206b 6579 206e 616d 6520 6465 7065  ge key name depe
-00029bc0: 6e64 696e 6720 6f6e 2069 6620 6772 6f75  nding on if grou
-00029bd0: 7069 6e67 2069 7320 656e 6162 6c65 640a  ping is enabled.
-00029be0: 2020 2020 2020 2020 6966 2067 726f 7570          if group
-00029bf0: 5f73 7065 6320 616e 6420 6d69 6e5f 636f  _spec and min_co
-00029c00: 756e 7473 2069 7320 6e6f 7420 4e6f 6e65  unts is not None
-00029c10: 3a0a 2020 2020 2020 2020 2020 2020 6578  :.            ex
-00029c20: 7472 615f 6e61 6d65 203d 2022 5f6d 696e  tra_name = "_min
-00029c30: 636e 747b 7d22 2e66 6f72 6d61 7428 6d69  cnt{}".format(mi
-00029c40: 6e5f 636f 756e 7473 290a 2020 2020 2020  n_counts).      
-00029c50: 2020 656c 6966 2067 726f 7570 5f73 7065    elif group_spe
-00029c60: 6320 616e 6420 6d69 6e5f 736e 2069 7320  c and min_sn is 
-00029c70: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00029c80: 2020 2020 2020 6578 7472 615f 6e61 6d65        extra_name
-00029c90: 203d 2022 5f6d 696e 736e 7b7d 222e 666f   = "_minsn{}".fo
-00029ca0: 726d 6174 286d 696e 5f73 6e29 0a20 2020  rmat(min_sn).   
-00029cb0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00029cc0: 2020 2020 2020 2065 7874 7261 5f6e 616d         extra_nam
-00029cd0: 6520 3d20 2727 0a0a 2020 2020 2020 2020  e = ''..        
-00029ce0: 2320 416e 6420 6966 2069 7420 7761 7320  # And if it was 
-00029cf0: 6f76 6572 7361 6d70 6c65 6420 6475 7269  oversampled duri
-00029d00: 6e67 2067 656e 6572 6174 696f 6e20 7468  ng generation th
-00029d10: 656e 2077 6520 6e65 6564 2074 6f20 696e  en we need to in
-00029d20: 636c 7564 6520 7468 6174 2061 7320 7765  clude that as we
-00029d30: 6c6c 0a20 2020 2020 2020 2069 6620 6f76  ll.        if ov
-00029d40: 6572 5f73 616d 706c 6520 6973 206e 6f74  er_sample is not
-00029d50: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00029d60: 2020 2065 7874 7261 5f6e 616d 6520 2b3d     extra_name +=
-00029d70: 2022 5f6f 7673 616d 707b 6f76 7d22 2e66   "_ovsamp{ov}".f
-00029d80: 6f72 6d61 7428 6f76 3d6f 7665 725f 7361  ormat(ov=over_sa
-00029d90: 6d70 6c65 290a 0a20 2020 2020 2020 2069  mple)..        i
-00029da0: 6620 6f75 7465 725f 7261 6469 7573 2021  f outer_radius !
-00029db0: 3d20 2772 6567 696f 6e27 3a0a 2020 2020  = 'region':.    
-00029dc0: 2020 2020 2020 2020 2320 5468 6520 6b65          # The ke
-00029dd0: 7920 756e 6465 7220 7768 6963 6820 7468  y under which th
-00029de0: 6573 6520 7370 6563 7472 6120 7769 6c6c  ese spectra will
-00029df0: 2062 6520 7374 6f72 6564 0a20 2020 2020   be stored.     
-00029e00: 2020 2020 2020 2073 7065 635f 7374 6f72         spec_stor
-00029e10: 6167 655f 6e61 6d65 203d 2022 7261 7b72  age_name = "ra{r
-00029e20: 617d 5f64 6563 7b64 6563 7d5f 7269 7b72  a}_dec{dec}_ri{r
-00029e30: 697d 5f72 6f7b 726f 7d5f 6772 707b 6772  i}_ro{ro}_grp{gr
-00029e40: 7d22 0a20 2020 2020 2020 2020 2020 2073  }".            s
-00029e50: 7065 635f 7374 6f72 6167 655f 6e61 6d65  pec_storage_name
-00029e60: 203d 2073 7065 635f 7374 6f72 6167 655f   = spec_storage_
-00029e70: 6e61 6d65 2e66 6f72 6d61 7428 7261 3d73  name.format(ra=s
-00029e80: 656c 662e 6465 6661 756c 745f 636f 6f72  elf.default_coor
-00029e90: 645b 305d 2e76 616c 7565 2c0a 2020 2020  d[0].value,.    
-00029ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029ed0: 2020 2020 2064 6563 3d73 656c 662e 6465       dec=self.de
-00029ee0: 6661 756c 745f 636f 6f72 645b 315d 2e76  fault_coord[1].v
-00029ef0: 616c 7565 2c0a 2020 2020 2020 2020 2020  alue,.          
-00029f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029f20: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00029f30: 693d 696e 6e5f 7261 645f 6e75 6d2e 7661  i=inn_rad_num.va
-00029f40: 6c75 652c 2072 6f3d 6f75 745f 7261 645f  lue, ro=out_rad_
-00029f50: 6e75 6d2e 7661 6c75 652c 0a20 2020 2020  num.value,.     
-00029f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029f90: 2020 2020 6772 3d67 726f 7570 5f73 7065      gr=group_spe
-00029fa0: 6329 0a20 2020 2020 2020 2065 6c73 653a  c).        else:
-00029fb0: 0a20 2020 2020 2020 2020 2020 2073 7065  .            spe
-00029fc0: 635f 7374 6f72 6167 655f 6e61 6d65 203d  c_storage_name =
-00029fd0: 2022 7265 6769 6f6e 5f67 7270 7b67 727d   "region_grp{gr}
-00029fe0: 222e 666f 726d 6174 2867 723d 6772 6f75  ".format(gr=grou
-00029ff0: 705f 7370 6563 290a 0a20 2020 2020 2020  p_spec)..       
-0002a000: 2023 2041 6464 7320 6f6e 2074 6865 2065   # Adds on the e
-0002a010: 7874 7261 2069 6e66 6f72 6d61 7469 6f6e  xtra information
-0002a020: 2061 626f 7574 2067 726f 7570 696e 6720   about grouping 
-0002a030: 746f 2074 6865 2073 746f 7261 6765 206b  to the storage k
-0002a040: 6579 0a20 2020 2020 2020 2073 7065 635f  ey.        spec_
-0002a050: 7374 6f72 6167 655f 6e61 6d65 202b 3d20  storage_name += 
-0002a060: 6578 7472 615f 6e61 6d65 0a20 2020 2020  extra_name.     
-0002a070: 2020 206d 6174 6368 6564 5f70 726f 6473     matched_prods
-0002a080: 203d 2073 656c 662e 6765 745f 7072 6f64   = self.get_prod
-0002a090: 7563 7473 2827 7370 6563 7472 756d 272c  ucts('spectrum',
-0002a0a0: 206f 6273 5f69 643d 6f62 735f 6964 2c20   obs_id=obs_id, 
-0002a0b0: 696e 7374 3d69 6e73 742c 2065 7874 7261  inst=inst, extra
-0002a0c0: 5f6b 6579 3d73 7065 635f 7374 6f72 6167  _key=spec_storag
-0002a0d0: 655f 6e61 6d65 290a 2020 2020 2020 2020  e_name).        
-0002a0e0: 6966 206c 656e 286d 6174 6368 6564 5f70  if len(matched_p
-0002a0f0: 726f 6473 2920 3d3d 2031 3a0a 2020 2020  rods) == 1:.    
-0002a100: 2020 2020 2020 2020 6d61 7463 6865 645f          matched_
-0002a110: 7072 6f64 7320 3d20 6d61 7463 6865 645f  prods = matched_
-0002a120: 7072 6f64 735b 305d 0a20 2020 2020 2020  prods[0].       
-0002a130: 2065 6c69 6620 6c65 6e28 6d61 7463 6865   elif len(matche
-0002a140: 645f 7072 6f64 7329 203d 3d20 303a 0a20  d_prods) == 0:. 
-0002a150: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0002a160: 204e 6f50 726f 6475 6374 4176 6169 6c61   NoProductAvaila
-0002a170: 626c 6545 7272 6f72 2822 4361 6e6e 6f74  bleError("Cannot
-0002a180: 2066 696e 6420 616e 7920 7370 6563 7472   find any spectr
-0002a190: 6120 6d61 7463 6869 6e67 2079 6f75 7220  a matching your 
-0002a1a0: 696e 7075 742e 2229 0a0a 2020 2020 2020  input.")..      
-0002a1b0: 2020 7265 7475 726e 206d 6174 6368 6564    return matched
-0002a1c0: 5f70 726f 6473 0a0a 2020 2020 6465 6620  _prods..    def 
-0002a1d0: 6765 745f 616e 6e75 6c61 725f 7370 6563  get_annular_spec
-0002a1e0: 7472 6128 7365 6c66 2c20 7261 6469 693a  tra(self, radii:
-0002a1f0: 2051 7561 6e74 6974 7920 3d20 4e6f 6e65   Quantity = None
-0002a200: 2c20 6772 6f75 705f 7370 6563 3a20 626f  , group_spec: bo
-0002a210: 6f6c 203d 2054 7275 652c 206d 696e 5f63  ol = True, min_c
-0002a220: 6f75 6e74 733a 2069 6e74 203d 2035 2c0a  ounts: int = 5,.
-0002a230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a240: 2020 2020 2020 2020 2020 2020 6d69 6e5f              min_
-0002a250: 736e 3a20 666c 6f61 7420 3d20 4e6f 6e65  sn: float = None
-0002a260: 2c20 6f76 6572 5f73 616d 706c 653a 2066  , over_sample: f
-0002a270: 6c6f 6174 203d 204e 6f6e 652c 2073 6574  loat = None, set
-0002a280: 5f69 643a 2069 6e74 203d 204e 6f6e 6529  _id: int = None)
-0002a290: 202d 3e20 416e 6e75 6c61 7253 7065 6374   -> AnnularSpect
-0002a2a0: 7261 3a0a 2020 2020 2020 2020 2222 220a  ra:.        """.
-0002a2b0: 2020 2020 2020 2020 416e 6f74 6865 7220          Another 
-0002a2c0: 7573 6566 756c 206d 6574 686f 6420 7468  useful method th
-0002a2d0: 6174 2077 7261 7073 2074 6865 2067 6574  at wraps the get
-0002a2e0: 5f70 726f 6475 6374 7320 6675 6e63 7469  _products functi
-0002a2f0: 6f6e 2c20 7468 6f75 6768 2074 6869 7320  on, though this 
-0002a300: 6f6e 6520 6765 7473 2079 6f75 2041 6e6e  one gets you Ann
-0002a310: 756c 6172 5370 6563 7472 612e 0a20 2020  ularSpectra..   
-0002a320: 2020 2020 2050 6173 7320 7468 6520 7261       Pass the ra
-0002a330: 6469 6920 7573 6564 2074 6f20 6765 6e65  dii used to gene
-0002a340: 7261 7465 2074 6865 2061 6e6e 756c 692c  rate the annuli,
-0002a350: 2061 6e64 2074 6865 2073 616d 6520 7365   and the same se
-0002a360: 7474 696e 6773 2079 6f75 2075 7365 6420  ttings you used 
-0002a370: 746f 2067 656e 6572 6174 6520 7468 6520  to generate the 
-0002a380: 7370 6563 7472 756d 0a20 2020 2020 2020  spectrum.       
-0002a390: 2069 6e20 7370 6563 7472 756d 5f73 6574   in spectrum_set
-0002a3a0: 2c20 616e 6420 7468 6520 416e 6e75 6c61  , and the Annula
-0002a3b0: 7253 7065 6374 7261 2077 696c 6c20 6265  rSpectra will be
-0002a3c0: 2072 6574 7572 6e65 6420 2869 6620 6974   returned (if it
-0002a3d0: 2065 7869 7374 7329 2e20 4966 206e 6f20   exists). If no 
-0002a3e0: 6d61 7463 6820 6973 2066 6f75 6e64 2074  match is found t
-0002a3f0: 6865 6e0a 2020 2020 2020 2020 6120 4e6f  hen.        a No
-0002a400: 5072 6f64 7563 7441 7661 696c 6162 6c65  ProductAvailable
-0002a410: 4572 726f 7220 7769 6c6c 2062 6520 7261  Error will be ra
-0002a420: 6973 6564 2e20 5468 6973 206d 6574 686f  ised. This metho
-0002a430: 6420 6861 7320 616e 2061 6464 6974 696f  d has an additio
-0002a440: 6e61 6c20 7761 7920 6f66 206c 6f6f 6b69  nal way of looki
-0002a450: 6e67 2066 6f72 2061 206d 6174 6368 696e  ng for a matchin
-0002a460: 670a 2020 2020 2020 2020 7370 6563 7472  g.        spectr
-0002a470: 756d 2c20 6966 2074 6865 2073 6574 2049  um, if the set I
-0002a480: 4420 6973 206b 6e6f 776e 2074 6865 6e20  D is known then 
-0002a490: 7468 6174 2063 616e 2062 6520 7061 7373  that can be pass
-0002a4a0: 6564 2062 7920 7468 6520 7573 6572 2061  ed by the user a
-0002a4b0: 6e64 2075 7365 6420 746f 2066 696e 6420  nd used to find 
-0002a4c0: 616e 2065 7861 6374 206d 6174 6368 2e0a  an exact match..
-0002a4d0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-0002a4e0: 5175 616e 7469 7479 2072 6164 6969 3a20  Quantity radii: 
-0002a4f0: 5468 6520 616e 6e75 6c75 7320 626f 756e  The annulus boun
-0002a500: 6461 7279 2072 6164 6969 2074 6861 7420  dary radii that 
-0002a510: 7765 7265 2075 7365 6420 746f 2067 656e  were used to gen
-0002a520: 6572 6174 6520 7468 6520 616e 6e75 6c61  erate the annula
-0002a530: 7220 7370 6563 7472 6120 7365 740a 2020  r spectra set.  
-0002a540: 2020 2020 2020 2020 2020 7468 6174 2079            that y
-0002a550: 6f75 2077 6973 6820 746f 2072 6574 7269  ou wish to retri
-0002a560: 6576 652e 2042 7920 6465 6661 756c 7420  eve. By default 
-0002a570: 7468 6973 2069 7320 4e6f 6e65 2c20 7768  this is None, wh
-0002a580: 6963 6820 6d65 616e 7320 7468 6520 6d65  ich means the me
-0002a590: 7468 6f64 2077 696c 6c20 7265 7475 726e  thod will return
-0002a5a0: 2061 6e6e 756c 6172 0a20 2020 2020 2020   annular.       
-0002a5b0: 2020 2020 2073 7065 6374 7261 2077 6974       spectra wit
-0002a5c0: 6820 616e 7920 7261 6469 692e 0a20 2020  h any radii..   
-0002a5d0: 2020 2020 203a 7061 7261 6d20 626f 6f6c       :param bool
-0002a5e0: 2067 726f 7570 5f73 7065 633a 2057 6173   group_spec: Was
-0002a5f0: 2074 6865 2073 7065 6374 7275 6d20 7365   the spectrum se
-0002a600: 7420 796f 7520 7769 7368 2074 6f20 7265  t you wish to re
-0002a610: 7472 6965 7665 2067 726f 7570 6564 3f0a  trieve grouped?.
-0002a620: 2020 2020 2020 2020 3a70 6172 616d 2066          :param f
-0002a630: 6c6f 6174 206d 696e 5f63 6f75 6e74 733a  loat min_counts:
-0002a640: 2049 6620 7468 6520 7370 6563 7472 756d   If the spectrum
-0002a650: 2073 6574 2079 6f75 2077 6973 6820 746f   set you wish to
-0002a660: 2072 6574 7269 6576 6520 7761 7320 6772   retrieve was gr
-0002a670: 6f75 7065 6420 6f6e 206d 696e 696d 756d  ouped on minimum
-0002a680: 2063 6f75 6e74 732c 2077 6861 7420 7761   counts, what wa
-0002a690: 730a 2020 2020 2020 2020 2020 2020 7468  s.            th
-0002a6a0: 6520 6d69 6e69 6d75 6d20 6e75 6d62 6572  e minimum number
-0002a6b0: 206f 6620 636f 756e 7473 3f0a 2020 2020   of counts?.    
-0002a6c0: 2020 2020 3a70 6172 616d 2066 6c6f 6174      :param float
-0002a6d0: 206d 696e 5f73 6e3a 2049 6620 7468 6520   min_sn: If the 
-0002a6e0: 7370 6563 7472 756d 2073 6574 2079 6f75  spectrum set you
-0002a6f0: 2077 6973 6820 746f 2072 6574 7269 6576   wish to retriev
-0002a700: 6520 7761 7320 6772 6f75 7065 6420 6f6e  e was grouped on
-0002a710: 206d 696e 696d 756d 2073 6967 6e61 6c20   minimum signal 
-0002a720: 746f 0a20 2020 2020 2020 2020 2020 206e  to.            n
-0002a730: 6f69 7365 2c20 7768 6174 2077 6173 2074  oise, what was t
-0002a740: 6865 206d 696e 696d 756d 2073 6967 6e61  he minimum signa
-0002a750: 6c20 746f 206e 6f69 7365 2e0a 2020 2020  l to noise..    
-0002a760: 2020 2020 3a70 6172 616d 2066 6c6f 6174      :param float
-0002a770: 206f 7665 725f 7361 6d70 6c65 3a20 4966   over_sample: If
-0002a780: 2074 6865 2073 7065 6374 7275 6d20 7365   the spectrum se
-0002a790: 7420 796f 7520 7769 7368 2074 6f20 7265  t you wish to re
-0002a7a0: 7472 6965 7665 2077 6173 206f 7665 7220  trieve was over 
-0002a7b0: 7361 6d70 6c65 642c 2077 6861 7420 7761  sampled, what wa
-0002a7c0: 7320 7468 6520 6c65 7665 6c20 6f66 0a20  s the level of. 
-0002a7d0: 2020 2020 2020 2020 2020 206f 7665 7220             over 
-0002a7e0: 7361 6d70 6c69 6e67 2075 7365 643f 0a20  sampling used?. 
-0002a7f0: 2020 2020 2020 203a 7061 7261 6d20 696e         :param in
-0002a800: 7420 7365 745f 6964 3a20 5468 6520 756e  t set_id: The un
-0002a810: 6971 7565 2069 6465 6e74 6966 6965 7220  ique identifier 
-0002a820: 6f66 2074 6865 2061 6e6e 756c 6172 2073  of the annular s
-0002a830: 7065 6374 7275 6d20 7365 742e 2050 6173  pectrum set. Pas
-0002a840: 7369 6e67 2061 2076 616c 7565 2066 6f72  sing a value for
-0002a850: 2074 6869 7320 7061 7261 6d65 7465 720a   this parameter.
-0002a860: 2020 2020 2020 2020 2020 2020 7769 6c6c              will
-0002a870: 206f 7665 7272 6964 6520 616e 7920 6f74   override any ot
-0002a880: 6865 7220 696e 666f 726d 6174 696f 6e20  her information 
-0002a890: 7468 6174 2079 6f75 2068 6176 6520 6769  that you have gi
-0002a8a0: 7665 6e20 7468 6973 206d 6574 686f 642e  ven this method.
-0002a8b0: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
-0002a8c0: 3a20 416e 2058 4741 2041 6e6e 756c 6172  : An XGA Annular
-0002a8d0: 5370 6563 7472 6120 6f62 6a65 6374 2069  Spectra object i
-0002a8e0: 6620 7468 6572 6520 6973 2061 6e20 6578  f there is an ex
-0002a8f0: 6163 7420 6d61 7463 682e 0a20 2020 2020  act match..     
-0002a900: 2020 203a 7274 7970 653a 2041 6e6e 756c     :rtype: Annul
-0002a910: 6172 5370 6563 7472 610a 2020 2020 2020  arSpectra.      
-0002a920: 2020 2222 220a 2020 2020 2020 2020 6966    """.        if
-0002a930: 2067 726f 7570 5f73 7065 6320 616e 6420   group_spec and 
-0002a940: 6d69 6e5f 636f 756e 7473 2069 7320 6e6f  min_counts is no
-0002a950: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-0002a960: 2020 2020 6578 7472 615f 6e61 6d65 203d      extra_name =
-0002a970: 2022 5f6d 696e 636e 747b 7d22 2e66 6f72   "_mincnt{}".for
-0002a980: 6d61 7428 6d69 6e5f 636f 756e 7473 290a  mat(min_counts).
-0002a990: 2020 2020 2020 2020 656c 6966 2067 726f          elif gro
-0002a9a0: 7570 5f73 7065 6320 616e 6420 6d69 6e5f  up_spec and min_
-0002a9b0: 736e 2069 7320 6e6f 7420 4e6f 6e65 3a0a  sn is not None:.
-0002a9c0: 2020 2020 2020 2020 2020 2020 6578 7472              extr
-0002a9d0: 615f 6e61 6d65 203d 2022 5f6d 696e 736e  a_name = "_minsn
-0002a9e0: 7b7d 222e 666f 726d 6174 286d 696e 5f73  {}".format(min_s
-0002a9f0: 6e29 0a20 2020 2020 2020 2065 6c73 653a  n).        else:
-0002aa00: 0a20 2020 2020 2020 2020 2020 2065 7874  .            ext
-0002aa10: 7261 5f6e 616d 6520 3d20 2727 0a0a 2020  ra_name = ''..  
-0002aa20: 2020 2020 2020 2320 416e 6420 6966 2069        # And if i
-0002aa30: 7420 7761 7320 6f76 6572 7361 6d70 6c65  t was oversample
-0002aa40: 6420 6475 7269 6e67 2067 656e 6572 6174  d during generat
-0002aa50: 696f 6e20 7468 656e 2077 6520 6e65 6564  ion then we need
-0002aa60: 2074 6f20 696e 636c 7564 6520 7468 6174   to include that
-0002aa70: 2061 7320 7765 6c6c 0a20 2020 2020 2020   as well.       
-0002aa80: 2069 6620 6f76 6572 5f73 616d 706c 6520   if over_sample 
-0002aa90: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-0002aaa0: 2020 2020 2020 2020 2065 7874 7261 5f6e           extra_n
-0002aab0: 616d 6520 2b3d 2022 5f6f 7673 616d 707b  ame += "_ovsamp{
-0002aac0: 6f76 7d22 2e66 6f72 6d61 7428 6f76 3d6f  ov}".format(ov=o
-0002aad0: 7665 725f 7361 6d70 6c65 290a 0a20 2020  ver_sample)..   
-0002aae0: 2020 2020 2023 2043 6f6d 6269 6e65 7320       # Combines 
-0002aaf0: 7468 6520 616e 6e75 6c61 7220 7261 6469  the annular radi
-0002ab00: 6920 696e 746f 2061 2073 7472 696e 672c  i into a string,
-0002ab10: 2061 6e64 206d 616b 6573 2073 7572 6520   and makes sure 
-0002ab20: 7468 6520 7261 6469 6920 6172 6520 696e  the radii are in
-0002ab30: 2064 6567 7265 6573 2c20 6173 2072 6164   degrees, as rad
-0002ab40: 6969 2061 7265 2069 6e0a 2020 2020 2020  ii are in.      
-0002ab50: 2020 2320 2064 6567 7265 6573 2069 6e20    #  degrees in 
-0002ab60: 7468 6520 7374 6f72 6167 6520 6b65 790a  the storage key.
-0002ab70: 2020 2020 2020 2020 6966 2072 6164 6969          if radii
-0002ab80: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-0002ab90: 2020 2020 2020 2020 2020 2320 5765 2772            # We'r
-0002aba0: 6520 6465 616c 696e 6720 7769 7468 2074  e dealing with t
-0002abb0: 6865 2062 6573 7420 6361 7365 2068 6572  he best case her
-0002abc0: 652c 2074 6865 2075 7365 7220 6861 7320  e, the user has 
-0002abd0: 7061 7373 6564 2072 6164 6969 2c20 736f  passed radii, so
-0002abe0: 2077 6520 6361 6e20 6765 6e65 7261 7465   we can generate
-0002abf0: 2061 6e20 6578 6163 740a 2020 2020 2020   an exact.      
-0002ac00: 2020 2020 2020 2320 2073 746f 7261 6765        #  storage
-0002ac10: 206b 6579 2061 6e64 206c 6f6f 6b20 666f   key and look fo
-0002ac20: 7220 6120 7369 6e67 6c65 206d 6174 6368  r a single match
-0002ac30: 0a20 2020 2020 2020 2020 2020 2061 6e6e  .            ann
-0002ac40: 5f72 6164 5f73 7472 203d 2022 5f22 2e6a  _rad_str = "_".j
-0002ac50: 6f69 6e28 7365 6c66 2e63 6f6e 7665 7274  oin(self.convert
-0002ac60: 5f72 6164 6975 7328 7261 6469 692c 2027  _radius(radii, '
-0002ac70: 6465 6727 292e 7661 6c75 652e 6173 7479  deg').value.asty
-0002ac80: 7065 2873 7472 2929 0a20 2020 2020 2020  pe(str)).       
-0002ac90: 2020 2020 2073 7065 635f 7374 6f72 6167       spec_storag
-0002aca0: 655f 6e61 6d65 203d 2022 7261 7b72 617d  e_name = "ra{ra}
-0002acb0: 5f64 6563 7b64 6563 7d5f 6172 7b61 727d  _dec{dec}_ar{ar}
-0002acc0: 5f67 7270 7b67 727d 220a 2020 2020 2020  _grp{gr}".      
-0002acd0: 2020 2020 2020 7370 6563 5f73 746f 7261        spec_stora
-0002ace0: 6765 5f6e 616d 6520 3d20 7370 6563 5f73  ge_name = spec_s
-0002acf0: 746f 7261 6765 5f6e 616d 652e 666f 726d  torage_name.form
-0002ad00: 6174 2872 613d 7365 6c66 2e64 6566 6175  at(ra=self.defau
-0002ad10: 6c74 5f63 6f6f 7264 5b30 5d2e 7661 6c75  lt_coord[0].valu
-0002ad20: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0002ad30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ad40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ad50: 2020 2020 2020 2020 2020 2020 6465 633d              dec=
-0002ad60: 7365 6c66 2e64 6566 6175 6c74 5f63 6f6f  self.default_coo
-0002ad70: 7264 5b31 5d2e 7661 6c75 652c 0a20 2020  rd[1].value,.   
-0002ad80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ad90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ada0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002adb0: 2020 2020 2020 6172 3d61 6e6e 5f72 6164        ar=ann_rad
-0002adc0: 5f73 7472 2c20 6772 3d67 726f 7570 5f73  _str, gr=group_s
-0002add0: 7065 6329 0a20 2020 2020 2020 2020 2020  pec).           
-0002ade0: 2073 7065 635f 7374 6f72 6167 655f 6e61   spec_storage_na
-0002adf0: 6d65 202b 3d20 6578 7472 615f 6e61 6d65  me += extra_name
-0002ae00: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-0002ae10: 2020 2020 2020 2020 2020 2023 2054 6869             # Thi
-0002ae20: 7320 6973 2061 2077 6f72 7365 2063 6173  s is a worse cas
-0002ae30: 652c 2077 6520 646f 6e27 7420 6861 7665  e, we don't have
-0002ae40: 2072 6164 6969 2c20 736f 2077 6520 7370   radii, so we sp
-0002ae50: 6c69 7420 7468 6520 6b6e 6f77 6e20 7061  lit the known pa
-0002ae60: 7274 7320 6f66 2074 6865 206b 6579 2069  rts of the key i
-0002ae70: 6e74 6f20 6120 6c69 7374 0a20 2020 2020  nto a list.     
-0002ae80: 2020 2020 2020 2023 2020 616e 6420 7765         #  and we
-0002ae90: 276c 6c20 6c6f 6f6b 2066 6f72 2070 6172  'll look for par
-0002aea0: 7469 616c 206d 6174 6368 6573 0a20 2020  tial matches.   
-0002aeb0: 2020 2020 2020 2020 2070 6f73 5f73 7472           pos_str
-0002aec0: 203d 2022 7261 7b72 617d 5f64 6563 7b64   = "ra{ra}_dec{d
-0002aed0: 6563 7d22 2e66 6f72 6d61 7428 7261 3d73  ec}".format(ra=s
-0002aee0: 656c 662e 6465 6661 756c 745f 636f 6f72  elf.default_coor
-0002aef0: 645b 305d 2e76 616c 7565 2c20 6465 633d  d[0].value, dec=
-0002af00: 7365 6c66 2e64 6566 6175 6c74 5f63 6f6f  self.default_coo
-0002af10: 7264 5b31 5d2e 7661 6c75 6529 0a20 2020  rd[1].value).   
-0002af20: 2020 2020 2020 2020 2067 7270 5f73 7472           grp_str
-0002af30: 203d 2022 6772 707b 6772 7d22 2e66 6f72   = "grp{gr}".for
-0002af40: 6d61 7428 6772 3d67 726f 7570 5f73 7065  mat(gr=group_spe
-0002af50: 6329 202b 2065 7874 7261 5f6e 616d 650a  c) + extra_name.
-0002af60: 2020 2020 2020 2020 2020 2020 7370 6563              spec
-0002af70: 5f73 746f 7261 6765 5f6e 616d 6520 3d20  _storage_name = 
-0002af80: 5b70 6f73 5f73 7472 2c20 6772 705f 7374  [pos_str, grp_st
-0002af90: 725d 0a0a 2020 2020 2020 2020 2320 4966  r]..        # If
-0002afa0: 2074 6865 2075 7365 7220 6861 736e 2774   the user hasn't
-0002afb0: 2070 6173 7365 6420 6120 7365 7420 4944   passed a set ID
-0002afc0: 2041 4e44 2074 6865 2075 7365 7220 6861   AND the user ha
-0002afd0: 7320 7061 7373 6564 2072 6164 6969 2074  s passed radii t
-0002afe0: 6865 6e20 7765 276c 6c20 676f 206c 6f6f  hen we'll go loo
-0002aff0: 6b69 6e67 2077 6974 6820 6f75 740a 2020  king with out.  
-0002b000: 2020 2020 2020 2320 2070 726f 7065 726c        #  properl
-0002b010: 7920 636f 6e73 7472 7563 7465 6420 7374  y constructed st
-0002b020: 6f72 6167 6520 6b65 790a 2020 2020 2020  orage key.      
-0002b030: 2020 6966 2073 6574 5f69 6420 6973 204e    if set_id is N
-0002b040: 6f6e 6520 616e 6420 7261 6469 6920 6973  one and radii is
-0002b050: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-0002b060: 2020 2020 2020 206d 6174 6368 6564 5f70         matched_p
-0002b070: 726f 6473 203d 2073 656c 662e 6765 745f  rods = self.get_
-0002b080: 7072 6f64 7563 7473 2827 636f 6d62 696e  products('combin
-0002b090: 6564 5f73 7065 6374 7275 6d27 2c20 6578  ed_spectrum', ex
-0002b0a0: 7472 615f 6b65 793d 7370 6563 5f73 746f  tra_key=spec_sto
-0002b0b0: 7261 6765 5f6e 616d 6529 0a20 2020 2020  rage_name).     
-0002b0c0: 2020 2023 2042 7574 2069 6620 7468 6520     # But if the 
-0002b0d0: 7573 6572 2068 6173 6e27 7420 7061 7373  user hasn't pass
-0002b0e0: 6564 2061 6e20 4944 2041 4e44 2074 6865  ed an ID AND the
-0002b0f0: 2072 6164 6969 2061 7265 204e 6f6e 6520   radii are None 
-0002b100: 7468 656e 2077 6520 6c6f 6f6b 2066 6f72  then we look for
-0002b110: 2070 6172 7469 616c 206d 6174 6368 6573   partial matches
-0002b120: 0a20 2020 2020 2020 2065 6c69 6620 7365  .        elif se
-0002b130: 745f 6964 2069 7320 4e6f 6e65 2061 6e64  t_id is None and
-0002b140: 2072 6164 6969 2069 7320 4e6f 6e65 3a0a   radii is None:.
-0002b150: 2020 2020 2020 2020 2020 2020 6d61 7463              matc
-0002b160: 6865 645f 7072 6f64 7320 3d20 5b70 2066  hed_prods = [p f
-0002b170: 6f72 2070 2069 6e20 7365 6c66 2e67 6574  or p in self.get
-0002b180: 5f70 726f 6475 6374 7328 2763 6f6d 6269  _products('combi
-0002b190: 6e65 645f 7370 6563 7472 756d 2729 0a20  ned_spectrum'). 
-0002b1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b1b0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-0002b1c0: 7065 635f 7374 6f72 6167 655f 6e61 6d65  pec_storage_name
-0002b1d0: 5b30 5d20 696e 2070 2e73 746f 7261 6765  [0] in p.storage
-0002b1e0: 5f6b 6579 2061 6e64 2073 7065 635f 7374  _key and spec_st
-0002b1f0: 6f72 6167 655f 6e61 6d65 5b31 5d20 696e  orage_name[1] in
-0002b200: 2070 2e73 746f 7261 6765 5f6b 6579 5d0a   p.storage_key].
-0002b210: 2020 2020 2020 2020 2320 486f 7765 7665          # Howeve
-0002b220: 7220 6966 2074 6865 7920 6861 7665 2070  r if they have p
-0002b230: 6173 7365 6420 6120 7365 7449 4420 7468  assed a setID th
-0002b240: 656e 2074 6869 7320 6f76 6572 2d72 6964  en this over-rid
-0002b250: 6573 2065 7665 7279 7468 696e 6720 656c  es everything el
-0002b260: 7365 0a20 2020 2020 2020 2065 6c73 653a  se.        else:
-0002b270: 0a20 2020 2020 2020 2020 2020 2023 2057  .            # W
-0002b280: 6974 6820 7468 6520 7365 7420 4944 2077  ith the set ID w
-0002b290: 6520 6665 7463 6820 414c 4c20 616e 6e75  e fetch ALL annu
-0002b2a0: 6c61 7220 7370 6563 7472 612c 2074 6865  lar spectra, the
-0002b2b0: 6e20 7573 6520 7468 6569 7220 7365 745f  n use their set_
-0002b2c0: 6964 2070 726f 7065 7274 7920 746f 206d  id property to m
-0002b2d0: 6174 6368 2061 6761 696e 7374 0a20 2020  atch against.   
-0002b2e0: 2020 2020 2020 2020 2023 2020 7768 6174           #  what
-0002b2f0: 6576 6572 2074 6865 2075 7365 7220 7061  ever the user pa
-0002b300: 7373 6564 2069 6e0a 2020 2020 2020 2020  ssed in.        
-0002b310: 2020 2020 6d61 7463 6865 645f 7072 6f64      matched_prod
-0002b320: 7320 3d20 5b70 2066 6f72 2070 2069 6e20  s = [p for p in 
-0002b330: 7365 6c66 2e67 6574 5f70 726f 6475 6374  self.get_product
-0002b340: 7328 2763 6f6d 6269 6e65 645f 7370 6563  s('combined_spec
-0002b350: 7472 756d 2729 2069 6620 702e 7365 745f  trum') if p.set_
-0002b360: 6964 656e 7420 3d3d 2073 6574 5f69 645d  ident == set_id]
-0002b370: 0a0a 2020 2020 2020 2020 6966 206c 656e  ..        if len
-0002b380: 286d 6174 6368 6564 5f70 726f 6473 2920  (matched_prods) 
-0002b390: 3d3d 2031 3a0a 2020 2020 2020 2020 2020  == 1:.          
-0002b3a0: 2020 6d61 7463 6865 645f 7072 6f64 7320    matched_prods 
-0002b3b0: 3d20 6d61 7463 6865 645f 7072 6f64 735b  = matched_prods[
-0002b3c0: 305d 0a20 2020 2020 2020 2065 6c69 6620  0].        elif 
-0002b3d0: 6c65 6e28 6d61 7463 6865 645f 7072 6f64  len(matched_prod
-0002b3e0: 7329 203d 3d20 303a 0a20 2020 2020 2020  s) == 0:.       
-0002b3f0: 2020 2020 2072 6169 7365 204e 6f50 726f       raise NoPro
-0002b400: 6475 6374 4176 6169 6c61 626c 6545 7272  ductAvailableErr
-0002b410: 6f72 2822 4e6f 206d 6174 6368 696e 6720  or("No matching 
-0002b420: 416e 6e75 6c61 7253 7065 6374 7261 2063  AnnularSpectra c
-0002b430: 616e 2062 6520 666f 756e 642e 2229 0a0a  an be found.")..
-0002b440: 2020 2020 2020 2020 7265 7475 726e 206d          return m
-0002b450: 6174 6368 6564 5f70 726f 6473 0a0a 2020  atched_prods..  
-0002b460: 2020 6465 6620 5f67 6574 5f70 686f 745f    def _get_phot_
-0002b470: 7072 6f64 2873 656c 662c 2070 726f 645f  prod(self, prod_
-0002b480: 7479 7065 3a20 7374 722c 206f 6273 5f69  type: str, obs_i
-0002b490: 643a 2073 7472 203d 204e 6f6e 652c 2069  d: str = None, i
-0002b4a0: 6e73 743a 2073 7472 203d 204e 6f6e 652c  nst: str = None,
-0002b4b0: 206c 6f5f 656e 3a20 5175 616e 7469 7479   lo_en: Quantity
-0002b4c0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-0002b4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b4e0: 6869 5f65 6e3a 2051 7561 6e74 6974 7920  hi_en: Quantity 
-0002b4f0: 3d20 4e6f 6e65 2c20 7073 665f 636f 7272  = None, psf_corr
-0002b500: 3a20 626f 6f6c 203d 2046 616c 7365 2c20  : bool = False, 
-0002b510: 7073 665f 6d6f 6465 6c3a 2073 7472 203d  psf_model: str =
-0002b520: 2022 454c 4c42 4554 4122 2c0a 2020 2020   "ELLBETA",.    
-0002b530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b540: 2020 2070 7366 5f62 696e 733a 2069 6e74     psf_bins: int
-0002b550: 203d 2034 2c20 7073 665f 616c 676f 3a20   = 4, psf_algo: 
-0002b560: 7374 7220 3d20 2272 6c22 2c20 7073 665f  str = "rl", psf_
-0002b570: 6974 6572 3a20 696e 7420 3d20 3135 2920  iter: int = 15) 
-0002b580: 5c0a 2020 2020 2020 2020 2020 2020 2d3e  \.            ->
-0002b590: 2055 6e69 6f6e 5b49 6d61 6765 2c20 4578   Union[Image, Ex
-0002b5a0: 704d 6170 2c20 5261 7465 4d61 702c 204c  pMap, RateMap, L
-0002b5b0: 6973 745b 496d 6167 655d 2c20 4c69 7374  ist[Image], List
-0002b5c0: 5b45 7870 4d61 705d 2c20 4c69 7374 5b52  [ExpMap], List[R
-0002b5d0: 6174 654d 6170 5d5d 3a0a 2020 2020 2020  ateMap]]:.      
-0002b5e0: 2020 2222 220a 2020 2020 2020 2020 416e    """.        An
-0002b5f0: 2069 6e74 6572 6e61 6c20 6d65 7468 6f64   internal method
-0002b600: 2077 6869 6368 2069 7320 7468 6520 6261   which is the ba
-0002b610: 7369 7320 6f66 2074 6865 2067 6574 5f69  sis of the get_i
-0002b620: 6d61 6765 732c 2067 6574 5f65 7870 6d61  mages, get_expma
-0002b630: 7073 2c20 616e 6420 6765 745f 7261 7465  ps, and get_rate
-0002b640: 6d61 7073 206d 6574 686f 6473 2e0a 0a20  maps methods... 
-0002b650: 2020 2020 2020 203a 7061 7261 6d20 7374         :param st
-0002b660: 7220 6f62 735f 6964 3a20 4f70 7469 6f6e  r obs_id: Option
-0002b670: 616c 6c79 2c20 6120 7370 6563 6966 6963  ally, a specific
-0002b680: 206f 6273 5f69 6420 746f 2073 6561 7263   obs_id to searc
-0002b690: 6820 666f 7220 6361 6e20 6265 2073 7570  h for can be sup
-0002b6a0: 706c 6965 642e 2054 6865 2064 6566 6175  plied. The defau
-0002b6b0: 6c74 2069 7320 4e6f 6e65 2c0a 2020 2020  lt is None,.    
-0002b6c0: 2020 2020 2020 2020 7768 6963 6820 6d65          which me
-0002b6d0: 616e 7320 616c 6c20 696d 6167 6573 2f65  ans all images/e
-0002b6e0: 7870 6d61 7073 2f72 6174 656d 6170 7320  xpmaps/ratemaps 
-0002b6f0: 6d61 7463 6869 6e67 2074 6865 206f 7468  matching the oth
-0002b700: 6572 2063 7269 7465 7269 6120 7769 6c6c  er criteria will
-0002b710: 2062 6520 7265 7475 726e 6564 2e0a 2020   be returned..  
-0002b720: 2020 2020 2020 3a70 6172 616d 2073 7472        :param str
-0002b730: 2069 6e73 743a 204f 7074 696f 6e61 6c6c   inst: Optionall
-0002b740: 792c 2061 2073 7065 6369 6669 6320 696e  y, a specific in
-0002b750: 7374 7275 6d65 6e74 2074 6f20 7365 6172  strument to sear
-0002b760: 6368 2066 6f72 2063 616e 2062 6520 7375  ch for can be su
-0002b770: 7070 6c69 6564 2e20 5468 6520 6465 6661  pplied. The defa
-0002b780: 756c 7420 6973 204e 6f6e 652c 0a20 2020  ult is None,.   
-0002b790: 2020 2020 2020 2020 2077 6869 6368 206d           which m
-0002b7a0: 6561 6e73 2061 6c6c 2069 6d61 6765 732f  eans all images/
-0002b7b0: 6578 706d 6170 732f 7261 7465 6d61 7073  expmaps/ratemaps
-0002b7c0: 206d 6174 6368 696e 6720 7468 6520 6f74   matching the ot
-0002b7d0: 6865 7220 6372 6974 6572 6961 2077 696c  her criteria wil
-0002b7e0: 6c20 6265 2072 6574 7572 6e65 642e 0a20  l be returned.. 
-0002b7f0: 2020 2020 2020 203a 7061 7261 6d20 5175         :param Qu
-0002b800: 616e 7469 7479 206c 6f5f 656e 3a20 5468  antity lo_en: Th
-0002b810: 6520 6c6f 7765 7220 656e 6572 6779 206c  e lower energy l
-0002b820: 696d 6974 206f 6620 7468 6520 696d 6167  imit of the imag
-0002b830: 6573 2f65 7870 6d61 7073 2f72 6174 656d  es/expmaps/ratem
-0002b840: 6170 7320 796f 7520 7769 7368 2074 6f0a  aps you wish to.
-0002b850: 2020 2020 2020 2020 2020 2020 7265 7472              retr
-0002b860: 6965 7665 2c20 7468 6520 6465 6661 756c  ieve, the defaul
-0002b870: 7420 6973 204e 6f6e 6520 2877 6869 6368  t is None (which
-0002b880: 2077 696c 6c20 7265 7472 6965 7665 2061   will retrieve a
-0002b890: 6c6c 2069 6d61 6765 732f 6578 706d 6170  ll images/expmap
-0002b8a0: 732f 7261 7465 6d61 7073 2072 6567 6172  s/ratemaps regar
-0002b8b0: 646c 6573 7320 6f66 0a20 2020 2020 2020  dless of.       
-0002b8c0: 2020 2020 2065 6e65 7267 7920 6c69 6d69       energy limi
-0002b8d0: 7429 2e0a 2020 2020 2020 2020 3a70 6172  t)..        :par
-0002b8e0: 616d 2051 7561 6e74 6974 7920 6869 5f65  am Quantity hi_e
-0002b8f0: 6e3a 2054 6865 2075 7070 6572 2065 6e65  n: The upper ene
-0002b900: 7267 7920 6c69 6d69 7420 6f66 2074 6865  rgy limit of the
-0002b910: 2069 6d61 6765 732f 6578 706d 6170 732f   images/expmaps/
-0002b920: 7261 7465 6d61 7073 2079 6f75 2077 6973  ratemaps you wis
-0002b930: 6820 746f 0a20 2020 2020 2020 2020 2020  h to.           
-0002b940: 2072 6574 7269 6576 652c 2074 6865 2064   retrieve, the d
-0002b950: 6566 6175 6c74 2069 7320 4e6f 6e65 2028  efault is None (
-0002b960: 7768 6963 6820 7769 6c6c 2072 6574 7269  which will retri
-0002b970: 6576 6520 616c 6c20 696d 6167 6573 2f65  eve all images/e
-0002b980: 7870 6d61 7073 2f72 6174 656d 6170 7320  xpmaps/ratemaps 
-0002b990: 7265 6761 7264 6c65 7373 206f 660a 2020  regardless of.  
-0002b9a0: 2020 2020 2020 2020 2020 656e 6572 6779            energy
-0002b9b0: 206c 696d 6974 292e 0a20 2020 2020 2020   limit)..       
-0002b9c0: 203a 7061 7261 6d20 626f 6f6c 2070 7366   :param bool psf
-0002b9d0: 5f63 6f72 723a 2053 6574 7320 7768 6574  _corr: Sets whet
-0002b9e0: 6865 7220 796f 7520 7769 7368 2074 6f20  her you wish to 
-0002b9f0: 7265 7472 6965 7665 2061 2050 5346 2063  retrieve a PSF c
-0002ba00: 6f72 7265 6374 6564 2069 6d61 6765 732f  orrected images/
-0002ba10: 7261 7465 6d61 7073 206f 7220 6e6f 742e  ratemaps or not.
-0002ba20: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-0002ba30: 7374 7220 7073 665f 6d6f 6465 6c3a 2049  str psf_model: I
-0002ba40: 6620 7468 6520 696d 6167 6573 2f72 6174  f the images/rat
-0002ba50: 656d 6170 7320 796f 7520 7761 6e74 2061  emaps you want a
-0002ba60: 7265 2050 5346 2063 6f72 7265 6374 6564  re PSF corrected
-0002ba70: 2c20 7468 6973 2069 7320 7468 6520 5053  , this is the PS
-0002ba80: 4620 6d6f 6465 6c20 7573 6564 2e0a 2020  F model used..  
-0002ba90: 2020 2020 2020 3a70 6172 616d 2069 6e74        :param int
-0002baa0: 2070 7366 5f62 696e 733a 2049 6620 7468   psf_bins: If th
-0002bab0: 6520 696d 6167 6573 2f72 6174 656d 6170  e images/ratemap
-0002bac0: 7320 796f 7520 7761 6e74 2061 7265 2050  s you want are P
-0002bad0: 5346 2063 6f72 7265 6374 6564 2c20 7468  SF corrected, th
-0002bae0: 6973 2069 7320 7468 6520 6e75 6d62 6572  is is the number
-0002baf0: 206f 6620 5053 4673 2070 6572 0a20 2020   of PSFs per.   
-0002bb00: 2020 2020 2020 2020 2073 6964 6520 696e           side in
-0002bb10: 2074 6865 2050 5346 2067 7269 642e 0a20   the PSF grid.. 
-0002bb20: 2020 2020 2020 203a 7061 7261 6d20 7374         :param st
-0002bb30: 7220 7073 665f 616c 676f 3a20 4966 2074  r psf_algo: If t
-0002bb40: 6865 2069 6d61 6765 732f 7261 7465 6d61  he images/ratema
-0002bb50: 7073 2079 6f75 2077 616e 7420 6172 6520  ps you want are 
-0002bb60: 5053 4620 636f 7272 6563 7465 642c 2074  PSF corrected, t
-0002bb70: 6869 7320 6973 2074 6865 2061 6c67 6f72  his is the algor
-0002bb80: 6974 686d 2075 7365 642e 0a20 2020 2020  ithm used..     
-0002bb90: 2020 203a 7061 7261 6d20 696e 7420 7073     :param int ps
-0002bba0: 665f 6974 6572 3a20 4966 2074 6865 2069  f_iter: If the i
+00023830: 2020 2020 2020 2020 226d 6f64 656c 7320          "models 
+00023840: 6172 6520 7b61 7d22 2e66 6f72 6d61 7428  are {a}".format(
+00023850: 6d3d 6d6f 6465 6c2c 2073 3d73 656c 662e  m=model, s=self.
+00023860: 6e61 6d65 2c20 613d 6176 5f6d 6f64 7329  name, a=av_mods)
+00023870: 290a 2020 2020 2020 2020 656c 6966 2070  ).        elif p
+00023880: 6172 2069 7320 6e6f 7420 4e6f 6e65 2061  ar is not None a
+00023890: 6e64 2070 6172 206e 6f74 2069 6e20 7365  nd par not in se
+000238a0: 6c66 2e5f 6669 745f 7265 7375 6c74 735b  lf._fit_results[
+000238b0: 7374 6f72 6167 655f 6b65 795d 5b6d 6f64  storage_key][mod
+000238c0: 656c 5d3a 0a20 2020 2020 2020 2020 2020  el]:.           
+000238d0: 2061 765f 7061 7273 203d 2022 2c20 222e   av_pars = ", ".
+000238e0: 6a6f 696e 2873 656c 662e 5f66 6974 5f72  join(self._fit_r
+000238f0: 6573 756c 7473 5b73 746f 7261 6765 5f6b  esults[storage_k
+00023900: 6579 5d5b 6d6f 6465 6c5d 2e6b 6579 7328  ey][model].keys(
+00023910: 2929 0a20 2020 2020 2020 2020 2020 2072  )).            r
+00023920: 6169 7365 2050 6172 616d 6574 6572 4e6f  aise ParameterNo
+00023930: 7441 7373 6f63 6961 7465 6445 7272 6f72  tAssociatedError
+00023940: 2822 7b70 7d20 7761 7320 6e6f 7420 6120  ("{p} was not a 
+00023950: 6672 6565 2070 6172 616d 6574 6572 2069  free parameter i
+00023960: 6e20 7468 6520 7b6d 7d20 6669 7420 746f  n the {m} fit to
+00023970: 207b 737d 2c20 220a 2020 2020 2020 2020   {s}, ".        
+00023980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000239a0: 2020 2020 2020 2274 6865 206f 7074 696f        "the optio
+000239b0: 6e73 2061 7265 207b 617d 222e 666f 726d  ns are {a}".form
+000239c0: 6174 2870 3d70 6172 2c20 6d3d 6d6f 6465  at(p=par, m=mode
+000239d0: 6c2c 2073 3d73 656c 662e 6e61 6d65 2c20  l, s=self.name, 
+000239e0: 613d 6176 5f70 6172 7329 290a 0a20 2020  a=av_pars))..   
+000239f0: 2020 2020 2023 2052 6561 6420 6f75 7420       # Read out 
+00023a00: 696e 746f 2076 6172 6961 626c 6520 666f  into variable fo
+00023a10: 7220 7265 6164 6162 696c 6974 6965 7320  r readabilities 
+00023a20: 7361 6b65 0a20 2020 2020 2020 2066 6974  sake.        fit
+00023a30: 5f64 6174 6120 3d20 7365 6c66 2e5f 6669  _data = self._fi
+00023a40: 745f 7265 7375 6c74 735b 7374 6f72 6167  t_results[storag
+00023a50: 655f 6b65 795d 5b6d 6f64 656c 5d0a 2020  e_key][model].  
+00023a60: 2020 2020 2020 7072 6f63 5f64 6174 6120        proc_data 
+00023a70: 3d20 7b7d 2020 2320 5768 6572 6520 7468  = {}  # Where th
+00023a80: 6520 6f75 7470 7574 2077 696c 6c20 6976  e output will iv
+00023a90: 650a 2020 2020 2020 2020 666f 7220 705f  e.        for p_
+00023aa0: 6b65 7920 696e 2066 6974 5f64 6174 613a  key in fit_data:
+00023ab0: 0a20 2020 2020 2020 2020 2020 2023 2055  .            # U
+00023ac0: 7365 6420 746f 2073 6861 7065 2074 6865  sed to shape the
+00023ad0: 206e 756d 7079 2061 7272 6179 2074 6865   numpy array the
+00023ae0: 2064 6174 6120 6973 2074 7261 6e73 6665   data is transfe
+00023af0: 7272 6564 2069 6e74 6f0a 2020 2020 2020  rred into.      
+00023b00: 2020 2020 2020 6e75 6d5f 656e 7472 6965        num_entrie
+00023b10: 7320 3d20 6c65 6e28 6669 745f 6461 7461  s = len(fit_data
+00023b20: 5b70 5f6b 6579 5d29 0a20 2020 2020 2020  [p_key]).       
+00023b30: 2020 2020 2023 2027 456d 7074 7927 206e       # 'Empty' n
+00023b40: 6577 2061 7272 6179 2074 6f20 7772 6974  ew array to writ
+00023b50: 6520 6f75 7420 7468 6520 7265 7375 6c74  e out the result
+00023b60: 7320 696e 746f 2c20 646f 6e65 206c 696b  s into, done lik
+00023b70: 6520 7468 6973 2062 6563 6175 7365 2072  e this because r
+00023b80: 6573 756c 7473 2061 7265 2073 746f 7265  esults are store
+00023b90: 640a 2020 2020 2020 2020 2020 2020 2320  d.            # 
+00023ba0: 2069 6e20 6e65 7374 6564 2064 6963 7469   in nested dicti
+00023bb0: 6f6e 6172 6965 7320 7769 7468 2074 6865  onaries with the
+00023bc0: 6972 2058 5350 4543 2070 6172 616d 6574  ir XSPEC paramet
+00023bd0: 6572 206e 756d 6265 7220 6173 2061 6e20  er number as an 
+00023be0: 6578 7472 6120 6b65 790a 2020 2020 2020  extra key.      
+00023bf0: 2020 2020 2020 6e65 775f 6461 7461 203d        new_data =
+00023c00: 206e 702e 7a65 726f 7328 286e 756d 5f65   np.zeros((num_e
+00023c10: 6e74 7269 6573 2c20 3329 290a 0a20 2020  ntries, 3))..   
+00023c20: 2020 2020 2020 2020 2023 2049 6620 6120           # If a 
+00023c30: 7061 7261 6d65 7465 7220 6973 2075 6e6c  parameter is unl
+00023c40: 696e 6b65 6420 696e 2061 2066 6974 2077  inked in a fit w
+00023c50: 6974 6820 6d75 6c74 6970 6c65 2073 7065  ith multiple spe
+00023c60: 6374 7261 2028 6c69 6b65 206e 6f72 6d61  ctra (like norma
+00023c70: 6c69 7361 7469 6f6e 2066 6f72 2069 6e73  lisation for ins
+00023c80: 7461 6e63 6529 2c0a 2020 2020 2020 2020  tance),.        
+00023c90: 2020 2020 2320 2074 6865 7265 2063 616e      #  there can
+00023ca0: 2062 6520 4e20 656e 7472 6965 7320 666f   be N entries fo
+00023cb0: 7220 7468 6520 7361 6d65 2070 6172 616d  r the same param
+00023cc0: 6574 6572 2c20 7772 6974 696e 6720 7468  eter, writing th
+00023cd0: 656d 206f 7574 2069 6e20 6f72 6465 7220  em out in order 
+00023ce0: 746f 2061 206e 756d 7079 2061 7272 6179  to a numpy array
+00023cf0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+00023d00: 2069 6e63 722c 2070 6172 5f69 6e64 6578   incr, par_index
+00023d10: 2069 6e20 656e 756d 6572 6174 6528 6669   in enumerate(fi
+00023d20: 745f 6461 7461 5b70 5f6b 6579 5d29 3a0a  t_data[p_key]):.
+00023d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023d40: 6e65 775f 6461 7461 5b69 6e63 722c 203a  new_data[incr, :
+00023d50: 5d20 3d20 6669 745f 6461 7461 5b70 5f6b  ] = fit_data[p_k
+00023d60: 6579 5d5b 7061 725f 696e 6465 785d 0a0a  ey][par_index]..
+00023d70: 2020 2020 2020 2020 2020 2020 2320 4a75              # Ju
+00023d80: 7374 206d 616b 6573 2074 6865 206f 7574  st makes the out
+00023d90: 7075 7420 6120 6c69 7474 6c65 206e 6963  put a little nic
+00023da0: 6572 2069 6620 7468 6572 6520 6973 206f  er if there is o
+00023db0: 6e6c 7920 6f6e 6520 656e 7472 790a 2020  nly one entry.  
+00023dc0: 2020 2020 2020 2020 2020 6966 206e 6577            if new
+00023dd0: 5f64 6174 612e 7368 6170 655b 305d 203d  _data.shape[0] =
+00023de0: 3d20 313a 0a20 2020 2020 2020 2020 2020  = 1:.           
+00023df0: 2020 2020 2070 726f 635f 6461 7461 5b70       proc_data[p
+00023e00: 5f6b 6579 5d20 3d20 6e65 775f 6461 7461  _key] = new_data
+00023e10: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
+00023e20: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00023e30: 2020 2020 2020 7072 6f63 5f64 6174 615b        proc_data[
+00023e40: 705f 6b65 795d 203d 206e 6577 5f64 6174  p_key] = new_dat
+00023e50: 610a 0a20 2020 2020 2020 2023 2049 6620  a..        # If 
+00023e60: 6e6f 2073 7065 6369 6669 6320 7061 7261  no specific para
+00023e70: 6d65 7465 7220 7761 7320 7265 7175 6573  meter was reques
+00023e80: 7465 642c 2074 6865 2075 7365 7220 6765  ted, the user ge
+00023e90: 7473 2061 6c6c 206f 6620 7468 656d 0a20  ts all of them. 
+00023ea0: 2020 2020 2020 2069 6620 7061 7220 6973         if par is
+00023eb0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00023ec0: 2020 2072 6574 7572 6e20 7072 6f63 5f64     return proc_d
+00023ed0: 6174 610a 2020 2020 2020 2020 656c 7365  ata.        else
+00023ee0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00023ef0: 7475 726e 2070 726f 635f 6461 7461 5b70  turn proc_data[p
+00023f00: 6172 5d0a 0a20 2020 2064 6566 2067 6574  ar]..    def get
+00023f10: 5f6c 756d 696e 6f73 6974 6965 7328 7365  _luminosities(se
+00023f20: 6c66 2c20 6f75 7465 725f 7261 6469 7573  lf, outer_radius
+00023f30: 3a20 556e 696f 6e5b 7374 722c 2051 7561  : Union[str, Qua
+00023f40: 6e74 6974 795d 2c20 6d6f 6465 6c3a 2073  ntity], model: s
+00023f50: 7472 2c0a 2020 2020 2020 2020 2020 2020  tr,.            
+00023f60: 2020 2020 2020 2020 2020 2020 2069 6e6e               inn
+00023f70: 6572 5f72 6164 6975 733a 2055 6e69 6f6e  er_radius: Union
+00023f80: 5b73 7472 2c20 5175 616e 7469 7479 5d20  [str, Quantity] 
+00023f90: 3d20 5175 616e 7469 7479 2830 2c20 2761  = Quantity(0, 'a
+00023fa0: 7263 7365 6327 292c 206c 6f5f 656e 3a20  rcsec'), lo_en: 
+00023fb0: 5175 616e 7469 7479 203d 204e 6f6e 652c  Quantity = None,
+00023fc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023fd0: 2020 2020 2020 2020 2020 6869 5f65 6e3a            hi_en:
+00023fe0: 2051 7561 6e74 6974 7920 3d20 4e6f 6e65   Quantity = None
+00023ff0: 2c20 6772 6f75 705f 7370 6563 3a20 626f  , group_spec: bo
+00024000: 6f6c 203d 2054 7275 652c 206d 696e 5f63  ol = True, min_c
+00024010: 6f75 6e74 733a 2069 6e74 203d 2035 2c20  ounts: int = 5, 
+00024020: 6d69 6e5f 736e 3a20 666c 6f61 7420 3d20  min_sn: float = 
+00024030: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+00024040: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+00024050: 7665 725f 7361 6d70 6c65 3a20 666c 6f61  ver_sample: floa
+00024060: 7420 3d20 4e6f 6e65 293a 0a20 2020 2020  t = None):.     
+00024070: 2020 2022 2222 0a20 2020 2020 2020 2047     """.        G
+00024080: 6574 206d 6574 686f 6420 666f 7220 6c75  et method for lu
+00024090: 6d69 6e6f 7369 7469 6573 2063 616c 6375  minosities calcu
+000240a0: 6c61 7465 6420 6672 6f6d 206d 6f64 656c  lated from model
+000240b0: 2066 6974 7320 746f 2073 7065 6374 7261   fits to spectra
+000240c0: 2061 7373 6f63 6961 7465 6420 7769 7468   associated with
+000240d0: 2074 6869 7320 736f 7572 6365 2e0a 2020   this source..  
+000240e0: 2020 2020 2020 4569 7468 6572 2066 6f72        Either for
+000240f0: 2067 6976 656e 2065 6e65 7267 7920 6c69   given energy li
+00024100: 6d69 7473 2028 7468 6174 206d 7573 7420  mits (that must 
+00024110: 6861 7665 2062 6565 6e20 7370 6563 6966  have been specif
+00024120: 6965 6420 7768 656e 2074 6865 2066 6974  ied when the fit
+00024130: 2077 6173 2066 6972 7374 2070 6572 666f   was first perfo
+00024140: 726d 6564 292c 206f 720a 2020 2020 2020  rmed), or.      
+00024150: 2020 666f 7220 616c 6c20 6c75 6d69 6e6f    for all lumino
+00024160: 7369 7469 6573 2061 7373 6f63 6961 7465  sities associate
+00024170: 6420 7769 7468 2074 6861 7420 6d6f 6465  d with that mode
+00024180: 6c2e 204c 756d 696e 6f73 6974 6965 7320  l. Luminosities 
+00024190: 6172 6520 7265 7475 726e 6564 2061 7320  are returned as 
+000241a0: 6120 3320 636f 6c75 6d6e 206e 756d 7079  a 3 column numpy
+000241b0: 2061 7272 6179 3b0a 2020 2020 2020 2020   array;.        
+000241c0: 7468 6520 3074 6820 636f 6c75 6d6e 2069  the 0th column i
+000241d0: 7320 7468 6520 7661 6c75 652c 2074 6865  s the value, the
+000241e0: 2031 7374 2063 6f6c 756d 6e20 6973 2074   1st column is t
+000241f0: 6865 2065 7272 2d2c 2061 6e64 2074 6865  he err-, and the
+00024200: 2032 6e64 2069 7320 6572 722b 2e0a 0a20   2nd is err+... 
+00024210: 2020 2020 2020 203a 7061 7261 6d20 7374         :param st
+00024220: 722f 5175 616e 7469 7479 206f 7574 6572  r/Quantity outer
+00024230: 5f72 6164 6975 733a 2054 6865 206e 616d  _radius: The nam
+00024240: 6520 6f72 2076 616c 7565 206f 6620 7468  e or value of th
+00024250: 6520 6f75 7465 7220 7261 6469 7573 2074  e outer radius t
+00024260: 6861 7420 7761 7320 7573 6564 2066 6f72  hat was used for
+00024270: 2074 6865 2067 656e 6572 6174 696f 6e20   the generation 
+00024280: 6f66 0a20 2020 2020 2020 2020 2020 2074  of.            t
+00024290: 6865 2073 7065 6374 7261 2077 6869 6368  he spectra which
+000242a0: 2077 6572 6520 6669 7474 6564 2074 6f20   were fitted to 
+000242b0: 7072 6f64 7563 6520 7468 6520 6465 7369  produce the desi
+000242c0: 7265 6420 7265 7375 6c74 2028 666f 7220  red result (for 
+000242d0: 696e 7374 616e 6365 2027 7232 3030 2720  instance 'r200' 
+000242e0: 776f 756c 6420 6265 2061 6363 6570 7461  would be accepta
+000242f0: 626c 650a 2020 2020 2020 2020 2020 2020  ble.            
+00024300: 666f 7220 6120 4761 6c61 7879 436c 7573  for a GalaxyClus
+00024310: 7465 722c 206f 7220 5175 616e 7469 7479  ter, or Quantity
+00024320: 2831 3030 302c 2027 6b70 6327 2929 2e20  (1000, 'kpc')). 
+00024330: 4966 2027 7265 6769 6f6e 2720 6973 2063  If 'region' is c
+00024340: 686f 7365 6e20 2874 6f20 7573 6520 7468  hosen (to use th
+00024350: 6520 7265 6769 6f6e 7320 696e 0a20 2020  e regions in.   
+00024360: 2020 2020 2020 2020 2072 6567 696f 6e20           region 
+00024370: 6669 6c65 7329 2c20 7468 656e 2061 6e79  files), then any
+00024380: 2069 6e6e 6572 2072 6164 6975 7320 7769   inner radius wi
+00024390: 6c6c 2062 6520 6967 6e6f 7265 642e 0a20  ll be ignored.. 
+000243a0: 2020 2020 2020 203a 7061 7261 6d20 7374         :param st
+000243b0: 7220 6d6f 6465 6c3a 2054 6865 206e 616d  r model: The nam
+000243c0: 6520 6f66 2074 6865 2066 6974 7465 6420  e of the fitted 
+000243d0: 6d6f 6465 6c20 7468 6174 2079 6f75 2772  model that you'r
+000243e0: 6520 7265 7175 6573 7469 6e67 2074 6865  e requesting the
+000243f0: 206c 756d 696e 6f73 6974 6965 730a 2020   luminosities.  
+00024400: 2020 2020 2020 2020 2020 6672 6f6d 2028            from (
+00024410: 652e 672e 2063 6f6e 7374 616e 742a 7462  e.g. constant*tb
+00024420: 6162 732a 6170 6563 292e 0a20 2020 2020  abs*apec)..     
+00024430: 2020 203a 7061 7261 6d20 7374 722f 5175     :param str/Qu
+00024440: 616e 7469 7479 2069 6e6e 6572 5f72 6164  antity inner_rad
+00024450: 6975 733a 2054 6865 206e 616d 6520 6f72  ius: The name or
+00024460: 2076 616c 7565 206f 6620 7468 6520 696e   value of the in
+00024470: 6e65 7220 7261 6469 7573 2074 6861 7420  ner radius that 
+00024480: 7761 7320 7573 6564 2066 6f72 2074 6865  was used for the
+00024490: 2067 656e 6572 6174 696f 6e20 6f66 0a20   generation of. 
+000244a0: 2020 2020 2020 2020 2020 2074 6865 2073             the s
+000244b0: 7065 6374 7261 2077 6869 6368 2077 6572  pectra which wer
+000244c0: 6520 6669 7474 6564 2074 6f20 7072 6f64  e fitted to prod
+000244d0: 7563 6520 7468 6520 6465 7369 7265 6420  uce the desired 
+000244e0: 7265 7375 6c74 2028 666f 7220 696e 7374  result (for inst
+000244f0: 616e 6365 2027 7235 3030 2720 776f 756c  ance 'r500' woul
+00024500: 6420 6265 2061 6363 6570 7461 626c 650a  d be acceptable.
+00024510: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00024520: 6120 4761 6c61 7879 436c 7573 7465 722c  a GalaxyCluster,
+00024530: 206f 7220 5175 616e 7469 7479 2833 3030   or Quantity(300
+00024540: 2c20 276b 7063 2729 292e 2042 7920 6465  , 'kpc')). By de
+00024550: 6661 756c 7420 7468 6973 2069 7320 7a65  fault this is ze
+00024560: 726f 2061 7263 7365 636f 6e64 732c 2072  ro arcseconds, r
+00024570: 6573 756c 7469 6e67 2069 6e20 610a 2020  esulting in a.  
+00024580: 2020 2020 2020 2020 2020 6369 7263 756c            circul
+00024590: 6172 2073 7065 6374 7275 6d2e 0a20 2020  ar spectrum..   
+000245a0: 2020 2020 203a 7061 7261 6d20 5175 616e       :param Quan
+000245b0: 7469 7479 206c 6f5f 656e 3a20 5468 6520  tity lo_en: The 
+000245c0: 6c6f 7765 7220 656e 6572 6779 206c 696d  lower energy lim
+000245d0: 6974 2066 6f72 2074 6865 2064 6573 6972  it for the desir
+000245e0: 6564 206c 756d 696e 6f73 6974 7920 6d65  ed luminosity me
+000245f0: 6173 7572 656d 656e 742e 0a20 2020 2020  asurement..     
+00024600: 2020 203a 7061 7261 6d20 5175 616e 7469     :param Quanti
+00024610: 7479 2068 695f 656e 3a20 5468 6520 7570  ty hi_en: The up
+00024620: 7065 7220 656e 6572 6779 206c 696d 6974  per energy limit
+00024630: 2066 6f72 2074 6865 2064 6573 6972 6564   for the desired
+00024640: 206c 756d 696e 6f73 6974 7920 6d65 6173   luminosity meas
+00024650: 7572 656d 656e 742e 0a20 2020 2020 2020  urement..       
+00024660: 203a 7061 7261 6d20 626f 6f6c 2067 726f   :param bool gro
+00024670: 7570 5f73 7065 633a 2057 6865 7468 6572  up_spec: Whether
+00024680: 2074 6865 2073 7065 6374 7261 2074 6861   the spectra tha
+00024690: 7420 7765 7265 2066 6974 7465 6420 666f  t were fitted fo
+000246a0: 7220 7468 6520 6465 7369 7265 6420 7265  r the desired re
+000246b0: 7375 6c74 2077 6572 6520 6772 6f75 7065  sult were groupe
+000246c0: 642e 0a20 2020 2020 2020 203a 7061 7261  d..        :para
+000246d0: 6d20 666c 6f61 7420 6d69 6e5f 636f 756e  m float min_coun
+000246e0: 7473 3a20 5468 6520 6d69 6e69 6d75 6d20  ts: The minimum 
+000246f0: 636f 756e 7473 2070 6572 2063 6861 6e6e  counts per chann
+00024700: 656c 2c20 6966 2074 6865 2073 7065 6374  el, if the spect
+00024710: 7261 2074 6861 7420 7765 7265 2066 6974  ra that were fit
+00024720: 7465 6420 666f 7220 7468 650a 2020 2020  ted for the.    
+00024730: 2020 2020 2020 2020 6465 7369 7265 6420          desired 
+00024740: 7265 7375 6c74 2077 6572 6520 6772 6f75  result were grou
+00024750: 7065 6420 6279 206d 696e 696d 756d 2063  ped by minimum c
+00024760: 6f75 6e74 732e 0a20 2020 2020 2020 203a  ounts..        :
+00024770: 7061 7261 6d20 666c 6f61 7420 6d69 6e5f  param float min_
+00024780: 736e 3a20 5468 6520 6d69 6e69 6d75 6d20  sn: The minimum 
+00024790: 7369 676e 616c 2074 6f20 6e6f 6973 6520  signal to noise 
+000247a0: 7065 7220 6368 616e 6e65 6c2c 2069 6620  per channel, if 
+000247b0: 7468 6520 7370 6563 7472 6120 7468 6174  the spectra that
+000247c0: 2077 6572 6520 6669 7474 6564 2066 6f72   were fitted for
+000247d0: 2074 6865 0a20 2020 2020 2020 2020 2020   the.           
+000247e0: 2064 6573 6972 6564 2072 6573 756c 7420   desired result 
+000247f0: 7765 7265 2067 726f 7570 6564 2062 7920  were grouped by 
+00024800: 6d69 6e69 6d75 6d20 7369 676e 616c 2074  minimum signal t
+00024810: 6f20 6e6f 6973 652e 0a20 2020 2020 2020  o noise..       
+00024820: 203a 7061 7261 6d20 666c 6f61 7420 6f76   :param float ov
+00024830: 6572 5f73 616d 706c 653a 2054 6865 206c  er_sample: The l
+00024840: 6576 656c 206f 6620 6f76 6572 7361 6d70  evel of oversamp
+00024850: 6c69 6e67 2061 7070 6c69 6564 206f 6e20  ling applied on 
+00024860: 7468 6520 7370 6563 7472 6120 7468 6174  the spectra that
+00024870: 2077 6572 6520 6669 7474 6564 2e0a 2020   were fitted..  
+00024880: 2020 2020 2020 3a72 6574 7572 6e3a 2054        :return: T
+00024890: 6865 2072 6571 7565 7374 6564 206c 756d  he requested lum
+000248a0: 696e 6f73 6974 7920 7661 6c75 652c 2061  inosity value, a
+000248b0: 6e64 2075 6e63 6572 7461 696e 7469 6573  nd uncertainties
+000248c0: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+000248d0: 2020 2020 2020 2320 4669 7273 7420 4920        # First I 
+000248e0: 7761 6e74 2074 6f20 7265 7472 6965 7665  want to retrieve
+000248f0: 2074 6865 2073 7065 6374 7261 2074 6861   the spectra tha
+00024900: 7420 7765 7265 2066 6974 7465 6420 746f  t were fitted to
+00024910: 2070 726f 6475 6365 2074 6865 2072 6573   produce the res
+00024920: 756c 7420 7468 6579 2772 6520 6c6f 6f6b  ult they're look
+00024930: 696e 6720 666f 722c 0a20 2020 2020 2020  ing for,.       
+00024940: 2023 2020 6265 6361 7573 6520 7468 656e   #  because then
+00024950: 2049 2063 616e 206a 7573 7420 6772 6162   I can just grab
+00024960: 2074 6865 2073 746f 7261 6765 206b 6579   the storage key
+00024970: 2066 726f 6d20 6f6e 6520 6f66 2074 6865   from one of the
+00024980: 6d0a 2020 2020 2020 2020 7370 6563 7320  m.        specs 
+00024990: 3d20 7365 6c66 2e67 6574 5f73 7065 6374  = self.get_spect
+000249a0: 7261 286f 7574 6572 5f72 6164 6975 732c  ra(outer_radius,
+000249b0: 204e 6f6e 652c 204e 6f6e 652c 2069 6e6e   None, None, inn
+000249c0: 6572 5f72 6164 6975 732c 2067 726f 7570  er_radius, group
+000249d0: 5f73 7065 632c 206d 696e 5f63 6f75 6e74  _spec, min_count
+000249e0: 732c 206d 696e 5f73 6e2c 206f 7665 725f  s, min_sn, over_
+000249f0: 7361 6d70 6c65 290a 2020 2020 2020 2020  sample).        
+00024a00: 2320 4920 6a75 7374 2074 616b 6520 7468  # I just take th
+00024a10: 6520 6669 7273 7420 7370 6563 7472 756d  e first spectrum
+00024a20: 2069 6e20 7468 6520 6c69 7374 2062 6563   in the list bec
+00024a30: 6175 7365 2074 6865 2073 746f 7261 6765  ause the storage
+00024a40: 206b 6579 2077 696c 6c20 6265 2074 6865   key will be the
+00024a50: 2073 616d 6520 666f 7220 616c 6c20 6f66   same for all of
+00024a60: 2074 6865 6d0a 2020 2020 2020 2020 6966   them.        if
+00024a70: 2069 7369 6e73 7461 6e63 6528 7370 6563   isinstance(spec
+00024a80: 732c 206c 6973 7429 3a0a 2020 2020 2020  s, list):.      
+00024a90: 2020 2020 2020 7374 6f72 6167 655f 6b65        storage_ke
+00024aa0: 7920 3d20 7370 6563 735b 305d 2e73 746f  y = specs[0].sto
+00024ab0: 7261 6765 5f6b 6579 0a20 2020 2020 2020  rage_key.       
+00024ac0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00024ad0: 2020 2073 746f 7261 6765 5f6b 6579 203d     storage_key =
+00024ae0: 2073 7065 6373 2e73 746f 7261 6765 5f6b   specs.storage_k
+00024af0: 6579 0a0a 2020 2020 2020 2020 2320 4368  ey..        # Ch
+00024b00: 6563 6b69 6e67 2074 6865 2069 6e70 7574  ecking the input
+00024b10: 2065 6e65 7267 7920 6c69 6d69 7473 2061   energy limits a
+00024b20: 7265 2076 616c 6964 2c20 616e 6420 6173  re valid, and as
+00024b30: 7365 6d62 6c65 7320 7468 6520 6b65 7920  sembles the key 
+00024b40: 746f 206c 6f6f 6b20 666f 7220 6c75 6d73  to look for lums
+00024b50: 2069 6e20 7468 6f73 6520 656e 6572 6779   in those energy
+00024b60: 0a20 2020 2020 2020 2023 2020 626f 756e  .        #  boun
+00024b70: 6473 2e20 4966 2074 6865 206c 696d 6974  ds. If the limit
+00024b80: 7320 6172 6520 6e6f 6e65 2074 6865 6e20  s are none then 
+00024b90: 736f 2069 7320 7468 6520 656e 6572 6779  so is the energy
+00024ba0: 206b 6579 0a20 2020 2020 2020 2069 6620   key.        if 
+00024bb0: 6c6f 5f65 6e20 6973 206e 6f74 204e 6f6e  lo_en is not Non
+00024bc0: 6520 616e 6420 6869 5f65 6e20 6973 206e  e and hi_en is n
+00024bd0: 6f74 204e 6f6e 6520 616e 6420 6c6f 5f65  ot None and lo_e
+00024be0: 6e20 3e20 6869 5f65 6e3a 0a20 2020 2020  n > hi_en:.     
+00024bf0: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+00024c00: 7565 4572 726f 7228 2254 6865 206c 6f77  ueError("The low
+00024c10: 2065 6e65 7267 7920 6c69 6d69 7420 6361   energy limit ca
+00024c20: 6e6e 6f74 2062 6520 6772 6561 7465 7220  nnot be greater 
+00024c30: 7468 616e 2074 6865 2068 6967 6820 656e  than the high en
+00024c40: 6572 6779 206c 696d 6974 2229 0a20 2020  ergy limit").   
+00024c50: 2020 2020 2065 6c69 6620 6c6f 5f65 6e20       elif lo_en 
+00024c60: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
+00024c70: 6869 5f65 6e20 6973 206e 6f74 204e 6f6e  hi_en is not Non
+00024c80: 653a 0a20 2020 2020 2020 2020 2020 2065  e:.            e
+00024c90: 6e5f 6b65 7920 3d20 2262 6f75 6e64 5f7b  n_key = "bound_{
+00024ca0: 6c7d 2d7b 757d 222e 666f 726d 6174 286c  l}-{u}".format(l
+00024cb0: 3d6c 6f5f 656e 2e74 6f28 226b 6556 2229  =lo_en.to("keV")
+00024cc0: 2e76 616c 7565 2c20 753d 6869 5f65 6e2e  .value, u=hi_en.
+00024cd0: 746f 2822 6b65 5622 292e 7661 6c75 6529  to("keV").value)
+00024ce0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00024cf0: 2020 2020 2020 2020 2020 2065 6e5f 6b65             en_ke
+00024d00: 7920 3d20 4e6f 6e65 0a0a 2020 2020 2020  y = None..      
+00024d10: 2020 2320 4368 6563 6b73 2074 6861 7420    # Checks that 
+00024d20: 7468 6520 7265 7175 6573 7465 6420 7265  the requested re
+00024d30: 6769 6f6e 2c20 6d6f 6465 6c20 616e 6420  gion, model and 
+00024d40: 656e 6572 6779 2062 616e 6420 6163 7475  energy band actu
+00024d50: 616c 6c79 2065 7869 7374 0a20 2020 2020  ally exist.     
+00024d60: 2020 2069 6620 6c65 6e28 7365 6c66 2e5f     if len(self._
+00024d70: 6c75 6d69 6e6f 7369 7469 6573 2920 3d3d  luminosities) ==
+00024d80: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+00024d90: 7261 6973 6520 4d6f 6465 6c4e 6f74 4173  raise ModelNotAs
+00024da0: 736f 6369 6174 6564 4572 726f 7228 2254  sociatedError("T
+00024db0: 6865 7265 2061 7265 206e 6f20 5853 5045  here are no XSPE
+00024dc0: 4320 6669 7473 2061 7373 6f63 6961 7465  C fits associate
+00024dd0: 6420 7769 7468 207b 737d 222e 666f 726d  d with {s}".form
+00024de0: 6174 2873 3d73 656c 662e 6e61 6d65 2929  at(s=self.name))
+00024df0: 0a20 2020 2020 2020 2065 6c69 6620 7374  .        elif st
+00024e00: 6f72 6167 655f 6b65 7920 6e6f 7420 696e  orage_key not in
+00024e10: 2073 656c 662e 5f6c 756d 696e 6f73 6974   self._luminosit
+00024e20: 6965 733a 0a20 2020 2020 2020 2020 2020  ies:.           
+00024e30: 2072 6169 7365 204d 6f64 656c 4e6f 7441   raise ModelNotA
+00024e40: 7373 6f63 6961 7465 6445 7272 6f72 2822  ssociatedError("
+00024e50: 5468 6573 6520 7370 6563 7472 6120 6861  These spectra ha
+00024e60: 7665 206e 6f20 6173 736f 6369 6174 6564  ve no associated
+00024e70: 2058 5350 4543 2066 6974 2074 6f20 7b73   XSPEC fit to {s
+00024e80: 7d2e 222e 666f 726d 6174 2873 3d73 656c  }.".format(s=sel
+00024e90: 662e 6e61 6d65 2929 0a20 2020 2020 2020  f.name)).       
+00024ea0: 2065 6c69 6620 6d6f 6465 6c20 6e6f 7420   elif model not 
+00024eb0: 696e 2073 656c 662e 5f6c 756d 696e 6f73  in self._luminos
+00024ec0: 6974 6965 735b 7374 6f72 6167 655f 6b65  ities[storage_ke
+00024ed0: 795d 3a0a 2020 2020 2020 2020 2020 2020  y]:.            
+00024ee0: 6176 5f6d 6f64 7320 3d20 222c 2022 2e6a  av_mods = ", ".j
+00024ef0: 6f69 6e28 7365 6c66 2e5f 6c75 6d69 6e6f  oin(self._lumino
+00024f00: 7369 7469 6573 5b73 746f 7261 6765 5f6b  sities[storage_k
+00024f10: 6579 5d2e 6b65 7973 2829 290a 2020 2020  ey].keys()).    
+00024f20: 2020 2020 2020 2020 7261 6973 6520 4d6f          raise Mo
+00024f30: 6465 6c4e 6f74 4173 736f 6369 6174 6564  delNotAssociated
+00024f40: 4572 726f 7228 227b 6d7d 2068 6173 206e  Error("{m} has n
+00024f50: 6f74 2062 6565 6e20 6669 7474 6564 2074  ot been fitted t
+00024f60: 6f20 7468 6573 6520 7370 6563 7472 6120  o these spectra 
+00024f70: 6f66 207b 737d 3b20 220a 2020 2020 2020  of {s}; ".      
+00024f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024fa0: 2020 2020 2261 7661 696c 6162 6c65 206d      "available m
+00024fb0: 6f64 656c 7320 6172 6520 7b61 7d22 2e66  odels are {a}".f
+00024fc0: 6f72 6d61 7428 6d3d 6d6f 6465 6c2c 2073  ormat(m=model, s
+00024fd0: 3d73 656c 662e 6e61 6d65 2c20 613d 6176  =self.name, a=av
+00024fe0: 5f6d 6f64 7329 290a 2020 2020 2020 2020  _mods)).        
+00024ff0: 656c 6966 2065 6e5f 6b65 7920 6973 206e  elif en_key is n
+00025000: 6f74 204e 6f6e 6520 616e 6420 656e 5f6b  ot None and en_k
+00025010: 6579 206e 6f74 2069 6e20 7365 6c66 2e5f  ey not in self._
+00025020: 6c75 6d69 6e6f 7369 7469 6573 5b73 746f  luminosities[sto
+00025030: 7261 6765 5f6b 6579 5d5b 6d6f 6465 6c5d  rage_key][model]
+00025040: 3a0a 2020 2020 2020 2020 2020 2020 6176  :.            av
+00025050: 5f62 616e 6473 203d 2022 2c20 222e 6a6f  _bands = ", ".jo
+00025060: 696e 285b 656e 2e73 706c 6974 2822 5f22  in([en.split("_"
+00025070: 295b 2d31 5d20 2b20 226b 6556 2220 666f  )[-1] + "keV" fo
+00025080: 7220 656e 2069 6e20 7365 6c66 2e5f 6c75  r en in self._lu
+00025090: 6d69 6e6f 7369 7469 6573 5b73 746f 7261  minosities[stora
+000250a0: 6765 5f6b 6579 5d5b 6d6f 6465 6c5d 2e6b  ge_key][model].k
+000250b0: 6579 7328 295d 290a 2020 2020 2020 2020  eys()]).        
+000250c0: 2020 2020 7261 6973 6520 5061 7261 6d65      raise Parame
+000250d0: 7465 724e 6f74 4173 736f 6369 6174 6564  terNotAssociated
+000250e0: 4572 726f 7228 227b 6c7d 2d7b 757d 6b65  Error("{l}-{u}ke
+000250f0: 5620 7761 7320 6e6f 7420 616e 2065 6e65  V was not an ene
+00025100: 7267 7920 6261 6e64 2066 6f72 2074 6865  rgy band for the
+00025110: 2066 6974 2077 6974 6820 7b6d 7d3b 2061   fit with {m}; a
+00025120: 7661 696c 6162 6c65 2022 0a20 2020 2020  vailable ".     
+00025130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025150: 2020 2020 2020 2020 2022 656e 6572 6779           "energy
+00025160: 2062 616e 6473 2061 7265 207b 627d 222e   bands are {b}".
+00025170: 666f 726d 6174 286c 3d6c 6f5f 656e 2e74  format(l=lo_en.t
+00025180: 6f28 226b 6556 2229 2e76 616c 7565 2c0a  o("keV").value,.
+00025190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000251a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000251b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000251c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000251d0: 2020 2020 2020 2020 2020 2020 753d 6869              u=hi
+000251e0: 5f65 6e2e 746f 2822 6b65 5622 292e 7661  _en.to("keV").va
+000251f0: 6c75 652c 0a20 2020 2020 2020 2020 2020  lue,.           
+00025200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025240: 206d 3d6d 6f64 656c 2c20 623d 6176 5f62   m=model, b=av_b
+00025250: 616e 6473 2929 0a0a 2020 2020 2020 2020  ands))..        
+00025260: 2320 4966 206e 6f20 6c69 6d69 7473 2073  # If no limits s
+00025270: 7065 6369 6669 6564 2c74 6865 2075 7365  pecified,the use
+00025280: 7220 6765 7473 2061 6c6c 2074 6865 206c  r gets all the l
+00025290: 756d 696e 6f73 6974 6965 732c 206f 7468  uminosities, oth
+000252a0: 6572 7769 7365 2074 6865 7920 6765 7420  erwise they get 
+000252b0: 7468 6520 6f6e 6520 7468 6579 2061 736b  the one they ask
+000252c0: 6564 2066 6f72 0a20 2020 2020 2020 2069  ed for.        i
+000252d0: 6620 656e 5f6b 6579 2069 7320 4e6f 6e65  f en_key is None
+000252e0: 3a0a 2020 2020 2020 2020 2020 2020 7061  :.            pa
+000252f0: 7273 6564 5f6c 756d 7320 3d20 7b7d 0a20  rsed_lums = {}. 
+00025300: 2020 2020 2020 2020 2020 2066 6f72 206c             for l
+00025310: 756d 5f6b 6579 2069 6e20 7365 6c66 2e5f  um_key in self._
+00025320: 6c75 6d69 6e6f 7369 7469 6573 5b73 746f  luminosities[sto
+00025330: 7261 6765 5f6b 6579 5d5b 6d6f 6465 6c5d  rage_key][model]
+00025340: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00025350: 2020 6c75 6d5f 7661 6c75 6520 3d20 7365    lum_value = se
+00025360: 6c66 2e5f 6c75 6d69 6e6f 7369 7469 6573  lf._luminosities
+00025370: 5b73 746f 7261 6765 5f6b 6579 5d5b 6d6f  [storage_key][mo
+00025380: 6465 6c5d 5b6c 756d 5f6b 6579 5d0a 2020  del][lum_key].  
+00025390: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+000253a0: 7273 6564 5f6c 756d 203d 2051 7561 6e74  rsed_lum = Quant
+000253b0: 6974 7928 5b6c 756d 2e76 616c 7565 2066  ity([lum.value f
+000253c0: 6f72 206c 756d 2069 6e20 6c75 6d5f 7661  or lum in lum_va
+000253d0: 6c75 655d 2c20 6c75 6d5f 7661 6c75 655b  lue], lum_value[
+000253e0: 305d 2e75 6e69 7429 0a20 2020 2020 2020  0].unit).       
+000253f0: 2020 2020 2020 2020 2070 6172 7365 645f           parsed_
+00025400: 6c75 6d73 5b6c 756d 5f6b 6579 5d20 3d20  lums[lum_key] = 
+00025410: 7061 7273 6564 5f6c 756d 0a20 2020 2020  parsed_lum.     
+00025420: 2020 2020 2020 2072 6574 7572 6e20 7061         return pa
+00025430: 7273 6564 5f6c 756d 730a 2020 2020 2020  rsed_lums.      
+00025440: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00025450: 2020 2020 6c75 6d5f 7661 6c75 6520 3d20      lum_value = 
+00025460: 7365 6c66 2e5f 6c75 6d69 6e6f 7369 7469  self._luminositi
+00025470: 6573 5b73 746f 7261 6765 5f6b 6579 5d5b  es[storage_key][
+00025480: 6d6f 6465 6c5d 5b65 6e5f 6b65 795d 0a20  model][en_key]. 
+00025490: 2020 2020 2020 2020 2020 2070 6172 7365             parse
+000254a0: 645f 6c75 6d20 3d20 5175 616e 7469 7479  d_lum = Quantity
+000254b0: 285b 6c75 6d2e 7661 6c75 6520 666f 7220  ([lum.value for 
+000254c0: 6c75 6d20 696e 206c 756d 5f76 616c 7565  lum in lum_value
+000254d0: 5d2c 206c 756d 5f76 616c 7565 5b30 5d2e  ], lum_value[0].
+000254e0: 756e 6974 290a 2020 2020 2020 2020 2020  unit).          
+000254f0: 2020 7265 7475 726e 2070 6172 7365 645f    return parsed_
+00025500: 6c75 6d0a 0a20 2020 2064 6566 2063 6f6e  lum..    def con
+00025510: 7665 7274 5f72 6164 6975 7328 7365 6c66  vert_radius(self
+00025520: 2c20 7261 6469 7573 3a20 5175 616e 7469  , radius: Quanti
+00025530: 7479 2c20 6f75 745f 756e 6974 3a20 556e  ty, out_unit: Un
+00025540: 696f 6e5b 556e 6974 2c20 7374 725d 203d  ion[Unit, str] =
+00025550: 2027 6465 6727 2920 2d3e 2051 7561 6e74   'deg') -> Quant
+00025560: 6974 793a 0a20 2020 2020 2020 2022 2222  ity:.        """
+00025570: 0a20 2020 2020 2020 2041 2073 696d 706c  .        A simpl
+00025580: 6520 6d65 7468 6f64 2074 6f20 636f 6e76  e method to conv
+00025590: 6572 7420 7261 6469 6920 6265 7477 6565  ert radii betwee
+000255a0: 6e20 6469 6666 6572 656e 7420 6469 7374  n different dist
+000255b0: 616e 6365 2075 6e69 7473 2c20 6974 2061  ance units, it a
+000255c0: 7574 6f6d 6174 6963 616c 6c79 2063 6865  utomatically che
+000255d0: 636b 7320 7768 6574 6865 720a 2020 2020  cks whether.    
+000255e0: 2020 2020 7468 6520 7265 7175 6573 7465      the requeste
+000255f0: 6420 636f 6e76 6572 7369 6f6e 2069 7320  d conversion is 
+00025600: 706f 7373 6962 6c65 2c20 6769 7665 6e20  possible, given 
+00025610: 6176 6169 6c61 626c 6520 696e 666f 726d  available inform
+00025620: 6174 696f 6e2e 2046 6f72 2069 6e73 7461  ation. For insta
+00025630: 6e63 6520 6974 2077 6f75 6c64 2066 6169  nce it would fai
+00025640: 6c20 6966 2079 6f75 0a20 2020 2020 2020  l if you.       
+00025650: 2072 6571 7565 7374 6564 2061 2063 6f6e   requested a con
+00025660: 7665 7273 696f 6e20 6672 6f6d 2061 7263  version from arc
+00025670: 7365 636f 6e64 7320 746f 2061 2070 726f  seconds to a pro
+00025680: 7065 7220 6469 7374 616e 6365 2069 6620  per distance if 
+00025690: 6e6f 2072 6564 7368 6966 7420 696e 666f  no redshift info
+000256a0: 726d 6174 696f 6e20 7765 7265 2061 7661  rmation were ava
+000256b0: 696c 6162 6c65 2e0a 0a20 2020 2020 2020  ilable...       
+000256c0: 203a 7061 7261 6d20 5175 616e 7469 7479   :param Quantity
+000256d0: 2072 6164 6975 733a 2054 6865 2072 6164   radius: The rad
+000256e0: 6975 7320 746f 2063 6f6e 7665 7274 2074  ius to convert t
+000256f0: 6f20 6120 6e65 7720 756e 6974 2e0a 2020  o a new unit..  
+00025700: 2020 2020 2020 3a70 6172 616d 2055 6e69        :param Uni
+00025710: 742f 7374 7220 6f75 745f 756e 6974 3a20  t/str out_unit: 
+00025720: 5468 6520 756e 6974 2074 6f20 636f 6e76  The unit to conv
+00025730: 6572 7420 7468 6520 696e 7075 7420 7261  ert the input ra
+00025740: 6469 7573 2074 6f2e 0a20 2020 2020 2020  dius to..       
+00025750: 203a 7265 7475 726e 3a20 5468 6520 636f   :return: The co
+00025760: 6e76 6572 7465 6420 7261 6469 7573 0a20  nverted radius. 
+00025770: 2020 2020 2020 203a 7274 7970 653a 2051         :rtype: Q
+00025780: 7561 6e74 6974 790a 2020 2020 2020 2020  uantity.        
+00025790: 2222 220a 2020 2020 2020 2020 2320 4966  """.        # If
+000257a0: 2061 2073 7472 696e 6720 7265 7072 6573   a string repres
+000257b0: 656e 7461 7469 6f6e 2077 6173 2070 6173  entation was pas
+000257c0: 7365 642c 2077 6520 6d61 6b65 2069 7420  sed, we make it 
+000257d0: 616e 2061 7374 726f 7079 2075 6e69 740a  an astropy unit.
+000257e0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+000257f0: 7461 6e63 6528 6f75 745f 756e 6974 2c20  tance(out_unit, 
+00025800: 7374 7229 3a0a 2020 2020 2020 2020 2020  str):.          
+00025810: 2020 6f75 745f 756e 6974 203d 2055 6e69    out_unit = Uni
+00025820: 7428 6f75 745f 756e 6974 290a 0a20 2020  t(out_unit)..   
+00025830: 2020 2020 2069 6620 6f75 745f 756e 6974       if out_unit
+00025840: 2e69 735f 6571 7569 7661 6c65 6e74 2827  .is_equivalent('
+00025850: 6b70 6327 2920 616e 6420 7365 6c66 2e5f  kpc') and self._
+00025860: 7265 6473 6869 6674 2069 7320 4e6f 6e65  redshift is None
+00025870: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+00025880: 6973 6520 556e 6974 436f 6e76 6572 7369  ise UnitConversi
+00025890: 6f6e 4572 726f 7228 2259 6f75 2063 616e  onError("You can
+000258a0: 6e6f 7420 636f 6e76 6572 7420 746f 2074  not convert to t
+000258b0: 6869 7320 756e 6974 2077 6974 686f 7574  his unit without
+000258c0: 2072 6564 7368 6966 7420 696e 666f 726d   redshift inform
+000258d0: 6174 696f 6e2e 2229 0a0a 2020 2020 2020  ation.")..      
+000258e0: 2020 6966 2072 6164 6975 732e 756e 6974    if radius.unit
+000258f0: 2e69 735f 6571 7569 7661 6c65 6e74 2827  .is_equivalent('
+00025900: 6465 6727 2920 616e 6420 6f75 745f 756e  deg') and out_un
+00025910: 6974 2e69 735f 6571 7569 7661 6c65 6e74  it.is_equivalent
+00025920: 2827 6465 6727 293a 0a20 2020 2020 2020  ('deg'):.       
+00025930: 2020 2020 206f 7574 5f72 6164 203d 2072       out_rad = r
+00025940: 6164 6975 732e 746f 286f 7574 5f75 6e69  adius.to(out_uni
+00025950: 7429 0a20 2020 2020 2020 2065 6c69 6620  t).        elif 
+00025960: 7261 6469 7573 2e75 6e69 742e 6973 5f65  radius.unit.is_e
+00025970: 7175 6976 616c 656e 7428 2764 6567 2729  quivalent('deg')
+00025980: 2061 6e64 206f 7574 5f75 6e69 742e 6973   and out_unit.is
+00025990: 5f65 7175 6976 616c 656e 7428 276b 7063  _equivalent('kpc
+000259a0: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
+000259b0: 6f75 745f 7261 6420 3d20 616e 675f 746f  out_rad = ang_to
+000259c0: 5f72 6164 2872 6164 6975 732c 2073 656c  _rad(radius, sel
+000259d0: 662e 5f72 6564 7368 6966 742c 2073 656c  f._redshift, sel
+000259e0: 662e 5f63 6f73 6d6f 292e 746f 286f 7574  f._cosmo).to(out
+000259f0: 5f75 6e69 7429 0a20 2020 2020 2020 2065  _unit).        e
+00025a00: 6c69 6620 7261 6469 7573 2e75 6e69 742e  lif radius.unit.
+00025a10: 6973 5f65 7175 6976 616c 656e 7428 276b  is_equivalent('k
+00025a20: 7063 2729 2061 6e64 206f 7574 5f75 6e69  pc') and out_uni
+00025a30: 742e 6973 5f65 7175 6976 616c 656e 7428  t.is_equivalent(
+00025a40: 276b 7063 2729 3a0a 2020 2020 2020 2020  'kpc'):.        
+00025a50: 2020 2020 6f75 745f 7261 6420 3d20 7261      out_rad = ra
+00025a60: 6469 7573 2e74 6f28 6f75 745f 756e 6974  dius.to(out_unit
+00025a70: 290a 2020 2020 2020 2020 656c 6966 2072  ).        elif r
+00025a80: 6164 6975 732e 756e 6974 2e69 735f 6571  adius.unit.is_eq
+00025a90: 7569 7661 6c65 6e74 2827 6b70 6327 2920  uivalent('kpc') 
+00025aa0: 616e 6420 6f75 745f 756e 6974 2e69 735f  and out_unit.is_
+00025ab0: 6571 7569 7661 6c65 6e74 2827 6465 6727  equivalent('deg'
+00025ac0: 293a 0a20 2020 2020 2020 2020 2020 206f  ):.            o
+00025ad0: 7574 5f72 6164 203d 2072 6164 5f74 6f5f  ut_rad = rad_to_
+00025ae0: 616e 6728 7261 6469 7573 2c20 7365 6c66  ang(radius, self
+00025af0: 2e5f 7265 6473 6869 6674 2c20 7365 6c66  ._redshift, self
+00025b00: 2e5f 636f 736d 6f29 2e74 6f28 6f75 745f  ._cosmo).to(out_
+00025b10: 756e 6974 290a 2020 2020 2020 2020 656c  unit).        el
+00025b20: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00025b30: 7261 6973 6520 556e 6974 436f 6e76 6572  raise UnitConver
+00025b40: 7369 6f6e 4572 726f 7228 2243 616e 6e6f  sionError("Canno
+00025b50: 7420 756e 6465 7273 7461 6e64 207b 7d20  t understand {} 
+00025b60: 6173 2061 2064 6973 7461 6e63 6520 756e  as a distance un
+00025b70: 6974 222e 666f 726d 6174 2873 7472 286f  it".format(str(o
+00025b80: 7574 5f75 6e69 7429 2929 0a0a 2020 2020  ut_unit)))..    
+00025b90: 2020 2020 7265 7475 726e 206f 7574 5f72      return out_r
+00025ba0: 6164 0a0a 2020 2020 6465 6620 6765 745f  ad..    def get_
+00025bb0: 7261 6469 7573 2873 656c 662c 2072 6164  radius(self, rad
+00025bc0: 5f6e 616d 653a 2073 7472 2c20 6f75 745f  _name: str, out_
+00025bd0: 756e 6974 3a20 556e 696f 6e5b 556e 6974  unit: Union[Unit
+00025be0: 2c20 7374 725d 203d 2027 6465 6727 2920  , str] = 'deg') 
+00025bf0: 2d3e 2051 7561 6e74 6974 793a 0a20 2020  -> Quantity:.   
+00025c00: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00025c10: 2041 6c6c 6f77 7320 6120 7261 6469 7573   Allows a radius
+00025c20: 2061 7373 6f63 6961 7465 6420 7769 7468   associated with
+00025c30: 2074 6869 7320 736f 7572 6365 2074 6f20   this source to 
+00025c40: 6265 2072 6574 7269 6576 6564 2069 6e20  be retrieved in 
+00025c50: 7370 6563 6966 6965 6420 6469 7374 616e  specified distan
+00025c60: 6365 2075 6e69 7473 2e20 4e6f 7465 0a20  ce units. Note. 
+00025c70: 2020 2020 2020 2074 6861 7420 7068 7973         that phys
+00025c80: 6963 616c 2064 6973 7461 6e63 6520 756e  ical distance un
+00025c90: 6974 7320 7375 6368 2061 7320 6b69 6c6f  its such as kilo
+00025ca0: 7061 7273 6563 7320 6d61 7920 6f6e 6c79  parsecs may only
+00025cb0: 2062 6520 7573 6564 2069 6620 7468 6520   be used if the 
+00025cc0: 736f 7572 6365 2068 6173 0a20 2020 2020  source has.     
+00025cd0: 2020 2072 6564 7368 6966 7420 696e 666f     redshift info
+00025ce0: 726d 6174 696f 6e2e 0a0a 2020 2020 2020  rmation...      
+00025cf0: 2020 3a70 6172 616d 2073 7472 2072 6164    :param str rad
+00025d00: 5f6e 616d 653a 2054 6865 206e 616d 6520  _name: The name 
+00025d10: 6f66 2074 6865 2064 6573 6972 6564 2072  of the desired r
+00025d20: 6164 6975 732c 2072 3230 3020 666f 7220  adius, r200 for 
+00025d30: 696e 7374 616e 6365 2e0a 2020 2020 2020  instance..      
+00025d40: 2020 3a70 6172 616d 2055 6e69 742f 7374    :param Unit/st
+00025d50: 7220 6f75 745f 756e 6974 3a20 416e 2061  r out_unit: An a
+00025d60: 7374 726f 7079 2075 6e69 742c 2065 6974  stropy unit, eit
+00025d70: 6865 7220 6120 556e 6974 2069 6e73 7461  her a Unit insta
+00025d80: 6e63 6520 6f72 2061 2073 7472 696e 670a  nce or a string.
+00025d90: 2020 2020 2020 2020 2020 2020 7265 7072              repr
+00025da0: 6573 656e 7461 7469 6f6e 2e20 4465 6661  esentation. Defa
+00025db0: 756c 7420 6973 2064 6567 7265 6573 2e0a  ult is degrees..
+00025dc0: 2020 2020 2020 2020 3a72 6574 7572 6e3a          :return:
+00025dd0: 2054 6865 2064 6573 6972 6564 2072 6164   The desired rad
+00025de0: 6975 7320 696e 2074 6865 2064 6573 6972  ius in the desir
+00025df0: 6564 2075 6e69 7473 2e0a 2020 2020 2020  ed units..      
+00025e00: 2020 3a72 7479 7065 3a20 5175 616e 7469    :rtype: Quanti
+00025e10: 7479 0a20 2020 2020 2020 2022 2222 0a0a  ty.        """..
+00025e20: 2020 2020 2020 2020 2320 496e 2063 6173          # In cas
+00025e30: 6520 736f 6d65 626f 6479 2074 7970 6573  e somebody types
+00025e40: 2069 6e20 5235 3030 2072 6174 6865 7220   in R500 rather 
+00025e50: 7468 616e 2072 3530 3020 666f 7220 696e  than r500 for in
+00025e60: 7374 616e 6365 2e0a 2020 2020 2020 2020  stance..        
+00025e70: 7261 645f 6e61 6d65 203d 2072 6164 5f6e  rad_name = rad_n
+00025e80: 616d 652e 6c6f 7765 7228 290a 2020 2020  ame.lower().    
+00025e90: 2020 2020 6966 2072 6164 5f6e 616d 6520      if rad_name 
+00025ea0: 6e6f 7420 696e 2073 656c 662e 5f72 6164  not in self._rad
+00025eb0: 6969 3a0a 2020 2020 2020 2020 2020 2020  ii:.            
+00025ec0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+00025ed0: 2822 5468 6572 6520 6973 206e 6f20 7b72  ("There is no {r
+00025ee0: 7d20 7261 6469 7573 2061 7373 6f63 6961  } radius associa
+00025ef0: 7465 6420 7769 7468 2074 6869 7320 6f62  ted with this ob
+00025f00: 6a65 6374 2e22 2e66 6f72 6d61 7428 723d  ject.".format(r=
+00025f10: 7261 645f 6e61 6d65 2929 0a0a 2020 2020  rad_name))..    
+00025f20: 2020 2020 6f75 745f 7261 6420 3d20 7365      out_rad = se
+00025f30: 6c66 2e63 6f6e 7665 7274 5f72 6164 6975  lf.convert_radiu
+00025f40: 7328 7365 6c66 2e5f 7261 6469 695b 7261  s(self._radii[ra
+00025f50: 645f 6e61 6d65 5d2c 206f 7574 5f75 6e69  d_name], out_uni
+00025f60: 7429 0a0a 2020 2020 2020 2020 7265 7475  t)..        retu
+00025f70: 726e 206f 7574 5f72 6164 0a0a 2020 2020  rn out_rad..    
+00025f80: 4070 726f 7065 7274 790a 2020 2020 6465  @property.    de
+00025f90: 6620 6e75 6d5f 706e 5f6f 6273 2873 656c  f num_pn_obs(sel
+00025fa0: 6629 202d 3e20 696e 743a 0a20 2020 2020  f) -> int:.     
+00025fb0: 2020 2022 2222 0a20 2020 2020 2020 2047     """.        G
+00025fc0: 6574 7465 7220 6d65 7468 6f64 2074 6861  etter method tha
+00025fd0: 7420 6769 7665 7320 7468 6520 6e75 6d62  t gives the numb
+00025fe0: 6572 206f 6620 504e 206f 6273 6572 7661  er of PN observa
+00025ff0: 7469 6f6e 732e 0a0a 2020 2020 2020 2020  tions...        
+00026000: 3a72 6574 7572 6e3a 2049 6e74 6567 6572  :return: Integer
+00026010: 206e 756d 6265 7220 6f66 2050 4e20 6f62   number of PN ob
+00026020: 7365 7276 6174 696f 6e73 2061 7373 6f63  servations assoc
+00026030: 6961 7465 6420 7769 7468 2074 6869 7320  iated with this 
+00026040: 736f 7572 6365 0a20 2020 2020 2020 203a  source.        :
+00026050: 7274 7970 653a 2069 6e74 0a20 2020 2020  rtype: int.     
+00026060: 2020 2022 2222 0a20 2020 2020 2020 2072     """.        r
+00026070: 6574 7572 6e20 6c65 6e28 5b6f 2066 6f72  eturn len([o for
+00026080: 206f 2069 6e20 7365 6c66 2e6f 6273 5f69   o in self.obs_i
+00026090: 6473 2069 6620 2770 6e27 2069 6e20 7365  ds if 'pn' in se
+000260a0: 6c66 2e5f 7072 6f64 7563 7473 5b6f 5d5d  lf._products[o]]
+000260b0: 290a 0a20 2020 2040 7072 6f70 6572 7479  )..    @property
+000260c0: 0a20 2020 2064 6566 206e 756d 5f6d 6f73  .    def num_mos
+000260d0: 315f 6f62 7328 7365 6c66 2920 2d3e 2069  1_obs(self) -> i
+000260e0: 6e74 3a0a 2020 2020 2020 2020 2222 220a  nt:.        """.
+000260f0: 2020 2020 2020 2020 4765 7474 6572 206d          Getter m
+00026100: 6574 686f 6420 7468 6174 2067 6976 6573  ethod that gives
+00026110: 2074 6865 206e 756d 6265 7220 6f66 204d   the number of M
+00026120: 4f53 3120 6f62 7365 7276 6174 696f 6e73  OS1 observations
+00026130: 2e0a 0a20 2020 2020 2020 203a 7265 7475  ...        :retu
+00026140: 726e 3a20 496e 7465 6765 7220 6e75 6d62  rn: Integer numb
+00026150: 6572 206f 6620 4d4f 5331 206f 6273 6572  er of MOS1 obser
+00026160: 7661 7469 6f6e 7320 6173 736f 6369 6174  vations associat
+00026170: 6564 2077 6974 6820 7468 6973 2073 6f75  ed with this sou
+00026180: 7263 650a 2020 2020 2020 2020 3a72 7479  rce.        :rty
+00026190: 7065 3a20 696e 740a 2020 2020 2020 2020  pe: int.        
+000261a0: 2222 220a 2020 2020 2020 2020 7265 7475  """.        retu
+000261b0: 726e 206c 656e 285b 6f20 666f 7220 6f20  rn len([o for o 
+000261c0: 696e 2073 656c 662e 6f62 735f 6964 7320  in self.obs_ids 
+000261d0: 6966 2027 6d6f 7331 2720 696e 2073 656c  if 'mos1' in sel
+000261e0: 662e 5f70 726f 6475 6374 735b 6f5d 5d29  f._products[o]])
+000261f0: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
+00026200: 2020 2020 6465 6620 6e75 6d5f 6d6f 7332      def num_mos2
+00026210: 5f6f 6273 2873 656c 6629 202d 3e20 696e  _obs(self) -> in
+00026220: 743a 0a20 2020 2020 2020 2022 2222 0a20  t:.        """. 
+00026230: 2020 2020 2020 2047 6574 7465 7220 6d65         Getter me
+00026240: 7468 6f64 2074 6861 7420 6769 7665 7320  thod that gives 
+00026250: 7468 6520 6e75 6d62 6572 206f 6620 4d4f  the number of MO
+00026260: 5332 206f 6273 6572 7661 7469 6f6e 732e  S2 observations.
+00026270: 0a0a 2020 2020 2020 2020 3a72 6574 7572  ..        :retur
+00026280: 6e3a 2049 6e74 6567 6572 206e 756d 6265  n: Integer numbe
+00026290: 7220 6f66 204d 4f53 3220 6f62 7365 7276  r of MOS2 observ
+000262a0: 6174 696f 6e73 2061 7373 6f63 6961 7465  ations associate
+000262b0: 6420 7769 7468 2074 6869 7320 736f 7572  d with this sour
+000262c0: 6365 0a20 2020 2020 2020 203a 7274 7970  ce.        :rtyp
+000262d0: 653a 2069 6e74 0a20 2020 2020 2020 2022  e: int.        "
+000262e0: 2222 0a20 2020 2020 2020 2072 6574 7572  "".        retur
+000262f0: 6e20 6c65 6e28 5b6f 2066 6f72 206f 2069  n len([o for o i
+00026300: 6e20 7365 6c66 2e6f 6273 5f69 6473 2069  n self.obs_ids i
+00026310: 6620 276d 6f73 3227 2069 6e20 7365 6c66  f 'mos2' in self
+00026320: 2e5f 7072 6f64 7563 7473 5b6f 5d5d 290a  ._products[o]]).
+00026330: 0a20 2020 2023 2041 7320 7468 6973 2069  .    # As this i
+00026340: 7320 616e 2069 6e74 7269 6e73 6963 2070  s an intrinsic p
+00026350: 726f 7065 7274 7920 6f66 2077 6869 6368  roperty of which
+00026360: 206d 6174 6368 6564 206f 6273 6572 7661   matched observa
+00026370: 7469 6f6e 7320 6172 6520 7661 6c69 642c  tions are valid,
+00026380: 2074 6865 7265 2077 696c 6c20 6265 206e   there will be n
+00026390: 6f20 7365 7474 6572 0a20 2020 2040 7072  o setter.    @pr
+000263a0: 6f70 6572 7479 0a20 2020 2064 6566 2069  operty.    def i
+000263b0: 6e73 7472 756d 656e 7473 2873 656c 6629  nstruments(self)
+000263c0: 202d 3e20 4469 6374 3a0a 2020 2020 2020   -> Dict:.      
+000263d0: 2020 2222 220a 2020 2020 2020 2020 4120    """.        A 
+000263e0: 7072 6f70 6572 7479 206f 6620 6120 736f  property of a so
+000263f0: 7572 6365 2074 6861 7420 6465 7461 696c  urce that detail
+00026400: 7320 7768 6963 6820 696e 7374 7275 6d65  s which instrume
+00026410: 6e74 7320 6861 7665 2076 616c 6964 2064  nts have valid d
+00026420: 6174 6120 666f 7220 7768 6963 6820 6f62  ata for which ob
+00026430: 7365 7276 6174 696f 6e73 2e0a 0a20 2020  servations...   
+00026440: 2020 2020 203a 7265 7475 726e 3a20 4120       :return: A 
+00026450: 6469 6374 696f 6e61 7279 206f 6620 4f62  dictionary of Ob
+00026460: 7349 4473 2061 6e64 2074 6865 6972 2061  sIDs and their a
+00026470: 7373 6f63 6961 7465 6420 7661 6c69 6420  ssociated valid 
+00026480: 696e 7374 7275 6d65 6e74 732e 0a20 2020  instruments..   
+00026490: 2020 2020 203a 7274 7970 653a 2044 6963       :rtype: Dic
+000264a0: 740a 2020 2020 2020 2020 2222 220a 2020  t.        """.  
+000264b0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+000264c0: 662e 5f69 6e73 7472 756d 656e 7473 0a0a  f._instruments..
+000264d0: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
+000264e0: 2020 6465 6620 6469 7361 7373 6f63 6961    def disassocia
+000264f0: 7465 6428 7365 6c66 2920 2d3e 2062 6f6f  ted(self) -> boo
+00026500: 6c3a 0a20 2020 2020 2020 2022 2222 0a20  l:.        """. 
+00026510: 2020 2020 2020 2050 726f 7065 7274 7920         Property 
+00026520: 7468 6174 2064 6573 6372 6962 6573 2077  that describes w
+00026530: 6865 7468 6572 2074 6869 7320 736f 7572  hether this sour
+00026540: 6365 2068 6173 2068 6164 204f 6273 4944  ce has had ObsID
+00026550: 7320 6469 7361 7373 6f63 6961 7465 6420  s disassociated 
+00026560: 6672 6f6d 2069 742e 0a0a 2020 2020 2020  from it...      
+00026570: 2020 3a72 6574 7572 6e3a 2041 2062 6f6f    :return: A boo
+00026580: 6c65 616e 2066 6c61 672c 2054 7275 6520  lean flag, True 
+00026590: 6d65 616e 7320 7468 6174 204f 6273 4944  means that ObsID
+000265a0: 732f 696e 7374 7275 6d65 6e74 7320 6861  s/instruments ha
+000265b0: 7665 2062 6565 6e20 7265 6d6f 7665 642c  ve been removed,
+000265c0: 2046 616c 7365 206d 6561 6e73 2074 6865   False means the
+000265d0: 7920 6861 7665 6e27 742e 0a20 2020 2020  y haven't..     
+000265e0: 2020 203a 7274 7970 653a 2062 6f6f 6c0a     :rtype: bool.
+000265f0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00026600: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+00026610: 5f64 6973 6173 736f 6369 6174 6564 0a0a  _disassociated..
+00026620: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
+00026630: 2020 6465 6620 6469 7361 7373 6f63 6961    def disassocia
+00026640: 7465 645f 6f62 7328 7365 6c66 2920 2d3e  ted_obs(self) ->
+00026650: 2064 6963 743a 0a20 2020 2020 2020 2022   dict:.        "
+00026660: 2222 0a20 2020 2020 2020 2050 726f 7065  "".        Prope
+00026670: 7274 7920 7468 6174 2064 6574 6169 6c73  rty that details
+00026680: 2065 7861 6374 6c79 2077 6861 7420 6461   exactly what da
+00026690: 7461 2068 6173 2062 6565 6e20 6469 7361  ta has been disa
+000266a0: 7373 6f63 6961 7465 6420 6672 6f6d 2074  ssociated from t
+000266b0: 6869 7320 736f 7572 6365 2c20 6966 2061  his source, if a
+000266c0: 6e79 2e0a 0a20 2020 2020 2020 203a 7265  ny...        :re
+000266d0: 7475 726e 3a20 4469 6374 696f 6e61 7279  turn: Dictionary
+000266e0: 2064 6573 6372 6962 696e 6720 7768 6963   describing whic
+000266f0: 6820 696e 7374 7275 6d65 6e74 7320 6f66  h instruments of
+00026700: 2077 6869 6368 204f 6273 4944 7320 6861   which ObsIDs ha
+00026710: 7665 2062 6565 6e20 6469 7361 7373 6f63  ve been disassoc
+00026720: 6961 7465 6420 6672 6f6d 2074 6869 7320  iated from this 
+00026730: 736f 7572 6365 2e0a 2020 2020 2020 2020  source..        
+00026740: 3a72 7479 7065 3a20 6469 6374 0a20 2020  :rtype: dict.   
+00026750: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00026760: 2072 6574 7572 6e20 7365 6c66 2e5f 6469   return self._di
+00026770: 7361 7373 6f63 6961 7465 645f 6f62 730a  sassociated_obs.
+00026780: 0a20 2020 2064 6566 2064 6973 6173 736f  .    def disasso
+00026790: 6369 6174 655f 6f62 7328 7365 6c66 2c20  ciate_obs(self, 
+000267a0: 746f 5f72 656d 6f76 653a 2055 6e69 6f6e  to_remove: Union
+000267b0: 5b64 6963 742c 2073 7472 2c20 6c69 7374  [dict, str, list
+000267c0: 5d29 3a0a 2020 2020 2020 2020 2222 220a  ]):.        """.
+000267d0: 2020 2020 2020 2020 4d65 7468 6f64 2074          Method t
+000267e0: 6861 7420 7573 6573 2074 6865 2073 7570  hat uses the sup
+000267f0: 706c 6965 6420 6469 6374 696f 6e61 7279  plied dictionary
+00026800: 2074 6f20 7361 6665 6c79 2072 656d 6f76   to safely remov
+00026810: 6520 6461 7461 2066 726f 6d20 7468 6520  e data from the 
+00026820: 736f 7572 6365 2e20 5468 6973 2064 6174  source. This dat
+00026830: 6120 7769 6c6c 206e 6f20 6c6f 6e67 6572  a will no longer
+00026840: 0a20 2020 2020 2020 2062 6520 7573 6564  .        be used
+00026850: 2069 6e20 616e 7920 616e 616c 7973 6573   in any analyses
+00026860: 2c20 616e 6420 776f 756c 6420 7479 7069  , and would typi
+00026870: 6361 6c6c 7920 6265 2072 656d 6f76 6564  cally be removed
+00026880: 2062 6563 6175 7365 2069 7420 6973 206f   because it is o
+00026890: 6620 706f 6f72 2071 7561 6c69 7479 2c20  f poor quality, 
+000268a0: 6f72 2064 6f65 736e 2774 2063 6f6e 7472  or doesn't contr
+000268b0: 6962 7574 650a 2020 2020 2020 2020 656e  ibute.        en
+000268c0: 6f75 6768 2074 6f20 6a75 7374 6966 7920  ough to justify 
+000268d0: 6974 7320 7072 6573 656e 6365 2e0a 0a20  its presence... 
+000268e0: 2020 2020 2020 203a 7061 7261 6d20 6469         :param di
+000268f0: 6374 2f73 7472 2f6c 6973 7420 746f 5f72  ct/str/list to_r
+00026900: 656d 6f76 653a 2045 6974 6865 7220 6120  emove: Either a 
+00026910: 6469 6374 696f 6e61 7279 206f 6620 6f62  dictionary of ob
+00026920: 7365 7276 6174 696f 6e73 2074 6f20 7265  servations to re
+00026930: 6d6f 7665 2c20 2869 6e20 7468 6520 7374  move, (in the st
+00026940: 796c 6520 6f66 0a20 2020 2020 2020 2020  yle of.         
+00026950: 2020 2074 6865 2073 6f75 7263 652e 696e     the source.in
+00026960: 7374 7275 6d65 6e74 7320 6469 6374 696f  struments dictio
+00026970: 6e61 7279 2077 6974 6820 7468 6520 746f  nary with the to
+00026980: 7020 6c65 7665 6c20 6b65 7973 2062 6569  p level keys bei
+00026990: 6e67 204f 6273 4944 732c 2061 6e64 2074  ng ObsIDs, and t
+000269a0: 6865 206c 6f77 6572 206c 6576 656c 730a  he lower levels.
+000269b0: 2020 2020 2020 2020 2020 2020 6265 696e              bein
+000269c0: 6720 696e 7374 7275 6d65 6e74 206e 616d  g instrument nam
+000269d0: 6573 292c 2061 2073 7472 696e 6720 636f  es), a string co
+000269e0: 6e74 6169 6e69 6e67 2061 6e20 4f62 7349  ntaining an ObsI
+000269f0: 442c 206f 7220 6120 6c69 7374 206f 6620  D, or a list of 
+00026a00: 4f62 7349 4473 2e0a 2020 2020 2020 2020  ObsIDs..        
+00026a10: 2222 220a 2020 2020 2020 2020 2320 5573  """.        # Us
+00026a20: 6572 7320 6361 6e20 7061 7373 206a 7573  ers can pass jus
+00026a30: 7420 616e 204f 6273 4944 2073 7472 696e  t an ObsID strin
+00026a40: 672c 2062 7574 2077 6520 7468 656e 206e  g, but we then n
+00026a50: 6565 6420 746f 2063 6f6e 7665 7274 2069  eed to convert i
+00026a60: 7420 746f 2074 6865 2066 6f72 6d0a 2020  t to the form.  
+00026a70: 2020 2020 2020 2320 2074 6861 7420 7468        #  that th
+00026a80: 6520 7265 7374 206f 6620 7468 6520 6675  e rest of the fu
+00026a90: 6e63 7469 6f6e 2072 6571 7569 7265 730a  nction requires.
+00026aa0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+00026ab0: 7461 6e63 6528 746f 5f72 656d 6f76 652c  tance(to_remove,
+00026ac0: 2073 7472 293a 0a20 2020 2020 2020 2020   str):.         
+00026ad0: 2020 2074 6f5f 7265 6d6f 7665 203d 207b     to_remove = {
+00026ae0: 746f 5f72 656d 6f76 653a 2064 6565 7063  to_remove: deepc
+00026af0: 6f70 7928 7365 6c66 2e69 6e73 7472 756d  opy(self.instrum
+00026b00: 656e 7473 5b74 6f5f 7265 6d6f 7665 5d29  ents[to_remove])
+00026b10: 7d0a 2020 2020 2020 2020 2320 4865 7265  }.        # Here
+00026b20: 2069 7320 7768 6572 6520 7468 6579 2068   is where they h
+00026b30: 6176 6520 6a75 7374 2070 6173 7365 6420  ave just passed 
+00026b40: 6120 6c69 7374 206f 6620 4f62 7349 4473  a list of ObsIDs
+00026b50: 2c20 616e 6420 7765 206e 6565 6420 746f  , and we need to
+00026b60: 2066 696c 6c20 696e 2074 6865 2062 6c61   fill in the bla
+00026b70: 6e6b 7320 7769 7468 2074 6865 2069 6e73  nks with the ins
+00026b80: 7472 756d 656e 7473 0a20 2020 2020 2020  truments.       
+00026b90: 2023 2020 6375 7272 656e 746c 7920 6c6f   #  currently lo
+00026ba0: 6164 6564 2066 6f72 2074 686f 7365 204f  aded for those O
+00026bb0: 6273 4944 730a 2020 2020 2020 2020 656c  bsIDs.        el
+00026bc0: 6966 2069 7369 6e73 7461 6e63 6528 746f  if isinstance(to
+00026bd0: 5f72 656d 6f76 652c 206c 6973 7429 3a0a  _remove, list):.
+00026be0: 2020 2020 2020 2020 2020 2020 746f 5f72              to_r
+00026bf0: 656d 6f76 6520 3d20 7b6f 3a20 6465 6570  emove = {o: deep
+00026c00: 636f 7079 2873 656c 662e 696e 7374 7275  copy(self.instru
+00026c10: 6d65 6e74 735b 6f5d 2920 666f 7220 6f20  ments[o]) for o 
+00026c20: 696e 2074 6f5f 7265 6d6f 7665 7d0a 2020  in to_remove}.  
+00026c30: 2020 2020 2020 2320 4865 7265 2064 6561        # Here dea
+00026c40: 6c73 2077 6974 6820 7768 656e 2073 6f6d  ls with when som
+00026c50: 656f 6e65 206d 6967 6874 2068 6176 6520  eone might have 
+00026c60: 7061 7373 6564 2061 2064 6963 7469 6f6e  passed a diction
+00026c70: 6172 7920 7768 6572 6520 7468 6572 6520  ary where there 
+00026c80: 6973 2061 2073 696e 676c 6520 696e 7374  is a single inst
+00026c90: 7275 6d65 6e74 2c20 616e 640a 2020 2020  rument, and.    
+00026ca0: 2020 2020 2320 2074 6865 7920 6861 7665      #  they have
+00026cb0: 6e27 7420 7075 7420 6974 2069 6e20 6120  n't put it in a 
+00026cc0: 6c69 7374 3b20 652e 672e 207b 2730 3230  list; e.g. {'020
+00026cd0: 3139 3033 3530 3127 3a20 2770 6e27 7d2e  1903501': 'pn'}.
+00026ce0: 2054 6869 7320 6465 7465 6374 7320 696e   This detects in
+00026cf0: 7374 616e 6365 7320 6c69 6b65 2074 6861  stances like tha
+00026d00: 7420 616e 6420 7468 656e 0a20 2020 2020  t and then.     
+00026d10: 2020 2023 2020 7075 7473 2074 6865 2069     #  puts the i
+00026d20: 6e64 6976 6964 7561 6c20 696e 7374 7275  ndividual instru
+00026d30: 6d65 6e74 2069 6e20 6120 6c69 7374 2061  ment in a list a
+00026d40: 7320 6973 2065 7870 6563 7465 6420 6279  s is expected by
+00026d50: 2074 6865 2072 6573 7420 6f66 2074 6865   the rest of the
+00026d60: 2066 756e 6374 696f 6e0a 2020 2020 2020   function.      
+00026d70: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
+00026d80: 6528 746f 5f72 656d 6f76 652c 2064 6963  e(to_remove, dic
+00026d90: 7429 2061 6e64 206e 6f74 2061 6c6c 285b  t) and not all([
+00026da0: 6973 696e 7374 616e 6365 2876 2c20 6c69  isinstance(v, li
+00026db0: 7374 2920 666f 7220 7620 696e 2074 6f5f  st) for v in to_
+00026dc0: 7265 6d6f 7665 2e76 616c 7565 7328 295d  remove.values()]
+00026dd0: 293a 0a20 2020 2020 2020 2020 2020 206e  ):.            n
+00026de0: 6577 5f74 6f5f 7265 6d6f 7665 203d 207b  ew_to_remove = {
+00026df0: 7d0a 2020 2020 2020 2020 2020 2020 666f  }.            fo
+00026e00: 7220 6f20 696e 2074 6f5f 7265 6d6f 7665  r o in to_remove
+00026e10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00026e20: 2020 6966 206e 6f74 2069 7369 6e73 7461    if not isinsta
+00026e30: 6e63 6528 746f 5f72 656d 6f76 655b 6f5d  nce(to_remove[o]
+00026e40: 2c20 6c69 7374 293a 0a20 2020 2020 2020  , list):.       
+00026e50: 2020 2020 2020 2020 2020 2020 206e 6577               new
+00026e60: 5f74 6f5f 7265 6d6f 7665 5b6f 5d20 3d20  _to_remove[o] = 
+00026e70: 5b64 6565 7063 6f70 7928 746f 5f72 656d  [deepcopy(to_rem
+00026e80: 6f76 655b 6f5d 295d 0a20 2020 2020 2020  ove[o])].       
+00026e90: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00026ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026eb0: 2020 206e 6577 5f74 6f5f 7265 6d6f 7665     new_to_remove
+00026ec0: 5b6f 5d20 3d20 6465 6570 636f 7079 2874  [o] = deepcopy(t
+00026ed0: 6f5f 7265 6d6f 7665 5b6f 5d29 0a0a 2020  o_remove[o])..  
+00026ee0: 2020 2020 2020 2020 2020 2320 4920 7573            # I us
+00026ef0: 6520 6465 6570 636f 7079 2061 6761 696e  e deepcopy again
+00026f00: 2062 6563 6175 7365 2074 6865 7265 2068   because there h
+00026f10: 6176 6520 6265 656e 2069 7373 7565 7320  ave been issues 
+00026f20: 7769 7468 2074 6869 7320 6675 6e63 7469  with this functi
+00026f30: 6f6e 2073 7469 6c6c 2070 6f69 6e74 696e  on still pointin
+00026f40: 6720 746f 206f 6c64 206d 656d 6f72 790a  g to old memory.
+00026f50: 2020 2020 2020 2020 2020 2020 2320 2061              #  a
+00026f60: 6464 7265 7373 6573 2c20 736f 2049 276d  ddresses, so I'm
+00026f70: 2071 7569 7465 2070 6172 616e 6f69 6420   quite paranoid 
+00026f80: 696e 2074 6869 7320 6269 7420 6f66 2063  in this bit of c
+00026f90: 6f64 650a 2020 2020 2020 2020 2020 2020  ode.            
+00026fa0: 746f 5f72 656d 6f76 6520 3d20 6465 6570  to_remove = deep
+00026fb0: 636f 7079 286e 6577 5f74 6f5f 7265 6d6f  copy(new_to_remo
+00026fc0: 7665 290a 0a20 2020 2020 2020 2023 2057  ve)..        # W
+00026fd0: 6520 616c 736f 2063 6865 636b 2074 6f20  e also check to 
+00026fe0: 6d61 6b65 2073 7572 6520 7468 6174 2074  make sure that t
+00026ff0: 6865 2064 6174 6120 7765 2772 6520 6265  he data we're be
+00027000: 696e 6720 6173 6b65 6420 746f 2072 656d  ing asked to rem
+00027010: 6f76 6520 6163 7475 616c 6c79 2069 7320  ove actually is 
+00027020: 6173 736f 6369 6174 6564 2077 6974 6820  associated with 
+00027030: 7468 650a 2020 2020 2020 2020 2320 2073  the.        #  s
+00027040: 6f75 7263 652e 2057 6520 7368 616c 6c20  ource. We shall 
+00027050: 6265 2066 6f72 6769 7669 6e67 2069 6620  be forgiving if 
+00027060: 6974 2069 736e 2774 2c20 616e 6420 6a75  it isn't, and ju
+00027070: 7374 2069 7373 7565 2061 2077 6172 6e69  st issue a warni
+00027080: 6e67 2074 6f20 6c65 7420 7468 6520 7573  ng to let the us
+00027090: 6572 206b 6e6f 7720 7468 6174 2074 6865  er know that the
+000270a0: 7920 6172 650a 2020 2020 2020 2020 2320  y are.        # 
+000270b0: 2061 7373 756d 696e 6720 6461 7461 2077   assuming data w
+000270c0: 6173 2068 6572 6520 7468 6174 2061 6374  as here that act
+000270d0: 7561 6c6c 7920 6973 6e27 7420 7072 6573  ually isn't pres
+000270e0: 656e 740a 2020 2020 2020 2020 2320 4974  ent.        # It
+000270f0: 6572 6174 696e 6720 7468 726f 7567 6820  erating through 
+00027100: 7468 6520 6b65 7973 2028 4f62 7349 4473  the keys (ObsIDs
+00027110: 2920 696e 2074 6f5f 7265 6d6f 7665 0a20  ) in to_remove. 
+00027120: 2020 2020 2020 2066 6f72 206f 2069 6e20         for o in 
+00027130: 746f 5f72 656d 6f76 653a 0a20 2020 2020  to_remove:.     
+00027140: 2020 2020 2020 2069 6620 6f20 6e6f 7420         if o not 
+00027150: 696e 2073 656c 662e 6f62 735f 6964 733a  in self.obs_ids:
+00027160: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00027170: 2077 6172 6e28 227b 6f7d 2064 6174 6120   warn("{o} data 
+00027180: 6361 6e6e 6f74 2062 6520 7265 6d6f 7665  cannot be remove
+00027190: 6420 6672 6f6d 207b 737d 2061 7320 7468  d from {s} as th
+000271a0: 6579 2061 7265 206e 6f74 2061 7373 6f63  ey are not assoc
+000271b0: 6961 7465 6420 7769 7468 2022 0a20 2020  iated with ".   
+000271c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000271d0: 2020 2020 2020 2020 2020 2022 6974 2e22             "it."
+000271e0: 2e66 6f72 6d61 7428 6f3d 6f2c 2073 3d73  .format(o=o, s=s
+000271f0: 656c 662e 6e61 6d65 292c 2073 7461 636b  elf.name), stack
+00027200: 6c65 7665 6c3d 3229 0a20 2020 2020 2020  level=2).       
+00027210: 2020 2020 2023 2043 6865 636b 2074 6f20       # Check to 
+00027220: 7365 6520 7768 6574 6865 7220 616e 7920  see whether any 
+00027230: 6f66 2074 6865 2069 6e73 7472 756d 656e  of the instrumen
+00027240: 7473 2066 6f72 206f 2061 7265 206e 6f74  ts for o are not
+00027250: 2061 6374 7561 6c6c 7920 6173 736f 6369   actually associ
+00027260: 6174 6564 2077 6974 6820 7468 6520 736f  ated with the so
+00027270: 7572 6365 0a20 2020 2020 2020 2020 2020  urce.           
+00027280: 2065 6c69 6620 616e 7928 5b69 206e 6f74   elif any([i not
+00027290: 2069 6e20 7365 6c66 2e69 6e73 7472 756d   in self.instrum
+000272a0: 656e 7473 5b6f 5d20 666f 7220 6920 696e  ents[o] for i in
+000272b0: 2074 6f5f 7265 6d6f 7665 5b6f 5d5d 293a   to_remove[o]]):
+000272c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000272d0: 2062 6164 5f6c 6973 7420 3d20 5b69 2066   bad_list = [i f
+000272e0: 6f72 2069 2069 6e20 746f 5f72 656d 6f76  or i in to_remov
+000272f0: 655b 6f5d 2069 6620 6920 6e6f 7420 696e  e[o] if i not in
+00027300: 2073 656c 662e 696e 7374 7275 6d65 6e74   self.instrument
+00027310: 735b 6f5d 5d0a 2020 2020 2020 2020 2020  s[o]].          
+00027320: 2020 2020 2020 6261 645f 7374 7220 3d20        bad_str = 
+00027330: 222f 222e 6a6f 696e 2862 6164 5f6c 6973  "/".join(bad_lis
+00027340: 7429 0a20 2020 2020 2020 2020 2020 2020  t).             
+00027350: 2020 2077 6172 6e28 227b 6f7d 2d7b 6962     warn("{o}-{ib
+00027360: 7d20 6461 7461 2063 616e 6e6f 7420 6265  } data cannot be
+00027370: 2072 656d 6f76 6564 2066 726f 6d20 7b73   removed from {s
+00027380: 7d20 6173 2074 6865 7920 6172 6520 6e6f  } as they are no
+00027390: 7420 6173 736f 6369 6174 6564 2022 0a20  t associated ". 
+000273a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000273b0: 2020 2020 2020 2020 2020 2020 2022 7769               "wi
+000273c0: 7468 2069 742e 222e 666f 726d 6174 286f  th it.".format(o
+000273d0: 3d6f 2c20 6962 3d62 6164 5f73 7472 2c20  =o, ib=bad_str, 
+000273e0: 733d 7365 6c66 2e6e 616d 6529 2c20 7374  s=self.name), st
+000273f0: 6163 6b6c 6576 656c 3d32 290a 0a20 2020  acklevel=2)..   
+00027400: 2020 2020 2023 2053 6574 7320 7468 6520       # Sets the 
+00027410: 6174 7472 6962 7574 6520 7468 6174 2074  attribute that t
+00027420: 656c 6c73 2075 7320 7768 6574 6865 7220  ells us whether 
+00027430: 616e 7920 6461 7461 2068 6173 2062 6565  any data has bee
+00027440: 6e20 7265 6d6f 7665 640a 2020 2020 2020  n removed.      
+00027450: 2020 6966 206e 6f74 2073 656c 662e 5f64    if not self._d
+00027460: 6973 6173 736f 6369 6174 6564 3a0a 2020  isassociated:.  
+00027470: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00027480: 6469 7361 7373 6f63 6961 7465 6420 3d20  disassociated = 
+00027490: 5472 7565 0a0a 2020 2020 2020 2020 2320  True..        # 
+000274a0: 5765 2077 616e 7420 746f 2073 746f 7265  We want to store
+000274b0: 206b 6e6f 776c 6564 6765 206f 6620 7768   knowledge of wh
+000274c0: 6174 2064 6174 6120 6861 7320 6265 656e  at data has been
+000274d0: 2072 656d 6f76 6564 2c20 6966 2074 6865   removed, if the
+000274e0: 7265 2068 6173 6e27 7420 6265 656e 2061  re hasn't been a
+000274f0: 6e79 7468 696e 6720 7461 6b65 6e20 6177  nything taken aw
+00027500: 6179 2079 6574 0a20 2020 2020 2020 2023  ay yet.        #
+00027510: 2020 7468 656e 2077 6520 6361 6e20 6a75    then we can ju
+00027520: 7374 2073 6574 2069 7420 6571 7561 6c20  st set it equal 
+00027530: 746f 2074 6865 2074 6f5f 7265 6d6f 7665  to the to_remove
+00027540: 2064 6963 7469 6f6e 6172 790a 2020 2020   dictionary.    
+00027550: 2020 2020 6966 206c 656e 2873 656c 662e      if len(self.
+00027560: 5f64 6973 6173 736f 6369 6174 6564 5f6f  _disassociated_o
+00027570: 6273 2920 3d3d 2030 3a0a 2020 2020 2020  bs) == 0:.      
+00027580: 2020 2020 2020 7365 6c66 2e5f 6469 7361        self._disa
+00027590: 7373 6f63 6961 7465 645f 6f62 7320 3d20  ssociated_obs = 
+000275a0: 746f 5f72 656d 6f76 650a 2020 2020 2020  to_remove.      
+000275b0: 2020 2320 4f74 6865 7277 6973 6520 7765    # Otherwise we
+000275c0: 2068 6176 6520 746f 2061 6464 2074 6865   have to add the
+000275d0: 2064 6174 6120 746f 2074 6865 2065 7869   data to the exi
+000275e0: 7374 696e 6720 6469 6374 696f 6e61 7279  sting dictionary
+000275f0: 2073 7472 7563 7475 7265 0a20 2020 2020   structure.     
+00027600: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00027610: 2020 2020 2066 6f72 206f 2069 6e20 746f       for o in to
+00027620: 5f72 656d 6f76 653a 0a20 2020 2020 2020  _remove:.       
+00027630: 2020 2020 2020 2020 2069 6620 6f20 6e6f           if o no
+00027640: 7420 696e 2073 656c 662e 5f64 6973 6173  t in self._disas
+00027650: 736f 6369 6174 6564 5f6f 6273 3a0a 2020  sociated_obs:.  
+00027660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027670: 2020 7365 6c66 2e5f 6469 7361 7373 6f63    self._disassoc
+00027680: 6961 7465 645f 6f62 735b 6f5d 203d 2074  iated_obs[o] = t
+00027690: 6f5f 7265 6d6f 7665 5b6f 5d0a 2020 2020  o_remove[o].    
+000276a0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+000276b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000276c0: 2020 2020 2020 7365 6c66 2e5f 6469 7361        self._disa
+000276d0: 7373 6f63 6961 7465 645f 6f62 735b 6f5d  ssociated_obs[o]
+000276e0: 202b 3d20 746f 5f72 656d 6f76 655b 6f5d   += to_remove[o]
+000276f0: 0a0a 2020 2020 2020 2020 2320 4966 2077  ..        # If w
+00027700: 6527 7265 2075 6e2d 6173 736f 6369 6174  e're un-associat
+00027710: 696e 6720 6365 7274 6169 6e20 6f62 7365  ing certain obse
+00027720: 7276 6174 696f 6e73 2c20 6f64 6473 206f  rvations, odds o
+00027730: 6e20 7468 6520 636f 6d62 696e 6564 2070  n the combined p
+00027740: 726f 6475 6374 7320 6172 6520 6e6f 206c  roducts are no l
+00027750: 6f6e 6765 7220 7661 6c69 640a 2020 2020  onger valid.    
+00027760: 2020 2020 6966 2022 636f 6d62 696e 6564      if "combined
+00027770: 2220 696e 2073 656c 662e 5f70 726f 6475  " in self._produ
+00027780: 6374 733a 0a20 2020 2020 2020 2020 2020  cts:.           
+00027790: 2064 656c 2073 656c 662e 5f70 726f 6475   del self._produ
+000277a0: 6374 735b 2263 6f6d 6269 6e65 6422 5d0a  cts["combined"].
+000277b0: 2020 2020 2020 2020 2020 2020 6966 2022              if "
+000277c0: 636f 6d62 696e 6564 2220 696e 2073 656c  combined" in sel
+000277d0: 662e 5f69 6e74 6572 6c6f 7065 725f 6d61  f._interloper_ma
+000277e0: 736b 733a 0a20 2020 2020 2020 2020 2020  sks:.           
+000277f0: 2020 2020 2064 656c 2073 656c 662e 5f69       del self._i
+00027800: 6e74 6572 6c6f 7065 725f 6d61 736b 735b  nterloper_masks[
+00027810: 2263 6f6d 6269 6e65 6422 5d0a 2020 2020  "combined"].    
+00027820: 2020 2020 2020 2020 7365 6c66 2e5f 6669          self._fi
+00027830: 745f 7265 7375 6c74 7320 3d20 7b7d 0a20  t_results = {}. 
+00027840: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00027850: 5f74 6573 745f 7374 6174 203d 207b 7d0a  _test_stat = {}.
+00027860: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00027870: 2e5f 646f 6620 3d20 7b7d 0a20 2020 2020  ._dof = {}.     
+00027880: 2020 2020 2020 2073 656c 662e 5f74 6f74         self._tot
+00027890: 616c 5f63 6f75 6e74 5f72 6174 6520 3d20  al_count_rate = 
+000278a0: 7b7d 0a20 2020 2020 2020 2020 2020 2073  {}.            s
+000278b0: 656c 662e 5f74 6f74 616c 5f65 7870 203d  elf._total_exp =
+000278c0: 207b 7d0a 2020 2020 2020 2020 2020 2020   {}.            
+000278d0: 7365 6c66 2e5f 6c75 6d69 6e6f 7369 7469  self._luminositi
+000278e0: 6573 203d 207b 7d0a 0a20 2020 2020 2020  es = {}..       
+000278f0: 2066 6f72 206f 2069 6e20 746f 5f72 656d   for o in to_rem
+00027900: 6f76 653a 0a20 2020 2020 2020 2020 2020  ove:.           
+00027910: 2066 6f72 2069 2069 6e20 746f 5f72 656d   for i in to_rem
+00027920: 6f76 655b 6f5d 3a0a 2020 2020 2020 2020  ove[o]:.        
+00027930: 2020 2020 2020 2020 6465 6c20 7365 6c66          del self
+00027940: 2e5f 7072 6f64 7563 7473 5b6f 5d5b 695d  ._products[o][i]
+00027950: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00027960: 2064 656c 2073 656c 662e 5f69 6e73 7472   del self._instr
+00027970: 756d 656e 7473 5b6f 5d5b 7365 6c66 2e5f  uments[o][self._
+00027980: 696e 7374 7275 6d65 6e74 735b 6f5d 2e69  instruments[o].i
+00027990: 6e64 6578 2869 295d 0a0a 2020 2020 2020  ndex(i)]..      
+000279a0: 2020 2020 2020 6966 206c 656e 2873 656c        if len(sel
+000279b0: 662e 5f69 6e73 7472 756d 656e 7473 5b6f  f._instruments[o
+000279c0: 5d29 203d 3d20 303a 0a20 2020 2020 2020  ]) == 0:.       
+000279d0: 2020 2020 2020 2020 2064 656c 2073 656c           del sel
+000279e0: 662e 5f70 726f 6475 6374 735b 6f5d 0a20  f._products[o]. 
+000279f0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00027a00: 656c 2073 656c 662e 5f64 6574 6563 7465  el self._detecte
+00027a10: 645b 6f5d 0a20 2020 2020 2020 2020 2020  d[o].           
+00027a20: 2020 2020 2064 656c 2073 656c 662e 5f69       del self._i
+00027a30: 6e69 7469 616c 5f72 6567 696f 6e73 5b6f  nitial_regions[o
+00027a40: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00027a50: 2020 6465 6c20 7365 6c66 2e5f 696e 6974    del self._init
+00027a60: 6961 6c5f 7265 6769 6f6e 5f6d 6174 6368  ial_region_match
+00027a70: 6573 5b6f 5d0a 2020 2020 2020 2020 2020  es[o].          
+00027a80: 2020 2020 2020 6465 6c20 7365 6c66 2e5f        del self._
+00027a90: 7265 6769 6f6e 735b 6f5d 0a20 2020 2020  regions[o].     
+00027aa0: 2020 2020 2020 2020 2020 2064 656c 2073             del s
+00027ab0: 656c 662e 5f6f 7468 6572 5f72 6567 696f  elf._other_regio
+00027ac0: 6e73 5b6f 5d0a 2020 2020 2020 2020 2020  ns[o].          
+00027ad0: 2020 2020 2020 6465 6c20 7365 6c66 2e5f        del self._
+00027ae0: 616c 745f 6d61 7463 685f 7265 6769 6f6e  alt_match_region
+00027af0: 735b 6f5d 0a20 2020 2020 2020 2020 2020  s[o].           
+00027b00: 2020 2020 2023 2054 6865 7365 2061 7265       # These are
+00027b10: 206d 6164 6520 6f6e 2064 656d 616e 642c   made on demand,
+00027b20: 2073 6f20 6e65 6564 2074 6f20 6368 6563   so need to chec
+00027b30: 6b20 6966 2069 7473 2061 6374 7561 6c6c  k if its actuall
+00027b40: 7920 7072 6573 656e 7420 6669 7273 740a  y present first.
+00027b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027b60: 6966 206f 2069 6e20 7365 6c66 2e5f 696e  if o in self._in
+00027b70: 7465 726c 6f70 6572 5f6d 6173 6b73 3a0a  terloper_masks:.
+00027b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027b90: 2020 2020 6465 6c20 7365 6c66 2e5f 696e      del self._in
+00027ba0: 7465 726c 6f70 6572 5f6d 6173 6b73 5b6f  terloper_masks[o
+00027bb0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00027bc0: 2020 6966 2073 656c 662e 5f70 6561 6b73    if self._peaks
+00027bd0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00027be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027bf0: 2020 6465 6c20 7365 6c66 2e5f 7065 616b    del self._peak
+00027c00: 735b 6f5d 0a0a 2020 2020 2020 2020 2020  s[o]..          
+00027c10: 2020 2020 2020 6465 6c20 7365 6c66 2e5f        del self._
+00027c20: 6f62 735b 7365 6c66 2e5f 6f62 732e 696e  obs[self._obs.in
+00027c30: 6465 7828 6f29 5d0a 2020 2020 2020 2020  dex(o)].        
+00027c40: 2020 2020 2020 2020 6966 206f 2069 6e20          if o in 
+00027c50: 7365 6c66 2e5f 6f6e 6178 6973 3a0a 2020  self._onaxis:.  
+00027c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027c70: 2020 6465 6c20 7365 6c66 2e5f 6f6e 6178    del self._onax
+00027c80: 6973 5b73 656c 662e 5f6f 6e61 7869 732e  is[self._onaxis.
+00027c90: 696e 6465 7828 6f29 5d0a 2020 2020 2020  index(o)].      
+00027ca0: 2020 2020 2020 2020 2020 6465 6c20 7365            del se
+00027cb0: 6c66 2e5f 696e 7374 7275 6d65 6e74 735b  lf._instruments[
+00027cc0: 6f5d 0a0a 2020 2020 2020 2020 6966 206c  o]..        if l
+00027cd0: 656e 2873 656c 662e 5f6f 6273 2920 3d3d  en(self._obs) ==
+00027ce0: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+00027cf0: 7261 6973 6520 4e6f 5661 6c69 644f 6273  raise NoValidObs
+00027d00: 6572 7661 7469 6f6e 7345 7272 6f72 2822  ervationsError("
+00027d10: 4e6f 206f 6273 6572 7661 7469 6f6e 7320  No observations 
+00027d20: 7265 6d61 696e 2061 7373 6f63 6961 7465  remain associate
+00027d30: 6420 7769 7468 207b 7d20 6166 7465 7220  d with {} after 
+00027d40: 636c 6561 6e69 6e67 222e 666f 726d 6174  cleaning".format
+00027d50: 2873 656c 662e 6e61 6d65 2929 0a0a 2020  (self.name))..  
+00027d60: 2020 2020 2020 2320 5765 2061 7474 656d        # We attem
+00027d70: 7074 2074 6f20 6c6f 6164 2069 6e20 6d61  pt to load in ma
+00027d80: 7463 6869 6e67 2058 4741 2070 726f 6475  tching XGA produ
+00027d90: 6374 7320 6966 2074 6861 7420 7761 7320  cts if that was 
+00027da0: 7468 6520 6265 6861 7669 6f75 7220 7365  the behaviour se
+00027db0: 7420 6279 206c 6f61 645f 7072 6f64 7563  t by load_produc
+00027dc0: 7473 206f 6e20 696e 6974 0a20 2020 2020  ts on init.     
+00027dd0: 2020 2069 6620 7365 6c66 2e5f 6c6f 6164     if self._load
+00027de0: 5f70 726f 6475 6374 733a 0a20 2020 2020  _products:.     
+00027df0: 2020 2020 2020 2073 656c 662e 5f65 7869         self._exi
+00027e00: 7374 696e 675f 7867 615f 7072 6f64 7563  sting_xga_produc
+00027e10: 7473 2873 656c 662e 5f6c 6f61 645f 6669  ts(self._load_fi
+00027e20: 7473 290a 0a20 2020 2040 7072 6f70 6572  ts)..    @proper
+00027e30: 7479 0a20 2020 2064 6566 206c 756d 696e  ty.    def lumin
+00027e40: 6f73 6974 795f 6469 7374 616e 6365 2873  osity_distance(s
+00027e50: 656c 6629 202d 3e20 5175 616e 7469 7479  elf) -> Quantity
+00027e60: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+00027e70: 2020 2020 2020 5465 6c6c 7320 7468 6520        Tells the 
+00027e80: 7573 6572 2074 6865 206c 756d 696e 6f73  user the luminos
+00027e90: 6974 7920 6469 7374 616e 6365 2074 6f20  ity distance to 
+00027ea0: 7468 6520 736f 7572 6365 2069 6620 6120  the source if a 
+00027eb0: 7265 6473 6869 6674 2077 6173 2073 7570  redshift was sup
+00027ec0: 706c 6965 642c 2069 6620 6e6f 7420 7265  plied, if not re
+00027ed0: 7475 726e 7320 4e6f 6e65 2e0a 0a20 2020  turns None...   
+00027ee0: 2020 2020 203a 7265 7475 726e 3a20 5468       :return: Th
+00027ef0: 6520 6c75 6d69 6e6f 7369 7479 2064 6973  e luminosity dis
+00027f00: 7461 6e63 6520 746f 2074 6865 2073 6f75  tance to the sou
+00027f10: 7263 652c 2063 616c 6375 6c61 7465 6420  rce, calculated 
+00027f20: 7573 696e 6720 7468 6520 636f 736d 6f6c  using the cosmol
+00027f30: 6f67 7920 6173 736f 6369 6174 6564 2077  ogy associated w
+00027f40: 6974 6820 7468 6973 2073 6f75 7263 652e  ith this source.
+00027f50: 0a20 2020 2020 2020 203a 7274 7970 653a  .        :rtype:
+00027f60: 2051 7561 6e74 6974 790a 2020 2020 2020   Quantity.      
+00027f70: 2020 2222 220a 2020 2020 2020 2020 7265    """.        re
+00027f80: 7475 726e 2073 656c 662e 5f6c 756d 5f64  turn self._lum_d
+00027f90: 6973 740a 0a20 2020 2040 7072 6f70 6572  ist..    @proper
+00027fa0: 7479 0a20 2020 2064 6566 2061 6e67 756c  ty.    def angul
+00027fb0: 6172 5f64 6961 6d65 7465 725f 6469 7374  ar_diameter_dist
+00027fc0: 616e 6365 2873 656c 6629 202d 3e20 5175  ance(self) -> Qu
+00027fd0: 616e 7469 7479 3a0a 2020 2020 2020 2020  antity:.        
+00027fe0: 2222 220a 2020 2020 2020 2020 5465 6c6c  """.        Tell
+00027ff0: 7320 7468 6520 7573 6572 2074 6865 2061  s the user the a
+00028000: 6e67 756c 6172 2064 6961 6d65 7465 7220  ngular diameter 
+00028010: 6469 7374 616e 6365 2074 6f20 7468 6520  distance to the 
+00028020: 736f 7572 6365 2069 6620 6120 7265 6473  source if a reds
+00028030: 6869 6674 2077 6173 2073 7570 706c 6965  hift was supplie
+00028040: 642c 2069 6620 6e6f 7420 7265 7475 726e  d, if not return
+00028050: 7320 4e6f 6e65 2e0a 0a20 2020 2020 2020  s None...       
+00028060: 203a 7265 7475 726e 3a20 5468 6520 616e   :return: The an
+00028070: 6775 6c61 7220 6469 616d 6574 6572 2064  gular diameter d
+00028080: 6973 7461 6e63 6520 746f 2074 6865 2073  istance to the s
+00028090: 6f75 7263 652c 2063 616c 6375 6c61 7465  ource, calculate
+000280a0: 6420 7573 696e 6720 7468 6520 636f 736d  d using the cosm
+000280b0: 6f6c 6f67 790a 2020 2020 2020 2020 2020  ology.          
+000280c0: 2020 6173 736f 6369 6174 6564 2077 6974    associated wit
+000280d0: 6820 7468 6973 2073 6f75 7263 652e 0a20  h this source.. 
+000280e0: 2020 2020 2020 203a 7274 7970 653a 2051         :rtype: Q
+000280f0: 7561 6e74 6974 790a 2020 2020 2020 2020  uantity.        
+00028100: 2222 220a 2020 2020 2020 2020 7265 7475  """.        retu
+00028110: 726e 2073 656c 662e 5f61 6e67 5f64 6961  rn self._ang_dia
+00028120: 6d5f 6469 7374 0a0a 2020 2020 4070 726f  m_dist..    @pro
+00028130: 7065 7274 790a 2020 2020 6465 6620 6261  perty.    def ba
+00028140: 636b 6772 6f75 6e64 5f72 6164 6975 735f  ckground_radius_
+00028150: 6661 6374 6f72 7328 7365 6c66 2920 2d3e  factors(self) ->
+00028160: 206e 6461 7272 6179 3a0a 2020 2020 2020   ndarray:.      
+00028170: 2020 2222 220a 2020 2020 2020 2020 5468    """.        Th
+00028180: 6520 6661 6374 6f72 7320 6279 2077 6869  e factors by whi
+00028190: 6368 2074 6f20 6d75 6c74 6970 6c79 206f  ch to multiply o
+000281a0: 7574 6572 2072 6164 6975 7320 6279 2074  uter radius by t
+000281b0: 6f20 6765 7420 696e 6e65 7220 616e 6420  o get inner and 
+000281c0: 6f75 7465 7220 7261 6469 6920 666f 7220  outer radii for 
+000281d0: 6261 636b 6772 6f75 6e64 2072 6567 696f  background regio
+000281e0: 6e73 2e0a 0a20 2020 2020 2020 203a 7265  ns...        :re
+000281f0: 7475 726e 3a20 416e 2061 7272 6179 206f  turn: An array o
+00028200: 6620 7468 6520 7477 6f20 6661 6374 6f72  f the two factor
+00028210: 732e 0a20 2020 2020 2020 203a 7274 7970  s..        :rtyp
+00028220: 653a 206e 6461 7272 6179 0a20 2020 2020  e: ndarray.     
+00028230: 2020 2022 2222 0a20 2020 2020 2020 2072     """.        r
+00028240: 6574 7572 6e20 6e70 2e61 7272 6179 285b  eturn np.array([
+00028250: 7365 6c66 2e5f 6261 636b 5f69 6e6e 5f66  self._back_inn_f
+00028260: 6163 746f 722c 2073 656c 662e 5f62 6163  actor, self._bac
+00028270: 6b5f 6f75 745f 6661 6374 6f72 5d29 0a0a  k_out_factor])..
+00028280: 2020 2020 6465 6620 6f62 735f 6368 6563      def obs_chec
+00028290: 6b28 7365 6c66 2c20 7265 675f 7479 7065  k(self, reg_type
+000282a0: 3a20 7374 722c 2074 6872 6573 686f 6c64  : str, threshold
+000282b0: 5f66 7261 6374 696f 6e3a 2066 6c6f 6174  _fraction: float
+000282c0: 203d 2030 2e35 2920 2d3e 2044 6963 743a   = 0.5) -> Dict:
+000282d0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+000282e0: 2020 2020 2054 6869 7320 6d65 7468 6f64       This method
+000282f0: 2075 7365 7320 6578 706f 7375 7265 206d   uses exposure m
+00028300: 6170 7320 616e 6420 7265 6769 6f6e 206d  aps and region m
+00028310: 6173 6b73 2074 6f20 6465 7465 726d 696e  asks to determin
+00028320: 6520 7768 6963 6820 4f62 7349 442f 696e  e which ObsID/in
+00028330: 7374 7275 6d65 6e74 2063 6f6d 6269 6e61  strument combina
+00028340: 7469 6f6e 730a 2020 2020 2020 2020 6172  tions.        ar
+00028350: 6520 6e6f 7420 636f 6e74 7269 6275 7469  e not contributi
+00028360: 6e67 2074 6f20 7468 6520 616e 616c 7973  ng to the analys
+00028370: 6973 2e20 4974 2063 616c 6375 6c61 7465  is. It calculate
+00028380: 7320 7468 6520 6172 6561 2069 6e74 6572  s the area inter
+00028390: 7365 6374 696f 6e20 6f66 2074 6865 206d  section of the m
+000283a0: 6173 6b20 616e 6420 6578 706f 7375 7265  ask and exposure
+000283b0: 0a20 2020 2020 2020 206d 6170 732c 2061  .        maps, a
+000283c0: 6e64 2069 6620 2866 6f72 2061 2067 6976  nd if (for a giv
+000283d0: 656e 204f 6273 4944 2d49 6e73 7472 756d  en ObsID-Instrum
+000283e0: 656e 7429 2074 6865 2072 6174 696f 206f  ent) the ratio o
+000283f0: 6620 7468 6174 2061 7265 6120 746f 2074  f that area to t
+00028400: 6865 2066 756c 6c20 6172 6561 206f 6620  he full area of 
+00028410: 7468 6520 7265 6769 6f6e 0a20 2020 2020  the region.     
+00028420: 2020 2063 616c 6375 6c61 7465 6420 6973     calculated is
+00028430: 206c 6573 7320 7468 616e 2074 6865 2074   less than the t
+00028440: 6872 6573 686f 6c64 2066 7261 6374 696f  hreshold fractio
+00028450: 6e2c 2074 6861 7420 4f62 7349 442d 696e  n, that ObsID-in
+00028460: 7374 7275 6d65 6e74 2077 696c 6c20 6265  strument will be
+00028470: 2069 6e63 6c75 6465 6420 696e 2074 6865   included in the
+00028480: 2072 6574 7572 6e65 640a 2020 2020 2020   returned.      
+00028490: 2020 7265 6a65 6374 696f 6e20 6469 6374    rejection dict
+000284a0: 696f 6e61 7279 2e0a 0a20 2020 2020 2020  ionary...       
+000284b0: 203a 7061 7261 6d20 7374 7220 7265 675f   :param str reg_
+000284c0: 7479 7065 3a20 5468 6520 7265 6769 6f6e  type: The region
+000284d0: 2074 7970 6520 666f 7220 7768 6963 6820   type for which 
+000284e0: 746f 2063 616c 6375 6c61 7465 2074 6865  to calculate the
+000284f0: 2061 7265 6120 696e 7465 7273 6563 7469   area intersecti
+00028500: 6f6e 2e0a 2020 2020 2020 2020 3a70 6172  on..        :par
+00028510: 616d 2066 6c6f 6174 2074 6872 6573 686f  am float thresho
+00028520: 6c64 5f66 7261 6374 696f 6e3a 2049 6e74  ld_fraction: Int
+00028530: 6572 7365 6374 696f 6e20 6172 6561 2f20  ersection area/ 
+00028540: 6675 6c6c 2072 6567 696f 6e20 6172 6561  full region area
+00028550: 2072 6174 696f 7320 6265 6c6f 7720 7468   ratios below th
+00028560: 6973 2076 616c 7565 2077 696c 6c20 6d65  is value will me
+00028570: 616e 2061 6e0a 2020 2020 2020 2020 2020  an an.          
+00028580: 2020 4f62 7349 442d 496e 7374 7275 6d65    ObsID-Instrume
+00028590: 6e74 2069 7320 7265 6a65 6374 6564 2e0a  nt is rejected..
+000285a0: 2020 2020 2020 2020 3a72 6574 7572 6e3a          :return:
+000285b0: 2041 2064 6963 7469 6f6e 6172 7920 6f66   A dictionary of
+000285c0: 204f 6273 4944 206b 6579 7320 6f6e 2074   ObsID keys on t
+000285d0: 6865 2074 6f70 206c 6576 656c 2c20 7468  he top level, th
+000285e0: 656e 2069 6e73 7472 756d 656e 7473 2061  en instruments a
+000285f0: 206c 6576 656c 2064 6f77 6e2c 2074 6861   level down, tha
+00028600: 740a 2020 2020 2020 2020 2020 2020 7368  t.            sh
+00028610: 6f75 6c64 2062 6520 7265 6a65 6374 6564  ould be rejected
+00028620: 2061 6363 6f72 6469 6e67 2074 6f20 7468   according to th
+00028630: 6520 6372 6974 6572 6961 2073 7570 706c  e criteria suppl
+00028640: 6965 6420 746f 2074 6869 7320 6d65 7468  ied to this meth
+00028650: 6f64 2e0a 2020 2020 2020 2020 3a72 7479  od..        :rty
+00028660: 7065 3a20 4469 6374 0a20 2020 2020 2020  pe: Dict.       
+00028670: 2022 2222 0a20 2020 2020 2020 2023 2041   """.        # A
+00028680: 6761 696e 2064 6f6e 2774 2070 6172 7469  gain don't parti
+00028690: 6375 6c61 726c 7920 7761 6e74 2074 6f20  cularly want to 
+000286a0: 646f 2074 6869 7320 6c6f 6361 6c20 696d  do this local im
+000286b0: 706f 7274 2c20 6275 7420 6974 7320 6a75  port, but its ju
+000286c0: 7374 2065 6173 6965 720a 2020 2020 2020  st easier.      
+000286d0: 2020 6672 6f6d 2078 6761 2e73 6173 2069    from xga.sas i
+000286e0: 6d70 6f72 7420 6565 7870 6d61 700a 0a20  mport eexpmap.. 
+000286f0: 2020 2020 2020 2023 2047 6f69 6e67 2074         # Going t
+00028700: 6f20 656e 7375 7265 2074 6861 7420 696e  o ensure that in
+00028710: 6469 7669 6475 616c 2065 7870 6f73 7572  dividual exposur
+00028720: 6520 6d61 7073 2065 7869 7374 2066 6f72  e maps exist for
+00028730: 2065 6163 6820 6f66 2074 6865 204f 6273   each of the Obs
+00028740: 4944 2f69 6e73 7472 756d 656e 7420 636f  ID/instrument co
+00028750: 6d62 696e 6174 696f 6e73 0a20 2020 2020  mbinations.     
+00028760: 2020 2023 2020 6669 7273 742c 2074 6865     #  first, the
+00028770: 6e20 6368 6563 6b69 6e67 2077 6865 7265  n checking where
+00028780: 2074 6865 2073 6f75 7263 6520 6c69 6573   the source lies
+00028790: 206f 6e20 7468 6520 6578 706f 7375 7265   on the exposure
+000287a0: 206d 6170 0a20 2020 2020 2020 2065 6578   map.        eex
+000287b0: 706d 6170 2873 656c 662c 2073 656c 662e  pmap(self, self.
+000287c0: 5f70 6561 6b5f 6c6f 5f65 6e2c 2073 656c  _peak_lo_en, sel
+000287d0: 662e 5f70 6561 6b5f 6869 5f65 6e29 0a0a  f._peak_hi_en)..
+000287e0: 2020 2020 2020 2020 6578 7472 615f 6b65          extra_ke
+000287f0: 7920 3d20 2262 6f75 6e64 5f7b 6c7d 2d7b  y = "bound_{l}-{
+00028800: 757d 222e 666f 726d 6174 286c 3d73 656c  u}".format(l=sel
+00028810: 662e 5f70 6561 6b5f 6c6f 5f65 6e2e 746f  f._peak_lo_en.to
+00028820: 2822 6b65 5622 292e 7661 6c75 652c 2075  ("keV").value, u
+00028830: 3d73 656c 662e 5f70 6561 6b5f 6869 5f65  =self._peak_hi_e
+00028840: 6e2e 746f 2822 6b65 5622 292e 7661 6c75  n.to("keV").valu
+00028850: 6529 0a0a 2020 2020 2020 2020 6172 6561  e)..        area
+00028860: 203d 207b 6f3a 207b 7d20 666f 7220 6f20   = {o: {} for o 
+00028870: 696e 2073 656c 662e 6f62 735f 6964 737d  in self.obs_ids}
+00028880: 0a20 2020 2020 2020 2066 756c 6c5f 6172  .        full_ar
+00028890: 6561 203d 207b 6f3a 207b 7d20 666f 7220  ea = {o: {} for 
+000288a0: 6f20 696e 2073 656c 662e 6f62 735f 6964  o in self.obs_id
+000288b0: 737d 0a20 2020 2020 2020 2066 6f72 206f  s}.        for o
+000288c0: 2069 6e20 7365 6c66 2e6f 6273 5f69 6473   in self.obs_ids
+000288d0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+000288e0: 4578 706f 7375 7265 206d 6170 7320 6f66  Exposure maps of
+000288f0: 2074 6865 2070 6561 6b20 6669 6e64 696e   the peak findin
+00028900: 6720 656e 6572 6779 2072 616e 6765 2066  g energy range f
+00028910: 6f72 2074 6869 7320 4f62 7349 440a 2020  or this ObsID.  
+00028920: 2020 2020 2020 2020 2020 6578 705f 6d61            exp_ma
+00028930: 7073 203d 2073 656c 662e 6765 745f 7072  ps = self.get_pr
+00028940: 6f64 7563 7473 2822 6578 706d 6170 222c  oducts("expmap",
+00028950: 206f 2c20 6578 7472 615f 6b65 793d 6578   o, extra_key=ex
+00028960: 7472 615f 6b65 7929 0a20 2020 2020 2020  tra_key).       
+00028970: 2020 2020 206d 203d 2073 656c 662e 6765       m = self.ge
+00028980: 745f 736f 7572 6365 5f6d 6173 6b28 7265  t_source_mask(re
+00028990: 675f 7479 7065 2c20 6f2c 2063 656e 7472  g_type, o, centr
+000289a0: 616c 5f63 6f6f 7264 3d73 656c 662e 5f64  al_coord=self._d
+000289b0: 6566 6175 6c74 5f63 6f6f 7264 295b 305d  efault_coord)[0]
+000289c0: 0a20 2020 2020 2020 2020 2020 2066 756c  .            ful
+000289d0: 6c5f 6172 6561 5b6f 5d20 3d20 6d2e 7375  l_area[o] = m.su
+000289e0: 6d28 290a 0a20 2020 2020 2020 2020 2020  m()..           
+000289f0: 2066 6f72 2065 7820 696e 2065 7870 5f6d   for ex in exp_m
+00028a00: 6170 733a 0a20 2020 2020 2020 2020 2020  aps:.           
+00028a10: 2020 2020 2023 2047 7261 6273 2065 7870       # Grabs exp
+00028a20: 6f73 7572 6520 6d61 7020 6461 7461 2c20  osure map data, 
+00028a30: 7468 656e 2061 6c74 6572 7320 6974 2073  then alters it s
+00028a40: 6f20 616e 7974 6869 6e67 2074 6861 7420  o anything that 
+00028a50: 6973 6e27 7420 7a65 726f 2069 7320 6120  isn't zero is a 
+00028a60: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+00028a70: 2020 2020 6578 5f64 6174 6120 3d20 6578      ex_data = ex
+00028a80: 2e64 6174 612e 636f 7079 2829 0a20 2020  .data.copy().   
+00028a90: 2020 2020 2020 2020 2020 2020 2065 785f               ex_
+00028aa0: 6461 7461 5b65 785f 6461 7461 203e 2030  data[ex_data > 0
+00028ab0: 5d20 3d20 310a 2020 2020 2020 2020 2020  ] = 1.          
+00028ac0: 2020 2020 2020 2320 5765 2064 6f20 7468        # We do th
+00028ad0: 6973 2062 6563 6175 7365 2069 7420 7468  is because it th
+00028ae0: 656e 2062 6563 6f6d 6573 2076 6572 7920  en becomes very 
+00028af0: 6561 7379 2074 6f20 6361 6c63 756c 6174  easy to calculat
+00028b00: 6520 7468 6520 696e 7465 7273 6563 7469  e the intersecti
+00028b10: 6f6e 2061 7265 6120 6f66 2074 6865 206d  on area of the m
+00028b20: 6173 6b0a 2020 2020 2020 2020 2020 2020  ask.            
+00028b30: 2020 2020 2320 2077 6974 6820 7468 6520      #  with the 
+00028b40: 584d 4d20 6368 6970 732e 204a 7573 7420  XMM chips. Just 
+00028b50: 6d61 736b 2074 6865 206d 6f64 6966 6965  mask the modifie
+00028b60: 6420 6578 706d 6170 2c20 7468 656e 2073  d expmap, then s
+00028b70: 756d 2e0a 2020 2020 2020 2020 2020 2020  um..            
+00028b80: 2020 2020 6172 6561 5b6f 5d5b 6578 2e69      area[o][ex.i
+00028b90: 6e73 7472 756d 656e 745d 203d 2028 6578  nstrument] = (ex
+00028ba0: 5f64 6174 6120 2a20 6d29 2e73 756d 2829  _data * m).sum()
+00028bb0: 0a0a 2020 2020 2020 2020 6966 206d 6178  ..        if max
+00028bc0: 286c 6973 7428 6675 6c6c 5f61 7265 612e  (list(full_area.
+00028bd0: 7661 6c75 6573 2829 2929 203d 3d20 303a  values())) == 0:
+00028be0: 0a20 2020 2020 2020 2020 2020 2023 2045  .            # E
+00028bf0: 7665 7279 7468 696e 6720 6861 7320 746f  verything has to
+00028c00: 2062 6520 7265 6a65 6374 6564 2069 6e20   be rejected in 
+00028c10: 7468 6973 2063 6173 650a 2020 2020 2020  this case.      
+00028c20: 2020 2020 2020 7265 6a65 6374 5f64 6963        reject_dic
+00028c30: 7420 3d20 6465 6570 636f 7079 2873 656c  t = deepcopy(sel
+00028c40: 662e 5f69 6e73 7472 756d 656e 7473 290a  f._instruments).
+00028c50: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00028c60: 2020 2020 2020 2020 2020 7265 6a65 6374            reject
+00028c70: 5f64 6963 7420 3d20 7b7d 0a20 2020 2020  _dict = {}.     
+00028c80: 2020 2020 2020 2066 6f72 206f 2069 6e20         for o in 
+00028c90: 6172 6561 3a0a 2020 2020 2020 2020 2020  area:.          
+00028ca0: 2020 2020 2020 666f 7220 6920 696e 2061        for i in a
+00028cb0: 7265 615b 6f5d 3a0a 2020 2020 2020 2020  rea[o]:.        
+00028cc0: 2020 2020 2020 2020 2020 2020 6966 2066              if f
+00028cd0: 756c 6c5f 6172 6561 5b6f 5d20 213d 2030  ull_area[o] != 0
+00028ce0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00028cf0: 2020 2020 2020 2020 2020 6672 6163 203d            frac =
+00028d00: 2028 6172 6561 5b6f 5d5b 695d 202f 2066   (area[o][i] / f
+00028d10: 756c 6c5f 6172 6561 5b6f 5d29 0a20 2020  ull_area[o]).   
+00028d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028d30: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00028d40: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00028d50: 7261 6320 3d20 300a 2020 2020 2020 2020  rac = 0.        
+00028d60: 2020 2020 2020 2020 2020 2020 6966 2066              if f
+00028d70: 7261 6320 3c3d 2074 6872 6573 686f 6c64  rac <= threshold
+00028d80: 5f66 7261 6374 696f 6e20 616e 6420 6f20  _fraction and o 
+00028d90: 6e6f 7420 696e 2072 656a 6563 745f 6469  not in reject_di
+00028da0: 6374 3a0a 2020 2020 2020 2020 2020 2020  ct:.            
+00028db0: 2020 2020 2020 2020 2020 2020 7265 6a65              reje
+00028dc0: 6374 5f64 6963 745b 6f5d 203d 205b 695d  ct_dict[o] = [i]
+00028dd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028de0: 2020 2020 2065 6c69 6620 6672 6163 203c       elif frac <
+00028df0: 3d20 7468 7265 7368 6f6c 645f 6672 6163  = threshold_frac
+00028e00: 7469 6f6e 2061 6e64 206f 2069 6e20 7265  tion and o in re
+00028e10: 6a65 6374 5f64 6963 743a 0a20 2020 2020  ject_dict:.     
+00028e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028e30: 2020 2072 656a 6563 745f 6469 6374 5b6f     reject_dict[o
+00028e40: 5d2e 6170 7065 6e64 2869 290a 0a20 2020  ].append(i)..   
+00028e50: 2020 2020 2072 6574 7572 6e20 7265 6a65       return reje
+00028e60: 6374 5f64 6963 740a 0a20 2020 2023 2041  ct_dict..    # A
+00028e70: 6e64 2068 6572 6520 4927 6d20 6164 6469  nd here I'm addi
+00028e80: 6e67 2061 2062 756e 6368 206f 6620 6765  ng a bunch of ge
+00028e90: 7420 6d65 7468 6f64 7320 7468 6174 2073  t methods that s
+00028ea0: 686f 756c 6420 6d65 616e 2074 6865 2075  hould mean the u
+00028eb0: 7365 7220 6e65 7665 7220 6861 7320 746f  ser never has to
+00028ec0: 2075 7365 2067 6574 5f70 726f 6475 6374   use get_product
+00028ed0: 732c 2066 6f72 0a20 2020 2023 2020 696e  s, for.    #  in
+00028ee0: 6469 7669 6475 616c 2070 726f 6475 6374  dividual product
+00028ef0: 2074 7970 6573 2e20 4974 2077 696c 6c20   types. It will 
+00028f00: 616c 736f 206d 6561 6e20 7468 6174 2074  also mean that t
+00028f10: 6865 7920 7769 6c6c 206e 6576 6572 2068  hey will never h
+00028f20: 6176 6520 746f 2066 6967 7572 6520 6f75  ave to figure ou
+00028f30: 7420 6578 7472 6120 6b65 7973 2074 6865  t extra keys the
+00028f40: 6d73 656c 7665 730a 2020 2020 2320 2061  mselves.    #  a
+00028f50: 6e64 2049 2063 616e 206d 616b 6520 6c69  nd I can make li
+00028f60: 7374 7320 6f66 2031 2070 726f 6475 6374  sts of 1 product
+00028f70: 2072 6574 7572 6e20 6a75 7374 2061 7320   return just as 
+00028f80: 7468 6520 7072 6f64 7563 7420 7769 7468  the product with
+00028f90: 6f75 7420 6265 696e 6720 6120 6272 6561  out being a brea
+00028fa0: 6b69 6e67 2063 6861 6e67 650a 2020 2020  king change.    
+00028fb0: 6465 6620 6765 745f 7370 6563 7472 6128  def get_spectra(
+00028fc0: 7365 6c66 2c20 6f75 7465 725f 7261 6469  self, outer_radi
+00028fd0: 7573 3a20 556e 696f 6e5b 7374 722c 2051  us: Union[str, Q
+00028fe0: 7561 6e74 6974 795d 2c20 6f62 735f 6964  uantity], obs_id
+00028ff0: 3a20 7374 7220 3d20 4e6f 6e65 2c20 696e  : str = None, in
+00029000: 7374 3a20 7374 7220 3d20 4e6f 6e65 2c0a  st: str = None,.
+00029010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029020: 2020 2020 696e 6e65 725f 7261 6469 7573      inner_radius
+00029030: 3a20 556e 696f 6e5b 7374 722c 2051 7561  : Union[str, Qua
+00029040: 6e74 6974 795d 203d 2051 7561 6e74 6974  ntity] = Quantit
+00029050: 7928 302c 2027 6172 6373 6563 2729 2c20  y(0, 'arcsec'), 
+00029060: 6772 6f75 705f 7370 6563 3a20 626f 6f6c  group_spec: bool
+00029070: 203d 2054 7275 652c 0a20 2020 2020 2020   = True,.       
+00029080: 2020 2020 2020 2020 2020 2020 206d 696e               min
+00029090: 5f63 6f75 6e74 733a 2069 6e74 203d 2035  _counts: int = 5
+000290a0: 2c20 6d69 6e5f 736e 3a20 666c 6f61 7420  , min_sn: float 
+000290b0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+000290c0: 2020 2020 2020 2020 2020 2020 6f76 6572              over
+000290d0: 5f73 616d 706c 653a 2066 6c6f 6174 203d  _sample: float =
+000290e0: 204e 6f6e 6529 202d 3e20 556e 696f 6e5b   None) -> Union[
+000290f0: 5370 6563 7472 756d 2c20 4c69 7374 5b53  Spectrum, List[S
+00029100: 7065 6374 7275 6d5d 5d3a 0a20 2020 2020  pectrum]]:.     
+00029110: 2020 2022 2222 0a20 2020 2020 2020 2041     """.        A
+00029120: 2075 7365 6675 6c20 6d65 7468 6f64 2074   useful method t
+00029130: 6861 7420 7772 6170 7320 7468 6520 6765  hat wraps the ge
+00029140: 745f 7072 6f64 7563 7473 2066 756e 6374  t_products funct
+00029150: 696f 6e20 746f 2061 6c6c 6f77 2079 6f75  ion to allow you
+00029160: 2074 6f20 6561 7369 6c79 2072 6574 7269   to easily retri
+00029170: 6576 6520 5847 4120 5370 6563 7472 756d  eve XGA Spectrum
+00029180: 206f 626a 6563 7473 2e0a 2020 2020 2020   objects..      
+00029190: 2020 5369 6d70 6c79 2070 6173 7320 7468    Simply pass th
+000291a0: 6520 6465 7369 7265 6420 4f62 7349 442f  e desired ObsID/
+000291b0: 696e 7374 7275 6d65 6e74 2c20 616e 6420  instrument, and 
+000291c0: 7468 6520 7361 6d65 2073 6574 7469 6e67  the same setting
+000291d0: 7320 796f 7520 7573 6564 2074 6f20 6765  s you used to ge
+000291e0: 6e65 7261 7465 2074 6865 2073 7065 6374  nerate the spect
+000291f0: 7275 6d0a 2020 2020 2020 2020 696e 2065  rum.        in e
+00029200: 7673 656c 6563 745f 7370 6563 7472 756d  vselect_spectrum
+00029210: 2c20 616e 6420 7468 6520 7370 6563 7472  , and the spectr
+00029220: 6128 756d 2920 7769 6c6c 2062 6520 7072  a(um) will be pr
+00029230: 6f76 6964 6564 2074 6f20 796f 752e 2049  ovided to you. I
+00029240: 6620 6e6f 206d 6174 6368 2069 7320 666f  f no match is fo
+00029250: 756e 6420 7468 656e 2061 0a20 2020 2020  und then a.     
+00029260: 2020 204e 6f50 726f 6475 6374 4176 6169     NoProductAvai
+00029270: 6c61 626c 6545 7272 6f72 2077 696c 6c20  lableError will 
+00029280: 6265 2072 6169 7365 642e 0a0a 2020 2020  be raised...    
+00029290: 2020 2020 3a70 6172 616d 2073 7472 2f51      :param str/Q
+000292a0: 7561 6e74 6974 7920 6f75 7465 725f 7261  uantity outer_ra
+000292b0: 6469 7573 3a20 5468 6520 6e61 6d65 206f  dius: The name o
+000292c0: 7220 7661 6c75 6520 6f66 2074 6865 206f  r value of the o
+000292d0: 7574 6572 2072 6164 6975 7320 7468 6174  uter radius that
+000292e0: 2077 6173 2075 7365 6420 666f 7220 7468   was used for th
+000292f0: 6520 6765 6e65 7261 7469 6f6e 206f 660a  e generation of.
+00029300: 2020 2020 2020 2020 2020 2020 7468 6520              the 
+00029310: 7370 6563 7472 756d 2028 666f 7220 696e  spectrum (for in
+00029320: 7374 616e 6365 2027 7232 3030 2720 776f  stance 'r200' wo
+00029330: 756c 6420 6265 2061 6363 6570 7461 626c  uld be acceptabl
+00029340: 6520 666f 7220 6120 4761 6c61 7879 436c  e for a GalaxyCl
+00029350: 7573 7465 722c 206f 7220 5175 616e 7469  uster, or Quanti
+00029360: 7479 2831 3030 302c 2027 6b70 6327 2929  ty(1000, 'kpc'))
+00029370: 2e20 4966 0a20 2020 2020 2020 2020 2020  . If.           
+00029380: 2027 7265 6769 6f6e 2720 6973 2063 686f   'region' is cho
+00029390: 7365 6e20 2874 6f20 7573 6520 7468 6520  sen (to use the 
+000293a0: 7265 6769 6f6e 7320 696e 2072 6567 696f  regions in regio
+000293b0: 6e20 6669 6c65 7329 2c20 7468 656e 2061  n files), then a
+000293c0: 6e79 2069 6e6e 6572 2072 6164 6975 7320  ny inner radius 
+000293d0: 7769 6c6c 2062 6520 6967 6e6f 7265 642e  will be ignored.
+000293e0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+000293f0: 7374 7220 6f62 735f 6964 3a20 4f70 7469  str obs_id: Opti
+00029400: 6f6e 616c 6c79 2c20 6120 7370 6563 6966  onally, a specif
+00029410: 6963 206f 6273 5f69 6420 746f 2073 6561  ic obs_id to sea
+00029420: 7263 6820 666f 7220 6361 6e20 6265 2073  rch for can be s
+00029430: 7570 706c 6965 642e 2054 6865 2064 6566  upplied. The def
+00029440: 6175 6c74 2069 7320 4e6f 6e65 2c0a 2020  ault is None,.  
+00029450: 2020 2020 2020 2020 2020 7768 6963 6820            which 
+00029460: 6d65 616e 7320 616c 6c20 7370 6563 7472  means all spectr
+00029470: 6120 6d61 7463 6869 6e67 2074 6865 206f  a matching the o
+00029480: 7468 6572 2063 7269 7465 7269 6120 7769  ther criteria wi
+00029490: 6c6c 2062 6520 7265 7475 726e 6564 2e0a  ll be returned..
+000294a0: 2020 2020 2020 2020 3a70 6172 616d 2073          :param s
+000294b0: 7472 2069 6e73 743a 204f 7074 696f 6e61  tr inst: Optiona
+000294c0: 6c6c 792c 2061 2073 7065 6369 6669 6320  lly, a specific 
+000294d0: 696e 7374 7275 6d65 6e74 2074 6f20 7365  instrument to se
+000294e0: 6172 6368 2066 6f72 2063 616e 2062 6520  arch for can be 
+000294f0: 7375 7070 6c69 6564 2e20 5468 6520 6465  supplied. The de
+00029500: 6661 756c 7420 6973 204e 6f6e 652c 0a20  fault is None,. 
+00029510: 2020 2020 2020 2020 2020 2077 6869 6368             which
+00029520: 206d 6561 6e73 2061 6c6c 2073 7065 6374   means all spect
+00029530: 7261 206d 6174 6368 696e 6720 7468 6520  ra matching the 
+00029540: 6f74 6865 7220 6372 6974 6572 6961 2077  other criteria w
+00029550: 696c 6c20 6265 2072 6574 7572 6e65 642e  ill be returned.
+00029560: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+00029570: 7374 722f 5175 616e 7469 7479 2069 6e6e  str/Quantity inn
+00029580: 6572 5f72 6164 6975 733a 2054 6865 206e  er_radius: The n
+00029590: 616d 6520 6f72 2076 616c 7565 206f 6620  ame or value of 
+000295a0: 7468 6520 696e 6e65 7220 7261 6469 7573  the inner radius
+000295b0: 2074 6861 7420 7761 7320 7573 6564 2066   that was used f
+000295c0: 6f72 2074 6865 2067 656e 6572 6174 696f  or the generatio
+000295d0: 6e20 6f66 0a20 2020 2020 2020 2020 2020  n of.           
+000295e0: 2074 6865 2073 7065 6374 7275 6d20 2866   the spectrum (f
+000295f0: 6f72 2069 6e73 7461 6e63 6520 2772 3530  or instance 'r50
+00029600: 3027 2077 6f75 6c64 2062 6520 6163 6365  0' would be acce
+00029610: 7074 6162 6c65 2066 6f72 2061 2047 616c  ptable for a Gal
+00029620: 6178 7943 6c75 7374 6572 2c20 6f72 2051  axyCluster, or Q
+00029630: 7561 6e74 6974 7928 3330 302c 2027 6b70  uantity(300, 'kp
+00029640: 6327 2929 2e20 4279 0a20 2020 2020 2020  c')). By.       
+00029650: 2020 2020 2064 6566 6175 6c74 2074 6869       default thi
+00029660: 7320 6973 207a 6572 6f20 6172 6373 6563  s is zero arcsec
+00029670: 6f6e 6473 2c20 7265 7375 6c74 696e 6720  onds, resulting 
+00029680: 696e 2061 2063 6972 6375 6c61 7220 7370  in a circular sp
+00029690: 6563 7472 756d 2e0a 2020 2020 2020 2020  ectrum..        
+000296a0: 3a70 6172 616d 2062 6f6f 6c20 6772 6f75  :param bool grou
+000296b0: 705f 7370 6563 3a20 5761 7320 7468 6520  p_spec: Was the 
+000296c0: 7370 6563 7472 756d 2079 6f75 2077 6973  spectrum you wis
+000296d0: 6820 746f 2072 6574 7269 6576 6520 6772  h to retrieve gr
+000296e0: 6f75 7065 643f 0a20 2020 2020 2020 203a  ouped?.        :
+000296f0: 7061 7261 6d20 666c 6f61 7420 6d69 6e5f  param float min_
+00029700: 636f 756e 7473 3a20 4966 2074 6865 2073  counts: If the s
+00029710: 7065 6374 7275 6d20 796f 7520 7769 7368  pectrum you wish
+00029720: 2074 6f20 7265 7472 6965 7665 2077 6173   to retrieve was
+00029730: 2067 726f 7570 6564 206f 6e20 6d69 6e69   grouped on mini
+00029740: 6d75 6d20 636f 756e 7473 2c20 7768 6174  mum counts, what
+00029750: 2077 6173 0a20 2020 2020 2020 2020 2020   was.           
+00029760: 2074 6865 206d 696e 696d 756d 206e 756d   the minimum num
+00029770: 6265 7220 6f66 2063 6f75 6e74 733f 0a20  ber of counts?. 
+00029780: 2020 2020 2020 203a 7061 7261 6d20 666c         :param fl
+00029790: 6f61 7420 6d69 6e5f 736e 3a20 4966 2074  oat min_sn: If t
+000297a0: 6865 2073 7065 6374 7275 6d20 796f 7520  he spectrum you 
+000297b0: 7769 7368 2074 6f20 7265 7472 6965 7665  wish to retrieve
+000297c0: 2077 6173 2067 726f 7570 6564 206f 6e20   was grouped on 
+000297d0: 6d69 6e69 6d75 6d20 7369 676e 616c 2074  minimum signal t
+000297e0: 6f20 6e6f 6973 652c 2077 6861 7420 7761  o noise, what wa
+000297f0: 730a 2020 2020 2020 2020 2020 2020 7468  s.            th
+00029800: 6520 6d69 6e69 6d75 6d20 7369 676e 616c  e minimum signal
+00029810: 2074 6f20 6e6f 6973 652e 0a20 2020 2020   to noise..     
+00029820: 2020 203a 7061 7261 6d20 666c 6f61 7420     :param float 
+00029830: 6f76 6572 5f73 616d 706c 653a 2049 6620  over_sample: If 
+00029840: 7468 6520 7370 6563 7472 756d 2079 6f75  the spectrum you
+00029850: 2077 6973 6820 746f 2072 6574 7269 6576   wish to retriev
+00029860: 6520 7761 7320 6f76 6572 2073 616d 706c  e was over sampl
+00029870: 6564 2c20 7768 6174 2077 6173 2074 6865  ed, what was the
+00029880: 206c 6576 656c 206f 660a 2020 2020 2020   level of.      
+00029890: 2020 2020 2020 6f76 6572 2073 616d 706c        over sampl
+000298a0: 696e 6720 7573 6564 3f0a 2020 2020 2020  ing used?.      
+000298b0: 2020 3a72 6574 7572 6e3a 2041 6e20 5847    :return: An XG
+000298c0: 4120 5370 6563 7472 756d 206f 626a 6563  A Spectrum objec
+000298d0: 7420 2869 6620 7468 6572 6520 6973 2061  t (if there is a
+000298e0: 6e20 6578 6163 7420 6d61 7463 6829 2c20  n exact match), 
+000298f0: 6f72 2061 206c 6973 7420 6f66 2058 4741  or a list of XGA
+00029900: 2053 7065 6374 7275 6d20 6f62 6a65 6374   Spectrum object
+00029910: 7320 2869 6620 7468 6572 650a 2020 2020  s (if there.    
+00029920: 2020 2020 2020 2020 7765 7265 206d 756c          were mul
+00029930: 7469 706c 6520 6d61 7463 6869 6e67 2070  tiple matching p
+00029940: 726f 6475 6374 7329 2e0a 2020 2020 2020  roducts)..      
+00029950: 2020 3a72 7479 7065 3a20 556e 696f 6e5b    :rtype: Union[
+00029960: 5370 6563 7472 756d 2c20 4c69 7374 5b53  Spectrum, List[S
+00029970: 7065 6374 7275 6d5d 5d0a 2020 2020 2020  pectrum]].      
+00029980: 2020 2222 220a 2020 2020 2020 2020 6966    """.        if
+00029990: 2069 7369 6e73 7461 6e63 6528 696e 6e65   isinstance(inne
+000299a0: 725f 7261 6469 7573 2c20 5175 616e 7469  r_radius, Quanti
+000299b0: 7479 293a 0a20 2020 2020 2020 2020 2020  ty):.           
+000299c0: 2069 6e6e 5f72 6164 5f6e 756d 203d 2073   inn_rad_num = s
+000299d0: 656c 662e 636f 6e76 6572 745f 7261 6469  elf.convert_radi
+000299e0: 7573 2869 6e6e 6572 5f72 6164 6975 732c  us(inner_radius,
+000299f0: 2027 6465 6727 290a 2020 2020 2020 2020   'deg').        
+00029a00: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
+00029a10: 696e 6e65 725f 7261 6469 7573 2c20 7374  inner_radius, st
+00029a20: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+00029a30: 696e 6e5f 7261 645f 6e75 6d20 3d20 7365  inn_rad_num = se
+00029a40: 6c66 2e67 6574 5f72 6164 6975 7328 696e  lf.get_radius(in
+00029a50: 6e65 725f 7261 6469 7573 2c20 2764 6567  ner_radius, 'deg
+00029a60: 2729 0a20 2020 2020 2020 2065 6c73 653a  ').        else:
+00029a70: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+00029a80: 7365 2054 7970 6545 7272 6f72 2822 596f  se TypeError("Yo
+00029a90: 7520 6d61 7920 6f6e 6c79 2070 6173 7320  u may only pass 
+00029aa0: 6120 7175 616e 7469 7479 206f 7220 6120  a quantity or a 
+00029ab0: 7374 7269 6e67 2061 7320 696e 6e65 725f  string as inner_
+00029ac0: 7261 6469 7573 2229 0a0a 2020 2020 2020  radius")..      
+00029ad0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+00029ae0: 6f75 7465 725f 7261 6469 7573 2c20 5175  outer_radius, Qu
+00029af0: 616e 7469 7479 293a 0a20 2020 2020 2020  antity):.       
+00029b00: 2020 2020 206f 7574 5f72 6164 5f6e 756d       out_rad_num
+00029b10: 203d 2073 656c 662e 636f 6e76 6572 745f   = self.convert_
+00029b20: 7261 6469 7573 286f 7574 6572 5f72 6164  radius(outer_rad
+00029b30: 6975 732c 2027 6465 6727 290a 2020 2020  ius, 'deg').    
+00029b40: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
+00029b50: 6e63 6528 6f75 7465 725f 7261 6469 7573  nce(outer_radius
+00029b60: 2c20 7374 7229 3a0a 2020 2020 2020 2020  , str):.        
+00029b70: 2020 2020 6f75 745f 7261 645f 6e75 6d20      out_rad_num 
+00029b80: 3d20 7365 6c66 2e67 6574 5f72 6164 6975  = self.get_radiu
+00029b90: 7328 6f75 7465 725f 7261 6469 7573 2c20  s(outer_radius, 
+00029ba0: 2764 6567 2729 0a20 2020 2020 2020 2065  'deg').        e
+00029bb0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00029bc0: 2072 6169 7365 2054 7970 6545 7272 6f72   raise TypeError
+00029bd0: 2822 596f 7520 6d61 7920 6f6e 6c79 2070  ("You may only p
+00029be0: 6173 7320 6120 7175 616e 7469 7479 206f  ass a quantity o
+00029bf0: 7220 6120 7374 7269 6e67 2061 7320 6f75  r a string as ou
+00029c00: 7465 725f 7261 6469 7573 2229 0a0a 2020  ter_radius")..  
+00029c10: 2020 2020 2020 6966 206f 7665 725f 7361        if over_sa
+00029c20: 6d70 6c65 2069 7320 6e6f 7420 4e6f 6e65  mple is not None
+00029c30: 3a0a 2020 2020 2020 2020 2020 2020 6f76  :.            ov
+00029c40: 6572 5f73 616d 706c 6520 3d20 696e 7428  er_sample = int(
+00029c50: 6f76 6572 5f73 616d 706c 6529 0a20 2020  over_sample).   
+00029c60: 2020 2020 2069 6620 6d69 6e5f 636f 756e       if min_coun
+00029c70: 7473 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ts is not None:.
+00029c80: 2020 2020 2020 2020 2020 2020 6d69 6e5f              min_
+00029c90: 636f 756e 7473 203d 2069 6e74 286d 696e  counts = int(min
+00029ca0: 5f63 6f75 6e74 7329 0a20 2020 2020 2020  _counts).       
+00029cb0: 2069 6620 6d69 6e5f 736e 2069 7320 6e6f   if min_sn is no
+00029cc0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00029cd0: 2020 2020 6d69 6e5f 736e 203d 2066 6c6f      min_sn = flo
+00029ce0: 6174 286d 696e 5f73 6e29 0a0a 2020 2020  at(min_sn)..    
+00029cf0: 2020 2020 2320 5365 7473 2075 7020 7468      # Sets up th
+00029d00: 6520 6578 7472 6120 7061 7274 206f 6620  e extra part of 
+00029d10: 7468 6520 7374 6f72 6167 6520 6b65 7920  the storage key 
+00029d20: 6e61 6d65 2064 6570 656e 6469 6e67 206f  name depending o
+00029d30: 6e20 6966 2067 726f 7570 696e 6720 6973  n if grouping is
+00029d40: 2065 6e61 626c 6564 0a20 2020 2020 2020   enabled.       
+00029d50: 2069 6620 6772 6f75 705f 7370 6563 2061   if group_spec a
+00029d60: 6e64 206d 696e 5f63 6f75 6e74 7320 6973  nd min_counts is
+00029d70: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00029d80: 2020 2020 2020 2065 7874 7261 5f6e 616d         extra_nam
+00029d90: 6520 3d20 225f 6d69 6e63 6e74 7b7d 222e  e = "_mincnt{}".
+00029da0: 666f 726d 6174 286d 696e 5f63 6f75 6e74  format(min_count
+00029db0: 7329 0a20 2020 2020 2020 2065 6c69 6620  s).        elif 
+00029dc0: 6772 6f75 705f 7370 6563 2061 6e64 206d  group_spec and m
+00029dd0: 696e 5f73 6e20 6973 206e 6f74 204e 6f6e  in_sn is not Non
+00029de0: 653a 0a20 2020 2020 2020 2020 2020 2065  e:.            e
+00029df0: 7874 7261 5f6e 616d 6520 3d20 225f 6d69  xtra_name = "_mi
+00029e00: 6e73 6e7b 7d22 2e66 6f72 6d61 7428 6d69  nsn{}".format(mi
+00029e10: 6e5f 736e 290a 2020 2020 2020 2020 656c  n_sn).        el
+00029e20: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00029e30: 6578 7472 615f 6e61 6d65 203d 2027 270a  extra_name = ''.
+00029e40: 0a20 2020 2020 2020 2023 2041 6e64 2069  .        # And i
+00029e50: 6620 6974 2077 6173 206f 7665 7273 616d  f it was oversam
+00029e60: 706c 6564 2064 7572 696e 6720 6765 6e65  pled during gene
+00029e70: 7261 7469 6f6e 2074 6865 6e20 7765 206e  ration then we n
+00029e80: 6565 6420 746f 2069 6e63 6c75 6465 2074  eed to include t
+00029e90: 6861 7420 6173 2077 656c 6c0a 2020 2020  hat as well.    
+00029ea0: 2020 2020 6966 206f 7665 725f 7361 6d70      if over_samp
+00029eb0: 6c65 2069 7320 6e6f 7420 4e6f 6e65 3a0a  le is not None:.
+00029ec0: 2020 2020 2020 2020 2020 2020 6578 7472              extr
+00029ed0: 615f 6e61 6d65 202b 3d20 225f 6f76 7361  a_name += "_ovsa
+00029ee0: 6d70 7b6f 767d 222e 666f 726d 6174 286f  mp{ov}".format(o
+00029ef0: 763d 6f76 6572 5f73 616d 706c 6529 0a0a  v=over_sample)..
+00029f00: 2020 2020 2020 2020 6966 206f 7574 6572          if outer
+00029f10: 5f72 6164 6975 7320 213d 2027 7265 6769  _radius != 'regi
+00029f20: 6f6e 273a 0a20 2020 2020 2020 2020 2020  on':.           
+00029f30: 2023 2054 6865 206b 6579 2075 6e64 6572   # The key under
+00029f40: 2077 6869 6368 2074 6865 7365 2073 7065   which these spe
+00029f50: 6374 7261 2077 696c 6c20 6265 2073 746f  ctra will be sto
+00029f60: 7265 640a 2020 2020 2020 2020 2020 2020  red.            
+00029f70: 7370 6563 5f73 746f 7261 6765 5f6e 616d  spec_storage_nam
+00029f80: 6520 3d20 2272 617b 7261 7d5f 6465 637b  e = "ra{ra}_dec{
+00029f90: 6465 637d 5f72 697b 7269 7d5f 726f 7b72  dec}_ri{ri}_ro{r
+00029fa0: 6f7d 5f67 7270 7b67 727d 220a 2020 2020  o}_grp{gr}".    
+00029fb0: 2020 2020 2020 2020 7370 6563 5f73 746f          spec_sto
+00029fc0: 7261 6765 5f6e 616d 6520 3d20 7370 6563  rage_name = spec
+00029fd0: 5f73 746f 7261 6765 5f6e 616d 652e 666f  _storage_name.fo
+00029fe0: 726d 6174 2872 613d 7365 6c66 2e64 6566  rmat(ra=self.def
+00029ff0: 6175 6c74 5f63 6f6f 7264 5b30 5d2e 7661  ault_coord[0].va
+0002a000: 6c75 652c 0a20 2020 2020 2020 2020 2020  lue,.           
+0002a010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a030: 2020 2020 2020 2020 2020 2020 2020 6465                de
+0002a040: 633d 7365 6c66 2e64 6566 6175 6c74 5f63  c=self.default_c
+0002a050: 6f6f 7264 5b31 5d2e 7661 6c75 652c 0a20  oord[1].value,. 
+0002a060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a090: 2020 2020 2020 2020 7269 3d69 6e6e 5f72          ri=inn_r
+0002a0a0: 6164 5f6e 756d 2e76 616c 7565 2c20 726f  ad_num.value, ro
+0002a0b0: 3d6f 7574 5f72 6164 5f6e 756d 2e76 616c  =out_rad_num.val
+0002a0c0: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
+0002a0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a0f0: 2020 2020 2020 2020 2020 2020 2067 723d               gr=
+0002a100: 6772 6f75 705f 7370 6563 290a 2020 2020  group_spec).    
+0002a110: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0002a120: 2020 2020 2020 7370 6563 5f73 746f 7261        spec_stora
+0002a130: 6765 5f6e 616d 6520 3d20 2272 6567 696f  ge_name = "regio
+0002a140: 6e5f 6772 707b 6772 7d22 2e66 6f72 6d61  n_grp{gr}".forma
+0002a150: 7428 6772 3d67 726f 7570 5f73 7065 6329  t(gr=group_spec)
+0002a160: 0a0a 2020 2020 2020 2020 2320 4164 6473  ..        # Adds
+0002a170: 206f 6e20 7468 6520 6578 7472 6120 696e   on the extra in
+0002a180: 666f 726d 6174 696f 6e20 6162 6f75 7420  formation about 
+0002a190: 6772 6f75 7069 6e67 2074 6f20 7468 6520  grouping to the 
+0002a1a0: 7374 6f72 6167 6520 6b65 790a 2020 2020  storage key.    
+0002a1b0: 2020 2020 7370 6563 5f73 746f 7261 6765      spec_storage
+0002a1c0: 5f6e 616d 6520 2b3d 2065 7874 7261 5f6e  _name += extra_n
+0002a1d0: 616d 650a 2020 2020 2020 2020 6d61 7463  ame.        matc
+0002a1e0: 6865 645f 7072 6f64 7320 3d20 7365 6c66  hed_prods = self
+0002a1f0: 2e67 6574 5f70 726f 6475 6374 7328 2773  .get_products('s
+0002a200: 7065 6374 7275 6d27 2c20 6f62 735f 6964  pectrum', obs_id
+0002a210: 3d6f 6273 5f69 642c 2069 6e73 743d 696e  =obs_id, inst=in
+0002a220: 7374 2c20 6578 7472 615f 6b65 793d 7370  st, extra_key=sp
+0002a230: 6563 5f73 746f 7261 6765 5f6e 616d 6529  ec_storage_name)
+0002a240: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
+0002a250: 6d61 7463 6865 645f 7072 6f64 7329 203d  matched_prods) =
+0002a260: 3d20 313a 0a20 2020 2020 2020 2020 2020  = 1:.           
+0002a270: 206d 6174 6368 6564 5f70 726f 6473 203d   matched_prods =
+0002a280: 206d 6174 6368 6564 5f70 726f 6473 5b30   matched_prods[0
+0002a290: 5d0a 2020 2020 2020 2020 656c 6966 206c  ].        elif l
+0002a2a0: 656e 286d 6174 6368 6564 5f70 726f 6473  en(matched_prods
+0002a2b0: 2920 3d3d 2030 3a0a 2020 2020 2020 2020  ) == 0:.        
+0002a2c0: 2020 2020 7261 6973 6520 4e6f 5072 6f64      raise NoProd
+0002a2d0: 7563 7441 7661 696c 6162 6c65 4572 726f  uctAvailableErro
+0002a2e0: 7228 2243 616e 6e6f 7420 6669 6e64 2061  r("Cannot find a
+0002a2f0: 6e79 2073 7065 6374 7261 206d 6174 6368  ny spectra match
+0002a300: 696e 6720 796f 7572 2069 6e70 7574 2e22  ing your input."
+0002a310: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+0002a320: 6e20 6d61 7463 6865 645f 7072 6f64 730a  n matched_prods.
+0002a330: 0a20 2020 2064 6566 2067 6574 5f61 6e6e  .    def get_ann
+0002a340: 756c 6172 5f73 7065 6374 7261 2873 656c  ular_spectra(sel
+0002a350: 662c 2072 6164 6969 3a20 5175 616e 7469  f, radii: Quanti
+0002a360: 7479 203d 204e 6f6e 652c 2067 726f 7570  ty = None, group
+0002a370: 5f73 7065 633a 2062 6f6f 6c20 3d20 5472  _spec: bool = Tr
+0002a380: 7565 2c20 6d69 6e5f 636f 756e 7473 3a20  ue, min_counts: 
+0002a390: 696e 7420 3d20 352c 0a20 2020 2020 2020  int = 5,.       
+0002a3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a3b0: 2020 2020 206d 696e 5f73 6e3a 2066 6c6f       min_sn: flo
+0002a3c0: 6174 203d 204e 6f6e 652c 206f 7665 725f  at = None, over_
+0002a3d0: 7361 6d70 6c65 3a20 666c 6f61 7420 3d20  sample: float = 
+0002a3e0: 4e6f 6e65 2c20 7365 745f 6964 3a20 696e  None, set_id: in
+0002a3f0: 7420 3d20 4e6f 6e65 2920 2d3e 2041 6e6e  t = None) -> Ann
+0002a400: 756c 6172 5370 6563 7472 613a 0a20 2020  ularSpectra:.   
+0002a410: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0002a420: 2041 6e6f 7468 6572 2075 7365 6675 6c20   Another useful 
+0002a430: 6d65 7468 6f64 2074 6861 7420 7772 6170  method that wrap
+0002a440: 7320 7468 6520 6765 745f 7072 6f64 7563  s the get_produc
+0002a450: 7473 2066 756e 6374 696f 6e2c 2074 686f  ts function, tho
+0002a460: 7567 6820 7468 6973 206f 6e65 2067 6574  ugh this one get
+0002a470: 7320 796f 7520 416e 6e75 6c61 7253 7065  s you AnnularSpe
+0002a480: 6374 7261 2e0a 2020 2020 2020 2020 5061  ctra..        Pa
+0002a490: 7373 2074 6865 2072 6164 6969 2075 7365  ss the radii use
+0002a4a0: 6420 746f 2067 656e 6572 6174 6520 7468  d to generate th
+0002a4b0: 6520 616e 6e75 6c69 2c20 616e 6420 7468  e annuli, and th
+0002a4c0: 6520 7361 6d65 2073 6574 7469 6e67 7320  e same settings 
+0002a4d0: 796f 7520 7573 6564 2074 6f20 6765 6e65  you used to gene
+0002a4e0: 7261 7465 2074 6865 2073 7065 6374 7275  rate the spectru
+0002a4f0: 6d0a 2020 2020 2020 2020 696e 2073 7065  m.        in spe
+0002a500: 6374 7275 6d5f 7365 742c 2061 6e64 2074  ctrum_set, and t
+0002a510: 6865 2041 6e6e 756c 6172 5370 6563 7472  he AnnularSpectr
+0002a520: 6120 7769 6c6c 2062 6520 7265 7475 726e  a will be return
+0002a530: 6564 2028 6966 2069 7420 6578 6973 7473  ed (if it exists
+0002a540: 292e 2049 6620 6e6f 206d 6174 6368 2069  ). If no match i
+0002a550: 7320 666f 756e 6420 7468 656e 0a20 2020  s found then.   
+0002a560: 2020 2020 2061 204e 6f50 726f 6475 6374       a NoProduct
+0002a570: 4176 6169 6c61 626c 6545 7272 6f72 2077  AvailableError w
+0002a580: 696c 6c20 6265 2072 6169 7365 642e 2054  ill be raised. T
+0002a590: 6869 7320 6d65 7468 6f64 2068 6173 2061  his method has a
+0002a5a0: 6e20 6164 6469 7469 6f6e 616c 2077 6179  n additional way
+0002a5b0: 206f 6620 6c6f 6f6b 696e 6720 666f 7220   of looking for 
+0002a5c0: 6120 6d61 7463 6869 6e67 0a20 2020 2020  a matching.     
+0002a5d0: 2020 2073 7065 6374 7275 6d2c 2069 6620     spectrum, if 
+0002a5e0: 7468 6520 7365 7420 4944 2069 7320 6b6e  the set ID is kn
+0002a5f0: 6f77 6e20 7468 656e 2074 6861 7420 6361  own then that ca
+0002a600: 6e20 6265 2070 6173 7365 6420 6279 2074  n be passed by t
+0002a610: 6865 2075 7365 7220 616e 6420 7573 6564  he user and used
+0002a620: 2074 6f20 6669 6e64 2061 6e20 6578 6163   to find an exac
+0002a630: 7420 6d61 7463 682e 0a0a 2020 2020 2020  t match...      
+0002a640: 2020 3a70 6172 616d 2051 7561 6e74 6974    :param Quantit
+0002a650: 7920 7261 6469 693a 2054 6865 2061 6e6e  y radii: The ann
+0002a660: 756c 7573 2062 6f75 6e64 6172 7920 7261  ulus boundary ra
+0002a670: 6469 6920 7468 6174 2077 6572 6520 7573  dii that were us
+0002a680: 6564 2074 6f20 6765 6e65 7261 7465 2074  ed to generate t
+0002a690: 6865 2061 6e6e 756c 6172 2073 7065 6374  he annular spect
+0002a6a0: 7261 2073 6574 0a20 2020 2020 2020 2020  ra set.         
+0002a6b0: 2020 2074 6861 7420 796f 7520 7769 7368     that you wish
+0002a6c0: 2074 6f20 7265 7472 6965 7665 2e20 4279   to retrieve. By
+0002a6d0: 2064 6566 6175 6c74 2074 6869 7320 6973   default this is
+0002a6e0: 204e 6f6e 652c 2077 6869 6368 206d 6561   None, which mea
+0002a6f0: 6e73 2074 6865 206d 6574 686f 6420 7769  ns the method wi
+0002a700: 6c6c 2072 6574 7572 6e20 616e 6e75 6c61  ll return annula
+0002a710: 720a 2020 2020 2020 2020 2020 2020 7370  r.            sp
+0002a720: 6563 7472 6120 7769 7468 2061 6e79 2072  ectra with any r
+0002a730: 6164 6969 2e0a 2020 2020 2020 2020 3a70  adii..        :p
+0002a740: 6172 616d 2062 6f6f 6c20 6772 6f75 705f  aram bool group_
+0002a750: 7370 6563 3a20 5761 7320 7468 6520 7370  spec: Was the sp
+0002a760: 6563 7472 756d 2073 6574 2079 6f75 2077  ectrum set you w
+0002a770: 6973 6820 746f 2072 6574 7269 6576 6520  ish to retrieve 
+0002a780: 6772 6f75 7065 643f 0a20 2020 2020 2020  grouped?.       
+0002a790: 203a 7061 7261 6d20 666c 6f61 7420 6d69   :param float mi
+0002a7a0: 6e5f 636f 756e 7473 3a20 4966 2074 6865  n_counts: If the
+0002a7b0: 2073 7065 6374 7275 6d20 7365 7420 796f   spectrum set yo
+0002a7c0: 7520 7769 7368 2074 6f20 7265 7472 6965  u wish to retrie
+0002a7d0: 7665 2077 6173 2067 726f 7570 6564 206f  ve was grouped o
+0002a7e0: 6e20 6d69 6e69 6d75 6d20 636f 756e 7473  n minimum counts
+0002a7f0: 2c20 7768 6174 2077 6173 0a20 2020 2020  , what was.     
+0002a800: 2020 2020 2020 2074 6865 206d 696e 696d         the minim
+0002a810: 756d 206e 756d 6265 7220 6f66 2063 6f75  um number of cou
+0002a820: 6e74 733f 0a20 2020 2020 2020 203a 7061  nts?.        :pa
+0002a830: 7261 6d20 666c 6f61 7420 6d69 6e5f 736e  ram float min_sn
+0002a840: 3a20 4966 2074 6865 2073 7065 6374 7275  : If the spectru
+0002a850: 6d20 7365 7420 796f 7520 7769 7368 2074  m set you wish t
+0002a860: 6f20 7265 7472 6965 7665 2077 6173 2067  o retrieve was g
+0002a870: 726f 7570 6564 206f 6e20 6d69 6e69 6d75  rouped on minimu
+0002a880: 6d20 7369 676e 616c 2074 6f0a 2020 2020  m signal to.    
+0002a890: 2020 2020 2020 2020 6e6f 6973 652c 2077          noise, w
+0002a8a0: 6861 7420 7761 7320 7468 6520 6d69 6e69  hat was the mini
+0002a8b0: 6d75 6d20 7369 676e 616c 2074 6f20 6e6f  mum signal to no
+0002a8c0: 6973 652e 0a20 2020 2020 2020 203a 7061  ise..        :pa
+0002a8d0: 7261 6d20 666c 6f61 7420 6f76 6572 5f73  ram float over_s
+0002a8e0: 616d 706c 653a 2049 6620 7468 6520 7370  ample: If the sp
+0002a8f0: 6563 7472 756d 2073 6574 2079 6f75 2077  ectrum set you w
+0002a900: 6973 6820 746f 2072 6574 7269 6576 6520  ish to retrieve 
+0002a910: 7761 7320 6f76 6572 2073 616d 706c 6564  was over sampled
+0002a920: 2c20 7768 6174 2077 6173 2074 6865 206c  , what was the l
+0002a930: 6576 656c 206f 660a 2020 2020 2020 2020  evel of.        
+0002a940: 2020 2020 6f76 6572 2073 616d 706c 696e      over samplin
+0002a950: 6720 7573 6564 3f0a 2020 2020 2020 2020  g used?.        
+0002a960: 3a70 6172 616d 2069 6e74 2073 6574 5f69  :param int set_i
+0002a970: 643a 2054 6865 2075 6e69 7175 6520 6964  d: The unique id
+0002a980: 656e 7469 6669 6572 206f 6620 7468 6520  entifier of the 
+0002a990: 616e 6e75 6c61 7220 7370 6563 7472 756d  annular spectrum
+0002a9a0: 2073 6574 2e20 5061 7373 696e 6720 6120   set. Passing a 
+0002a9b0: 7661 6c75 6520 666f 7220 7468 6973 2070  value for this p
+0002a9c0: 6172 616d 6574 6572 0a20 2020 2020 2020  arameter.       
+0002a9d0: 2020 2020 2077 696c 6c20 6f76 6572 7269       will overri
+0002a9e0: 6465 2061 6e79 206f 7468 6572 2069 6e66  de any other inf
+0002a9f0: 6f72 6d61 7469 6f6e 2074 6861 7420 796f  ormation that yo
+0002aa00: 7520 6861 7665 2067 6976 656e 2074 6869  u have given thi
+0002aa10: 7320 6d65 7468 6f64 2e0a 2020 2020 2020  s method..      
+0002aa20: 2020 3a72 6574 7572 6e3a 2041 6e20 5847    :return: An XG
+0002aa30: 4120 416e 6e75 6c61 7253 7065 6374 7261  A AnnularSpectra
+0002aa40: 206f 626a 6563 7420 6966 2074 6865 7265   object if there
+0002aa50: 2069 7320 616e 2065 7861 6374 206d 6174   is an exact mat
+0002aa60: 6368 2e0a 2020 2020 2020 2020 3a72 7479  ch..        :rty
+0002aa70: 7065 3a20 416e 6e75 6c61 7253 7065 6374  pe: AnnularSpect
+0002aa80: 7261 0a20 2020 2020 2020 2022 2222 0a20  ra.        """. 
+0002aa90: 2020 2020 2020 2069 6620 6772 6f75 705f         if group_
+0002aaa0: 7370 6563 2061 6e64 206d 696e 5f63 6f75  spec and min_cou
+0002aab0: 6e74 7320 6973 206e 6f74 204e 6f6e 653a  nts is not None:
+0002aac0: 0a20 2020 2020 2020 2020 2020 2065 7874  .            ext
+0002aad0: 7261 5f6e 616d 6520 3d20 225f 6d69 6e63  ra_name = "_minc
+0002aae0: 6e74 7b7d 222e 666f 726d 6174 286d 696e  nt{}".format(min
+0002aaf0: 5f63 6f75 6e74 7329 0a20 2020 2020 2020  _counts).       
+0002ab00: 2065 6c69 6620 6772 6f75 705f 7370 6563   elif group_spec
+0002ab10: 2061 6e64 206d 696e 5f73 6e20 6973 206e   and min_sn is n
+0002ab20: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+0002ab30: 2020 2020 2065 7874 7261 5f6e 616d 6520       extra_name 
+0002ab40: 3d20 225f 6d69 6e73 6e7b 7d22 2e66 6f72  = "_minsn{}".for
+0002ab50: 6d61 7428 6d69 6e5f 736e 290a 2020 2020  mat(min_sn).    
+0002ab60: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0002ab70: 2020 2020 2020 6578 7472 615f 6e61 6d65        extra_name
+0002ab80: 203d 2027 270a 0a20 2020 2020 2020 2023   = ''..        #
+0002ab90: 2041 6e64 2069 6620 6974 2077 6173 206f   And if it was o
+0002aba0: 7665 7273 616d 706c 6564 2064 7572 696e  versampled durin
+0002abb0: 6720 6765 6e65 7261 7469 6f6e 2074 6865  g generation the
+0002abc0: 6e20 7765 206e 6565 6420 746f 2069 6e63  n we need to inc
+0002abd0: 6c75 6465 2074 6861 7420 6173 2077 656c  lude that as wel
+0002abe0: 6c0a 2020 2020 2020 2020 6966 206f 7665  l.        if ove
+0002abf0: 725f 7361 6d70 6c65 2069 7320 6e6f 7420  r_sample is not 
+0002ac00: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0002ac10: 2020 6578 7472 615f 6e61 6d65 202b 3d20    extra_name += 
+0002ac20: 225f 6f76 7361 6d70 7b6f 767d 222e 666f  "_ovsamp{ov}".fo
+0002ac30: 726d 6174 286f 763d 6f76 6572 5f73 616d  rmat(ov=over_sam
+0002ac40: 706c 6529 0a0a 2020 2020 2020 2020 2320  ple)..        # 
+0002ac50: 436f 6d62 696e 6573 2074 6865 2061 6e6e  Combines the ann
+0002ac60: 756c 6172 2072 6164 6969 2069 6e74 6f20  ular radii into 
+0002ac70: 6120 7374 7269 6e67 2c20 616e 6420 6d61  a string, and ma
+0002ac80: 6b65 7320 7375 7265 2074 6865 2072 6164  kes sure the rad
+0002ac90: 6969 2061 7265 2069 6e20 6465 6772 6565  ii are in degree
+0002aca0: 732c 2061 7320 7261 6469 6920 6172 6520  s, as radii are 
+0002acb0: 696e 0a20 2020 2020 2020 2023 2020 6465  in.        #  de
+0002acc0: 6772 6565 7320 696e 2074 6865 2073 746f  grees in the sto
+0002acd0: 7261 6765 206b 6579 0a20 2020 2020 2020  rage key.       
+0002ace0: 2069 6620 7261 6469 6920 6973 206e 6f74   if radii is not
+0002acf0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0002ad00: 2020 2023 2057 6527 7265 2064 6561 6c69     # We're deali
+0002ad10: 6e67 2077 6974 6820 7468 6520 6265 7374  ng with the best
+0002ad20: 2063 6173 6520 6865 7265 2c20 7468 6520   case here, the 
+0002ad30: 7573 6572 2068 6173 2070 6173 7365 6420  user has passed 
+0002ad40: 7261 6469 692c 2073 6f20 7765 2063 616e  radii, so we can
+0002ad50: 2067 656e 6572 6174 6520 616e 2065 7861   generate an exa
+0002ad60: 6374 0a20 2020 2020 2020 2020 2020 2023  ct.            #
+0002ad70: 2020 7374 6f72 6167 6520 6b65 7920 616e    storage key an
+0002ad80: 6420 6c6f 6f6b 2066 6f72 2061 2073 696e  d look for a sin
+0002ad90: 676c 6520 6d61 7463 680a 2020 2020 2020  gle match.      
+0002ada0: 2020 2020 2020 616e 6e5f 7261 645f 7374        ann_rad_st
+0002adb0: 7220 3d20 225f 222e 6a6f 696e 2873 656c  r = "_".join(sel
+0002adc0: 662e 636f 6e76 6572 745f 7261 6469 7573  f.convert_radius
+0002add0: 2872 6164 6969 2c20 2764 6567 2729 2e76  (radii, 'deg').v
+0002ade0: 616c 7565 2e61 7374 7970 6528 7374 7229  alue.astype(str)
+0002adf0: 290a 2020 2020 2020 2020 2020 2020 7370  ).            sp
+0002ae00: 6563 5f73 746f 7261 6765 5f6e 616d 6520  ec_storage_name 
+0002ae10: 3d20 2272 617b 7261 7d5f 6465 637b 6465  = "ra{ra}_dec{de
+0002ae20: 637d 5f61 727b 6172 7d5f 6772 707b 6772  c}_ar{ar}_grp{gr
+0002ae30: 7d22 0a20 2020 2020 2020 2020 2020 2073  }".            s
+0002ae40: 7065 635f 7374 6f72 6167 655f 6e61 6d65  pec_storage_name
+0002ae50: 203d 2073 7065 635f 7374 6f72 6167 655f   = spec_storage_
+0002ae60: 6e61 6d65 2e66 6f72 6d61 7428 7261 3d73  name.format(ra=s
+0002ae70: 656c 662e 6465 6661 756c 745f 636f 6f72  elf.default_coor
+0002ae80: 645b 305d 2e76 616c 7565 2c0a 2020 2020  d[0].value,.    
+0002ae90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002aea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002aeb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002aec0: 2020 2020 2064 6563 3d73 656c 662e 6465       dec=self.de
+0002aed0: 6661 756c 745f 636f 6f72 645b 315d 2e76  fault_coord[1].v
+0002aee0: 616c 7565 2c0a 2020 2020 2020 2020 2020  alue,.          
+0002aef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002af00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002af10: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0002af20: 723d 616e 6e5f 7261 645f 7374 722c 2067  r=ann_rad_str, g
+0002af30: 723d 6772 6f75 705f 7370 6563 290a 2020  r=group_spec).  
+0002af40: 2020 2020 2020 2020 2020 7370 6563 5f73            spec_s
+0002af50: 746f 7261 6765 5f6e 616d 6520 2b3d 2065  torage_name += e
+0002af60: 7874 7261 5f6e 616d 650a 2020 2020 2020  xtra_name.      
+0002af70: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0002af80: 2020 2020 2320 5468 6973 2069 7320 6120      # This is a 
+0002af90: 776f 7273 6520 6361 7365 2c20 7765 2064  worse case, we d
+0002afa0: 6f6e 2774 2068 6176 6520 7261 6469 692c  on't have radii,
+0002afb0: 2073 6f20 7765 2073 706c 6974 2074 6865   so we split the
+0002afc0: 206b 6e6f 776e 2070 6172 7473 206f 6620   known parts of 
+0002afd0: 7468 6520 6b65 7920 696e 746f 2061 206c  the key into a l
+0002afe0: 6973 740a 2020 2020 2020 2020 2020 2020  ist.            
+0002aff0: 2320 2061 6e64 2077 6527 6c6c 206c 6f6f  #  and we'll loo
+0002b000: 6b20 666f 7220 7061 7274 6961 6c20 6d61  k for partial ma
+0002b010: 7463 6865 730a 2020 2020 2020 2020 2020  tches.          
+0002b020: 2020 706f 735f 7374 7220 3d20 2272 617b    pos_str = "ra{
+0002b030: 7261 7d5f 6465 637b 6465 637d 222e 666f  ra}_dec{dec}".fo
+0002b040: 726d 6174 2872 613d 7365 6c66 2e64 6566  rmat(ra=self.def
+0002b050: 6175 6c74 5f63 6f6f 7264 5b30 5d2e 7661  ault_coord[0].va
+0002b060: 6c75 652c 2064 6563 3d73 656c 662e 6465  lue, dec=self.de
+0002b070: 6661 756c 745f 636f 6f72 645b 315d 2e76  fault_coord[1].v
+0002b080: 616c 7565 290a 2020 2020 2020 2020 2020  alue).          
+0002b090: 2020 6772 705f 7374 7220 3d20 2267 7270    grp_str = "grp
+0002b0a0: 7b67 727d 222e 666f 726d 6174 2867 723d  {gr}".format(gr=
+0002b0b0: 6772 6f75 705f 7370 6563 2920 2b20 6578  group_spec) + ex
+0002b0c0: 7472 615f 6e61 6d65 0a20 2020 2020 2020  tra_name.       
+0002b0d0: 2020 2020 2073 7065 635f 7374 6f72 6167       spec_storag
+0002b0e0: 655f 6e61 6d65 203d 205b 706f 735f 7374  e_name = [pos_st
+0002b0f0: 722c 2067 7270 5f73 7472 5d0a 0a20 2020  r, grp_str]..   
+0002b100: 2020 2020 2023 2049 6620 7468 6520 7573       # If the us
+0002b110: 6572 2068 6173 6e27 7420 7061 7373 6564  er hasn't passed
+0002b120: 2061 2073 6574 2049 4420 414e 4420 7468   a set ID AND th
+0002b130: 6520 7573 6572 2068 6173 2070 6173 7365  e user has passe
+0002b140: 6420 7261 6469 6920 7468 656e 2077 6527  d radii then we'
+0002b150: 6c6c 2067 6f20 6c6f 6f6b 696e 6720 7769  ll go looking wi
+0002b160: 7468 206f 7574 0a20 2020 2020 2020 2023  th out.        #
+0002b170: 2020 7072 6f70 6572 6c79 2063 6f6e 7374    properly const
+0002b180: 7275 6374 6564 2073 746f 7261 6765 206b  ructed storage k
+0002b190: 6579 0a20 2020 2020 2020 2069 6620 7365  ey.        if se
+0002b1a0: 745f 6964 2069 7320 4e6f 6e65 2061 6e64  t_id is None and
+0002b1b0: 2072 6164 6969 2069 7320 6e6f 7420 4e6f   radii is not No
+0002b1c0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0002b1d0: 6d61 7463 6865 645f 7072 6f64 7320 3d20  matched_prods = 
+0002b1e0: 7365 6c66 2e67 6574 5f70 726f 6475 6374  self.get_product
+0002b1f0: 7328 2763 6f6d 6269 6e65 645f 7370 6563  s('combined_spec
+0002b200: 7472 756d 272c 2065 7874 7261 5f6b 6579  trum', extra_key
+0002b210: 3d73 7065 635f 7374 6f72 6167 655f 6e61  =spec_storage_na
+0002b220: 6d65 290a 2020 2020 2020 2020 2320 4275  me).        # Bu
+0002b230: 7420 6966 2074 6865 2075 7365 7220 6861  t if the user ha
+0002b240: 736e 2774 2070 6173 7365 6420 616e 2049  sn't passed an I
+0002b250: 4420 414e 4420 7468 6520 7261 6469 6920  D AND the radii 
+0002b260: 6172 6520 4e6f 6e65 2074 6865 6e20 7765  are None then we
+0002b270: 206c 6f6f 6b20 666f 7220 7061 7274 6961   look for partia
+0002b280: 6c20 6d61 7463 6865 730a 2020 2020 2020  l matches.      
+0002b290: 2020 656c 6966 2073 6574 5f69 6420 6973    elif set_id is
+0002b2a0: 204e 6f6e 6520 616e 6420 7261 6469 6920   None and radii 
+0002b2b0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+0002b2c0: 2020 2020 206d 6174 6368 6564 5f70 726f       matched_pro
+0002b2d0: 6473 203d 205b 7020 666f 7220 7020 696e  ds = [p for p in
+0002b2e0: 2073 656c 662e 6765 745f 7072 6f64 7563   self.get_produc
+0002b2f0: 7473 2827 636f 6d62 696e 6564 5f73 7065  ts('combined_spe
+0002b300: 6374 7275 6d27 290a 2020 2020 2020 2020  ctrum').        
+0002b310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b320: 2020 2020 2069 6620 7370 6563 5f73 746f       if spec_sto
+0002b330: 7261 6765 5f6e 616d 655b 305d 2069 6e20  rage_name[0] in 
+0002b340: 702e 7374 6f72 6167 655f 6b65 7920 616e  p.storage_key an
+0002b350: 6420 7370 6563 5f73 746f 7261 6765 5f6e  d spec_storage_n
+0002b360: 616d 655b 315d 2069 6e20 702e 7374 6f72  ame[1] in p.stor
+0002b370: 6167 655f 6b65 795d 0a20 2020 2020 2020  age_key].       
+0002b380: 2023 2048 6f77 6576 6572 2069 6620 7468   # However if th
+0002b390: 6579 2068 6176 6520 7061 7373 6564 2061  ey have passed a
+0002b3a0: 2073 6574 4944 2074 6865 6e20 7468 6973   setID then this
+0002b3b0: 206f 7665 722d 7269 6465 7320 6576 6572   over-rides ever
+0002b3c0: 7974 6869 6e67 2065 6c73 650a 2020 2020  ything else.    
+0002b3d0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0002b3e0: 2020 2020 2020 2320 5769 7468 2074 6865        # With the
+0002b3f0: 2073 6574 2049 4420 7765 2066 6574 6368   set ID we fetch
+0002b400: 2041 4c4c 2061 6e6e 756c 6172 2073 7065   ALL annular spe
+0002b410: 6374 7261 2c20 7468 656e 2075 7365 2074  ctra, then use t
+0002b420: 6865 6972 2073 6574 5f69 6420 7072 6f70  heir set_id prop
+0002b430: 6572 7479 2074 6f20 6d61 7463 6820 6167  erty to match ag
+0002b440: 6169 6e73 740a 2020 2020 2020 2020 2020  ainst.          
+0002b450: 2020 2320 2077 6861 7465 7665 7220 7468    #  whatever th
+0002b460: 6520 7573 6572 2070 6173 7365 6420 696e  e user passed in
+0002b470: 0a20 2020 2020 2020 2020 2020 206d 6174  .            mat
+0002b480: 6368 6564 5f70 726f 6473 203d 205b 7020  ched_prods = [p 
+0002b490: 666f 7220 7020 696e 2073 656c 662e 6765  for p in self.ge
+0002b4a0: 745f 7072 6f64 7563 7473 2827 636f 6d62  t_products('comb
+0002b4b0: 696e 6564 5f73 7065 6374 7275 6d27 2920  ined_spectrum') 
+0002b4c0: 6966 2070 2e73 6574 5f69 6465 6e74 203d  if p.set_ident =
+0002b4d0: 3d20 7365 745f 6964 5d0a 0a20 2020 2020  = set_id]..     
+0002b4e0: 2020 2069 6620 6c65 6e28 6d61 7463 6865     if len(matche
+0002b4f0: 645f 7072 6f64 7329 203d 3d20 313a 0a20  d_prods) == 1:. 
+0002b500: 2020 2020 2020 2020 2020 206d 6174 6368             match
+0002b510: 6564 5f70 726f 6473 203d 206d 6174 6368  ed_prods = match
+0002b520: 6564 5f70 726f 6473 5b30 5d0a 2020 2020  ed_prods[0].    
+0002b530: 2020 2020 656c 6966 206c 656e 286d 6174      elif len(mat
+0002b540: 6368 6564 5f70 726f 6473 2920 3d3d 2030  ched_prods) == 0
+0002b550: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+0002b560: 6973 6520 4e6f 5072 6f64 7563 7441 7661  ise NoProductAva
+0002b570: 696c 6162 6c65 4572 726f 7228 224e 6f20  ilableError("No 
+0002b580: 6d61 7463 6869 6e67 2041 6e6e 756c 6172  matching Annular
+0002b590: 5370 6563 7472 6120 6361 6e20 6265 2066  Spectra can be f
+0002b5a0: 6f75 6e64 2e22 290a 0a20 2020 2020 2020  ound.")..       
+0002b5b0: 2072 6574 7572 6e20 6d61 7463 6865 645f   return matched_
+0002b5c0: 7072 6f64 730a 0a20 2020 2064 6566 205f  prods..    def _
+0002b5d0: 6765 745f 7068 6f74 5f70 726f 6428 7365  get_phot_prod(se
+0002b5e0: 6c66 2c20 7072 6f64 5f74 7970 653a 2073  lf, prod_type: s
+0002b5f0: 7472 2c20 6f62 735f 6964 3a20 7374 7220  tr, obs_id: str 
+0002b600: 3d20 4e6f 6e65 2c20 696e 7374 3a20 7374  = None, inst: st
+0002b610: 7220 3d20 4e6f 6e65 2c20 6c6f 5f65 6e3a  r = None, lo_en:
+0002b620: 2051 7561 6e74 6974 7920 3d20 4e6f 6e65   Quantity = None
+0002b630: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002b640: 2020 2020 2020 2020 2068 695f 656e 3a20           hi_en: 
+0002b650: 5175 616e 7469 7479 203d 204e 6f6e 652c  Quantity = None,
+0002b660: 2070 7366 5f63 6f72 723a 2062 6f6f 6c20   psf_corr: bool 
+0002b670: 3d20 4661 6c73 652c 2070 7366 5f6d 6f64  = False, psf_mod
+0002b680: 656c 3a20 7374 7220 3d20 2245 4c4c 4245  el: str = "ELLBE
+0002b690: 5441 222c 0a20 2020 2020 2020 2020 2020  TA",.           
+0002b6a0: 2020 2020 2020 2020 2020 2020 7073 665f              psf_
+0002b6b0: 6269 6e73 3a20 696e 7420 3d20 342c 2070  bins: int = 4, p
+0002b6c0: 7366 5f61 6c67 6f3a 2073 7472 203d 2022  sf_algo: str = "
+0002b6d0: 726c 222c 2070 7366 5f69 7465 723a 2069  rl", psf_iter: i
+0002b6e0: 6e74 203d 2031 3529 205c 0a20 2020 2020  nt = 15) \.     
+0002b6f0: 2020 2020 2020 202d 3e20 556e 696f 6e5b         -> Union[
+0002b700: 496d 6167 652c 2045 7870 4d61 702c 2052  Image, ExpMap, R
+0002b710: 6174 654d 6170 2c20 4c69 7374 5b49 6d61  ateMap, List[Ima
+0002b720: 6765 5d2c 204c 6973 745b 4578 704d 6170  ge], List[ExpMap
+0002b730: 5d2c 204c 6973 745b 5261 7465 4d61 705d  ], List[RateMap]
+0002b740: 5d3a 0a20 2020 2020 2020 2022 2222 0a20  ]:.        """. 
+0002b750: 2020 2020 2020 2041 6e20 696e 7465 726e         An intern
+0002b760: 616c 206d 6574 686f 6420 7768 6963 6820  al method which 
+0002b770: 6973 2074 6865 2062 6173 6973 206f 6620  is the basis of 
+0002b780: 7468 6520 6765 745f 696d 6167 6573 2c20  the get_images, 
+0002b790: 6765 745f 6578 706d 6170 732c 2061 6e64  get_expmaps, and
+0002b7a0: 2067 6574 5f72 6174 656d 6170 7320 6d65   get_ratemaps me
+0002b7b0: 7468 6f64 732e 0a0a 2020 2020 2020 2020  thods...        
+0002b7c0: 3a70 6172 616d 2073 7472 206f 6273 5f69  :param str obs_i
+0002b7d0: 643a 204f 7074 696f 6e61 6c6c 792c 2061  d: Optionally, a
+0002b7e0: 2073 7065 6369 6669 6320 6f62 735f 6964   specific obs_id
+0002b7f0: 2074 6f20 7365 6172 6368 2066 6f72 2063   to search for c
+0002b800: 616e 2062 6520 7375 7070 6c69 6564 2e20  an be supplied. 
+0002b810: 5468 6520 6465 6661 756c 7420 6973 204e  The default is N
+0002b820: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+0002b830: 2077 6869 6368 206d 6561 6e73 2061 6c6c   which means all
+0002b840: 2069 6d61 6765 732f 6578 706d 6170 732f   images/expmaps/
+0002b850: 7261 7465 6d61 7073 206d 6174 6368 696e  ratemaps matchin
+0002b860: 6720 7468 6520 6f74 6865 7220 6372 6974  g the other crit
+0002b870: 6572 6961 2077 696c 6c20 6265 2072 6574  eria will be ret
+0002b880: 7572 6e65 642e 0a20 2020 2020 2020 203a  urned..        :
+0002b890: 7061 7261 6d20 7374 7220 696e 7374 3a20  param str inst: 
+0002b8a0: 4f70 7469 6f6e 616c 6c79 2c20 6120 7370  Optionally, a sp
+0002b8b0: 6563 6966 6963 2069 6e73 7472 756d 656e  ecific instrumen
+0002b8c0: 7420 746f 2073 6561 7263 6820 666f 7220  t to search for 
+0002b8d0: 6361 6e20 6265 2073 7570 706c 6965 642e  can be supplied.
+0002b8e0: 2054 6865 2064 6566 6175 6c74 2069 7320   The default is 
+0002b8f0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+0002b900: 2020 7768 6963 6820 6d65 616e 7320 616c    which means al
+0002b910: 6c20 696d 6167 6573 2f65 7870 6d61 7073  l images/expmaps
+0002b920: 2f72 6174 656d 6170 7320 6d61 7463 6869  /ratemaps matchi
+0002b930: 6e67 2074 6865 206f 7468 6572 2063 7269  ng the other cri
+0002b940: 7465 7269 6120 7769 6c6c 2062 6520 7265  teria will be re
+0002b950: 7475 726e 6564 2e0a 2020 2020 2020 2020  turned..        
+0002b960: 3a70 6172 616d 2051 7561 6e74 6974 7920  :param Quantity 
+0002b970: 6c6f 5f65 6e3a 2054 6865 206c 6f77 6572  lo_en: The lower
+0002b980: 2065 6e65 7267 7920 6c69 6d69 7420 6f66   energy limit of
+0002b990: 2074 6865 2069 6d61 6765 732f 6578 706d   the images/expm
+0002b9a0: 6170 732f 7261 7465 6d61 7073 2079 6f75  aps/ratemaps you
+0002b9b0: 2077 6973 6820 746f 0a20 2020 2020 2020   wish to.       
+0002b9c0: 2020 2020 2072 6574 7269 6576 652c 2074       retrieve, t
+0002b9d0: 6865 2064 6566 6175 6c74 2069 7320 4e6f  he default is No
+0002b9e0: 6e65 2028 7768 6963 6820 7769 6c6c 2072  ne (which will r
+0002b9f0: 6574 7269 6576 6520 616c 6c20 696d 6167  etrieve all imag
+0002ba00: 6573 2f65 7870 6d61 7073 2f72 6174 656d  es/expmaps/ratem
+0002ba10: 6170 7320 7265 6761 7264 6c65 7373 206f  aps regardless o
+0002ba20: 660a 2020 2020 2020 2020 2020 2020 656e  f.            en
+0002ba30: 6572 6779 206c 696d 6974 292e 0a20 2020  ergy limit)..   
+0002ba40: 2020 2020 203a 7061 7261 6d20 5175 616e       :param Quan
+0002ba50: 7469 7479 2068 695f 656e 3a20 5468 6520  tity hi_en: The 
+0002ba60: 7570 7065 7220 656e 6572 6779 206c 696d  upper energy lim
+0002ba70: 6974 206f 6620 7468 6520 696d 6167 6573  it of the images
+0002ba80: 2f65 7870 6d61 7073 2f72 6174 656d 6170  /expmaps/ratemap
+0002ba90: 7320 796f 7520 7769 7368 2074 6f0a 2020  s you wish to.  
+0002baa0: 2020 2020 2020 2020 2020 7265 7472 6965            retrie
+0002bab0: 7665 2c20 7468 6520 6465 6661 756c 7420  ve, the default 
+0002bac0: 6973 204e 6f6e 6520 2877 6869 6368 2077  is None (which w
+0002bad0: 696c 6c20 7265 7472 6965 7665 2061 6c6c  ill retrieve all
+0002bae0: 2069 6d61 6765 732f 6578 706d 6170 732f   images/expmaps/
+0002baf0: 7261 7465 6d61 7073 2072 6567 6172 646c  ratemaps regardl
+0002bb00: 6573 7320 6f66 0a20 2020 2020 2020 2020  ess of.         
+0002bb10: 2020 2065 6e65 7267 7920 6c69 6d69 7429     energy limit)
+0002bb20: 2e0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
+0002bb30: 2062 6f6f 6c20 7073 665f 636f 7272 3a20   bool psf_corr: 
+0002bb40: 5365 7473 2077 6865 7468 6572 2079 6f75  Sets whether you
+0002bb50: 2077 6973 6820 746f 2072 6574 7269 6576   wish to retriev
+0002bb60: 6520 6120 5053 4620 636f 7272 6563 7465  e a PSF correcte
+0002bb70: 6420 696d 6167 6573 2f72 6174 656d 6170  d images/ratemap
+0002bb80: 7320 6f72 206e 6f74 2e0a 2020 2020 2020  s or not..      
+0002bb90: 2020 3a70 6172 616d 2073 7472 2070 7366    :param str psf
+0002bba0: 5f6d 6f64 656c 3a20 4966 2074 6865 2069  _model: If the i
 0002bbb0: 6d61 6765 732f 7261 7465 6d61 7073 2079  mages/ratemaps y
 0002bbc0: 6f75 2077 616e 7420 6172 6520 5053 4620  ou want are PSF 
 0002bbd0: 636f 7272 6563 7465 642c 2074 6869 7320  corrected, this 
-0002bbe0: 6973 2074 6865 206e 756d 6265 7220 6f66  is the number of
-0002bbf0: 2069 7465 7261 7469 6f6e 732e 0a20 2020   iterations..   
-0002bc00: 2020 2020 203a 7265 7475 726e 3a20 416e       :return: An
-0002bc10: 2058 4741 2049 6d61 6765 2f52 6174 654d   XGA Image/RateM
-0002bc20: 6170 2f45 7870 4d61 7020 6f62 6a65 6374  ap/ExpMap object
-0002bc30: 2028 6966 2074 6865 7265 2069 7320 616e   (if there is an
-0002bc40: 2065 7861 6374 206d 6174 6368 292c 206f   exact match), o
-0002bc50: 7220 6120 6c69 7374 206f 6620 5847 410a  r a list of XGA.
-0002bc60: 2020 2020 2020 2020 2020 2020 496d 6167              Imag
-0002bc70: 652f 5261 7465 4d61 702f 4578 704d 6170  e/RateMap/ExpMap
-0002bc80: 206f 626a 6563 7473 2028 6966 2074 6865   objects (if the
-0002bc90: 7265 2077 6572 6520 6d75 6c74 6970 6c65  re were multiple
-0002bca0: 206d 6174 6368 696e 6720 7072 6f64 7563   matching produc
-0002bcb0: 7473 292e 0a20 2020 2020 2020 203a 7274  ts)..        :rt
-0002bcc0: 7970 653a 2055 6e69 6f6e 5b49 6d61 6765  ype: Union[Image
-0002bcd0: 2c20 4578 704d 6170 2c20 5261 7465 4d61  , ExpMap, RateMa
-0002bce0: 702c 204c 6973 745b 496d 6167 655d 2c20  p, List[Image], 
-0002bcf0: 4c69 7374 5b45 7870 4d61 705d 2c20 4c69  List[ExpMap], Li
-0002bd00: 7374 5b52 6174 654d 6170 5d5d 0a20 2020  st[RateMap]].   
-0002bd10: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-0002bd20: 2023 2043 6865 636b 7320 746f 206d 616b   # Checks to mak
-0002bd30: 6520 7375 7265 2074 6861 7420 616e 2061  e sure that an a
-0002bd40: 6c6c 6f77 6564 2063 6f6d 6269 6e61 7469  llowed combinati
-0002bd50: 6f6e 206f 6620 6c6f 5f65 6e20 616e 6420  on of lo_en and 
-0002bd60: 6869 5f65 6e20 6861 7320 6265 656e 2070  hi_en has been p
-0002bd70: 6173 7365 642e 0a20 2020 2020 2020 2069  assed..        i
-0002bd80: 6620 616c 6c28 5b6c 6f5f 656e 2069 7320  f all([lo_en is 
-0002bd90: 4e6f 6e65 2c20 6869 5f65 6e20 6973 204e  None, hi_en is N
-0002bda0: 6f6e 655d 293a 0a20 2020 2020 2020 2020  one]):.         
-0002bdb0: 2020 2023 2053 6574 7320 6120 666c 6167     # Sets a flag
-0002bdc0: 2074 6f20 7465 6c6c 2074 6865 2072 6573   to tell the res
-0002bdd0: 7420 6f66 2074 6865 206d 6574 686f 6420  t of the method 
-0002bde0: 7768 6574 6865 7220 7765 2068 6176 6520  whether we have 
-0002bdf0: 656e 6572 6779 206c 696d 7320 6f72 206e  energy lims or n
-0002be00: 6f74 0a20 2020 2020 2020 2020 2020 2077  ot.            w
-0002be10: 6974 685f 6c69 6d73 203d 2046 616c 7365  ith_lims = False
-0002be20: 0a20 2020 2020 2020 2020 2020 2065 6e65  .            ene
-0002be30: 7267 795f 6b65 7920 3d20 4e6f 6e65 0a20  rgy_key = None. 
-0002be40: 2020 2020 2020 2065 6c69 6620 616c 6c28         elif all(
-0002be50: 5b6c 6f5f 656e 2069 7320 6e6f 7420 4e6f  [lo_en is not No
-0002be60: 6e65 2c20 6869 5f65 6e20 6973 206e 6f74  ne, hi_en is not
-0002be70: 204e 6f6e 655d 293a 0a20 2020 2020 2020   None]):.       
-0002be80: 2020 2020 2077 6974 685f 6c69 6d73 203d       with_lims =
-0002be90: 2054 7275 650a 2020 2020 2020 2020 2020   True.          
-0002bea0: 2020 2320 5765 2068 6176 6520 656e 6572    # We have ener
-0002beb0: 6779 206c 696d 6974 7320 6865 7265 2073  gy limits here s
-0002bec0: 6f20 7765 2061 7373 656d 626c 6520 7468  o we assemble th
-0002bed0: 6520 6b65 7920 7468 6174 2064 6573 6372  e key that descr
-0002bee0: 6962 6573 2074 6865 2065 6e65 7267 7920  ibes the energy 
-0002bef0: 7261 6e67 650a 2020 2020 2020 2020 2020  range.          
-0002bf00: 2020 656e 6572 6779 5f6b 6579 203d 2022    energy_key = "
-0002bf10: 626f 756e 645f 7b6c 7d2d 7b68 7d22 2e66  bound_{l}-{h}".f
-0002bf20: 6f72 6d61 7428 6c3d 6c6f 5f65 6e2e 746f  ormat(l=lo_en.to
-0002bf30: 2827 6b65 5627 292e 7661 6c75 652c 2068  ('keV').value, h
-0002bf40: 3d68 695f 656e 2e74 6f28 276b 6556 2729  =hi_en.to('keV')
-0002bf50: 2e76 616c 7565 290a 2020 2020 2020 2020  .value).        
-0002bf60: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0002bf70: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
-0002bf80: 6f72 2822 6c6f 5f65 6e20 616e 6420 6869  or("lo_en and hi
-0002bf90: 5f65 6e20 6d75 7374 2062 6520 6569 7468  _en must be eith
-0002bfa0: 6572 2042 4f54 4820 4e6f 6e65 206f 7220  er BOTH None or 
-0002bfb0: 424f 5448 2061 6e20 4173 7472 6f70 7920  BOTH an Astropy 
-0002bfc0: 7175 616e 7469 7479 2e22 290a 0a20 2020  quantity.")..   
-0002bfd0: 2020 2020 2023 2049 6620 7765 2061 7265       # If we are
-0002bfe0: 206c 6f6f 6b69 6e67 2066 6f72 2061 2050   looking for a P
-0002bff0: 5346 2063 6f72 7265 6374 6564 2069 6d61  SF corrected ima
-0002c000: 6765 2f72 6174 656d 6170 2074 6865 6e20  ge/ratemap then 
-0002c010: 7765 2061 7373 656d 626c 6520 7468 6520  we assemble the 
-0002c020: 6578 7472 6120 6b65 7920 7769 7468 2050  extra key with P
-0002c030: 5346 2064 6574 6169 6c73 0a20 2020 2020  SF details.     
-0002c040: 2020 2069 6620 7073 665f 636f 7272 2061     if psf_corr a
-0002c050: 6e64 2070 726f 645f 7479 7065 2069 6e20  nd prod_type in 
-0002c060: 5b22 696d 6167 6522 2c20 2272 6174 656d  ["image", "ratem
-0002c070: 6170 225d 3a0a 2020 2020 2020 2020 2020  ap"]:.          
-0002c080: 2020 6578 7472 615f 6b65 7920 3d20 225f    extra_key = "_
-0002c090: 2220 2b20 7073 665f 6d6f 6465 6c20 2b20  " + psf_model + 
-0002c0a0: 225f 2220 2b20 7374 7228 7073 665f 6269  "_" + str(psf_bi
-0002c0b0: 6e73 2920 2b20 225f 2220 2b20 7073 665f  ns) + "_" + psf_
-0002c0c0: 616c 676f 202b 2073 7472 2870 7366 5f69  algo + str(psf_i
-0002c0d0: 7465 7229 0a0a 2020 2020 2020 2020 6966  ter)..        if
-0002c0e0: 206e 6f74 2070 7366 5f63 6f72 7220 616e   not psf_corr an
-0002c0f0: 6420 7769 7468 5f6c 696d 733a 0a20 2020  d with_lims:.   
-0002c100: 2020 2020 2020 2020 2023 2053 696d 706c           # Simpl
-0002c110: 6573 7420 6361 7365 2c20 6a75 7374 2063  est case, just c
-0002c120: 616c 6c69 6e67 2067 6574 5f70 726f 6475  alling get_produ
-0002c130: 6374 7320 616e 6420 7061 7373 696e 6720  cts and passing 
-0002c140: 696e 206f 7572 2069 6e66 6f72 6d61 7469  in our informati
-0002c150: 6f6e 0a20 2020 2020 2020 2020 2020 206d  on.            m
-0002c160: 6174 6368 6564 5f70 726f 6473 203d 2073  atched_prods = s
-0002c170: 656c 662e 6765 745f 7072 6f64 7563 7473  elf.get_products
-0002c180: 2870 726f 645f 7479 7065 2c20 6f62 735f  (prod_type, obs_
-0002c190: 6964 2c20 696e 7374 2c20 6578 7472 615f  id, inst, extra_
-0002c1a0: 6b65 793d 656e 6572 6779 5f6b 6579 290a  key=energy_key).
-0002c1b0: 2020 2020 2020 2020 656c 6966 206e 6f74          elif not
-0002c1c0: 2070 7366 5f63 6f72 7220 616e 6420 6e6f   psf_corr and no
-0002c1d0: 7420 7769 7468 5f6c 696d 733a 0a20 2020  t with_lims:.   
-0002c1e0: 2020 2020 2020 2020 2062 726f 6164 5f6d           broad_m
-0002c1f0: 6174 6368 6573 203d 2073 656c 662e 6765  atches = self.ge
-0002c200: 745f 7072 6f64 7563 7473 2870 726f 645f  t_products(prod_
-0002c210: 7479 7065 2c20 6f62 735f 6964 2c20 696e  type, obs_id, in
-0002c220: 7374 290a 2020 2020 2020 2020 2020 2020  st).            
-0002c230: 6d61 7463 6865 645f 7072 6f64 7320 3d20  matched_prods = 
-0002c240: 5b70 2066 6f72 2070 2069 6e20 6272 6f61  [p for p in broa
-0002c250: 645f 6d61 7463 6865 7320 6966 206e 6f74  d_matches if not
-0002c260: 2070 2e70 7366 5f63 6f72 7265 6374 6564   p.psf_corrected
-0002c270: 5d0a 2020 2020 2020 2020 656c 6966 2070  ].        elif p
-0002c280: 7366 5f63 6f72 7220 616e 6420 7769 7468  sf_corr and with
-0002c290: 5f6c 696d 733a 0a20 2020 2020 2020 2020  _lims:.         
-0002c2a0: 2020 2023 2048 6572 6520 7765 206e 6565     # Here we nee
-0002c2b0: 6420 746f 2061 6464 2074 6865 2065 7874  d to add the ext
-0002c2c0: 7261 206b 6579 2074 6f20 7468 6520 656e  ra key to the en
-0002c2d0: 6572 6779 206b 6579 0a20 2020 2020 2020  ergy key.       
-0002c2e0: 2020 2020 206d 6174 6368 6564 5f70 726f       matched_pro
-0002c2f0: 6473 203d 2073 656c 662e 6765 745f 7072  ds = self.get_pr
-0002c300: 6f64 7563 7473 2870 726f 645f 7479 7065  oducts(prod_type
-0002c310: 2c20 6f62 735f 6964 2c20 696e 7374 2c20  , obs_id, inst, 
-0002c320: 6578 7472 615f 6b65 793d 656e 6572 6779  extra_key=energy
-0002c330: 5f6b 6579 202b 2065 7874 7261 5f6b 6579  _key + extra_key
-0002c340: 290a 2020 2020 2020 2020 656c 6966 2070  ).        elif p
-0002c350: 7366 5f63 6f72 7220 616e 6420 6e6f 7420  sf_corr and not 
-0002c360: 7769 7468 5f6c 696d 733a 0a20 2020 2020  with_lims:.     
-0002c370: 2020 2020 2020 2023 2048 6572 6520 7765         # Here we
-0002c380: 2064 6f6e 2774 206b 6e6f 7720 7468 6520   don't know the 
-0002c390: 656e 6572 6779 206b 6579 2c20 736f 2077  energy key, so w
-0002c3a0: 6520 6861 7665 2074 6f20 6c6f 6f6b 2066  e have to look f
-0002c3b0: 6f72 2070 6172 7469 616c 206d 6174 6368  or partial match
-0002c3c0: 6573 2069 6e20 7468 6520 6765 745f 7072  es in the get_pr
-0002c3d0: 6f64 7563 7473 2072 6574 7572 6e0a 2020  oducts return.  
-0002c3e0: 2020 2020 2020 2020 2020 6272 6f61 645f            broad_
-0002c3f0: 6d61 7463 6865 7320 3d20 7365 6c66 2e67  matches = self.g
-0002c400: 6574 5f70 726f 6475 6374 7328 7072 6f64  et_products(prod
-0002c410: 5f74 7970 652c 206f 6273 5f69 642c 2069  _type, obs_id, i
-0002c420: 6e73 742c 2065 7874 7261 5f6b 6579 3d4e  nst, extra_key=N
-0002c430: 6f6e 652c 206a 7573 745f 6f62 6a3d 4661  one, just_obj=Fa
-0002c440: 6c73 6529 0a20 2020 2020 2020 2020 2020  lse).           
-0002c450: 206d 6174 6368 6564 5f70 726f 6473 203d   matched_prods =
-0002c460: 205b 705b 2d31 5d20 666f 7220 7020 696e   [p[-1] for p in
-0002c470: 2062 726f 6164 5f6d 6174 6368 6573 2069   broad_matches i
-0002c480: 6620 6578 7472 615f 6b65 7920 696e 2070  f extra_key in p
-0002c490: 5b2d 325d 5d0a 0a20 2020 2020 2020 2069  [-2]]..        i
-0002c4a0: 6620 6c65 6e28 6d61 7463 6865 645f 7072  f len(matched_pr
-0002c4b0: 6f64 7329 203d 3d20 313a 0a20 2020 2020  ods) == 1:.     
-0002c4c0: 2020 2020 2020 206d 6174 6368 6564 5f70         matched_p
-0002c4d0: 726f 6473 203d 206d 6174 6368 6564 5f70  rods = matched_p
-0002c4e0: 726f 6473 5b30 5d0a 2020 2020 2020 2020  rods[0].        
-0002c4f0: 656c 6966 206c 656e 286d 6174 6368 6564  elif len(matched
-0002c500: 5f70 726f 6473 2920 3d3d 2030 3a0a 2020  _prods) == 0:.  
-0002c510: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0002c520: 4e6f 5072 6f64 7563 7441 7661 696c 6162  NoProductAvailab
-0002c530: 6c65 4572 726f 7228 2243 616e 6e6f 7420  leError("Cannot 
-0002c540: 6669 6e64 2061 6e79 207b 707d 7320 6d61  find any {p}s ma
-0002c550: 7463 6869 6e67 2079 6f75 7220 696e 7075  tching your inpu
-0002c560: 742e 222e 666f 726d 6174 2870 3d70 726f  t.".format(p=pro
-0002c570: 645f 7479 7065 2929 0a0a 2020 2020 2020  d_type))..      
-0002c580: 2020 7265 7475 726e 206d 6174 6368 6564    return matched
-0002c590: 5f70 726f 6473 0a0a 2020 2020 6465 6620  _prods..    def 
-0002c5a0: 6765 745f 696d 6167 6573 2873 656c 662c  get_images(self,
-0002c5b0: 206f 6273 5f69 643a 2073 7472 203d 204e   obs_id: str = N
-0002c5c0: 6f6e 652c 2069 6e73 743a 2073 7472 203d  one, inst: str =
-0002c5d0: 204e 6f6e 652c 206c 6f5f 656e 3a20 5175   None, lo_en: Qu
-0002c5e0: 616e 7469 7479 203d 204e 6f6e 652c 2068  antity = None, h
-0002c5f0: 695f 656e 3a20 5175 616e 7469 7479 203d  i_en: Quantity =
-0002c600: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
-0002c610: 2020 2020 2020 2020 2020 7073 665f 636f            psf_co
-0002c620: 7272 3a20 626f 6f6c 203d 2046 616c 7365  rr: bool = False
-0002c630: 2c20 7073 665f 6d6f 6465 6c3a 2073 7472  , psf_model: str
-0002c640: 203d 2022 454c 4c42 4554 4122 2c20 7073   = "ELLBETA", ps
-0002c650: 665f 6269 6e73 3a20 696e 7420 3d20 342c  f_bins: int = 4,
-0002c660: 2070 7366 5f61 6c67 6f3a 2073 7472 203d   psf_algo: str =
-0002c670: 2022 726c 222c 0a20 2020 2020 2020 2020   "rl",.         
-0002c680: 2020 2020 2020 2020 2020 7073 665f 6974            psf_it
-0002c690: 6572 3a20 696e 7420 3d20 3135 2920 2d3e  er: int = 15) ->
-0002c6a0: 2055 6e69 6f6e 5b49 6d61 6765 2c20 4c69   Union[Image, Li
-0002c6b0: 7374 5b49 6d61 6765 5d5d 3a0a 2020 2020  st[Image]]:.    
-0002c6c0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0002c6d0: 4120 6d65 7468 6f64 2074 6f20 7265 7472  A method to retr
-0002c6e0: 6965 7665 2058 4741 2049 6d61 6765 206f  ieve XGA Image o
-0002c6f0: 626a 6563 7473 2e20 5468 6973 2073 7570  bjects. This sup
-0002c700: 706f 7274 7320 7468 6520 7265 7472 6965  ports the retrie
-0002c710: 7661 6c20 6f66 2062 6f74 6820 5053 4620  val of both PSF 
-0002c720: 636f 7272 6563 7465 6420 616e 6420 6e6f  corrected and no
-0002c730: 6e2d 5053 460a 2020 2020 2020 2020 636f  n-PSF.        co
-0002c740: 7272 6563 7465 6420 696d 6167 6573 2c20  rrected images, 
-0002c750: 6173 2077 656c 6c20 6173 2073 6574 7469  as well as setti
-0002c760: 6e67 2074 6865 2065 6e65 7267 7920 6c69  ng the energy li
-0002c770: 6d69 7473 206f 6620 7468 6520 7370 6563  mits of the spec
-0002c780: 6966 6963 2069 6d61 6765 2079 6f75 2077  ific image you w
-0002c790: 6f75 6c64 206c 696b 652e 2041 0a20 2020  ould like. A.   
-0002c7a0: 2020 2020 204e 6f50 726f 6475 6374 4176       NoProductAv
-0002c7b0: 6169 6c61 626c 6545 7272 6f72 2065 7272  ailableError err
-0002c7c0: 6f72 2077 696c 6c20 6265 2072 6169 7365  or will be raise
-0002c7d0: 6420 6966 206e 6f20 6d61 7463 6865 7320  d if no matches 
-0002c7e0: 6172 6520 666f 756e 642e 0a0a 2020 2020  are found...    
-0002c7f0: 2020 2020 3a70 6172 616d 2073 7472 206f      :param str o
-0002c800: 6273 5f69 643a 204f 7074 696f 6e61 6c6c  bs_id: Optionall
-0002c810: 792c 2061 2073 7065 6369 6669 6320 6f62  y, a specific ob
-0002c820: 735f 6964 2074 6f20 7365 6172 6368 2066  s_id to search f
-0002c830: 6f72 2063 616e 2062 6520 7375 7070 6c69  or can be suppli
-0002c840: 6564 2e20 5468 6520 6465 6661 756c 7420  ed. The default 
-0002c850: 6973 204e 6f6e 652c 0a20 2020 2020 2020  is None,.       
-0002c860: 2020 2020 2077 6869 6368 206d 6561 6e73       which means
-0002c870: 2061 6c6c 2069 6d61 6765 7320 6d61 7463   all images matc
-0002c880: 6869 6e67 2074 6865 206f 7468 6572 2063  hing the other c
-0002c890: 7269 7465 7269 6120 7769 6c6c 2062 6520  riteria will be 
-0002c8a0: 7265 7475 726e 6564 2e0a 2020 2020 2020  returned..      
-0002c8b0: 2020 3a70 6172 616d 2073 7472 2069 6e73    :param str ins
-0002c8c0: 743a 204f 7074 696f 6e61 6c6c 792c 2061  t: Optionally, a
-0002c8d0: 2073 7065 6369 6669 6320 696e 7374 7275   specific instru
-0002c8e0: 6d65 6e74 2074 6f20 7365 6172 6368 2066  ment to search f
-0002c8f0: 6f72 2063 616e 2062 6520 7375 7070 6c69  or can be suppli
-0002c900: 6564 2e20 5468 6520 6465 6661 756c 7420  ed. The default 
-0002c910: 6973 204e 6f6e 652c 0a20 2020 2020 2020  is None,.       
-0002c920: 2020 2020 2077 6869 6368 206d 6561 6e73       which means
-0002c930: 2061 6c6c 2069 6d61 6765 7320 6d61 7463   all images matc
-0002c940: 6869 6e67 2074 6865 206f 7468 6572 2063  hing the other c
-0002c950: 7269 7465 7269 6120 7769 6c6c 2062 6520  riteria will be 
-0002c960: 7265 7475 726e 6564 2e0a 2020 2020 2020  returned..      
-0002c970: 2020 3a70 6172 616d 2051 7561 6e74 6974    :param Quantit
-0002c980: 7920 6c6f 5f65 6e3a 2054 6865 206c 6f77  y lo_en: The low
-0002c990: 6572 2065 6e65 7267 7920 6c69 6d69 7420  er energy limit 
-0002c9a0: 6f66 2074 6865 2069 6d61 6765 2079 6f75  of the image you
-0002c9b0: 2077 6973 6820 746f 2072 6574 7269 6576   wish to retriev
-0002c9c0: 652c 2074 6865 2064 6566 6175 6c74 0a20  e, the default. 
-0002c9d0: 2020 2020 2020 2020 2020 2069 7320 4e6f             is No
-0002c9e0: 6e65 2028 7768 6963 6820 7769 6c6c 2072  ne (which will r
-0002c9f0: 6574 7269 6576 6520 616c 6c20 696d 6167  etrieve all imag
-0002ca00: 6573 2072 6567 6172 646c 6573 7320 6f66  es regardless of
-0002ca10: 2065 6e65 7267 7920 6c69 6d69 7429 2e0a   energy limit)..
-0002ca20: 2020 2020 2020 2020 3a70 6172 616d 2051          :param Q
-0002ca30: 7561 6e74 6974 7920 6869 5f65 6e3a 2054  uantity hi_en: T
-0002ca40: 6865 2075 7070 6572 2065 6e65 7267 7920  he upper energy 
-0002ca50: 6c69 6d69 7420 6f66 2074 6865 2069 6d61  limit of the ima
-0002ca60: 6765 2079 6f75 2077 6973 6820 746f 2072  ge you wish to r
-0002ca70: 6574 7269 6576 652c 2074 6865 2064 6566  etrieve, the def
-0002ca80: 6175 6c74 0a20 2020 2020 2020 2020 2020  ault.           
-0002ca90: 2069 7320 4e6f 6e65 2028 7768 6963 6820   is None (which 
-0002caa0: 7769 6c6c 2072 6574 7269 6576 6520 616c  will retrieve al
-0002cab0: 6c20 696d 6167 6573 2072 6567 6172 646c  l images regardl
-0002cac0: 6573 7320 6f66 2065 6e65 7267 7920 6c69  ess of energy li
-0002cad0: 6d69 7429 2e0a 2020 2020 2020 2020 3a70  mit)..        :p
-0002cae0: 6172 616d 2062 6f6f 6c20 7073 665f 636f  aram bool psf_co
-0002caf0: 7272 3a20 5365 7473 2077 6865 7468 6572  rr: Sets whether
-0002cb00: 2079 6f75 2077 6973 6820 746f 2072 6574   you wish to ret
-0002cb10: 7269 6576 6520 6120 5053 4620 636f 7272  rieve a PSF corr
-0002cb20: 6563 7465 6420 696d 6167 6520 6f72 206e  ected image or n
-0002cb30: 6f74 2e0a 2020 2020 2020 2020 3a70 6172  ot..        :par
-0002cb40: 616d 2073 7472 2070 7366 5f6d 6f64 656c  am str psf_model
-0002cb50: 3a20 4966 2074 6865 2069 6d61 6765 2079  : If the image y
-0002cb60: 6f75 2077 616e 7420 6973 2050 5346 2063  ou want is PSF c
-0002cb70: 6f72 7265 6374 6564 2c20 7468 6973 2069  orrected, this i
-0002cb80: 7320 7468 6520 5053 4620 6d6f 6465 6c20  s the PSF model 
-0002cb90: 7573 6564 2e0a 2020 2020 2020 2020 3a70  used..        :p
-0002cba0: 6172 616d 2069 6e74 2070 7366 5f62 696e  aram int psf_bin
-0002cbb0: 733a 2049 6620 7468 6520 696d 6167 6520  s: If the image 
-0002cbc0: 796f 7520 7761 6e74 2069 7320 5053 4620  you want is PSF 
-0002cbd0: 636f 7272 6563 7465 642c 2074 6869 7320  corrected, this 
-0002cbe0: 6973 2074 6865 206e 756d 6265 7220 6f66  is the number of
-0002cbf0: 2050 5346 7320 7065 720a 2020 2020 2020   PSFs per.      
-0002cc00: 2020 2020 2020 7369 6465 2069 6e20 7468        side in th
-0002cc10: 6520 5053 4620 6772 6964 2e0a 2020 2020  e PSF grid..    
-0002cc20: 2020 2020 3a70 6172 616d 2073 7472 2070      :param str p
-0002cc30: 7366 5f61 6c67 6f3a 2049 6620 7468 6520  sf_algo: If the 
-0002cc40: 696d 6167 6520 796f 7520 7761 6e74 2069  image you want i
-0002cc50: 7320 5053 4620 636f 7272 6563 7465 642c  s PSF corrected,
-0002cc60: 2074 6869 7320 6973 2074 6865 2061 6c67   this is the alg
-0002cc70: 6f72 6974 686d 2075 7365 642e 0a20 2020  orithm used..   
-0002cc80: 2020 2020 203a 7061 7261 6d20 696e 7420       :param int 
-0002cc90: 7073 665f 6974 6572 3a20 4966 2074 6865  psf_iter: If the
-0002cca0: 2069 6d61 6765 2079 6f75 2077 616e 7420   image you want 
-0002ccb0: 6973 2050 5346 2063 6f72 7265 6374 6564  is PSF corrected
-0002ccc0: 2c20 7468 6973 2069 7320 7468 6520 6e75  , this is the nu
-0002ccd0: 6d62 6572 206f 6620 6974 6572 6174 696f  mber of iteratio
-0002cce0: 6e73 2e0a 2020 2020 2020 2020 3a72 6574  ns..        :ret
-0002ccf0: 7572 6e3a 2041 6e20 5847 4120 496d 6167  urn: An XGA Imag
-0002cd00: 6520 6f62 6a65 6374 2028 6966 2074 6865  e object (if the
-0002cd10: 7265 2069 7320 616e 2065 7861 6374 206d  re is an exact m
-0002cd20: 6174 6368 292c 206f 7220 6120 6c69 7374  atch), or a list
-0002cd30: 206f 6620 5847 4120 496d 6167 6520 6f62   of XGA Image ob
-0002cd40: 6a65 6374 7320 2869 6620 7468 6572 650a  jects (if there.
-0002cd50: 2020 2020 2020 2020 2020 2020 7765 7265              were
-0002cd60: 206d 756c 7469 706c 6520 6d61 7463 6869   multiple matchi
-0002cd70: 6e67 2070 726f 6475 6374 7329 2e0a 2020  ng products)..  
-0002cd80: 2020 2020 2020 3a72 7479 7065 3a20 556e        :rtype: Un
-0002cd90: 696f 6e5b 496d 6167 652c 204c 6973 745b  ion[Image, List[
-0002cda0: 496d 6167 655d 5d0a 2020 2020 2020 2020  Image]].        
-0002cdb0: 2222 220a 2020 2020 2020 2020 7265 7475  """.        retu
-0002cdc0: 726e 2073 656c 662e 5f67 6574 5f70 686f  rn self._get_pho
-0002cdd0: 745f 7072 6f64 2822 696d 6167 6522 2c20  t_prod("image", 
-0002cde0: 6f62 735f 6964 2c20 696e 7374 2c20 6c6f  obs_id, inst, lo
-0002cdf0: 5f65 6e2c 2068 695f 656e 2c20 7073 665f  _en, hi_en, psf_
-0002ce00: 636f 7272 2c20 7073 665f 6d6f 6465 6c2c  corr, psf_model,
-0002ce10: 2070 7366 5f62 696e 732c 2070 7366 5f61   psf_bins, psf_a
-0002ce20: 6c67 6f2c 0a20 2020 2020 2020 2020 2020  lgo,.           
-0002ce30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ce40: 2020 2020 2020 2020 7073 665f 6974 6572          psf_iter
-0002ce50: 290a 0a20 2020 2064 6566 2067 6574 5f65  )..    def get_e
-0002ce60: 7870 6d61 7073 2873 656c 662c 206f 6273  xpmaps(self, obs
-0002ce70: 5f69 643a 2073 7472 203d 204e 6f6e 652c  _id: str = None,
-0002ce80: 2069 6e73 743a 2073 7472 203d 204e 6f6e   inst: str = Non
-0002ce90: 652c 206c 6f5f 656e 3a20 5175 616e 7469  e, lo_en: Quanti
-0002cea0: 7479 203d 204e 6f6e 652c 2068 695f 656e  ty = None, hi_en
-0002ceb0: 3a20 5175 616e 7469 7479 203d 204e 6f6e  : Quantity = Non
-0002cec0: 6529 205c 0a20 2020 2020 2020 2020 2020  e) \.           
-0002ced0: 202d 3e20 556e 696f 6e5b 4578 704d 6170   -> Union[ExpMap
-0002cee0: 2c20 4c69 7374 5b45 7870 4d61 705d 5d3a  , List[ExpMap]]:
-0002cef0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0002cf00: 2020 2020 2041 206d 6574 686f 6420 746f       A method to
-0002cf10: 2072 6574 7269 6576 6520 5847 4120 4578   retrieve XGA Ex
-0002cf20: 704d 6170 206f 626a 6563 7473 2e20 5468  pMap objects. Th
-0002cf30: 6973 2073 7570 706f 7274 7320 7365 7474  is supports sett
-0002cf40: 696e 6720 7468 6520 656e 6572 6779 206c  ing the energy l
-0002cf50: 696d 6974 7320 6f66 2074 6865 2073 7065  imits of the spe
-0002cf60: 6369 6669 630a 2020 2020 2020 2020 6578  cific.        ex
-0002cf70: 706f 7375 7265 206d 6170 7320 796f 7520  posure maps you 
-0002cf80: 776f 756c 6420 6c69 6b65 2e20 4120 4e6f  would like. A No
-0002cf90: 5072 6f64 7563 7441 7661 696c 6162 6c65  ProductAvailable
-0002cfa0: 4572 726f 7220 6572 726f 7220 7769 6c6c  Error error will
-0002cfb0: 2062 6520 7261 6973 6564 2069 6620 6e6f   be raised if no
-0002cfc0: 206d 6174 6368 6573 2061 7265 2066 6f75   matches are fou
-0002cfd0: 6e64 2e0a 0a20 2020 2020 2020 203a 7061  nd...        :pa
-0002cfe0: 7261 6d20 7374 7220 6f62 735f 6964 3a20  ram str obs_id: 
-0002cff0: 4f70 7469 6f6e 616c 6c79 2c20 6120 7370  Optionally, a sp
-0002d000: 6563 6966 6963 206f 6273 5f69 6420 746f  ecific obs_id to
-0002d010: 2073 6561 7263 6820 666f 7220 6361 6e20   search for can 
-0002d020: 6265 2073 7570 706c 6965 642e 2054 6865  be supplied. The
-0002d030: 2064 6566 6175 6c74 2069 7320 4e6f 6e65   default is None
-0002d040: 2c0a 2020 2020 2020 2020 2020 2020 7768  ,.            wh
-0002d050: 6963 6820 6d65 616e 7320 616c 6c20 6578  ich means all ex
-0002d060: 706f 7375 7265 206d 6170 7320 6d61 7463  posure maps matc
-0002d070: 6869 6e67 2074 6865 206f 7468 6572 2063  hing the other c
-0002d080: 7269 7465 7269 6120 7769 6c6c 2062 6520  riteria will be 
-0002d090: 7265 7475 726e 6564 2e0a 2020 2020 2020  returned..      
-0002d0a0: 2020 3a70 6172 616d 2073 7472 2069 6e73    :param str ins
-0002d0b0: 743a 204f 7074 696f 6e61 6c6c 792c 2061  t: Optionally, a
-0002d0c0: 2073 7065 6369 6669 6320 696e 7374 7275   specific instru
-0002d0d0: 6d65 6e74 2074 6f20 7365 6172 6368 2066  ment to search f
-0002d0e0: 6f72 2063 616e 2062 6520 7375 7070 6c69  or can be suppli
-0002d0f0: 6564 2e20 5468 6520 6465 6661 756c 7420  ed. The default 
-0002d100: 6973 204e 6f6e 652c 0a20 2020 2020 2020  is None,.       
-0002d110: 2020 2020 2077 6869 6368 206d 6561 6e73       which means
-0002d120: 2061 6c6c 2065 7870 6f73 7572 6520 6d61   all exposure ma
-0002d130: 7073 206d 6174 6368 696e 6720 7468 6520  ps matching the 
-0002d140: 6f74 6865 7220 6372 6974 6572 6961 2077  other criteria w
-0002d150: 696c 6c20 6265 2072 6574 7572 6e65 642e  ill be returned.
-0002d160: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-0002d170: 5175 616e 7469 7479 206c 6f5f 656e 3a20  Quantity lo_en: 
-0002d180: 5468 6520 6c6f 7765 7220 656e 6572 6779  The lower energy
-0002d190: 206c 696d 6974 206f 6620 7468 6520 6578   limit of the ex
-0002d1a0: 706f 7375 7265 206d 6170 7320 796f 7520  posure maps you 
-0002d1b0: 7769 7368 2074 6f20 7265 7472 6965 7665  wish to retrieve
-0002d1c0: 2c20 7468 6520 6465 6661 756c 740a 2020  , the default.  
-0002d1d0: 2020 2020 2020 2020 2020 6973 204e 6f6e            is Non
-0002d1e0: 6520 2877 6869 6368 2077 696c 6c20 7265  e (which will re
-0002d1f0: 7472 6965 7665 2061 6c6c 2069 6d61 6765  trieve all image
-0002d200: 7320 7265 6761 7264 6c65 7373 206f 6620  s regardless of 
-0002d210: 656e 6572 6779 206c 696d 6974 292e 0a20  energy limit).. 
-0002d220: 2020 2020 2020 203a 7061 7261 6d20 5175         :param Qu
-0002d230: 616e 7469 7479 2068 695f 656e 3a20 5468  antity hi_en: Th
-0002d240: 6520 7570 7065 7220 656e 6572 6779 206c  e upper energy l
-0002d250: 696d 6974 206f 6620 7468 6520 6578 706f  imit of the expo
-0002d260: 7375 7265 206d 6170 7320 796f 7520 7769  sure maps you wi
-0002d270: 7368 2074 6f20 7265 7472 6965 7665 2c20  sh to retrieve, 
-0002d280: 7468 6520 6465 6661 756c 740a 2020 2020  the default.    
-0002d290: 2020 2020 2020 2020 6973 204e 6f6e 6520          is None 
-0002d2a0: 2877 6869 6368 2077 696c 6c20 7265 7472  (which will retr
-0002d2b0: 6965 7665 2061 6c6c 2069 6d61 6765 7320  ieve all images 
-0002d2c0: 7265 6761 7264 6c65 7373 206f 6620 656e  regardless of en
-0002d2d0: 6572 6779 206c 696d 6974 292e 0a20 2020  ergy limit)..   
-0002d2e0: 2020 2020 203a 7265 7475 726e 3a20 416e       :return: An
-0002d2f0: 2058 4741 2045 7870 4d61 7020 6f62 6a65   XGA ExpMap obje
-0002d300: 6374 2028 6966 2074 6865 7265 2069 7320  ct (if there is 
-0002d310: 616e 2065 7861 6374 206d 6174 6368 292c  an exact match),
-0002d320: 206f 7220 6120 6c69 7374 206f 6620 5847   or a list of XG
-0002d330: 4120 4578 704d 6170 206f 626a 6563 7473  A ExpMap objects
-0002d340: 2028 6966 2074 6865 7265 0a20 2020 2020   (if there.     
-0002d350: 2020 2020 2020 2077 6572 6520 6d75 6c74         were mult
-0002d360: 6970 6c65 206d 6174 6368 696e 6720 7072  iple matching pr
-0002d370: 6f64 7563 7473 292e 0a20 2020 2020 2020  oducts)..       
-0002d380: 203a 7274 7970 653a 2055 6e69 6f6e 5b45   :rtype: Union[E
-0002d390: 7870 4d61 702c 204c 6973 745b 4578 704d  xpMap, List[ExpM
-0002d3a0: 6170 5d5d 0a20 2020 2020 2020 2022 2222  ap]].        """
-0002d3b0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0002d3c0: 7365 6c66 2e5f 6765 745f 7068 6f74 5f70  self._get_phot_p
-0002d3d0: 726f 6428 2265 7870 6d61 7022 2c20 6f62  rod("expmap", ob
-0002d3e0: 735f 6964 2c20 696e 7374 2c20 6c6f 5f65  s_id, inst, lo_e
-0002d3f0: 6e2c 2068 695f 656e 2c20 4661 6c73 6529  n, hi_en, False)
-0002d400: 0a0a 2020 2020 6465 6620 6765 745f 7261  ..    def get_ra
-0002d410: 7465 6d61 7073 2873 656c 662c 206f 6273  temaps(self, obs
-0002d420: 5f69 643a 2073 7472 203d 204e 6f6e 652c  _id: str = None,
-0002d430: 2069 6e73 743a 2073 7472 203d 204e 6f6e   inst: str = Non
-0002d440: 652c 206c 6f5f 656e 3a20 5175 616e 7469  e, lo_en: Quanti
-0002d450: 7479 203d 204e 6f6e 652c 2068 695f 656e  ty = None, hi_en
-0002d460: 3a20 5175 616e 7469 7479 203d 204e 6f6e  : Quantity = Non
-0002d470: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0002d480: 2020 2020 2020 2020 7073 665f 636f 7272          psf_corr
-0002d490: 3a20 626f 6f6c 203d 2046 616c 7365 2c20  : bool = False, 
-0002d4a0: 7073 665f 6d6f 6465 6c3a 2073 7472 203d  psf_model: str =
-0002d4b0: 2022 454c 4c42 4554 4122 2c20 7073 665f   "ELLBETA", psf_
-0002d4c0: 6269 6e73 3a20 696e 7420 3d20 342c 2070  bins: int = 4, p
-0002d4d0: 7366 5f61 6c67 6f3a 2073 7472 203d 2022  sf_algo: str = "
-0002d4e0: 726c 222c 0a20 2020 2020 2020 2020 2020  rl",.           
-0002d4f0: 2020 2020 2020 2020 2020 7073 665f 6974            psf_it
-0002d500: 6572 3a20 696e 7420 3d20 3135 2920 2d3e  er: int = 15) ->
-0002d510: 2055 6e69 6f6e 5b52 6174 654d 6170 2c20   Union[RateMap, 
-0002d520: 4c69 7374 5b52 6174 654d 6170 5d5d 3a0a  List[RateMap]]:.
-0002d530: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-0002d540: 2020 2020 4120 6d65 7468 6f64 2074 6f20      A method to 
-0002d550: 7265 7472 6965 7665 2058 4741 2052 6174  retrieve XGA Rat
-0002d560: 654d 6170 206f 626a 6563 7473 2e20 5468  eMap objects. Th
-0002d570: 6973 2073 7570 706f 7274 7320 7468 6520  is supports the 
-0002d580: 7265 7472 6965 7661 6c20 6f66 2062 6f74  retrieval of bot
-0002d590: 6820 5053 4620 636f 7272 6563 7465 6420  h PSF corrected 
-0002d5a0: 616e 6420 6e6f 6e2d 5053 460a 2020 2020  and non-PSF.    
-0002d5b0: 2020 2020 636f 7272 6563 7465 6420 7261      corrected ra
-0002d5c0: 7465 6d61 7073 2c20 6173 2077 656c 6c20  temaps, as well 
-0002d5d0: 6173 2073 6574 7469 6e67 2074 6865 2065  as setting the e
-0002d5e0: 6e65 7267 7920 6c69 6d69 7473 206f 6620  nergy limits of 
-0002d5f0: 7468 6520 7370 6563 6966 6963 2072 6174  the specific rat
-0002d600: 656d 6170 2079 6f75 2077 6f75 6c64 206c  emap you would l
-0002d610: 696b 652e 2041 0a20 2020 2020 2020 204e  ike. A.        N
-0002d620: 6f50 726f 6475 6374 4176 6169 6c61 626c  oProductAvailabl
-0002d630: 6545 7272 6f72 2065 7272 6f72 2077 696c  eError error wil
-0002d640: 6c20 6265 2072 6169 7365 6420 6966 206e  l be raised if n
-0002d650: 6f20 6d61 7463 6865 7320 6172 6520 666f  o matches are fo
-0002d660: 756e 642e 0a0a 2020 2020 2020 2020 3a70  und...        :p
-0002d670: 6172 616d 2073 7472 206f 6273 5f69 643a  aram str obs_id:
-0002d680: 204f 7074 696f 6e61 6c6c 792c 2061 2073   Optionally, a s
-0002d690: 7065 6369 6669 6320 6f62 735f 6964 2074  pecific obs_id t
-0002d6a0: 6f20 7365 6172 6368 2066 6f72 2063 616e  o search for can
-0002d6b0: 2062 6520 7375 7070 6c69 6564 2e20 5468   be supplied. Th
-0002d6c0: 6520 6465 6661 756c 7420 6973 204e 6f6e  e default is Non
-0002d6d0: 652c 0a20 2020 2020 2020 2020 2020 2077  e,.            w
-0002d6e0: 6869 6368 206d 6561 6e73 2061 6c6c 2072  hich means all r
-0002d6f0: 6174 656d 6170 7320 6d61 7463 6869 6e67  atemaps matching
-0002d700: 2074 6865 206f 7468 6572 2063 7269 7465   the other crite
-0002d710: 7269 6120 7769 6c6c 2062 6520 7265 7475  ria will be retu
-0002d720: 726e 6564 2e0a 2020 2020 2020 2020 3a70  rned..        :p
-0002d730: 6172 616d 2073 7472 2069 6e73 743a 204f  aram str inst: O
-0002d740: 7074 696f 6e61 6c6c 792c 2061 2073 7065  ptionally, a spe
-0002d750: 6369 6669 6320 696e 7374 7275 6d65 6e74  cific instrument
-0002d760: 2074 6f20 7365 6172 6368 2066 6f72 2063   to search for c
-0002d770: 616e 2062 6520 7375 7070 6c69 6564 2e20  an be supplied. 
-0002d780: 5468 6520 6465 6661 756c 7420 6973 204e  The default is N
-0002d790: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
-0002d7a0: 2077 6869 6368 206d 6561 6e73 2061 6c6c   which means all
-0002d7b0: 2072 6174 656d 6170 7320 6d61 7463 6869   ratemaps matchi
-0002d7c0: 6e67 2074 6865 206f 7468 6572 2063 7269  ng the other cri
-0002d7d0: 7465 7269 6120 7769 6c6c 2062 6520 7265  teria will be re
-0002d7e0: 7475 726e 6564 2e0a 2020 2020 2020 2020  turned..        
-0002d7f0: 3a70 6172 616d 2051 7561 6e74 6974 7920  :param Quantity 
-0002d800: 6c6f 5f65 6e3a 2054 6865 206c 6f77 6572  lo_en: The lower
-0002d810: 2065 6e65 7267 7920 6c69 6d69 7420 6f66   energy limit of
-0002d820: 2074 6865 2072 6174 656d 6170 7320 796f   the ratemaps yo
-0002d830: 7520 7769 7368 2074 6f20 7265 7472 6965  u wish to retrie
-0002d840: 7665 2c20 7468 6520 6465 6661 756c 740a  ve, the default.
-0002d850: 2020 2020 2020 2020 2020 2020 6973 204e              is N
-0002d860: 6f6e 6520 2877 6869 6368 2077 696c 6c20  one (which will 
-0002d870: 7265 7472 6965 7665 2061 6c6c 2072 6174  retrieve all rat
-0002d880: 656d 6170 7320 7265 6761 7264 6c65 7373  emaps regardless
-0002d890: 206f 6620 656e 6572 6779 206c 696d 6974   of energy limit
-0002d8a0: 292e 0a20 2020 2020 2020 203a 7061 7261  )..        :para
-0002d8b0: 6d20 5175 616e 7469 7479 2068 695f 656e  m Quantity hi_en
-0002d8c0: 3a20 5468 6520 7570 7065 7220 656e 6572  : The upper ener
-0002d8d0: 6779 206c 696d 6974 206f 6620 7468 6520  gy limit of the 
-0002d8e0: 7261 7465 6d61 7073 2079 6f75 2077 6973  ratemaps you wis
-0002d8f0: 6820 746f 2072 6574 7269 6576 652c 2074  h to retrieve, t
-0002d900: 6865 2064 6566 6175 6c74 0a20 2020 2020  he default.     
-0002d910: 2020 2020 2020 2069 7320 4e6f 6e65 2028         is None (
-0002d920: 7768 6963 6820 7769 6c6c 2072 6574 7269  which will retri
-0002d930: 6576 6520 616c 6c20 7261 7465 6d61 7073  eve all ratemaps
-0002d940: 2072 6567 6172 646c 6573 7320 6f66 2065   regardless of e
-0002d950: 6e65 7267 7920 6c69 6d69 7429 2e0a 2020  nergy limit)..  
-0002d960: 2020 2020 2020 3a70 6172 616d 2062 6f6f        :param boo
-0002d970: 6c20 7073 665f 636f 7272 3a20 5365 7473  l psf_corr: Sets
-0002d980: 2077 6865 7468 6572 2079 6f75 2077 6973   whether you wis
-0002d990: 6820 746f 2072 6574 7269 6576 6520 6120  h to retrieve a 
-0002d9a0: 5053 4620 636f 7272 6563 7465 6420 7261  PSF corrected ra
-0002d9b0: 7465 6d61 7020 6f72 206e 6f74 2e0a 2020  temap or not..  
-0002d9c0: 2020 2020 2020 3a70 6172 616d 2073 7472        :param str
-0002d9d0: 2070 7366 5f6d 6f64 656c 3a20 4966 2074   psf_model: If t
-0002d9e0: 6865 2072 6174 656d 6170 2079 6f75 2077  he ratemap you w
-0002d9f0: 616e 7420 6973 2050 5346 2063 6f72 7265  ant is PSF corre
-0002da00: 6374 6564 2c20 7468 6973 2069 7320 7468  cted, this is th
-0002da10: 6520 5053 4620 6d6f 6465 6c20 7573 6564  e PSF model used
-0002da20: 2e0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
-0002da30: 2069 6e74 2070 7366 5f62 696e 733a 2049   int psf_bins: I
-0002da40: 6620 7468 6520 7261 7465 6d61 7020 796f  f the ratemap yo
-0002da50: 7520 7761 6e74 2069 7320 5053 4620 636f  u want is PSF co
-0002da60: 7272 6563 7465 642c 2074 6869 7320 6973  rrected, this is
-0002da70: 2074 6865 206e 756d 6265 7220 6f66 2050   the number of P
-0002da80: 5346 7320 7065 720a 2020 2020 2020 2020  SFs per.        
-0002da90: 2020 2020 7369 6465 2069 6e20 7468 6520      side in the 
-0002daa0: 5053 4620 6772 6964 2e0a 2020 2020 2020  PSF grid..      
-0002dab0: 2020 3a70 6172 616d 2073 7472 2070 7366    :param str psf
-0002dac0: 5f61 6c67 6f3a 2049 6620 7468 6520 7261  _algo: If the ra
-0002dad0: 7465 6d61 7020 796f 7520 7761 6e74 2069  temap you want i
-0002dae0: 7320 5053 4620 636f 7272 6563 7465 642c  s PSF corrected,
-0002daf0: 2074 6869 7320 6973 2074 6865 2061 6c67   this is the alg
-0002db00: 6f72 6974 686d 2075 7365 642e 0a20 2020  orithm used..   
-0002db10: 2020 2020 203a 7061 7261 6d20 696e 7420       :param int 
-0002db20: 7073 665f 6974 6572 3a20 4966 2074 6865  psf_iter: If the
-0002db30: 2072 6174 656d 6170 2079 6f75 2077 616e   ratemap you wan
-0002db40: 7420 6973 2050 5346 2063 6f72 7265 6374  t is PSF correct
-0002db50: 6564 2c20 7468 6973 2069 7320 7468 6520  ed, this is the 
-0002db60: 6e75 6d62 6572 206f 6620 6974 6572 6174  number of iterat
-0002db70: 696f 6e73 2e0a 2020 2020 2020 2020 3a72  ions..        :r
-0002db80: 6574 7572 6e3a 2041 6e20 5847 4120 5261  eturn: An XGA Ra
-0002db90: 7465 4d61 7020 6f62 6a65 6374 2028 6966  teMap object (if
-0002dba0: 2074 6865 7265 2069 7320 616e 2065 7861   there is an exa
-0002dbb0: 6374 206d 6174 6368 292c 206f 7220 6120  ct match), or a 
-0002dbc0: 6c69 7374 206f 6620 5847 4120 5261 7465  list of XGA Rate
-0002dbd0: 4d61 7020 6f62 6a65 6374 7320 2869 6620  Map objects (if 
-0002dbe0: 7468 6572 650a 2020 2020 2020 2020 2020  there.          
-0002dbf0: 2020 7765 7265 206d 756c 7469 706c 6520    were multiple 
-0002dc00: 6d61 7463 6869 6e67 2070 726f 6475 6374  matching product
-0002dc10: 7329 2e0a 2020 2020 2020 2020 3a72 7479  s)..        :rty
-0002dc20: 7065 3a20 556e 696f 6e5b 5261 7465 4d61  pe: Union[RateMa
-0002dc30: 702c 204c 6973 745b 5261 7465 4d61 705d  p, List[RateMap]
-0002dc40: 5d0a 2020 2020 2020 2020 2222 220a 2020  ].        """.  
-0002dc50: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-0002dc60: 662e 5f67 6574 5f70 686f 745f 7072 6f64  f._get_phot_prod
-0002dc70: 2822 7261 7465 6d61 7022 2c20 6f62 735f  ("ratemap", obs_
-0002dc80: 6964 2c20 696e 7374 2c20 6c6f 5f65 6e2c  id, inst, lo_en,
-0002dc90: 2068 695f 656e 2c20 7073 665f 636f 7272   hi_en, psf_corr
-0002dca0: 2c20 7073 665f 6d6f 6465 6c2c 2070 7366  , psf_model, psf
-0002dcb0: 5f62 696e 732c 2070 7366 5f61 6c67 6f2c  _bins, psf_algo,
-0002dcc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002dcd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dce0: 2020 2020 7073 665f 6974 6572 290a 0a20      psf_iter).. 
-0002dcf0: 2020 2064 6566 205f 6765 745f 6c63 5f70     def _get_lc_p
-0002dd00: 726f 6428 7365 6c66 2c20 6f75 7465 725f  rod(self, outer_
-0002dd10: 7261 6469 7573 3a20 556e 696f 6e5b 7374  radius: Union[st
-0002dd20: 722c 2051 7561 6e74 6974 795d 203d 204e  r, Quantity] = N
-0002dd30: 6f6e 652c 206f 6273 5f69 643a 2073 7472  one, obs_id: str
-0002dd40: 203d 204e 6f6e 652c 2069 6e73 743a 2073   = None, inst: s
-0002dd50: 7472 203d 204e 6f6e 652c 0a20 2020 2020  tr = None,.     
-0002dd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dd70: 696e 6e65 725f 7261 6469 7573 3a20 556e  inner_radius: Un
-0002dd80: 696f 6e5b 7374 722c 2051 7561 6e74 6974  ion[str, Quantit
-0002dd90: 795d 203d 204e 6f6e 652c 206c 6f5f 656e  y] = None, lo_en
-0002dda0: 3a20 5175 616e 7469 7479 203d 204e 6f6e  : Quantity = Non
-0002ddb0: 652c 2068 695f 656e 3a20 5175 616e 7469  e, hi_en: Quanti
-0002ddc0: 7479 203d 204e 6f6e 652c 0a20 2020 2020  ty = None,.     
-0002ddd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dde0: 7469 6d65 5f62 696e 5f73 697a 653a 2051  time_bin_size: Q
-0002ddf0: 7561 6e74 6974 7920 3d20 4e6f 6e65 2920  uantity = None) 
-0002de00: 5c0a 2020 2020 2020 2020 2020 2020 2d3e  \.            ->
-0002de10: 2055 6e69 6f6e 5b4c 6967 6874 4375 7276   Union[LightCurv
-0002de20: 652c 204c 6973 745b 4c69 6768 7443 7572  e, List[LightCur
-0002de30: 7665 5d2c 2041 6767 7265 6761 7465 4c69  ve], AggregateLi
-0002de40: 6768 7443 7572 7665 2c20 4c69 7374 5b41  ghtCurve, List[A
-0002de50: 6767 7265 6761 7465 4c69 6768 7443 7572  ggregateLightCur
-0002de60: 7665 5d5d 3a0a 2020 2020 2020 2020 2222  ve]]:.        ""
-0002de70: 220a 2020 2020 2020 2020 4120 7072 6f74  ".        A prot
-0002de80: 6563 7465 6420 6d65 7468 6f64 2074 6f20  ected method to 
-0002de90: 7265 7472 6965 7665 2058 4741 204c 6967  retrieve XGA Lig
-0002dea0: 6874 4375 7276 6520 6f62 6a65 6374 732c  htCurve objects,
-0002deb0: 2074 6865 2075 7365 7220 7368 6f75 6c64   the user should
-0002dec0: 206e 6576 6572 2069 6e74 6572 6163 7420   never interact 
-0002ded0: 7769 7468 2074 6869 7320 6469 7265 6374  with this direct
-0002dee0: 6c79 2e0a 0a20 2020 2020 2020 203a 7061  ly...        :pa
-0002def0: 7261 6d20 7374 722f 5175 616e 7469 7479  ram str/Quantity
-0002df00: 206f 7574 6572 5f72 6164 6975 733a 2054   outer_radius: T
-0002df10: 6865 206e 616d 6520 6f72 2076 616c 7565  he name or value
-0002df20: 206f 6620 7468 6520 6f75 7465 7220 7261   of the outer ra
-0002df30: 6469 7573 2074 6861 7420 7761 7320 7573  dius that was us
-0002df40: 6564 2066 6f72 2074 6865 2067 656e 6572  ed for the gener
-0002df50: 6174 696f 6e20 6f66 0a20 2020 2020 2020  ation of.       
-0002df60: 2020 2020 2074 6865 206c 6967 6874 6375       the lightcu
-0002df70: 7276 6520 2866 6f72 2069 6e73 7461 6e63  rve (for instanc
-0002df80: 6520 2770 6f69 6e74 2720 776f 756c 6420  e 'point' would 
-0002df90: 6265 2061 6363 6570 7461 626c 6520 666f  be acceptable fo
-0002dfa0: 7220 6120 506f 696e 7453 6f75 7263 652c  r a PointSource,
-0002dfb0: 206f 7220 5175 616e 7469 7479 2831 3030   or Quantity(100
-0002dfc0: 2c20 276b 7063 2729 292e 0a20 2020 2020  , 'kpc'))..     
-0002dfd0: 2020 2020 2020 2044 6566 6175 6c74 2069         Default i
-0002dfe0: 7320 4e6f 6e65 2c20 6d65 616e 696e 6720  s None, meaning 
-0002dff0: 616c 6c20 6c69 6768 7463 7572 7665 7320  all lightcurves 
-0002e000: 7769 6c6c 2062 6520 7265 7472 6965 7665  will be retrieve
-0002e010: 642e 0a20 2020 2020 2020 203a 7061 7261  d..        :para
-0002e020: 6d20 7374 7220 6f62 735f 6964 3a20 4f70  m str obs_id: Op
-0002e030: 7469 6f6e 616c 6c79 2c20 6120 7370 6563  tionally, a spec
-0002e040: 6966 6963 206f 6273 5f69 6420 746f 2073  ific obs_id to s
-0002e050: 6561 7263 6820 666f 7220 6361 6e20 6265  earch for can be
-0002e060: 2073 7570 706c 6965 642e 2054 6865 2064   supplied. The d
-0002e070: 6566 6175 6c74 2069 7320 4e6f 6e65 2c0a  efault is None,.
-0002e080: 2020 2020 2020 2020 2020 2020 7768 6963              whic
-0002e090: 6820 6d65 616e 7320 616c 6c20 6c69 6768  h means all ligh
-0002e0a0: 7463 7572 7665 7320 6d61 7463 6869 6e67  tcurves matching
-0002e0b0: 2074 6865 206f 7468 6572 2063 7269 7465   the other crite
-0002e0c0: 7269 6120 7769 6c6c 2062 6520 7265 7475  ria will be retu
-0002e0d0: 726e 6564 2e0a 2020 2020 2020 2020 3a70  rned..        :p
-0002e0e0: 6172 616d 2073 7472 2069 6e73 743a 204f  aram str inst: O
-0002e0f0: 7074 696f 6e61 6c6c 792c 2061 2073 7065  ptionally, a spe
-0002e100: 6369 6669 6320 696e 7374 7275 6d65 6e74  cific instrument
-0002e110: 2074 6f20 7365 6172 6368 2066 6f72 2063   to search for c
-0002e120: 616e 2062 6520 7375 7070 6c69 6564 2e20  an be supplied. 
-0002e130: 5468 6520 6465 6661 756c 7420 6973 204e  The default is N
-0002e140: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
-0002e150: 2077 6869 6368 206d 6561 6e73 2061 6c6c   which means all
-0002e160: 206c 6967 6874 6375 7276 6573 206d 6174   lightcurves mat
-0002e170: 6368 696e 6720 7468 6520 6f74 6865 7220  ching the other 
-0002e180: 6372 6974 6572 6961 2077 696c 6c20 6265  criteria will be
-0002e190: 2072 6574 7572 6e65 642e 0a20 2020 2020   returned..     
-0002e1a0: 2020 203a 7061 7261 6d20 7374 722f 5175     :param str/Qu
-0002e1b0: 616e 7469 7479 2069 6e6e 6572 5f72 6164  antity inner_rad
-0002e1c0: 6975 733a 2054 6865 206e 616d 6520 6f72  ius: The name or
-0002e1d0: 2076 616c 7565 206f 6620 7468 6520 696e   value of the in
-0002e1e0: 6e65 7220 7261 6469 7573 2074 6861 7420  ner radius that 
-0002e1f0: 7761 7320 7573 6564 2066 6f72 2074 6865  was used for the
-0002e200: 2067 656e 6572 6174 696f 6e20 6f66 0a20   generation of. 
-0002e210: 2020 2020 2020 2020 2020 2074 6865 206c             the l
-0002e220: 6967 6874 6375 7276 6520 2866 6f72 2069  ightcurve (for i
-0002e230: 6e73 7461 6e63 6520 2770 6f69 6e74 2720  nstance 'point' 
-0002e240: 776f 756c 6420 6265 2061 6363 6570 7461  would be accepta
-0002e250: 626c 6520 666f 7220 6120 506f 696e 7453  ble for a PointS
-0002e260: 6f75 7263 652c 206f 7220 5175 616e 7469  ource, or Quanti
-0002e270: 7479 2830 2c20 276b 7063 2729 292e 0a20  ty(0, 'kpc')).. 
-0002e280: 2020 2020 2020 2020 2020 2044 6566 6175             Defau
-0002e290: 6c74 2069 7320 4e6f 6e65 2c20 6d65 616e  lt is None, mean
-0002e2a0: 696e 6720 616c 6c20 6c69 6768 7463 7572  ing all lightcur
-0002e2b0: 7665 7320 7769 6c6c 2062 6520 7265 7472  ves will be retr
-0002e2c0: 6965 7665 642e 0a20 2020 2020 2020 203a  ieved..        :
-0002e2d0: 7061 7261 6d20 5175 616e 7469 7479 206c  param Quantity l
-0002e2e0: 6f5f 656e 3a20 5468 6520 6c6f 7765 7220  o_en: The lower 
-0002e2f0: 656e 6572 6779 206c 696d 6974 206f 6620  energy limit of 
-0002e300: 7468 6520 6c69 6768 7463 7572 7665 7320  the lightcurves 
-0002e310: 796f 7520 7769 7368 2074 6f20 7265 7472  you wish to retr
-0002e320: 6965 7665 2c20 7468 6520 6465 6661 756c  ieve, the defaul
-0002e330: 740a 2020 2020 2020 2020 2020 2020 6973  t.            is
-0002e340: 204e 6f6e 6520 2877 6869 6368 2077 696c   None (which wil
-0002e350: 6c20 7265 7472 6965 7665 2061 6c6c 206c  l retrieve all l
-0002e360: 6967 6874 6375 7276 6573 2072 6567 6172  ightcurves regar
-0002e370: 646c 6573 7320 6f66 2065 6e65 7267 7920  dless of energy 
-0002e380: 6c69 6d69 7429 2e0a 2020 2020 2020 2020  limit)..        
-0002e390: 3a70 6172 616d 2051 7561 6e74 6974 7920  :param Quantity 
-0002e3a0: 6869 5f65 6e3a 2054 6865 2075 7070 6572  hi_en: The upper
-0002e3b0: 2065 6e65 7267 7920 6c69 6d69 7420 6f66   energy limit of
-0002e3c0: 2074 6865 206c 6967 6874 6375 7276 6573   the lightcurves
-0002e3d0: 2079 6f75 2077 6973 6820 746f 2072 6574   you wish to ret
-0002e3e0: 7269 6576 652c 2074 6865 2064 6566 6175  rieve, the defau
-0002e3f0: 6c74 0a20 2020 2020 2020 2020 2020 2069  lt.            i
-0002e400: 7320 4e6f 6e65 2028 7768 6963 6820 7769  s None (which wi
-0002e410: 6c6c 2072 6574 7269 6576 6520 616c 6c20  ll retrieve all 
-0002e420: 6c69 6768 7463 7572 7665 7320 7265 6761  lightcurves rega
-0002e430: 7264 6c65 7373 206f 6620 656e 6572 6779  rdless of energy
-0002e440: 206c 696d 6974 292e 0a20 2020 2020 2020   limit)..       
-0002e450: 203a 7061 7261 6d20 5175 616e 7469 7479   :param Quantity
-0002e460: 2074 696d 655f 6269 6e5f 7369 7a65 3a20   time_bin_size: 
-0002e470: 5468 6520 7469 6d65 2062 696e 2073 697a  The time bin siz
-0002e480: 6520 7573 6564 2074 6f20 6765 6e65 7261  e used to genera
-0002e490: 7465 2074 6865 2064 6573 6972 6564 206c  te the desired l
-0002e4a0: 6967 6874 6375 7276 652e 2054 6865 2064  ightcurve. The d
-0002e4b0: 6566 6175 6c74 2076 616c 7565 0a20 2020  efault value.   
-0002e4c0: 2020 2020 2020 2020 2069 7320 4e6f 6e65           is None
-0002e4d0: 2c20 696e 2077 6869 6368 2063 6173 6520  , in which case 
-0002e4e0: 616c 6c20 6c69 6768 7463 7572 7665 7320  all lightcurves 
-0002e4f0: 6d61 7463 6869 6e67 206f 7468 6572 2063  matching other c
-0002e500: 7269 7465 7269 6120 7769 6c6c 2062 6520  riteria will be 
-0002e510: 7265 7472 6965 7665 642e 0a20 2020 2020  retrieved..     
-0002e520: 2020 203a 7265 7475 726e 3a20 416e 2058     :return: An X
-0002e530: 4741 204c 6967 6874 4375 7276 6520 6f62  GA LightCurve ob
-0002e540: 6a65 6374 2028 6966 2074 6865 7265 2069  ject (if there i
-0002e550: 7320 616e 2065 7861 6374 206d 6174 6368  s an exact match
-0002e560: 292c 206f 7220 6120 6c69 7374 206f 6620  ), or a list of 
-0002e570: 5847 4120 4c69 6768 7443 7572 7665 206f  XGA LightCurve o
-0002e580: 626a 6563 7473 2028 6966 2074 6865 7265  bjects (if there
-0002e590: 0a20 2020 2020 2020 2020 2020 2077 6572  .            wer
-0002e5a0: 6520 6d75 6c74 6970 6c65 206d 6174 6368  e multiple match
-0002e5b0: 696e 6720 7072 6f64 7563 7473 292c 206f  ing products), o
-0002e5c0: 7220 6120 7369 6e67 6c65 2f6c 6973 7420  r a single/list 
-0002e5d0: 6f66 2041 6767 7265 6761 7465 4c69 6768  of AggregateLigh
-0002e5e0: 7443 7572 7665 206f 626a 6563 7473 2e0a  tCurve objects..
-0002e5f0: 2020 2020 2020 2020 3a72 7479 7065 3a20          :rtype: 
-0002e600: 556e 696f 6e5b 4c69 6768 7443 7572 7665  Union[LightCurve
-0002e610: 2c20 4c69 7374 5b4c 6967 6874 4375 7276  , List[LightCurv
-0002e620: 655d 2c20 4167 6772 6567 6174 654c 6967  e], AggregateLig
-0002e630: 6874 4375 7276 652c 204c 6973 745b 4167  htCurve, List[Ag
-0002e640: 6772 6567 6174 654c 6967 6874 4375 7276  gregateLightCurv
-0002e650: 655d 5d0a 2020 2020 2020 2020 2222 220a  e]].        """.
-0002e660: 2020 2020 2020 2020 2320 5365 7420 7570          # Set up
-0002e670: 2073 6561 7263 6820 7374 7269 6e67 7320   search strings 
-0002e680: 2866 6f72 2074 6865 2070 726f 6475 6374  (for the product
-0002e690: 2073 746f 7261 6765 206b 6579 7329 2066   storage keys) f
-0002e6a0: 6f72 2074 6865 2069 6e6e 6572 2061 6e64  or the inner and
-0002e6b0: 206f 7574 6572 2072 6164 6969 2068 6572   outer radii her
-0002e6c0: 652e 2054 6865 2064 6566 6175 6c74 204e  e. The default N
-0002e6d0: 6f6e 650a 2020 2020 2020 2020 2320 2076  one.        #  v
-0002e6e0: 616c 7565 206a 7573 7420 6372 6561 7465  alue just create
-0002e6f0: 7320 6120 6b65 7920 7468 6174 206c 6f6f  s a key that loo
-0002e700: 6b73 2066 6f72 2074 6865 2027 7269 2720  ks for the 'ri' 
-0002e710: 6f72 2027 726f 2720 7072 6563 7572 736f  or 'ro' precurso
-0002e720: 7220 746f 2074 6865 2076 616c 7565 2069  r to the value i
-0002e730: 6e20 7468 6520 6b65 792c 2069 2e65 2e20  n the key, i.e. 
-0002e740: 6974 2064 6f65 736e 2774 0a20 2020 2020  it doesn't.     
-0002e750: 2020 2023 2020 646f 2061 6e79 7468 696e     #  do anythin
-0002e760: 6720 2d20 7765 2061 6c73 6f20 6d61 6b65  g - we also make
-0002e770: 2073 7572 6520 7468 6174 2061 6e79 2072   sure that any r
-0002e780: 6164 6969 2070 6173 7365 6420 6279 2074  adii passed by t
-0002e790: 6865 2075 7365 7220 6172 6520 636f 6e76  he user are conv
-0002e7a0: 6572 7465 6420 7072 6f70 6572 6c79 0a20  erted properly. 
-0002e7b0: 2020 2020 2020 2069 6620 696e 6e65 725f         if inner_
-0002e7c0: 7261 6469 7573 2069 7320 6e6f 7420 4e6f  radius is not No
-0002e7d0: 6e65 2061 6e64 2069 7369 6e73 7461 6e63  ne and isinstanc
-0002e7e0: 6528 696e 6e65 725f 7261 6469 7573 2c20  e(inner_radius, 
-0002e7f0: 5175 616e 7469 7479 293a 0a20 2020 2020  Quantity):.     
-0002e800: 2020 2020 2020 2069 6e6e 5f72 6164 5f73         inn_rad_s
-0002e810: 6561 7263 6820 3d20 275f 7269 7b7d 5f27  earch = '_ri{}_'
-0002e820: 2e66 6f72 6d61 7428 7365 6c66 2e63 6f6e  .format(self.con
-0002e830: 7665 7274 5f72 6164 6975 7328 696e 6e65  vert_radius(inne
-0002e840: 725f 7261 6469 7573 2c20 2764 6567 2729  r_radius, 'deg')
-0002e850: 2e76 616c 7565 290a 2020 2020 2020 2020  .value).        
-0002e860: 656c 6966 2069 6e6e 6572 5f72 6164 6975  elif inner_radiu
-0002e870: 7320 6973 206e 6f74 204e 6f6e 6520 616e  s is not None an
-0002e880: 6420 6973 696e 7374 616e 6365 2869 6e6e  d isinstance(inn
-0002e890: 6572 5f72 6164 6975 732c 2073 7472 293a  er_radius, str):
-0002e8a0: 0a20 2020 2020 2020 2020 2020 2069 6e6e  .            inn
-0002e8b0: 5f72 6164 5f73 6561 7263 6820 3d20 275f  _rad_search = '_
-0002e8c0: 7269 7b7d 5f27 2e66 6f72 6d61 7428 7365  ri{}_'.format(se
-0002e8d0: 6c66 2e67 6574 5f72 6164 6975 7328 696e  lf.get_radius(in
-0002e8e0: 6e65 725f 7261 6469 7573 2c20 2764 6567  ner_radius, 'deg
-0002e8f0: 2729 2e76 616c 7565 290a 2020 2020 2020  ').value).      
-0002e900: 2020 656c 6966 2069 6e6e 6572 5f72 6164    elif inner_rad
-0002e910: 6975 7320 6973 204e 6f6e 653a 0a20 2020  ius is None:.   
-0002e920: 2020 2020 2020 2020 2069 6e6e 5f72 6164           inn_rad
-0002e930: 5f73 6561 7263 6820 3d20 225f 7269 220a  _search = "_ri".
-0002e940: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0002e950: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0002e960: 5479 7065 4572 726f 7228 2259 6f75 206d  TypeError("You m
-0002e970: 6179 206f 6e6c 7920 7061 7373 2061 2071  ay only pass a q
-0002e980: 7561 6e74 6974 7920 6f72 2061 2073 7472  uantity or a str
-0002e990: 696e 6720 6173 2069 6e6e 6572 5f72 6164  ing as inner_rad
-0002e9a0: 6975 7322 290a 0a20 2020 2020 2020 2069  ius")..        i
-0002e9b0: 6620 6f75 7465 725f 7261 6469 7573 2069  f outer_radius i
-0002e9c0: 7320 6e6f 7420 4e6f 6e65 2061 6e64 2069  s not None and i
-0002e9d0: 7369 6e73 7461 6e63 6528 6f75 7465 725f  sinstance(outer_
-0002e9e0: 7261 6469 7573 2c20 5175 616e 7469 7479  radius, Quantity
-0002e9f0: 293a 0a20 2020 2020 2020 2020 2020 206f  ):.            o
-0002ea00: 7574 5f72 6164 5f73 6561 7263 6820 3d20  ut_rad_search = 
-0002ea10: 275f 726f 7b7d 5f27 2e66 6f72 6d61 7428  '_ro{}_'.format(
-0002ea20: 7365 6c66 2e63 6f6e 7665 7274 5f72 6164  self.convert_rad
-0002ea30: 6975 7328 6f75 7465 725f 7261 6469 7573  ius(outer_radius
-0002ea40: 2c20 2764 6567 2729 2e76 616c 7565 290a  , 'deg').value).
-0002ea50: 2020 2020 2020 2020 656c 6966 206f 7574          elif out
-0002ea60: 6572 5f72 6164 6975 7320 6973 206e 6f74  er_radius is not
-0002ea70: 204e 6f6e 6520 616e 6420 6973 696e 7374   None and isinst
-0002ea80: 616e 6365 286f 7574 6572 5f72 6164 6975  ance(outer_radiu
-0002ea90: 732c 2073 7472 293a 0a20 2020 2020 2020  s, str):.       
-0002eaa0: 2020 2020 206f 7574 5f72 6164 5f73 6561       out_rad_sea
-0002eab0: 7263 6820 3d20 275f 726f 7b7d 5f27 2e66  rch = '_ro{}_'.f
-0002eac0: 6f72 6d61 7428 7365 6c66 2e67 6574 5f72  ormat(self.get_r
-0002ead0: 6164 6975 7328 6f75 7465 725f 7261 6469  adius(outer_radi
-0002eae0: 7573 2c20 2764 6567 2729 2e76 616c 7565  us, 'deg').value
-0002eaf0: 290a 2020 2020 2020 2020 656c 6966 206f  ).        elif o
-0002eb00: 7574 6572 5f72 6164 6975 7320 6973 204e  uter_radius is N
-0002eb10: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0002eb20: 206f 7574 5f72 6164 5f73 6561 7263 6820   out_rad_search 
-0002eb30: 3d20 225f 726f 220a 2020 2020 2020 2020  = "_ro".        
-0002eb40: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0002eb50: 2020 7261 6973 6520 5479 7065 4572 726f    raise TypeErro
-0002eb60: 7228 2259 6f75 206d 6179 206f 6e6c 7920  r("You may only 
-0002eb70: 7061 7373 2061 2071 7561 6e74 6974 7920  pass a quantity 
-0002eb80: 6f72 2061 2073 7472 696e 6720 6173 206f  or a string as o
-0002eb90: 7574 6572 5f72 6164 6975 7322 290a 0a20  uter_radius").. 
-0002eba0: 2020 2020 2020 2023 2043 6865 636b 2074         # Check t
-0002ebb0: 6f20 6d61 6b65 2073 7572 6520 7468 6174  o make sure that
-0002ebc0: 2074 6865 2074 696d 6520 6269 6e20 7369   the time bin si
-0002ebd0: 7a65 2069 7320 6120 6c65 6761 6c20 7661  ze is a legal va
-0002ebe0: 6c75 652c 2061 6e64 2073 6574 2075 7020  lue, and set up 
-0002ebf0: 6120 7365 6172 6368 2073 7472 696e 6720  a search string 
-0002ec00: 666f 7220 7468 6520 7469 6d65 2062 696e  for the time bin
-0002ec10: 0a20 2020 2020 2020 2023 2020 7369 7a65  .        #  size
-0002ec20: 2069 6e20 6f72 6465 7220 746f 206e 6172   in order to nar
-0002ec30: 726f 7720 646f 776e 2074 6865 206c 6967  row down the lig
-0002ec40: 6874 6375 7276 6573 2074 6f20 6a75 7374  htcurves to just
-0002ec50: 2074 6865 206f 6e65 7320 7468 6174 2074   the ones that t
-0002ec60: 6865 2075 7365 7220 7761 6e74 730a 2020  he user wants.  
-0002ec70: 2020 2020 2020 6966 2074 696d 655f 6269        if time_bi
-0002ec80: 6e5f 7369 7a65 2069 7320 6e6f 7420 4e6f  n_size is not No
-0002ec90: 6e65 2061 6e64 206e 6f74 2074 696d 655f  ne and not time_
-0002eca0: 6269 6e5f 7369 7a65 2e75 6e69 742e 6973  bin_size.unit.is
-0002ecb0: 5f65 7175 6976 616c 656e 7428 2773 2729  _equivalent('s')
-0002ecc0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-0002ecd0: 6973 6520 556e 6974 436f 6e76 6572 7369  ise UnitConversi
-0002ece0: 6f6e 4572 726f 7228 2254 6865 2027 7469  onError("The 'ti
-0002ecf0: 6d65 5f62 696e 5f73 697a 6527 2061 7267  me_bin_size' arg
-0002ed00: 756d 656e 7420 6d75 7374 2062 6520 636f  ument must be co
-0002ed10: 6e76 6572 7469 626c 6520 746f 2073 6563  nvertible to sec
-0002ed20: 6f6e 6473 2e22 290a 2020 2020 2020 2020  onds.").        
-0002ed30: 656c 6966 2074 696d 655f 6269 6e5f 7369  elif time_bin_si
-0002ed40: 7a65 2069 7320 4e6f 6e65 3a0a 2020 2020  ze is None:.    
-0002ed50: 2020 2020 2020 2020 7469 6d65 5f62 696e          time_bin
-0002ed60: 5f73 6561 7263 6820 3d20 275f 7469 6d65  _search = '_time
-0002ed70: 6269 6e27 0a20 2020 2020 2020 2065 6c73  bin'.        els
-0002ed80: 653a 0a20 2020 2020 2020 2020 2020 2074  e:.            t
-0002ed90: 696d 655f 6269 6e5f 7365 6172 6368 203d  ime_bin_search =
-0002eda0: 2027 5f74 696d 6562 696e 7b7d 272e 666f   '_timebin{}'.fo
-0002edb0: 726d 6174 2874 696d 655f 6269 6e5f 7369  rmat(time_bin_si
-0002edc0: 7a65 2e74 6f28 2773 2729 2e76 616c 7565  ze.to('s').value
-0002edd0: 290a 0a20 2020 2020 2020 2023 2053 6574  )..        # Set
-0002ede0: 7469 6e67 2075 7020 7468 6520 656e 6572  ting up the ener
-0002edf0: 6779 2062 616e 6420 7365 6172 6368 2073  gy band search s
-0002ee00: 7472 696e 6720 2d20 6966 206f 6e65 2062  tring - if one b
-0002ee10: 6f75 6e64 2069 7320 7370 6563 6966 6965  ound is specifie
-0002ee20: 6420 7468 656e 2074 6865 206f 7468 6572  d then the other
-0002ee30: 2068 6173 2074 6f20 6265 2061 7320 7765   has to be as we
-0002ee40: 6c6c 2c20 490a 2020 2020 2020 2020 2320  ll, I.        # 
-0002ee50: 2064 6964 6e27 7420 7468 696e 6b20 6974   didn't think it
-0002ee60: 206d 6164 6520 7365 6e73 6520 6f74 6865   made sense othe
-0002ee70: 7277 6973 650a 2020 2020 2020 2020 6966  rwise.        if
-0002ee80: 2061 6e79 285b 6c6f 5f65 6e20 6973 206e   any([lo_en is n
-0002ee90: 6f74 204e 6f6e 652c 2068 695f 656e 2069  ot None, hi_en i
-0002eea0: 7320 6e6f 7420 4e6f 6e65 5d29 2061 6e64  s not None]) and
-0002eeb0: 206e 6f74 2061 6c6c 285b 6c6f 5f65 6e20   not all([lo_en 
-0002eec0: 6973 206e 6f74 204e 6f6e 652c 2068 695f  is not None, hi_
-0002eed0: 656e 2069 7320 6e6f 7420 4e6f 6e65 5d29  en is not None])
-0002eee0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-0002eef0: 6973 6520 5661 6c75 6545 7272 6f72 2822  ise ValueError("
-0002ef00: 5468 6520 276c 6f5f 656e 2720 616e 6420  The 'lo_en' and 
-0002ef10: 2768 695f 656e 2720 7661 6c75 6573 206d  'hi_en' values m
-0002ef20: 7573 7420 6569 7468 6572 2062 6f74 6820  ust either both 
-0002ef30: 6265 204e 6f6e 652c 206f 7220 626f 7468  be None, or both
-0002ef40: 2062 6520 616e 2065 6e65 7267 7920 7661   be an energy va
-0002ef50: 6c75 652e 2229 0a20 2020 2020 2020 2069  lue.").        i
-0002ef60: 6620 286c 6f5f 656e 2069 7320 6e6f 7420  f (lo_en is not 
-0002ef70: 4e6f 6e65 2061 6e64 206e 6f74 206c 6f5f  None and not lo_
-0002ef80: 656e 2e75 6e69 742e 6973 5f65 7175 6976  en.unit.is_equiv
-0002ef90: 616c 656e 7428 276b 6556 2729 2920 6f72  alent('keV')) or
-0002efa0: 205c 0a20 2020 2020 2020 2020 2020 2020   \.             
-0002efb0: 2020 2028 6869 5f65 6e20 6973 206e 6f74     (hi_en is not
-0002efc0: 204e 6f6e 6520 616e 6420 6e6f 7420 6869   None and not hi
-0002efd0: 5f65 6e2e 756e 6974 2e69 735f 6571 7569  _en.unit.is_equi
-0002efe0: 7661 6c65 6e74 2827 6b65 5627 2929 3a0a  valent('keV')):.
-0002eff0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0002f000: 6520 556e 6974 436f 6e76 6572 7369 6f6e  e UnitConversion
-0002f010: 4572 726f 7228 2254 6865 2027 6c6f 5f65  Error("The 'lo_e
-0002f020: 6e27 2061 6e64 2027 6869 5f65 6e27 2061  n' and 'hi_en' a
-0002f030: 7267 756d 656e 7473 206d 7573 7420 6265  rguments must be
-0002f040: 2063 6f6e 7665 7274 6962 6c65 2074 6f20   convertible to 
-0002f050: 6b65 562e 2229 0a20 2020 2020 2020 2023  keV.").        #
-0002f060: 2049 6620 6569 7468 6572 2069 7320 4e6f   If either is No
-0002f070: 6e65 2074 6865 6e20 7765 206b 6e6f 7720  ne then we know 
-0002f080: 626f 7468 2061 7265 2062 6563 6175 7365  both are because
-0002f090: 2077 6520 6368 6563 6b65 6420 6561 726c   we checked earl
-0002f0a0: 6965 720a 2020 2020 2020 2020 656c 6966  ier.        elif
-0002f0b0: 206c 6f5f 656e 2069 7320 4e6f 6e65 3a0a   lo_en is None:.
-0002f0c0: 2020 2020 2020 2020 2020 2020 656e 5f73              en_s
-0002f0d0: 6561 7263 6820 3d20 2762 6f75 6e64 5f27  earch = 'bound_'
-0002f0e0: 0a20 2020 2020 2020 2065 6c69 6620 6c6f  .        elif lo
-0002f0f0: 5f65 6e20 6973 206e 6f74 204e 6f6e 653a  _en is not None:
-0002f100: 0a20 2020 2020 2020 2020 2020 2065 6e5f  .            en_
-0002f110: 7365 6172 6368 203d 2027 626f 756e 645f  search = 'bound_
-0002f120: 7b6c 7d2d 7b75 7d27 2e66 6f72 6d61 7428  {l}-{u}'.format(
-0002f130: 6c3d 6c6f 5f65 6e2e 746f 2827 6b65 5627  l=lo_en.to('keV'
-0002f140: 292e 7661 6c75 652c 2075 3d68 695f 656e  ).value, u=hi_en
-0002f150: 2e74 6f28 276b 6556 2729 2e76 616c 7565  .to('keV').value
-0002f160: 290a 0a20 2020 2020 2020 2069 6620 6f62  )..        if ob
-0002f170: 735f 6964 203d 3d20 2763 6f6d 6269 6e65  s_id == 'combine
-0002f180: 6427 3a0a 2020 2020 2020 2020 2020 2020  d':.            
-0002f190: 7365 6172 6368 5f6b 6579 203d 2027 636f  search_key = 'co
-0002f1a0: 6d62 696e 6564 5f6c 6967 6874 6375 7276  mbined_lightcurv
-0002f1b0: 6527 0a20 2020 2020 2020 2065 6c73 653a  e'.        else:
-0002f1c0: 0a20 2020 2020 2020 2020 2020 2073 6561  .            sea
-0002f1d0: 7263 685f 6b65 7920 3d20 276c 6967 6874  rch_key = 'light
-0002f1e0: 6375 7276 6527 0a20 2020 2020 2020 2023  curve'.        #
-0002f1f0: 2047 7261 6262 696e 6720 6576 6572 7920   Grabbing every 
-0002f200: 7369 6e67 6c65 206c 6967 6874 6375 7276  single lightcurv
-0002f210: 6520 7468 6174 206d 6174 6368 6573 204f  e that matches O
-0002f220: 6273 4944 2061 6e64 2069 6e73 7420 7061  bsID and inst pa
-0002f230: 7373 6564 2062 7920 7468 6520 7573 6572  ssed by the user
-0002f240: 2028 7265 6d65 6d62 6572 2074 6865 7920   (remember they 
-0002f250: 636f 756c 6420 6265 0a20 2020 2020 2020  could be.       
-0002f260: 2023 2020 4e6f 6e65 2076 616c 7565 732c   #  None values,
-0002f270: 2069 6e64 6565 6420 7468 6579 2061 7265   indeed they are
-0002f280: 2062 7920 6465 6661 756c 7429 202d 2077   by default) - w
-0002f290: 6527 6c6c 2074 6865 6e20 7377 6565 7020  e'll then sweep 
-0002f2a0: 7468 726f 7567 6820 7768 6174 6576 6572  through whatever
-0002f2b0: 206c 6973 7420 6973 2072 6574 7572 6e65   list is returne
-0002f2c0: 6420 616e 640a 2020 2020 2020 2020 2320  d and.        # 
-0002f2d0: 206e 6172 726f 7720 7468 656d 2064 6f77   narrow them dow
-0002f2e0: 6e0a 2020 2020 2020 2020 616c 6c5f 6c63  n.        all_lc
-0002f2f0: 7320 3d20 7365 6c66 2e67 6574 5f70 726f  s = self.get_pro
-0002f300: 6475 6374 7328 7365 6172 6368 5f6b 6579  ducts(search_key
-0002f310: 2c20 6f62 735f 6964 2c20 696e 7374 290a  , obs_id, inst).
-0002f320: 2020 2020 2020 2020 2320 4974 2077 6173          # It was
-0002f330: 2067 6574 7469 6e67 2074 6f20 7468 6520   getting to the 
-0002f340: 706f 696e 7420 7768 6572 6520 6120 6c69  point where a li
-0002f350: 7374 2063 6f6d 7072 6568 656e 7369 6f6e  st comprehension
-0002f360: 2077 6173 206c 6573 7320 7265 6164 6162   was less readab
-0002f370: 6c65 2074 6861 6e20 6120 666f 7220 6c6f  le than a for lo
-0002f380: 6f70 2c20 7061 7274 6963 756c 6172 6c79  op, particularly
-0002f390: 0a20 2020 2020 2020 2023 2020 7769 7468  .        #  with
-0002f3a0: 2074 6865 2070 6174 7465 726e 206c 6f67   the pattern log
-0002f3b0: 6963 2c20 736f 2049 2063 6861 6e67 6564  ic, so I changed
-0002f3c0: 2069 7420 746f 2074 6869 730a 2020 2020   it to this.    
-0002f3d0: 2020 2020 6d61 7463 6865 645f 7072 6f64      matched_prod
-0002f3e0: 7320 3d20 5b5d 0a20 2020 2020 2020 2066  s = [].        f
-0002f3f0: 6f72 206c 6320 696e 2061 6c6c 5f6c 6373  or lc in all_lcs
-0002f400: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-0002f410: 206f 7574 5f72 6164 5f73 6561 7263 6820   out_rad_search 
-0002f420: 696e 206c 632e 7374 6f72 6167 655f 6b65  in lc.storage_ke
-0002f430: 7920 616e 6420 696e 6e5f 7261 645f 7365  y and inn_rad_se
-0002f440: 6172 6368 2069 6e20 6c63 2e73 746f 7261  arch in lc.stora
-0002f450: 6765 5f6b 6579 2061 6e64 205c 0a20 2020  ge_key and \.   
-0002f460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f470: 2074 696d 655f 6269 6e5f 7365 6172 6368   time_bin_search
-0002f480: 2069 6e20 6c63 2e73 746f 7261 6765 5f6b   in lc.storage_k
-0002f490: 6579 2061 6e64 2065 6e5f 7365 6172 6368  ey and en_search
-0002f4a0: 2069 6e20 6c63 2e73 746f 7261 6765 5f6b   in lc.storage_k
-0002f4b0: 6579 3a0a 2020 2020 2020 2020 2020 2020  ey:.            
-0002f4c0: 2020 2020 6d61 7463 6865 645f 7072 6f64      matched_prod
-0002f4d0: 732e 6170 7065 6e64 286c 6329 0a0a 2020  s.append(lc)..  
-0002f4e0: 2020 2020 2020 6966 206c 656e 286d 6174        if len(mat
-0002f4f0: 6368 6564 5f70 726f 6473 2920 3d3d 2030  ched_prods) == 0
-0002f500: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-0002f510: 6973 6520 4e6f 5072 6f64 7563 7441 7661  ise NoProductAva
-0002f520: 696c 6162 6c65 4572 726f 7228 2243 616e  ilableError("Can
-0002f530: 6e6f 7420 6669 6e64 2061 6e79 206c 6967  not find any lig
-0002f540: 6874 6375 7276 6573 206d 6174 6368 696e  htcurves matchin
-0002f550: 6720 796f 7572 2069 6e70 7574 2e22 290a  g your input.").
-0002f560: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0002f570: 6d61 7463 6865 645f 7072 6f64 730a 0a20  matched_prods.. 
-0002f580: 2020 2064 6566 2067 6574 5f6c 6967 6874     def get_light
-0002f590: 6375 7276 6573 2873 656c 662c 206f 7574  curves(self, out
-0002f5a0: 6572 5f72 6164 6975 733a 2055 6e69 6f6e  er_radius: Union
-0002f5b0: 5b73 7472 2c20 5175 616e 7469 7479 5d20  [str, Quantity] 
-0002f5c0: 3d20 4e6f 6e65 2c20 6f62 735f 6964 3a20  = None, obs_id: 
-0002f5d0: 7374 7220 3d20 4e6f 6e65 2c20 696e 7374  str = None, inst
-0002f5e0: 3a20 7374 7220 3d20 4e6f 6e65 2c0a 2020  : str = None,.  
-0002f5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f600: 2020 2020 2020 696e 6e65 725f 7261 6469        inner_radi
-0002f610: 7573 3a20 556e 696f 6e5b 7374 722c 2051  us: Union[str, Q
-0002f620: 7561 6e74 6974 795d 203d 204e 6f6e 652c  uantity] = None,
-0002f630: 206c 6f5f 656e 3a20 5175 616e 7469 7479   lo_en: Quantity
-0002f640: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-0002f650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f660: 2068 695f 656e 3a20 5175 616e 7469 7479   hi_en: Quantity
-0002f670: 203d 204e 6f6e 652c 2074 696d 655f 6269   = None, time_bi
-0002f680: 6e5f 7369 7a65 3a20 5175 616e 7469 7479  n_size: Quantity
-0002f690: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-0002f6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f6b0: 2070 6174 7465 726e 3a20 556e 696f 6e5b   pattern: Union[
-0002f6c0: 6469 6374 2c20 7374 725d 203d 2027 6465  dict, str] = 'de
-0002f6d0: 6661 756c 7427 2920 2d3e 2055 6e69 6f6e  fault') -> Union
-0002f6e0: 5b4c 6967 6874 4375 7276 652c 204c 6973  [LightCurve, Lis
-0002f6f0: 745b 4c69 6768 7443 7572 7665 5d5d 3a0a  t[LightCurve]]:.
-0002f700: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-0002f710: 2020 2020 4120 6d65 7468 6f64 2074 6f20      A method to 
-0002f720: 7265 7472 6965 7665 2058 4741 204c 6967  retrieve XGA Lig
-0002f730: 6874 4375 7276 6520 6f62 6a65 6374 732e  htCurve objects.
-0002f740: 0a0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
-0002f750: 2073 7472 2f51 7561 6e74 6974 7920 6f75   str/Quantity ou
-0002f760: 7465 725f 7261 6469 7573 3a20 5468 6520  ter_radius: The 
-0002f770: 6e61 6d65 206f 7220 7661 6c75 6520 6f66  name or value of
-0002f780: 2074 6865 206f 7574 6572 2072 6164 6975   the outer radiu
-0002f790: 7320 7468 6174 2077 6173 2075 7365 6420  s that was used 
-0002f7a0: 666f 7220 7468 6520 6765 6e65 7261 7469  for the generati
-0002f7b0: 6f6e 206f 660a 2020 2020 2020 2020 2020  on of.          
-0002f7c0: 2020 7468 6520 6c69 6768 7463 7572 7665    the lightcurve
-0002f7d0: 2028 666f 7220 696e 7374 616e 6365 2027   (for instance '
-0002f7e0: 706f 696e 7427 2077 6f75 6c64 2062 6520  point' would be 
-0002f7f0: 6163 6365 7074 6162 6c65 2066 6f72 2061  acceptable for a
-0002f800: 2050 6f69 6e74 536f 7572 6365 2c20 6f72   PointSource, or
-0002f810: 2051 7561 6e74 6974 7928 3130 302c 2027   Quantity(100, '
-0002f820: 6b70 6327 2929 2e0a 2020 2020 2020 2020  kpc'))..        
-0002f830: 2020 2020 4465 6661 756c 7420 6973 204e      Default is N
-0002f840: 6f6e 652c 206d 6561 6e69 6e67 2061 6c6c  one, meaning all
-0002f850: 206c 6967 6874 6375 7276 6573 2077 696c   lightcurves wil
-0002f860: 6c20 6265 2072 6574 7269 6576 6564 2e0a  l be retrieved..
-0002f870: 2020 2020 2020 2020 3a70 6172 616d 2073          :param s
-0002f880: 7472 206f 6273 5f69 643a 204f 7074 696f  tr obs_id: Optio
-0002f890: 6e61 6c6c 792c 2061 2073 7065 6369 6669  nally, a specifi
-0002f8a0: 6320 6f62 735f 6964 2074 6f20 7365 6172  c obs_id to sear
-0002f8b0: 6368 2066 6f72 2063 616e 2062 6520 7375  ch for can be su
-0002f8c0: 7070 6c69 6564 2e20 5468 6520 6465 6661  pplied. The defa
-0002f8d0: 756c 7420 6973 204e 6f6e 652c 0a20 2020  ult is None,.   
-0002f8e0: 2020 2020 2020 2020 2077 6869 6368 206d           which m
-0002f8f0: 6561 6e73 2061 6c6c 206c 6967 6874 6375  eans all lightcu
-0002f900: 7276 6573 206d 6174 6368 696e 6720 7468  rves matching th
-0002f910: 6520 6f74 6865 7220 6372 6974 6572 6961  e other criteria
-0002f920: 2077 696c 6c20 6265 2072 6574 7572 6e65   will be returne
-0002f930: 642e 0a20 2020 2020 2020 203a 7061 7261  d..        :para
-0002f940: 6d20 7374 7220 696e 7374 3a20 4f70 7469  m str inst: Opti
-0002f950: 6f6e 616c 6c79 2c20 6120 7370 6563 6966  onally, a specif
-0002f960: 6963 2069 6e73 7472 756d 656e 7420 746f  ic instrument to
-0002f970: 2073 6561 7263 6820 666f 7220 6361 6e20   search for can 
-0002f980: 6265 2073 7570 706c 6965 642e 2054 6865  be supplied. The
-0002f990: 2064 6566 6175 6c74 2069 7320 4e6f 6e65   default is None
-0002f9a0: 2c0a 2020 2020 2020 2020 2020 2020 7768  ,.            wh
-0002f9b0: 6963 6820 6d65 616e 7320 616c 6c20 6c69  ich means all li
-0002f9c0: 6768 7463 7572 7665 7320 6d61 7463 6869  ghtcurves matchi
-0002f9d0: 6e67 2074 6865 206f 7468 6572 2063 7269  ng the other cri
-0002f9e0: 7465 7269 6120 7769 6c6c 2062 6520 7265  teria will be re
-0002f9f0: 7475 726e 6564 2e0a 2020 2020 2020 2020  turned..        
-0002fa00: 3a70 6172 616d 2073 7472 2f51 7561 6e74  :param str/Quant
-0002fa10: 6974 7920 696e 6e65 725f 7261 6469 7573  ity inner_radius
-0002fa20: 3a20 5468 6520 6e61 6d65 206f 7220 7661  : The name or va
-0002fa30: 6c75 6520 6f66 2074 6865 2069 6e6e 6572  lue of the inner
-0002fa40: 2072 6164 6975 7320 7468 6174 2077 6173   radius that was
-0002fa50: 2075 7365 6420 666f 7220 7468 6520 6765   used for the ge
-0002fa60: 6e65 7261 7469 6f6e 206f 660a 2020 2020  neration of.    
-0002fa70: 2020 2020 2020 2020 7468 6520 6c69 6768          the ligh
-0002fa80: 7463 7572 7665 2028 666f 7220 696e 7374  tcurve (for inst
-0002fa90: 616e 6365 2027 706f 696e 7427 2077 6f75  ance 'point' wou
-0002faa0: 6c64 2062 6520 6163 6365 7074 6162 6c65  ld be acceptable
-0002fab0: 2066 6f72 2061 2050 6f69 6e74 536f 7572   for a PointSour
-0002fac0: 6365 2c20 6f72 2051 7561 6e74 6974 7928  ce, or Quantity(
-0002fad0: 302c 2027 6b70 6327 2929 2e0a 2020 2020  0, 'kpc'))..    
-0002fae0: 2020 2020 2020 2020 4465 6661 756c 7420          Default 
-0002faf0: 6973 204e 6f6e 652c 206d 6561 6e69 6e67  is None, meaning
-0002fb00: 2061 6c6c 206c 6967 6874 6375 7276 6573   all lightcurves
-0002fb10: 2077 696c 6c20 6265 2072 6574 7269 6576   will be retriev
-0002fb20: 6564 2e0a 2020 2020 2020 2020 3a70 6172  ed..        :par
-0002fb30: 616d 2051 7561 6e74 6974 7920 6c6f 5f65  am Quantity lo_e
-0002fb40: 6e3a 2054 6865 206c 6f77 6572 2065 6e65  n: The lower ene
-0002fb50: 7267 7920 6c69 6d69 7420 6f66 2074 6865  rgy limit of the
-0002fb60: 206c 6967 6874 6375 7276 6573 2079 6f75   lightcurves you
-0002fb70: 2077 6973 6820 746f 2072 6574 7269 6576   wish to retriev
-0002fb80: 652c 2074 6865 2064 6566 6175 6c74 0a20  e, the default. 
-0002fb90: 2020 2020 2020 2020 2020 2069 7320 4e6f             is No
-0002fba0: 6e65 2028 7768 6963 6820 7769 6c6c 2072  ne (which will r
-0002fbb0: 6574 7269 6576 6520 616c 6c20 6c69 6768  etrieve all ligh
-0002fbc0: 7463 7572 7665 7320 7265 6761 7264 6c65  tcurves regardle
-0002fbd0: 7373 206f 6620 656e 6572 6779 206c 696d  ss of energy lim
-0002fbe0: 6974 292e 0a20 2020 2020 2020 203a 7061  it)..        :pa
-0002fbf0: 7261 6d20 5175 616e 7469 7479 2068 695f  ram Quantity hi_
-0002fc00: 656e 3a20 5468 6520 7570 7065 7220 656e  en: The upper en
-0002fc10: 6572 6779 206c 696d 6974 206f 6620 7468  ergy limit of th
-0002fc20: 6520 6c69 6768 7463 7572 7665 7320 796f  e lightcurves yo
-0002fc30: 7520 7769 7368 2074 6f20 7265 7472 6965  u wish to retrie
-0002fc40: 7665 2c20 7468 6520 6465 6661 756c 740a  ve, the default.
-0002fc50: 2020 2020 2020 2020 2020 2020 6973 204e              is N
-0002fc60: 6f6e 6520 2877 6869 6368 2077 696c 6c20  one (which will 
-0002fc70: 7265 7472 6965 7665 2061 6c6c 206c 6967  retrieve all lig
-0002fc80: 6874 6375 7276 6573 2072 6567 6172 646c  htcurves regardl
-0002fc90: 6573 7320 6f66 2065 6e65 7267 7920 6c69  ess of energy li
-0002fca0: 6d69 7429 2e0a 2020 2020 2020 2020 3a70  mit)..        :p
-0002fcb0: 6172 616d 2051 7561 6e74 6974 7920 7469  aram Quantity ti
-0002fcc0: 6d65 5f62 696e 5f73 697a 653a 2054 6865  me_bin_size: The
-0002fcd0: 2074 696d 6520 6269 6e20 7369 7a65 2075   time bin size u
-0002fce0: 7365 6420 746f 2067 656e 6572 6174 6520  sed to generate 
-0002fcf0: 7468 6520 6465 7369 7265 6420 6c69 6768  the desired ligh
-0002fd00: 7463 7572 7665 2e20 5468 6520 6465 6661  tcurve. The defa
-0002fd10: 756c 7420 7661 6c75 650a 2020 2020 2020  ult value.      
-0002fd20: 2020 2020 2020 6973 204e 6f6e 652c 2069        is None, i
-0002fd30: 6e20 7768 6963 6820 6361 7365 2061 6c6c  n which case all
-0002fd40: 206c 6967 6874 6375 7276 6573 206d 6174   lightcurves mat
-0002fd50: 6368 696e 6720 6f74 6865 7220 6372 6974  ching other crit
-0002fd60: 6572 6961 2077 696c 6c20 6265 2072 6574  eria will be ret
-0002fd70: 7269 6576 6564 2e0a 2020 2020 2020 2020  rieved..        
-0002fd80: 3a70 6172 616d 2064 6963 7420 7061 7474  :param dict patt
-0002fd90: 6572 6e3a 2045 7665 6e74 2073 656c 6563  ern: Event selec
-0002fda0: 7469 6f6e 2070 6174 7465 726e 7320 7573  tion patterns us
-0002fdb0: 6564 2074 6f20 6372 6561 7465 206c 6967  ed to create lig
-0002fdc0: 6874 6375 7276 6573 206f 6620 696e 7465  htcurves of inte
-0002fdd0: 7265 7374 2e20 5468 6520 6465 6661 756c  rest. The defaul
-0002fde0: 7420 7661 6c75 6520 6973 0a20 2020 2020  t value is.     
-0002fdf0: 2020 2020 2020 2027 6465 6661 756c 7427         'default'
-0002fe00: 2077 6869 6368 2075 7365 7320 7468 6520   which uses the 
-0002fe10: 6465 6661 756c 7420 7661 6c75 6573 2066  default values f
-0002fe20: 6f72 2067 656e 6572 6174 696e 6720 6c69  or generating li
-0002fe30: 6768 7463 7572 7665 7320 666f 7220 6469  ghtcurves for di
-0002fe40: 6666 6572 656e 7420 696e 7374 7275 6d65  fferent instrume
-0002fe50: 6e74 732c 206f 7220 796f 750a 2020 2020  nts, or you.    
-0002fe60: 2020 2020 2020 2020 6361 6e20 7061 7373          can pass
-0002fe70: 2061 2064 6963 7469 6f6e 6172 7920 7769   a dictionary wi
-0002fe80: 7468 2070 6174 7465 726e 7320 696e 3b20  th patterns in; 
-0002fe90: 652e 672e 207b 2770 6e27 3a20 273c 3d34  e.g. {'pn': '<=4
-0002fea0: 272c 2027 6d6f 7327 3a20 273c 3d31 3227  ', 'mos': '<=12'
-0002feb0: 7d2e 2059 6f75 2063 616e 2061 6c73 6f20  }. You can also 
-0002fec0: 7061 7373 204e 6f6e 652c 2077 6869 6368  pass None, which
-0002fed0: 0a20 2020 2020 2020 2020 2020 206d 6561  .            mea
-0002fee0: 6e73 2061 6c6c 206c 6967 6874 2063 7572  ns all light cur
-0002fef0: 7665 7320 6d61 7463 6869 6e67 206f 7468  ves matching oth
-0002ff00: 6572 2073 6561 7263 6820 7465 726d 7320  er search terms 
-0002ff10: 7769 6c6c 2062 6520 7265 7475 726e 6564  will be returned
-0002ff20: 2e0a 2020 2020 2020 2020 3a72 6574 7572  ..        :retur
-0002ff30: 6e3a 2041 6e20 5847 4120 4c69 6768 7443  n: An XGA LightC
-0002ff40: 7572 7665 206f 626a 6563 7420 2869 6620  urve object (if 
-0002ff50: 7468 6572 6520 6973 2061 6e20 6578 6163  there is an exac
-0002ff60: 7420 6d61 7463 6829 2c20 6f72 2061 206c  t match), or a l
-0002ff70: 6973 7420 6f66 2058 4741 204c 6967 6874  ist of XGA Light
-0002ff80: 4375 7276 6520 6f62 6a65 6374 7320 2869  Curve objects (i
-0002ff90: 6620 7468 6572 650a 2020 2020 2020 2020  f there.        
-0002ffa0: 2020 2020 7765 7265 206d 756c 7469 706c      were multipl
-0002ffb0: 6520 6d61 7463 6869 6e67 2070 726f 6475  e matching produ
-0002ffc0: 6374 7329 2e0a 2020 2020 2020 2020 3a72  cts)..        :r
-0002ffd0: 7479 7065 3a20 556e 696f 6e5b 4c69 6768  type: Union[Ligh
-0002ffe0: 7443 7572 7665 2c20 4c69 7374 5b4c 6967  tCurve, List[Lig
-0002fff0: 6874 4375 7276 655d 5d0a 2020 2020 2020  htCurve]].      
-00030000: 2020 2222 220a 2020 2020 2020 2020 6672    """.        fr
-00030010: 6f6d 2078 6761 2e73 6173 2069 6d70 6f72  om xga.sas impor
-00030020: 7420 6368 6563 6b5f 7061 7474 6572 6e0a  t check_pattern.
-00030030: 0a20 2020 2020 2020 2023 2054 4f44 4f20  .        # TODO 
-00030040: 5468 6973 2069 7320 584d 4d20 7370 6563  This is XMM spec
-00030050: 6966 6963 2062 6563 6175 7365 206f 6620  ific because of 
-00030060: 7468 6520 7061 7474 6572 6e73 2063 7572  the patterns cur
-00030070: 7265 6e74 6c79 0a20 2020 2020 2020 2023  rently.        #
-00030080: 2054 6869 7320 6973 2077 6865 7265 2077   This is where w
-00030090: 6520 7365 7420 7570 2074 6865 2073 6561  e set up the sea
-000300a0: 7263 6820 7374 7269 6e67 2066 6f72 2074  rch string for t
-000300b0: 6865 2070 6174 7465 726e 7320 7370 6563  he patterns spec
-000300c0: 6966 6965 6420 6279 2074 6865 2075 7365  ified by the use
-000300d0: 722e 0a20 2020 2020 2020 2069 6620 7061  r..        if pa
-000300e0: 7474 6572 6e20 6973 204e 6f6e 653a 0a20  ttern is None:. 
-000300f0: 2020 2020 2020 2020 2020 2070 6174 745f             patt_
-00030100: 7365 6172 6368 203d 2022 5f70 6174 7465  search = "_patte
-00030110: 726e 220a 2020 2020 2020 2020 656c 6966  rn".        elif
-00030120: 2069 7369 6e73 7461 6e63 6528 7061 7474   isinstance(patt
-00030130: 6572 6e2c 2073 7472 293a 0a20 2020 2020  ern, str):.     
-00030140: 2020 2020 2020 2070 6174 7465 726e 203d         pattern =
-00030150: 207b 2770 6e27 3a20 273c 3d34 272c 2027   {'pn': '<=4', '
-00030160: 6d6f 7327 3a20 273c 3d31 3227 7d0a 2020  mos': '<=12'}.  
-00030170: 2020 2020 2020 2020 2020 7061 7474 5f73            patt_s
-00030180: 6561 7263 6820 3d20 7b69 6e73 743a 2022  earch = {inst: "
-00030190: 5f70 6174 7465 726e 2220 2b20 6368 6563  _pattern" + chec
-000301a0: 6b5f 7061 7474 6572 6e28 7061 7474 295b  k_pattern(patt)[
-000301b0: 315d 2066 6f72 2069 6e73 742c 2070 6174  1] for inst, pat
-000301c0: 7420 696e 2070 6174 7465 726e 2e69 7465  t in pattern.ite
-000301d0: 6d73 2829 7d0a 2020 2020 2020 2020 656c  ms()}.        el
-000301e0: 6966 2069 7369 6e73 7461 6e63 6528 7061  if isinstance(pa
-000301f0: 7474 6572 6e2c 2064 6963 7429 3a0a 2020  ttern, dict):.  
-00030200: 2020 2020 2020 2020 2020 6966 2027 6d6f            if 'mo
-00030210: 7331 2720 696e 206c 6973 7428 7061 7474  s1' in list(patt
-00030220: 6572 6e2e 6b65 7973 2829 2920 6f72 2027  ern.keys()) or '
-00030230: 6d6f 7332 2720 696e 206c 6973 7428 7061  mos2' in list(pa
-00030240: 7474 6572 6e2e 6b65 7973 2829 293a 0a20  ttern.keys()):. 
-00030250: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00030260: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-00030270: 2253 7065 6369 6669 6320 4d4f 5320 696e  "Specific MOS in
-00030280: 7374 7275 6d65 6e74 7320 646f 206e 6f74  struments do not
-00030290: 206e 6565 6420 746f 2062 6520 7370 6563   need to be spec
-000302a0: 6966 6965 6420 666f 7220 2770 6174 7465  ified for 'patte
-000302b0: 726e 273b 2069 2e65 2e20 7468 6572 6520  rn'; i.e. there 
-000302c0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-000302d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000302e0: 2020 2022 7368 6f75 6c64 2062 6520 6f6e     "should be on
-000302f0: 6520 656e 7472 7920 666f 7220 276d 6f73  e entry for 'mos
-00030300: 272e 2229 0a20 2020 2020 2020 2020 2020  '.").           
-00030310: 2070 6174 7465 726e 203d 207b 696e 7374   pattern = {inst
-00030320: 3a20 7061 7474 2e72 6570 6c61 6365 2827  : patt.replace('
-00030330: 2027 2c20 2727 2920 666f 7220 696e 7374   ', '') for inst
-00030340: 2c20 7061 7474 2069 6e20 7061 7474 6572  , patt in patter
-00030350: 6e2e 6974 656d 7328 297d 0a20 2020 2020  n.items()}.     
-00030360: 2020 2020 2020 2070 6174 745f 7365 6172         patt_sear
-00030370: 6368 203d 207b 696e 7374 3a20 225f 7061  ch = {inst: "_pa
-00030380: 7474 6572 6e22 202b 2063 6865 636b 5f70  ttern" + check_p
-00030390: 6174 7465 726e 2870 6174 7429 5b31 5d20  attern(patt)[1] 
-000303a0: 666f 7220 696e 7374 2c20 7061 7474 2069  for inst, patt i
-000303b0: 6e20 7061 7474 6572 6e2e 6974 656d 7328  n pattern.items(
-000303c0: 297d 0a20 2020 2020 2020 2065 6c73 653a  )}.        else:
-000303d0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-000303e0: 7365 2054 7970 6545 7272 6f72 2822 5468  se TypeError("Th
-000303f0: 6520 2770 6174 7465 726e 2720 6172 6775  e 'pattern' argu
-00030400: 6d65 6e74 206d 7573 7420 6265 2065 6974  ment must be eit
-00030410: 6865 7220 2764 6566 6175 6c74 272c 206f  her 'default', o
-00030420: 7220 6120 6469 6374 696f 6e61 7279 2077  r a dictionary w
-00030430: 6865 7265 2074 6865 206b 6579 7320 6172  here the keys ar
-00030440: 6520 220a 2020 2020 2020 2020 2020 2020  e ".            
-00030450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030460: 2269 6e73 7472 756d 656e 7420 6e61 6d65  "instrument name
-00030470: 7320 616e 6420 7661 6c75 6573 2061 7265  s and values are
-00030480: 2073 7472 696e 6720 7061 7474 6572 6e73   string patterns
-00030490: 2e22 290a 0a20 2020 2020 2020 2023 204a  .")..        # J
-000304a0: 7573 7420 6d61 6b65 7320 7468 6520 7365  ust makes the se
-000304b0: 6172 6368 2065 6173 6965 7220 646f 776e  arch easier down
-000304c0: 2074 6865 206c 696e 650a 2020 2020 2020   the line.      
-000304d0: 2020 6966 2027 6d6f 7327 2069 6e20 7061    if 'mos' in pa
-000304e0: 7474 5f73 6561 7263 683a 0a20 2020 2020  tt_search:.     
-000304f0: 2020 2020 2020 2070 6174 745f 7365 6172         patt_sear
-00030500: 6368 2e75 7064 6174 6528 7b27 6d6f 7331  ch.update({'mos1
-00030510: 273a 2070 6174 745f 7365 6172 6368 5b27  ': patt_search['
-00030520: 6d6f 7327 5d2c 2027 6d6f 7332 273a 2070  mos'], 'mos2': p
-00030530: 6174 745f 7365 6172 6368 5b27 6d6f 7327  att_search['mos'
-00030540: 5d7d 290a 0a20 2020 2020 2020 2073 6f6d  ]})..        som
-00030550: 655f 6c63 7320 3d20 7365 6c66 2e5f 6765  e_lcs = self._ge
-00030560: 745f 6c63 5f70 726f 6428 6f75 7465 725f  t_lc_prod(outer_
-00030570: 7261 6469 7573 2c20 6f62 735f 6964 2c20  radius, obs_id, 
-00030580: 696e 7374 2c20 696e 6e65 725f 7261 6469  inst, inner_radi
-00030590: 7573 2c20 6c6f 5f65 6e2c 2068 695f 656e  us, lo_en, hi_en
-000305a0: 2c20 7469 6d65 5f62 696e 5f73 697a 6529  , time_bin_size)
-000305b0: 0a20 2020 2020 2020 206d 6174 6368 6564  .        matched
-000305c0: 5f70 726f 6473 203d 205b 5d0a 2020 2020  _prods = [].    
-000305d0: 2020 2020 666f 7220 6c63 2069 6e20 736f      for lc in so
-000305e0: 6d65 5f6c 6373 3a0a 2020 2020 2020 2020  me_lcs:.        
-000305f0: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-00030600: 6528 7061 7474 5f73 6561 7263 682c 2073  e(patt_search, s
-00030610: 7472 293a 0a20 2020 2020 2020 2020 2020  tr):.           
-00030620: 2020 2020 2072 656c 5f70 6174 745f 7365       rel_patt_se
-00030630: 6172 6368 203d 2070 6174 745f 7365 6172  arch = patt_sear
-00030640: 6368 0a20 2020 2020 2020 2020 2020 2065  ch.            e
-00030650: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00030660: 2020 2020 2072 656c 5f70 6174 745f 7365       rel_patt_se
-00030670: 6172 6368 203d 2070 6174 745f 7365 6172  arch = patt_sear
-00030680: 6368 5b6c 632e 696e 7374 7275 6d65 6e74  ch[lc.instrument
-00030690: 5d0a 0a20 2020 2020 2020 2020 2020 2069  ]..            i
-000306a0: 6620 7265 6c5f 7061 7474 5f73 6561 7263  f rel_patt_searc
-000306b0: 6820 696e 206c 632e 7374 6f72 6167 655f  h in lc.storage_
-000306c0: 6b65 793a 0a20 2020 2020 2020 2020 2020  key:.           
-000306d0: 2020 2020 206d 6174 6368 6564 5f70 726f       matched_pro
-000306e0: 6473 2e61 7070 656e 6428 6c63 290a 0a20  ds.append(lc).. 
-000306f0: 2020 2020 2020 2069 6620 6c65 6e28 6d61         if len(ma
-00030700: 7463 6865 645f 7072 6f64 7329 203d 3d20  tched_prods) == 
-00030710: 313a 0a20 2020 2020 2020 2020 2020 206d  1:.            m
-00030720: 6174 6368 6564 5f70 726f 6473 203d 206d  atched_prods = m
-00030730: 6174 6368 6564 5f70 726f 6473 5b30 5d0a  atched_prods[0].
-00030740: 2020 2020 2020 2020 656c 6966 206c 656e          elif len
-00030750: 286d 6174 6368 6564 5f70 726f 6473 2920  (matched_prods) 
-00030760: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
-00030770: 2020 7261 6973 6520 4e6f 5072 6f64 7563    raise NoProduc
-00030780: 7441 7661 696c 6162 6c65 4572 726f 7228  tAvailableError(
-00030790: 2243 616e 6e6f 7420 6669 6e64 2061 6e79  "Cannot find any
-000307a0: 206c 6967 6874 6375 7276 6573 206d 6174   lightcurves mat
-000307b0: 6368 696e 6720 796f 7572 2069 6e70 7574  ching your input
-000307c0: 2e22 290a 0a20 2020 2020 2020 2072 6574  .")..        ret
-000307d0: 7572 6e20 6d61 7463 6865 645f 7072 6f64  urn matched_prod
-000307e0: 730a 0a20 2020 2064 6566 2067 6574 5f63  s..    def get_c
-000307f0: 6f6d 6269 6e65 645f 6c69 6768 7463 7572  ombined_lightcur
-00030800: 7665 7328 7365 6c66 2c20 6f75 7465 725f  ves(self, outer_
-00030810: 7261 6469 7573 3a20 556e 696f 6e5b 7374  radius: Union[st
-00030820: 722c 2051 7561 6e74 6974 795d 203d 204e  r, Quantity] = N
-00030830: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
-00030840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030850: 2020 2020 2020 696e 6e65 725f 7261 6469        inner_radi
-00030860: 7573 3a20 556e 696f 6e5b 7374 722c 2051  us: Union[str, Q
-00030870: 7561 6e74 6974 795d 203d 204e 6f6e 652c  uantity] = None,
-00030880: 206c 6f5f 656e 3a20 5175 616e 7469 7479   lo_en: Quantity
-00030890: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-000308a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000308b0: 2020 2020 2020 2020 2020 6869 5f65 6e3a            hi_en:
-000308c0: 2051 7561 6e74 6974 7920 3d20 4e6f 6e65   Quantity = None
-000308d0: 2c20 7469 6d65 5f62 696e 5f73 697a 653a  , time_bin_size:
-000308e0: 2051 7561 6e74 6974 7920 3d20 4e6f 6e65   Quantity = None
-000308f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00030900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030910: 2020 2070 6174 7465 726e 3a20 556e 696f     pattern: Unio
-00030920: 6e5b 6469 6374 2c20 7374 725d 203d 2022  n[dict, str] = "
-00030930: 6465 6661 756c 7422 2920 5c0a 2020 2020  default") \.    
-00030940: 2020 2020 2020 2020 2d3e 2055 6e69 6f6e          -> Union
-00030950: 5b41 6767 7265 6761 7465 4c69 6768 7443  [AggregateLightC
-00030960: 7572 7665 2c20 4c69 7374 5b41 6767 7265  urve, List[Aggre
-00030970: 6761 7465 4c69 6768 7443 7572 7665 5d5d  gateLightCurve]]
-00030980: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-00030990: 2020 2020 2020 4120 6d65 7468 6f64 2074        A method t
-000309a0: 6f20 7265 7472 6965 7665 2058 4741 2041  o retrieve XGA A
-000309b0: 6767 7265 6761 7465 4c69 6768 7443 7572  ggregateLightCur
-000309c0: 7665 206f 626a 6563 7473 2028 692e 652e  ve objects (i.e.
-000309d0: 206c 6967 6874 6375 7276 6573 2066 6f72   lightcurves for
-000309e0: 2074 6869 7320 6f62 6a65 6374 2074 6861   this object tha
-000309f0: 7420 7765 7265 2067 656e 6572 6174 6564  t were generated
-00030a00: 2061 740a 2020 2020 2020 2020 7468 6520   at.        the 
-00030a10: 7361 6d65 2074 696d 6520 616e 6420 6861  same time and ha
-00030a20: 7665 2062 6565 6e20 7061 636b 6167 6564  ve been packaged
-00030a30: 2074 6f67 6574 6865 7229 2e0a 0a20 2020   together)...   
-00030a40: 2020 2020 203a 7061 7261 6d20 7374 722f       :param str/
-00030a50: 5175 616e 7469 7479 206f 7574 6572 5f72  Quantity outer_r
-00030a60: 6164 6975 733a 2054 6865 206e 616d 6520  adius: The name 
-00030a70: 6f72 2076 616c 7565 206f 6620 7468 6520  or value of the 
-00030a80: 6f75 7465 7220 7261 6469 7573 2074 6861  outer radius tha
-00030a90: 7420 7761 7320 7573 6564 2066 6f72 2074  t was used for t
-00030aa0: 6865 2067 656e 6572 6174 696f 6e20 6f66  he generation of
-00030ab0: 0a20 2020 2020 2020 2020 2020 2074 6865  .            the
-00030ac0: 2061 6767 7265 6761 7465 206c 6967 6874   aggregate light
-00030ad0: 6375 7276 6520 2866 6f72 2069 6e73 7461  curve (for insta
-00030ae0: 6e63 6520 2770 6f69 6e74 2720 776f 756c  nce 'point' woul
-00030af0: 6420 6265 2061 6363 6570 7461 626c 6520  d be acceptable 
-00030b00: 666f 7220 6120 506f 696e 7453 6f75 7263  for a PointSourc
-00030b10: 652c 206f 720a 2020 2020 2020 2020 2020  e, or.          
-00030b20: 2020 5175 616e 7469 7479 2831 3030 2c20    Quantity(100, 
-00030b30: 276b 7063 2729 292e 2044 6566 6175 6c74  'kpc')). Default
-00030b40: 2069 7320 4e6f 6e65 2c20 6d65 616e 696e   is None, meanin
-00030b50: 6720 616c 6c20 6167 6772 6567 6174 6520  g all aggregate 
-00030b60: 6c69 6768 7463 7572 7665 7320 7769 6c6c  lightcurves will
-00030b70: 2062 6520 7265 7472 6965 7665 642e 0a20   be retrieved.. 
-00030b80: 2020 2020 2020 203a 7061 7261 6d20 7374         :param st
-00030b90: 722f 5175 616e 7469 7479 2069 6e6e 6572  r/Quantity inner
-00030ba0: 5f72 6164 6975 733a 2054 6865 206e 616d  _radius: The nam
-00030bb0: 6520 6f72 2076 616c 7565 206f 6620 7468  e or value of th
-00030bc0: 6520 696e 6e65 7220 7261 6469 7573 2074  e inner radius t
-00030bd0: 6861 7420 7761 7320 7573 6564 2066 6f72  hat was used for
-00030be0: 2074 6865 2067 656e 6572 6174 696f 6e20   the generation 
-00030bf0: 6f66 0a20 2020 2020 2020 2020 2020 2074  of.            t
-00030c00: 6865 2061 6767 7265 6761 7465 206c 6967  he aggregate lig
-00030c10: 6874 6375 7276 6520 2866 6f72 2069 6e73  htcurve (for ins
-00030c20: 7461 6e63 6520 2770 6f69 6e74 2720 776f  tance 'point' wo
-00030c30: 756c 6420 6265 2061 6363 6570 7461 626c  uld be acceptabl
-00030c40: 6520 666f 7220 6120 506f 696e 7453 6f75  e for a PointSou
-00030c50: 7263 652c 206f 720a 2020 2020 2020 2020  rce, or.        
-00030c60: 2020 2020 5175 616e 7469 7479 2830 2c20      Quantity(0, 
-00030c70: 276b 7063 2729 292e 2044 6566 6175 6c74  'kpc')). Default
-00030c80: 2069 7320 4e6f 6e65 2c20 6d65 616e 696e   is None, meanin
-00030c90: 6720 616c 6c20 6167 6772 6567 6174 6520  g all aggregate 
-00030ca0: 6c69 6768 7463 7572 7665 7320 7769 6c6c  lightcurves will
-00030cb0: 2062 6520 7265 7472 6965 7665 642e 0a20   be retrieved.. 
-00030cc0: 2020 2020 2020 203a 7061 7261 6d20 5175         :param Qu
-00030cd0: 616e 7469 7479 206c 6f5f 656e 3a20 5468  antity lo_en: Th
-00030ce0: 6520 6c6f 7765 7220 656e 6572 6779 206c  e lower energy l
-00030cf0: 696d 6974 206f 6620 7468 6520 6167 6772  imit of the aggr
-00030d00: 6567 6174 6520 6c69 6768 7463 7572 7665  egate lightcurve
-00030d10: 7320 796f 7520 7769 7368 2074 6f20 7265  s you wish to re
-00030d20: 7472 6965 7665 2c20 7468 6520 6465 6661  trieve, the defa
-00030d30: 756c 740a 2020 2020 2020 2020 2020 2020  ult.            
-00030d40: 6973 204e 6f6e 6520 2877 6869 6368 2077  is None (which w
-00030d50: 696c 6c20 7265 7472 6965 7665 2061 6c6c  ill retrieve all
-00030d60: 2061 6767 7265 6761 7465 206c 6967 6874   aggregate light
-00030d70: 6375 7276 6573 2072 6567 6172 646c 6573  curves regardles
-00030d80: 7320 6f66 2065 6e65 7267 7920 6c69 6d69  s of energy limi
-00030d90: 7429 2e0a 2020 2020 2020 2020 3a70 6172  t)..        :par
-00030da0: 616d 2051 7561 6e74 6974 7920 6869 5f65  am Quantity hi_e
-00030db0: 6e3a 2054 6865 2075 7070 6572 2065 6e65  n: The upper ene
-00030dc0: 7267 7920 6c69 6d69 7420 6f66 2074 6865  rgy limit of the
-00030dd0: 2061 6767 7265 6761 7465 206c 6967 6874   aggregate light
-00030de0: 6375 7276 6573 2079 6f75 2077 6973 6820  curves you wish 
-00030df0: 746f 2072 6574 7269 6576 652c 2074 6865  to retrieve, the
-00030e00: 2064 6566 6175 6c74 0a20 2020 2020 2020   default.       
-00030e10: 2020 2020 2069 7320 4e6f 6e65 2028 7768       is None (wh
-00030e20: 6963 6820 7769 6c6c 2072 6574 7269 6576  ich will retriev
-00030e30: 6520 616c 6c20 6167 6772 6567 6174 6520  e all aggregate 
-00030e40: 6c69 6768 7463 7572 7665 7320 7265 6761  lightcurves rega
-00030e50: 7264 6c65 7373 206f 6620 656e 6572 6779  rdless of energy
-00030e60: 206c 696d 6974 292e 0a20 2020 2020 2020   limit)..       
-00030e70: 203a 7061 7261 6d20 5175 616e 7469 7479   :param Quantity
-00030e80: 2074 696d 655f 6269 6e5f 7369 7a65 3a20   time_bin_size: 
-00030e90: 5468 6520 7469 6d65 2062 696e 2073 697a  The time bin siz
-00030ea0: 6520 7573 6564 2074 6f20 6765 6e65 7261  e used to genera
-00030eb0: 7465 2074 6865 2064 6573 6972 6564 2061  te the desired a
-00030ec0: 6767 7265 6761 7465 206c 6967 6874 6375  ggregate lightcu
-00030ed0: 7276 652e 2054 6865 0a20 2020 2020 2020  rve. The.       
-00030ee0: 2020 2020 2064 6566 6175 6c74 2076 616c       default val
-00030ef0: 7565 2069 7320 4e6f 6e65 2c20 696e 2077  ue is None, in w
-00030f00: 6869 6368 2063 6173 6520 616c 6c20 6167  hich case all ag
-00030f10: 6772 6567 6174 6520 6c69 6768 7463 7572  gregate lightcur
-00030f20: 7665 7320 6d61 7463 6869 6e67 206f 7468  ves matching oth
-00030f30: 6572 2063 7269 7465 7269 6120 7769 6c6c  er criteria will
-00030f40: 2062 6520 7265 7472 6965 7665 642e 0a20   be retrieved.. 
-00030f50: 2020 2020 2020 203a 7061 7261 6d20 6469         :param di
-00030f60: 6374 2070 6174 7465 726e 3a20 4576 656e  ct pattern: Even
-00030f70: 7420 7365 6c65 6374 696f 6e20 7061 7474  t selection patt
-00030f80: 6572 6e73 2075 7365 6420 746f 2063 7265  erns used to cre
-00030f90: 6174 6520 6167 6772 6567 6174 6520 6c69  ate aggregate li
-00030fa0: 6768 7463 7572 7665 7320 6f66 2069 6e74  ghtcurves of int
-00030fb0: 6572 6573 742e 2054 6865 2064 6566 6175  erest. The defau
-00030fc0: 6c74 0a20 2020 2020 2020 2020 2020 2069  lt.            i
-00030fd0: 7320 2764 6566 6175 6c74 2720 7768 6963  s 'default' whic
-00030fe0: 6820 7573 6573 2074 6865 2064 6566 6175  h uses the defau
-00030ff0: 6c74 2076 616c 7565 7320 666f 7220 6765  lt values for ge
-00031000: 6e65 7261 7469 6e67 206c 6967 6874 6375  nerating lightcu
-00031010: 7276 6573 2066 6f72 2064 6966 6665 7265  rves for differe
-00031020: 6e74 2069 6e73 7472 756d 656e 7473 2c20  nt instruments, 
-00031030: 6f72 2079 6f75 0a20 2020 2020 2020 2020  or you.         
-00031040: 2020 2063 616e 2070 6173 7320 6120 6469     can pass a di
-00031050: 6374 696f 6e61 7279 2077 6974 6820 7061  ctionary with pa
-00031060: 7474 6572 6e73 2069 6e3b 2065 2e67 2e20  tterns in; e.g. 
-00031070: 7b27 706e 273a 2027 3c3d 3427 2c20 276d  {'pn': '<=4', 'm
-00031080: 6f73 273a 2027 3c3d 3132 277d 2e20 596f  os': '<=12'}. Yo
-00031090: 7520 6361 6e20 616c 736f 2070 6173 7320  u can also pass 
-000310a0: 4e6f 6e65 2c20 7768 6963 680a 2020 2020  None, which.    
-000310b0: 2020 2020 2020 2020 6d65 616e 7320 616c          means al
-000310c0: 6c20 6167 6772 6567 6174 6520 206c 6967  l aggregate  lig
-000310d0: 6874 2063 7572 7665 7320 6d61 7463 6869  ht curves matchi
-000310e0: 6e67 206f 7468 6572 2073 6561 7263 6820  ng other search 
-000310f0: 7465 726d 7320 7769 6c6c 2062 6520 7265  terms will be re
-00031100: 7475 726e 6564 2e0a 2020 2020 2020 2020  turned..        
-00031110: 3a72 6574 7572 6e3a 2041 6e20 5847 4120  :return: An XGA 
-00031120: 4167 6772 6567 6174 654c 6967 6874 4375  AggregateLightCu
-00031130: 7276 6520 6f62 6a65 6374 2028 6966 2074  rve object (if t
-00031140: 6865 7265 2069 7320 616e 2065 7861 6374  here is an exact
-00031150: 206d 6174 6368 292c 206f 7220 6120 6c69   match), or a li
-00031160: 7374 206f 6620 5847 4120 4167 6772 6567  st of XGA Aggreg
-00031170: 6174 654c 6967 6874 4375 7276 650a 2020  ateLightCurve.  
-00031180: 2020 2020 2020 2020 2020 6f62 6a65 6374            object
-00031190: 7320 2869 6620 7468 6572 6520 7765 7265  s (if there were
-000311a0: 206d 756c 7469 706c 6520 6d61 7463 6869   multiple matchi
-000311b0: 6e67 2070 726f 6475 6374 7329 2e0a 2020  ng products)..  
-000311c0: 2020 2020 2020 3a72 7479 7065 3a20 556e        :rtype: Un
-000311d0: 696f 6e5b 4167 6772 6567 6174 654c 6967  ion[AggregateLig
-000311e0: 6874 4375 7276 652c 204c 6973 745b 4167  htCurve, List[Ag
-000311f0: 6772 6567 6174 654c 6967 6874 4375 7276  gregateLightCurv
-00031200: 655d 5d0a 2020 2020 2020 2020 2222 220a  e]].        """.
-00031210: 2020 2020 2020 2020 6672 6f6d 2078 6761          from xga
-00031220: 2e73 6173 2069 6d70 6f72 7420 6368 6563  .sas import chec
-00031230: 6b5f 7061 7474 6572 6e0a 0a20 2020 2020  k_pattern..     
-00031240: 2020 2023 2054 4f44 4f20 5468 6973 2069     # TODO This i
-00031250: 7320 584d 4d20 7370 6563 6966 6963 2062  s XMM specific b
-00031260: 6563 6175 7365 206f 6620 7468 6520 7061  ecause of the pa
-00031270: 7474 6572 6e73 2063 7572 7265 6e74 6c79  tterns currently
-00031280: 0a20 2020 2020 2020 2023 2054 6869 7320  .        # This 
-00031290: 6973 2077 6865 7265 2077 6520 7365 7420  is where we set 
-000312a0: 7570 2074 6865 2073 6561 7263 6820 7374  up the search st
-000312b0: 7269 6e67 2066 6f72 2074 6865 2070 6174  ring for the pat
-000312c0: 7465 726e 7320 7370 6563 6966 6965 6420  terns specified 
-000312d0: 6279 2074 6865 2075 7365 722e 0a20 2020  by the user..   
-000312e0: 2020 2020 2069 6620 7061 7474 6572 6e20       if pattern 
-000312f0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-00031300: 2020 2020 2070 6174 745f 7365 6172 6368       patt_search
-00031310: 203d 2022 7061 7474 6572 6e22 0a20 2020   = "pattern".   
-00031320: 2020 2020 2065 6c69 6620 6973 696e 7374       elif isinst
-00031330: 616e 6365 2870 6174 7465 726e 2c20 7374  ance(pattern, st
-00031340: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-00031350: 7061 7474 6572 6e20 3d20 7b27 706e 273a  pattern = {'pn':
-00031360: 2027 3c3d 3427 2c20 276d 6f73 273a 2027   '<=4', 'mos': '
-00031370: 3c3d 3132 277d 0a20 2020 2020 2020 2020  <=12'}.         
-00031380: 2020 2070 6174 745f 7365 6172 6368 203d     patt_search =
-00031390: 207b 696e 7374 3a20 225f 7b69 7d70 6174   {inst: "_{i}pat
-000313a0: 7465 726e 222e 666f 726d 6174 2869 3d69  tern".format(i=i
-000313b0: 6e73 7429 202b 2063 6865 636b 5f70 6174  nst) + check_pat
-000313c0: 7465 726e 2870 6174 7429 5b31 5d0a 2020  tern(patt)[1].  
-000313d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000313e0: 2020 2020 2020 2020 2066 6f72 2069 6e73           for ins
-000313f0: 742c 2070 6174 7420 696e 2070 6174 7465  t, patt in patte
-00031400: 726e 2e69 7465 6d73 2829 7d0a 2020 2020  rn.items()}.    
-00031410: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
-00031420: 6e63 6528 7061 7474 6572 6e2c 2064 6963  nce(pattern, dic
-00031430: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
-00031440: 6966 2027 6d6f 7331 2720 696e 206c 6973  if 'mos1' in lis
-00031450: 7428 7061 7474 6572 6e2e 6b65 7973 2829  t(pattern.keys()
-00031460: 2920 6f72 2027 6d6f 7332 2720 696e 206c  ) or 'mos2' in l
-00031470: 6973 7428 7061 7474 6572 6e2e 6b65 7973  ist(pattern.keys
-00031480: 2829 293a 0a20 2020 2020 2020 2020 2020  ()):.           
-00031490: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-000314a0: 4572 726f 7228 2253 7065 6369 6669 6320  Error("Specific 
-000314b0: 4d4f 5320 696e 7374 7275 6d65 6e74 7320  MOS instruments 
-000314c0: 646f 206e 6f74 206e 6565 6420 746f 2062  do not need to b
-000314d0: 6520 7370 6563 6966 6965 6420 666f 7220  e specified for 
-000314e0: 2770 6174 7465 726e 273b 2069 2e65 2e20  'pattern'; i.e. 
-000314f0: 7468 6572 6520 220a 2020 2020 2020 2020  there ".        
-00031500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031510: 2020 2020 2020 2020 2022 7368 6f75 6c64           "should
-00031520: 2062 6520 6f6e 6520 656e 7472 7920 666f   be one entry fo
-00031530: 7220 276d 6f73 272e 2229 0a20 2020 2020  r 'mos'.").     
-00031540: 2020 2020 2020 2070 6174 7465 726e 203d         pattern =
-00031550: 207b 696e 7374 3a20 7061 7474 2e72 6570   {inst: patt.rep
-00031560: 6c61 6365 2827 2027 2c20 2727 2920 666f  lace(' ', '') fo
-00031570: 7220 696e 7374 2c20 7061 7474 2069 6e20  r inst, patt in 
-00031580: 7061 7474 6572 6e2e 6974 656d 7328 297d  pattern.items()}
-00031590: 0a20 2020 2020 2020 2020 2020 2070 6174  .            pat
-000315a0: 745f 7365 6172 6368 203d 207b 696e 7374  t_search = {inst
-000315b0: 3a20 225f 7b69 7d70 6174 7465 726e 222e  : "_{i}pattern".
-000315c0: 666f 726d 6174 2869 3d69 6e73 7429 202b  format(i=inst) +
-000315d0: 2063 6865 636b 5f70 6174 7465 726e 2870   check_pattern(p
-000315e0: 6174 7429 5b31 5d0a 2020 2020 2020 2020  att)[1].        
-000315f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031600: 2020 2066 6f72 2069 6e73 742c 2070 6174     for inst, pat
-00031610: 7420 696e 2070 6174 7465 726e 2e69 7465  t in pattern.ite
-00031620: 6d73 2829 7d0a 2020 2020 2020 2020 656c  ms()}.        el
-00031630: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00031640: 7261 6973 6520 5479 7065 4572 726f 7228  raise TypeError(
-00031650: 2254 6865 2027 7061 7474 6572 6e27 2061  "The 'pattern' a
-00031660: 7267 756d 656e 7420 6d75 7374 2062 6520  rgument must be 
-00031670: 6569 7468 6572 2027 6465 6661 756c 7427  either 'default'
-00031680: 2c20 6f72 2061 2064 6963 7469 6f6e 6172  , or a dictionar
-00031690: 7920 7768 6572 6520 7468 6520 6b65 7973  y where the keys
-000316a0: 2061 7265 2022 0a20 2020 2020 2020 2020   are ".         
-000316b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000316c0: 2020 2022 696e 7374 7275 6d65 6e74 206e     "instrument n
-000316d0: 616d 6573 2061 6e64 2076 616c 7565 7320  ames and values 
-000316e0: 6172 6520 7374 7269 6e67 2070 6174 7465  are string patte
-000316f0: 726e 732e 2229 0a0a 2020 2020 2020 2020  rns.")..        
-00031700: 2320 5573 6520 7468 6520 696e 7465 726e  # Use the intern
-00031710: 616c 2066 756e 6374 696f 6e20 746f 2066  al function to f
-00031720: 696e 6420 7468 6520 636f 6d62 696e 6564  ind the combined
-00031730: 206c 6967 6874 2063 7572 7665 732c 2074   light curves, t
-00031740: 6865 6e20 6170 706c 7920 7061 7474 6572  hen apply patter
-00031750: 6e20 6368 6563 6b73 2061 6674 6572 0a20  n checks after. 
-00031760: 2020 2020 2020 2073 6f6d 655f 6c63 7320         some_lcs 
-00031770: 3d20 7365 6c66 2e5f 6765 745f 6c63 5f70  = self._get_lc_p
-00031780: 726f 6428 6f75 7465 725f 7261 6469 7573  rod(outer_radius
-00031790: 2c20 2763 6f6d 6269 6e65 6427 2c20 4e6f  , 'combined', No
-000317a0: 6e65 2c20 696e 6e65 725f 7261 6469 7573  ne, inner_radius
-000317b0: 2c20 6c6f 5f65 6e2c 2068 695f 656e 2c20  , lo_en, hi_en, 
-000317c0: 7469 6d65 5f62 696e 5f73 697a 6529 0a20  time_bin_size). 
-000317d0: 2020 2020 2020 206d 6174 6368 6564 5f70         matched_p
-000317e0: 726f 6473 203d 205b 5d0a 2020 2020 2020  rods = [].      
-000317f0: 2020 666f 7220 6c63 2069 6e20 736f 6d65    for lc in some
-00031800: 5f6c 6373 3a0a 2020 2020 2020 2020 2020  _lcs:.          
-00031810: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-00031820: 7061 7474 5f73 6561 7263 682c 2073 7472  patt_search, str
-00031830: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00031840: 2020 2072 656c 5f70 6174 745f 7365 6172     rel_patt_sear
-00031850: 6368 203d 205b 7061 7474 5f73 6561 7263  ch = [patt_searc
-00031860: 685d 0a20 2020 2020 2020 2020 2020 2065  h].            e
-00031870: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00031880: 2020 2020 2072 656c 5f70 6174 745f 7365       rel_patt_se
-00031890: 6172 6368 203d 205b 7061 7474 2066 6f72  arch = [patt for
-000318a0: 2069 6e73 742c 2070 6174 7420 696e 2070   inst, patt in p
-000318b0: 6174 745f 7365 6172 6368 2e69 7465 6d73  att_search.items
-000318c0: 2829 5d0a 0a20 2020 2020 2020 2020 2020  ()]..           
-000318d0: 2069 6620 616c 6c28 5b72 7073 2069 6e20   if all([rps in 
-000318e0: 6c63 2e73 746f 7261 6765 5f6b 6579 2066  lc.storage_key f
-000318f0: 6f72 2072 7073 2069 6e20 7265 6c5f 7061  or rps in rel_pa
-00031900: 7474 5f73 6561 7263 685d 293a 0a20 2020  tt_search]):.   
-00031910: 2020 2020 2020 2020 2020 2020 206d 6174               mat
-00031920: 6368 6564 5f70 726f 6473 2e61 7070 656e  ched_prods.appen
-00031930: 6428 6c63 290a 0a20 2020 2020 2020 2069  d(lc)..        i
-00031940: 6620 6c65 6e28 6d61 7463 6865 645f 7072  f len(matched_pr
-00031950: 6f64 7329 203d 3d20 313a 0a20 2020 2020  ods) == 1:.     
-00031960: 2020 2020 2020 206d 6174 6368 6564 5f70         matched_p
-00031970: 726f 6473 203d 206d 6174 6368 6564 5f70  rods = matched_p
-00031980: 726f 6473 5b30 5d0a 2020 2020 2020 2020  rods[0].        
-00031990: 656c 6966 206c 656e 286d 6174 6368 6564  elif len(matched
-000319a0: 5f70 726f 6473 2920 3d3d 2030 3a0a 2020  _prods) == 0:.  
-000319b0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-000319c0: 4e6f 5072 6f64 7563 7441 7661 696c 6162  NoProductAvailab
-000319d0: 6c65 4572 726f 7228 2243 616e 6e6f 7420  leError("Cannot 
-000319e0: 6669 6e64 2061 6e79 206c 6967 6874 6375  find any lightcu
-000319f0: 7276 6573 206d 6174 6368 696e 6720 796f  rves matching yo
-00031a00: 7572 2069 6e70 7574 2e22 290a 0a20 2020  ur input.")..   
-00031a10: 2020 2020 2072 6574 7572 6e20 6d61 7463       return matc
-00031a20: 6865 645f 7072 6f64 730a 0a20 2020 2023  hed_prods..    #
-00031a30: 2054 6865 2063 6f6d 6269 6e65 6420 7068   The combined ph
-00031a40: 6f74 6f6d 6574 7269 6320 7072 6f64 7563  otometric produc
-00031a50: 7473 2064 6f6e 2774 2072 6561 6c6c 7920  ts don't really 
-00031a60: 4e45 4544 2074 6865 6972 206f 776e 2067  NEED their own g
-00031a70: 6574 206d 6574 686f 6473 2c20 6275 7420  et methods, but 
-00031a80: 4920 6669 6775 7265 6420 4920 776f 756c  I figured I woul
-00031a90: 6420 6a75 7374 2066 6f72 0a20 2020 2023  d just for.    #
-00031aa0: 2020 636c 6172 6974 7927 7320 7361 6b65    clarity's sake
-00031ab0: 0a20 2020 2064 6566 2067 6574 5f63 6f6d  .    def get_com
-00031ac0: 6269 6e65 645f 696d 6167 6573 2873 656c  bined_images(sel
-00031ad0: 662c 206c 6f5f 656e 3a20 5175 616e 7469  f, lo_en: Quanti
-00031ae0: 7479 203d 204e 6f6e 652c 2068 695f 656e  ty = None, hi_en
-00031af0: 3a20 5175 616e 7469 7479 203d 204e 6f6e  : Quantity = Non
-00031b00: 652c 2070 7366 5f63 6f72 723a 2062 6f6f  e, psf_corr: boo
-00031b10: 6c20 3d20 4661 6c73 652c 0a20 2020 2020  l = False,.     
-00031b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031b30: 2020 2020 2020 2070 7366 5f6d 6f64 656c         psf_model
-00031b40: 3a20 7374 7220 3d20 2245 4c4c 4245 5441  : str = "ELLBETA
-00031b50: 222c 2070 7366 5f62 696e 733a 2069 6e74  ", psf_bins: int
-00031b60: 203d 2034 2c20 7073 665f 616c 676f 3a20   = 4, psf_algo: 
-00031b70: 7374 7220 3d20 2272 6c22 2c0a 2020 2020  str = "rl",.    
-00031b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031b90: 2020 2020 2020 2020 7073 665f 6974 6572          psf_iter
-00031ba0: 3a20 696e 7420 3d20 3135 2920 2d3e 2055  : int = 15) -> U
-00031bb0: 6e69 6f6e 5b49 6d61 6765 2c20 4c69 7374  nion[Image, List
-00031bc0: 5b49 6d61 6765 5d5d 3a0a 2020 2020 2020  [Image]]:.      
-00031bd0: 2020 2222 220a 2020 2020 2020 2020 4120    """.        A 
-00031be0: 6d65 7468 6f64 2074 6f20 7265 7472 6965  method to retrie
-00031bf0: 7665 2063 6f6d 6269 6e65 6420 5847 4120  ve combined XGA 
-00031c00: 496d 6167 6520 6f62 6a65 6374 732c 2061  Image objects, a
-00031c10: 7320 696e 2074 686f 7365 2069 6d61 6765  s in those image
-00031c20: 7320 7468 6174 2068 6176 6520 6265 656e  s that have been
-00031c30: 2063 7265 6174 6564 2062 790a 2020 2020   created by.    
-00031c40: 2020 2020 6d65 7267 696e 6720 616c 6c20      merging all 
-00031c50: 6176 6169 6c61 626c 6520 6461 7461 2066  available data f
-00031c60: 6f72 2074 6869 7320 736f 7572 6365 2e20  or this source. 
-00031c70: 5468 6973 2073 7570 706f 7274 7320 7468  This supports th
-00031c80: 6520 7265 7472 6965 7661 6c20 6f66 2062  e retrieval of b
-00031c90: 6f74 6820 5053 4620 636f 7272 6563 7465  oth PSF correcte
-00031ca0: 6420 616e 6420 6e6f 6e2d 5053 460a 2020  d and non-PSF.  
-00031cb0: 2020 2020 2020 636f 7272 6563 7465 6420        corrected 
-00031cc0: 696d 6167 6573 2c20 6173 2077 656c 6c20  images, as well 
-00031cd0: 6173 2073 6574 7469 6e67 2074 6865 2065  as setting the e
-00031ce0: 6e65 7267 7920 6c69 6d69 7473 206f 6620  nergy limits of 
-00031cf0: 7468 6520 7370 6563 6966 6963 2069 6d61  the specific ima
-00031d00: 6765 2079 6f75 2077 6f75 6c64 206c 696b  ge you would lik
-00031d10: 652e 2041 0a20 2020 2020 2020 204e 6f50  e. A.        NoP
-00031d20: 726f 6475 6374 4176 6169 6c61 626c 6545  roductAvailableE
-00031d30: 7272 6f72 2065 7272 6f72 2077 696c 6c20  rror error will 
-00031d40: 6265 2072 6169 7365 6420 6966 206e 6f20  be raised if no 
-00031d50: 6d61 7463 6865 7320 6172 6520 666f 756e  matches are foun
-00031d60: 642e 0a0a 2020 2020 2020 2020 3a70 6172  d...        :par
-00031d70: 616d 2051 7561 6e74 6974 7920 6c6f 5f65  am Quantity lo_e
-00031d80: 6e3a 2054 6865 206c 6f77 6572 2065 6e65  n: The lower ene
-00031d90: 7267 7920 6c69 6d69 7420 6f66 2074 6865  rgy limit of the
-00031da0: 2069 6d61 6765 2079 6f75 2077 6973 6820   image you wish 
-00031db0: 746f 2072 6574 7269 6576 652c 2074 6865  to retrieve, the
-00031dc0: 2064 6566 6175 6c74 0a20 2020 2020 2020   default.       
-00031dd0: 2020 2020 2069 7320 4e6f 6e65 2028 7768       is None (wh
-00031de0: 6963 6820 7769 6c6c 2072 6574 7269 6576  ich will retriev
-00031df0: 6520 616c 6c20 696d 6167 6573 2072 6567  e all images reg
-00031e00: 6172 646c 6573 7320 6f66 2065 6e65 7267  ardless of energ
-00031e10: 7920 6c69 6d69 7429 2e0a 2020 2020 2020  y limit)..      
-00031e20: 2020 3a70 6172 616d 2051 7561 6e74 6974    :param Quantit
-00031e30: 7920 6869 5f65 6e3a 2054 6865 2075 7070  y hi_en: The upp
-00031e40: 6572 2065 6e65 7267 7920 6c69 6d69 7420  er energy limit 
-00031e50: 6f66 2074 6865 2069 6d61 6765 2079 6f75  of the image you
-00031e60: 2077 6973 6820 746f 2072 6574 7269 6576   wish to retriev
-00031e70: 652c 2074 6865 2064 6566 6175 6c74 0a20  e, the default. 
-00031e80: 2020 2020 2020 2020 2020 2069 7320 4e6f             is No
-00031e90: 6e65 2028 7768 6963 6820 7769 6c6c 2072  ne (which will r
-00031ea0: 6574 7269 6576 6520 616c 6c20 696d 6167  etrieve all imag
-00031eb0: 6573 2072 6567 6172 646c 6573 7320 6f66  es regardless of
-00031ec0: 2065 6e65 7267 7920 6c69 6d69 7429 2e0a   energy limit)..
-00031ed0: 2020 2020 2020 2020 3a70 6172 616d 2062          :param b
-00031ee0: 6f6f 6c20 7073 665f 636f 7272 3a20 5365  ool psf_corr: Se
-00031ef0: 7473 2077 6865 7468 6572 2079 6f75 2077  ts whether you w
-00031f00: 6973 6820 746f 2072 6574 7269 6576 6520  ish to retrieve 
-00031f10: 6120 5053 4620 636f 7272 6563 7465 6420  a PSF corrected 
-00031f20: 696d 6167 6520 6f72 206e 6f74 2e0a 2020  image or not..  
-00031f30: 2020 2020 2020 3a70 6172 616d 2073 7472        :param str
-00031f40: 2070 7366 5f6d 6f64 656c 3a20 4966 2074   psf_model: If t
-00031f50: 6865 2069 6d61 6765 2079 6f75 2077 616e  he image you wan
-00031f60: 7420 6973 2050 5346 2063 6f72 7265 6374  t is PSF correct
-00031f70: 6564 2c20 7468 6973 2069 7320 7468 6520  ed, this is the 
-00031f80: 5053 4620 6d6f 6465 6c20 7573 6564 2e0a  PSF model used..
-00031f90: 2020 2020 2020 2020 3a70 6172 616d 2069          :param i
-00031fa0: 6e74 2070 7366 5f62 696e 733a 2049 6620  nt psf_bins: If 
-00031fb0: 7468 6520 696d 6167 6520 796f 7520 7761  the image you wa
-00031fc0: 6e74 2069 7320 5053 4620 636f 7272 6563  nt is PSF correc
-00031fd0: 7465 642c 2074 6869 7320 6973 2074 6865  ted, this is the
-00031fe0: 206e 756d 6265 7220 6f66 2050 5346 7320   number of PSFs 
-00031ff0: 7065 720a 2020 2020 2020 2020 2020 2020  per.            
-00032000: 7369 6465 2069 6e20 7468 6520 5053 4620  side in the PSF 
-00032010: 6772 6964 2e0a 2020 2020 2020 2020 3a70  grid..        :p
-00032020: 6172 616d 2073 7472 2070 7366 5f61 6c67  aram str psf_alg
-00032030: 6f3a 2049 6620 7468 6520 696d 6167 6520  o: If the image 
-00032040: 796f 7520 7761 6e74 2069 7320 5053 4620  you want is PSF 
-00032050: 636f 7272 6563 7465 642c 2074 6869 7320  corrected, this 
-00032060: 6973 2074 6865 2061 6c67 6f72 6974 686d  is the algorithm
-00032070: 2075 7365 642e 0a20 2020 2020 2020 203a   used..        :
-00032080: 7061 7261 6d20 696e 7420 7073 665f 6974  param int psf_it
-00032090: 6572 3a20 4966 2074 6865 2069 6d61 6765  er: If the image
-000320a0: 2079 6f75 2077 616e 7420 6973 2050 5346   you want is PSF
-000320b0: 2063 6f72 7265 6374 6564 2c20 7468 6973   corrected, this
-000320c0: 2069 7320 7468 6520 6e75 6d62 6572 206f   is the number o
-000320d0: 6620 6974 6572 6174 696f 6e73 2e0a 2020  f iterations..  
-000320e0: 2020 2020 2020 3a72 6574 7572 6e3a 2041        :return: A
-000320f0: 6e20 5847 4120 496d 6167 6520 6f62 6a65  n XGA Image obje
-00032100: 6374 2028 6966 2074 6865 7265 2069 7320  ct (if there is 
-00032110: 616e 2065 7861 6374 206d 6174 6368 292c  an exact match),
-00032120: 206f 7220 6120 6c69 7374 206f 6620 5847   or a list of XG
-00032130: 4120 496d 6167 6520 6f62 6a65 6374 7320  A Image objects 
-00032140: 2869 6620 7468 6572 650a 2020 2020 2020  (if there.      
-00032150: 2020 2020 2020 7765 7265 206d 756c 7469        were multi
-00032160: 706c 6520 6d61 7463 6869 6e67 2070 726f  ple matching pro
-00032170: 6475 6374 7329 2e0a 2020 2020 2020 2020  ducts)..        
-00032180: 3a72 7479 7065 3a20 556e 696f 6e5b 496d  :rtype: Union[Im
-00032190: 6167 652c 204c 6973 745b 496d 6167 655d  age, List[Image]
-000321a0: 5d0a 2020 2020 2020 2020 2222 220a 0a20  ].        """.. 
-000321b0: 2020 2020 2020 2023 2043 6865 636b 7320         # Checks 
-000321c0: 746f 206d 616b 6520 7375 7265 2074 6861  to make sure tha
-000321d0: 7420 616e 2061 6c6c 6f77 6564 2063 6f6d  t an allowed com
-000321e0: 6269 6e61 7469 6f6e 206f 6620 6c6f 5f65  bination of lo_e
-000321f0: 6e20 616e 6420 6869 5f65 6e20 6861 7320  n and hi_en has 
-00032200: 6265 656e 2070 6173 7365 642e 0a20 2020  been passed..   
-00032210: 2020 2020 2069 6620 616c 6c28 5b6c 6f5f       if all([lo_
-00032220: 656e 2069 7320 4e6f 6e65 2c20 6869 5f65  en is None, hi_e
-00032230: 6e20 6973 204e 6f6e 655d 293a 0a20 2020  n is None]):.   
-00032240: 2020 2020 2020 2020 2023 2053 6574 7320           # Sets 
-00032250: 6120 666c 6167 2074 6f20 7465 6c6c 2074  a flag to tell t
-00032260: 6865 2072 6573 7420 6f66 2074 6865 206d  he rest of the m
-00032270: 6574 686f 6420 7768 6574 6865 7220 7765  ethod whether we
-00032280: 2068 6176 6520 656e 6572 6779 206c 696d   have energy lim
-00032290: 7320 6f72 206e 6f74 0a20 2020 2020 2020  s or not.       
-000322a0: 2020 2020 2077 6974 685f 6c69 6d73 203d       with_lims =
-000322b0: 2046 616c 7365 0a20 2020 2020 2020 2020   False.         
-000322c0: 2020 2065 6e65 7267 795f 6b65 7920 3d20     energy_key = 
-000322d0: 4e6f 6e65 0a20 2020 2020 2020 2065 6c69  None.        eli
-000322e0: 6620 616c 6c28 5b6c 6f5f 656e 2069 7320  f all([lo_en is 
-000322f0: 6e6f 7420 4e6f 6e65 2c20 6869 5f65 6e20  not None, hi_en 
-00032300: 6973 206e 6f74 204e 6f6e 655d 293a 0a20  is not None]):. 
-00032310: 2020 2020 2020 2020 2020 2077 6974 685f             with_
-00032320: 6c69 6d73 203d 2054 7275 650a 2020 2020  lims = True.    
-00032330: 2020 2020 2020 2020 2320 5765 2068 6176          # We hav
-00032340: 6520 656e 6572 6779 206c 696d 6974 7320  e energy limits 
-00032350: 6865 7265 2073 6f20 7765 2061 7373 656d  here so we assem
-00032360: 626c 6520 7468 6520 6b65 7920 7468 6174  ble the key that
-00032370: 2064 6573 6372 6962 6573 2074 6865 2065   describes the e
-00032380: 6e65 7267 7920 7261 6e67 650a 2020 2020  nergy range.    
-00032390: 2020 2020 2020 2020 656e 6572 6779 5f6b          energy_k
-000323a0: 6579 203d 2022 626f 756e 645f 7b6c 7d2d  ey = "bound_{l}-
-000323b0: 7b68 7d22 2e66 6f72 6d61 7428 6c3d 6c6f  {h}".format(l=lo
-000323c0: 5f65 6e2e 746f 2827 6b65 5627 292e 7661  _en.to('keV').va
-000323d0: 6c75 652c 2068 3d68 695f 656e 2e74 6f28  lue, h=hi_en.to(
-000323e0: 276b 6556 2729 2e76 616c 7565 290a 2020  'keV').value).  
-000323f0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00032400: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
-00032410: 6c75 6545 7272 6f72 2822 6c6f 5f65 6e20  lueError("lo_en 
-00032420: 616e 6420 6869 5f65 6e20 6d75 7374 2062  and hi_en must b
-00032430: 6520 6569 7468 6572 2042 4f54 4820 4e6f  e either BOTH No
-00032440: 6e65 206f 7220 424f 5448 2061 6e20 4173  ne or BOTH an As
-00032450: 7472 6f70 7920 7175 616e 7469 7479 2e22  tropy quantity."
-00032460: 290a 0a20 2020 2020 2020 2023 2049 6620  )..        # If 
-00032470: 7765 2061 7265 206c 6f6f 6b69 6e67 2066  we are looking f
-00032480: 6f72 2061 2050 5346 2063 6f72 7265 6374  or a PSF correct
-00032490: 6564 2069 6d61 6765 2074 6865 6e20 7765  ed image then we
-000324a0: 2061 7373 656d 626c 6520 7468 6520 6578   assemble the ex
-000324b0: 7472 6120 6b65 7920 7769 7468 2050 5346  tra key with PSF
-000324c0: 2064 6574 6169 6c73 0a20 2020 2020 2020   details.       
-000324d0: 2069 6620 7073 665f 636f 7272 3a0a 2020   if psf_corr:.  
-000324e0: 2020 2020 2020 2020 2020 6578 7472 615f            extra_
-000324f0: 6b65 7920 3d20 225f 2220 2b20 7073 665f  key = "_" + psf_
-00032500: 6d6f 6465 6c20 2b20 225f 2220 2b20 7374  model + "_" + st
-00032510: 7228 7073 665f 6269 6e73 2920 2b20 225f  r(psf_bins) + "_
-00032520: 2220 2b20 7073 665f 616c 676f 202b 2073  " + psf_algo + s
-00032530: 7472 2870 7366 5f69 7465 7229 0a0a 2020  tr(psf_iter)..  
-00032540: 2020 2020 2020 6966 206e 6f74 2070 7366        if not psf
-00032550: 5f63 6f72 7220 616e 6420 7769 7468 5f6c  _corr and with_l
-00032560: 696d 733a 0a20 2020 2020 2020 2020 2020  ims:.           
-00032570: 2023 2053 696d 706c 6573 7420 6361 7365   # Simplest case
-00032580: 2c20 6a75 7374 2063 616c 6c69 6e67 2067  , just calling g
-00032590: 6574 5f70 726f 6475 6374 7320 616e 6420  et_products and 
-000325a0: 7061 7373 696e 6720 696e 206f 7572 2069  passing in our i
-000325b0: 6e66 6f72 6d61 7469 6f6e 0a20 2020 2020  nformation.     
-000325c0: 2020 2020 2020 206d 6174 6368 6564 5f70         matched_p
-000325d0: 726f 6473 203d 2073 656c 662e 6765 745f  rods = self.get_
-000325e0: 7072 6f64 7563 7473 2827 636f 6d62 696e  products('combin
-000325f0: 6564 5f69 6d61 6765 272c 2065 7874 7261  ed_image', extra
-00032600: 5f6b 6579 3d65 6e65 7267 795f 6b65 7929  _key=energy_key)
-00032610: 0a20 2020 2020 2020 2065 6c69 6620 6e6f  .        elif no
-00032620: 7420 7073 665f 636f 7272 2061 6e64 206e  t psf_corr and n
-00032630: 6f74 2077 6974 685f 6c69 6d73 3a0a 2020  ot with_lims:.  
-00032640: 2020 2020 2020 2020 2020 6272 6f61 645f            broad_
-00032650: 6d61 7463 6865 7320 3d20 7365 6c66 2e67  matches = self.g
-00032660: 6574 5f70 726f 6475 6374 7328 2263 6f6d  et_products("com
-00032670: 6269 6e65 645f 696d 6167 6522 290a 2020  bined_image").  
-00032680: 2020 2020 2020 2020 2020 6d61 7463 6865            matche
-00032690: 645f 7072 6f64 7320 3d20 5b70 2066 6f72  d_prods = [p for
-000326a0: 2070 2069 6e20 6272 6f61 645f 6d61 7463   p in broad_matc
-000326b0: 6865 7320 6966 206e 6f74 2070 2e70 7366  hes if not p.psf
-000326c0: 5f63 6f72 7265 6374 6564 5d0a 2020 2020  _corrected].    
-000326d0: 2020 2020 656c 6966 2070 7366 5f63 6f72      elif psf_cor
-000326e0: 7220 616e 6420 7769 7468 5f6c 696d 733a  r and with_lims:
-000326f0: 0a20 2020 2020 2020 2020 2020 2023 2048  .            # H
-00032700: 6572 6520 7765 206e 6565 6420 746f 2061  ere we need to a
-00032710: 6464 2074 6865 2065 7874 7261 206b 6579  dd the extra key
-00032720: 2074 6f20 7468 6520 656e 6572 6779 206b   to the energy k
-00032730: 6579 0a20 2020 2020 2020 2020 2020 206d  ey.            m
-00032740: 6174 6368 6564 5f70 726f 6473 203d 2073  atched_prods = s
-00032750: 656c 662e 6765 745f 7072 6f64 7563 7473  elf.get_products
-00032760: 2827 636f 6d62 696e 6564 5f69 6d61 6765  ('combined_image
-00032770: 272c 2065 7874 7261 5f6b 6579 3d65 6e65  ', extra_key=ene
-00032780: 7267 795f 6b65 7920 2b20 6578 7472 615f  rgy_key + extra_
-00032790: 6b65 7929 0a20 2020 2020 2020 2065 6c69  key).        eli
-000327a0: 6620 7073 665f 636f 7272 2061 6e64 206e  f psf_corr and n
-000327b0: 6f74 2077 6974 685f 6c69 6d73 3a0a 2020  ot with_lims:.  
-000327c0: 2020 2020 2020 2020 2020 2320 4865 7265            # Here
-000327d0: 2077 6520 646f 6e27 7420 6b6e 6f77 2074   we don't know t
-000327e0: 6865 2065 6e65 7267 7920 6b65 792c 2073  he energy key, s
-000327f0: 6f20 7765 2068 6176 6520 746f 206c 6f6f  o we have to loo
-00032800: 6b20 666f 7220 7061 7274 6961 6c20 6d61  k for partial ma
-00032810: 7463 6865 7320 696e 2074 6865 2067 6574  tches in the get
-00032820: 5f70 726f 6475 6374 7320 7265 7475 726e  _products return
-00032830: 0a20 2020 2020 2020 2020 2020 2062 726f  .            bro
-00032840: 6164 5f6d 6174 6368 6573 203d 2073 656c  ad_matches = sel
-00032850: 662e 6765 745f 7072 6f64 7563 7473 2827  f.get_products('
-00032860: 636f 6d62 696e 6564 5f69 6d61 6765 272c  combined_image',
-00032870: 2065 7874 7261 5f6b 6579 3d4e 6f6e 652c   extra_key=None,
-00032880: 206a 7573 745f 6f62 6a3d 4661 6c73 6529   just_obj=False)
-00032890: 0a20 2020 2020 2020 2020 2020 206d 6174  .            mat
-000328a0: 6368 6564 5f70 726f 6473 203d 205b 705b  ched_prods = [p[
-000328b0: 2d31 5d20 666f 7220 7020 696e 2062 726f  -1] for p in bro
-000328c0: 6164 5f6d 6174 6368 6573 2069 6620 6578  ad_matches if ex
-000328d0: 7472 615f 6b65 7920 696e 2070 5b2d 325d  tra_key in p[-2]
-000328e0: 5d0a 0a20 2020 2020 2020 2069 6620 6c65  ]..        if le
-000328f0: 6e28 6d61 7463 6865 645f 7072 6f64 7329  n(matched_prods)
-00032900: 203d 3d20 313a 0a20 2020 2020 2020 2020   == 1:.         
-00032910: 2020 206d 6174 6368 6564 5f70 726f 6473     matched_prods
-00032920: 203d 206d 6174 6368 6564 5f70 726f 6473   = matched_prods
-00032930: 5b30 5d0a 2020 2020 2020 2020 656c 6966  [0].        elif
-00032940: 206c 656e 286d 6174 6368 6564 5f70 726f   len(matched_pro
-00032950: 6473 2920 3d3d 2030 3a0a 2020 2020 2020  ds) == 0:.      
-00032960: 2020 2020 2020 7261 6973 6520 4e6f 5072        raise NoPr
-00032970: 6f64 7563 7441 7661 696c 6162 6c65 4572  oductAvailableEr
-00032980: 726f 7228 2243 616e 6e6f 7420 6669 6e64  ror("Cannot find
-00032990: 2061 6e79 2063 6f6d 6269 6e65 6420 696d   any combined im
-000329a0: 6167 6573 206d 6174 6368 696e 6720 796f  ages matching yo
-000329b0: 7572 2069 6e70 7574 2e22 290a 0a20 2020  ur input.")..   
-000329c0: 2020 2020 2072 6574 7572 6e20 6d61 7463       return matc
-000329d0: 6865 645f 7072 6f64 730a 0a20 2020 2064  hed_prods..    d
-000329e0: 6566 2067 6574 5f63 6f6d 6269 6e65 645f  ef get_combined_
-000329f0: 6578 706d 6170 7328 7365 6c66 2c20 6c6f  expmaps(self, lo
-00032a00: 5f65 6e3a 2051 7561 6e74 6974 7920 3d20  _en: Quantity = 
-00032a10: 4e6f 6e65 2c20 6869 5f65 6e3a 2051 7561  None, hi_en: Qua
-00032a20: 6e74 6974 7920 3d20 4e6f 6e65 2920 2d3e  ntity = None) ->
-00032a30: 2055 6e69 6f6e 5b45 7870 4d61 702c 204c   Union[ExpMap, L
-00032a40: 6973 745b 4578 704d 6170 5d5d 3a0a 2020  ist[ExpMap]]:.  
-00032a50: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00032a60: 2020 4120 6d65 7468 6f64 2074 6f20 7265    A method to re
-00032a70: 7472 6965 7665 2063 6f6d 6269 6e65 6420  trieve combined 
-00032a80: 5847 4120 4578 704d 6170 206f 626a 6563  XGA ExpMap objec
-00032a90: 7473 2c20 6173 2069 6e20 7468 6f73 6520  ts, as in those 
-00032aa0: 6578 706f 7375 7265 206d 6170 7320 7468  exposure maps th
-00032ab0: 6174 2068 6176 6520 6265 656e 2063 7265  at have been cre
-00032ac0: 6174 6564 2062 790a 2020 2020 2020 2020  ated by.        
-00032ad0: 6d65 7267 696e 6720 616c 6c20 6176 6169  merging all avai
-00032ae0: 6c61 626c 6520 6461 7461 2066 6f72 2074  lable data for t
-00032af0: 6869 7320 736f 7572 6365 2e20 5468 6973  his source. This
-00032b00: 2073 7570 706f 7274 7320 7365 7474 696e   supports settin
-00032b10: 6720 7468 6520 656e 6572 6779 206c 696d  g the energy lim
-00032b20: 6974 7320 6f66 2074 6865 2073 7065 6369  its of the speci
-00032b30: 6669 630a 2020 2020 2020 2020 6578 706f  fic.        expo
-00032b40: 7375 7265 206d 6170 7320 796f 7520 776f  sure maps you wo
-00032b50: 756c 6420 6c69 6b65 2e20 4120 4e6f 5072  uld like. A NoPr
-00032b60: 6f64 7563 7441 7661 696c 6162 6c65 4572  oductAvailableEr
-00032b70: 726f 7220 6572 726f 7220 7769 6c6c 2062  ror error will b
-00032b80: 6520 7261 6973 6564 2069 6620 6e6f 206d  e raised if no m
-00032b90: 6174 6368 6573 2061 7265 2066 6f75 6e64  atches are found
-00032ba0: 2e0a 0a20 2020 2020 2020 203a 7061 7261  ...        :para
-00032bb0: 6d20 5175 616e 7469 7479 206c 6f5f 656e  m Quantity lo_en
-00032bc0: 3a20 5468 6520 6c6f 7765 7220 656e 6572  : The lower ener
-00032bd0: 6779 206c 696d 6974 206f 6620 7468 6520  gy limit of the 
-00032be0: 6578 706f 7375 7265 206d 6170 7320 796f  exposure maps yo
-00032bf0: 7520 7769 7368 2074 6f20 7265 7472 6965  u wish to retrie
-00032c00: 7665 2c20 7468 6520 6465 6661 756c 740a  ve, the default.
-00032c10: 2020 2020 2020 2020 2020 2020 6973 204e              is N
-00032c20: 6f6e 6520 2877 6869 6368 2077 696c 6c20  one (which will 
-00032c30: 7265 7472 6965 7665 2061 6c6c 2069 6d61  retrieve all ima
-00032c40: 6765 7320 7265 6761 7264 6c65 7373 206f  ges regardless o
-00032c50: 6620 656e 6572 6779 206c 696d 6974 292e  f energy limit).
-00032c60: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-00032c70: 5175 616e 7469 7479 2068 695f 656e 3a20  Quantity hi_en: 
-00032c80: 5468 6520 7570 7065 7220 656e 6572 6779  The upper energy
-00032c90: 206c 696d 6974 206f 6620 7468 6520 6578   limit of the ex
-00032ca0: 706f 7375 7265 206d 6170 7320 796f 7520  posure maps you 
-00032cb0: 7769 7368 2074 6f20 7265 7472 6965 7665  wish to retrieve
-00032cc0: 2c20 7468 6520 6465 6661 756c 740a 2020  , the default.  
-00032cd0: 2020 2020 2020 2020 2020 6973 204e 6f6e            is Non
-00032ce0: 6520 2877 6869 6368 2077 696c 6c20 7265  e (which will re
-00032cf0: 7472 6965 7665 2061 6c6c 2069 6d61 6765  trieve all image
-00032d00: 7320 7265 6761 7264 6c65 7373 206f 6620  s regardless of 
-00032d10: 656e 6572 6779 206c 696d 6974 292e 0a20  energy limit).. 
-00032d20: 2020 2020 2020 203a 7265 7475 726e 3a20         :return: 
-00032d30: 416e 2058 4741 2045 7870 4d61 7020 6f62  An XGA ExpMap ob
-00032d40: 6a65 6374 2028 6966 2074 6865 7265 2069  ject (if there i
-00032d50: 7320 616e 2065 7861 6374 206d 6174 6368  s an exact match
-00032d60: 292c 206f 7220 6120 6c69 7374 206f 6620  ), or a list of 
-00032d70: 5847 4120 496d 6167 6520 6f62 6a65 6374  XGA Image object
-00032d80: 7320 2869 6620 7468 6572 650a 2020 2020  s (if there.    
-00032d90: 2020 2020 2020 2020 7765 7265 206d 756c          were mul
-00032da0: 7469 706c 6520 6d61 7463 6869 6e67 2070  tiple matching p
-00032db0: 726f 6475 6374 7329 2e0a 2020 2020 2020  roducts)..      
-00032dc0: 2020 3a72 7479 7065 3a20 556e 696f 6e5b    :rtype: Union[
-00032dd0: 4578 704d 6170 2c20 4c69 7374 5b45 7870  ExpMap, List[Exp
-00032de0: 4d61 705d 5d0a 2020 2020 2020 2020 2222  Map]].        ""
-00032df0: 220a 2020 2020 2020 2020 6966 2061 6c6c  ".        if all
-00032e00: 285b 6c6f 5f65 6e20 6973 204e 6f6e 652c  ([lo_en is None,
-00032e10: 2068 695f 656e 2069 7320 4e6f 6e65 5d29   hi_en is None])
-00032e20: 3a0a 2020 2020 2020 2020 2020 2020 656e  :.            en
-00032e30: 6572 6779 5f6b 6579 203d 204e 6f6e 650a  ergy_key = None.
-00032e40: 2020 2020 2020 2020 656c 6966 2061 6c6c          elif all
-00032e50: 285b 6c6f 5f65 6e20 6973 206e 6f74 204e  ([lo_en is not N
-00032e60: 6f6e 652c 2068 695f 656e 2069 7320 6e6f  one, hi_en is no
-00032e70: 7420 4e6f 6e65 5d29 3a0a 2020 2020 2020  t None]):.      
-00032e80: 2020 2020 2020 656e 6572 6779 5f6b 6579        energy_key
-00032e90: 203d 2022 626f 756e 645f 7b6c 7d2d 7b68   = "bound_{l}-{h
-00032ea0: 7d22 2e66 6f72 6d61 7428 6c3d 6c6f 5f65  }".format(l=lo_e
-00032eb0: 6e2e 746f 2827 6b65 5627 292e 7661 6c75  n.to('keV').valu
-00032ec0: 652c 2068 3d68 695f 656e 2e74 6f28 276b  e, h=hi_en.to('k
-00032ed0: 6556 2729 2e76 616c 7565 290a 2020 2020  eV').value).    
-00032ee0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00032ef0: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
-00032f00: 6545 7272 6f72 2822 6c6f 5f65 6e20 616e  eError("lo_en an
-00032f10: 6420 6869 5f65 6e20 6d75 7374 2062 6520  d hi_en must be 
-00032f20: 6569 7468 6572 2042 4f54 4820 4e6f 6e65  either BOTH None
-00032f30: 206f 7220 424f 5448 2061 6e20 4173 7472   or BOTH an Astr
-00032f40: 6f70 7920 7175 616e 7469 7479 2e22 290a  opy quantity.").
-00032f50: 0a20 2020 2020 2020 206d 6174 6368 6564  .        matched
-00032f60: 5f70 726f 6473 203d 2073 656c 662e 6765  _prods = self.ge
-00032f70: 745f 7072 6f64 7563 7473 2827 636f 6d62  t_products('comb
-00032f80: 696e 6564 5f65 7870 6d61 7027 2c20 6578  ined_expmap', ex
-00032f90: 7472 615f 6b65 793d 656e 6572 6779 5f6b  tra_key=energy_k
-00032fa0: 6579 290a 2020 2020 2020 2020 6966 206c  ey).        if l
-00032fb0: 656e 286d 6174 6368 6564 5f70 726f 6473  en(matched_prods
-00032fc0: 2920 3d3d 2031 3a0a 2020 2020 2020 2020  ) == 1:.        
-00032fd0: 2020 2020 6d61 7463 6865 645f 7072 6f64      matched_prod
-00032fe0: 7320 3d20 6d61 7463 6865 645f 7072 6f64  s = matched_prod
-00032ff0: 735b 305d 0a20 2020 2020 2020 2065 6c69  s[0].        eli
-00033000: 6620 6c65 6e28 6d61 7463 6865 645f 7072  f len(matched_pr
-00033010: 6f64 7329 203d 3d20 303a 0a20 2020 2020  ods) == 0:.     
-00033020: 2020 2020 2020 2072 6169 7365 204e 6f50         raise NoP
-00033030: 726f 6475 6374 4176 6169 6c61 626c 6545  roductAvailableE
-00033040: 7272 6f72 2822 4361 6e6e 6f74 2066 696e  rror("Cannot fin
-00033050: 6420 616e 7920 636f 6d62 696e 6564 2065  d any combined e
-00033060: 7870 6f73 7572 6520 6d61 7073 206d 6174  xposure maps mat
-00033070: 6368 696e 6720 796f 7572 2069 6e70 7574  ching your input
-00033080: 2e22 290a 0a20 2020 2020 2020 2072 6574  .")..        ret
-00033090: 7572 6e20 6d61 7463 6865 645f 7072 6f64  urn matched_prod
-000330a0: 730a 0a20 2020 2064 6566 2067 6574 5f63  s..    def get_c
-000330b0: 6f6d 6269 6e65 645f 7261 7465 6d61 7073  ombined_ratemaps
-000330c0: 2873 656c 662c 206c 6f5f 656e 3a20 5175  (self, lo_en: Qu
-000330d0: 616e 7469 7479 203d 204e 6f6e 652c 2068  antity = None, h
-000330e0: 695f 656e 3a20 5175 616e 7469 7479 203d  i_en: Quantity =
-000330f0: 204e 6f6e 652c 2020 7073 665f 636f 7272   None,  psf_corr
-00033100: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
-00033110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033120: 2020 2020 2020 2020 2020 2020 2020 7073                ps
-00033130: 665f 6d6f 6465 6c3a 2073 7472 203d 2022  f_model: str = "
-00033140: 454c 4c42 4554 4122 2c20 7073 665f 6269  ELLBETA", psf_bi
-00033150: 6e73 3a20 696e 7420 3d20 342c 2070 7366  ns: int = 4, psf
-00033160: 5f61 6c67 6f3a 2073 7472 203d 2022 726c  _algo: str = "rl
-00033170: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-00033180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033190: 2070 7366 5f69 7465 723a 2069 6e74 203d   psf_iter: int =
-000331a0: 2031 3529 202d 3e20 556e 696f 6e5b 5261   15) -> Union[Ra
-000331b0: 7465 4d61 702c 204c 6973 745b 5261 7465  teMap, List[Rate
-000331c0: 4d61 705d 5d3a 0a20 2020 2020 2020 2022  Map]]:.        "
-000331d0: 2222 0a20 2020 2020 2020 2041 206d 6574  "".        A met
-000331e0: 686f 6420 746f 2072 6574 7269 6576 6520  hod to retrieve 
-000331f0: 636f 6d62 696e 6564 2058 4741 2052 6174  combined XGA Rat
-00033200: 654d 6170 206f 626a 6563 7473 2c20 6173  eMap objects, as
-00033210: 2069 6e20 7468 6f73 6520 7261 7465 6d61   in those ratema
-00033220: 7020 7468 6174 2068 6176 6520 6265 656e  p that have been
-00033230: 2063 7265 6174 6564 2062 790a 2020 2020   created by.    
-00033240: 2020 2020 6d65 7267 696e 6720 616c 6c20      merging all 
-00033250: 6176 6169 6c61 626c 6520 6461 7461 2066  available data f
-00033260: 6f72 2074 6869 7320 736f 7572 6365 2e20  or this source. 
-00033270: 5468 6973 2073 7570 706f 7274 7320 7468  This supports th
-00033280: 6520 7265 7472 6965 7661 6c20 6f66 2062  e retrieval of b
-00033290: 6f74 6820 5053 4620 636f 7272 6563 7465  oth PSF correcte
-000332a0: 6420 616e 6420 6e6f 6e2d 5053 460a 2020  d and non-PSF.  
-000332b0: 2020 2020 2020 636f 7272 6563 7465 6420        corrected 
-000332c0: 7261 7465 6d61 7073 2c20 6173 2077 656c  ratemaps, as wel
-000332d0: 6c20 6173 2073 6574 7469 6e67 2074 6865  l as setting the
-000332e0: 2065 6e65 7267 7920 6c69 6d69 7473 206f   energy limits o
-000332f0: 6620 7468 6520 7370 6563 6966 6963 2072  f the specific r
-00033300: 6174 656d 6170 2079 6f75 2077 6f75 6c64  atemap you would
-00033310: 206c 696b 652e 2041 0a20 2020 2020 2020   like. A.       
-00033320: 204e 6f50 726f 6475 6374 4176 6169 6c61   NoProductAvaila
-00033330: 626c 6545 7272 6f72 2065 7272 6f72 2077  bleError error w
-00033340: 696c 6c20 6265 2072 6169 7365 6420 6966  ill be raised if
-00033350: 206e 6f20 6d61 7463 6865 7320 6172 6520   no matches are 
-00033360: 666f 756e 642e 0a0a 2020 2020 2020 2020  found...        
-00033370: 3a70 6172 616d 2051 7561 6e74 6974 7920  :param Quantity 
-00033380: 6c6f 5f65 6e3a 2054 6865 206c 6f77 6572  lo_en: The lower
-00033390: 2065 6e65 7267 7920 6c69 6d69 7420 6f66   energy limit of
-000333a0: 2074 6865 2072 6174 656d 6170 7320 796f   the ratemaps yo
-000333b0: 7520 7769 7368 2074 6f20 7265 7472 6965  u wish to retrie
-000333c0: 7665 2c20 7468 6520 6465 6661 756c 740a  ve, the default.
-000333d0: 2020 2020 2020 2020 2020 2020 6973 204e              is N
-000333e0: 6f6e 6520 2877 6869 6368 2077 696c 6c20  one (which will 
-000333f0: 7265 7472 6965 7665 2061 6c6c 2072 6174  retrieve all rat
-00033400: 656d 6170 7320 7265 6761 7264 6c65 7373  emaps regardless
-00033410: 206f 6620 656e 6572 6779 206c 696d 6974   of energy limit
-00033420: 292e 0a20 2020 2020 2020 203a 7061 7261  )..        :para
-00033430: 6d20 5175 616e 7469 7479 2068 695f 656e  m Quantity hi_en
-00033440: 3a20 5468 6520 7570 7065 7220 656e 6572  : The upper ener
-00033450: 6779 206c 696d 6974 206f 6620 7468 6520  gy limit of the 
-00033460: 7261 7465 6d61 7073 2079 6f75 2077 6973  ratemaps you wis
-00033470: 6820 746f 2072 6574 7269 6576 652c 2074  h to retrieve, t
-00033480: 6865 2064 6566 6175 6c74 0a20 2020 2020  he default.     
-00033490: 2020 2020 2020 2069 7320 4e6f 6e65 2028         is None (
-000334a0: 7768 6963 6820 7769 6c6c 2072 6574 7269  which will retri
-000334b0: 6576 6520 616c 6c20 7261 7465 6d61 7073  eve all ratemaps
-000334c0: 2072 6567 6172 646c 6573 7320 6f66 2065   regardless of e
-000334d0: 6e65 7267 7920 6c69 6d69 7429 2e0a 2020  nergy limit)..  
-000334e0: 2020 2020 2020 3a70 6172 616d 2062 6f6f        :param boo
-000334f0: 6c20 7073 665f 636f 7272 3a20 5365 7473  l psf_corr: Sets
-00033500: 2077 6865 7468 6572 2079 6f75 2077 6973   whether you wis
-00033510: 6820 746f 2072 6574 7269 6576 6520 6120  h to retrieve a 
-00033520: 5053 4620 636f 7272 6563 7465 6420 7261  PSF corrected ra
-00033530: 7465 6d61 7020 6f72 206e 6f74 2e0a 2020  temap or not..  
-00033540: 2020 2020 2020 3a70 6172 616d 2073 7472        :param str
-00033550: 2070 7366 5f6d 6f64 656c 3a20 4966 2074   psf_model: If t
-00033560: 6865 2072 6174 656d 6170 2079 6f75 2077  he ratemap you w
-00033570: 616e 7420 6973 2050 5346 2063 6f72 7265  ant is PSF corre
-00033580: 6374 6564 2c20 7468 6973 2069 7320 7468  cted, this is th
-00033590: 6520 5053 4620 6d6f 6465 6c20 7573 6564  e PSF model used
-000335a0: 2e0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
-000335b0: 2069 6e74 2070 7366 5f62 696e 733a 2049   int psf_bins: I
-000335c0: 6620 7468 6520 7261 7465 6d61 7020 796f  f the ratemap yo
-000335d0: 7520 7761 6e74 2069 7320 5053 4620 636f  u want is PSF co
-000335e0: 7272 6563 7465 642c 2074 6869 7320 6973  rrected, this is
-000335f0: 2074 6865 206e 756d 6265 7220 6f66 2050   the number of P
-00033600: 5346 7320 7065 720a 2020 2020 2020 2020  SFs per.        
-00033610: 2020 2020 7369 6465 2069 6e20 7468 6520      side in the 
-00033620: 5053 4620 6772 6964 2e0a 2020 2020 2020  PSF grid..      
-00033630: 2020 3a70 6172 616d 2073 7472 2070 7366    :param str psf
-00033640: 5f61 6c67 6f3a 2049 6620 7468 6520 7261  _algo: If the ra
-00033650: 7465 6d61 7020 796f 7520 7761 6e74 2069  temap you want i
-00033660: 7320 5053 4620 636f 7272 6563 7465 642c  s PSF corrected,
-00033670: 2074 6869 7320 6973 2074 6865 2061 6c67   this is the alg
-00033680: 6f72 6974 686d 2075 7365 642e 0a20 2020  orithm used..   
-00033690: 2020 2020 203a 7061 7261 6d20 696e 7420       :param int 
-000336a0: 7073 665f 6974 6572 3a20 4966 2074 6865  psf_iter: If the
-000336b0: 2072 6174 656d 6170 2079 6f75 2077 616e   ratemap you wan
-000336c0: 7420 6973 2050 5346 2063 6f72 7265 6374  t is PSF correct
-000336d0: 6564 2c20 7468 6973 2069 7320 7468 6520  ed, this is the 
-000336e0: 6e75 6d62 6572 206f 6620 6974 6572 6174  number of iterat
-000336f0: 696f 6e73 2e0a 2020 2020 2020 2020 3a72  ions..        :r
-00033700: 6574 7572 6e3a 2041 6e20 5847 4120 5261  eturn: An XGA Ra
-00033710: 7465 4d61 7020 6f62 6a65 6374 2028 6966  teMap object (if
-00033720: 2074 6865 7265 2069 7320 616e 2065 7861   there is an exa
-00033730: 6374 206d 6174 6368 292c 206f 7220 6120  ct match), or a 
-00033740: 6c69 7374 206f 6620 5847 4120 5261 7465  list of XGA Rate
-00033750: 4d61 7020 6f62 6a65 6374 7320 2869 6620  Map objects (if 
-00033760: 7468 6572 650a 2020 2020 2020 2020 2020  there.          
-00033770: 2020 7765 7265 206d 756c 7469 706c 6520    were multiple 
-00033780: 6d61 7463 6869 6e67 2070 726f 6475 6374  matching product
-00033790: 7329 2e0a 2020 2020 2020 2020 3a72 7479  s)..        :rty
-000337a0: 7065 3a20 556e 696f 6e5b 5261 7465 4d61  pe: Union[RateMa
-000337b0: 702c 204c 6973 745b 5261 7465 4d61 705d  p, List[RateMap]
-000337c0: 5d0a 2020 2020 2020 2020 2222 220a 2020  ].        """.  
-000337d0: 2020 2020 2020 2320 5468 6973 2066 756e        # This fun
-000337e0: 6374 696f 6e20 6973 2065 7373 656e 7469  ction is essenti
-000337f0: 616c 6c79 2069 6465 6e74 6963 616c 2074  ally identical t
-00033800: 6f20 6765 745f 696d 6167 6573 2c20 6275  o get_images, bu
-00033810: 7420 4927 6d20 676f 696e 6720 746f 2062  t I'm going to b
-00033820: 6520 6c61 7a79 2061 6e64 206e 6f74 2077  e lazy and not w
-00033830: 7269 7465 0a20 2020 2020 2020 2023 2020  rite.        #  
-00033840: 6120 7365 7061 7261 7465 2069 6e74 6572  a separate inter
-00033850: 6e61 6c20 6675 6e63 7469 6f6e 2074 6f20  nal function to 
-00033860: 646f 2062 6f74 682e 0a0a 2020 2020 2020  do both...      
-00033870: 2020 2320 4368 6563 6b73 2074 6f20 6d61    # Checks to ma
-00033880: 6b65 2073 7572 6520 7468 6174 2061 6e20  ke sure that an 
-00033890: 616c 6c6f 7765 6420 636f 6d62 696e 6174  allowed combinat
-000338a0: 696f 6e20 6f66 206c 6f5f 656e 2061 6e64  ion of lo_en and
-000338b0: 2068 695f 656e 2068 6173 2062 6565 6e20   hi_en has been 
-000338c0: 7061 7373 6564 2e0a 2020 2020 2020 2020  passed..        
-000338d0: 6966 2061 6c6c 285b 6c6f 5f65 6e20 6973  if all([lo_en is
-000338e0: 204e 6f6e 652c 2068 695f 656e 2069 7320   None, hi_en is 
-000338f0: 4e6f 6e65 5d29 3a0a 2020 2020 2020 2020  None]):.        
-00033900: 2020 2020 2320 5365 7473 2061 2066 6c61      # Sets a fla
-00033910: 6720 746f 2074 656c 6c20 7468 6520 7265  g to tell the re
-00033920: 7374 206f 6620 7468 6520 6d65 7468 6f64  st of the method
-00033930: 2077 6865 7468 6572 2077 6520 6861 7665   whether we have
-00033940: 2065 6e65 7267 7920 6c69 6d73 206f 7220   energy lims or 
-00033950: 6e6f 740a 2020 2020 2020 2020 2020 2020  not.            
-00033960: 7769 7468 5f6c 696d 7320 3d20 4661 6c73  with_lims = Fals
-00033970: 650a 2020 2020 2020 2020 2020 2020 656e  e.            en
-00033980: 6572 6779 5f6b 6579 203d 204e 6f6e 650a  ergy_key = None.
-00033990: 2020 2020 2020 2020 656c 6966 2061 6c6c          elif all
-000339a0: 285b 6c6f 5f65 6e20 6973 206e 6f74 204e  ([lo_en is not N
-000339b0: 6f6e 652c 2068 695f 656e 2069 7320 6e6f  one, hi_en is no
-000339c0: 7420 4e6f 6e65 5d29 3a0a 2020 2020 2020  t None]):.      
-000339d0: 2020 2020 2020 7769 7468 5f6c 696d 7320        with_lims 
-000339e0: 3d20 5472 7565 0a20 2020 2020 2020 2020  = True.         
-000339f0: 2020 2023 2057 6520 6861 7665 2065 6e65     # We have ene
-00033a00: 7267 7920 6c69 6d69 7473 2068 6572 6520  rgy limits here 
-00033a10: 736f 2077 6520 6173 7365 6d62 6c65 2074  so we assemble t
-00033a20: 6865 206b 6579 2074 6861 7420 6465 7363  he key that desc
-00033a30: 7269 6265 7320 7468 6520 656e 6572 6779  ribes the energy
-00033a40: 2072 616e 6765 0a20 2020 2020 2020 2020   range.         
-00033a50: 2020 2065 6e65 7267 795f 6b65 7920 3d20     energy_key = 
-00033a60: 2262 6f75 6e64 5f7b 6c7d 2d7b 687d 222e  "bound_{l}-{h}".
-00033a70: 666f 726d 6174 286c 3d6c 6f5f 656e 2e74  format(l=lo_en.t
-00033a80: 6f28 276b 6556 2729 2e76 616c 7565 2c20  o('keV').value, 
-00033a90: 683d 6869 5f65 6e2e 746f 2827 6b65 5627  h=hi_en.to('keV'
-00033aa0: 292e 7661 6c75 6529 0a20 2020 2020 2020  ).value).       
-00033ab0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00033ac0: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-00033ad0: 726f 7228 226c 6f5f 656e 2061 6e64 2068  ror("lo_en and h
-00033ae0: 695f 656e 206d 7573 7420 6265 2065 6974  i_en must be eit
-00033af0: 6865 7220 424f 5448 204e 6f6e 6520 6f72  her BOTH None or
-00033b00: 2042 4f54 4820 616e 2041 7374 726f 7079   BOTH an Astropy
-00033b10: 2071 7561 6e74 6974 792e 2229 0a0a 2020   quantity.")..  
-00033b20: 2020 2020 2020 2320 4966 2077 6520 6172        # If we ar
-00033b30: 6520 6c6f 6f6b 696e 6720 666f 7220 6120  e looking for a 
-00033b40: 5053 4620 636f 7272 6563 7465 6420 7261  PSF corrected ra
-00033b50: 7465 6d61 7020 7468 656e 2077 6520 6173  temap then we as
-00033b60: 7365 6d62 6c65 2074 6865 2065 7874 7261  semble the extra
-00033b70: 206b 6579 2077 6974 6820 5053 4620 6465   key with PSF de
-00033b80: 7461 696c 730a 2020 2020 2020 2020 6966  tails.        if
-00033b90: 2070 7366 5f63 6f72 723a 0a20 2020 2020   psf_corr:.     
-00033ba0: 2020 2020 2020 2065 7874 7261 5f6b 6579         extra_key
-00033bb0: 203d 2022 5f22 202b 2070 7366 5f6d 6f64   = "_" + psf_mod
-00033bc0: 656c 202b 2022 5f22 202b 2073 7472 2870  el + "_" + str(p
-00033bd0: 7366 5f62 696e 7329 202b 2022 5f22 202b  sf_bins) + "_" +
-00033be0: 2070 7366 5f61 6c67 6f20 2b20 7374 7228   psf_algo + str(
-00033bf0: 7073 665f 6974 6572 290a 0a20 2020 2020  psf_iter)..     
-00033c00: 2020 2069 6620 6e6f 7420 7073 665f 636f     if not psf_co
-00033c10: 7272 2061 6e64 2077 6974 685f 6c69 6d73  rr and with_lims
-00033c20: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-00033c30: 5369 6d70 6c65 7374 2063 6173 652c 206a  Simplest case, j
-00033c40: 7573 7420 6361 6c6c 696e 6720 6765 745f  ust calling get_
-00033c50: 7072 6f64 7563 7473 2061 6e64 2070 6173  products and pas
-00033c60: 7369 6e67 2069 6e20 6f75 7220 696e 666f  sing in our info
-00033c70: 726d 6174 696f 6e0a 2020 2020 2020 2020  rmation.        
-00033c80: 2020 2020 6d61 7463 6865 645f 7072 6f64      matched_prod
-00033c90: 7320 3d20 7365 6c66 2e67 6574 5f70 726f  s = self.get_pro
-00033ca0: 6475 6374 7328 2763 6f6d 6269 6e65 645f  ducts('combined_
-00033cb0: 7261 7465 6d61 7027 2c20 6578 7472 615f  ratemap', extra_
-00033cc0: 6b65 793d 656e 6572 6779 5f6b 6579 290a  key=energy_key).
-00033cd0: 2020 2020 2020 2020 656c 6966 206e 6f74          elif not
-00033ce0: 2070 7366 5f63 6f72 7220 616e 6420 6e6f   psf_corr and no
-00033cf0: 7420 7769 7468 5f6c 696d 733a 0a20 2020  t with_lims:.   
-00033d00: 2020 2020 2020 2020 2062 726f 6164 5f6d           broad_m
-00033d10: 6174 6368 6573 203d 2073 656c 662e 6765  atches = self.ge
-00033d20: 745f 7072 6f64 7563 7473 2822 636f 6d62  t_products("comb
-00033d30: 696e 6564 5f72 6174 656d 6170 2229 0a20  ined_ratemap"). 
-00033d40: 2020 2020 2020 2020 2020 206d 6174 6368             match
-00033d50: 6564 5f70 726f 6473 203d 205b 7020 666f  ed_prods = [p fo
-00033d60: 7220 7020 696e 2062 726f 6164 5f6d 6174  r p in broad_mat
-00033d70: 6368 6573 2069 6620 6e6f 7420 702e 7073  ches if not p.ps
-00033d80: 665f 636f 7272 6563 7465 645d 0a20 2020  f_corrected].   
-00033d90: 2020 2020 2065 6c69 6620 7073 665f 636f       elif psf_co
-00033da0: 7272 2061 6e64 2077 6974 685f 6c69 6d73  rr and with_lims
-00033db0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-00033dc0: 4865 7265 2077 6520 6e65 6564 2074 6f20  Here we need to 
-00033dd0: 6164 6420 7468 6520 6578 7472 6120 6b65  add the extra ke
-00033de0: 7920 746f 2074 6865 2065 6e65 7267 7920  y to the energy 
-00033df0: 6b65 790a 2020 2020 2020 2020 2020 2020  key.            
-00033e00: 6d61 7463 6865 645f 7072 6f64 7320 3d20  matched_prods = 
-00033e10: 7365 6c66 2e67 6574 5f70 726f 6475 6374  self.get_product
-00033e20: 7328 2763 6f6d 6269 6e65 645f 7261 7465  s('combined_rate
-00033e30: 6d61 7027 2c20 6578 7472 615f 6b65 793d  map', extra_key=
-00033e40: 656e 6572 6779 5f6b 6579 202b 2065 7874  energy_key + ext
-00033e50: 7261 5f6b 6579 290a 2020 2020 2020 2020  ra_key).        
-00033e60: 656c 6966 2070 7366 5f63 6f72 7220 616e  elif psf_corr an
-00033e70: 6420 6e6f 7420 7769 7468 5f6c 696d 733a  d not with_lims:
-00033e80: 0a20 2020 2020 2020 2020 2020 2023 2048  .            # H
-00033e90: 6572 6520 7765 2064 6f6e 2774 206b 6e6f  ere we don't kno
-00033ea0: 7720 7468 6520 656e 6572 6779 206b 6579  w the energy key
-00033eb0: 2c20 736f 2077 6520 6861 7665 2074 6f20  , so we have to 
-00033ec0: 6c6f 6f6b 2066 6f72 2070 6172 7469 616c  look for partial
-00033ed0: 206d 6174 6368 6573 2069 6e20 7468 6520   matches in the 
-00033ee0: 6765 745f 7072 6f64 7563 7473 2072 6574  get_products ret
-00033ef0: 7572 6e0a 2020 2020 2020 2020 2020 2020  urn.            
-00033f00: 6272 6f61 645f 6d61 7463 6865 7320 3d20  broad_matches = 
-00033f10: 7365 6c66 2e67 6574 5f70 726f 6475 6374  self.get_product
-00033f20: 7328 2763 6f6d 6269 6e65 645f 7261 7465  s('combined_rate
-00033f30: 6d61 7027 2c20 6578 7472 615f 6b65 793d  map', extra_key=
-00033f40: 4e6f 6e65 2c20 6a75 7374 5f6f 626a 3d46  None, just_obj=F
-00033f50: 616c 7365 290a 2020 2020 2020 2020 2020  alse).          
-00033f60: 2020 6d61 7463 6865 645f 7072 6f64 7320    matched_prods 
-00033f70: 3d20 5b70 5b2d 315d 2066 6f72 2070 2069  = [p[-1] for p i
-00033f80: 6e20 6272 6f61 645f 6d61 7463 6865 7320  n broad_matches 
-00033f90: 6966 2065 7874 7261 5f6b 6579 2069 6e20  if extra_key in 
-00033fa0: 705b 2d32 5d5d 0a0a 2020 2020 2020 2020  p[-2]]..        
-00033fb0: 6966 206c 656e 286d 6174 6368 6564 5f70  if len(matched_p
-00033fc0: 726f 6473 2920 3d3d 2031 3a0a 2020 2020  rods) == 1:.    
-00033fd0: 2020 2020 2020 2020 6d61 7463 6865 645f          matched_
-00033fe0: 7072 6f64 7320 3d20 6d61 7463 6865 645f  prods = matched_
-00033ff0: 7072 6f64 735b 305d 0a20 2020 2020 2020  prods[0].       
-00034000: 2065 6c69 6620 6c65 6e28 6d61 7463 6865   elif len(matche
-00034010: 645f 7072 6f64 7329 203d 3d20 303a 0a20  d_prods) == 0:. 
-00034020: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00034030: 204e 6f50 726f 6475 6374 4176 6169 6c61   NoProductAvaila
-00034040: 626c 6545 7272 6f72 2822 4361 6e6e 6f74  bleError("Cannot
-00034050: 2066 696e 6420 616e 7920 636f 6d62 696e   find any combin
-00034060: 6564 2072 6174 656d 6170 7320 6d61 7463  ed ratemaps matc
-00034070: 6869 6e67 2079 6f75 7220 696e 7075 742e  hing your input.
-00034080: 2229 0a0a 2020 2020 2020 2020 7265 7475  ")..        retu
-00034090: 726e 206d 6174 6368 6564 5f70 726f 6473  rn matched_prods
-000340a0: 0a0a 2020 2020 6465 6620 5f67 6574 5f70  ..    def _get_p
-000340b0: 726f 665f 7072 6f64 2873 656c 662c 2073  rof_prod(self, s
-000340c0: 6561 7263 685f 6b65 793a 2073 7472 2c20  earch_key: str, 
-000340d0: 6f62 735f 6964 3a20 7374 7220 3d20 4e6f  obs_id: str = No
-000340e0: 6e65 2c20 696e 7374 3a20 7374 7220 3d20  ne, inst: str = 
-000340f0: 4e6f 6e65 2c20 6365 6e74 7261 6c5f 636f  None, central_co
-00034100: 6f72 643a 2051 7561 6e74 6974 7920 3d20  ord: Quantity = 
-00034110: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
-00034120: 2020 2020 2020 2020 2020 2020 2072 6164               rad
-00034130: 6969 3a20 5175 616e 7469 7479 203d 204e  ii: Quantity = N
-00034140: 6f6e 652c 206c 6f5f 656e 3a20 5175 616e  one, lo_en: Quan
-00034150: 7469 7479 203d 204e 6f6e 652c 2068 695f  tity = None, hi_
-00034160: 656e 3a20 5175 616e 7469 7479 203d 204e  en: Quantity = N
-00034170: 6f6e 6529 205c 0a20 2020 2020 2020 2020  one) \.         
-00034180: 2020 202d 3e20 556e 696f 6e5b 4261 7365     -> Union[Base
-00034190: 5072 6f66 696c 6531 442c 204c 6973 745b  Profile1D, List[
-000341a0: 4261 7365 5072 6f66 696c 6531 445d 5d3a  BaseProfile1D]]:
-000341b0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-000341c0: 2020 2020 2054 6865 2069 6e74 6572 6e61       The interna
-000341d0: 6c20 6d65 7468 6f64 2077 6869 6368 2069  l method which i
-000341e0: 7320 7468 6520 6775 7473 206f 6620 6765  s the guts of ge
-000341f0: 745f 7072 6f66 696c 6573 2061 6e64 2067  t_profiles and g
-00034200: 6574 5f63 6f6d 6269 6e65 645f 7072 6f66  et_combined_prof
-00034210: 696c 6573 2e20 4974 2070 6172 7365 7320  iles. It parses 
-00034220: 7468 6520 696e 7075 7420 616e 640a 2020  the input and.  
-00034230: 2020 2020 2020 7365 6172 6368 6573 2066        searches f
-00034240: 6f72 2066 756c 6c20 616e 6420 7061 7274  or full and part
-00034250: 6961 6c20 6d61 7463 6865 7320 696e 2074  ial matches in t
-00034260: 6869 7320 736f 7572 6365 2773 2070 726f  his source's pro
-00034270: 6475 6374 2073 746f 7261 6765 2073 7472  duct storage str
-00034280: 7563 7475 7265 2e0a 0a20 2020 2020 2020  ucture...       
-00034290: 203a 7061 7261 6d20 7374 7220 7365 6172   :param str sear
-000342a0: 6368 5f6b 6579 3a20 5468 6520 6578 6163  ch_key: The exac
-000342b0: 7420 7365 6172 6368 206b 6579 2077 6869  t search key whi
-000342c0: 6368 2064 6566 696e 6564 2070 726f 6669  ch defined profi
-000342d0: 6c65 2074 7970 652c 2061 6e64 2077 6865  le type, and whe
-000342e0: 7468 6572 2069 7420 6973 2063 6f6d 6269  ther it is combi
-000342f0: 6e65 6420 6f72 206e 6f74 2e0a 2020 2020  ned or not..    
-00034300: 2020 2020 3a70 6172 616d 2073 7472 206f      :param str o
-00034310: 6273 5f69 643a 204f 7074 696f 6e61 6c6c  bs_id: Optionall
-00034320: 792c 2061 2073 7065 6369 6669 6320 6f62  y, a specific ob
-00034330: 735f 6964 2074 6f20 7365 6172 6368 2066  s_id to search f
-00034340: 6f72 2063 616e 2062 6520 7375 7070 6c69  or can be suppli
-00034350: 6564 2e20 5468 6520 6465 6661 756c 7420  ed. The default 
-00034360: 6973 204e 6f6e 652c 0a20 2020 2020 2020  is None,.       
-00034370: 2020 2020 2077 6869 6368 206d 6561 6e73       which means
-00034380: 2061 6c6c 2070 726f 6669 6c65 7320 6d61   all profiles ma
-00034390: 7463 6869 6e67 2074 6865 206f 7468 6572  tching the other
-000343a0: 2063 7269 7465 7269 6120 7769 6c6c 2062   criteria will b
-000343b0: 6520 7265 7475 726e 6564 2e0a 2020 2020  e returned..    
-000343c0: 2020 2020 3a70 6172 616d 2073 7472 2069      :param str i
-000343d0: 6e73 743a 204f 7074 696f 6e61 6c6c 792c  nst: Optionally,
-000343e0: 2061 2073 7065 6369 6669 6320 696e 7374   a specific inst
-000343f0: 7275 6d65 6e74 2074 6f20 7365 6172 6368  rument to search
-00034400: 2066 6f72 2063 616e 2062 6520 7375 7070   for can be supp
-00034410: 6c69 6564 2e20 5468 6520 6465 6661 756c  lied. The defaul
-00034420: 7420 6973 204e 6f6e 652c 0a20 2020 2020  t is None,.     
-00034430: 2020 2020 2020 2077 6869 6368 206d 6561         which mea
-00034440: 6e73 2061 6c6c 2070 726f 6669 6c65 7320  ns all profiles 
-00034450: 6d61 7463 6869 6e67 2074 6865 206f 7468  matching the oth
-00034460: 6572 2063 7269 7465 7269 6120 7769 6c6c  er criteria will
-00034470: 2062 6520 7265 7475 726e 6564 2e0a 2020   be returned..  
-00034480: 2020 2020 2020 3a70 6172 616d 2051 7561        :param Qua
-00034490: 6e74 6974 7920 6365 6e74 7261 6c5f 636f  ntity central_co
-000344a0: 6f72 643a 2054 6865 2063 656e 7472 616c  ord: The central
-000344b0: 2063 6f6f 7264 696e 6174 6520 6f66 2074   coordinate of t
-000344c0: 6865 2070 726f 6669 6c65 2079 6f75 2077  he profile you w
-000344d0: 6973 6820 746f 2072 6574 7269 6576 652c  ish to retrieve,
-000344e0: 2074 6865 2064 6566 6175 6c74 0a20 2020   the default.   
-000344f0: 2020 2020 2020 2020 2069 7320 4e6f 6e65           is None
-00034500: 2077 6869 6368 206d 6561 6e73 2074 6865   which means the
-00034510: 206d 6574 686f 6420 7769 6c6c 2075 7365   method will use
-00034520: 2074 6865 2064 6566 6175 6c74 2063 6f6f   the default coo
-00034530: 7264 696e 6174 6520 6f66 2074 6869 7320  rdinate of this 
-00034540: 736f 7572 6365 2e0a 2020 2020 2020 2020  source..        
-00034550: 3a70 6172 616d 2051 7561 6e74 6974 7920  :param Quantity 
-00034560: 7261 6469 693a 2054 6865 2063 656e 7472  radii: The centr
-00034570: 616c 2072 6164 6969 206f 6620 7468 6520  al radii of the 
-00034580: 7072 6f66 696c 6520 706f 696e 7473 2c20  profile points, 
-00034590: 6974 2069 7320 6e6f 7420 6c69 6b65 6c79  it is not likely
-000345a0: 2074 6861 7420 7468 6973 206f 7074 696f   that this optio
-000345b0: 6e20 7769 6c6c 2062 650a 2020 2020 2020  n will be.      
-000345c0: 2020 2020 2020 7573 6564 206f 6674 656e        used often
-000345d0: 2061 7320 796f 7520 6c69 6b65 6c79 2077   as you likely w
-000345e0: 6f6e 2774 206b 6e6f 7720 7468 6520 7261  on't know the ra
-000345f0: 6469 616c 2076 616c 7565 7320 6120 7072  dial values a pr
-00034600: 696f 7269 2e0a 2020 2020 2020 2020 3a70  iori..        :p
-00034610: 6172 616d 2051 7561 6e74 6974 7920 6c6f  aram Quantity lo
-00034620: 5f65 6e3a 2054 6865 206c 6f77 6572 2065  _en: The lower e
-00034630: 6e65 7267 7920 626f 756e 6420 6f66 2074  nergy bound of t
-00034640: 6865 2070 726f 6669 6c65 2079 6f75 2077  he profile you w
-00034650: 6973 6820 746f 2072 6574 7269 6576 6520  ish to retrieve 
-00034660: 2869 6620 6170 706c 6963 6162 6c65 292c  (if applicable),
-00034670: 2064 6566 6175 6c74 0a20 2020 2020 2020   default.       
-00034680: 2020 2020 2069 7320 4e6f 6e65 2c20 616e       is None, an
-00034690: 6420 6966 2074 6869 7320 6172 6775 6d65  d if this argume
-000346a0: 6e74 2069 7320 7061 7373 6564 2068 695f  nt is passed hi_
-000346b0: 656e 206d 7573 7420 6265 2074 6f6f 2e0a  en must be too..
-000346c0: 2020 2020 2020 2020 3a70 6172 616d 2051          :param Q
-000346d0: 7561 6e74 6974 7920 6869 5f65 6e3a 2054  uantity hi_en: T
-000346e0: 6865 2068 6967 6865 7220 656e 6572 6779  he higher energy
-000346f0: 2062 6f75 6e64 206f 6620 7468 6520 7072   bound of the pr
-00034700: 6f66 696c 6520 796f 7520 7769 7368 2074  ofile you wish t
-00034710: 6f20 7265 7472 6965 7665 2028 6966 2061  o retrieve (if a
-00034720: 7070 6c69 6361 626c 6529 2c20 6465 6661  pplicable), defa
-00034730: 756c 740a 2020 2020 2020 2020 2020 2020  ult.            
-00034740: 6973 204e 6f6e 652c 2061 6e64 2069 6620  is None, and if 
-00034750: 7468 6973 2061 7267 756d 656e 7420 6973  this argument is
-00034760: 2070 6173 7365 6420 6c6f 5f65 6e20 6d75   passed lo_en mu
-00034770: 7374 2062 6520 746f 6f2e 0a20 2020 2020  st be too..     
-00034780: 2020 203a 7265 7475 726e 3a20 416e 2058     :return: An X
-00034790: 4741 2070 726f 6669 6c65 206f 626a 6563  GA profile objec
-000347a0: 7420 2869 6620 7468 6572 6520 6973 2061  t (if there is a
-000347b0: 6e20 6578 6163 7420 6d61 7463 6829 2c20  n exact match), 
-000347c0: 6f72 2061 206c 6973 7420 6f66 2058 4741  or a list of XGA
-000347d0: 2070 726f 6669 6c65 206f 626a 6563 7473   profile objects
-000347e0: 2028 6966 2074 6865 7265 0a20 2020 2020   (if there.     
-000347f0: 2020 2020 2020 2077 6572 6520 6d75 6c74         were mult
-00034800: 6970 6c65 206d 6174 6368 696e 6720 7072  iple matching pr
-00034810: 6f64 7563 7473 292e 0a20 2020 2020 2020  oducts)..       
-00034820: 203a 7274 7970 653a 2055 6e69 6f6e 5b42   :rtype: Union[B
-00034830: 6173 6550 726f 6669 6c65 3144 2c20 4c69  aseProfile1D, Li
-00034840: 7374 5b42 6173 6550 726f 6669 6c65 3144  st[BaseProfile1D
-00034850: 5d5d 0a20 2020 2020 2020 2022 2222 0a20  ]].        """. 
-00034860: 2020 2020 2020 2069 6620 616c 6c28 5b6c         if all([l
-00034870: 6f5f 656e 2069 7320 4e6f 6e65 2c20 6869  o_en is None, hi
-00034880: 5f65 6e20 6973 204e 6f6e 655d 293a 0a20  _en is None]):. 
-00034890: 2020 2020 2020 2020 2020 2065 6e65 7267             energ
-000348a0: 795f 6b65 7920 3d20 225f 220a 2020 2020  y_key = "_".    
-000348b0: 2020 2020 656c 6966 2061 6c6c 285b 6c6f      elif all([lo
-000348c0: 5f65 6e20 6973 206e 6f74 204e 6f6e 652c  _en is not None,
-000348d0: 2068 695f 656e 2069 7320 6e6f 7420 4e6f   hi_en is not No
-000348e0: 6e65 5d29 3a0a 2020 2020 2020 2020 2020  ne]):.          
-000348f0: 2020 656e 6572 6779 5f6b 6579 203d 2022    energy_key = "
-00034900: 626f 756e 645f 7b6c 7d2d 7b68 7d5f 222e  bound_{l}-{h}_".
-00034910: 666f 726d 6174 286c 3d6c 6f5f 656e 2e74  format(l=lo_en.t
-00034920: 6f28 276b 6556 2729 2e76 616c 7565 2c20  o('keV').value, 
-00034930: 683d 6869 5f65 6e2e 746f 2827 6b65 5627  h=hi_en.to('keV'
-00034940: 292e 7661 6c75 6529 0a20 2020 2020 2020  ).value).       
-00034950: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00034960: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-00034970: 726f 7228 226c 6f5f 656e 2061 6e64 2068  ror("lo_en and h
-00034980: 695f 656e 206d 7573 7420 6265 2065 6974  i_en must be eit
-00034990: 6865 7220 424f 5448 204e 6f6e 6520 6f72  her BOTH None or
-000349a0: 2042 4f54 4820 616e 2041 7374 726f 7079   BOTH an Astropy
-000349b0: 2071 7561 6e74 6974 792e 2229 0a0a 2020   quantity.")..  
-000349c0: 2020 2020 2020 6966 2063 656e 7472 616c        if central
-000349d0: 5f63 6f6f 7264 2069 7320 4e6f 6e65 3a0a  _coord is None:.
-000349e0: 2020 2020 2020 2020 2020 2020 6365 6e74              cent
-000349f0: 7261 6c5f 636f 6f72 6420 3d20 7365 6c66  ral_coord = self
-00034a00: 2e64 6566 6175 6c74 5f63 6f6f 7264 0a20  .default_coord. 
-00034a10: 2020 2020 2020 2063 656e 5f63 6875 6e6b         cen_chunk
-00034a20: 203d 2022 7261 7b72 7d5f 6465 637b 647d   = "ra{r}_dec{d}
-00034a30: 5f22 2e66 6f72 6d61 7428 723d 6365 6e74  _".format(r=cent
-00034a40: 7261 6c5f 636f 6f72 645b 305d 2e76 616c  ral_coord[0].val
-00034a50: 7565 2c20 643d 6365 6e74 7261 6c5f 636f  ue, d=central_co
-00034a60: 6f72 645b 315d 2e76 616c 7565 290a 0a20  ord[1].value).. 
-00034a70: 2020 2020 2020 2069 6620 7261 6469 6920         if radii 
-00034a80: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00034a90: 2020 2020 2020 2020 2072 6164 6969 203d           radii =
-00034aa0: 2073 656c 662e 636f 6e76 6572 745f 7261   self.convert_ra
-00034ab0: 6469 7573 2872 6164 6969 2c20 2764 6567  dius(radii, 'deg
-00034ac0: 2729 0a20 2020 2020 2020 2020 2020 2072  ').            r
-00034ad0: 6164 5f63 6875 6e6b 203d 2022 7222 202b  ad_chunk = "r" +
-00034ae0: 2022 5f22 2e6a 6f69 6e28 7261 6469 692e   "_".join(radii.
-00034af0: 7661 6c75 652e 6173 7479 7065 2873 7472  value.astype(str
-00034b00: 2929 0a20 2020 2020 2020 2020 2020 2072  )).            r
-00034b10: 6164 5f69 6e66 6f20 3d20 5472 7565 0a20  ad_info = True. 
-00034b20: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00034b30: 2020 2020 2020 2020 2072 6164 5f69 6e66           rad_inf
-00034b40: 6f20 3d20 4661 6c73 650a 0a20 2020 2020  o = False..     
-00034b50: 2020 2062 726f 6164 5f70 726f 6473 203d     broad_prods =
-00034b60: 2073 656c 662e 6765 745f 7072 6f64 7563   self.get_produc
-00034b70: 7473 2873 6561 7263 685f 6b65 792c 206f  ts(search_key, o
-00034b80: 6273 5f69 642c 2069 6e73 742c 206a 7573  bs_id, inst, jus
-00034b90: 745f 6f62 6a3d 4661 6c73 6529 0a20 2020  t_obj=False).   
-00034ba0: 2020 2020 206d 6174 6368 6564 5f70 726f       matched_pro
-00034bb0: 6473 203d 205b 5d0a 2020 2020 2020 2020  ds = [].        
-00034bc0: 666f 7220 7020 696e 2062 726f 6164 5f70  for p in broad_p
-00034bd0: 726f 6473 3a0a 2020 2020 2020 2020 2020  rods:.          
-00034be0: 2020 7261 645f 7374 7220 3d20 705b 2d32    rad_str = p[-2
-00034bf0: 5d2e 7370 6c69 7428 225f 7374 2229 5b30  ].split("_st")[0
-00034c00: 5d2e 7370 6c69 7428 6365 6e5f 6368 756e  ].split(cen_chun
-00034c10: 6b29 5b2d 315d 0a0a 2020 2020 2020 2020  k)[-1]..        
-00034c20: 2020 2020 6966 2063 656e 5f63 6875 6e6b      if cen_chunk
-00034c30: 2069 6e20 705b 2d32 5d20 616e 6420 656e   in p[-2] and en
-00034c40: 6572 6779 5f6b 6579 2069 6e20 705b 2d32  ergy_key in p[-2
-00034c50: 5d20 616e 6420 7261 645f 696e 666f 2061  ] and rad_info a
-00034c60: 6e64 2072 6164 5f73 7472 203d 3d20 7261  nd rad_str == ra
-00034c70: 645f 6368 756e 6b3a 0a20 2020 2020 2020  d_chunk:.       
-00034c80: 2020 2020 2020 2020 206d 6174 6368 6564           matched
-00034c90: 5f70 726f 6473 2e61 7070 656e 6428 705b  _prods.append(p[
-00034ca0: 2d31 5d29 0a20 2020 2020 2020 2020 2020  -1]).           
-00034cb0: 2065 6c69 6620 6365 6e5f 6368 756e 6b20   elif cen_chunk 
-00034cc0: 696e 2070 5b2d 325d 2061 6e64 2065 6e65  in p[-2] and ene
-00034cd0: 7267 795f 6b65 7920 696e 2070 5b2d 325d  rgy_key in p[-2]
-00034ce0: 2061 6e64 206e 6f74 2072 6164 5f69 6e66   and not rad_inf
-00034cf0: 6f3a 0a20 2020 2020 2020 2020 2020 2020  o:.             
-00034d00: 2020 206d 6174 6368 6564 5f70 726f 6473     matched_prods
-00034d10: 2e61 7070 656e 6428 705b 2d31 5d29 0a0a  .append(p[-1])..
-00034d20: 2020 2020 2020 2020 7265 7475 726e 206d          return m
-00034d30: 6174 6368 6564 5f70 726f 6473 0a0a 2020  atched_prods..  
-00034d40: 2020 6465 6620 6765 745f 7072 6f66 696c    def get_profil
-00034d50: 6573 2873 656c 662c 2070 726f 6669 6c65  es(self, profile
-00034d60: 5f74 7970 653a 2073 7472 2c20 6f62 735f  _type: str, obs_
-00034d70: 6964 3a20 7374 7220 3d20 4e6f 6e65 2c20  id: str = None, 
-00034d80: 696e 7374 3a20 7374 7220 3d20 4e6f 6e65  inst: str = None
-00034d90: 2c20 6365 6e74 7261 6c5f 636f 6f72 643a  , central_coord:
-00034da0: 2051 7561 6e74 6974 7920 3d20 4e6f 6e65   Quantity = None
-00034db0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00034dc0: 2020 2020 2020 2072 6164 6969 3a20 5175         radii: Qu
-00034dd0: 616e 7469 7479 203d 204e 6f6e 652c 206c  antity = None, l
-00034de0: 6f5f 656e 3a20 5175 616e 7469 7479 203d  o_en: Quantity =
-00034df0: 204e 6f6e 652c 2068 695f 656e 3a20 5175   None, hi_en: Qu
-00034e00: 616e 7469 7479 203d 204e 6f6e 6529 205c  antity = None) \
-00034e10: 0a20 2020 2020 2020 2020 2020 202d 3e20  .            -> 
-00034e20: 556e 696f 6e5b 4261 7365 5072 6f66 696c  Union[BaseProfil
-00034e30: 6531 442c 204c 6973 745b 4261 7365 5072  e1D, List[BasePr
-00034e40: 6f66 696c 6531 445d 5d3a 0a20 2020 2020  ofile1D]]:.     
-00034e50: 2020 2022 2222 0a20 2020 2020 2020 2054     """.        T
-00034e60: 6869 7320 6973 2074 6865 2067 656e 6572  his is the gener
-00034e70: 6963 2067 6574 206d 6574 686f 6420 666f  ic get method fo
-00034e80: 7220 5847 4120 7072 6f66 696c 6520 6f62  r XGA profile ob
-00034e90: 6a65 6374 7320 7374 6f72 6564 2069 6e20  jects stored in 
-00034ea0: 7468 6973 2073 6f75 7263 652e 2059 6f75  this source. You
-00034eb0: 2073 7469 6c6c 206d 7573 7420 7265 6d65   still must reme
-00034ec0: 6d62 6572 0a20 2020 2020 2020 2074 6865  mber.        the
-00034ed0: 2070 726f 6669 6c65 2074 7970 6520 7661   profile type va
-00034ee0: 6c75 6520 746f 2075 7365 2069 742c 2062  lue to use it, b
-00034ef0: 7574 206f 6e63 6520 656e 7465 7265 6420  ut once entered 
-00034f00: 6974 2077 696c 6c20 7265 7475 726e 2061  it will return a
-00034f10: 206c 6973 7420 6f66 2061 6c6c 206d 6174   list of all mat
-00034f20: 6368 696e 6720 7072 6f66 696c 6573 2028  ching profiles (
-00034f30: 6f72 2061 0a20 2020 2020 2020 2073 696e  or a.        sin
-00034f40: 676c 6520 6f62 6a65 6374 2069 6620 6f6e  gle object if on
-00034f50: 6c79 206f 6e65 206d 6174 6368 2069 7320  ly one match is 
-00034f60: 666f 756e 6429 2e0a 0a20 2020 2020 2020  found)...       
-00034f70: 203a 7061 7261 6d20 7374 7220 7072 6f66   :param str prof
-00034f80: 696c 655f 7479 7065 3a20 5468 6520 7374  ile_type: The st
-00034f90: 7269 6e67 2070 726f 6669 6c65 2074 7970  ring profile typ
-00034fa0: 6520 6f66 2074 6865 2070 726f 6669 6c65  e of the profile
-00034fb0: 2873 2920 796f 7520 7769 7368 2074 6f20  (s) you wish to 
-00034fc0: 7265 7472 6965 7665 2e0a 2020 2020 2020  retrieve..      
-00034fd0: 2020 3a70 6172 616d 2073 7472 206f 6273    :param str obs
-00034fe0: 5f69 643a 204f 7074 696f 6e61 6c6c 792c  _id: Optionally,
-00034ff0: 2061 2073 7065 6369 6669 6320 6f62 735f   a specific obs_
-00035000: 6964 2074 6f20 7365 6172 6368 2066 6f72  id to search for
-00035010: 2063 616e 2062 6520 7375 7070 6c69 6564   can be supplied
-00035020: 2e20 5468 6520 6465 6661 756c 7420 6973  . The default is
-00035030: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
-00035040: 2020 2077 6869 6368 206d 6561 6e73 2061     which means a
-00035050: 6c6c 2070 726f 6669 6c65 7320 6d61 7463  ll profiles matc
-00035060: 6869 6e67 2074 6865 206f 7468 6572 2063  hing the other c
-00035070: 7269 7465 7269 6120 7769 6c6c 2062 6520  riteria will be 
-00035080: 7265 7475 726e 6564 2e0a 2020 2020 2020  returned..      
-00035090: 2020 3a70 6172 616d 2073 7472 2069 6e73    :param str ins
-000350a0: 743a 204f 7074 696f 6e61 6c6c 792c 2061  t: Optionally, a
-000350b0: 2073 7065 6369 6669 6320 696e 7374 7275   specific instru
-000350c0: 6d65 6e74 2074 6f20 7365 6172 6368 2066  ment to search f
-000350d0: 6f72 2063 616e 2062 6520 7375 7070 6c69  or can be suppli
-000350e0: 6564 2e20 5468 6520 6465 6661 756c 7420  ed. The default 
-000350f0: 6973 204e 6f6e 652c 0a20 2020 2020 2020  is None,.       
-00035100: 2020 2020 2077 6869 6368 206d 6561 6e73       which means
-00035110: 2061 6c6c 2070 726f 6669 6c65 7320 6d61   all profiles ma
-00035120: 7463 6869 6e67 2074 6865 206f 7468 6572  tching the other
-00035130: 2063 7269 7465 7269 6120 7769 6c6c 2062   criteria will b
-00035140: 6520 7265 7475 726e 6564 2e0a 2020 2020  e returned..    
-00035150: 2020 2020 3a70 6172 616d 2051 7561 6e74      :param Quant
-00035160: 6974 7920 6365 6e74 7261 6c5f 636f 6f72  ity central_coor
-00035170: 643a 2054 6865 2063 656e 7472 616c 2063  d: The central c
-00035180: 6f6f 7264 696e 6174 6520 6f66 2074 6865  oordinate of the
-00035190: 2070 726f 6669 6c65 2079 6f75 2077 6973   profile you wis
-000351a0: 6820 746f 2072 6574 7269 6576 652c 2074  h to retrieve, t
-000351b0: 6865 2064 6566 6175 6c74 0a20 2020 2020  he default.     
-000351c0: 2020 2020 2020 2069 7320 4e6f 6e65 2077         is None w
-000351d0: 6869 6368 206d 6561 6e73 2074 6865 206d  hich means the m
-000351e0: 6574 686f 6420 7769 6c6c 2075 7365 2074  ethod will use t
-000351f0: 6865 2064 6566 6175 6c74 2063 6f6f 7264  he default coord
-00035200: 696e 6174 6520 6f66 2074 6869 7320 736f  inate of this so
-00035210: 7572 6365 2e0a 2020 2020 2020 2020 3a70  urce..        :p
-00035220: 6172 616d 2051 7561 6e74 6974 7920 7261  aram Quantity ra
-00035230: 6469 693a 2054 6865 2063 656e 7472 616c  dii: The central
-00035240: 2072 6164 6969 206f 6620 7468 6520 7072   radii of the pr
-00035250: 6f66 696c 6520 706f 696e 7473 2c20 6974  ofile points, it
-00035260: 2069 7320 6e6f 7420 6c69 6b65 6c79 2074   is not likely t
-00035270: 6861 7420 7468 6973 206f 7074 696f 6e20  hat this option 
-00035280: 7769 6c6c 2062 650a 2020 2020 2020 2020  will be.        
-00035290: 2020 2020 7573 6564 206f 6674 656e 2061      used often a
-000352a0: 7320 796f 7520 6c69 6b65 6c79 2077 6f6e  s you likely won
-000352b0: 2774 206b 6e6f 7720 7468 6520 7261 6469  't know the radi
-000352c0: 616c 2076 616c 7565 7320 6120 7072 696f  al values a prio
-000352d0: 7269 2e0a 2020 2020 2020 2020 3a70 6172  ri..        :par
-000352e0: 616d 2051 7561 6e74 6974 7920 6c6f 5f65  am Quantity lo_e
-000352f0: 6e3a 2054 6865 206c 6f77 6572 2065 6e65  n: The lower ene
-00035300: 7267 7920 626f 756e 6420 6f66 2074 6865  rgy bound of the
-00035310: 2070 726f 6669 6c65 2079 6f75 2077 6973   profile you wis
-00035320: 6820 746f 2072 6574 7269 6576 6520 2869  h to retrieve (i
-00035330: 6620 6170 706c 6963 6162 6c65 292c 2064  f applicable), d
-00035340: 6566 6175 6c74 0a20 2020 2020 2020 2020  efault.         
-00035350: 2020 2069 7320 4e6f 6e65 2c20 616e 6420     is None, and 
-00035360: 6966 2074 6869 7320 6172 6775 6d65 6e74  if this argument
-00035370: 2069 7320 7061 7373 6564 2068 695f 656e   is passed hi_en
-00035380: 206d 7573 7420 6265 2074 6f6f 2e0a 2020   must be too..  
-00035390: 2020 2020 2020 3a70 6172 616d 2051 7561        :param Qua
-000353a0: 6e74 6974 7920 6869 5f65 6e3a 2054 6865  ntity hi_en: The
-000353b0: 2068 6967 6865 7220 656e 6572 6779 2062   higher energy b
-000353c0: 6f75 6e64 206f 6620 7468 6520 7072 6f66  ound of the prof
-000353d0: 696c 6520 796f 7520 7769 7368 2074 6f20  ile you wish to 
-000353e0: 7265 7472 6965 7665 2028 6966 2061 7070  retrieve (if app
-000353f0: 6c69 6361 626c 6529 2c20 6465 6661 756c  licable), defaul
-00035400: 740a 2020 2020 2020 2020 2020 2020 6973  t.            is
-00035410: 204e 6f6e 652c 2061 6e64 2069 6620 7468   None, and if th
-00035420: 6973 2061 7267 756d 656e 7420 6973 2070  is argument is p
-00035430: 6173 7365 6420 6c6f 5f65 6e20 6d75 7374  assed lo_en must
-00035440: 2062 6520 746f 6f2e 0a20 2020 2020 2020   be too..       
-00035450: 203a 7265 7475 726e 3a20 416e 2058 4741   :return: An XGA
-00035460: 2070 726f 6669 6c65 206f 626a 6563 7420   profile object 
-00035470: 2869 6620 7468 6572 6520 6973 2061 6e20  (if there is an 
-00035480: 6578 6163 7420 6d61 7463 6829 2c20 6f72  exact match), or
-00035490: 2061 206c 6973 7420 6f66 2058 4741 2070   a list of XGA p
-000354a0: 726f 6669 6c65 206f 626a 6563 7473 2028  rofile objects (
-000354b0: 6966 2074 6865 7265 0a20 2020 2020 2020  if there.       
-000354c0: 2020 2020 2077 6572 6520 6d75 6c74 6970       were multip
-000354d0: 6c65 206d 6174 6368 696e 6720 7072 6f64  le matching prod
-000354e0: 7563 7473 292e 0a20 2020 2020 2020 203a  ucts)..        :
-000354f0: 7274 7970 653a 2055 6e69 6f6e 5b42 6173  rtype: Union[Bas
-00035500: 6550 726f 6669 6c65 3144 2c20 4c69 7374  eProfile1D, List
-00035510: 5b42 6173 6550 726f 6669 6c65 3144 5d5d  [BaseProfile1D]]
-00035520: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00035530: 2020 2020 2069 6620 2270 726f 6669 6c65       if "profile
-00035540: 2220 696e 2070 726f 6669 6c65 5f74 7970  " in profile_typ
-00035550: 653a 0a20 2020 2020 2020 2020 2020 2077  e:.            w
-00035560: 6172 6e28 2254 6865 2070 726f 6669 6c65  arn("The profile
-00035570: 5f74 7970 6520 796f 7520 7061 7373 6564  _type you passed
-00035580: 2063 6f6e 7461 696e 7320 7468 6520 776f   contains the wo
-00035590: 7264 2027 7072 6f66 696c 6527 2c20 7768  rd 'profile', wh
-000355a0: 6963 6820 6973 2061 7070 656e 6465 6420  ich is appended 
-000355b0: 6f6e 746f 2022 0a20 2020 2020 2020 2020  onto ".         
-000355c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000355d0: 2022 6120 7072 6f66 696c 6520 7479 7065   "a profile type
-000355e0: 2062 7920 5847 412c 2079 6f75 206e 6565   by XGA, you nee
-000355f0: 6420 746f 2074 7279 2074 6869 7320 6167  d to try this ag
-00035600: 6169 6e20 7769 7468 6f75 7420 7072 6f66  ain without prof
-00035610: 696c 6520 6f6e 2074 6865 2065 6e64 2c20  ile on the end, 
-00035620: 756e 6c65 7373 220a 2020 2020 2020 2020  unless".        
-00035630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035640: 2020 2220 796f 7520 6761 7665 2061 2067    " you gave a g
-00035650: 656e 6572 6963 2070 726f 6669 6c65 2061  eneric profile a
-00035660: 2074 7970 6520 7769 7468 2027 7072 6f66   type with 'prof
-00035670: 696c 6527 2069 6e2e 222c 2073 7461 636b  ile' in.", stack
-00035680: 6c65 7665 6c3d 3229 0a0a 2020 2020 2020  level=2)..      
-00035690: 2020 7365 6172 6368 5f6b 6579 203d 2070    search_key = p
-000356a0: 726f 6669 6c65 5f74 7970 6520 2b20 225f  rofile_type + "_
-000356b0: 7072 6f66 696c 6522 0a20 2020 2020 2020  profile".       
-000356c0: 2069 6620 616c 6c28 5b6f 6273 5f69 6420   if all([obs_id 
-000356d0: 6973 204e 6f6e 652c 2069 6e73 7420 6973  is None, inst is
-000356e0: 204e 6f6e 655d 293a 0a20 2020 2020 2020   None]):.       
-000356f0: 2020 2020 2073 6561 7263 685f 6b65 7920       search_key 
-00035700: 3d20 2263 6f6d 6269 6e65 645f 2220 2b20  = "combined_" + 
-00035710: 7365 6172 6368 5f6b 6579 0a0a 2020 2020  search_key..    
-00035720: 2020 2020 7365 6172 6368 5f6b 6579 203d      search_key =
-00035730: 2070 726f 6669 6c65 5f74 7970 6520 2b20   profile_type + 
-00035740: 225f 7072 6f66 696c 6522 0a20 2020 2020  "_profile".     
-00035750: 2020 2069 6620 7365 6172 6368 5f6b 6579     if search_key
-00035760: 206e 6f74 2069 6e20 414c 4c4f 5745 445f   not in ALLOWED_
-00035770: 5052 4f44 5543 5453 3a0a 2020 2020 2020  PRODUCTS:.      
-00035780: 2020 2020 2020 7761 726e 2822 7b7d 2073        warn("{} s
-00035790: 6565 6d73 2074 6f20 6265 2061 2063 7573  eems to be a cus
-000357a0: 746f 6d20 7072 6f66 696c 652c 206e 6f74  tom profile, not
-000357b0: 2061 6e20 5847 4120 6465 6661 756c 7420   an XGA default 
-000357c0: 7479 7065 2e20 4966 2074 6869 7320 6973  type. If this is
-000357d0: 206e 6f74 2022 0a20 2020 2020 2020 2020   not ".         
-000357e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000357f0: 2022 7472 7565 2074 6865 6e20 796f 7520   "true then you 
-00035800: 6861 7665 2070 6173 7365 6420 616e 2069  have passed an i
-00035810: 6e76 616c 6964 2070 726f 6669 6c65 2074  nvalid profile t
-00035820: 7970 652e 222e 666f 726d 6174 2873 6561  ype.".format(sea
-00035830: 7263 685f 6b65 7929 2c20 7374 6163 6b6c  rch_key), stackl
-00035840: 6576 656c 3d32 290a 0a20 2020 2020 2020  evel=2)..       
-00035850: 206d 6174 6368 6564 5f70 726f 6473 203d   matched_prods =
-00035860: 2073 656c 662e 5f67 6574 5f70 726f 665f   self._get_prof_
-00035870: 7072 6f64 2873 6561 7263 685f 6b65 792c  prod(search_key,
-00035880: 206f 6273 5f69 642c 2069 6e73 742c 2063   obs_id, inst, c
-00035890: 656e 7472 616c 5f63 6f6f 7264 2c20 7261  entral_coord, ra
-000358a0: 6469 692c 206c 6f5f 656e 2c20 6869 5f65  dii, lo_en, hi_e
-000358b0: 6e29 0a20 2020 2020 2020 2069 6620 6c65  n).        if le
-000358c0: 6e28 6d61 7463 6865 645f 7072 6f64 7329  n(matched_prods)
-000358d0: 203d 3d20 313a 0a20 2020 2020 2020 2020   == 1:.         
-000358e0: 2020 206d 6174 6368 6564 5f70 726f 6473     matched_prods
-000358f0: 203d 206d 6174 6368 6564 5f70 726f 6473   = matched_prods
-00035900: 5b30 5d0a 2020 2020 2020 2020 656c 6966  [0].        elif
-00035910: 206c 656e 286d 6174 6368 6564 5f70 726f   len(matched_pro
-00035920: 6473 2920 3d3d 2030 3a0a 2020 2020 2020  ds) == 0:.      
-00035930: 2020 2020 2020 7261 6973 6520 4e6f 5072        raise NoPr
-00035940: 6f64 7563 7441 7661 696c 6162 6c65 4572  oductAvailableEr
-00035950: 726f 7228 2243 616e 6e6f 7420 6669 6e64  ror("Cannot find
-00035960: 2061 6e79 207b 707d 2070 726f 6669 6c65   any {p} profile
-00035970: 7320 6d61 7463 6869 6e67 2079 6f75 7220  s matching your 
-00035980: 696e 7075 742e 222e 666f 726d 6174 2870  input.".format(p
-00035990: 3d70 726f 6669 6c65 5f74 7970 6529 290a  =profile_type)).
-000359a0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-000359b0: 6d61 7463 6865 645f 7072 6f64 730a 0a20  matched_prods.. 
-000359c0: 2020 2064 6566 2067 6574 5f63 6f6d 6269     def get_combi
-000359d0: 6e65 645f 7072 6f66 696c 6573 2873 656c  ned_profiles(sel
-000359e0: 662c 2070 726f 6669 6c65 5f74 7970 653a  f, profile_type:
-000359f0: 2073 7472 2c20 6365 6e74 7261 6c5f 636f   str, central_co
-00035a00: 6f72 643a 2051 7561 6e74 6974 7920 3d20  ord: Quantity = 
-00035a10: 4e6f 6e65 2c20 7261 6469 693a 2051 7561  None, radii: Qua
-00035a20: 6e74 6974 7920 3d20 4e6f 6e65 2c0a 2020  ntity = None,.  
-00035a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035a40: 2020 2020 2020 2020 2020 2020 6c6f 5f65              lo_e
-00035a50: 6e3a 2051 7561 6e74 6974 7920 3d20 4e6f  n: Quantity = No
-00035a60: 6e65 2c20 6869 5f65 6e3a 2051 7561 6e74  ne, hi_en: Quant
-00035a70: 6974 7920 3d20 4e6f 6e65 2920 5c0a 2020  ity = None) \.  
-00035a80: 2020 2020 2020 2020 2020 2d3e 2055 6e69            -> Uni
-00035a90: 6f6e 5b42 6173 6550 726f 6669 6c65 3144  on[BaseProfile1D
-00035aa0: 2c20 4c69 7374 5b42 6173 6550 726f 6669  , List[BaseProfi
-00035ab0: 6c65 3144 5d5d 3a0a 2020 2020 2020 2020  le1D]]:.        
-00035ac0: 2222 220a 2020 2020 2020 2020 5468 6520  """.        The 
-00035ad0: 6765 6e65 7269 6320 6765 7420 6d65 7468  generic get meth
-00035ae0: 6f64 2066 6f72 2058 4741 2070 726f 6669  od for XGA profi
-00035af0: 6c65 7320 6d61 6465 2075 7369 6e67 2061  les made using a
-00035b00: 6c6c 2061 7661 696c 6162 6c65 2064 6174  ll available dat
-00035b10: 6120 7768 6963 6820 6172 6520 7374 6f72  a which are stor
-00035b20: 6564 2069 6e20 7468 6973 2073 6f75 7263  ed in this sourc
-00035b30: 652e 0a20 2020 2020 2020 2059 6f75 2073  e..        You s
-00035b40: 7469 6c6c 206d 7573 7420 7265 6d65 6d62  till must rememb
-00035b50: 6572 2074 6865 2070 726f 6669 6c65 2074  er the profile t
-00035b60: 7970 6520 7661 6c75 6520 746f 2075 7365  ype value to use
-00035b70: 2069 742c 2062 7574 206f 6e63 6520 656e   it, but once en
-00035b80: 7465 7265 6420 6974 2077 696c 6c20 7265  tered it will re
-00035b90: 7475 726e 2061 206c 6973 740a 2020 2020  turn a list.    
-00035ba0: 2020 2020 6f66 2061 6c6c 206d 6174 6368      of all match
-00035bb0: 696e 6720 7072 6f66 696c 6573 2028 6f72  ing profiles (or
-00035bc0: 2061 2073 696e 676c 6520 6f62 6a65 6374   a single object
-00035bd0: 2069 6620 6f6e 6c79 206f 6e65 206d 6174   if only one mat
-00035be0: 6368 2069 7320 666f 756e 6429 2e0a 0a20  ch is found)... 
-00035bf0: 2020 2020 2020 203a 7061 7261 6d20 7374         :param st
-00035c00: 7220 7072 6f66 696c 655f 7479 7065 3a20  r profile_type: 
-00035c10: 5468 6520 7374 7269 6e67 2070 726f 6669  The string profi
-00035c20: 6c65 2074 7970 6520 6f66 2074 6865 2070  le type of the p
-00035c30: 726f 6669 6c65 2873 2920 796f 7520 7769  rofile(s) you wi
-00035c40: 7368 2074 6f20 7265 7472 6965 7665 2e0a  sh to retrieve..
-00035c50: 2020 2020 2020 2020 3a70 6172 616d 2051          :param Q
-00035c60: 7561 6e74 6974 7920 6365 6e74 7261 6c5f  uantity central_
-00035c70: 636f 6f72 643a 2054 6865 2063 656e 7472  coord: The centr
-00035c80: 616c 2063 6f6f 7264 696e 6174 6520 6f66  al coordinate of
-00035c90: 2074 6865 2070 726f 6669 6c65 2079 6f75   the profile you
-00035ca0: 2077 6973 6820 746f 2072 6574 7269 6576   wish to retriev
-00035cb0: 652c 2074 6865 2064 6566 6175 6c74 0a20  e, the default. 
-00035cc0: 2020 2020 2020 2020 2020 2069 7320 4e6f             is No
-00035cd0: 6e65 2077 6869 6368 206d 6561 6e73 2074  ne which means t
-00035ce0: 6865 206d 6574 686f 6420 7769 6c6c 2075  he method will u
-00035cf0: 7365 2074 6865 2064 6566 6175 6c74 2063  se the default c
-00035d00: 6f6f 7264 696e 6174 6520 6f66 2074 6869  oordinate of thi
-00035d10: 7320 736f 7572 6365 2e0a 2020 2020 2020  s source..      
-00035d20: 2020 3a70 6172 616d 2051 7561 6e74 6974    :param Quantit
-00035d30: 7920 7261 6469 693a 2054 6865 2063 656e  y radii: The cen
-00035d40: 7472 616c 2072 6164 6969 206f 6620 7468  tral radii of th
-00035d50: 6520 7072 6f66 696c 6520 706f 696e 7473  e profile points
-00035d60: 2c20 6974 2069 7320 6e6f 7420 6c69 6b65  , it is not like
-00035d70: 6c79 2074 6861 7420 7468 6973 206f 7074  ly that this opt
-00035d80: 696f 6e20 7769 6c6c 2062 650a 2020 2020  ion will be.    
-00035d90: 2020 2020 2020 2020 7573 6564 206f 6674          used oft
-00035da0: 656e 2061 7320 796f 7520 6c69 6b65 6c79  en as you likely
-00035db0: 2077 6f6e 2774 206b 6e6f 7720 7468 6520   won't know the 
-00035dc0: 7261 6469 616c 2076 616c 7565 7320 6120  radial values a 
-00035dd0: 7072 696f 7269 2e0a 2020 2020 2020 2020  priori..        
-00035de0: 3a70 6172 616d 2051 7561 6e74 6974 7920  :param Quantity 
-00035df0: 6c6f 5f65 6e3a 2054 6865 206c 6f77 6572  lo_en: The lower
-00035e00: 2065 6e65 7267 7920 626f 756e 6420 6f66   energy bound of
-00035e10: 2074 6865 2070 726f 6669 6c65 2079 6f75   the profile you
-00035e20: 2077 6973 6820 746f 2072 6574 7269 6576   wish to retriev
-00035e30: 6520 2869 6620 6170 706c 6963 6162 6c65  e (if applicable
-00035e40: 292c 2064 6566 6175 6c74 0a20 2020 2020  ), default.     
-00035e50: 2020 2020 2020 2069 7320 4e6f 6e65 2c20         is None, 
-00035e60: 616e 6420 6966 2074 6869 7320 6172 6775  and if this argu
-00035e70: 6d65 6e74 2069 7320 7061 7373 6564 2068  ment is passed h
-00035e80: 695f 656e 206d 7573 7420 6265 2074 6f6f  i_en must be too
-00035e90: 2e0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
-00035ea0: 2051 7561 6e74 6974 7920 6869 5f65 6e3a   Quantity hi_en:
-00035eb0: 2054 6865 2068 6967 6865 7220 656e 6572   The higher ener
-00035ec0: 6779 2062 6f75 6e64 206f 6620 7468 6520  gy bound of the 
-00035ed0: 7072 6f66 696c 6520 796f 7520 7769 7368  profile you wish
-00035ee0: 2074 6f20 7265 7472 6965 7665 2028 6966   to retrieve (if
-00035ef0: 2061 7070 6c69 6361 626c 6529 2c20 6465   applicable), de
-00035f00: 6661 756c 740a 2020 2020 2020 2020 2020  fault.          
-00035f10: 2020 6973 204e 6f6e 652c 2061 6e64 2069    is None, and i
-00035f20: 6620 7468 6973 2061 7267 756d 656e 7420  f this argument 
-00035f30: 6973 2070 6173 7365 6420 6c6f 5f65 6e20  is passed lo_en 
-00035f40: 6d75 7374 2062 6520 746f 6f2e 0a20 2020  must be too..   
-00035f50: 2020 2020 203a 7265 7475 726e 3a20 416e       :return: An
-00035f60: 2058 4741 2070 726f 6669 6c65 206f 626a   XGA profile obj
-00035f70: 6563 7420 2869 6620 7468 6572 6520 6973  ect (if there is
-00035f80: 2061 6e20 6578 6163 7420 6d61 7463 6829   an exact match)
-00035f90: 2c20 6f72 2061 206c 6973 7420 6f66 2058  , or a list of X
-00035fa0: 4741 2070 726f 6669 6c65 206f 626a 6563  GA profile objec
-00035fb0: 7473 2028 6966 2074 6865 7265 0a20 2020  ts (if there.   
-00035fc0: 2020 2020 2020 2020 2077 6572 6520 6d75           were mu
-00035fd0: 6c74 6970 6c65 206d 6174 6368 696e 6720  ltiple matching 
-00035fe0: 7072 6f64 7563 7473 292e 0a20 2020 2020  products)..     
-00035ff0: 2020 203a 7274 7970 653a 2055 6e69 6f6e     :rtype: Union
-00036000: 5b42 6173 6550 726f 6669 6c65 3144 2c20  [BaseProfile1D, 
-00036010: 4c69 7374 5b42 6173 6550 726f 6669 6c65  List[BaseProfile
-00036020: 3144 5d5d 0a20 2020 2020 2020 2022 2222  1D]].        """
-00036030: 0a20 2020 2020 2020 2069 6620 2270 726f  .        if "pro
-00036040: 6669 6c65 2220 696e 2070 726f 6669 6c65  file" in profile
-00036050: 5f74 7970 653a 0a20 2020 2020 2020 2020  _type:.         
-00036060: 2020 2077 6172 6e28 2254 6865 2070 726f     warn("The pro
-00036070: 6669 6c65 5f74 7970 6520 796f 7520 7061  file_type you pa
-00036080: 7373 6564 2063 6f6e 7461 696e 7320 7468  ssed contains th
-00036090: 6520 776f 7264 2027 7072 6f66 696c 6527  e word 'profile'
-000360a0: 2c20 7768 6963 6820 6973 2061 7070 656e  , which is appen
-000360b0: 6465 6420 6f6e 746f 2022 0a20 2020 2020  ded onto ".     
-000360c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000360d0: 2020 2020 2022 6120 7072 6f66 696c 6520       "a profile 
-000360e0: 7479 7065 2062 7920 5847 412c 2079 6f75  type by XGA, you
-000360f0: 206e 6565 6420 746f 2074 7279 2074 6869   need to try thi
-00036100: 7320 6167 6169 6e20 7769 7468 6f75 7420  s again without 
-00036110: 7072 6f66 696c 6520 6f6e 2074 6865 2065  profile on the e
-00036120: 6e64 2c20 756e 6c65 7373 220a 2020 2020  nd, unless".    
-00036130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036140: 2020 2020 2020 2220 796f 7520 6761 7665        " you gave
-00036150: 2061 2067 656e 6572 6963 2070 726f 6669   a generic profi
-00036160: 6c65 2061 2074 7970 6520 7769 7468 2027  le a type with '
-00036170: 7072 6f66 696c 6527 2069 6e2e 222c 2073  profile' in.", s
-00036180: 7461 636b 6c65 7665 6c3d 3229 0a0a 2020  tacklevel=2)..  
-00036190: 2020 2020 2020 7365 6172 6368 5f6b 6579        search_key
-000361a0: 203d 2022 636f 6d62 696e 6564 5f22 202b   = "combined_" +
-000361b0: 2070 726f 6669 6c65 5f74 7970 6520 2b20   profile_type + 
-000361c0: 225f 7072 6f66 696c 6522 0a0a 2020 2020  "_profile"..    
-000361d0: 2020 2020 6966 2073 6561 7263 685f 6b65      if search_ke
-000361e0: 7920 6e6f 7420 696e 2041 4c4c 4f57 4544  y not in ALLOWED
-000361f0: 5f50 524f 4455 4354 533a 0a20 2020 2020  _PRODUCTS:.     
-00036200: 2020 2020 2020 2077 6172 6e28 2254 6861         warn("Tha
-00036210: 7420 7072 6f66 696c 6520 7479 7065 2073  t profile type s
-00036220: 6565 6d73 2074 6f20 6265 2061 2063 7573  eems to be a cus
-00036230: 746f 6d20 7072 6f66 696c 652c 206e 6f74  tom profile, not
-00036240: 2061 6e20 5847 4120 6465 6661 756c 7420   an XGA default 
-00036250: 7479 7065 2e20 4966 2074 6869 7320 6973  type. If this is
-00036260: 206e 6f74 2022 0a20 2020 2020 2020 2020   not ".         
-00036270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036280: 2022 7472 7565 2074 6865 6e20 796f 7520   "true then you 
-00036290: 6861 7665 2070 6173 7365 6420 616e 2069  have passed an i
-000362a0: 6e76 616c 6964 2070 726f 6669 6c65 2074  nvalid profile t
-000362b0: 7970 652e 222c 2073 7461 636b 6c65 7665  ype.", stackleve
-000362c0: 6c3d 3229 0a0a 2020 2020 2020 2020 6d61  l=2)..        ma
-000362d0: 7463 6865 645f 7072 6f64 7320 3d20 7365  tched_prods = se
-000362e0: 6c66 2e5f 6765 745f 7072 6f66 5f70 726f  lf._get_prof_pro
-000362f0: 6428 7365 6172 6368 5f6b 6579 2c20 4e6f  d(search_key, No
-00036300: 6e65 2c20 4e6f 6e65 2c20 6365 6e74 7261  ne, None, centra
-00036310: 6c5f 636f 6f72 642c 2072 6164 6969 2c20  l_coord, radii, 
-00036320: 6c6f 5f65 6e2c 2068 695f 656e 290a 2020  lo_en, hi_en).  
-00036330: 2020 2020 2020 6966 206c 656e 286d 6174        if len(mat
-00036340: 6368 6564 5f70 726f 6473 2920 3d3d 2031  ched_prods) == 1
-00036350: 3a0a 2020 2020 2020 2020 2020 2020 6d61  :.            ma
-00036360: 7463 6865 645f 7072 6f64 7320 3d20 6d61  tched_prods = ma
-00036370: 7463 6865 645f 7072 6f64 735b 305d 0a20  tched_prods[0]. 
-00036380: 2020 2020 2020 2065 6c69 6620 6c65 6e28         elif len(
-00036390: 6d61 7463 6865 645f 7072 6f64 7329 203d  matched_prods) =
-000363a0: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
-000363b0: 2072 6169 7365 204e 6f50 726f 6475 6374   raise NoProduct
-000363c0: 4176 6169 6c61 626c 6545 7272 6f72 2822  AvailableError("
-000363d0: 4361 6e6e 6f74 2066 696e 6420 616e 7920  Cannot find any 
-000363e0: 636f 6d62 696e 6564 207b 707d 2070 726f  combined {p} pro
-000363f0: 6669 6c65 7320 6d61 7463 6869 6e67 2079  files matching y
-00036400: 6f75 7220 220a 2020 2020 2020 2020 2020  our ".          
-00036410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036430: 2269 6e70 7574 2e22 2e66 6f72 6d61 7428  "input.".format(
-00036440: 703d 7072 6f66 696c 655f 7479 7065 2929  p=profile_type))
-00036450: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-00036460: 206d 6174 6368 6564 5f70 726f 6473 0a0a   matched_prods..
-00036470: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
-00036480: 2020 6465 6620 6669 7474 6564 5f6d 6f64    def fitted_mod
-00036490: 656c 7328 7365 6c66 2920 2d3e 204c 6973  els(self) -> Lis
-000364a0: 745b 7374 725d 3a0a 2020 2020 2020 2020  t[str]:.        
-000364b0: 2222 220a 2020 2020 2020 2020 5468 6973  """.        This
-000364c0: 2070 726f 7065 7274 7920 6379 636c 6573   property cycles
-000364d0: 2074 6872 6f75 6768 2061 6c6c 2074 6865   through all the
-000364e0: 2061 7661 696c 6162 6c65 2066 6974 2072   available fit r
-000364f0: 6573 756c 7473 2c20 616e 6420 6669 6e64  esults, and find
-00036500: 7320 7468 6520 756e 6971 7565 206e 616d  s the unique nam
-00036510: 6573 206f 6620 5853 5045 4320 6d6f 6465  es of XSPEC mode
-00036520: 6c73 0a20 2020 2020 2020 2074 6861 7420  ls.        that 
-00036530: 6861 7665 2062 6565 6e20 6669 7474 6564  have been fitted
-00036540: 2074 6f20 7468 6973 2073 6f75 7263 652e   to this source.
-00036550: 0a0a 2020 2020 2020 2020 3a72 6574 7572  ..        :retur
-00036560: 6e3a 2041 206c 6973 7420 6f66 206d 6f64  n: A list of mod
-00036570: 656c 206e 616d 6573 2e0a 2020 2020 2020  el names..      
-00036580: 2020 3a72 7479 7065 3a20 4c69 7374 5b73    :rtype: List[s
-00036590: 7472 5d0a 2020 2020 2020 2020 2222 220a  tr].        """.
-000365a0: 2020 2020 2020 2020 6d6f 6465 6c73 203d          models =
-000365b0: 205b 5d0a 2020 2020 2020 2020 666f 7220   [].        for 
-000365c0: 735f 6b65 7920 696e 2073 656c 662e 5f66  s_key in self._f
-000365d0: 6974 5f72 6573 756c 7473 3a0a 2020 2020  it_results:.    
-000365e0: 2020 2020 2020 2020 6d6f 6465 6c73 202b          models +
-000365f0: 3d20 6c69 7374 2873 656c 662e 5f66 6974  = list(self._fit
-00036600: 5f72 6573 756c 7473 5b73 5f6b 6579 5d2e  _results[s_key].
-00036610: 6b65 7973 2829 290a 0a20 2020 2020 2020  keys())..       
-00036620: 2072 6574 7572 6e20 6d6f 6465 6c73 0a0a   return models..
-00036630: 2020 2020 6465 6620 736e 725f 7261 6e6b      def snr_rank
-00036640: 696e 6728 7365 6c66 2c20 6f75 7465 725f  ing(self, outer_
-00036650: 7261 6469 7573 3a20 556e 696f 6e5b 5175  radius: Union[Qu
-00036660: 616e 7469 7479 2c20 7374 725d 2c20 6c6f  antity, str], lo
-00036670: 5f65 6e3a 2051 7561 6e74 6974 7920 3d20  _en: Quantity = 
-00036680: 4e6f 6e65 2c20 6869 5f65 6e3a 2051 7561  None, hi_en: Qua
-00036690: 6e74 6974 7920 3d20 4e6f 6e65 2c0a 2020  ntity = None,.  
-000366a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000366b0: 2020 616c 6c6f 775f 6e65 6761 7469 7665    allow_negative
-000366c0: 3a20 626f 6f6c 203d 2046 616c 7365 2920  : bool = False) 
-000366d0: 2d3e 2054 7570 6c65 5b6e 702e 6e64 6172  -> Tuple[np.ndar
-000366e0: 7261 792c 206e 702e 6e64 6172 7261 795d  ray, np.ndarray]
-000366f0: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-00036700: 2020 2020 2020 5468 6973 206d 6574 686f        This metho
-00036710: 6420 6765 6e65 7261 7465 7320 6120 6c69  d generates a li
-00036720: 7374 206f 6620 4f62 7349 442d 496e 7374  st of ObsID-Inst
-00036730: 7275 6d65 6e74 2070 6169 7273 2c20 6f72  rument pairs, or
-00036740: 6465 7265 6420 6279 2074 6865 2073 6967  dered by the sig
-00036750: 6e61 6c20 746f 206e 6f69 7365 206d 6561  nal to noise mea
-00036760: 7375 7265 6420 666f 7220 7468 650a 2020  sured for the.  
-00036770: 2020 2020 2020 6769 7665 6e20 7265 6769        given regi
-00036780: 6f6e 2c20 7769 7468 2065 6c65 6d65 6e74  on, with element
-00036790: 207a 6572 6f20 6265 696e 6720 7468 6520   zero being the 
-000367a0: 6c6f 7765 7374 2053 4e52 2c20 616e 6420  lowest SNR, and 
-000367b0: 656c 656d 656e 7420 4e20 6265 696e 6720  element N being 
-000367c0: 7468 6520 6869 6768 6573 742e 0a0a 2020  the highest...  
-000367d0: 2020 2020 2020 3a70 6172 616d 2051 7561        :param Qua
-000367e0: 6e74 6974 792f 7374 7220 6f75 7465 725f  ntity/str outer_
-000367f0: 7261 6469 7573 3a20 5468 6520 7261 6469  radius: The radi
-00036800: 7573 2074 6861 7420 534e 5220 7368 6f75  us that SNR shou
-00036810: 6c64 2062 6520 6361 6c63 756c 6174 6564  ld be calculated
-00036820: 2077 6974 6869 6e2c 2074 6869 7320 6361   within, this ca
-00036830: 6e20 6569 7468 6572 2062 6520 610a 2020  n either be a.  
-00036840: 2020 2020 2020 2020 2020 6e61 6d65 6420            named 
-00036850: 7261 6469 7573 2073 7563 6820 6173 2072  radius such as r
-00036860: 3530 302c 206f 7220 616e 2061 7374 726f  500, or an astro
-00036870: 7079 2051 7561 6e74 6974 792e 0a20 2020  py Quantity..   
-00036880: 2020 2020 203a 7061 7261 6d20 5175 616e       :param Quan
-00036890: 7469 7479 206c 6f5f 656e 3a20 5468 6520  tity lo_en: The 
-000368a0: 6c6f 7765 7220 656e 6572 6779 2062 6f75  lower energy bou
-000368b0: 6e64 206f 6620 7468 6520 7261 7465 6d61  nd of the ratema
-000368c0: 7020 746f 2075 7365 2074 6f20 6361 6c63  p to use to calc
-000368d0: 756c 6174 6520 7468 6520 534e 522e 2044  ulate the SNR. D
-000368e0: 6566 6175 6c74 2069 7320 4e6f 6e65 2c0a  efault is None,.
-000368f0: 2020 2020 2020 2020 2020 2020 696e 2077              in w
-00036900: 6869 6368 2063 6173 6520 7468 6520 6c6f  hich case the lo
-00036910: 7765 7220 656e 6572 6779 2062 6f75 6e64  wer energy bound
-00036920: 2066 6f72 2070 6561 6b20 6669 6e64 696e   for peak findin
-00036930: 6720 7769 6c6c 2062 6520 7573 6564 2028  g will be used (
-00036940: 6465 6661 756c 7420 6973 2030 2e35 6b65  default is 0.5ke
-00036950: 5629 2e0a 2020 2020 2020 2020 3a70 6172  V)..        :par
-00036960: 616d 2051 7561 6e74 6974 7920 6869 5f65  am Quantity hi_e
-00036970: 6e3a 2054 6865 2075 7070 6572 2065 6e65  n: The upper ene
-00036980: 7267 7920 626f 756e 6420 6f66 2074 6865  rgy bound of the
-00036990: 2072 6174 656d 6170 2074 6f20 7573 6520   ratemap to use 
-000369a0: 746f 2063 616c 6375 6c61 7465 2074 6865  to calculate the
-000369b0: 2053 4e52 2e20 4465 6661 756c 7420 6973   SNR. Default is
-000369c0: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
-000369d0: 2020 2069 6e20 7768 6963 6820 6361 7365     in which case
-000369e0: 2074 6865 2075 7070 6572 2065 6e65 7267   the upper energ
-000369f0: 7920 626f 756e 6420 666f 7220 7065 616b  y bound for peak
-00036a00: 2066 696e 6469 6e67 2077 696c 6c20 6265   finding will be
-00036a10: 2075 7365 6420 2864 6566 6175 6c74 2069   used (default i
-00036a20: 7320 322e 306b 6556 292e 0a20 2020 2020  s 2.0keV)..     
-00036a30: 2020 203a 7061 7261 6d20 626f 6f6c 2061     :param bool a
-00036a40: 6c6c 6f77 5f6e 6567 6174 6976 653a 2053  llow_negative: S
-00036a50: 686f 756c 6420 7069 7865 6c73 2069 6e20  hould pixels in 
-00036a60: 7468 6520 6261 636b 6772 6f75 6e64 2073  the background s
-00036a70: 7562 7472 6163 7465 6420 636f 756e 7420  ubtracted count 
-00036a80: 6d61 7020 6265 2061 6c6c 6f77 6564 2074  map be allowed t
-00036a90: 6f20 676f 2062 656c 6f77 0a20 2020 2020  o go below.     
-00036aa0: 2020 2020 2020 207a 6572 6f2c 2077 6869         zero, whi
-00036ab0: 6368 2072 6573 756c 7473 2069 6e20 6120  ch results in a 
-00036ac0: 6c6f 7765 7220 7369 676e 616c 2074 6f20  lower signal to 
-00036ad0: 6e6f 6973 6520 2861 6e64 2063 616e 2072  noise (and can r
-00036ae0: 6573 756c 7420 696e 2061 206e 6567 6174  esult in a negat
-00036af0: 6976 6520 7369 676e 616c 2074 6f20 6e6f  ive signal to no
-00036b00: 6973 6529 2e0a 2020 2020 2020 2020 3a72  ise)..        :r
-00036b10: 6574 7572 6e3a 2054 776f 2061 7272 6179  eturn: Two array
-00036b20: 732c 2074 6865 2066 6972 7374 2061 6e20  s, the first an 
-00036b30: 4e20 6279 2032 2061 7272 6179 2c20 7769  N by 2 array, wi
-00036b40: 7468 2074 6865 204f 6273 4944 2c20 496e  th the ObsID, In
-00036b50: 7374 7275 6d65 6e74 2063 6f6d 6269 6e61  strument combina
-00036b60: 7469 6f6e 7320 696e 206f 7264 6572 0a20  tions in order. 
-00036b70: 2020 2020 2020 2020 2020 206f 6620 6173             of as
-00036b80: 6365 6e64 696e 6720 7369 676e 616c 2074  cending signal t
-00036b90: 6f20 6e6f 6973 652c 2074 6865 6e20 616e  o noise, then an
-00036ba0: 2061 7272 6179 2063 6f6e 7461 696e 696e   array containin
-00036bb0: 6720 7468 6520 6f72 6465 7220 534e 5220  g the order SNR 
-00036bc0: 7261 7469 6f73 2e0a 2020 2020 2020 2020  ratios..        
-00036bd0: 3a72 7479 7065 3a20 5475 706c 655b 6e70  :rtype: Tuple[np
-00036be0: 2e6e 6461 7272 6179 2c20 6e70 2e6e 6461  .ndarray, np.nda
-00036bf0: 7272 6179 5d0a 2020 2020 2020 2020 2222  rray].        ""
-00036c00: 220a 2020 2020 2020 2020 2320 5365 7420  ".        # Set 
-00036c10: 7570 2073 6f6d 6520 6c69 7374 7320 666f  up some lists fo
-00036c20: 7220 7468 6520 4f62 7349 442d 496e 7374  r the ObsID-Inst
-00036c30: 7275 6d65 6e74 2063 6f6d 626f 7320 616e  rument combos an
-00036c40: 6420 7468 6569 7220 534e 5273 2072 6573  d their SNRs res
-00036c50: 7065 6374 6976 656c 790a 2020 2020 2020  pectively.      
-00036c60: 2020 6f62 735f 696e 7374 203d 205b 5d0a    obs_inst = [].
-00036c70: 2020 2020 2020 2020 736e 7273 203d 205b          snrs = [
-00036c80: 5d0a 2020 2020 2020 2020 2320 5765 206c  ].        # We l
-00036c90: 6f6f 7020 7468 726f 7567 6820 7468 6520  oop through the 
-00036ca0: 4f62 7349 4473 2061 7373 6f63 6961 7465  ObsIDs associate
-00036cb0: 6420 7769 7468 2074 6869 7320 736f 7572  d with this sour
-00036cc0: 6365 2061 6e64 2074 6865 2069 6e73 7472  ce and the instr
-00036cd0: 756d 656e 7473 2061 7373 6f63 6961 7465  uments associate
-00036ce0: 6420 7769 7468 2074 686f 7365 204f 6273  d with those Obs
-00036cf0: 4944 730a 2020 2020 2020 2020 666f 7220  IDs.        for 
-00036d00: 6f62 735f 6964 2069 6e20 7365 6c66 2e69  obs_id in self.i
-00036d10: 6e73 7472 756d 656e 7473 3a0a 2020 2020  nstruments:.    
-00036d20: 2020 2020 2020 2020 666f 7220 696e 7374          for inst
-00036d30: 2069 6e20 7365 6c66 2e69 6e73 7472 756d   in self.instrum
-00036d40: 656e 7473 5b6f 6273 5f69 645d 3a0a 2020  ents[obs_id]:.  
-00036d50: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00036d60: 5573 6520 6f75 7220 6861 6e64 7920 6765  Use our handy ge
-00036d70: 745f 736e 7220 6d65 7468 6f64 2074 6f20  t_snr method to 
-00036d80: 6361 6c63 756c 6174 6520 7468 6520 534e  calculate the SN
-00036d90: 5273 2077 6520 7761 6e74 2c20 7468 656e  Rs we want, then
-00036da0: 2061 6464 2074 6861 7420 616e 6420 7468   add that and th
-00036db0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00036dc0: 2020 2320 204f 6273 4944 2d69 6e73 7420    #  ObsID-inst 
-00036dd0: 636f 6d62 6f20 696e 746f 2074 6865 6972  combo into their
-00036de0: 2072 6573 7065 6374 6976 6520 6c69 7374   respective list
-00036df0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-00036e00: 2020 736e 7273 2e61 7070 656e 6428 7365    snrs.append(se
-00036e10: 6c66 2e67 6574 5f73 6e72 286f 7574 6572  lf.get_snr(outer
-00036e20: 5f72 6164 6975 732c 2073 656c 662e 6465  _radius, self.de
-00036e30: 6661 756c 745f 636f 6f72 642c 206c 6f5f  fault_coord, lo_
-00036e40: 656e 2c20 6869 5f65 6e2c 206f 6273 5f69  en, hi_en, obs_i
-00036e50: 642c 2069 6e73 742c 0a20 2020 2020 2020  d, inst,.       
-00036e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036e80: 2020 616c 6c6f 775f 6e65 6761 7469 7665    allow_negative
-00036e90: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-00036ea0: 2020 206f 6273 5f69 6e73 742e 6170 7065     obs_inst.appe
-00036eb0: 6e64 285b 6f62 735f 6964 2c20 696e 7374  nd([obs_id, inst
-00036ec0: 5d29 0a0a 2020 2020 2020 2020 2320 4d61  ])..        # Ma
-00036ed0: 6b65 206f 7572 2073 746f 7261 6765 206c  ke our storage l
-00036ee0: 6973 7473 2069 6e74 6f20 6172 7261 7973  ists into arrays
-00036ef0: 2c20 6561 7369 6572 2074 6f20 776f 726b  , easier to work
-00036f00: 2077 6974 6820 7468 6174 2077 6179 0a20   with that way. 
-00036f10: 2020 2020 2020 206f 6273 5f69 6e73 7420         obs_inst 
-00036f20: 3d20 6e70 2e61 7272 6179 286f 6273 5f69  = np.array(obs_i
-00036f30: 6e73 7429 0a20 2020 2020 2020 2073 6e72  nst).        snr
-00036f40: 7320 3d20 6e70 2e61 7272 6179 2873 6e72  s = np.array(snr
-00036f50: 7329 0a0a 2020 2020 2020 2020 2320 5765  s)..        # We
-00036f60: 2077 616e 7420 746f 206f 7264 6572 2074   want to order t
-00036f70: 6865 206f 7574 7075 7420 6279 2053 4e52  he output by SNR
-00036f80: 2c20 7769 7468 2074 6865 206c 6f77 6573  , with the lowes
-00036f90: 7420 6265 696e 6720 6669 7273 7420 616e  t being first an
-00036fa0: 6420 7468 6520 6869 6768 6573 7420 6265  d the highest be
-00036fb0: 696e 6720 6c61 7374 2c20 736f 2077 650a  ing last, so we.
-00036fc0: 2020 2020 2020 2020 2320 2075 7365 2061          #  use a
-00036fd0: 206e 756d 7079 2066 756e 6374 696f 6e20   numpy function 
-00036fe0: 746f 206f 7574 7075 7420 7468 6520 696e  to output the in
-00036ff0: 6465 7820 6f72 6465 7220 6e65 6564 6564  dex order needed
-00037000: 2074 6f20 7265 2d6f 7264 6572 206f 7572   to re-order our
-00037010: 2074 776f 2061 7272 6179 730a 2020 2020   two arrays.    
-00037020: 2020 2020 7265 6f72 6465 725f 736e 7273      reorder_snrs
-00037030: 203d 206e 702e 6172 6773 6f72 7428 736e   = np.argsort(sn
-00037040: 7273 290a 2020 2020 2020 2020 2320 5468  rs).        # Th
-00037050: 656e 2077 6520 7573 6520 7468 6174 2074  en we use that t
-00037060: 6f20 7265 2d6f 7264 6572 2074 6865 6d0a  o re-order them.
-00037070: 2020 2020 2020 2020 736e 7273 203d 2073          snrs = s
-00037080: 6e72 735b 7265 6f72 6465 725f 736e 7273  nrs[reorder_snrs
-00037090: 5d0a 2020 2020 2020 2020 6f62 735f 696e  ].        obs_in
-000370a0: 7374 203d 206f 6273 5f69 6e73 745b 7265  st = obs_inst[re
-000370b0: 6f72 6465 725f 736e 7273 5d0a 0a20 2020  order_snrs]..   
-000370c0: 2020 2020 2023 2041 6e64 2072 6574 7572       # And retur
-000370d0: 6e20 6f75 7220 6f72 6465 7265 6420 6469  n our ordered di
-000370e0: 6374 696f 6e61 7269 6573 0a20 2020 2020  ctionaries.     
-000370f0: 2020 2072 6574 7572 6e20 6f62 735f 696e     return obs_in
-00037100: 7374 2c20 736e 7273 0a0a 2020 2020 6465  st, snrs..    de
-00037110: 6620 636f 756e 745f 7261 6e6b 696e 6728  f count_ranking(
-00037120: 7365 6c66 2c20 6f75 7465 725f 7261 6469  self, outer_radi
-00037130: 7573 3a20 556e 696f 6e5b 5175 616e 7469  us: Union[Quanti
-00037140: 7479 2c20 7374 725d 2c20 6c6f 5f65 6e3a  ty, str], lo_en:
-00037150: 2051 7561 6e74 6974 7920 3d20 4e6f 6e65   Quantity = None
-00037160: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00037170: 2020 2020 2020 2020 6869 5f65 6e3a 2051          hi_en: Q
-00037180: 7561 6e74 6974 7920 3d20 4e6f 6e65 2920  uantity = None) 
-00037190: 2d3e 2054 7570 6c65 5b6e 702e 6e64 6172  -> Tuple[np.ndar
-000371a0: 7261 792c 2051 7561 6e74 6974 795d 3a0a  ray, Quantity]:.
-000371b0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-000371c0: 2020 2020 5468 6973 206d 6574 686f 6420      This method 
-000371d0: 6765 6e65 7261 7465 7320 6120 6c69 7374  generates a list
-000371e0: 206f 6620 4f62 7349 442d 496e 7374 7275   of ObsID-Instru
-000371f0: 6d65 6e74 2070 6169 7273 2c20 6f72 6465  ment pairs, orde
-00037200: 7265 6420 6279 2074 6865 2063 6f75 6e74  red by the count
-00037210: 7320 6d65 6173 7572 6564 2066 6f72 2074  s measured for t
-00037220: 6865 0a20 2020 2020 2020 2067 6976 656e  he.        given
-00037230: 2072 6567 696f 6e2c 2077 6974 6820 656c   region, with el
-00037240: 656d 656e 7420 7a65 726f 2062 6569 6e67  ement zero being
-00037250: 2074 6865 206c 6f77 6573 7420 636f 756e   the lowest coun
-00037260: 7473 2c20 616e 6420 656c 656d 656e 7420  ts, and element 
-00037270: 4e20 6265 696e 6720 7468 6520 6869 6768  N being the high
-00037280: 6573 742e 0a0a 2020 2020 2020 2020 3a70  est...        :p
-00037290: 6172 616d 2051 7561 6e74 6974 792f 7374  aram Quantity/st
-000372a0: 7220 6f75 7465 725f 7261 6469 7573 3a20  r outer_radius: 
-000372b0: 5468 6520 7261 6469 7573 2074 6861 7420  The radius that 
-000372c0: 636f 756e 7473 2073 686f 756c 6420 6265  counts should be
-000372d0: 2063 616c 6375 6c61 7465 6420 7769 7468   calculated with
-000372e0: 696e 2c20 7468 6973 2063 616e 2065 6974  in, this can eit
-000372f0: 6865 7220 6265 2061 0a20 2020 2020 2020  her be a.       
-00037300: 2020 2020 206e 616d 6564 2072 6164 6975       named radiu
-00037310: 7320 7375 6368 2061 7320 7235 3030 2c20  s such as r500, 
-00037320: 6f72 2061 6e20 6173 7472 6f70 7920 5175  or an astropy Qu
-00037330: 616e 7469 7479 2e0a 2020 2020 2020 2020  antity..        
-00037340: 3a70 6172 616d 2051 7561 6e74 6974 7920  :param Quantity 
-00037350: 6c6f 5f65 6e3a 2054 6865 206c 6f77 6572  lo_en: The lower
-00037360: 2065 6e65 7267 7920 626f 756e 6420 6f66   energy bound of
-00037370: 2074 6865 2072 6174 656d 6170 2074 6f20   the ratemap to 
-00037380: 7573 6520 746f 2063 616c 6375 6c61 7465  use to calculate
-00037390: 2074 6865 2063 6f75 6e74 732e 2044 6566   the counts. Def
-000373a0: 6175 6c74 2069 7320 4e6f 6e65 2c0a 2020  ault is None,.  
-000373b0: 2020 2020 2020 2020 2020 696e 2077 6869            in whi
-000373c0: 6368 2063 6173 6520 7468 6520 6c6f 7765  ch case the lowe
-000373d0: 7220 656e 6572 6779 2062 6f75 6e64 2066  r energy bound f
-000373e0: 6f72 2070 6561 6b20 6669 6e64 696e 6720  or peak finding 
-000373f0: 7769 6c6c 2062 6520 7573 6564 2028 6465  will be used (de
-00037400: 6661 756c 7420 6973 2030 2e35 6b65 5629  fault is 0.5keV)
-00037410: 2e0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
-00037420: 2051 7561 6e74 6974 7920 6869 5f65 6e3a   Quantity hi_en:
-00037430: 2054 6865 2075 7070 6572 2065 6e65 7267   The upper energ
-00037440: 7920 626f 756e 6420 6f66 2074 6865 2072  y bound of the r
-00037450: 6174 656d 6170 2074 6f20 7573 6520 746f  atemap to use to
-00037460: 2063 616c 6375 6c61 7465 2074 6865 2063   calculate the c
-00037470: 6f75 6e74 732e 2044 6566 6175 6c74 2069  ounts. Default i
-00037480: 7320 4e6f 6e65 2c0a 2020 2020 2020 2020  s None,.        
-00037490: 2020 2020 696e 2077 6869 6368 2063 6173      in which cas
-000374a0: 6520 7468 6520 7570 7065 7220 656e 6572  e the upper ener
-000374b0: 6779 2062 6f75 6e64 2066 6f72 2070 6561  gy bound for pea
-000374c0: 6b20 6669 6e64 696e 6720 7769 6c6c 2062  k finding will b
-000374d0: 6520 7573 6564 2028 6465 6661 756c 7420  e used (default 
-000374e0: 6973 2032 2e30 6b65 5629 2e0a 2020 2020  is 2.0keV)..    
-000374f0: 2020 2020 3a72 6574 7572 6e3a 2054 776f      :return: Two
-00037500: 2061 7272 6179 732c 2074 6865 2066 6972   arrays, the fir
-00037510: 7374 2061 6e20 4e20 6279 2032 2061 7272  st an N by 2 arr
-00037520: 6179 2c20 7769 7468 2074 6865 204f 6273  ay, with the Obs
-00037530: 4944 2c20 496e 7374 7275 6d65 6e74 2063  ID, Instrument c
-00037540: 6f6d 6269 6e61 7469 6f6e 7320 696e 206f  ombinations in o
-00037550: 7264 6572 0a20 2020 2020 2020 2020 2020  rder.           
-00037560: 206f 6620 6173 6365 6e64 696e 6720 636f   of ascending co
-00037570: 756e 7473 2c20 7468 656e 2061 6e20 6172  unts, then an ar
-00037580: 7261 7920 636f 6e74 6169 6e69 6e67 2074  ray containing t
-00037590: 6865 206f 7264 6572 2063 6f75 6e74 7320  he order counts 
-000375a0: 7261 7469 6f73 2e0a 2020 2020 2020 2020  ratios..        
-000375b0: 3a72 7479 7065 3a20 5475 706c 655b 6e70  :rtype: Tuple[np
-000375c0: 2e6e 6461 7272 6179 2c20 5175 616e 7469  .ndarray, Quanti
-000375d0: 7479 5d0a 2020 2020 2020 2020 2222 220a  ty].        """.
-000375e0: 2020 2020 2020 2020 2320 5365 7420 7570          # Set up
-000375f0: 2073 6f6d 6520 6c69 7374 7320 666f 7220   some lists for 
-00037600: 7468 6520 4f62 7349 442d 496e 7374 7275  the ObsID-Instru
-00037610: 6d65 6e74 2063 6f6d 626f 7320 616e 6420  ment combos and 
-00037620: 7468 6569 7220 636e 7473 2072 6573 7065  their cnts respe
-00037630: 6374 6976 656c 790a 2020 2020 2020 2020  ctively.        
-00037640: 6f62 735f 696e 7374 203d 205b 5d0a 2020  obs_inst = [].  
-00037650: 2020 2020 2020 636e 7473 203d 205b 5d0a        cnts = [].
-00037660: 2020 2020 2020 2020 2320 5765 206c 6f6f          # We loo
-00037670: 7020 7468 726f 7567 6820 7468 6520 4f62  p through the Ob
-00037680: 7349 4473 2061 7373 6f63 6961 7465 6420  sIDs associated 
-00037690: 7769 7468 2074 6869 7320 736f 7572 6365  with this source
-000376a0: 2061 6e64 2074 6865 2069 6e73 7472 756d   and the instrum
-000376b0: 656e 7473 2061 7373 6f63 6961 7465 6420  ents associated 
-000376c0: 7769 7468 2074 686f 7365 204f 6273 4944  with those ObsID
-000376d0: 730a 2020 2020 2020 2020 666f 7220 6f62  s.        for ob
-000376e0: 735f 6964 2069 6e20 7365 6c66 2e69 6e73  s_id in self.ins
-000376f0: 7472 756d 656e 7473 3a0a 2020 2020 2020  truments:.      
-00037700: 2020 2020 2020 666f 7220 696e 7374 2069        for inst i
-00037710: 6e20 7365 6c66 2e69 6e73 7472 756d 656e  n self.instrumen
-00037720: 7473 5b6f 6273 5f69 645d 3a0a 2020 2020  ts[obs_id]:.    
-00037730: 2020 2020 2020 2020 2020 2020 636e 7473              cnts
-00037740: 2e61 7070 656e 6428 7365 6c66 2e67 6574  .append(self.get
-00037750: 5f63 6f75 6e74 7328 6f75 7465 725f 7261  _counts(outer_ra
-00037760: 6469 7573 2c20 7365 6c66 2e64 6566 6175  dius, self.defau
-00037770: 6c74 5f63 6f6f 7264 2c20 6c6f 5f65 6e2c  lt_coord, lo_en,
-00037780: 2068 695f 656e 2c20 6f62 735f 6964 2c20   hi_en, obs_id, 
-00037790: 696e 7374 2929 0a20 2020 2020 2020 2020  inst)).         
-000377a0: 2020 2020 2020 206f 6273 5f69 6e73 742e         obs_inst.
-000377b0: 6170 7065 6e64 285b 6f62 735f 6964 2c20  append([obs_id, 
-000377c0: 696e 7374 5d29 0a0a 2020 2020 2020 2020  inst])..        
-000377d0: 2320 4d61 6b65 206f 7572 2073 746f 7261  # Make our stora
-000377e0: 6765 206c 6973 7473 2069 6e74 6f20 6172  ge lists into ar
-000377f0: 7261 7973 2c20 6561 7369 6572 2074 6f20  rays, easier to 
-00037800: 776f 726b 2077 6974 6820 7468 6174 2077  work with that w
-00037810: 6179 0a20 2020 2020 2020 206f 6273 5f69  ay.        obs_i
-00037820: 6e73 7420 3d20 6e70 2e61 7272 6179 286f  nst = np.array(o
-00037830: 6273 5f69 6e73 7429 0a20 2020 2020 2020  bs_inst).       
-00037840: 2063 6e74 7320 3d20 5175 616e 7469 7479   cnts = Quantity
-00037850: 2863 6e74 7329 0a0a 2020 2020 2020 2020  (cnts)..        
-00037860: 2320 5765 2077 616e 7420 746f 206f 7264  # We want to ord
-00037870: 6572 2074 6865 206f 7574 7075 7420 6279  er the output by
-00037880: 2063 6f75 6e74 732c 2077 6974 6820 7468   counts, with th
-00037890: 6520 6c6f 7765 7374 2062 6569 6e67 2066  e lowest being f
-000378a0: 6972 7374 2061 6e64 2074 6865 2068 6967  irst and the hig
-000378b0: 6865 7374 2062 6569 6e67 206c 6173 742c  hest being last,
-000378c0: 2073 6f20 7765 0a20 2020 2020 2020 2023   so we.        #
-000378d0: 2020 7573 6520 6120 6e75 6d70 7920 6675    use a numpy fu
-000378e0: 6e63 7469 6f6e 2074 6f20 6f75 7470 7574  nction to output
-000378f0: 2074 6865 2069 6e64 6578 206f 7264 6572   the index order
-00037900: 206e 6565 6465 6420 746f 2072 652d 6f72   needed to re-or
-00037910: 6465 7220 6f75 7220 7477 6f20 6172 7261  der our two arra
-00037920: 7973 0a20 2020 2020 2020 2072 656f 7264  ys.        reord
-00037930: 6572 5f63 6e74 7320 3d20 6e70 2e61 7267  er_cnts = np.arg
-00037940: 736f 7274 2863 6e74 7329 0a20 2020 2020  sort(cnts).     
-00037950: 2020 2023 2054 6865 6e20 7765 2075 7365     # Then we use
-00037960: 2074 6861 7420 746f 2072 652d 6f72 6465   that to re-orde
-00037970: 7220 7468 656d 0a20 2020 2020 2020 2063  r them.        c
-00037980: 6e74 7320 3d20 636e 7473 5b72 656f 7264  nts = cnts[reord
-00037990: 6572 5f63 6e74 735d 0a20 2020 2020 2020  er_cnts].       
-000379a0: 206f 6273 5f69 6e73 7420 3d20 6f62 735f   obs_inst = obs_
-000379b0: 696e 7374 5b72 656f 7264 6572 5f63 6e74  inst[reorder_cnt
-000379c0: 735d 0a0a 2020 2020 2020 2020 2320 416e  s]..        # An
-000379d0: 6420 7265 7475 726e 206f 7572 206f 7264  d return our ord
-000379e0: 6572 6564 2064 6963 7469 6f6e 6172 6965  ered dictionarie
-000379f0: 7327 0a20 2020 2020 2020 2072 6574 7572  s'.        retur
-00037a00: 6e20 6f62 735f 696e 7374 2c20 636e 7473  n obs_inst, cnts
-00037a10: 0a0a 2020 2020 6465 6620 6f66 6673 6574  ..    def offset
-00037a20: 2873 656c 662c 206f 6666 5f75 6e69 743a  (self, off_unit:
-00037a30: 2055 6e69 6f6e 5b55 6e69 742c 2073 7472   Union[Unit, str
-00037a40: 5d20 3d20 2261 7263 6d69 6e22 2920 2d3e  ] = "arcmin") ->
-00037a50: 2051 7561 6e74 6974 793a 0a20 2020 2020   Quantity:.     
-00037a60: 2020 2022 2222 0a20 2020 2020 2020 2054     """.        T
-00037a70: 6869 7320 6d65 7468 6f64 2063 616c 6375  his method calcu
-00037a80: 6c61 7465 7320 7468 6520 7365 7061 7261  lates the separa
-00037a90: 7469 6f6e 2062 6574 7765 656e 2074 6865  tion between the
-00037aa0: 2075 7365 7220 7375 7070 6c69 6564 2072   user supplied r
-00037ab0: 615f 6465 6320 636f 6f72 6469 6e61 7465  a_dec coordinate
-00037ac0: 732c 2061 6e64 2074 6865 2070 6561 6b0a  s, and the peak.
-00037ad0: 2020 2020 2020 2020 636f 6f72 6469 6e61          coordina
-00037ae0: 7465 7320 696e 2074 6865 2072 6571 7565  tes in the reque
-00037af0: 7374 6564 206f 6666 5f75 6e69 742e 2049  sted off_unit. I
-00037b00: 6620 7468 6572 6520 6973 206e 6f20 7065  f there is no pe
-00037b10: 616b 2061 7474 7269 6275 7465 2061 6e64  ak attribute and
-00037b20: 2065 7272 6f72 2077 696c 6c20 6265 2074   error will be t
-00037b30: 6872 6f77 6e2c 2061 6e64 2069 6620 6e6f  hrown, and if no
-00037b40: 0a20 2020 2020 2020 2070 6561 6b20 6861  .        peak ha
-00037b50: 7320 6265 656e 2063 616c 6375 6c61 7465  s been calculate
-00037b60: 6420 7468 656e 2074 6865 2072 6573 756c  d then the resul
-00037b70: 7420 7769 6c6c 2062 6520 302e 0a0a 2020  t will be 0...  
-00037b80: 2020 2020 2020 3a70 6172 616d 2055 6e69        :param Uni
-00037b90: 742f 7374 7220 6f66 665f 756e 6974 3a20  t/str off_unit: 
-00037ba0: 5468 6520 756e 6974 2074 6861 7420 7468  The unit that th
-00037bb0: 6520 6f66 6673 6574 2073 686f 756c 6420  e offset should 
-00037bc0: 6265 2069 6e2e 0a20 2020 2020 2020 203a  be in..        :
-00037bd0: 7265 7475 726e 3a20 5468 6520 6f66 6673  return: The offs
-00037be0: 6574 2062 6574 7765 656e 2072 615f 6465  et between ra_de
-00037bf0: 6320 616e 6420 7065 616b 2c20 696e 2074  c and peak, in t
-00037c00: 6865 2072 6571 7565 7374 6564 2075 6e69  he requested uni
-00037c10: 742e 0a20 2020 2020 2020 203a 7274 7970  t..        :rtyp
-00037c20: 653a 2051 7561 6e74 6974 790a 2020 2020  e: Quantity.    
-00037c30: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00037c40: 2320 4368 6563 6b20 7468 6174 2074 6865  # Check that the
-00037c50: 2073 6f75 7263 6520 6861 7320 6120 7065   source has a pe
-00037c60: 616b 2061 7474 7269 6275 7465 2074 6f20  ak attribute to 
-00037c70: 6665 7463 682c 206f 7468 6572 7769 7365  fetch, otherwise
-00037c80: 2074 6872 6f77 2065 7272 6f72 0a20 2020   throw error.   
-00037c90: 2020 2020 2069 6620 6e6f 7420 6861 7361       if not hasa
-00037ca0: 7474 7228 7365 6c66 2c20 2770 6561 6b27  ttr(self, 'peak'
-00037cb0: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-00037cc0: 6169 7365 2041 7474 7269 6275 7465 4572  aise AttributeEr
-00037cd0: 726f 7228 2254 6869 7320 736f 7572 6365  ror("This source
-00037ce0: 2064 6f65 7320 6e6f 7420 6861 7665 2061   does not have a
-00037cf0: 2070 6561 6b20 6174 7472 6962 7574 652c   peak attribute,
-00037d00: 2061 6e64 2073 6f20 616e 206f 6666 7365   and so an offse
-00037d10: 7420 6361 6e6e 6f74 2062 6520 6361 6c63  t cannot be calc
-00037d20: 756c 6174 6564 2e22 290a 0a20 2020 2020  ulated.")..     
-00037d30: 2020 2023 2043 616c 6375 6c61 7465 2074     # Calculate t
-00037d40: 6865 2065 7563 6c69 6465 616e 2064 6973  he euclidean dis
-00037d50: 7461 6e63 6520 6265 7477 6565 6e20 7261  tance between ra
-00037d60: 5f64 6563 2061 6e64 2070 6561 6b0a 2020  _dec and peak.  
-00037d70: 2020 2020 2020 7365 7020 3d20 6e70 2e73        sep = np.s
-00037d80: 7172 7428 6162 7328 7365 6c66 2e72 615f  qrt(abs(self.ra_
-00037d90: 6465 635b 305d 202d 2073 656c 662e 7065  dec[0] - self.pe
-00037da0: 616b 5b30 5d29 202a 2a20 3220 2b20 6162  ak[0]) ** 2 + ab
-00037db0: 7328 7365 6c66 2e72 615f 6465 635b 315d  s(self.ra_dec[1]
-00037dc0: 202d 2073 656c 662e 7065 616b 5b31 5d29   - self.peak[1])
-00037dd0: 202a 2a20 3229 0a20 2020 2020 2020 2023   ** 2).        #
-00037de0: 2043 6f6e 7665 7274 2074 6865 2073 6570   Convert the sep
-00037df0: 6172 6174 696f 6e20 746f 2074 6865 2072  aration to the r
-00037e00: 6571 7565 7374 6564 2075 6e69 7420 2d20  equested unit - 
-00037e10: 7468 6973 2077 696c 6c20 7468 726f 7720  this will throw 
-00037e20: 616e 2065 7272 6f72 2069 6620 7468 6520  an error if the 
-00037e30: 756e 6974 2069 7320 7374 7570 6964 0a20  unit is stupid. 
-00037e40: 2020 2020 2020 2063 6f6e 765f 7365 7020         conv_sep 
-00037e50: 3d20 7365 6c66 2e63 6f6e 7665 7274 5f72  = self.convert_r
-00037e60: 6164 6975 7328 7365 702c 206f 6666 5f75  adius(sep, off_u
-00037e70: 6e69 7429 0a0a 2020 2020 2020 2020 2320  nit)..        # 
-00037e80: 5265 7475 726e 2074 6865 2063 6f6e 7665  Return the conve
-00037e90: 7274 6564 2073 6570 6172 6174 696f 6e0a  rted separation.
-00037ea0: 2020 2020 2020 2020 7265 7475 726e 2063          return c
-00037eb0: 6f6e 765f 7365 700a 0a20 2020 2040 7072  onv_sep..    @pr
-00037ec0: 6f70 6572 7479 0a20 2020 2064 6566 2070  operty.    def p
-00037ed0: 6561 6b5f 6c6f 5f65 6e28 7365 6c66 2920  eak_lo_en(self) 
-00037ee0: 2d3e 2051 7561 6e74 6974 793a 0a20 2020  -> Quantity:.   
-00037ef0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00037f00: 2054 6869 7320 7072 6f70 6572 7479 2072   This property r
-00037f10: 6574 7572 6e73 2074 6865 206c 6f77 6572  eturns the lower
-00037f20: 2065 6e65 7267 7920 626f 756e 6420 6f66   energy bound of
-00037f30: 2074 6865 2069 6d61 6765 2075 7365 6420   the image used 
-00037f40: 666f 7220 7065 616b 2066 696e 6469 6e67  for peak finding
-00037f50: 2e0a 0a20 2020 2020 2020 203a 7265 7475  ...        :retu
-00037f60: 726e 3a20 4120 7175 616e 7469 7479 2063  rn: A quantity c
-00037f70: 6f6e 7461 696e 696e 6720 7468 6520 6c6f  ontaining the lo
-00037f80: 7765 7220 656e 6572 6779 206c 696d 6974  wer energy limit
-00037f90: 2075 7365 6420 666f 7220 7065 616b 2066   used for peak f
-00037fa0: 696e 6469 6e67 2e0a 2020 2020 2020 2020  inding..        
-00037fb0: 3a72 7479 7065 3a20 5175 616e 7469 7479  :rtype: Quantity
-00037fc0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00037fd0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-00037fe0: 2e5f 7065 616b 5f6c 6f5f 656e 0a0a 2020  ._peak_lo_en..  
-00037ff0: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
-00038000: 6465 6620 7065 616b 5f68 695f 656e 2873  def peak_hi_en(s
-00038010: 656c 6629 202d 3e20 5175 616e 7469 7479  elf) -> Quantity
-00038020: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-00038030: 2020 2020 2020 5468 6973 2070 726f 7065        This prope
-00038040: 7274 7920 7265 7475 726e 7320 7468 6520  rty returns the 
-00038050: 7570 7065 7220 656e 6572 6779 2062 6f75  upper energy bou
-00038060: 6e64 206f 6620 7468 6520 696d 6167 6520  nd of the image 
-00038070: 7573 6564 2066 6f72 2070 6561 6b20 6669  used for peak fi
-00038080: 6e64 696e 672e 0a0a 2020 2020 2020 2020  nding...        
-00038090: 3a72 6574 7572 6e3a 2041 2071 7561 6e74  :return: A quant
-000380a0: 6974 7920 636f 6e74 6169 6e69 6e67 2074  ity containing t
-000380b0: 6865 2075 7070 6572 2065 6e65 7267 7920  he upper energy 
-000380c0: 6c69 6d69 7420 7573 6564 2066 6f72 2070  limit used for p
-000380d0: 6561 6b20 6669 6e64 696e 672e 0a20 2020  eak finding..   
-000380e0: 2020 2020 203a 7274 7970 653a 2051 7561       :rtype: Qua
-000380f0: 6e74 6974 790a 2020 2020 2020 2020 2222  ntity.        ""
-00038100: 220a 2020 2020 2020 2020 7265 7475 726e  ".        return
-00038110: 2073 656c 662e 5f70 6561 6b5f 6869 5f65   self._peak_hi_e
-00038120: 6e0a 0a20 2020 2040 7072 6f70 6572 7479  n..    @property
-00038130: 0a20 2020 2064 6566 2075 7365 5f70 6561  .    def use_pea
-00038140: 6b28 7365 6c66 2920 2d3e 2062 6f6f 6c3a  k(self) -> bool:
-00038150: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00038160: 2020 2020 2054 6869 7320 7072 6f70 6572       This proper
-00038170: 7479 2073 686f 7773 2077 6865 7468 6572  ty shows whether
-00038180: 2061 2070 6172 7469 6375 6c61 7220 5847   a particular XG
-00038190: 4120 736f 7572 6365 206f 626a 6563 7420  A source object 
-000381a0: 6861 7320 6265 656e 2073 6574 7570 2074  has been setup t
-000381b0: 6f20 7573 6520 7065 616b 2063 6f6f 7264  o use peak coord
-000381c0: 696e 6174 6573 0a20 2020 2020 2020 206f  inates.        o
-000381d0: 7220 6e6f 742e 2054 6865 2070 726f 7065  r not. The prope
-000381e0: 7274 7920 6973 2065 6974 6865 7220 5472  rty is either Tr
-000381f0: 7565 2c20 4661 6c73 652c 206f 7220 4e6f  ue, False, or No
-00038200: 6e65 2028 6966 2069 7473 2061 2042 6173  ne (if its a Bas
-00038210: 6553 6f75 7263 6529 2e0a 0a20 2020 2020  eSource)...     
-00038220: 2020 203a 7265 7475 726e 3a20 4966 2074     :return: If t
-00038230: 6865 2073 6f75 7263 6520 6973 2073 6574  he source is set
-00038240: 2074 6f20 7573 6520 7065 616b 732c 2054   to use peaks, T
-00038250: 7275 652c 206f 7468 6572 7769 7365 2046  rue, otherwise F
-00038260: 616c 7365 2e0a 2020 2020 2020 2020 3a72  alse..        :r
-00038270: 7479 7065 3a20 626f 6f6c 0a20 2020 2020  type: bool.     
-00038280: 2020 2022 2222 0a20 2020 2020 2020 2072     """.        r
-00038290: 6574 7572 6e20 7365 6c66 2e5f 7573 655f  eturn self._use_
-000382a0: 7065 616b 0a0a 2020 2020 4070 726f 7065  peak..    @prope
-000382b0: 7274 790a 2020 2020 6465 6620 7375 7070  rty.    def supp
-000382c0: 7265 7373 6564 5f77 6172 6e69 6e67 7328  ressed_warnings(
-000382d0: 7365 6c66 2920 2d3e 204c 6973 745b 7374  self) -> List[st
-000382e0: 725d 3a0a 2020 2020 2020 2020 2222 220a  r]:.        """.
-000382f0: 2020 2020 2020 2020 4120 7072 6f70 6572          A proper
-00038300: 7479 2067 6574 7465 7220 2877 6974 6820  ty getter (with 
-00038310: 6e6f 2073 6574 7465 7229 2066 6f72 2074  no setter) for t
-00038320: 6865 2077 6172 6e69 6e67 7320 7468 6174  he warnings that
-00038330: 2068 6176 6520 6265 656e 2073 7570 7072   have been suppr
-00038340: 6573 7365 6420 6672 6f6d 2064 6973 706c  essed from displ
-00038350: 6179 2074 6f20 7468 6520 7573 6572 2061  ay to the user a
-00038360: 730a 2020 2020 2020 2020 7468 6520 736f  s.        the so
-00038370: 7572 6365 2077 6173 2064 6563 6c61 7265  urce was declare
-00038380: 6420 6173 2061 206d 656d 6265 7220 6f66  d as a member of
-00038390: 2061 2073 616d 706c 652e 0a0a 2020 2020   a sample...    
-000383a0: 2020 2020 3a72 6574 7572 6e3a 2054 6865      :return: The
-000383b0: 206c 6973 7420 6f66 2073 7570 7072 6573   list of suppres
-000383c0: 7365 6420 7761 726e 696e 6773 2066 6f72  sed warnings for
-000383d0: 2074 6869 7320 736f 7572 6365 2e0a 2020   this source..  
-000383e0: 2020 2020 2020 3a72 7479 7065 3a20 4c69        :rtype: Li
-000383f0: 7374 5b73 7472 5d0a 2020 2020 2020 2020  st[str].        
-00038400: 2222 220a 2020 2020 2020 2020 6966 206e  """.        if n
-00038410: 6f74 2073 656c 662e 5f73 616d 705f 6d65  ot self._samp_me
-00038420: 6d62 6572 3a0a 2020 2020 2020 2020 2020  mber:.          
-00038430: 2020 7261 6973 6520 4e6f 7453 616d 706c    raise NotSampl
-00038440: 654d 656d 6265 7245 7272 6f72 2822 5468  eMemberError("Th
-00038450: 6520 736f 7572 6365 2066 6f72 207b 6e7d  e source for {n}
-00038460: 2069 7320 6e6f 7420 6120 6d65 6d62 6572   is not a member
-00038470: 206f 6620 6120 7361 6d70 6c65 2c20 616e   of a sample, an
-00038480: 6420 6173 2073 7563 6820 7761 726e 696e  d as such warnin
-00038490: 6773 2068 6176 6520 220a 2020 2020 2020  gs have ".      
-000384a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000384b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000384c0: 2022 6e6f 7420 6265 656e 2073 7570 7072   "not been suppr
-000384d0: 6573 7365 642e 222e 666f 726d 6174 286e  essed.".format(n
-000384e0: 3d73 656c 662e 6e61 6d65 2929 0a20 2020  =self.name)).   
-000384f0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00038500: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-00038510: 6c66 2e5f 7375 7070 5f77 6172 6e0a 0a20  lf._supp_warn.. 
-00038520: 2020 2064 6566 2069 6e66 6f28 7365 6c66     def info(self
-00038530: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
-00038540: 2020 2020 2020 2056 6572 7920 7369 6d70         Very simp
-00038550: 6c65 2066 756e 6374 696f 6e20 7468 6174  le function that
-00038560: 206a 7573 7420 7072 696e 7473 2061 2073   just prints a s
-00038570: 756d 6d61 7279 206f 6620 696d 706f 7274  ummary of import
-00038580: 616e 7420 696e 666f 726d 6174 696f 6e20  ant information 
-00038590: 7265 6c61 7465 6420 746f 2074 6865 2073  related to the s
-000385a0: 6f75 7263 6520 6f62 6a65 6374 2e2e 0a20  ource object... 
-000385b0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-000385c0: 2020 2070 7269 6e74 2822 5c6e 2d2d 2d2d     print("\n----
-000385d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000385e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000385f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00038600: 2d22 290a 2020 2020 2020 2020 7072 696e  -").        prin
-00038610: 7428 2253 6f75 7263 6520 4e61 6d65 202d  t("Source Name -
-00038620: 207b 7d22 2e66 6f72 6d61 7428 7365 6c66   {}".format(self
-00038630: 2e5f 6e61 6d65 2929 0a20 2020 2020 2020  ._name)).       
-00038640: 2070 7269 6e74 2822 5573 6572 2043 6f6f   print("User Coo
-00038650: 7264 696e 6174 6573 202d 2028 7b30 7d2c  rdinates - ({0},
-00038660: 207b 317d 2920 6465 6772 6565 7322 2e66   {1}) degrees".f
-00038670: 6f72 6d61 7428 2a73 656c 662e 5f72 615f  ormat(*self._ra_
-00038680: 6465 6329 290a 2020 2020 2020 2020 6966  dec)).        if
-00038690: 2073 656c 662e 5f75 7365 5f70 6561 6b20   self._use_peak 
-000386a0: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
-000386b0: 7365 6c66 2e5f 7573 655f 7065 616b 3a0a  self._use_peak:.
-000386c0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-000386d0: 7428 2258 2d72 6179 2050 6561 6b20 2d20  t("X-ray Peak - 
-000386e0: 287b 307d 2c20 7b31 7d29 2064 6567 7265  ({0}, {1}) degre
-000386f0: 6573 222e 666f 726d 6174 282a 7365 6c66  es".format(*self
-00038700: 2e5f 7065 616b 735b 2263 6f6d 6269 6e65  ._peaks["combine
-00038710: 6422 5d2e 7661 6c75 6529 290a 2020 2020  d"].value)).    
-00038720: 2020 2020 7072 696e 7428 226e 4820 2d20      print("nH - 
-00038730: 7b7d 222e 666f 726d 6174 2873 656c 662e  {}".format(self.
-00038740: 6e48 2929 0a20 2020 2020 2020 2069 6620  nH)).        if 
-00038750: 7365 6c66 2e5f 7265 6473 6869 6674 2069  self._redshift i
-00038760: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00038770: 2020 2020 2020 2020 7072 696e 7428 2252          print("R
-00038780: 6564 7368 6966 7420 2d20 7b7d 222e 666f  edshift - {}".fo
-00038790: 726d 6174 2872 6f75 6e64 2873 656c 662e  rmat(round(self.
-000387a0: 5f72 6564 7368 6966 742c 2033 2929 290a  _redshift, 3))).
-000387b0: 2020 2020 2020 2020 7072 696e 7428 2258          print("X
-000387c0: 4d4d 204f 6273 4944 7320 2d20 7b7d 222e  MM ObsIDs - {}".
-000387d0: 666f 726d 6174 2873 656c 662e 5f5f 6c65  format(self.__le
-000387e0: 6e5f 5f28 2929 290a 2020 2020 2020 2020  n__())).        
-000387f0: 7072 696e 7428 2250 4e20 4f62 7365 7276  print("PN Observ
-00038800: 6174 696f 6e73 202d 207b 7d22 2e66 6f72  ations - {}".for
-00038810: 6d61 7428 7365 6c66 2e6e 756d 5f70 6e5f  mat(self.num_pn_
-00038820: 6f62 7329 290a 2020 2020 2020 2020 7072  obs)).        pr
-00038830: 696e 7428 224d 4f53 3120 4f62 7365 7276  int("MOS1 Observ
-00038840: 6174 696f 6e73 202d 207b 7d22 2e66 6f72  ations - {}".for
-00038850: 6d61 7428 7365 6c66 2e6e 756d 5f6d 6f73  mat(self.num_mos
-00038860: 315f 6f62 7329 290a 2020 2020 2020 2020  1_obs)).        
-00038870: 7072 696e 7428 224d 4f53 3220 4f62 7365  print("MOS2 Obse
-00038880: 7276 6174 696f 6e73 202d 207b 7d22 2e66  rvations - {}".f
-00038890: 6f72 6d61 7428 7365 6c66 2e6e 756d 5f6d  ormat(self.num_m
-000388a0: 6f73 325f 6f62 7329 290a 2020 2020 2020  os2_obs)).      
-000388b0: 2020 7072 696e 7428 224f 6e2d 4178 6973    print("On-Axis
-000388c0: 202d 207b 7d22 2e66 6f72 6d61 7428 6c65   - {}".format(le
-000388d0: 6e28 7365 6c66 2e5f 6f6e 6178 6973 2929  n(self._onaxis))
-000388e0: 290a 2020 2020 2020 2020 7072 696e 7428  ).        print(
-000388f0: 2257 6974 6820 7265 6769 6f6e 7320 2d20  "With regions - 
-00038900: 7b7d 222e 666f 726d 6174 286c 656e 2873  {}".format(len(s
-00038910: 656c 662e 5f69 6e69 7469 616c 5f72 6567  elf._initial_reg
-00038920: 696f 6e73 2929 290a 2020 2020 2020 2020  ions))).        
-00038930: 7072 696e 7428 2254 6f74 616c 2072 6567  print("Total reg
-00038940: 696f 6e73 202d 207b 7d22 2e66 6f72 6d61  ions - {}".forma
-00038950: 7428 7375 6d28 5b6c 656e 2873 656c 662e  t(sum([len(self.
-00038960: 5f69 6e69 7469 616c 5f72 6567 696f 6e73  _initial_regions
-00038970: 5b6f 5d29 2066 6f72 206f 2069 6e20 7365  [o]) for o in se
-00038980: 6c66 2e5f 696e 6974 6961 6c5f 7265 6769  lf._initial_regi
-00038990: 6f6e 735d 2929 290a 2020 2020 2020 2020  ons]))).        
-000389a0: 7072 696e 7428 224f 6273 2077 6974 6820  print("Obs with 
-000389b0: 3120 6465 7465 6374 696f 6e20 2d20 7b7d  1 detection - {}
-000389c0: 222e 666f 726d 6174 2873 756d 285b 3120  ".format(sum([1 
-000389d0: 666f 7220 6f20 696e 2073 656c 662e 5f69  for o in self._i
-000389e0: 6e69 7469 616c 5f72 6567 696f 6e5f 6d61  nitial_region_ma
-000389f0: 7463 6865 7320 6966 0a20 2020 2020 2020  tches if.       
-00038a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038a20: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00038a30: 662e 5f69 6e69 7469 616c 5f72 6567 696f  f._initial_regio
-00038a40: 6e5f 6d61 7463 6865 735b 6f5d 2e73 756d  n_matches[o].sum
-00038a50: 2829 203d 3d20 315d 2929 290a 2020 2020  () == 1]))).    
-00038a60: 2020 2020 7072 696e 7428 224f 6273 2077      print("Obs w
-00038a70: 6974 6820 3e31 206d 6174 6368 6573 202d  ith >1 matches -
-00038a80: 207b 7d22 2e66 6f72 6d61 7428 7375 6d28   {}".format(sum(
-00038a90: 5b31 2066 6f72 206f 2069 6e20 7365 6c66  [1 for o in self
-00038aa0: 2e5f 696e 6974 6961 6c5f 7265 6769 6f6e  ._initial_region
-00038ab0: 5f6d 6174 6368 6573 2069 660a 2020 2020  _matches if.    
-00038ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038af0: 2073 656c 662e 5f69 6e69 7469 616c 5f72   self._initial_r
-00038b00: 6567 696f 6e5f 6d61 7463 6865 735b 6f5d  egion_matches[o]
-00038b10: 2e73 756d 2829 203e 2031 5d29 2929 0a20  .sum() > 1]))). 
-00038b20: 2020 2020 2020 2023 2049 6620 6120 636f         # If a co
-00038b30: 6d62 696e 6564 2065 7870 6f73 7572 6520  mbined exposure 
-00038b40: 6d61 7020 6578 6973 7473 2c20 7765 276c  map exists, we'l
-00038b50: 6c20 7573 6520 6974 2074 6f20 6769 7665  l use it to give
-00038b60: 2074 6865 2075 7365 7220 616e 2069 6465   the user an ide
-00038b70: 6120 6f66 2074 6865 2074 6f74 616c 2065  a of the total e
-00038b80: 7870 6f73 7572 650a 2020 2020 2020 2020  xposure.        
-00038b90: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00038ba0: 2065 7820 3d20 7365 6c66 2e67 6574 5f63   ex = self.get_c
-00038bb0: 6f6d 6269 6e65 645f 6578 706d 6170 7328  ombined_expmaps(
-00038bc0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-00038bd0: 2069 7369 6e73 7461 6e63 6528 6578 2c20   isinstance(ex, 
-00038be0: 6c69 7374 293a 0a20 2020 2020 2020 2020  list):.         
-00038bf0: 2020 2020 2020 2065 7820 3d20 6578 5b30         ex = ex[0
-00038c00: 5d0a 2020 2020 2020 2020 2020 2020 7072  ].            pr
-00038c10: 696e 7428 2254 6f74 616c 2065 7870 6f73  int("Total expos
-00038c20: 7572 6520 2d20 7b7d 222e 666f 726d 6174  ure - {}".format
-00038c30: 2865 782e 6765 745f 6578 7028 7365 6c66  (ex.get_exp(self
-00038c40: 2e72 615f 6465 6329 2e74 6f28 276b 7327  .ra_dec).to('ks'
-00038c50: 292e 726f 756e 6428 3229 2929 0a20 2020  ).round(2))).   
-00038c60: 2020 2020 2065 7863 6570 7420 4e6f 5072       except NoPr
-00038c70: 6f64 7563 7441 7661 696c 6162 6c65 4572  oductAvailableEr
-00038c80: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
-00038c90: 2070 6173 730a 2020 2020 2020 2020 7072   pass.        pr
-00038ca0: 696e 7428 2249 6d61 6765 7320 6173 736f  int("Images asso
-00038cb0: 6369 6174 6564 202d 207b 7d22 2e66 6f72  ciated - {}".for
-00038cc0: 6d61 7428 6c65 6e28 7365 6c66 2e67 6574  mat(len(self.get
-00038cd0: 5f70 726f 6475 6374 7328 2269 6d61 6765  _products("image
-00038ce0: 2229 2929 290a 2020 2020 2020 2020 7072  ")))).        pr
-00038cf0: 696e 7428 2245 7870 6f73 7572 6520 6d61  int("Exposure ma
-00038d00: 7073 2061 7373 6f63 6961 7465 6420 2d20  ps associated - 
-00038d10: 7b7d 222e 666f 726d 6174 286c 656e 2873  {}".format(len(s
-00038d20: 656c 662e 6765 745f 7072 6f64 7563 7473  elf.get_products
-00038d30: 2822 6578 706d 6170 2229 2929 290a 2020  ("expmap")))).  
-00038d40: 2020 2020 2020 7072 696e 7428 2243 6f6d        print("Com
-00038d50: 6269 6e65 6420 5261 7465 6d61 7073 2061  bined Ratemaps a
-00038d60: 7373 6f63 6961 7465 6420 2d20 7b7d 222e  ssociated - {}".
-00038d70: 666f 726d 6174 286c 656e 2873 656c 662e  format(len(self.
-00038d80: 6765 745f 7072 6f64 7563 7473 2822 636f  get_products("co
-00038d90: 6d62 696e 6564 5f72 6174 656d 6170 2229  mbined_ratemap")
-00038da0: 2929 290a 2020 2020 2020 2020 7072 696e  ))).        prin
-00038db0: 7428 2253 7065 6374 7261 2061 7373 6f63  t("Spectra assoc
-00038dc0: 6961 7465 6420 2d20 7b7d 222e 666f 726d  iated - {}".form
-00038dd0: 6174 286c 656e 2873 656c 662e 6765 745f  at(len(self.get_
-00038de0: 7072 6f64 7563 7473 2822 7370 6563 7472  products("spectr
-00038df0: 756d 2229 2929 290a 0a20 2020 2020 2020  um"))))..       
-00038e00: 2069 6620 6c65 6e28 7365 6c66 2e5f 6669   if len(self._fi
-00038e10: 745f 7265 7375 6c74 7329 2021 3d20 303a  t_results) != 0:
-00038e20: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-00038e30: 6e74 2822 4669 7474 6564 204d 6f64 656c  nt("Fitted Model
-00038e40: 7320 2d20 7b7d 222e 666f 726d 6174 2822  s - {}".format("
-00038e50: 207c 2022 2e6a 6f69 6e28 7365 6c66 2e66   | ".join(self.f
-00038e60: 6974 7465 645f 6d6f 6465 6c73 2929 290a  itted_models))).
-00038e70: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00038e80: 2e5f 7265 6769 6f6e 7320 6973 206e 6f74  ._regions is not
-00038e90: 204e 6f6e 6520 616e 6420 2263 7573 746f   None and "custo
-00038ea0: 6d22 2069 6e20 7365 6c66 2e5f 7261 6469  m" in self._radi
-00038eb0: 693a 0a20 2020 2020 2020 2020 2020 2069  i:.            i
-00038ec0: 6620 7365 6c66 2e5f 7265 6473 6869 6674  f self._redshift
-00038ed0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-00038ee0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00038ef0: 6769 6f6e 5f72 6164 6975 7320 3d20 616e  gion_radius = an
-00038f00: 675f 746f 5f72 6164 2873 656c 662e 5f63  g_to_rad(self._c
-00038f10: 7573 746f 6d5f 7265 6769 6f6e 5f72 6164  ustom_region_rad
-00038f20: 6975 732c 2073 656c 662e 5f72 6564 7368  ius, self._redsh
-00038f30: 6966 742c 2063 6f73 6d6f 3d73 656c 662e  ift, cosmo=self.
-00038f40: 5f63 6f73 6d6f 290a 2020 2020 2020 2020  _cosmo).        
-00038f50: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00038f60: 2020 2020 2020 2020 2020 7265 6769 6f6e            region
-00038f70: 5f72 6164 6975 7320 3d20 7365 6c66 2e5f  _radius = self._
-00038f80: 6375 7374 6f6d 5f72 6567 696f 6e5f 7261  custom_region_ra
-00038f90: 6469 7573 2e74 6f28 2264 6567 2229 0a20  dius.to("deg"). 
-00038fa0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00038fb0: 2822 4375 7374 6f6d 2052 6567 696f 6e20  ("Custom Region 
-00038fc0: 5261 6469 7573 202d 207b 7d22 2e66 6f72  Radius - {}".for
-00038fd0: 6d61 7428 7265 6769 6f6e 5f72 6164 6975  mat(region_radiu
-00038fe0: 732e 726f 756e 6428 3229 2929 0a20 2020  s.round(2))).   
-00038ff0: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
-00039000: 7365 6c66 2e67 6574 5f70 726f 6475 6374  self.get_product
-00039010: 7328 2763 6f6d 6269 6e65 645f 696d 6167  s('combined_imag
-00039020: 6527 2929 2021 3d20 303a 0a20 2020 2020  e')) != 0:.     
-00039030: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00039040: 2822 4375 7374 6f6d 2052 6567 696f 6e20  ("Custom Region 
-00039050: 534e 5220 2d20 7b7d 222e 666f 726d 6174  SNR - {}".format
-00039060: 2873 656c 662e 6765 745f 736e 7228 2263  (self.get_snr("c
-00039070: 7573 746f 6d22 2c20 7365 6c66 2e5f 6465  ustom", self._de
-00039080: 6661 756c 745f 636f 6f72 6429 2e72 6f75  fault_coord).rou
-00039090: 6e64 2832 2929 290a 0a20 2020 2020 2020  nd(2)))..       
-000390a0: 2069 6620 7365 6c66 2e5f 7232 3030 2069   if self._r200 i
-000390b0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-000390c0: 2020 2020 2020 2020 7072 696e 7428 2252          print("R
-000390d0: 3230 3020 2d20 7b7d 222e 666f 726d 6174  200 - {}".format
-000390e0: 2873 656c 662e 5f72 3230 302e 726f 756e  (self._r200.roun
-000390f0: 6428 3229 2929 0a20 2020 2020 2020 2020  d(2))).         
-00039100: 2020 2069 6620 6c65 6e28 7365 6c66 2e67     if len(self.g
-00039110: 6574 5f70 726f 6475 6374 7328 2763 6f6d  et_products('com
-00039120: 6269 6e65 645f 696d 6167 6527 2929 2021  bined_image')) !
-00039130: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
-00039140: 2020 2020 2070 7269 6e74 2822 5232 3030       print("R200
-00039150: 2053 4e52 202d 207b 7d22 2e66 6f72 6d61   SNR - {}".forma
-00039160: 7428 7365 6c66 2e67 6574 5f73 6e72 2822  t(self.get_snr("
-00039170: 7232 3030 222c 2073 656c 662e 5f64 6566  r200", self._def
-00039180: 6175 6c74 5f63 6f6f 7264 292e 726f 756e  ault_coord).roun
-00039190: 6428 3229 2929 0a20 2020 2020 2020 2069  d(2))).        i
-000391a0: 6620 7365 6c66 2e5f 7235 3030 2069 7320  f self._r500 is 
-000391b0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-000391c0: 2020 2020 2020 7072 696e 7428 2252 3530        print("R50
-000391d0: 3020 2d20 7b7d 222e 666f 726d 6174 2873  0 - {}".format(s
-000391e0: 656c 662e 5f72 3530 302e 726f 756e 6428  elf._r500.round(
-000391f0: 3229 2929 0a20 2020 2020 2020 2020 2020  2))).           
-00039200: 2069 6620 6c65 6e28 7365 6c66 2e67 6574   if len(self.get
-00039210: 5f70 726f 6475 6374 7328 2763 6f6d 6269  _products('combi
-00039220: 6e65 645f 696d 6167 6527 2929 2021 3d20  ned_image')) != 
-00039230: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
-00039240: 2020 2070 7269 6e74 2822 5235 3030 2053     print("R500 S
-00039250: 4e52 202d 207b 7d22 2e66 6f72 6d61 7428  NR - {}".format(
-00039260: 7365 6c66 2e67 6574 5f73 6e72 2822 7235  self.get_snr("r5
-00039270: 3030 222c 2073 656c 662e 5f64 6566 6175  00", self._defau
-00039280: 6c74 5f63 6f6f 7264 292e 726f 756e 6428  lt_coord).round(
-00039290: 3229 2929 0a20 2020 2020 2020 2069 6620  2))).        if 
-000392a0: 7365 6c66 2e5f 7232 3530 3020 6973 206e  self._r2500 is n
-000392b0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-000392c0: 2020 2020 2070 7269 6e74 2822 5232 3530       print("R250
-000392d0: 3020 2d20 7b7d 222e 666f 726d 6174 2873  0 - {}".format(s
-000392e0: 656c 662e 5f72 3235 3030 2e72 6f75 6e64  elf._r2500.round
-000392f0: 2832 2929 290a 2020 2020 2020 2020 2020  (2))).          
-00039300: 2020 6966 206c 656e 2873 656c 662e 6765    if len(self.ge
-00039310: 745f 7072 6f64 7563 7473 2827 636f 6d62  t_products('comb
-00039320: 696e 6564 5f69 6d61 6765 2729 2920 213d  ined_image')) !=
-00039330: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-00039340: 2020 2020 7072 696e 7428 2252 3235 3030      print("R2500
-00039350: 2053 4e52 202d 207b 7d22 2e66 6f72 6d61   SNR - {}".forma
-00039360: 7428 7365 6c66 2e67 6574 5f73 6e72 2822  t(self.get_snr("
-00039370: 7232 3530 3022 2c20 7365 6c66 2e5f 6465  r2500", self._de
-00039380: 6661 756c 745f 636f 6f72 6429 2e72 6f75  fault_coord).rou
-00039390: 6e64 2832 2929 290a 0a20 2020 2020 2020  nd(2)))..       
-000393a0: 2023 2054 6865 7265 2773 2070 726f 6261   # There's proba
-000393b0: 626c 7920 6120 6e65 6174 6572 2077 6179  bly a neater way
-000393c0: 206f 6620 646f 696e 6720 7468 6520 6f62   of doing the ob
-000393d0: 7365 7276 6162 6c65 7320 2d20 6d61 7962  servables - mayb
-000393e0: 6520 6120 666f 726d 6174 7469 6e67 2066  e a formatting f
-000393f0: 756e 6374 696f 6e3f 0a20 2020 2020 2020  unction?.       
-00039400: 2069 6620 7365 6c66 2e5f 7269 6368 6e65   if self._richne
-00039410: 7373 2069 7320 6e6f 7420 4e6f 6e65 2061  ss is not None a
-00039420: 6e64 2073 656c 662e 5f72 6963 686e 6573  nd self._richnes
-00039430: 735f 6572 7220 6973 206e 6f74 204e 6f6e  s_err is not Non
-00039440: 6520 5c0a 2020 2020 2020 2020 2020 2020  e \.            
-00039450: 2020 2020 616e 6420 6e6f 7420 6973 696e      and not isin
-00039460: 7374 616e 6365 2873 656c 662e 5f72 6963  stance(self._ric
-00039470: 686e 6573 735f 6572 722c 2028 6c69 7374  hness_err, (list
-00039480: 2c20 7475 706c 652c 206e 6461 7272 6179  , tuple, ndarray
-00039490: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
-000394a0: 7072 696e 7428 2252 6963 686e 6573 7320  print("Richness 
-000394b0: 2d20 7b30 7dc2 b17b 317d 222e 666f 726d  - {0}..{1}".form
-000394c0: 6174 2873 656c 662e 5f72 6963 686e 6573  at(self._richnes
-000394d0: 732e 726f 756e 6428 3229 2c20 7365 6c66  s.round(2), self
-000394e0: 2e5f 7269 6368 6e65 7373 5f65 7272 2e72  ._richness_err.r
-000394f0: 6f75 6e64 2832 2929 290a 2020 2020 2020  ound(2))).      
-00039500: 2020 656c 6966 2073 656c 662e 5f72 6963    elif self._ric
-00039510: 686e 6573 7320 6973 206e 6f74 204e 6f6e  hness is not Non
-00039520: 6520 616e 6420 7365 6c66 2e5f 7269 6368  e and self._rich
-00039530: 6e65 7373 5f65 7272 2069 7320 6e6f 7420  ness_err is not 
-00039540: 4e6f 6e65 205c 0a20 2020 2020 2020 2020  None \.         
-00039550: 2020 2020 2020 2061 6e64 2069 7369 6e73         and isins
-00039560: 7461 6e63 6528 7365 6c66 2e5f 7269 6368  tance(self._rich
-00039570: 6e65 7373 5f65 7272 2c20 286c 6973 742c  ness_err, (list,
-00039580: 2074 7570 6c65 2c20 6e64 6172 7261 7929   tuple, ndarray)
-00039590: 293a 0a20 2020 2020 2020 2020 2020 2070  ):.            p
-000395a0: 7269 6e74 2822 5269 6368 6e65 7373 202d  rint("Richness -
-000395b0: 207b 307d 202d 7b31 7d2b 7b32 7d22 2e66   {0} -{1}+{2}".f
-000395c0: 6f72 6d61 7428 7365 6c66 2e5f 7269 6368  ormat(self._rich
-000395d0: 6e65 7373 2e72 6f75 6e64 2832 292c 2073  ness.round(2), s
-000395e0: 656c 662e 5f72 6963 686e 6573 735f 6572  elf._richness_er
-000395f0: 725b 305d 2e72 6f75 6e64 2832 292c 0a20  r[0].round(2),. 
-00039600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039630: 2020 7365 6c66 2e5f 7269 6368 6e65 7373    self._richness
-00039640: 5f65 7272 5b31 5d2e 726f 756e 6428 3229  _err[1].round(2)
-00039650: 2929 0a20 2020 2020 2020 2065 6c69 6620  )).        elif 
-00039660: 7365 6c66 2e5f 7269 6368 6e65 7373 2069  self._richness i
-00039670: 7320 6e6f 7420 4e6f 6e65 2061 6e64 2073  s not None and s
-00039680: 656c 662e 5f72 6963 686e 6573 735f 6572  elf._richness_er
-00039690: 7220 6973 204e 6f6e 653a 0a20 2020 2020  r is None:.     
-000396a0: 2020 2020 2020 2070 7269 6e74 2822 5269         print("Ri
-000396b0: 6368 6e65 7373 202d 207b 307d 222e 666f  chness - {0}".fo
-000396c0: 726d 6174 2873 656c 662e 5f72 6963 686e  rmat(self._richn
-000396d0: 6573 732e 726f 756e 6428 3229 2929 0a0a  ess.round(2)))..
-000396e0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-000396f0: 5f77 6c5f 6d61 7373 2069 7320 6e6f 7420  _wl_mass is not 
-00039700: 4e6f 6e65 2061 6e64 2073 656c 662e 5f77  None and self._w
-00039710: 6c5f 6d61 7373 5f65 7272 2069 7320 6e6f  l_mass_err is no
-00039720: 7420 4e6f 6e65 205c 0a20 2020 2020 2020  t None \.       
-00039730: 2020 2020 2020 2020 2061 6e64 206e 6f74           and not
-00039740: 2069 7369 6e73 7461 6e63 6528 7365 6c66   isinstance(self
-00039750: 2e5f 776c 5f6d 6173 735f 6572 722c 2028  ._wl_mass_err, (
-00039760: 6c69 7374 2c20 7475 706c 652c 206e 6461  list, tuple, nda
-00039770: 7272 6179 2929 3a0a 2020 2020 2020 2020  rray)):.        
-00039780: 2020 2020 7072 696e 7428 2257 6561 6b20      print("Weak 
-00039790: 4c65 6e73 696e 6720 4d61 7373 202d 207b  Lensing Mass - {
-000397a0: 307d c2b1 7b31 7d22 2e66 6f72 6d61 7428  0}..{1}".format(
-000397b0: 7365 6c66 2e5f 776c 5f6d 6173 732c 2073  self._wl_mass, s
-000397c0: 656c 662e 5f72 6963 686e 6573 735f 6572  elf._richness_er
-000397d0: 7229 290a 2020 2020 2020 2020 656c 6966  r)).        elif
-000397e0: 2073 656c 662e 5f77 6c5f 6d61 7373 2069   self._wl_mass i
-000397f0: 7320 6e6f 7420 4e6f 6e65 2061 6e64 2073  s not None and s
-00039800: 656c 662e 5f77 6c5f 6d61 7373 5f65 7272  elf._wl_mass_err
-00039810: 2069 7320 6e6f 7420 4e6f 6e65 205c 0a20   is not None \. 
-00039820: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00039830: 6e64 2069 7369 6e73 7461 6e63 6528 7365  nd isinstance(se
-00039840: 6c66 2e5f 776c 5f6d 6173 735f 6572 722c  lf._wl_mass_err,
-00039850: 2028 6c69 7374 2c20 7475 706c 652c 206e   (list, tuple, n
-00039860: 6461 7272 6179 2929 3a0a 2020 2020 2020  darray)):.      
-00039870: 2020 2020 2020 7072 696e 7428 2257 6561        print("Wea
-00039880: 6b20 4c65 6e73 696e 6720 4d61 7373 202d  k Lensing Mass -
-00039890: 207b 307d 202d 7b31 7d2b 7b32 7d22 2e66   {0} -{1}+{2}".f
-000398a0: 6f72 6d61 7428 7365 6c66 2e5f 776c 5f6d  ormat(self._wl_m
-000398b0: 6173 732c 2073 656c 662e 5f77 6c5f 6d61  ass, self._wl_ma
-000398c0: 7373 5f65 7272 5b30 5d2c 0a20 2020 2020  ss_err[0],.     
-000398d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000398e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000398f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039900: 2020 2020 2020 2073 656c 662e 5f77 6c5f         self._wl_
-00039910: 6d61 7373 5f65 7272 5b31 5d29 290a 2020  mass_err[1])).  
-00039920: 2020 2020 2020 656c 6966 2073 656c 662e        elif self.
-00039930: 5f77 6c5f 6d61 7373 2069 7320 6e6f 7420  _wl_mass is not 
-00039940: 4e6f 6e65 2061 6e64 2073 656c 662e 5f77  None and self._w
-00039950: 6c5f 6d61 7373 5f65 7272 2069 7320 4e6f  l_mass_err is No
-00039960: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00039970: 7072 696e 7428 2257 6561 6b20 4c65 6e73  print("Weak Lens
-00039980: 696e 6720 4d61 7373 202d 207b 307d 222e  ing Mass - {0}".
-00039990: 666f 726d 6174 2873 656c 662e 5f77 6c5f  format(self._wl_
-000399a0: 6d61 7373 2929 0a0a 2020 2020 2020 2020  mass))..        
-000399b0: 6966 2027 6765 745f 7465 6d70 6572 6174  if 'get_temperat
-000399c0: 7572 6527 2069 6e20 6469 7228 7365 6c66  ure' in dir(self
-000399d0: 293a 0a20 2020 2020 2020 2020 2020 2074  ):.            t
-000399e0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-000399f0: 2020 2020 7478 203d 2073 656c 662e 6765      tx = self.ge
-00039a00: 745f 7465 6d70 6572 6174 7572 6528 2772  t_temperature('r
-00039a10: 3530 3027 2c20 2763 6f6e 7374 616e 742a  500', 'constant*
-00039a20: 7462 6162 732a 6170 6563 2729 2e76 616c  tbabs*apec').val
-00039a30: 7565 2e72 6f75 6e64 2832 290a 2020 2020  ue.round(2).    
-00039a40: 2020 2020 2020 2020 2020 2020 2320 4a75              # Ju
-00039a50: 7374 2061 7665 7261 6765 2074 6865 2075  st average the u
-00039a60: 6e63 6572 7461 696e 7479 2066 6f72 2074  ncertainty for t
-00039a70: 6869 730a 2020 2020 2020 2020 2020 2020  his.            
-00039a80: 2020 2020 7072 696e 7428 2252 3530 3020      print("R500 
-00039a90: 5478 202d 207b 307d c2b1 7b31 7d5b 6b65  Tx - {0}..{1}[ke
-00039aa0: 565d 222e 666f 726d 6174 2874 785b 305d  V]".format(tx[0]
-00039ab0: 2c20 7478 5b31 3a5d 2e6d 6561 6e28 292e  , tx[1:].mean().
-00039ac0: 726f 756e 6428 3229 2929 0a20 2020 2020  round(2))).     
-00039ad0: 2020 2020 2020 2065 7863 6570 7420 284d         except (M
-00039ae0: 6f64 656c 4e6f 7441 7373 6f63 6961 7465  odelNotAssociate
-00039af0: 6445 7272 6f72 2c20 4e6f 5072 6f64 7563  dError, NoProduc
-00039b00: 7441 7661 696c 6162 6c65 4572 726f 7229  tAvailableError)
-00039b10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00039b20: 2020 7061 7373 0a0a 2020 2020 2020 2020    pass..        
-00039b30: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00039b40: 2020 2020 2020 2020 206c 7820 3d20 7365           lx = se
-00039b50: 6c66 2e67 6574 5f6c 756d 696e 6f73 6974  lf.get_luminosit
-00039b60: 6965 7328 2772 3530 3027 2c20 2763 6f6e  ies('r500', 'con
-00039b70: 7374 616e 742a 7462 6162 732a 6170 6563  stant*tbabs*apec
-00039b80: 272c 206c 6f5f 656e 3d51 7561 6e74 6974  ', lo_en=Quantit
-00039b90: 7928 302e 352c 2027 6b65 5627 292c 0a20  y(0.5, 'keV'),. 
-00039ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039bc0: 2020 2020 2020 2020 2020 6869 5f65 6e3d            hi_en=
-00039bd0: 5175 616e 7469 7479 2832 2e30 2c20 276b  Quantity(2.0, 'k
-00039be0: 6556 2729 292e 746f 2827 3130 5e34 3420  eV')).to('10^44 
-00039bf0: 6572 672f 7327 292e 7661 6c75 652e 726f  erg/s').value.ro
-00039c00: 756e 6428 3229 0a20 2020 2020 2020 2020  und(2).         
-00039c10: 2020 2020 2020 2070 7269 6e74 2822 5235         print("R5
-00039c20: 3030 2030 2e35 2d32 2e30 6b65 5620 4c78  00 0.5-2.0keV Lx
-00039c30: 202d 207b 307d c2b1 7b31 7d5b 652b 3434   - {0}..{1}[e+44
-00039c40: 2065 7267 2f73 5d22 2e66 6f72 6d61 7428   erg/s]".format(
-00039c50: 6c78 5b30 5d2c 206c 785b 313a 5d2e 6d65  lx[0], lx[1:].me
-00039c60: 616e 2829 2e72 6f75 6e64 2832 2929 290a  an().round(2))).
-00039c70: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-00039c80: 6570 7420 284d 6f64 656c 4e6f 7441 7373  ept (ModelNotAss
-00039c90: 6f63 6961 7465 6445 7272 6f72 2c20 4e6f  ociatedError, No
-00039ca0: 5072 6f64 7563 7441 7661 696c 6162 6c65  ProductAvailable
-00039cb0: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
-00039cc0: 2020 2020 2020 2020 7061 7373 0a20 2020          pass.   
-00039cd0: 2020 2020 2070 7269 6e74 2822 2d2d 2d2d       print("----
-00039ce0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00039cf0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00039d00: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00039d10: 2d5c 6e22 290a 0a20 2020 2064 6566 205f  -\n")..    def _
-00039d20: 5f6c 656e 5f5f 2873 656c 6629 202d 3e20  _len__(self) -> 
-00039d30: 696e 743a 0a20 2020 2020 2020 2022 2222  int:.        """
-00039d40: 0a20 2020 2020 2020 204d 6574 686f 6420  .        Method 
-00039d50: 746f 2072 6574 7572 6e20 7468 6520 6c65  to return the le
-00039d60: 6e67 7468 206f 6620 7468 6520 7072 6f64  ngth of the prod
-00039d70: 7563 7473 2064 6963 7469 6f6e 6172 7920  ucts dictionary 
-00039d80: 2877 6869 6368 206d 6561 6e73 2074 6865  (which means the
-00039d90: 206e 756d 6265 7220 6f66 0a20 2020 2020   number of.     
-00039da0: 2020 2069 6e64 6976 6964 7561 6c20 4f62     individual Ob
-00039db0: 7349 4473 2061 7373 6f63 6961 7465 6420  sIDs associated 
-00039dc0: 7769 7468 2074 6869 7320 736f 7572 6365  with this source
-00039dd0: 292c 2077 6865 6e20 6c65 6e28 2920 6973  ), when len() is
-00039de0: 2063 616c 6c65 6420 6f6e 2061 6e20 696e   called on an in
-00039df0: 7374 616e 6365 206f 6620 7468 6973 2063  stance of this c
-00039e00: 6c61 7373 2e0a 0a20 2020 2020 2020 203a  lass...        :
-00039e10: 7265 7475 726e 3a20 5468 6520 696e 7465  return: The inte
-00039e20: 6765 7220 6c65 6e67 7468 206f 6620 7468  ger length of th
-00039e30: 6520 746f 7020 6c65 7665 6c20 6f66 2074  e top level of t
-00039e40: 6865 205f 7072 6f64 7563 7473 206e 6573  he _products nes
-00039e50: 7465 6420 6469 6374 696f 6e61 7279 2e0a  ted dictionary..
-00039e60: 2020 2020 2020 2020 3a72 7479 7065 3a20          :rtype: 
-00039e70: 696e 740a 2020 2020 2020 2020 2222 220a  int.        """.
-00039e80: 2020 2020 2020 2020 7265 7475 726e 206c          return l
-00039e90: 656e 2873 656c 662e 6f62 735f 6964 7329  en(self.obs_ids)
-00039ea0: 0a0a 0a23 2057 6173 2067 6f69 6e67 2074  ...# Was going t
-00039eb0: 6f20 7772 6974 6520 7468 6973 2061 7320  o write this as 
-00039ec0: 6120 7375 6263 6c61 7373 206f 6620 4261  a subclass of Ba
-00039ed0: 7365 536f 7572 6365 2c20 6173 2069 7420  seSource, as it 
-00039ee0: 7769 6c6c 2062 6568 6176 6520 6c61 7267  will behave larg
-00039ef0: 656c 7920 7468 6520 7361 6d65 2c20 6275  ely the same, bu
-00039f00: 7420 4920 646f 6e27 740a 2320 2077 616e  t I don't.#  wan
-00039f10: 7420 6974 2064 6563 6c61 7269 6e67 2058  t it declaring X
-00039f20: 4741 2070 726f 6475 6374 7320 666f 7220  GA products for 
-00039f30: 7465 6e73 206f 6620 7468 6f75 7361 6e64  tens of thousand
-00039f40: 7320 6f66 2069 6d61 6765 7320 6574 632e  s of images etc.
-00039f50: 0a23 2041 7320 7375 6368 2077 696c 6c20  .# As such will 
-00039f60: 7265 706c 6963 6174 6520 7468 6520 6261  replicate the ba
-00039f70: 7365 2066 756e 6374 696f 6e61 6c69 7479  se functionality
-00039f80: 206f 6620 4261 7365 536f 7572 6365 2074   of BaseSource t
-00039f90: 6861 7420 7769 6c6c 2061 6c6c 6f77 2065  hat will allow e
-00039fa0: 7673 656c 6563 745f 696d 6167 652c 2065  vselect_image, e
-00039fb0: 7870 6d61 702c 2063 6966 6275 696c 640a  xpmap, cifbuild.
-00039fc0: 2320 5341 5320 7772 6170 7065 7273 2074  # SAS wrappers t
-00039fd0: 6f20 776f 726b 2e0a 2320 5468 6973 2064  o work..# This d
-00039fe0: 6f65 7320 6861 7665 2061 206c 6f74 206f  oes have a lot o
-00039ff0: 6620 7374 7261 6967 6874 2063 6f70 6965  f straight copie
-0003a000: 6420 636f 6465 2066 726f 6d20 4261 7365  d code from Base
-0003a010: 536f 7572 6365 2c20 6275 7420 4920 646f  Source, but I do
-0003a020: 6e27 7420 6d69 6e64 2069 6e20 7468 6973  n't mind in this
-0003a030: 2069 6e73 7461 6e63 650a 636c 6173 7320   instance.class 
-0003a040: 4e75 6c6c 536f 7572 6365 3a0a 2020 2020  NullSource:.    
-0003a050: 2222 220a 2020 2020 4120 7573 6566 756c  """.    A useful
-0003a060: 2c20 6275 7420 7665 7279 206c 696d 6974  , but very limit
-0003a070: 6564 2c20 736f 7572 6365 2063 6c61 7373  ed, source class
-0003a080: 2e20 4279 2064 6566 6175 6c74 2074 6869  . By default thi
-0003a090: 7320 736f 7572 6365 2063 6c61 7373 2077  s source class w
-0003a0a0: 696c 6c20 696e 636c 7564 6520 616c 6c20  ill include all 
-0003a0b0: 4f62 7349 4473 2070 7265 7365 6e74 2069  ObsIDs present i
-0003a0c0: 6e20 7468 650a 2020 2020 5847 4120 6365  n the.    XGA ce
-0003a0d0: 6e73 7573 2c20 616e 6420 6173 2073 7563  nsus, and as suc
-0003a0e0: 6820 6361 6e20 6265 2075 7365 6420 666f  h can be used fo
-0003a0f0: 7220 6275 6c6b 2067 656e 6572 6174 696f  r bulk generatio
-0003a100: 6e20 6f66 2053 4153 2070 726f 6475 6374  n of SAS product
-0003a110: 732e 2049 7420 6361 6e20 616c 736f 2062  s. It can also b
-0003a120: 6520 6d61 6465 2074 6f20 6f6e 6c79 2069  e made to only i
-0003a130: 6e63 6c75 6465 0a20 2020 2063 6572 7461  nclude.    certa
-0003a140: 696e 204f 6273 4944 732e 0a0a 0a20 2020  in ObsIDs....   
-0003a150: 203a 7061 7261 6d20 4c69 7374 206f 6273   :param List obs
-0003a160: 3a20 416e 206f 7074 696f 6e61 6c20 6c69  : An optional li
-0003a170: 7374 206f 6620 4f62 7349 4473 2074 6f20  st of ObsIDs to 
-0003a180: 696e 636c 7564 6520 696e 2074 6865 204e  include in the N
-0003a190: 756c 6c53 6f75 7263 652c 206f 7468 6572  ullSource, other
-0003a1a0: 7769 7365 2061 6c6c 2061 7661 696c 6162  wise all availab
-0003a1b0: 6c65 204f 6273 4944 730a 2020 2020 2020  le ObsIDs.      
-0003a1c0: 2020 7769 6c6c 2062 6520 696e 636c 7564    will be includ
-0003a1d0: 6564 2e0a 2020 2020 2222 220a 2020 2020  ed..    """.    
-0003a1e0: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
-0003a1f0: 662c 206f 6273 3a20 4c69 7374 5b73 7472  f, obs: List[str
-0003a200: 5d20 3d20 4e6f 6e65 293a 0a20 2020 2020  ] = None):.     
-0003a210: 2020 2022 2222 0a20 2020 2020 2020 2054     """.        T
-0003a220: 6865 206d 6574 686f 6420 7573 6564 2074  he method used t
-0003a230: 6f20 696e 6974 6961 7465 2074 6865 204e  o initiate the N
-0003a240: 756c 6c53 6f75 7263 6520 636c 6173 732e  ullSource class.
-0003a250: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0003a260: 2020 2020 2023 2054 6f20 6669 6e64 2061       # To find a
-0003a270: 6c6c 2063 656e 7375 7320 656e 7472 6965  ll census entrie
-0003a280: 7320 7769 7468 206e 6f6e 2d6e 6120 636f  s with non-na co
-0003a290: 6f72 6469 6e61 7465 730a 2020 2020 2020  ordinates.      
-0003a2a0: 2020 636c 6561 6e65 645f 6365 6e73 7573    cleaned_census
-0003a2b0: 203d 2043 454e 5355 532e 6472 6f70 6e61   = CENSUS.dropna
-0003a2c0: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
-0003a2d0: 5f72 615f 6465 6320 3d20 6e70 2e61 7272  _ra_dec = np.arr
-0003a2e0: 6179 285b 4e6f 6e65 2c20 4e6f 6e65 5d29  ay([None, None])
-0003a2f0: 0a20 2020 2020 2020 2023 2054 6865 2075  .        # The u
-0003a300: 7365 7220 6361 6e20 7370 6563 6966 7920  ser can specify 
-0003a310: 4f62 7349 4473 2074 6f20 6173 736f 6369  ObsIDs to associ
-0003a320: 6174 6520 7769 7468 2074 6865 204e 756c  ate with the Nul
-0003a330: 6c53 6f75 7263 652c 206f 7220 6173 736f  lSource, or asso
-0003a340: 6369 6174 6520 616c 6c0a 2020 2020 2020  ciate all.      
-0003a350: 2020 2320 206f 6620 7468 656d 2062 7920    #  of them by 
-0003a360: 6c65 6176 696e 6720 6974 2061 7320 4e6f  leaving it as No
-0003a370: 6e65 0a20 2020 2020 2020 2069 6620 6f62  ne.        if ob
-0003a380: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
-0003a390: 2020 2020 2020 2073 656c 662e 5f6e 616d         self._nam
-0003a3a0: 6520 3d20 2241 6c6c 4f62 7365 7276 6174  e = "AllObservat
-0003a3b0: 696f 6e73 220a 2020 2020 2020 2020 2020  ions".          
-0003a3c0: 2020 6f62 7320 3d20 636c 6561 6e65 645f    obs = cleaned_
-0003a3d0: 6365 6e73 7573 5b22 4f62 7349 4422 5d2e  census["ObsID"].
-0003a3e0: 7661 6c75 6573 0a20 2020 2020 2020 2065  values.        e
-0003a3f0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0003a400: 2023 2049 206b 6e6f 7720 7468 6973 2069   # I know this i
-0003a410: 7320 616e 2075 676c 7920 6e65 7374 6564  s an ugly nested
-0003a420: 2069 6620 7374 6174 656d 656e 7473 2c20   if statements, 
-0003a430: 6275 7420 4920 6f6e 6c79 2077 616e 7465  but I only wante
-0003a440: 6420 746f 2072 756e 206f 6273 5f63 6865  d to run obs_che
-0003a450: 636b 206f 6e63 650a 2020 2020 2020 2020  ck once.        
-0003a460: 2020 2020 6f62 7320 3d20 6e70 2e61 7272      obs = np.arr
-0003a470: 6179 286f 6273 290a 2020 2020 2020 2020  ay(obs).        
-0003a480: 2020 2020 6f62 735f 6368 6563 6b20 3d20      obs_check = 
-0003a490: 5b6f 2069 6e20 636c 6561 6e65 645f 6365  [o in cleaned_ce
-0003a4a0: 6e73 7573 5b22 4f62 7349 4422 5d2e 7661  nsus["ObsID"].va
-0003a4b0: 6c75 6573 2066 6f72 206f 2069 6e20 6f62  lues for o in ob
-0003a4c0: 735d 0a20 2020 2020 2020 2020 2020 2023  s].            #
-0003a4d0: 2049 6620 616c 6c20 7573 6572 2065 6e74   If all user ent
-0003a4e0: 6572 6564 204f 6273 4944 7320 6172 6520  ered ObsIDs are 
-0003a4f0: 696e 2074 6865 2063 656e 7375 732c 2074  in the census, t
-0003a500: 6865 6e20 616c 6c20 6973 2066 696e 650a  hen all is fine.
-0003a510: 2020 2020 2020 2020 2020 2020 6966 2061              if a
-0003a520: 6c6c 286f 6273 5f63 6865 636b 293a 0a20  ll(obs_check):. 
-0003a530: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0003a540: 656c 662e 5f6e 616d 6520 3d20 227b 7d4f  elf._name = "{}O
-0003a550: 6273 6572 7661 7469 6f6e 7322 2e66 6f72  bservations".for
-0003a560: 6d61 7428 6c65 6e28 6f62 7329 290a 2020  mat(len(obs)).  
-0003a570: 2020 2020 2020 2020 2020 2320 4966 2074            # If t
-0003a580: 6865 7920 6172 656e 2774 2061 6c6c 2069  hey aren't all i
-0003a590: 6e20 7468 6520 6365 6e73 7573 2074 6865  n the census the
-0003a5a0: 6e20 7468 6174 2069 7320 6465 6369 6465  n that is decide
-0003a5b0: 646c 7920 6e6f 7420 6669 6e65 0a20 2020  dly not fine.   
-0003a5c0: 2020 2020 2020 2020 2065 6c69 6620 6e6f           elif no
-0003a5d0: 7420 616c 6c28 6f62 735f 6368 6563 6b29  t all(obs_check)
-0003a5e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0003a5f0: 2020 6e6f 745f 7661 6c69 6420 3d20 6e70    not_valid = np
-0003a600: 2e61 7272 6179 286f 6273 295b 7e6e 702e  .array(obs)[~np.
-0003a610: 6172 7261 7928 6f62 735f 6368 6563 6b29  array(obs_check)
-0003a620: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0003a630: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
-0003a640: 6f72 2822 5468 6520 666f 6c6c 6f77 696e  or("The followin
-0003a650: 6720 6172 6520 6e6f 7420 7072 6573 656e  g are not presen
-0003a660: 7420 696e 2074 6865 2058 4741 2063 656e  t in the XGA cen
-0003a670: 7375 732c 2022 0a20 2020 2020 2020 2020  sus, ".         
-0003a680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a690: 2020 2020 2020 2020 227b 7d22 2e66 6f72          "{}".for
-0003a6a0: 6d61 7428 222c 2022 2e6a 6f69 6e28 6e6f  mat(", ".join(no
-0003a6b0: 745f 7661 6c69 6429 2929 0a0a 2020 2020  t_valid)))..    
-0003a6c0: 2020 2020 2320 4669 6e64 206f 7574 2077      # Find out w
-0003a6d0: 6869 6368 0a20 2020 2020 2020 2069 6e73  hich.        ins
-0003a6e0: 7472 756d 656e 7473 203d 207b 6f3a 205b  truments = {o: [
-0003a6f0: 5d20 666f 7220 6f20 696e 206f 6273 7d0a  ] for o in obs}.
-0003a700: 2020 2020 2020 2020 666f 7220 6f20 696e          for o in
-0003a710: 206f 6273 3a0a 2020 2020 2020 2020 2020   obs:.          
-0003a720: 2020 6966 2063 6c65 616e 6564 5f63 656e    if cleaned_cen
-0003a730: 7375 735b 636c 6561 6e65 645f 6365 6e73  sus[cleaned_cens
-0003a740: 7573 5b22 4f62 7349 4422 5d20 3d3d 206f  us["ObsID"] == o
-0003a750: 5d5b 2255 5345 5f50 4e22 5d2e 7661 6c75  ]["USE_PN"].valu
-0003a760: 6573 5b30 5d3a 0a20 2020 2020 2020 2020  es[0]:.         
-0003a770: 2020 2020 2020 2069 6e73 7472 756d 656e         instrumen
-0003a780: 7473 5b6f 5d2e 6170 7065 6e64 2822 706e  ts[o].append("pn
-0003a790: 2229 0a20 2020 2020 2020 2020 2020 2069  ").            i
-0003a7a0: 6620 636c 6561 6e65 645f 6365 6e73 7573  f cleaned_census
-0003a7b0: 5b63 6c65 616e 6564 5f63 656e 7375 735b  [cleaned_census[
-0003a7c0: 224f 6273 4944 225d 203d 3d20 6f5d 5b22  "ObsID"] == o]["
-0003a7d0: 5553 455f 4d4f 5331 225d 2e76 616c 7565  USE_MOS1"].value
-0003a7e0: 735b 305d 3a0a 2020 2020 2020 2020 2020  s[0]:.          
-0003a7f0: 2020 2020 2020 696e 7374 7275 6d65 6e74        instrument
-0003a800: 735b 6f5d 2e61 7070 656e 6428 226d 6f73  s[o].append("mos
-0003a810: 3122 290a 2020 2020 2020 2020 2020 2020  1").            
-0003a820: 6966 2063 6c65 616e 6564 5f63 656e 7375  if cleaned_censu
-0003a830: 735b 636c 6561 6e65 645f 6365 6e73 7573  s[cleaned_census
-0003a840: 5b22 4f62 7349 4422 5d20 3d3d 206f 5d5b  ["ObsID"] == o][
-0003a850: 2255 5345 5f4d 4f53 3222 5d2e 7661 6c75  "USE_MOS2"].valu
-0003a860: 6573 5b30 5d3a 0a20 2020 2020 2020 2020  es[0]:.         
-0003a870: 2020 2020 2020 2069 6e73 7472 756d 656e         instrumen
-0003a880: 7473 5b6f 5d2e 6170 7065 6e64 2822 6d6f  ts[o].append("mo
-0003a890: 7332 2229 0a0a 2020 2020 2020 2020 2320  s2")..        # 
-0003a8a0: 5468 6973 2063 6865 636b 7320 7468 6174  This checks that
-0003a8b0: 2074 6865 206f 6273 6572 7661 7469 6f6e   the observation
-0003a8c0: 7320 6861 7665 2061 7420 6c65 6173 7420  s have at least 
-0003a8d0: 6f6e 6520 7573 6162 6c65 2069 6e73 7472  one usable instr
-0003a8e0: 756d 656e 740a 2020 2020 2020 2020 7365  ument.        se
-0003a8f0: 6c66 2e5f 6f62 7320 3d20 5b6f 2066 6f72  lf._obs = [o for
-0003a900: 206f 2069 6e20 6f62 7320 6966 206c 656e   o in obs if len
-0003a910: 2869 6e73 7472 756d 656e 7473 5b6f 5d29  (instruments[o])
-0003a920: 203e 2030 5d0a 2020 2020 2020 2020 7365   > 0].        se
-0003a930: 6c66 2e5f 696e 7374 7275 6d65 6e74 7320  lf._instruments 
-0003a940: 3d20 7b6f 3a20 696e 7374 7275 6d65 6e74  = {o: instrument
-0003a950: 735b 6f5d 2066 6f72 206f 2069 6e20 7365  s[o] for o in se
-0003a960: 6c66 2e5f 6f62 7320 6966 206c 656e 2869  lf._obs if len(i
-0003a970: 6e73 7472 756d 656e 7473 5b6f 5d29 203e  nstruments[o]) >
-0003a980: 2030 7d0a 0a20 2020 2020 2020 2023 2048   0}..        # H
-0003a990: 6572 6520 7765 2063 6865 636b 2074 6f20  ere we check to 
-0003a9a0: 6d61 6b65 2073 7572 6520 7468 6174 2074  make sure that t
-0003a9b0: 6865 7265 2069 7320 6174 206c 6561 7374  here is at least
-0003a9c0: 206f 6e65 2076 616c 6964 204f 6273 4944   one valid ObsID
-0003a9d0: 2072 656d 6169 6e69 6e67 0a20 2020 2020   remaining.     
-0003a9e0: 2020 2069 6620 6c65 6e28 7365 6c66 2e5f     if len(self._
-0003a9f0: 6f62 7329 203d 3d20 303a 0a20 2020 2020  obs) == 0:.     
-0003aa00: 2020 2020 2020 2072 6169 7365 204e 6f56         raise NoV
-0003aa10: 616c 6964 4f62 7365 7276 6174 696f 6e73  alidObservations
-0003aa20: 4572 726f 7228 2241 6674 6572 2063 6865  Error("After che
-0003aa30: 636b 7320 7573 696e 6720 7468 6520 5847  cks using the XG
-0003aa40: 4120 6365 6e73 7573 2c20 616c 6c20 4f62  A census, all Ob
-0003aa50: 7349 4473 2061 7373 6f63 6961 7465 6420  sIDs associated 
-0003aa60: 7769 7468 2074 6869 7320 220a 2020 2020  with this ".    
-0003aa70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003aa80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003aa90: 2020 2020 2020 2022 4e75 6c6c 536f 7572         "NullSour
-0003aaa0: 6365 2061 7265 2063 6f6e 7369 6465 7265  ce are considere
-0003aab0: 6420 756e 7573 6162 6c65 2e22 290a 0a20  d unusable.").. 
-0003aac0: 2020 2020 2020 2023 2054 6865 2053 4153         # The SAS
-0003aad0: 2067 656e 6572 6174 696f 6e20 726f 7574   generation rout
-0003aae0: 696e 6520 6d69 6768 7420 6e65 6564 2074  ine might need t
-0003aaf0: 6869 7320 696e 666f 726d 6174 696f 6e0a  his information.
-0003ab00: 2020 2020 2020 2020 7365 6c66 2e5f 6174          self._at
-0003ab10: 745f 6669 6c65 7320 3d20 7b6f 3a20 7867  t_files = {o: xg
-0003ab20: 615f 636f 6e66 5b22 584d 4d5f 4649 4c45  a_conf["XMM_FILE
-0003ab30: 5322 5d5b 2261 7474 6974 7564 655f 6669  S"]["attitude_fi
-0003ab40: 6c65 225d 2e66 6f72 6d61 7428 6f62 735f  le"].format(obs_
-0003ab50: 6964 3d6f 2920 666f 7220 6f20 696e 2073  id=o) for o in s
-0003ab60: 656c 662e 5f6f 6273 7d0a 0a20 2020 2020  elf._obs}..     
-0003ab70: 2020 2023 204e 6565 6420 7468 6520 6576     # Need the ev
-0003ab80: 656e 7420 6c69 7374 206f 626a 6563 7473  ent list objects
-0003ab90: 2064 6563 6c61 7265 6420 756e 666f 7274   declared unfort
-0003aba0: 756e 6174 656c 790a 2020 2020 2020 2020  unately.        
-0003abb0: 7365 6c66 2e5f 7072 6f64 7563 7473 203d  self._products =
-0003abc0: 207b 6f3a 207b 7d20 666f 7220 6f20 696e   {o: {} for o in
-0003abd0: 2073 656c 662e 5f6f 6273 7d0a 2020 2020   self._obs}.    
-0003abe0: 2020 2020 666f 7220 6f20 696e 2073 656c      for o in sel
-0003abf0: 662e 5f6f 6273 3a0a 2020 2020 2020 2020  f._obs:.        
-0003ac00: 2020 2020 666f 7220 696e 7374 2069 6e20      for inst in 
-0003ac10: 7365 6c66 2e5f 696e 7374 7275 6d65 6e74  self._instrument
-0003ac20: 735b 6f5d 3a0a 2020 2020 2020 2020 2020  s[o]:.          
-0003ac30: 2020 2020 2020 6576 745f 6b65 7920 3d20        evt_key = 
-0003ac40: 2263 6c65 616e 5f7b 7d5f 6576 7473 222e  "clean_{}_evts".
-0003ac50: 666f 726d 6174 2869 6e73 7429 0a20 2020  format(inst).   
-0003ac60: 2020 2020 2020 2020 2020 2020 2065 7674               evt
-0003ac70: 5f66 696c 6520 3d20 7867 615f 636f 6e66  _file = xga_conf
-0003ac80: 5b22 584d 4d5f 4649 4c45 5322 5d5b 6576  ["XMM_FILES"][ev
-0003ac90: 745f 6b65 795d 2e66 6f72 6d61 7428 6f62  t_key].format(ob
-0003aca0: 735f 6964 3d6f 290a 2020 2020 2020 2020  s_id=o).        
-0003acb0: 2020 2020 2020 2020 7365 6c66 2e5f 7072          self._pr
-0003acc0: 6f64 7563 7473 5b6f 5d5b 696e 7374 5d20  oducts[o][inst] 
-0003acd0: 3d20 7b22 6576 656e 7473 223a 2045 7665  = {"events": Eve
-0003ace0: 6e74 4c69 7374 2865 7674 5f66 696c 652c  ntList(evt_file,
-0003acf0: 206f 6273 5f69 643d 6f2c 2069 6e73 7472   obs_id=o, instr
-0003ad00: 756d 656e 743d 696e 7374 2c20 7374 646f  ument=inst, stdo
-0003ad10: 7574 5f73 7472 3d22 222c 0a20 2020 2020  ut_str="",.     
-0003ad20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ad30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ad40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ad50: 2020 2020 2020 2020 2020 7374 6465 7272            stderr
-0003ad60: 5f73 7472 3d22 222c 2067 656e 5f63 6d64  _str="", gen_cmd
-0003ad70: 3d22 2229 7d0a 0a20 2020 2020 2020 2023  ="")}..        #
-0003ad80: 2054 6869 7320 6973 2061 2071 7565 7565   This is a queue
-0003ad90: 2066 6f72 2070 726f 6475 6374 7320 746f   for products to
-0003ada0: 2062 6520 6765 6e65 7261 7465 6420 666f   be generated fo
-0003adb0: 7220 7468 6973 2073 6f75 7263 652c 2077  r this source, w
-0003adc0: 696c 6c20 6265 2061 206e 756d 7079 2061  ill be a numpy a
-0003add0: 7272 6179 2069 6e20 7072 6163 7469 7365  rray in practise
-0003ade0: 2e0a 2020 2020 2020 2020 2320 4974 656d  ..        # Item
-0003adf0: 7320 696e 2074 6865 2073 616d 6520 726f  s in the same ro
-0003ae00: 7720 7769 6c6c 2061 6c6c 2062 6520 6765  w will all be ge
-0003ae10: 6e65 7261 7465 6420 696e 2070 6172 616c  nerated in paral
-0003ae20: 6c65 6c2c 2077 6865 7265 6173 2069 7465  lel, whereas ite
-0003ae30: 6d73 2069 6e20 7468 6520 7361 6d65 2063  ms in the same c
-0003ae40: 6f6c 756d 6e20 7769 6c6c 0a20 2020 2020  olumn will.     
-0003ae50: 2020 2023 2062 6520 636f 6d62 696e 6564     # be combined
-0003ae60: 2069 6e74 6f20 6120 636f 6d6d 616e 6420   into a command 
-0003ae70: 7374 6163 6b20 616e 6420 7275 6e20 696e  stack and run in
-0003ae80: 206f 7264 6572 2e0a 2020 2020 2020 2020   order..        
-0003ae90: 7365 6c66 2e71 7565 7565 203d 204e 6f6e  self.queue = Non
-0003aea0: 650a 2020 2020 2020 2020 2320 416e 6f74  e.        # Anot
-0003aeb0: 6865 7220 6174 7472 6962 7574 6520 6465  her attribute de
-0003aec0: 7374 696e 6564 2074 6f20 6265 2061 6e20  stined to be an 
-0003aed0: 6172 7261 792c 2077 696c 6c20 636f 6e74  array, will cont
-0003aee0: 6169 6e20 7468 6520 6f75 7470 7574 2074  ain the output t
-0003aef0: 7970 6520 6f66 2065 6163 6820 636f 6d6d  ype of each comm
-0003af00: 616e 6420 7375 626d 6974 7465 6420 746f  and submitted to
-0003af10: 0a20 2020 2020 2020 2023 2074 6865 2071  .        # the q
-0003af20: 7565 7565 2061 7272 6179 2e0a 2020 2020  ueue array..    
-0003af30: 2020 2020 7365 6c66 2e71 7565 7565 5f74      self.queue_t
-0003af40: 7970 6520 3d20 4e6f 6e65 0a20 2020 2020  ype = None.     
-0003af50: 2020 2023 2054 6869 7320 636f 6e74 6169     # This contai
-0003af60: 6e73 2061 6e20 6172 7261 7920 6f66 2074  ns an array of t
-0003af70: 6865 2070 6174 6873 206f 6620 7468 6520  he paths of the 
-0003af80: 6669 6e61 6c20 6f75 7470 7574 206f 6620  final output of 
-0003af90: 6561 6368 2063 6f6d 6d61 6e64 2069 6e20  each command in 
-0003afa0: 7468 6520 7175 6575 650a 2020 2020 2020  the queue.      
-0003afb0: 2020 7365 6c66 2e71 7565 7565 5f70 6174    self.queue_pat
-0003afc0: 6820 3d20 4e6f 6e65 0a20 2020 2020 2020  h = None.       
-0003afd0: 2023 2054 6869 7320 636f 6e74 6169 6e73   # This contains
-0003afe0: 2061 6e20 6172 7261 7920 6f66 2074 6865   an array of the
-0003aff0: 2065 7874 7261 2069 6e66 6f72 6d61 7469   extra informati
-0003b000: 6f6e 206e 6565 6465 6420 746f 2069 6e73  on needed to ins
-0003b010: 7461 6e74 6961 7465 2063 6c61 7373 0a20  tantiate class. 
-0003b020: 2020 2020 2020 2023 2061 6674 6572 2074         # after t
-0003b030: 6865 2053 4153 2063 6f6d 6d61 6e64 2068  he SAS command h
-0003b040: 6173 2072 756e 0a20 2020 2020 2020 2073  as run.        s
-0003b050: 656c 662e 7175 6575 655f 6578 7472 615f  elf.queue_extra_
-0003b060: 696e 666f 203d 204e 6f6e 650a 0a20 2020  info = None..   
-0003b070: 2064 6566 2067 6574 5f61 7474 5f66 696c   def get_att_fil
-0003b080: 6528 7365 6c66 2c20 6f62 735f 6964 3a20  e(self, obs_id: 
-0003b090: 7374 7229 202d 3e20 7374 723a 0a20 2020  str) -> str:.   
-0003b0a0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-0003b0b0: 2046 6574 6368 6573 2074 6865 2070 6174   Fetches the pat
-0003b0c0: 6820 746f 2074 6865 2061 7474 6974 7564  h to the attitud
-0003b0d0: 6520 6669 6c65 2066 6f72 2061 6e20 584d  e file for an XM
-0003b0e0: 4d20 6f62 7365 7276 6174 696f 6e2e 0a0a  M observation...
-0003b0f0: 2020 2020 2020 2020 3a70 6172 616d 206f          :param o
-0003b100: 6273 5f69 643a 2054 6865 204f 6273 4944  bs_id: The ObsID
-0003b110: 2074 6f20 6665 7463 6820 7468 6520 6174   to fetch the at
-0003b120: 7469 7475 6465 2066 696c 6520 666f 722e  titude file for.
-0003b130: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
-0003b140: 3a20 5468 6520 7061 7468 2074 6f20 7468  : The path to th
-0003b150: 6520 6174 7469 7475 6465 2066 696c 652e  e attitude file.
-0003b160: 0a20 2020 2020 2020 203a 7274 7970 653a  .        :rtype:
-0003b170: 2073 7472 0a20 2020 2020 2020 2022 2222   str.        """
-0003b180: 0a20 2020 2020 2020 2069 6620 6f62 735f  .        if obs_
-0003b190: 6964 206e 6f74 2069 6e20 7365 6c66 2e5f  id not in self._
-0003b1a0: 7072 6f64 7563 7473 3a0a 2020 2020 2020  products:.      
-0003b1b0: 2020 2020 2020 7261 6973 6520 4e6f 7441        raise NotA
-0003b1c0: 7373 6f63 6961 7465 6445 7272 6f72 2822  ssociatedError("
-0003b1d0: 7b6f 7d20 6973 206e 6f74 2061 7373 6f63  {o} is not assoc
-0003b1e0: 6961 7465 6420 7769 7468 207b 737d 222e  iated with {s}".
-0003b1f0: 666f 726d 6174 286f 3d6f 6273 5f69 642c  format(o=obs_id,
-0003b200: 2073 3d73 656c 662e 6e61 6d65 2929 0a20   s=self.name)). 
-0003b210: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0003b220: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0003b230: 7365 6c66 2e5f 6174 745f 6669 6c65 735b  self._att_files[
-0003b240: 6f62 735f 6964 5d0a 0a20 2020 2040 7072  obs_id]..    @pr
-0003b250: 6f70 6572 7479 0a20 2020 2064 6566 206f  operty.    def o
-0003b260: 6273 5f69 6473 2873 656c 6629 202d 3e20  bs_ids(self) -> 
-0003b270: 4c69 7374 5b73 7472 5d3a 0a20 2020 2020  List[str]:.     
-0003b280: 2020 2022 2222 0a20 2020 2020 2020 2050     """.        P
-0003b290: 726f 7065 7274 7920 6765 7474 6572 2066  roperty getter f
-0003b2a0: 6f72 204f 6273 4944 7320 6173 736f 6369  or ObsIDs associ
-0003b2b0: 6174 6564 2077 6974 6820 7468 6973 2073  ated with this s
-0003b2c0: 6f75 7263 6520 7468 6174 2061 7265 2063  ource that are c
-0003b2d0: 6f6e 6669 726d 6564 2074 6f20 6861 7665  onfirmed to have
-0003b2e0: 2065 7665 6e74 7320 6669 6c65 732e 0a0a   events files...
-0003b2f0: 2020 2020 2020 2020 3a72 6574 7572 6e3a          :return:
-0003b300: 2041 206c 6973 7420 6f66 2074 6865 2061   A list of the a
-0003b310: 7373 6f63 6961 7465 6420 584d 4d20 4f62  ssociated XMM Ob
-0003b320: 7349 4473 2e0a 2020 2020 2020 2020 3a72  sIDs..        :r
-0003b330: 7479 7065 3a20 4c69 7374 5b73 7472 5d0a  type: List[str].
-0003b340: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-0003b350: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-0003b360: 5f6f 6273 0a0a 2020 2020 4070 726f 7065  _obs..    @prope
-0003b370: 7274 790a 2020 2020 6465 6620 696e 7374  rty.    def inst
-0003b380: 7275 6d65 6e74 7328 7365 6c66 2920 2d3e  ruments(self) ->
-0003b390: 2044 6963 743a 0a20 2020 2020 2020 2022   Dict:.        "
-0003b3a0: 2222 0a20 2020 2020 2020 2041 2070 726f  "".        A pro
-0003b3b0: 7065 7274 7920 6f66 2061 2073 6f75 7263  perty of a sourc
-0003b3c0: 6520 7468 6174 2064 6574 6169 6c73 2077  e that details w
-0003b3d0: 6869 6368 2069 6e73 7472 756d 656e 7473  hich instruments
-0003b3e0: 2068 6176 6520 7661 6c69 6420 6461 7461   have valid data
-0003b3f0: 2066 6f72 2077 6869 6368 206f 6273 6572   for which obser
-0003b400: 7661 7469 6f6e 732e 0a0a 2020 2020 2020  vations...      
-0003b410: 2020 3a72 6574 7572 6e3a 2041 2064 6963    :return: A dic
-0003b420: 7469 6f6e 6172 7920 6f66 204f 6273 4944  tionary of ObsID
-0003b430: 7320 616e 6420 7468 6569 7220 6173 736f  s and their asso
-0003b440: 6369 6174 6564 2076 616c 6964 2069 6e73  ciated valid ins
-0003b450: 7472 756d 656e 7473 2e0a 2020 2020 2020  truments..      
-0003b460: 2020 3a72 7479 7065 3a20 4469 6374 0a20    :rtype: Dict. 
-0003b470: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0003b480: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
-0003b490: 696e 7374 7275 6d65 6e74 730a 0a20 2020  instruments..   
-0003b4a0: 2064 6566 2075 7064 6174 655f 7175 6575   def update_queu
-0003b4b0: 6528 7365 6c66 2c20 636d 645f 6172 723a  e(self, cmd_arr:
-0003b4c0: 206e 702e 6e64 6172 7261 792c 2070 5f74   np.ndarray, p_t
-0003b4d0: 7970 655f 6172 723a 206e 702e 6e64 6172  ype_arr: np.ndar
-0003b4e0: 7261 792c 2070 5f70 6174 685f 6172 723a  ray, p_path_arr:
-0003b4f0: 206e 702e 6e64 6172 7261 792c 0a20 2020   np.ndarray,.   
-0003b500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b510: 2020 6578 7472 615f 696e 666f 3a20 6e70    extra_info: np
-0003b520: 2e6e 6461 7272 6179 2c20 7374 6163 6b3a  .ndarray, stack:
-0003b530: 2062 6f6f 6c20 3d20 4661 6c73 6529 3a0a   bool = False):.
-0003b540: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-0003b550: 2020 2020 536d 616c 6c20 6675 6e63 7469      Small functi
-0003b560: 6f6e 2074 6f20 7570 6461 7465 2074 6865  on to update the
-0003b570: 206e 756d 7079 2061 7272 6179 2074 6861   numpy array tha
-0003b580: 7420 6d61 6b65 7320 7570 2074 6865 2071  t makes up the q
-0003b590: 7565 7565 206f 6620 7072 6f64 7563 7473  ueue of products
-0003b5a0: 2074 6f20 6265 2067 656e 6572 6174 6564   to be generated
-0003b5b0: 2e0a 0a20 2020 2020 2020 203a 7061 7261  ...        :para
-0003b5c0: 6d20 6e70 2e6e 6461 7272 6179 2063 6d64  m np.ndarray cmd
-0003b5d0: 5f61 7272 3a20 4172 7261 7920 636f 6e74  _arr: Array cont
-0003b5e0: 6169 6e69 6e67 2053 4153 2063 6f6d 6d61  aining SAS comma
-0003b5f0: 6e64 732e 0a20 2020 2020 2020 203a 7061  nds..        :pa
-0003b600: 7261 6d20 6e70 2e6e 6461 7272 6179 2070  ram np.ndarray p
-0003b610: 5f74 7970 655f 6172 723a 2041 7272 6179  _type_arr: Array
-0003b620: 206f 6620 7072 6f64 7563 7420 7479 7065   of product type
-0003b630: 2069 6465 6e74 6966 6965 7273 2066 6f72   identifiers for
-0003b640: 2074 6865 2070 726f 6475 6374 7320 6765   the products ge
-0003b650: 6e65 7261 7465 640a 2020 2020 2020 2020  nerated.        
-0003b660: 2020 2020 6279 2074 6865 2063 6d64 2061      by the cmd a
-0003b670: 7272 6179 2e20 652e 672e 2069 6d61 6765  rray. e.g. image
-0003b680: 206f 7220 6578 706d 6170 2e0a 2020 2020   or expmap..    
-0003b690: 2020 2020 3a70 6172 616d 206e 702e 6e64      :param np.nd
-0003b6a0: 6172 7261 7920 705f 7061 7468 5f61 7272  array p_path_arr
-0003b6b0: 3a20 4172 7261 7920 6f66 2066 696e 616c  : Array of final
-0003b6c0: 2070 726f 6475 6374 2070 6174 6873 2069   product paths i
-0003b6d0: 6620 636d 6420 6973 2073 7563 6365 7373  f cmd is success
-0003b6e0: 6675 6c0a 2020 2020 2020 2020 3a70 6172  ful.        :par
-0003b6f0: 616d 206e 702e 6e64 6172 7261 7920 6578  am np.ndarray ex
-0003b700: 7472 615f 696e 666f 3a20 4172 7261 7920  tra_info: Array 
-0003b710: 6f66 2065 7874 7261 2069 6e66 6f72 6d61  of extra informa
-0003b720: 7469 6f6e 2064 6963 7469 6f6e 6172 6965  tion dictionarie
-0003b730: 730a 2020 2020 2020 2020 3a70 6172 616d  s.        :param
-0003b740: 2073 7461 636b 3a20 5368 6f75 6c64 2074   stack: Should t
-0003b750: 6865 7365 2063 6f6d 6d61 6e64 7320 6265  hese commands be
-0003b760: 2065 7865 6375 7465 6420 6166 7465 7220   executed after 
-0003b770: 6120 7072 6563 6564 696e 6720 6c69 6e65  a preceding line
-0003b780: 206f 6620 636f 6d6d 616e 6473 2c0a 2020   of commands,.  
-0003b790: 2020 2020 2020 2020 2020 6f72 2061 7420            or at 
-0003b7a0: 7468 6520 7361 6d65 2074 696d 652e 0a20  the same time.. 
-0003b7b0: 2020 2020 2020 203a 7265 7475 726e 3a0a         :return:.
-0003b7c0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-0003b7d0: 2020 2020 6966 2073 656c 662e 7175 6575      if self.queu
-0003b7e0: 6520 6973 204e 6f6e 653a 0a20 2020 2020  e is None:.     
-0003b7f0: 2020 2020 2020 2023 2049 2063 6f75 6c64         # I could
-0003b800: 2068 6176 6520 646f 6e65 2061 6c6c 206f   have done all o
-0003b810: 6620 7468 6573 6520 696e 206f 6e65 2061  f these in one a
-0003b820: 7272 6179 2077 6974 6820 3320 6469 6d65  rray with 3 dime
-0003b830: 6e73 696f 6e73 2c20 6275 7420 6665 6c74  nsions, but felt
-0003b840: 2074 6869 7320 7761 7320 6561 7369 6572   this was easier
-0003b850: 2074 6f20 7265 6164 0a20 2020 2020 2020   to read.       
-0003b860: 2020 2020 2023 2061 6e64 2077 6974 6820       # and with 
-0003b870: 6e6f 2072 6561 6c20 7065 7266 6f72 6d61  no real performa
-0003b880: 6e63 6520 7065 6e61 6c74 790a 2020 2020  nce penalty.    
-0003b890: 2020 2020 2020 2020 7365 6c66 2e71 7565          self.que
-0003b8a0: 7565 203d 2063 6d64 5f61 7272 0a20 2020  ue = cmd_arr.   
-0003b8b0: 2020 2020 2020 2020 2073 656c 662e 7175           self.qu
-0003b8c0: 6575 655f 7479 7065 203d 2070 5f74 7970  eue_type = p_typ
-0003b8d0: 655f 6172 720a 2020 2020 2020 2020 2020  e_arr.          
-0003b8e0: 2020 7365 6c66 2e71 7565 7565 5f70 6174    self.queue_pat
-0003b8f0: 6820 3d20 705f 7061 7468 5f61 7272 0a20  h = p_path_arr. 
-0003b900: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0003b910: 7175 6575 655f 6578 7472 615f 696e 666f  queue_extra_info
-0003b920: 203d 2065 7874 7261 5f69 6e66 6f0a 2020   = extra_info.  
-0003b930: 2020 2020 2020 656c 6966 2073 7461 636b        elif stack
-0003b940: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-0003b950: 6c66 2e71 7565 7565 203d 206e 702e 7673  lf.queue = np.vs
-0003b960: 7461 636b 2828 7365 6c66 2e71 7565 7565  tack((self.queue
-0003b970: 2c20 636d 645f 6172 7229 290a 2020 2020  , cmd_arr)).    
-0003b980: 2020 2020 2020 2020 7365 6c66 2e71 7565          self.que
-0003b990: 7565 5f74 7970 6520 3d20 6e70 2e76 7374  ue_type = np.vst
-0003b9a0: 6163 6b28 2873 656c 662e 7175 6575 655f  ack((self.queue_
-0003b9b0: 7479 7065 2c20 705f 7479 7065 5f61 7272  type, p_type_arr
-0003b9c0: 2929 0a20 2020 2020 2020 2020 2020 2073  )).            s
-0003b9d0: 656c 662e 7175 6575 655f 7061 7468 203d  elf.queue_path =
-0003b9e0: 206e 702e 7673 7461 636b 2828 7365 6c66   np.vstack((self
-0003b9f0: 2e71 7565 7565 5f70 6174 682c 2070 5f70  .queue_path, p_p
-0003ba00: 6174 685f 6172 7229 290a 2020 2020 2020  ath_arr)).      
-0003ba10: 2020 2020 2020 7365 6c66 2e71 7565 7565        self.queue
-0003ba20: 5f65 7874 7261 5f69 6e66 6f20 3d20 6e70  _extra_info = np
-0003ba30: 2e76 7374 6163 6b28 2873 656c 662e 7175  .vstack((self.qu
-0003ba40: 6575 655f 6578 7472 615f 696e 666f 2c20  eue_extra_info, 
-0003ba50: 6578 7472 615f 696e 666f 2929 0a20 2020  extra_info)).   
-0003ba60: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0003ba70: 2020 2020 2020 2073 656c 662e 7175 6575         self.queu
-0003ba80: 6520 3d20 6e70 2e61 7070 656e 6428 7365  e = np.append(se
-0003ba90: 6c66 2e71 7565 7565 2c20 636d 645f 6172  lf.queue, cmd_ar
-0003baa0: 722c 2061 7869 733d 3029 0a20 2020 2020  r, axis=0).     
+0002bbe0: 6973 2074 6865 2050 5346 206d 6f64 656c  is the PSF model
+0002bbf0: 2075 7365 642e 0a20 2020 2020 2020 203a   used..        :
+0002bc00: 7061 7261 6d20 696e 7420 7073 665f 6269  param int psf_bi
+0002bc10: 6e73 3a20 4966 2074 6865 2069 6d61 6765  ns: If the image
+0002bc20: 732f 7261 7465 6d61 7073 2079 6f75 2077  s/ratemaps you w
+0002bc30: 616e 7420 6172 6520 5053 4620 636f 7272  ant are PSF corr
+0002bc40: 6563 7465 642c 2074 6869 7320 6973 2074  ected, this is t
+0002bc50: 6865 206e 756d 6265 7220 6f66 2050 5346  he number of PSF
+0002bc60: 7320 7065 720a 2020 2020 2020 2020 2020  s per.          
+0002bc70: 2020 7369 6465 2069 6e20 7468 6520 5053    side in the PS
+0002bc80: 4620 6772 6964 2e0a 2020 2020 2020 2020  F grid..        
+0002bc90: 3a70 6172 616d 2073 7472 2070 7366 5f61  :param str psf_a
+0002bca0: 6c67 6f3a 2049 6620 7468 6520 696d 6167  lgo: If the imag
+0002bcb0: 6573 2f72 6174 656d 6170 7320 796f 7520  es/ratemaps you 
+0002bcc0: 7761 6e74 2061 7265 2050 5346 2063 6f72  want are PSF cor
+0002bcd0: 7265 6374 6564 2c20 7468 6973 2069 7320  rected, this is 
+0002bce0: 7468 6520 616c 676f 7269 7468 6d20 7573  the algorithm us
+0002bcf0: 6564 2e0a 2020 2020 2020 2020 3a70 6172  ed..        :par
+0002bd00: 616d 2069 6e74 2070 7366 5f69 7465 723a  am int psf_iter:
+0002bd10: 2049 6620 7468 6520 696d 6167 6573 2f72   If the images/r
+0002bd20: 6174 656d 6170 7320 796f 7520 7761 6e74  atemaps you want
+0002bd30: 2061 7265 2050 5346 2063 6f72 7265 6374   are PSF correct
+0002bd40: 6564 2c20 7468 6973 2069 7320 7468 6520  ed, this is the 
+0002bd50: 6e75 6d62 6572 206f 6620 6974 6572 6174  number of iterat
+0002bd60: 696f 6e73 2e0a 2020 2020 2020 2020 3a72  ions..        :r
+0002bd70: 6574 7572 6e3a 2041 6e20 5847 4120 496d  eturn: An XGA Im
+0002bd80: 6167 652f 5261 7465 4d61 702f 4578 704d  age/RateMap/ExpM
+0002bd90: 6170 206f 626a 6563 7420 2869 6620 7468  ap object (if th
+0002bda0: 6572 6520 6973 2061 6e20 6578 6163 7420  ere is an exact 
+0002bdb0: 6d61 7463 6829 2c20 6f72 2061 206c 6973  match), or a lis
+0002bdc0: 7420 6f66 2058 4741 0a20 2020 2020 2020  t of XGA.       
+0002bdd0: 2020 2020 2049 6d61 6765 2f52 6174 654d       Image/RateM
+0002bde0: 6170 2f45 7870 4d61 7020 6f62 6a65 6374  ap/ExpMap object
+0002bdf0: 7320 2869 6620 7468 6572 6520 7765 7265  s (if there were
+0002be00: 206d 756c 7469 706c 6520 6d61 7463 6869   multiple matchi
+0002be10: 6e67 2070 726f 6475 6374 7329 2e0a 2020  ng products)..  
+0002be20: 2020 2020 2020 3a72 7479 7065 3a20 556e        :rtype: Un
+0002be30: 696f 6e5b 496d 6167 652c 2045 7870 4d61  ion[Image, ExpMa
+0002be40: 702c 2052 6174 654d 6170 2c20 4c69 7374  p, RateMap, List
+0002be50: 5b49 6d61 6765 5d2c 204c 6973 745b 4578  [Image], List[Ex
+0002be60: 704d 6170 5d2c 204c 6973 745b 5261 7465  pMap], List[Rate
+0002be70: 4d61 705d 5d0a 2020 2020 2020 2020 2222  Map]].        ""
+0002be80: 220a 2020 2020 2020 2020 2320 4368 6563  ".        # Chec
+0002be90: 6b73 2074 6f20 6d61 6b65 2073 7572 6520  ks to make sure 
+0002bea0: 7468 6174 2061 6e20 616c 6c6f 7765 6420  that an allowed 
+0002beb0: 636f 6d62 696e 6174 696f 6e20 6f66 206c  combination of l
+0002bec0: 6f5f 656e 2061 6e64 2068 695f 656e 2068  o_en and hi_en h
+0002bed0: 6173 2062 6565 6e20 7061 7373 6564 2e0a  as been passed..
+0002bee0: 2020 2020 2020 2020 6966 2061 6c6c 285b          if all([
+0002bef0: 6c6f 5f65 6e20 6973 204e 6f6e 652c 2068  lo_en is None, h
+0002bf00: 695f 656e 2069 7320 4e6f 6e65 5d29 3a0a  i_en is None]):.
+0002bf10: 2020 2020 2020 2020 2020 2020 2320 5365              # Se
+0002bf20: 7473 2061 2066 6c61 6720 746f 2074 656c  ts a flag to tel
+0002bf30: 6c20 7468 6520 7265 7374 206f 6620 7468  l the rest of th
+0002bf40: 6520 6d65 7468 6f64 2077 6865 7468 6572  e method whether
+0002bf50: 2077 6520 6861 7665 2065 6e65 7267 7920   we have energy 
+0002bf60: 6c69 6d73 206f 7220 6e6f 740a 2020 2020  lims or not.    
+0002bf70: 2020 2020 2020 2020 7769 7468 5f6c 696d          with_lim
+0002bf80: 7320 3d20 4661 6c73 650a 2020 2020 2020  s = False.      
+0002bf90: 2020 2020 2020 656e 6572 6779 5f6b 6579        energy_key
+0002bfa0: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
+0002bfb0: 656c 6966 2061 6c6c 285b 6c6f 5f65 6e20  elif all([lo_en 
+0002bfc0: 6973 206e 6f74 204e 6f6e 652c 2068 695f  is not None, hi_
+0002bfd0: 656e 2069 7320 6e6f 7420 4e6f 6e65 5d29  en is not None])
+0002bfe0: 3a0a 2020 2020 2020 2020 2020 2020 7769  :.            wi
+0002bff0: 7468 5f6c 696d 7320 3d20 5472 7565 0a20  th_lims = True. 
+0002c000: 2020 2020 2020 2020 2020 2023 2057 6520             # We 
+0002c010: 6861 7665 2065 6e65 7267 7920 6c69 6d69  have energy limi
+0002c020: 7473 2068 6572 6520 736f 2077 6520 6173  ts here so we as
+0002c030: 7365 6d62 6c65 2074 6865 206b 6579 2074  semble the key t
+0002c040: 6861 7420 6465 7363 7269 6265 7320 7468  hat describes th
+0002c050: 6520 656e 6572 6779 2072 616e 6765 0a20  e energy range. 
+0002c060: 2020 2020 2020 2020 2020 2065 6e65 7267             energ
+0002c070: 795f 6b65 7920 3d20 2262 6f75 6e64 5f7b  y_key = "bound_{
+0002c080: 6c7d 2d7b 687d 222e 666f 726d 6174 286c  l}-{h}".format(l
+0002c090: 3d6c 6f5f 656e 2e74 6f28 276b 6556 2729  =lo_en.to('keV')
+0002c0a0: 2e76 616c 7565 2c20 683d 6869 5f65 6e2e  .value, h=hi_en.
+0002c0b0: 746f 2827 6b65 5627 292e 7661 6c75 6529  to('keV').value)
+0002c0c0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0002c0d0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+0002c0e0: 2056 616c 7565 4572 726f 7228 226c 6f5f   ValueError("lo_
+0002c0f0: 656e 2061 6e64 2068 695f 656e 206d 7573  en and hi_en mus
+0002c100: 7420 6265 2065 6974 6865 7220 424f 5448  t be either BOTH
+0002c110: 204e 6f6e 6520 6f72 2042 4f54 4820 616e   None or BOTH an
+0002c120: 2041 7374 726f 7079 2071 7561 6e74 6974   Astropy quantit
+0002c130: 792e 2229 0a0a 2020 2020 2020 2020 2320  y.")..        # 
+0002c140: 4966 2077 6520 6172 6520 6c6f 6f6b 696e  If we are lookin
+0002c150: 6720 666f 7220 6120 5053 4620 636f 7272  g for a PSF corr
+0002c160: 6563 7465 6420 696d 6167 652f 7261 7465  ected image/rate
+0002c170: 6d61 7020 7468 656e 2077 6520 6173 7365  map then we asse
+0002c180: 6d62 6c65 2074 6865 2065 7874 7261 206b  mble the extra k
+0002c190: 6579 2077 6974 6820 5053 4620 6465 7461  ey with PSF deta
+0002c1a0: 696c 730a 2020 2020 2020 2020 6966 2070  ils.        if p
+0002c1b0: 7366 5f63 6f72 7220 616e 6420 7072 6f64  sf_corr and prod
+0002c1c0: 5f74 7970 6520 696e 205b 2269 6d61 6765  _type in ["image
+0002c1d0: 222c 2022 7261 7465 6d61 7022 5d3a 0a20  ", "ratemap"]:. 
+0002c1e0: 2020 2020 2020 2020 2020 2065 7874 7261             extra
+0002c1f0: 5f6b 6579 203d 2022 5f22 202b 2070 7366  _key = "_" + psf
+0002c200: 5f6d 6f64 656c 202b 2022 5f22 202b 2073  _model + "_" + s
+0002c210: 7472 2870 7366 5f62 696e 7329 202b 2022  tr(psf_bins) + "
+0002c220: 5f22 202b 2070 7366 5f61 6c67 6f20 2b20  _" + psf_algo + 
+0002c230: 7374 7228 7073 665f 6974 6572 290a 0a20  str(psf_iter).. 
+0002c240: 2020 2020 2020 2069 6620 6e6f 7420 7073         if not ps
+0002c250: 665f 636f 7272 2061 6e64 2077 6974 685f  f_corr and with_
+0002c260: 6c69 6d73 3a0a 2020 2020 2020 2020 2020  lims:.          
+0002c270: 2020 2320 5369 6d70 6c65 7374 2063 6173    # Simplest cas
+0002c280: 652c 206a 7573 7420 6361 6c6c 696e 6720  e, just calling 
+0002c290: 6765 745f 7072 6f64 7563 7473 2061 6e64  get_products and
+0002c2a0: 2070 6173 7369 6e67 2069 6e20 6f75 7220   passing in our 
+0002c2b0: 696e 666f 726d 6174 696f 6e0a 2020 2020  information.    
+0002c2c0: 2020 2020 2020 2020 6d61 7463 6865 645f          matched_
+0002c2d0: 7072 6f64 7320 3d20 7365 6c66 2e67 6574  prods = self.get
+0002c2e0: 5f70 726f 6475 6374 7328 7072 6f64 5f74  _products(prod_t
+0002c2f0: 7970 652c 206f 6273 5f69 642c 2069 6e73  ype, obs_id, ins
+0002c300: 742c 2065 7874 7261 5f6b 6579 3d65 6e65  t, extra_key=ene
+0002c310: 7267 795f 6b65 7929 0a20 2020 2020 2020  rgy_key).       
+0002c320: 2065 6c69 6620 6e6f 7420 7073 665f 636f   elif not psf_co
+0002c330: 7272 2061 6e64 206e 6f74 2077 6974 685f  rr and not with_
+0002c340: 6c69 6d73 3a0a 2020 2020 2020 2020 2020  lims:.          
+0002c350: 2020 6272 6f61 645f 6d61 7463 6865 7320    broad_matches 
+0002c360: 3d20 7365 6c66 2e67 6574 5f70 726f 6475  = self.get_produ
+0002c370: 6374 7328 7072 6f64 5f74 7970 652c 206f  cts(prod_type, o
+0002c380: 6273 5f69 642c 2069 6e73 7429 0a20 2020  bs_id, inst).   
+0002c390: 2020 2020 2020 2020 206d 6174 6368 6564           matched
+0002c3a0: 5f70 726f 6473 203d 205b 7020 666f 7220  _prods = [p for 
+0002c3b0: 7020 696e 2062 726f 6164 5f6d 6174 6368  p in broad_match
+0002c3c0: 6573 2069 6620 6e6f 7420 702e 7073 665f  es if not p.psf_
+0002c3d0: 636f 7272 6563 7465 645d 0a20 2020 2020  corrected].     
+0002c3e0: 2020 2065 6c69 6620 7073 665f 636f 7272     elif psf_corr
+0002c3f0: 2061 6e64 2077 6974 685f 6c69 6d73 3a0a   and with_lims:.
+0002c400: 2020 2020 2020 2020 2020 2020 2320 4865              # He
+0002c410: 7265 2077 6520 6e65 6564 2074 6f20 6164  re we need to ad
+0002c420: 6420 7468 6520 6578 7472 6120 6b65 7920  d the extra key 
+0002c430: 746f 2074 6865 2065 6e65 7267 7920 6b65  to the energy ke
+0002c440: 790a 2020 2020 2020 2020 2020 2020 6d61  y.            ma
+0002c450: 7463 6865 645f 7072 6f64 7320 3d20 7365  tched_prods = se
+0002c460: 6c66 2e67 6574 5f70 726f 6475 6374 7328  lf.get_products(
+0002c470: 7072 6f64 5f74 7970 652c 206f 6273 5f69  prod_type, obs_i
+0002c480: 642c 2069 6e73 742c 2065 7874 7261 5f6b  d, inst, extra_k
+0002c490: 6579 3d65 6e65 7267 795f 6b65 7920 2b20  ey=energy_key + 
+0002c4a0: 6578 7472 615f 6b65 7929 0a20 2020 2020  extra_key).     
+0002c4b0: 2020 2065 6c69 6620 7073 665f 636f 7272     elif psf_corr
+0002c4c0: 2061 6e64 206e 6f74 2077 6974 685f 6c69   and not with_li
+0002c4d0: 6d73 3a0a 2020 2020 2020 2020 2020 2020  ms:.            
+0002c4e0: 2320 4865 7265 2077 6520 646f 6e27 7420  # Here we don't 
+0002c4f0: 6b6e 6f77 2074 6865 2065 6e65 7267 7920  know the energy 
+0002c500: 6b65 792c 2073 6f20 7765 2068 6176 6520  key, so we have 
+0002c510: 746f 206c 6f6f 6b20 666f 7220 7061 7274  to look for part
+0002c520: 6961 6c20 6d61 7463 6865 7320 696e 2074  ial matches in t
+0002c530: 6865 2067 6574 5f70 726f 6475 6374 7320  he get_products 
+0002c540: 7265 7475 726e 0a20 2020 2020 2020 2020  return.         
+0002c550: 2020 2062 726f 6164 5f6d 6174 6368 6573     broad_matches
+0002c560: 203d 2073 656c 662e 6765 745f 7072 6f64   = self.get_prod
+0002c570: 7563 7473 2870 726f 645f 7479 7065 2c20  ucts(prod_type, 
+0002c580: 6f62 735f 6964 2c20 696e 7374 2c20 6578  obs_id, inst, ex
+0002c590: 7472 615f 6b65 793d 4e6f 6e65 2c20 6a75  tra_key=None, ju
+0002c5a0: 7374 5f6f 626a 3d46 616c 7365 290a 2020  st_obj=False).  
+0002c5b0: 2020 2020 2020 2020 2020 6d61 7463 6865            matche
+0002c5c0: 645f 7072 6f64 7320 3d20 5b70 5b2d 315d  d_prods = [p[-1]
+0002c5d0: 2066 6f72 2070 2069 6e20 6272 6f61 645f   for p in broad_
+0002c5e0: 6d61 7463 6865 7320 6966 2065 7874 7261  matches if extra
+0002c5f0: 5f6b 6579 2069 6e20 705b 2d32 5d5d 0a0a  _key in p[-2]]..
+0002c600: 2020 2020 2020 2020 6966 206c 656e 286d          if len(m
+0002c610: 6174 6368 6564 5f70 726f 6473 2920 3d3d  atched_prods) ==
+0002c620: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
+0002c630: 6d61 7463 6865 645f 7072 6f64 7320 3d20  matched_prods = 
+0002c640: 6d61 7463 6865 645f 7072 6f64 735b 305d  matched_prods[0]
+0002c650: 0a20 2020 2020 2020 2065 6c69 6620 6c65  .        elif le
+0002c660: 6e28 6d61 7463 6865 645f 7072 6f64 7329  n(matched_prods)
+0002c670: 203d 3d20 303a 0a20 2020 2020 2020 2020   == 0:.         
+0002c680: 2020 2072 6169 7365 204e 6f50 726f 6475     raise NoProdu
+0002c690: 6374 4176 6169 6c61 626c 6545 7272 6f72  ctAvailableError
+0002c6a0: 2822 4361 6e6e 6f74 2066 696e 6420 616e  ("Cannot find an
+0002c6b0: 7920 7b70 7d73 206d 6174 6368 696e 6720  y {p}s matching 
+0002c6c0: 796f 7572 2069 6e70 7574 2e22 2e66 6f72  your input.".for
+0002c6d0: 6d61 7428 703d 7072 6f64 5f74 7970 6529  mat(p=prod_type)
+0002c6e0: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+0002c6f0: 6e20 6d61 7463 6865 645f 7072 6f64 730a  n matched_prods.
+0002c700: 0a20 2020 2064 6566 2067 6574 5f69 6d61  .    def get_ima
+0002c710: 6765 7328 7365 6c66 2c20 6f62 735f 6964  ges(self, obs_id
+0002c720: 3a20 7374 7220 3d20 4e6f 6e65 2c20 696e  : str = None, in
+0002c730: 7374 3a20 7374 7220 3d20 4e6f 6e65 2c20  st: str = None, 
+0002c740: 6c6f 5f65 6e3a 2051 7561 6e74 6974 7920  lo_en: Quantity 
+0002c750: 3d20 4e6f 6e65 2c20 6869 5f65 6e3a 2051  = None, hi_en: Q
+0002c760: 7561 6e74 6974 7920 3d20 4e6f 6e65 2c0a  uantity = None,.
+0002c770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c780: 2020 2070 7366 5f63 6f72 723a 2062 6f6f     psf_corr: boo
+0002c790: 6c20 3d20 4661 6c73 652c 2070 7366 5f6d  l = False, psf_m
+0002c7a0: 6f64 656c 3a20 7374 7220 3d20 2245 4c4c  odel: str = "ELL
+0002c7b0: 4245 5441 222c 2070 7366 5f62 696e 733a  BETA", psf_bins:
+0002c7c0: 2069 6e74 203d 2034 2c20 7073 665f 616c   int = 4, psf_al
+0002c7d0: 676f 3a20 7374 7220 3d20 2272 6c22 2c0a  go: str = "rl",.
+0002c7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c7f0: 2020 2070 7366 5f69 7465 723a 2069 6e74     psf_iter: int
+0002c800: 203d 2031 3529 202d 3e20 556e 696f 6e5b   = 15) -> Union[
+0002c810: 496d 6167 652c 204c 6973 745b 496d 6167  Image, List[Imag
+0002c820: 655d 5d3a 0a20 2020 2020 2020 2022 2222  e]]:.        """
+0002c830: 0a20 2020 2020 2020 2041 206d 6574 686f  .        A metho
+0002c840: 6420 746f 2072 6574 7269 6576 6520 5847  d to retrieve XG
+0002c850: 4120 496d 6167 6520 6f62 6a65 6374 732e  A Image objects.
+0002c860: 2054 6869 7320 7375 7070 6f72 7473 2074   This supports t
+0002c870: 6865 2072 6574 7269 6576 616c 206f 6620  he retrieval of 
+0002c880: 626f 7468 2050 5346 2063 6f72 7265 6374  both PSF correct
+0002c890: 6564 2061 6e64 206e 6f6e 2d50 5346 0a20  ed and non-PSF. 
+0002c8a0: 2020 2020 2020 2063 6f72 7265 6374 6564         corrected
+0002c8b0: 2069 6d61 6765 732c 2061 7320 7765 6c6c   images, as well
+0002c8c0: 2061 7320 7365 7474 696e 6720 7468 6520   as setting the 
+0002c8d0: 656e 6572 6779 206c 696d 6974 7320 6f66  energy limits of
+0002c8e0: 2074 6865 2073 7065 6369 6669 6320 696d   the specific im
+0002c8f0: 6167 6520 796f 7520 776f 756c 6420 6c69  age you would li
+0002c900: 6b65 2e20 410a 2020 2020 2020 2020 4e6f  ke. A.        No
+0002c910: 5072 6f64 7563 7441 7661 696c 6162 6c65  ProductAvailable
+0002c920: 4572 726f 7220 6572 726f 7220 7769 6c6c  Error error will
+0002c930: 2062 6520 7261 6973 6564 2069 6620 6e6f   be raised if no
+0002c940: 206d 6174 6368 6573 2061 7265 2066 6f75   matches are fou
+0002c950: 6e64 2e0a 0a20 2020 2020 2020 203a 7061  nd...        :pa
+0002c960: 7261 6d20 7374 7220 6f62 735f 6964 3a20  ram str obs_id: 
+0002c970: 4f70 7469 6f6e 616c 6c79 2c20 6120 7370  Optionally, a sp
+0002c980: 6563 6966 6963 206f 6273 5f69 6420 746f  ecific obs_id to
+0002c990: 2073 6561 7263 6820 666f 7220 6361 6e20   search for can 
+0002c9a0: 6265 2073 7570 706c 6965 642e 2054 6865  be supplied. The
+0002c9b0: 2064 6566 6175 6c74 2069 7320 4e6f 6e65   default is None
+0002c9c0: 2c0a 2020 2020 2020 2020 2020 2020 7768  ,.            wh
+0002c9d0: 6963 6820 6d65 616e 7320 616c 6c20 696d  ich means all im
+0002c9e0: 6167 6573 206d 6174 6368 696e 6720 7468  ages matching th
+0002c9f0: 6520 6f74 6865 7220 6372 6974 6572 6961  e other criteria
+0002ca00: 2077 696c 6c20 6265 2072 6574 7572 6e65   will be returne
+0002ca10: 642e 0a20 2020 2020 2020 203a 7061 7261  d..        :para
+0002ca20: 6d20 7374 7220 696e 7374 3a20 4f70 7469  m str inst: Opti
+0002ca30: 6f6e 616c 6c79 2c20 6120 7370 6563 6966  onally, a specif
+0002ca40: 6963 2069 6e73 7472 756d 656e 7420 746f  ic instrument to
+0002ca50: 2073 6561 7263 6820 666f 7220 6361 6e20   search for can 
+0002ca60: 6265 2073 7570 706c 6965 642e 2054 6865  be supplied. The
+0002ca70: 2064 6566 6175 6c74 2069 7320 4e6f 6e65   default is None
+0002ca80: 2c0a 2020 2020 2020 2020 2020 2020 7768  ,.            wh
+0002ca90: 6963 6820 6d65 616e 7320 616c 6c20 696d  ich means all im
+0002caa0: 6167 6573 206d 6174 6368 696e 6720 7468  ages matching th
+0002cab0: 6520 6f74 6865 7220 6372 6974 6572 6961  e other criteria
+0002cac0: 2077 696c 6c20 6265 2072 6574 7572 6e65   will be returne
+0002cad0: 642e 0a20 2020 2020 2020 203a 7061 7261  d..        :para
+0002cae0: 6d20 5175 616e 7469 7479 206c 6f5f 656e  m Quantity lo_en
+0002caf0: 3a20 5468 6520 6c6f 7765 7220 656e 6572  : The lower ener
+0002cb00: 6779 206c 696d 6974 206f 6620 7468 6520  gy limit of the 
+0002cb10: 696d 6167 6520 796f 7520 7769 7368 2074  image you wish t
+0002cb20: 6f20 7265 7472 6965 7665 2c20 7468 6520  o retrieve, the 
+0002cb30: 6465 6661 756c 740a 2020 2020 2020 2020  default.        
+0002cb40: 2020 2020 6973 204e 6f6e 6520 2877 6869      is None (whi
+0002cb50: 6368 2077 696c 6c20 7265 7472 6965 7665  ch will retrieve
+0002cb60: 2061 6c6c 2069 6d61 6765 7320 7265 6761   all images rega
+0002cb70: 7264 6c65 7373 206f 6620 656e 6572 6779  rdless of energy
+0002cb80: 206c 696d 6974 292e 0a20 2020 2020 2020   limit)..       
+0002cb90: 203a 7061 7261 6d20 5175 616e 7469 7479   :param Quantity
+0002cba0: 2068 695f 656e 3a20 5468 6520 7570 7065   hi_en: The uppe
+0002cbb0: 7220 656e 6572 6779 206c 696d 6974 206f  r energy limit o
+0002cbc0: 6620 7468 6520 696d 6167 6520 796f 7520  f the image you 
+0002cbd0: 7769 7368 2074 6f20 7265 7472 6965 7665  wish to retrieve
+0002cbe0: 2c20 7468 6520 6465 6661 756c 740a 2020  , the default.  
+0002cbf0: 2020 2020 2020 2020 2020 6973 204e 6f6e            is Non
+0002cc00: 6520 2877 6869 6368 2077 696c 6c20 7265  e (which will re
+0002cc10: 7472 6965 7665 2061 6c6c 2069 6d61 6765  trieve all image
+0002cc20: 7320 7265 6761 7264 6c65 7373 206f 6620  s regardless of 
+0002cc30: 656e 6572 6779 206c 696d 6974 292e 0a20  energy limit).. 
+0002cc40: 2020 2020 2020 203a 7061 7261 6d20 626f         :param bo
+0002cc50: 6f6c 2070 7366 5f63 6f72 723a 2053 6574  ol psf_corr: Set
+0002cc60: 7320 7768 6574 6865 7220 796f 7520 7769  s whether you wi
+0002cc70: 7368 2074 6f20 7265 7472 6965 7665 2061  sh to retrieve a
+0002cc80: 2050 5346 2063 6f72 7265 6374 6564 2069   PSF corrected i
+0002cc90: 6d61 6765 206f 7220 6e6f 742e 0a20 2020  mage or not..   
+0002cca0: 2020 2020 203a 7061 7261 6d20 7374 7220       :param str 
+0002ccb0: 7073 665f 6d6f 6465 6c3a 2049 6620 7468  psf_model: If th
+0002ccc0: 6520 696d 6167 6520 796f 7520 7761 6e74  e image you want
+0002ccd0: 2069 7320 5053 4620 636f 7272 6563 7465   is PSF correcte
+0002cce0: 642c 2074 6869 7320 6973 2074 6865 2050  d, this is the P
+0002ccf0: 5346 206d 6f64 656c 2075 7365 642e 0a20  SF model used.. 
+0002cd00: 2020 2020 2020 203a 7061 7261 6d20 696e         :param in
+0002cd10: 7420 7073 665f 6269 6e73 3a20 4966 2074  t psf_bins: If t
+0002cd20: 6865 2069 6d61 6765 2079 6f75 2077 616e  he image you wan
+0002cd30: 7420 6973 2050 5346 2063 6f72 7265 6374  t is PSF correct
+0002cd40: 6564 2c20 7468 6973 2069 7320 7468 6520  ed, this is the 
+0002cd50: 6e75 6d62 6572 206f 6620 5053 4673 2070  number of PSFs p
+0002cd60: 6572 0a20 2020 2020 2020 2020 2020 2073  er.            s
+0002cd70: 6964 6520 696e 2074 6865 2050 5346 2067  ide in the PSF g
+0002cd80: 7269 642e 0a20 2020 2020 2020 203a 7061  rid..        :pa
+0002cd90: 7261 6d20 7374 7220 7073 665f 616c 676f  ram str psf_algo
+0002cda0: 3a20 4966 2074 6865 2069 6d61 6765 2079  : If the image y
+0002cdb0: 6f75 2077 616e 7420 6973 2050 5346 2063  ou want is PSF c
+0002cdc0: 6f72 7265 6374 6564 2c20 7468 6973 2069  orrected, this i
+0002cdd0: 7320 7468 6520 616c 676f 7269 7468 6d20  s the algorithm 
+0002cde0: 7573 6564 2e0a 2020 2020 2020 2020 3a70  used..        :p
+0002cdf0: 6172 616d 2069 6e74 2070 7366 5f69 7465  aram int psf_ite
+0002ce00: 723a 2049 6620 7468 6520 696d 6167 6520  r: If the image 
+0002ce10: 796f 7520 7761 6e74 2069 7320 5053 4620  you want is PSF 
+0002ce20: 636f 7272 6563 7465 642c 2074 6869 7320  corrected, this 
+0002ce30: 6973 2074 6865 206e 756d 6265 7220 6f66  is the number of
+0002ce40: 2069 7465 7261 7469 6f6e 732e 0a20 2020   iterations..   
+0002ce50: 2020 2020 203a 7265 7475 726e 3a20 416e       :return: An
+0002ce60: 2058 4741 2049 6d61 6765 206f 626a 6563   XGA Image objec
+0002ce70: 7420 2869 6620 7468 6572 6520 6973 2061  t (if there is a
+0002ce80: 6e20 6578 6163 7420 6d61 7463 6829 2c20  n exact match), 
+0002ce90: 6f72 2061 206c 6973 7420 6f66 2058 4741  or a list of XGA
+0002cea0: 2049 6d61 6765 206f 626a 6563 7473 2028   Image objects (
+0002ceb0: 6966 2074 6865 7265 0a20 2020 2020 2020  if there.       
+0002cec0: 2020 2020 2077 6572 6520 6d75 6c74 6970       were multip
+0002ced0: 6c65 206d 6174 6368 696e 6720 7072 6f64  le matching prod
+0002cee0: 7563 7473 292e 0a20 2020 2020 2020 203a  ucts)..        :
+0002cef0: 7274 7970 653a 2055 6e69 6f6e 5b49 6d61  rtype: Union[Ima
+0002cf00: 6765 2c20 4c69 7374 5b49 6d61 6765 5d5d  ge, List[Image]]
+0002cf10: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0002cf20: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+0002cf30: 2e5f 6765 745f 7068 6f74 5f70 726f 6428  ._get_phot_prod(
+0002cf40: 2269 6d61 6765 222c 206f 6273 5f69 642c  "image", obs_id,
+0002cf50: 2069 6e73 742c 206c 6f5f 656e 2c20 6869   inst, lo_en, hi
+0002cf60: 5f65 6e2c 2070 7366 5f63 6f72 722c 2070  _en, psf_corr, p
+0002cf70: 7366 5f6d 6f64 656c 2c20 7073 665f 6269  sf_model, psf_bi
+0002cf80: 6e73 2c20 7073 665f 616c 676f 2c0a 2020  ns, psf_algo,.  
+0002cf90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cfa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cfb0: 2070 7366 5f69 7465 7229 0a0a 2020 2020   psf_iter)..    
+0002cfc0: 6465 6620 6765 745f 6578 706d 6170 7328  def get_expmaps(
+0002cfd0: 7365 6c66 2c20 6f62 735f 6964 3a20 7374  self, obs_id: st
+0002cfe0: 7220 3d20 4e6f 6e65 2c20 696e 7374 3a20  r = None, inst: 
+0002cff0: 7374 7220 3d20 4e6f 6e65 2c20 6c6f 5f65  str = None, lo_e
+0002d000: 6e3a 2051 7561 6e74 6974 7920 3d20 4e6f  n: Quantity = No
+0002d010: 6e65 2c20 6869 5f65 6e3a 2051 7561 6e74  ne, hi_en: Quant
+0002d020: 6974 7920 3d20 4e6f 6e65 2920 5c0a 2020  ity = None) \.  
+0002d030: 2020 2020 2020 2020 2020 2d3e 2055 6e69            -> Uni
+0002d040: 6f6e 5b45 7870 4d61 702c 204c 6973 745b  on[ExpMap, List[
+0002d050: 4578 704d 6170 5d5d 3a0a 2020 2020 2020  ExpMap]]:.      
+0002d060: 2020 2222 220a 2020 2020 2020 2020 4120    """.        A 
+0002d070: 6d65 7468 6f64 2074 6f20 7265 7472 6965  method to retrie
+0002d080: 7665 2058 4741 2045 7870 4d61 7020 6f62  ve XGA ExpMap ob
+0002d090: 6a65 6374 732e 2054 6869 7320 7375 7070  jects. This supp
+0002d0a0: 6f72 7473 2073 6574 7469 6e67 2074 6865  orts setting the
+0002d0b0: 2065 6e65 7267 7920 6c69 6d69 7473 206f   energy limits o
+0002d0c0: 6620 7468 6520 7370 6563 6966 6963 0a20  f the specific. 
+0002d0d0: 2020 2020 2020 2065 7870 6f73 7572 6520         exposure 
+0002d0e0: 6d61 7073 2079 6f75 2077 6f75 6c64 206c  maps you would l
+0002d0f0: 696b 652e 2041 204e 6f50 726f 6475 6374  ike. A NoProduct
+0002d100: 4176 6169 6c61 626c 6545 7272 6f72 2065  AvailableError e
+0002d110: 7272 6f72 2077 696c 6c20 6265 2072 6169  rror will be rai
+0002d120: 7365 6420 6966 206e 6f20 6d61 7463 6865  sed if no matche
+0002d130: 7320 6172 6520 666f 756e 642e 0a0a 2020  s are found...  
+0002d140: 2020 2020 2020 3a70 6172 616d 2073 7472        :param str
+0002d150: 206f 6273 5f69 643a 204f 7074 696f 6e61   obs_id: Optiona
+0002d160: 6c6c 792c 2061 2073 7065 6369 6669 6320  lly, a specific 
+0002d170: 6f62 735f 6964 2074 6f20 7365 6172 6368  obs_id to search
+0002d180: 2066 6f72 2063 616e 2062 6520 7375 7070   for can be supp
+0002d190: 6c69 6564 2e20 5468 6520 6465 6661 756c  lied. The defaul
+0002d1a0: 7420 6973 204e 6f6e 652c 0a20 2020 2020  t is None,.     
+0002d1b0: 2020 2020 2020 2077 6869 6368 206d 6561         which mea
+0002d1c0: 6e73 2061 6c6c 2065 7870 6f73 7572 6520  ns all exposure 
+0002d1d0: 6d61 7073 206d 6174 6368 696e 6720 7468  maps matching th
+0002d1e0: 6520 6f74 6865 7220 6372 6974 6572 6961  e other criteria
+0002d1f0: 2077 696c 6c20 6265 2072 6574 7572 6e65   will be returne
+0002d200: 642e 0a20 2020 2020 2020 203a 7061 7261  d..        :para
+0002d210: 6d20 7374 7220 696e 7374 3a20 4f70 7469  m str inst: Opti
+0002d220: 6f6e 616c 6c79 2c20 6120 7370 6563 6966  onally, a specif
+0002d230: 6963 2069 6e73 7472 756d 656e 7420 746f  ic instrument to
+0002d240: 2073 6561 7263 6820 666f 7220 6361 6e20   search for can 
+0002d250: 6265 2073 7570 706c 6965 642e 2054 6865  be supplied. The
+0002d260: 2064 6566 6175 6c74 2069 7320 4e6f 6e65   default is None
+0002d270: 2c0a 2020 2020 2020 2020 2020 2020 7768  ,.            wh
+0002d280: 6963 6820 6d65 616e 7320 616c 6c20 6578  ich means all ex
+0002d290: 706f 7375 7265 206d 6170 7320 6d61 7463  posure maps matc
+0002d2a0: 6869 6e67 2074 6865 206f 7468 6572 2063  hing the other c
+0002d2b0: 7269 7465 7269 6120 7769 6c6c 2062 6520  riteria will be 
+0002d2c0: 7265 7475 726e 6564 2e0a 2020 2020 2020  returned..      
+0002d2d0: 2020 3a70 6172 616d 2051 7561 6e74 6974    :param Quantit
+0002d2e0: 7920 6c6f 5f65 6e3a 2054 6865 206c 6f77  y lo_en: The low
+0002d2f0: 6572 2065 6e65 7267 7920 6c69 6d69 7420  er energy limit 
+0002d300: 6f66 2074 6865 2065 7870 6f73 7572 6520  of the exposure 
+0002d310: 6d61 7073 2079 6f75 2077 6973 6820 746f  maps you wish to
+0002d320: 2072 6574 7269 6576 652c 2074 6865 2064   retrieve, the d
+0002d330: 6566 6175 6c74 0a20 2020 2020 2020 2020  efault.         
+0002d340: 2020 2069 7320 4e6f 6e65 2028 7768 6963     is None (whic
+0002d350: 6820 7769 6c6c 2072 6574 7269 6576 6520  h will retrieve 
+0002d360: 616c 6c20 696d 6167 6573 2072 6567 6172  all images regar
+0002d370: 646c 6573 7320 6f66 2065 6e65 7267 7920  dless of energy 
+0002d380: 6c69 6d69 7429 2e0a 2020 2020 2020 2020  limit)..        
+0002d390: 3a70 6172 616d 2051 7561 6e74 6974 7920  :param Quantity 
+0002d3a0: 6869 5f65 6e3a 2054 6865 2075 7070 6572  hi_en: The upper
+0002d3b0: 2065 6e65 7267 7920 6c69 6d69 7420 6f66   energy limit of
+0002d3c0: 2074 6865 2065 7870 6f73 7572 6520 6d61   the exposure ma
+0002d3d0: 7073 2079 6f75 2077 6973 6820 746f 2072  ps you wish to r
+0002d3e0: 6574 7269 6576 652c 2074 6865 2064 6566  etrieve, the def
+0002d3f0: 6175 6c74 0a20 2020 2020 2020 2020 2020  ault.           
+0002d400: 2069 7320 4e6f 6e65 2028 7768 6963 6820   is None (which 
+0002d410: 7769 6c6c 2072 6574 7269 6576 6520 616c  will retrieve al
+0002d420: 6c20 696d 6167 6573 2072 6567 6172 646c  l images regardl
+0002d430: 6573 7320 6f66 2065 6e65 7267 7920 6c69  ess of energy li
+0002d440: 6d69 7429 2e0a 2020 2020 2020 2020 3a72  mit)..        :r
+0002d450: 6574 7572 6e3a 2041 6e20 5847 4120 4578  eturn: An XGA Ex
+0002d460: 704d 6170 206f 626a 6563 7420 2869 6620  pMap object (if 
+0002d470: 7468 6572 6520 6973 2061 6e20 6578 6163  there is an exac
+0002d480: 7420 6d61 7463 6829 2c20 6f72 2061 206c  t match), or a l
+0002d490: 6973 7420 6f66 2058 4741 2045 7870 4d61  ist of XGA ExpMa
+0002d4a0: 7020 6f62 6a65 6374 7320 2869 6620 7468  p objects (if th
+0002d4b0: 6572 650a 2020 2020 2020 2020 2020 2020  ere.            
+0002d4c0: 7765 7265 206d 756c 7469 706c 6520 6d61  were multiple ma
+0002d4d0: 7463 6869 6e67 2070 726f 6475 6374 7329  tching products)
+0002d4e0: 2e0a 2020 2020 2020 2020 3a72 7479 7065  ..        :rtype
+0002d4f0: 3a20 556e 696f 6e5b 4578 704d 6170 2c20  : Union[ExpMap, 
+0002d500: 4c69 7374 5b45 7870 4d61 705d 5d0a 2020  List[ExpMap]].  
+0002d510: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0002d520: 2020 7265 7475 726e 2073 656c 662e 5f67    return self._g
+0002d530: 6574 5f70 686f 745f 7072 6f64 2822 6578  et_phot_prod("ex
+0002d540: 706d 6170 222c 206f 6273 5f69 642c 2069  pmap", obs_id, i
+0002d550: 6e73 742c 206c 6f5f 656e 2c20 6869 5f65  nst, lo_en, hi_e
+0002d560: 6e2c 2046 616c 7365 290a 0a20 2020 2064  n, False)..    d
+0002d570: 6566 2067 6574 5f72 6174 656d 6170 7328  ef get_ratemaps(
+0002d580: 7365 6c66 2c20 6f62 735f 6964 3a20 7374  self, obs_id: st
+0002d590: 7220 3d20 4e6f 6e65 2c20 696e 7374 3a20  r = None, inst: 
+0002d5a0: 7374 7220 3d20 4e6f 6e65 2c20 6c6f 5f65  str = None, lo_e
+0002d5b0: 6e3a 2051 7561 6e74 6974 7920 3d20 4e6f  n: Quantity = No
+0002d5c0: 6e65 2c20 6869 5f65 6e3a 2051 7561 6e74  ne, hi_en: Quant
+0002d5d0: 6974 7920 3d20 4e6f 6e65 2c0a 2020 2020  ity = None,.    
+0002d5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d5f0: 2070 7366 5f63 6f72 723a 2062 6f6f 6c20   psf_corr: bool 
+0002d600: 3d20 4661 6c73 652c 2070 7366 5f6d 6f64  = False, psf_mod
+0002d610: 656c 3a20 7374 7220 3d20 2245 4c4c 4245  el: str = "ELLBE
+0002d620: 5441 222c 2070 7366 5f62 696e 733a 2069  TA", psf_bins: i
+0002d630: 6e74 203d 2034 2c20 7073 665f 616c 676f  nt = 4, psf_algo
+0002d640: 3a20 7374 7220 3d20 2272 6c22 2c0a 2020  : str = "rl",.  
+0002d650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d660: 2020 2070 7366 5f69 7465 723a 2069 6e74     psf_iter: int
+0002d670: 203d 2031 3529 202d 3e20 556e 696f 6e5b   = 15) -> Union[
+0002d680: 5261 7465 4d61 702c 204c 6973 745b 5261  RateMap, List[Ra
+0002d690: 7465 4d61 705d 5d3a 0a20 2020 2020 2020  teMap]]:.       
+0002d6a0: 2022 2222 0a20 2020 2020 2020 2041 206d   """.        A m
+0002d6b0: 6574 686f 6420 746f 2072 6574 7269 6576  ethod to retriev
+0002d6c0: 6520 5847 4120 5261 7465 4d61 7020 6f62  e XGA RateMap ob
+0002d6d0: 6a65 6374 732e 2054 6869 7320 7375 7070  jects. This supp
+0002d6e0: 6f72 7473 2074 6865 2072 6574 7269 6576  orts the retriev
+0002d6f0: 616c 206f 6620 626f 7468 2050 5346 2063  al of both PSF c
+0002d700: 6f72 7265 6374 6564 2061 6e64 206e 6f6e  orrected and non
+0002d710: 2d50 5346 0a20 2020 2020 2020 2063 6f72  -PSF.        cor
+0002d720: 7265 6374 6564 2072 6174 656d 6170 732c  rected ratemaps,
+0002d730: 2061 7320 7765 6c6c 2061 7320 7365 7474   as well as sett
+0002d740: 696e 6720 7468 6520 656e 6572 6779 206c  ing the energy l
+0002d750: 696d 6974 7320 6f66 2074 6865 2073 7065  imits of the spe
+0002d760: 6369 6669 6320 7261 7465 6d61 7020 796f  cific ratemap yo
+0002d770: 7520 776f 756c 6420 6c69 6b65 2e20 410a  u would like. A.
+0002d780: 2020 2020 2020 2020 4e6f 5072 6f64 7563          NoProduc
+0002d790: 7441 7661 696c 6162 6c65 4572 726f 7220  tAvailableError 
+0002d7a0: 6572 726f 7220 7769 6c6c 2062 6520 7261  error will be ra
+0002d7b0: 6973 6564 2069 6620 6e6f 206d 6174 6368  ised if no match
+0002d7c0: 6573 2061 7265 2066 6f75 6e64 2e0a 0a20  es are found... 
+0002d7d0: 2020 2020 2020 203a 7061 7261 6d20 7374         :param st
+0002d7e0: 7220 6f62 735f 6964 3a20 4f70 7469 6f6e  r obs_id: Option
+0002d7f0: 616c 6c79 2c20 6120 7370 6563 6966 6963  ally, a specific
+0002d800: 206f 6273 5f69 6420 746f 2073 6561 7263   obs_id to searc
+0002d810: 6820 666f 7220 6361 6e20 6265 2073 7570  h for can be sup
+0002d820: 706c 6965 642e 2054 6865 2064 6566 6175  plied. The defau
+0002d830: 6c74 2069 7320 4e6f 6e65 2c0a 2020 2020  lt is None,.    
+0002d840: 2020 2020 2020 2020 7768 6963 6820 6d65          which me
+0002d850: 616e 7320 616c 6c20 7261 7465 6d61 7073  ans all ratemaps
+0002d860: 206d 6174 6368 696e 6720 7468 6520 6f74   matching the ot
+0002d870: 6865 7220 6372 6974 6572 6961 2077 696c  her criteria wil
+0002d880: 6c20 6265 2072 6574 7572 6e65 642e 0a20  l be returned.. 
+0002d890: 2020 2020 2020 203a 7061 7261 6d20 7374         :param st
+0002d8a0: 7220 696e 7374 3a20 4f70 7469 6f6e 616c  r inst: Optional
+0002d8b0: 6c79 2c20 6120 7370 6563 6966 6963 2069  ly, a specific i
+0002d8c0: 6e73 7472 756d 656e 7420 746f 2073 6561  nstrument to sea
+0002d8d0: 7263 6820 666f 7220 6361 6e20 6265 2073  rch for can be s
+0002d8e0: 7570 706c 6965 642e 2054 6865 2064 6566  upplied. The def
+0002d8f0: 6175 6c74 2069 7320 4e6f 6e65 2c0a 2020  ault is None,.  
+0002d900: 2020 2020 2020 2020 2020 7768 6963 6820            which 
+0002d910: 6d65 616e 7320 616c 6c20 7261 7465 6d61  means all ratema
+0002d920: 7073 206d 6174 6368 696e 6720 7468 6520  ps matching the 
+0002d930: 6f74 6865 7220 6372 6974 6572 6961 2077  other criteria w
+0002d940: 696c 6c20 6265 2072 6574 7572 6e65 642e  ill be returned.
+0002d950: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+0002d960: 5175 616e 7469 7479 206c 6f5f 656e 3a20  Quantity lo_en: 
+0002d970: 5468 6520 6c6f 7765 7220 656e 6572 6779  The lower energy
+0002d980: 206c 696d 6974 206f 6620 7468 6520 7261   limit of the ra
+0002d990: 7465 6d61 7073 2079 6f75 2077 6973 6820  temaps you wish 
+0002d9a0: 746f 2072 6574 7269 6576 652c 2074 6865  to retrieve, the
+0002d9b0: 2064 6566 6175 6c74 0a20 2020 2020 2020   default.       
+0002d9c0: 2020 2020 2069 7320 4e6f 6e65 2028 7768       is None (wh
+0002d9d0: 6963 6820 7769 6c6c 2072 6574 7269 6576  ich will retriev
+0002d9e0: 6520 616c 6c20 7261 7465 6d61 7073 2072  e all ratemaps r
+0002d9f0: 6567 6172 646c 6573 7320 6f66 2065 6e65  egardless of ene
+0002da00: 7267 7920 6c69 6d69 7429 2e0a 2020 2020  rgy limit)..    
+0002da10: 2020 2020 3a70 6172 616d 2051 7561 6e74      :param Quant
+0002da20: 6974 7920 6869 5f65 6e3a 2054 6865 2075  ity hi_en: The u
+0002da30: 7070 6572 2065 6e65 7267 7920 6c69 6d69  pper energy limi
+0002da40: 7420 6f66 2074 6865 2072 6174 656d 6170  t of the ratemap
+0002da50: 7320 796f 7520 7769 7368 2074 6f20 7265  s you wish to re
+0002da60: 7472 6965 7665 2c20 7468 6520 6465 6661  trieve, the defa
+0002da70: 756c 740a 2020 2020 2020 2020 2020 2020  ult.            
+0002da80: 6973 204e 6f6e 6520 2877 6869 6368 2077  is None (which w
+0002da90: 696c 6c20 7265 7472 6965 7665 2061 6c6c  ill retrieve all
+0002daa0: 2072 6174 656d 6170 7320 7265 6761 7264   ratemaps regard
+0002dab0: 6c65 7373 206f 6620 656e 6572 6779 206c  less of energy l
+0002dac0: 696d 6974 292e 0a20 2020 2020 2020 203a  imit)..        :
+0002dad0: 7061 7261 6d20 626f 6f6c 2070 7366 5f63  param bool psf_c
+0002dae0: 6f72 723a 2053 6574 7320 7768 6574 6865  orr: Sets whethe
+0002daf0: 7220 796f 7520 7769 7368 2074 6f20 7265  r you wish to re
+0002db00: 7472 6965 7665 2061 2050 5346 2063 6f72  trieve a PSF cor
+0002db10: 7265 6374 6564 2072 6174 656d 6170 206f  rected ratemap o
+0002db20: 7220 6e6f 742e 0a20 2020 2020 2020 203a  r not..        :
+0002db30: 7061 7261 6d20 7374 7220 7073 665f 6d6f  param str psf_mo
+0002db40: 6465 6c3a 2049 6620 7468 6520 7261 7465  del: If the rate
+0002db50: 6d61 7020 796f 7520 7761 6e74 2069 7320  map you want is 
+0002db60: 5053 4620 636f 7272 6563 7465 642c 2074  PSF corrected, t
+0002db70: 6869 7320 6973 2074 6865 2050 5346 206d  his is the PSF m
+0002db80: 6f64 656c 2075 7365 642e 0a20 2020 2020  odel used..     
+0002db90: 2020 203a 7061 7261 6d20 696e 7420 7073     :param int ps
+0002dba0: 665f 6269 6e73 3a20 4966 2074 6865 2072  f_bins: If the r
+0002dbb0: 6174 656d 6170 2079 6f75 2077 616e 7420  atemap you want 
+0002dbc0: 6973 2050 5346 2063 6f72 7265 6374 6564  is PSF corrected
+0002dbd0: 2c20 7468 6973 2069 7320 7468 6520 6e75  , this is the nu
+0002dbe0: 6d62 6572 206f 6620 5053 4673 2070 6572  mber of PSFs per
+0002dbf0: 0a20 2020 2020 2020 2020 2020 2073 6964  .            sid
+0002dc00: 6520 696e 2074 6865 2050 5346 2067 7269  e in the PSF gri
+0002dc10: 642e 0a20 2020 2020 2020 203a 7061 7261  d..        :para
+0002dc20: 6d20 7374 7220 7073 665f 616c 676f 3a20  m str psf_algo: 
+0002dc30: 4966 2074 6865 2072 6174 656d 6170 2079  If the ratemap y
+0002dc40: 6f75 2077 616e 7420 6973 2050 5346 2063  ou want is PSF c
+0002dc50: 6f72 7265 6374 6564 2c20 7468 6973 2069  orrected, this i
+0002dc60: 7320 7468 6520 616c 676f 7269 7468 6d20  s the algorithm 
+0002dc70: 7573 6564 2e0a 2020 2020 2020 2020 3a70  used..        :p
+0002dc80: 6172 616d 2069 6e74 2070 7366 5f69 7465  aram int psf_ite
+0002dc90: 723a 2049 6620 7468 6520 7261 7465 6d61  r: If the ratema
+0002dca0: 7020 796f 7520 7761 6e74 2069 7320 5053  p you want is PS
+0002dcb0: 4620 636f 7272 6563 7465 642c 2074 6869  F corrected, thi
+0002dcc0: 7320 6973 2074 6865 206e 756d 6265 7220  s is the number 
+0002dcd0: 6f66 2069 7465 7261 7469 6f6e 732e 0a20  of iterations.. 
+0002dce0: 2020 2020 2020 203a 7265 7475 726e 3a20         :return: 
+0002dcf0: 416e 2058 4741 2052 6174 654d 6170 206f  An XGA RateMap o
+0002dd00: 626a 6563 7420 2869 6620 7468 6572 6520  bject (if there 
+0002dd10: 6973 2061 6e20 6578 6163 7420 6d61 7463  is an exact matc
+0002dd20: 6829 2c20 6f72 2061 206c 6973 7420 6f66  h), or a list of
+0002dd30: 2058 4741 2052 6174 654d 6170 206f 626a   XGA RateMap obj
+0002dd40: 6563 7473 2028 6966 2074 6865 7265 0a20  ects (if there. 
+0002dd50: 2020 2020 2020 2020 2020 2077 6572 6520             were 
+0002dd60: 6d75 6c74 6970 6c65 206d 6174 6368 696e  multiple matchin
+0002dd70: 6720 7072 6f64 7563 7473 292e 0a20 2020  g products)..   
+0002dd80: 2020 2020 203a 7274 7970 653a 2055 6e69       :rtype: Uni
+0002dd90: 6f6e 5b52 6174 654d 6170 2c20 4c69 7374  on[RateMap, List
+0002dda0: 5b52 6174 654d 6170 5d5d 0a20 2020 2020  [RateMap]].     
+0002ddb0: 2020 2022 2222 0a20 2020 2020 2020 2072     """.        r
+0002ddc0: 6574 7572 6e20 7365 6c66 2e5f 6765 745f  eturn self._get_
+0002ddd0: 7068 6f74 5f70 726f 6428 2272 6174 656d  phot_prod("ratem
+0002dde0: 6170 222c 206f 6273 5f69 642c 2069 6e73  ap", obs_id, ins
+0002ddf0: 742c 206c 6f5f 656e 2c20 6869 5f65 6e2c  t, lo_en, hi_en,
+0002de00: 2070 7366 5f63 6f72 722c 2070 7366 5f6d   psf_corr, psf_m
+0002de10: 6f64 656c 2c20 7073 665f 6269 6e73 2c20  odel, psf_bins, 
+0002de20: 7073 665f 616c 676f 2c0a 2020 2020 2020  psf_algo,.      
+0002de30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002de40: 2020 2020 2020 2020 2020 2020 2070 7366               psf
+0002de50: 5f69 7465 7229 0a0a 2020 2020 6465 6620  _iter)..    def 
+0002de60: 5f67 6574 5f6c 635f 7072 6f64 2873 656c  _get_lc_prod(sel
+0002de70: 662c 206f 7574 6572 5f72 6164 6975 733a  f, outer_radius:
+0002de80: 2055 6e69 6f6e 5b73 7472 2c20 5175 616e   Union[str, Quan
+0002de90: 7469 7479 5d20 3d20 4e6f 6e65 2c20 6f62  tity] = None, ob
+0002dea0: 735f 6964 3a20 7374 7220 3d20 4e6f 6e65  s_id: str = None
+0002deb0: 2c20 696e 7374 3a20 7374 7220 3d20 4e6f  , inst: str = No
+0002dec0: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+0002ded0: 2020 2020 2020 2020 2069 6e6e 6572 5f72           inner_r
+0002dee0: 6164 6975 733a 2055 6e69 6f6e 5b73 7472  adius: Union[str
+0002def0: 2c20 5175 616e 7469 7479 5d20 3d20 4e6f  , Quantity] = No
+0002df00: 6e65 2c20 6c6f 5f65 6e3a 2051 7561 6e74  ne, lo_en: Quant
+0002df10: 6974 7920 3d20 4e6f 6e65 2c20 6869 5f65  ity = None, hi_e
+0002df20: 6e3a 2051 7561 6e74 6974 7920 3d20 4e6f  n: Quantity = No
+0002df30: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+0002df40: 2020 2020 2020 2020 2074 696d 655f 6269           time_bi
+0002df50: 6e5f 7369 7a65 3a20 5175 616e 7469 7479  n_size: Quantity
+0002df60: 203d 204e 6f6e 6529 205c 0a20 2020 2020   = None) \.     
+0002df70: 2020 2020 2020 202d 3e20 556e 696f 6e5b         -> Union[
+0002df80: 4c69 6768 7443 7572 7665 2c20 4c69 7374  LightCurve, List
+0002df90: 5b4c 6967 6874 4375 7276 655d 2c20 4167  [LightCurve], Ag
+0002dfa0: 6772 6567 6174 654c 6967 6874 4375 7276  gregateLightCurv
+0002dfb0: 652c 204c 6973 745b 4167 6772 6567 6174  e, List[Aggregat
+0002dfc0: 654c 6967 6874 4375 7276 655d 5d3a 0a20  eLightCurve]]:. 
+0002dfd0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0002dfe0: 2020 2041 2070 726f 7465 6374 6564 206d     A protected m
+0002dff0: 6574 686f 6420 746f 2072 6574 7269 6576  ethod to retriev
+0002e000: 6520 5847 4120 4c69 6768 7443 7572 7665  e XGA LightCurve
+0002e010: 206f 626a 6563 7473 2c20 7468 6520 7573   objects, the us
+0002e020: 6572 2073 686f 756c 6420 6e65 7665 7220  er should never 
+0002e030: 696e 7465 7261 6374 2077 6974 6820 7468  interact with th
+0002e040: 6973 2064 6972 6563 746c 792e 0a0a 2020  is directly...  
+0002e050: 2020 2020 2020 3a70 6172 616d 2073 7472        :param str
+0002e060: 2f51 7561 6e74 6974 7920 6f75 7465 725f  /Quantity outer_
+0002e070: 7261 6469 7573 3a20 5468 6520 6e61 6d65  radius: The name
+0002e080: 206f 7220 7661 6c75 6520 6f66 2074 6865   or value of the
+0002e090: 206f 7574 6572 2072 6164 6975 7320 7468   outer radius th
+0002e0a0: 6174 2077 6173 2075 7365 6420 666f 7220  at was used for 
+0002e0b0: 7468 6520 6765 6e65 7261 7469 6f6e 206f  the generation o
+0002e0c0: 660a 2020 2020 2020 2020 2020 2020 7468  f.            th
+0002e0d0: 6520 6c69 6768 7463 7572 7665 2028 666f  e lightcurve (fo
+0002e0e0: 7220 696e 7374 616e 6365 2027 706f 696e  r instance 'poin
+0002e0f0: 7427 2077 6f75 6c64 2062 6520 6163 6365  t' would be acce
+0002e100: 7074 6162 6c65 2066 6f72 2061 2050 6f69  ptable for a Poi
+0002e110: 6e74 536f 7572 6365 2c20 6f72 2051 7561  ntSource, or Qua
+0002e120: 6e74 6974 7928 3130 302c 2027 6b70 6327  ntity(100, 'kpc'
+0002e130: 2929 2e0a 2020 2020 2020 2020 2020 2020  ))..            
+0002e140: 4465 6661 756c 7420 6973 204e 6f6e 652c  Default is None,
+0002e150: 206d 6561 6e69 6e67 2061 6c6c 206c 6967   meaning all lig
+0002e160: 6874 6375 7276 6573 2077 696c 6c20 6265  htcurves will be
+0002e170: 2072 6574 7269 6576 6564 2e0a 2020 2020   retrieved..    
+0002e180: 2020 2020 3a70 6172 616d 2073 7472 206f      :param str o
+0002e190: 6273 5f69 643a 204f 7074 696f 6e61 6c6c  bs_id: Optionall
+0002e1a0: 792c 2061 2073 7065 6369 6669 6320 6f62  y, a specific ob
+0002e1b0: 735f 6964 2074 6f20 7365 6172 6368 2066  s_id to search f
+0002e1c0: 6f72 2063 616e 2062 6520 7375 7070 6c69  or can be suppli
+0002e1d0: 6564 2e20 5468 6520 6465 6661 756c 7420  ed. The default 
+0002e1e0: 6973 204e 6f6e 652c 0a20 2020 2020 2020  is None,.       
+0002e1f0: 2020 2020 2077 6869 6368 206d 6561 6e73       which means
+0002e200: 2061 6c6c 206c 6967 6874 6375 7276 6573   all lightcurves
+0002e210: 206d 6174 6368 696e 6720 7468 6520 6f74   matching the ot
+0002e220: 6865 7220 6372 6974 6572 6961 2077 696c  her criteria wil
+0002e230: 6c20 6265 2072 6574 7572 6e65 642e 0a20  l be returned.. 
+0002e240: 2020 2020 2020 203a 7061 7261 6d20 7374         :param st
+0002e250: 7220 696e 7374 3a20 4f70 7469 6f6e 616c  r inst: Optional
+0002e260: 6c79 2c20 6120 7370 6563 6966 6963 2069  ly, a specific i
+0002e270: 6e73 7472 756d 656e 7420 746f 2073 6561  nstrument to sea
+0002e280: 7263 6820 666f 7220 6361 6e20 6265 2073  rch for can be s
+0002e290: 7570 706c 6965 642e 2054 6865 2064 6566  upplied. The def
+0002e2a0: 6175 6c74 2069 7320 4e6f 6e65 2c0a 2020  ault is None,.  
+0002e2b0: 2020 2020 2020 2020 2020 7768 6963 6820            which 
+0002e2c0: 6d65 616e 7320 616c 6c20 6c69 6768 7463  means all lightc
+0002e2d0: 7572 7665 7320 6d61 7463 6869 6e67 2074  urves matching t
+0002e2e0: 6865 206f 7468 6572 2063 7269 7465 7269  he other criteri
+0002e2f0: 6120 7769 6c6c 2062 6520 7265 7475 726e  a will be return
+0002e300: 6564 2e0a 2020 2020 2020 2020 3a70 6172  ed..        :par
+0002e310: 616d 2073 7472 2f51 7561 6e74 6974 7920  am str/Quantity 
+0002e320: 696e 6e65 725f 7261 6469 7573 3a20 5468  inner_radius: Th
+0002e330: 6520 6e61 6d65 206f 7220 7661 6c75 6520  e name or value 
+0002e340: 6f66 2074 6865 2069 6e6e 6572 2072 6164  of the inner rad
+0002e350: 6975 7320 7468 6174 2077 6173 2075 7365  ius that was use
+0002e360: 6420 666f 7220 7468 6520 6765 6e65 7261  d for the genera
+0002e370: 7469 6f6e 206f 660a 2020 2020 2020 2020  tion of.        
+0002e380: 2020 2020 7468 6520 6c69 6768 7463 7572      the lightcur
+0002e390: 7665 2028 666f 7220 696e 7374 616e 6365  ve (for instance
+0002e3a0: 2027 706f 696e 7427 2077 6f75 6c64 2062   'point' would b
+0002e3b0: 6520 6163 6365 7074 6162 6c65 2066 6f72  e acceptable for
+0002e3c0: 2061 2050 6f69 6e74 536f 7572 6365 2c20   a PointSource, 
+0002e3d0: 6f72 2051 7561 6e74 6974 7928 302c 2027  or Quantity(0, '
+0002e3e0: 6b70 6327 2929 2e0a 2020 2020 2020 2020  kpc'))..        
+0002e3f0: 2020 2020 4465 6661 756c 7420 6973 204e      Default is N
+0002e400: 6f6e 652c 206d 6561 6e69 6e67 2061 6c6c  one, meaning all
+0002e410: 206c 6967 6874 6375 7276 6573 2077 696c   lightcurves wil
+0002e420: 6c20 6265 2072 6574 7269 6576 6564 2e0a  l be retrieved..
+0002e430: 2020 2020 2020 2020 3a70 6172 616d 2051          :param Q
+0002e440: 7561 6e74 6974 7920 6c6f 5f65 6e3a 2054  uantity lo_en: T
+0002e450: 6865 206c 6f77 6572 2065 6e65 7267 7920  he lower energy 
+0002e460: 6c69 6d69 7420 6f66 2074 6865 206c 6967  limit of the lig
+0002e470: 6874 6375 7276 6573 2079 6f75 2077 6973  htcurves you wis
+0002e480: 6820 746f 2072 6574 7269 6576 652c 2074  h to retrieve, t
+0002e490: 6865 2064 6566 6175 6c74 0a20 2020 2020  he default.     
+0002e4a0: 2020 2020 2020 2069 7320 4e6f 6e65 2028         is None (
+0002e4b0: 7768 6963 6820 7769 6c6c 2072 6574 7269  which will retri
+0002e4c0: 6576 6520 616c 6c20 6c69 6768 7463 7572  eve all lightcur
+0002e4d0: 7665 7320 7265 6761 7264 6c65 7373 206f  ves regardless o
+0002e4e0: 6620 656e 6572 6779 206c 696d 6974 292e  f energy limit).
+0002e4f0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+0002e500: 5175 616e 7469 7479 2068 695f 656e 3a20  Quantity hi_en: 
+0002e510: 5468 6520 7570 7065 7220 656e 6572 6779  The upper energy
+0002e520: 206c 696d 6974 206f 6620 7468 6520 6c69   limit of the li
+0002e530: 6768 7463 7572 7665 7320 796f 7520 7769  ghtcurves you wi
+0002e540: 7368 2074 6f20 7265 7472 6965 7665 2c20  sh to retrieve, 
+0002e550: 7468 6520 6465 6661 756c 740a 2020 2020  the default.    
+0002e560: 2020 2020 2020 2020 6973 204e 6f6e 6520          is None 
+0002e570: 2877 6869 6368 2077 696c 6c20 7265 7472  (which will retr
+0002e580: 6965 7665 2061 6c6c 206c 6967 6874 6375  ieve all lightcu
+0002e590: 7276 6573 2072 6567 6172 646c 6573 7320  rves regardless 
+0002e5a0: 6f66 2065 6e65 7267 7920 6c69 6d69 7429  of energy limit)
+0002e5b0: 2e0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
+0002e5c0: 2051 7561 6e74 6974 7920 7469 6d65 5f62   Quantity time_b
+0002e5d0: 696e 5f73 697a 653a 2054 6865 2074 696d  in_size: The tim
+0002e5e0: 6520 6269 6e20 7369 7a65 2075 7365 6420  e bin size used 
+0002e5f0: 746f 2067 656e 6572 6174 6520 7468 6520  to generate the 
+0002e600: 6465 7369 7265 6420 6c69 6768 7463 7572  desired lightcur
+0002e610: 7665 2e20 5468 6520 6465 6661 756c 7420  ve. The default 
+0002e620: 7661 6c75 650a 2020 2020 2020 2020 2020  value.          
+0002e630: 2020 6973 204e 6f6e 652c 2069 6e20 7768    is None, in wh
+0002e640: 6963 6820 6361 7365 2061 6c6c 206c 6967  ich case all lig
+0002e650: 6874 6375 7276 6573 206d 6174 6368 696e  htcurves matchin
+0002e660: 6720 6f74 6865 7220 6372 6974 6572 6961  g other criteria
+0002e670: 2077 696c 6c20 6265 2072 6574 7269 6576   will be retriev
+0002e680: 6564 2e0a 2020 2020 2020 2020 3a72 6574  ed..        :ret
+0002e690: 7572 6e3a 2041 6e20 5847 4120 4c69 6768  urn: An XGA Ligh
+0002e6a0: 7443 7572 7665 206f 626a 6563 7420 2869  tCurve object (i
+0002e6b0: 6620 7468 6572 6520 6973 2061 6e20 6578  f there is an ex
+0002e6c0: 6163 7420 6d61 7463 6829 2c20 6f72 2061  act match), or a
+0002e6d0: 206c 6973 7420 6f66 2058 4741 204c 6967   list of XGA Lig
+0002e6e0: 6874 4375 7276 6520 6f62 6a65 6374 7320  htCurve objects 
+0002e6f0: 2869 6620 7468 6572 650a 2020 2020 2020  (if there.      
+0002e700: 2020 2020 2020 7765 7265 206d 756c 7469        were multi
+0002e710: 706c 6520 6d61 7463 6869 6e67 2070 726f  ple matching pro
+0002e720: 6475 6374 7329 2c20 6f72 2061 2073 696e  ducts), or a sin
+0002e730: 676c 652f 6c69 7374 206f 6620 4167 6772  gle/list of Aggr
+0002e740: 6567 6174 654c 6967 6874 4375 7276 6520  egateLightCurve 
+0002e750: 6f62 6a65 6374 732e 0a20 2020 2020 2020  objects..       
+0002e760: 203a 7274 7970 653a 2055 6e69 6f6e 5b4c   :rtype: Union[L
+0002e770: 6967 6874 4375 7276 652c 204c 6973 745b  ightCurve, List[
+0002e780: 4c69 6768 7443 7572 7665 5d2c 2041 6767  LightCurve], Agg
+0002e790: 7265 6761 7465 4c69 6768 7443 7572 7665  regateLightCurve
+0002e7a0: 2c20 4c69 7374 5b41 6767 7265 6761 7465  , List[Aggregate
+0002e7b0: 4c69 6768 7443 7572 7665 5d5d 0a20 2020  LightCurve]].   
+0002e7c0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0002e7d0: 2023 2053 6574 2075 7020 7365 6172 6368   # Set up search
+0002e7e0: 2073 7472 696e 6773 2028 666f 7220 7468   strings (for th
+0002e7f0: 6520 7072 6f64 7563 7420 7374 6f72 6167  e product storag
+0002e800: 6520 6b65 7973 2920 666f 7220 7468 6520  e keys) for the 
+0002e810: 696e 6e65 7220 616e 6420 6f75 7465 7220  inner and outer 
+0002e820: 7261 6469 6920 6865 7265 2e20 5468 6520  radii here. The 
+0002e830: 6465 6661 756c 7420 4e6f 6e65 0a20 2020  default None.   
+0002e840: 2020 2020 2023 2020 7661 6c75 6520 6a75       #  value ju
+0002e850: 7374 2063 7265 6174 6573 2061 206b 6579  st creates a key
+0002e860: 2074 6861 7420 6c6f 6f6b 7320 666f 7220   that looks for 
+0002e870: 7468 6520 2772 6927 206f 7220 2772 6f27  the 'ri' or 'ro'
+0002e880: 2070 7265 6375 7273 6f72 2074 6f20 7468   precursor to th
+0002e890: 6520 7661 6c75 6520 696e 2074 6865 206b  e value in the k
+0002e8a0: 6579 2c20 692e 652e 2069 7420 646f 6573  ey, i.e. it does
+0002e8b0: 6e27 740a 2020 2020 2020 2020 2320 2064  n't.        #  d
+0002e8c0: 6f20 616e 7974 6869 6e67 202d 2077 6520  o anything - we 
+0002e8d0: 616c 736f 206d 616b 6520 7375 7265 2074  also make sure t
+0002e8e0: 6861 7420 616e 7920 7261 6469 6920 7061  hat any radii pa
+0002e8f0: 7373 6564 2062 7920 7468 6520 7573 6572  ssed by the user
+0002e900: 2061 7265 2063 6f6e 7665 7274 6564 2070   are converted p
+0002e910: 726f 7065 726c 790a 2020 2020 2020 2020  roperly.        
+0002e920: 6966 2069 6e6e 6572 5f72 6164 6975 7320  if inner_radius 
+0002e930: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
+0002e940: 6973 696e 7374 616e 6365 2869 6e6e 6572  isinstance(inner
+0002e950: 5f72 6164 6975 732c 2051 7561 6e74 6974  _radius, Quantit
+0002e960: 7929 3a0a 2020 2020 2020 2020 2020 2020  y):.            
+0002e970: 696e 6e5f 7261 645f 7365 6172 6368 203d  inn_rad_search =
+0002e980: 2027 5f72 697b 7d5f 272e 666f 726d 6174   '_ri{}_'.format
+0002e990: 2873 656c 662e 636f 6e76 6572 745f 7261  (self.convert_ra
+0002e9a0: 6469 7573 2869 6e6e 6572 5f72 6164 6975  dius(inner_radiu
+0002e9b0: 732c 2027 6465 6727 292e 7661 6c75 6529  s, 'deg').value)
+0002e9c0: 0a20 2020 2020 2020 2065 6c69 6620 696e  .        elif in
+0002e9d0: 6e65 725f 7261 6469 7573 2069 7320 6e6f  ner_radius is no
+0002e9e0: 7420 4e6f 6e65 2061 6e64 2069 7369 6e73  t None and isins
+0002e9f0: 7461 6e63 6528 696e 6e65 725f 7261 6469  tance(inner_radi
+0002ea00: 7573 2c20 7374 7229 3a0a 2020 2020 2020  us, str):.      
+0002ea10: 2020 2020 2020 696e 6e5f 7261 645f 7365        inn_rad_se
+0002ea20: 6172 6368 203d 2027 5f72 697b 7d5f 272e  arch = '_ri{}_'.
+0002ea30: 666f 726d 6174 2873 656c 662e 6765 745f  format(self.get_
+0002ea40: 7261 6469 7573 2869 6e6e 6572 5f72 6164  radius(inner_rad
+0002ea50: 6975 732c 2027 6465 6727 292e 7661 6c75  ius, 'deg').valu
+0002ea60: 6529 0a20 2020 2020 2020 2065 6c69 6620  e).        elif 
+0002ea70: 696e 6e65 725f 7261 6469 7573 2069 7320  inner_radius is 
+0002ea80: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0002ea90: 2020 696e 6e5f 7261 645f 7365 6172 6368    inn_rad_search
+0002eaa0: 203d 2022 5f72 6922 0a20 2020 2020 2020   = "_ri".       
+0002eab0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0002eac0: 2020 2072 6169 7365 2054 7970 6545 7272     raise TypeErr
+0002ead0: 6f72 2822 596f 7520 6d61 7920 6f6e 6c79  or("You may only
+0002eae0: 2070 6173 7320 6120 7175 616e 7469 7479   pass a quantity
+0002eaf0: 206f 7220 6120 7374 7269 6e67 2061 7320   or a string as 
+0002eb00: 696e 6e65 725f 7261 6469 7573 2229 0a0a  inner_radius")..
+0002eb10: 2020 2020 2020 2020 6966 206f 7574 6572          if outer
+0002eb20: 5f72 6164 6975 7320 6973 206e 6f74 204e  _radius is not N
+0002eb30: 6f6e 6520 616e 6420 6973 696e 7374 616e  one and isinstan
+0002eb40: 6365 286f 7574 6572 5f72 6164 6975 732c  ce(outer_radius,
+0002eb50: 2051 7561 6e74 6974 7929 3a0a 2020 2020   Quantity):.    
+0002eb60: 2020 2020 2020 2020 6f75 745f 7261 645f          out_rad_
+0002eb70: 7365 6172 6368 203d 2027 5f72 6f7b 7d5f  search = '_ro{}_
+0002eb80: 272e 666f 726d 6174 2873 656c 662e 636f  '.format(self.co
+0002eb90: 6e76 6572 745f 7261 6469 7573 286f 7574  nvert_radius(out
+0002eba0: 6572 5f72 6164 6975 732c 2027 6465 6727  er_radius, 'deg'
+0002ebb0: 292e 7661 6c75 6529 0a20 2020 2020 2020  ).value).       
+0002ebc0: 2065 6c69 6620 6f75 7465 725f 7261 6469   elif outer_radi
+0002ebd0: 7573 2069 7320 6e6f 7420 4e6f 6e65 2061  us is not None a
+0002ebe0: 6e64 2069 7369 6e73 7461 6e63 6528 6f75  nd isinstance(ou
+0002ebf0: 7465 725f 7261 6469 7573 2c20 7374 7229  ter_radius, str)
+0002ec00: 3a0a 2020 2020 2020 2020 2020 2020 6f75  :.            ou
+0002ec10: 745f 7261 645f 7365 6172 6368 203d 2027  t_rad_search = '
+0002ec20: 5f72 6f7b 7d5f 272e 666f 726d 6174 2873  _ro{}_'.format(s
+0002ec30: 656c 662e 6765 745f 7261 6469 7573 286f  elf.get_radius(o
+0002ec40: 7574 6572 5f72 6164 6975 732c 2027 6465  uter_radius, 'de
+0002ec50: 6727 292e 7661 6c75 6529 0a20 2020 2020  g').value).     
+0002ec60: 2020 2065 6c69 6620 6f75 7465 725f 7261     elif outer_ra
+0002ec70: 6469 7573 2069 7320 4e6f 6e65 3a0a 2020  dius is None:.  
+0002ec80: 2020 2020 2020 2020 2020 6f75 745f 7261            out_ra
+0002ec90: 645f 7365 6172 6368 203d 2022 5f72 6f22  d_search = "_ro"
+0002eca0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0002ecb0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+0002ecc0: 2054 7970 6545 7272 6f72 2822 596f 7520   TypeError("You 
+0002ecd0: 6d61 7920 6f6e 6c79 2070 6173 7320 6120  may only pass a 
+0002ece0: 7175 616e 7469 7479 206f 7220 6120 7374  quantity or a st
+0002ecf0: 7269 6e67 2061 7320 6f75 7465 725f 7261  ring as outer_ra
+0002ed00: 6469 7573 2229 0a0a 2020 2020 2020 2020  dius")..        
+0002ed10: 2320 4368 6563 6b20 746f 206d 616b 6520  # Check to make 
+0002ed20: 7375 7265 2074 6861 7420 7468 6520 7469  sure that the ti
+0002ed30: 6d65 2062 696e 2073 697a 6520 6973 2061  me bin size is a
+0002ed40: 206c 6567 616c 2076 616c 7565 2c20 616e   legal value, an
+0002ed50: 6420 7365 7420 7570 2061 2073 6561 7263  d set up a searc
+0002ed60: 6820 7374 7269 6e67 2066 6f72 2074 6865  h string for the
+0002ed70: 2074 696d 6520 6269 6e0a 2020 2020 2020   time bin.      
+0002ed80: 2020 2320 2073 697a 6520 696e 206f 7264    #  size in ord
+0002ed90: 6572 2074 6f20 6e61 7272 6f77 2064 6f77  er to narrow dow
+0002eda0: 6e20 7468 6520 6c69 6768 7463 7572 7665  n the lightcurve
+0002edb0: 7320 746f 206a 7573 7420 7468 6520 6f6e  s to just the on
+0002edc0: 6573 2074 6861 7420 7468 6520 7573 6572  es that the user
+0002edd0: 2077 616e 7473 0a20 2020 2020 2020 2069   wants.        i
+0002ede0: 6620 7469 6d65 5f62 696e 5f73 697a 6520  f time_bin_size 
+0002edf0: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
+0002ee00: 6e6f 7420 7469 6d65 5f62 696e 5f73 697a  not time_bin_siz
+0002ee10: 652e 756e 6974 2e69 735f 6571 7569 7661  e.unit.is_equiva
+0002ee20: 6c65 6e74 2827 7327 293a 0a20 2020 2020  lent('s'):.     
+0002ee30: 2020 2020 2020 2072 6169 7365 2055 6e69         raise Uni
+0002ee40: 7443 6f6e 7665 7273 696f 6e45 7272 6f72  tConversionError
+0002ee50: 2822 5468 6520 2774 696d 655f 6269 6e5f  ("The 'time_bin_
+0002ee60: 7369 7a65 2720 6172 6775 6d65 6e74 206d  size' argument m
+0002ee70: 7573 7420 6265 2063 6f6e 7665 7274 6962  ust be convertib
+0002ee80: 6c65 2074 6f20 7365 636f 6e64 732e 2229  le to seconds.")
+0002ee90: 0a20 2020 2020 2020 2065 6c69 6620 7469  .        elif ti
+0002eea0: 6d65 5f62 696e 5f73 697a 6520 6973 204e  me_bin_size is N
+0002eeb0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0002eec0: 2074 696d 655f 6269 6e5f 7365 6172 6368   time_bin_search
+0002eed0: 203d 2027 5f74 696d 6562 696e 270a 2020   = '_timebin'.  
+0002eee0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0002eef0: 2020 2020 2020 2020 7469 6d65 5f62 696e          time_bin
+0002ef00: 5f73 6561 7263 6820 3d20 275f 7469 6d65  _search = '_time
+0002ef10: 6269 6e7b 7d27 2e66 6f72 6d61 7428 7469  bin{}'.format(ti
+0002ef20: 6d65 5f62 696e 5f73 697a 652e 746f 2827  me_bin_size.to('
+0002ef30: 7327 292e 7661 6c75 6529 0a0a 2020 2020  s').value)..    
+0002ef40: 2020 2020 2320 5365 7474 696e 6720 7570      # Setting up
+0002ef50: 2074 6865 2065 6e65 7267 7920 6261 6e64   the energy band
+0002ef60: 2073 6561 7263 6820 7374 7269 6e67 202d   search string -
+0002ef70: 2069 6620 6f6e 6520 626f 756e 6420 6973   if one bound is
+0002ef80: 2073 7065 6369 6669 6564 2074 6865 6e20   specified then 
+0002ef90: 7468 6520 6f74 6865 7220 6861 7320 746f  the other has to
+0002efa0: 2062 6520 6173 2077 656c 6c2c 2049 0a20   be as well, I. 
+0002efb0: 2020 2020 2020 2023 2020 6469 646e 2774         #  didn't
+0002efc0: 2074 6869 6e6b 2069 7420 6d61 6465 2073   think it made s
+0002efd0: 656e 7365 206f 7468 6572 7769 7365 0a20  ense otherwise. 
+0002efe0: 2020 2020 2020 2069 6620 616e 7928 5b6c         if any([l
+0002eff0: 6f5f 656e 2069 7320 6e6f 7420 4e6f 6e65  o_en is not None
+0002f000: 2c20 6869 5f65 6e20 6973 206e 6f74 204e  , hi_en is not N
+0002f010: 6f6e 655d 2920 616e 6420 6e6f 7420 616c  one]) and not al
+0002f020: 6c28 5b6c 6f5f 656e 2069 7320 6e6f 7420  l([lo_en is not 
+0002f030: 4e6f 6e65 2c20 6869 5f65 6e20 6973 206e  None, hi_en is n
+0002f040: 6f74 204e 6f6e 655d 293a 0a20 2020 2020  ot None]):.     
+0002f050: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+0002f060: 7565 4572 726f 7228 2254 6865 2027 6c6f  ueError("The 'lo
+0002f070: 5f65 6e27 2061 6e64 2027 6869 5f65 6e27  _en' and 'hi_en'
+0002f080: 2076 616c 7565 7320 6d75 7374 2065 6974   values must eit
+0002f090: 6865 7220 626f 7468 2062 6520 4e6f 6e65  her both be None
+0002f0a0: 2c20 6f72 2062 6f74 6820 6265 2061 6e20  , or both be an 
+0002f0b0: 656e 6572 6779 2076 616c 7565 2e22 290a  energy value.").
+0002f0c0: 2020 2020 2020 2020 6966 2028 6c6f 5f65          if (lo_e
+0002f0d0: 6e20 6973 206e 6f74 204e 6f6e 6520 616e  n is not None an
+0002f0e0: 6420 6e6f 7420 6c6f 5f65 6e2e 756e 6974  d not lo_en.unit
+0002f0f0: 2e69 735f 6571 7569 7661 6c65 6e74 2827  .is_equivalent('
+0002f100: 6b65 5627 2929 206f 7220 5c0a 2020 2020  keV')) or \.    
+0002f110: 2020 2020 2020 2020 2020 2020 2868 695f              (hi_
+0002f120: 656e 2069 7320 6e6f 7420 4e6f 6e65 2061  en is not None a
+0002f130: 6e64 206e 6f74 2068 695f 656e 2e75 6e69  nd not hi_en.uni
+0002f140: 742e 6973 5f65 7175 6976 616c 656e 7428  t.is_equivalent(
+0002f150: 276b 6556 2729 293a 0a20 2020 2020 2020  'keV')):.       
+0002f160: 2020 2020 2072 6169 7365 2055 6e69 7443       raise UnitC
+0002f170: 6f6e 7665 7273 696f 6e45 7272 6f72 2822  onversionError("
+0002f180: 5468 6520 276c 6f5f 656e 2720 616e 6420  The 'lo_en' and 
+0002f190: 2768 695f 656e 2720 6172 6775 6d65 6e74  'hi_en' argument
+0002f1a0: 7320 6d75 7374 2062 6520 636f 6e76 6572  s must be conver
+0002f1b0: 7469 626c 6520 746f 206b 6556 2e22 290a  tible to keV.").
+0002f1c0: 2020 2020 2020 2020 2320 4966 2065 6974          # If eit
+0002f1d0: 6865 7220 6973 204e 6f6e 6520 7468 656e  her is None then
+0002f1e0: 2077 6520 6b6e 6f77 2062 6f74 6820 6172   we know both ar
+0002f1f0: 6520 6265 6361 7573 6520 7765 2063 6865  e because we che
+0002f200: 636b 6564 2065 6172 6c69 6572 0a20 2020  cked earlier.   
+0002f210: 2020 2020 2065 6c69 6620 6c6f 5f65 6e20       elif lo_en 
+0002f220: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+0002f230: 2020 2020 2065 6e5f 7365 6172 6368 203d       en_search =
+0002f240: 2027 626f 756e 645f 270a 2020 2020 2020   'bound_'.      
+0002f250: 2020 656c 6966 206c 6f5f 656e 2069 7320    elif lo_en is 
+0002f260: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+0002f270: 2020 2020 2020 656e 5f73 6561 7263 6820        en_search 
+0002f280: 3d20 2762 6f75 6e64 5f7b 6c7d 2d7b 757d  = 'bound_{l}-{u}
+0002f290: 272e 666f 726d 6174 286c 3d6c 6f5f 656e  '.format(l=lo_en
+0002f2a0: 2e74 6f28 276b 6556 2729 2e76 616c 7565  .to('keV').value
+0002f2b0: 2c20 753d 6869 5f65 6e2e 746f 2827 6b65  , u=hi_en.to('ke
+0002f2c0: 5627 292e 7661 6c75 6529 0a0a 2020 2020  V').value)..    
+0002f2d0: 2020 2020 6966 206f 6273 5f69 6420 3d3d      if obs_id ==
+0002f2e0: 2027 636f 6d62 696e 6564 273a 0a20 2020   'combined':.   
+0002f2f0: 2020 2020 2020 2020 2073 6561 7263 685f           search_
+0002f300: 6b65 7920 3d20 2763 6f6d 6269 6e65 645f  key = 'combined_
+0002f310: 6c69 6768 7463 7572 7665 270a 2020 2020  lightcurve'.    
+0002f320: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0002f330: 2020 2020 2020 7365 6172 6368 5f6b 6579        search_key
+0002f340: 203d 2027 6c69 6768 7463 7572 7665 270a   = 'lightcurve'.
+0002f350: 2020 2020 2020 2020 2320 4772 6162 6269          # Grabbi
+0002f360: 6e67 2065 7665 7279 2073 696e 676c 6520  ng every single 
+0002f370: 6c69 6768 7463 7572 7665 2074 6861 7420  lightcurve that 
+0002f380: 6d61 7463 6865 7320 4f62 7349 4420 616e  matches ObsID an
+0002f390: 6420 696e 7374 2070 6173 7365 6420 6279  d inst passed by
+0002f3a0: 2074 6865 2075 7365 7220 2872 656d 656d   the user (remem
+0002f3b0: 6265 7220 7468 6579 2063 6f75 6c64 2062  ber they could b
+0002f3c0: 650a 2020 2020 2020 2020 2320 204e 6f6e  e.        #  Non
+0002f3d0: 6520 7661 6c75 6573 2c20 696e 6465 6564  e values, indeed
+0002f3e0: 2074 6865 7920 6172 6520 6279 2064 6566   they are by def
+0002f3f0: 6175 6c74 2920 2d20 7765 276c 6c20 7468  ault) - we'll th
+0002f400: 656e 2073 7765 6570 2074 6872 6f75 6768  en sweep through
+0002f410: 2077 6861 7465 7665 7220 6c69 7374 2069   whatever list i
+0002f420: 7320 7265 7475 726e 6564 2061 6e64 0a20  s returned and. 
+0002f430: 2020 2020 2020 2023 2020 6e61 7272 6f77         #  narrow
+0002f440: 2074 6865 6d20 646f 776e 0a20 2020 2020   them down.     
+0002f450: 2020 2061 6c6c 5f6c 6373 203d 2073 656c     all_lcs = sel
+0002f460: 662e 6765 745f 7072 6f64 7563 7473 2873  f.get_products(s
+0002f470: 6561 7263 685f 6b65 792c 206f 6273 5f69  earch_key, obs_i
+0002f480: 642c 2069 6e73 7429 0a20 2020 2020 2020  d, inst).       
+0002f490: 2023 2049 7420 7761 7320 6765 7474 696e   # It was gettin
+0002f4a0: 6720 746f 2074 6865 2070 6f69 6e74 2077  g to the point w
+0002f4b0: 6865 7265 2061 206c 6973 7420 636f 6d70  here a list comp
+0002f4c0: 7265 6865 6e73 696f 6e20 7761 7320 6c65  rehension was le
+0002f4d0: 7373 2072 6561 6461 626c 6520 7468 616e  ss readable than
+0002f4e0: 2061 2066 6f72 206c 6f6f 702c 2070 6172   a for loop, par
+0002f4f0: 7469 6375 6c61 726c 790a 2020 2020 2020  ticularly.      
+0002f500: 2020 2320 2077 6974 6820 7468 6520 7061    #  with the pa
+0002f510: 7474 6572 6e20 6c6f 6769 632c 2073 6f20  ttern logic, so 
+0002f520: 4920 6368 616e 6765 6420 6974 2074 6f20  I changed it to 
+0002f530: 7468 6973 0a20 2020 2020 2020 206d 6174  this.        mat
+0002f540: 6368 6564 5f70 726f 6473 203d 205b 5d0a  ched_prods = [].
+0002f550: 2020 2020 2020 2020 666f 7220 6c63 2069          for lc i
+0002f560: 6e20 616c 6c5f 6c63 733a 0a20 2020 2020  n all_lcs:.     
+0002f570: 2020 2020 2020 2069 6620 6f75 745f 7261         if out_ra
+0002f580: 645f 7365 6172 6368 2069 6e20 6c63 2e73  d_search in lc.s
+0002f590: 746f 7261 6765 5f6b 6579 2061 6e64 2069  torage_key and i
+0002f5a0: 6e6e 5f72 6164 5f73 6561 7263 6820 696e  nn_rad_search in
+0002f5b0: 206c 632e 7374 6f72 6167 655f 6b65 7920   lc.storage_key 
+0002f5c0: 616e 6420 5c0a 2020 2020 2020 2020 2020  and \.          
+0002f5d0: 2020 2020 2020 2020 2020 7469 6d65 5f62            time_b
+0002f5e0: 696e 5f73 6561 7263 6820 696e 206c 632e  in_search in lc.
+0002f5f0: 7374 6f72 6167 655f 6b65 7920 616e 6420  storage_key and 
+0002f600: 656e 5f73 6561 7263 6820 696e 206c 632e  en_search in lc.
+0002f610: 7374 6f72 6167 655f 6b65 793a 0a20 2020  storage_key:.   
+0002f620: 2020 2020 2020 2020 2020 2020 206d 6174               mat
+0002f630: 6368 6564 5f70 726f 6473 2e61 7070 656e  ched_prods.appen
+0002f640: 6428 6c63 290a 0a20 2020 2020 2020 2069  d(lc)..        i
+0002f650: 6620 6c65 6e28 6d61 7463 6865 645f 7072  f len(matched_pr
+0002f660: 6f64 7329 203d 3d20 303a 0a20 2020 2020  ods) == 0:.     
+0002f670: 2020 2020 2020 2072 6169 7365 204e 6f50         raise NoP
+0002f680: 726f 6475 6374 4176 6169 6c61 626c 6545  roductAvailableE
+0002f690: 7272 6f72 2822 4361 6e6e 6f74 2066 696e  rror("Cannot fin
+0002f6a0: 6420 616e 7920 6c69 6768 7463 7572 7665  d any lightcurve
+0002f6b0: 7320 6d61 7463 6869 6e67 2079 6f75 7220  s matching your 
+0002f6c0: 696e 7075 742e 2229 0a0a 2020 2020 2020  input.")..      
+0002f6d0: 2020 7265 7475 726e 206d 6174 6368 6564    return matched
+0002f6e0: 5f70 726f 6473 0a0a 2020 2020 6465 6620  _prods..    def 
+0002f6f0: 6765 745f 6c69 6768 7463 7572 7665 7328  get_lightcurves(
+0002f700: 7365 6c66 2c20 6f75 7465 725f 7261 6469  self, outer_radi
+0002f710: 7573 3a20 556e 696f 6e5b 7374 722c 2051  us: Union[str, Q
+0002f720: 7561 6e74 6974 795d 203d 204e 6f6e 652c  uantity] = None,
+0002f730: 206f 6273 5f69 643a 2073 7472 203d 204e   obs_id: str = N
+0002f740: 6f6e 652c 2069 6e73 743a 2073 7472 203d  one, inst: str =
+0002f750: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
+0002f760: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0002f770: 6e6e 6572 5f72 6164 6975 733a 2055 6e69  nner_radius: Uni
+0002f780: 6f6e 5b73 7472 2c20 5175 616e 7469 7479  on[str, Quantity
+0002f790: 5d20 3d20 4e6f 6e65 2c20 6c6f 5f65 6e3a  ] = None, lo_en:
+0002f7a0: 2051 7561 6e74 6974 7920 3d20 4e6f 6e65   Quantity = None
+0002f7b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002f7c0: 2020 2020 2020 2020 2020 6869 5f65 6e3a            hi_en:
+0002f7d0: 2051 7561 6e74 6974 7920 3d20 4e6f 6e65   Quantity = None
+0002f7e0: 2c20 7469 6d65 5f62 696e 5f73 697a 653a  , time_bin_size:
+0002f7f0: 2051 7561 6e74 6974 7920 3d20 4e6f 6e65   Quantity = None
+0002f800: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002f810: 2020 2020 2020 2020 2020 7061 7474 6572            patter
+0002f820: 6e3a 2055 6e69 6f6e 5b64 6963 742c 2073  n: Union[dict, s
+0002f830: 7472 5d20 3d20 2764 6566 6175 6c74 2729  tr] = 'default')
+0002f840: 202d 3e20 556e 696f 6e5b 4c69 6768 7443   -> Union[LightC
+0002f850: 7572 7665 2c20 4c69 7374 5b4c 6967 6874  urve, List[Light
+0002f860: 4375 7276 655d 5d3a 0a20 2020 2020 2020  Curve]]:.       
+0002f870: 2022 2222 0a20 2020 2020 2020 2041 206d   """.        A m
+0002f880: 6574 686f 6420 746f 2072 6574 7269 6576  ethod to retriev
+0002f890: 6520 5847 4120 4c69 6768 7443 7572 7665  e XGA LightCurve
+0002f8a0: 206f 626a 6563 7473 2e0a 0a20 2020 2020   objects...     
+0002f8b0: 2020 203a 7061 7261 6d20 7374 722f 5175     :param str/Qu
+0002f8c0: 616e 7469 7479 206f 7574 6572 5f72 6164  antity outer_rad
+0002f8d0: 6975 733a 2054 6865 206e 616d 6520 6f72  ius: The name or
+0002f8e0: 2076 616c 7565 206f 6620 7468 6520 6f75   value of the ou
+0002f8f0: 7465 7220 7261 6469 7573 2074 6861 7420  ter radius that 
+0002f900: 7761 7320 7573 6564 2066 6f72 2074 6865  was used for the
+0002f910: 2067 656e 6572 6174 696f 6e20 6f66 0a20   generation of. 
+0002f920: 2020 2020 2020 2020 2020 2074 6865 206c             the l
+0002f930: 6967 6874 6375 7276 6520 2866 6f72 2069  ightcurve (for i
+0002f940: 6e73 7461 6e63 6520 2770 6f69 6e74 2720  nstance 'point' 
+0002f950: 776f 756c 6420 6265 2061 6363 6570 7461  would be accepta
+0002f960: 626c 6520 666f 7220 6120 506f 696e 7453  ble for a PointS
+0002f970: 6f75 7263 652c 206f 7220 5175 616e 7469  ource, or Quanti
+0002f980: 7479 2831 3030 2c20 276b 7063 2729 292e  ty(100, 'kpc')).
+0002f990: 0a20 2020 2020 2020 2020 2020 2044 6566  .            Def
+0002f9a0: 6175 6c74 2069 7320 4e6f 6e65 2c20 6d65  ault is None, me
+0002f9b0: 616e 696e 6720 616c 6c20 6c69 6768 7463  aning all lightc
+0002f9c0: 7572 7665 7320 7769 6c6c 2062 6520 7265  urves will be re
+0002f9d0: 7472 6965 7665 642e 0a20 2020 2020 2020  trieved..       
+0002f9e0: 203a 7061 7261 6d20 7374 7220 6f62 735f   :param str obs_
+0002f9f0: 6964 3a20 4f70 7469 6f6e 616c 6c79 2c20  id: Optionally, 
+0002fa00: 6120 7370 6563 6966 6963 206f 6273 5f69  a specific obs_i
+0002fa10: 6420 746f 2073 6561 7263 6820 666f 7220  d to search for 
+0002fa20: 6361 6e20 6265 2073 7570 706c 6965 642e  can be supplied.
+0002fa30: 2054 6865 2064 6566 6175 6c74 2069 7320   The default is 
+0002fa40: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+0002fa50: 2020 7768 6963 6820 6d65 616e 7320 616c    which means al
+0002fa60: 6c20 6c69 6768 7463 7572 7665 7320 6d61  l lightcurves ma
+0002fa70: 7463 6869 6e67 2074 6865 206f 7468 6572  tching the other
+0002fa80: 2063 7269 7465 7269 6120 7769 6c6c 2062   criteria will b
+0002fa90: 6520 7265 7475 726e 6564 2e0a 2020 2020  e returned..    
+0002faa0: 2020 2020 3a70 6172 616d 2073 7472 2069      :param str i
+0002fab0: 6e73 743a 204f 7074 696f 6e61 6c6c 792c  nst: Optionally,
+0002fac0: 2061 2073 7065 6369 6669 6320 696e 7374   a specific inst
+0002fad0: 7275 6d65 6e74 2074 6f20 7365 6172 6368  rument to search
+0002fae0: 2066 6f72 2063 616e 2062 6520 7375 7070   for can be supp
+0002faf0: 6c69 6564 2e20 5468 6520 6465 6661 756c  lied. The defaul
+0002fb00: 7420 6973 204e 6f6e 652c 0a20 2020 2020  t is None,.     
+0002fb10: 2020 2020 2020 2077 6869 6368 206d 6561         which mea
+0002fb20: 6e73 2061 6c6c 206c 6967 6874 6375 7276  ns all lightcurv
+0002fb30: 6573 206d 6174 6368 696e 6720 7468 6520  es matching the 
+0002fb40: 6f74 6865 7220 6372 6974 6572 6961 2077  other criteria w
+0002fb50: 696c 6c20 6265 2072 6574 7572 6e65 642e  ill be returned.
+0002fb60: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+0002fb70: 7374 722f 5175 616e 7469 7479 2069 6e6e  str/Quantity inn
+0002fb80: 6572 5f72 6164 6975 733a 2054 6865 206e  er_radius: The n
+0002fb90: 616d 6520 6f72 2076 616c 7565 206f 6620  ame or value of 
+0002fba0: 7468 6520 696e 6e65 7220 7261 6469 7573  the inner radius
+0002fbb0: 2074 6861 7420 7761 7320 7573 6564 2066   that was used f
+0002fbc0: 6f72 2074 6865 2067 656e 6572 6174 696f  or the generatio
+0002fbd0: 6e20 6f66 0a20 2020 2020 2020 2020 2020  n of.           
+0002fbe0: 2074 6865 206c 6967 6874 6375 7276 6520   the lightcurve 
+0002fbf0: 2866 6f72 2069 6e73 7461 6e63 6520 2770  (for instance 'p
+0002fc00: 6f69 6e74 2720 776f 756c 6420 6265 2061  oint' would be a
+0002fc10: 6363 6570 7461 626c 6520 666f 7220 6120  cceptable for a 
+0002fc20: 506f 696e 7453 6f75 7263 652c 206f 7220  PointSource, or 
+0002fc30: 5175 616e 7469 7479 2830 2c20 276b 7063  Quantity(0, 'kpc
+0002fc40: 2729 292e 0a20 2020 2020 2020 2020 2020  '))..           
+0002fc50: 2044 6566 6175 6c74 2069 7320 4e6f 6e65   Default is None
+0002fc60: 2c20 6d65 616e 696e 6720 616c 6c20 6c69  , meaning all li
+0002fc70: 6768 7463 7572 7665 7320 7769 6c6c 2062  ghtcurves will b
+0002fc80: 6520 7265 7472 6965 7665 642e 0a20 2020  e retrieved..   
+0002fc90: 2020 2020 203a 7061 7261 6d20 5175 616e       :param Quan
+0002fca0: 7469 7479 206c 6f5f 656e 3a20 5468 6520  tity lo_en: The 
+0002fcb0: 6c6f 7765 7220 656e 6572 6779 206c 696d  lower energy lim
+0002fcc0: 6974 206f 6620 7468 6520 6c69 6768 7463  it of the lightc
+0002fcd0: 7572 7665 7320 796f 7520 7769 7368 2074  urves you wish t
+0002fce0: 6f20 7265 7472 6965 7665 2c20 7468 6520  o retrieve, the 
+0002fcf0: 6465 6661 756c 740a 2020 2020 2020 2020  default.        
+0002fd00: 2020 2020 6973 204e 6f6e 6520 2877 6869      is None (whi
+0002fd10: 6368 2077 696c 6c20 7265 7472 6965 7665  ch will retrieve
+0002fd20: 2061 6c6c 206c 6967 6874 6375 7276 6573   all lightcurves
+0002fd30: 2072 6567 6172 646c 6573 7320 6f66 2065   regardless of e
+0002fd40: 6e65 7267 7920 6c69 6d69 7429 2e0a 2020  nergy limit)..  
+0002fd50: 2020 2020 2020 3a70 6172 616d 2051 7561        :param Qua
+0002fd60: 6e74 6974 7920 6869 5f65 6e3a 2054 6865  ntity hi_en: The
+0002fd70: 2075 7070 6572 2065 6e65 7267 7920 6c69   upper energy li
+0002fd80: 6d69 7420 6f66 2074 6865 206c 6967 6874  mit of the light
+0002fd90: 6375 7276 6573 2079 6f75 2077 6973 6820  curves you wish 
+0002fda0: 746f 2072 6574 7269 6576 652c 2074 6865  to retrieve, the
+0002fdb0: 2064 6566 6175 6c74 0a20 2020 2020 2020   default.       
+0002fdc0: 2020 2020 2069 7320 4e6f 6e65 2028 7768       is None (wh
+0002fdd0: 6963 6820 7769 6c6c 2072 6574 7269 6576  ich will retriev
+0002fde0: 6520 616c 6c20 6c69 6768 7463 7572 7665  e all lightcurve
+0002fdf0: 7320 7265 6761 7264 6c65 7373 206f 6620  s regardless of 
+0002fe00: 656e 6572 6779 206c 696d 6974 292e 0a20  energy limit).. 
+0002fe10: 2020 2020 2020 203a 7061 7261 6d20 5175         :param Qu
+0002fe20: 616e 7469 7479 2074 696d 655f 6269 6e5f  antity time_bin_
+0002fe30: 7369 7a65 3a20 5468 6520 7469 6d65 2062  size: The time b
+0002fe40: 696e 2073 697a 6520 7573 6564 2074 6f20  in size used to 
+0002fe50: 6765 6e65 7261 7465 2074 6865 2064 6573  generate the des
+0002fe60: 6972 6564 206c 6967 6874 6375 7276 652e  ired lightcurve.
+0002fe70: 2054 6865 2064 6566 6175 6c74 2076 616c   The default val
+0002fe80: 7565 0a20 2020 2020 2020 2020 2020 2069  ue.            i
+0002fe90: 7320 4e6f 6e65 2c20 696e 2077 6869 6368  s None, in which
+0002fea0: 2063 6173 6520 616c 6c20 6c69 6768 7463   case all lightc
+0002feb0: 7572 7665 7320 6d61 7463 6869 6e67 206f  urves matching o
+0002fec0: 7468 6572 2063 7269 7465 7269 6120 7769  ther criteria wi
+0002fed0: 6c6c 2062 6520 7265 7472 6965 7665 642e  ll be retrieved.
+0002fee0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+0002fef0: 6469 6374 2070 6174 7465 726e 3a20 4576  dict pattern: Ev
+0002ff00: 656e 7420 7365 6c65 6374 696f 6e20 7061  ent selection pa
+0002ff10: 7474 6572 6e73 2075 7365 6420 746f 2063  tterns used to c
+0002ff20: 7265 6174 6520 6c69 6768 7463 7572 7665  reate lightcurve
+0002ff30: 7320 6f66 2069 6e74 6572 6573 742e 2054  s of interest. T
+0002ff40: 6865 2064 6566 6175 6c74 2076 616c 7565  he default value
+0002ff50: 2069 730a 2020 2020 2020 2020 2020 2020   is.            
+0002ff60: 2764 6566 6175 6c74 2720 7768 6963 6820  'default' which 
+0002ff70: 7573 6573 2074 6865 2064 6566 6175 6c74  uses the default
+0002ff80: 2076 616c 7565 7320 666f 7220 6765 6e65   values for gene
+0002ff90: 7261 7469 6e67 206c 6967 6874 6375 7276  rating lightcurv
+0002ffa0: 6573 2066 6f72 2064 6966 6665 7265 6e74  es for different
+0002ffb0: 2069 6e73 7472 756d 656e 7473 2c20 6f72   instruments, or
+0002ffc0: 2079 6f75 0a20 2020 2020 2020 2020 2020   you.           
+0002ffd0: 2063 616e 2070 6173 7320 6120 6469 6374   can pass a dict
+0002ffe0: 696f 6e61 7279 2077 6974 6820 7061 7474  ionary with patt
+0002fff0: 6572 6e73 2069 6e3b 2065 2e67 2e20 7b27  erns in; e.g. {'
+00030000: 706e 273a 2027 3c3d 3427 2c20 276d 6f73  pn': '<=4', 'mos
+00030010: 273a 2027 3c3d 3132 277d 2e20 596f 7520  ': '<=12'}. You 
+00030020: 6361 6e20 616c 736f 2070 6173 7320 4e6f  can also pass No
+00030030: 6e65 2c20 7768 6963 680a 2020 2020 2020  ne, which.      
+00030040: 2020 2020 2020 6d65 616e 7320 616c 6c20        means all 
+00030050: 6c69 6768 7420 6375 7276 6573 206d 6174  light curves mat
+00030060: 6368 696e 6720 6f74 6865 7220 7365 6172  ching other sear
+00030070: 6368 2074 6572 6d73 2077 696c 6c20 6265  ch terms will be
+00030080: 2072 6574 7572 6e65 642e 0a20 2020 2020   returned..     
+00030090: 2020 203a 7265 7475 726e 3a20 416e 2058     :return: An X
+000300a0: 4741 204c 6967 6874 4375 7276 6520 6f62  GA LightCurve ob
+000300b0: 6a65 6374 2028 6966 2074 6865 7265 2069  ject (if there i
+000300c0: 7320 616e 2065 7861 6374 206d 6174 6368  s an exact match
+000300d0: 292c 206f 7220 6120 6c69 7374 206f 6620  ), or a list of 
+000300e0: 5847 4120 4c69 6768 7443 7572 7665 206f  XGA LightCurve o
+000300f0: 626a 6563 7473 2028 6966 2074 6865 7265  bjects (if there
+00030100: 0a20 2020 2020 2020 2020 2020 2077 6572  .            wer
+00030110: 6520 6d75 6c74 6970 6c65 206d 6174 6368  e multiple match
+00030120: 696e 6720 7072 6f64 7563 7473 292e 0a20  ing products).. 
+00030130: 2020 2020 2020 203a 7274 7970 653a 2055         :rtype: U
+00030140: 6e69 6f6e 5b4c 6967 6874 4375 7276 652c  nion[LightCurve,
+00030150: 204c 6973 745b 4c69 6768 7443 7572 7665   List[LightCurve
+00030160: 5d5d 0a20 2020 2020 2020 2022 2222 0a20  ]].        """. 
+00030170: 2020 2020 2020 2066 726f 6d20 7867 612e         from xga.
+00030180: 7361 7320 696d 706f 7274 2063 6865 636b  sas import check
+00030190: 5f70 6174 7465 726e 0a0a 2020 2020 2020  _pattern..      
+000301a0: 2020 2320 544f 444f 2054 6869 7320 6973    # TODO This is
+000301b0: 2058 4d4d 2073 7065 6369 6669 6320 6265   XMM specific be
+000301c0: 6361 7573 6520 6f66 2074 6865 2070 6174  cause of the pat
+000301d0: 7465 726e 7320 6375 7272 656e 746c 790a  terns currently.
+000301e0: 2020 2020 2020 2020 2320 5468 6973 2069          # This i
+000301f0: 7320 7768 6572 6520 7765 2073 6574 2075  s where we set u
+00030200: 7020 7468 6520 7365 6172 6368 2073 7472  p the search str
+00030210: 696e 6720 666f 7220 7468 6520 7061 7474  ing for the patt
+00030220: 6572 6e73 2073 7065 6369 6669 6564 2062  erns specified b
+00030230: 7920 7468 6520 7573 6572 2e0a 2020 2020  y the user..    
+00030240: 2020 2020 6966 2070 6174 7465 726e 2069      if pattern i
+00030250: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+00030260: 2020 2020 7061 7474 5f73 6561 7263 6820      patt_search 
+00030270: 3d20 225f 7061 7474 6572 6e22 0a20 2020  = "_pattern".   
+00030280: 2020 2020 2065 6c69 6620 6973 696e 7374       elif isinst
+00030290: 616e 6365 2870 6174 7465 726e 2c20 7374  ance(pattern, st
+000302a0: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+000302b0: 7061 7474 6572 6e20 3d20 7b27 706e 273a  pattern = {'pn':
+000302c0: 2027 3c3d 3427 2c20 276d 6f73 273a 2027   '<=4', 'mos': '
+000302d0: 3c3d 3132 277d 0a20 2020 2020 2020 2020  <=12'}.         
+000302e0: 2020 2070 6174 745f 7365 6172 6368 203d     patt_search =
+000302f0: 207b 696e 7374 3a20 225f 7061 7474 6572   {inst: "_patter
+00030300: 6e22 202b 2063 6865 636b 5f70 6174 7465  n" + check_patte
+00030310: 726e 2870 6174 7429 5b31 5d20 666f 7220  rn(patt)[1] for 
+00030320: 696e 7374 2c20 7061 7474 2069 6e20 7061  inst, patt in pa
+00030330: 7474 6572 6e2e 6974 656d 7328 297d 0a20  ttern.items()}. 
+00030340: 2020 2020 2020 2065 6c69 6620 6973 696e         elif isin
+00030350: 7374 616e 6365 2870 6174 7465 726e 2c20  stance(pattern, 
+00030360: 6469 6374 293a 0a20 2020 2020 2020 2020  dict):.         
+00030370: 2020 2069 6620 276d 6f73 3127 2069 6e20     if 'mos1' in 
+00030380: 6c69 7374 2870 6174 7465 726e 2e6b 6579  list(pattern.key
+00030390: 7328 2929 206f 7220 276d 6f73 3227 2069  s()) or 'mos2' i
+000303a0: 6e20 6c69 7374 2870 6174 7465 726e 2e6b  n list(pattern.k
+000303b0: 6579 7328 2929 3a0a 2020 2020 2020 2020  eys()):.        
+000303c0: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
+000303d0: 6c75 6545 7272 6f72 2822 5370 6563 6966  lueError("Specif
+000303e0: 6963 204d 4f53 2069 6e73 7472 756d 656e  ic MOS instrumen
+000303f0: 7473 2064 6f20 6e6f 7420 6e65 6564 2074  ts do not need t
+00030400: 6f20 6265 2073 7065 6369 6669 6564 2066  o be specified f
+00030410: 6f72 2027 7061 7474 6572 6e27 3b20 692e  or 'pattern'; i.
+00030420: 652e 2074 6865 7265 2022 0a20 2020 2020  e. there ".     
+00030430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030440: 2020 2020 2020 2020 2020 2020 2273 686f              "sho
+00030450: 756c 6420 6265 206f 6e65 2065 6e74 7279  uld be one entry
+00030460: 2066 6f72 2027 6d6f 7327 2e22 290a 2020   for 'mos'.").  
+00030470: 2020 2020 2020 2020 2020 7061 7474 6572            patter
+00030480: 6e20 3d20 7b69 6e73 743a 2070 6174 742e  n = {inst: patt.
+00030490: 7265 706c 6163 6528 2720 272c 2027 2729  replace(' ', '')
+000304a0: 2066 6f72 2069 6e73 742c 2070 6174 7420   for inst, patt 
+000304b0: 696e 2070 6174 7465 726e 2e69 7465 6d73  in pattern.items
+000304c0: 2829 7d0a 2020 2020 2020 2020 2020 2020  ()}.            
+000304d0: 7061 7474 5f73 6561 7263 6820 3d20 7b69  patt_search = {i
+000304e0: 6e73 743a 2022 5f70 6174 7465 726e 2220  nst: "_pattern" 
+000304f0: 2b20 6368 6563 6b5f 7061 7474 6572 6e28  + check_pattern(
+00030500: 7061 7474 295b 315d 2066 6f72 2069 6e73  patt)[1] for ins
+00030510: 742c 2070 6174 7420 696e 2070 6174 7465  t, patt in patte
+00030520: 726e 2e69 7465 6d73 2829 7d0a 2020 2020  rn.items()}.    
+00030530: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00030540: 2020 2020 2020 7261 6973 6520 5479 7065        raise Type
+00030550: 4572 726f 7228 2254 6865 2027 7061 7474  Error("The 'patt
+00030560: 6572 6e27 2061 7267 756d 656e 7420 6d75  ern' argument mu
+00030570: 7374 2062 6520 6569 7468 6572 2027 6465  st be either 'de
+00030580: 6661 756c 7427 2c20 6f72 2061 2064 6963  fault', or a dic
+00030590: 7469 6f6e 6172 7920 7768 6572 6520 7468  tionary where th
+000305a0: 6520 6b65 7973 2061 7265 2022 0a20 2020  e keys are ".   
+000305b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000305c0: 2020 2020 2020 2020 2022 696e 7374 7275           "instru
+000305d0: 6d65 6e74 206e 616d 6573 2061 6e64 2076  ment names and v
+000305e0: 616c 7565 7320 6172 6520 7374 7269 6e67  alues are string
+000305f0: 2070 6174 7465 726e 732e 2229 0a0a 2020   patterns.")..  
+00030600: 2020 2020 2020 2320 4a75 7374 206d 616b        # Just mak
+00030610: 6573 2074 6865 2073 6561 7263 6820 6561  es the search ea
+00030620: 7369 6572 2064 6f77 6e20 7468 6520 6c69  sier down the li
+00030630: 6e65 0a20 2020 2020 2020 2069 6620 276d  ne.        if 'm
+00030640: 6f73 2720 696e 2070 6174 745f 7365 6172  os' in patt_sear
+00030650: 6368 3a0a 2020 2020 2020 2020 2020 2020  ch:.            
+00030660: 7061 7474 5f73 6561 7263 682e 7570 6461  patt_search.upda
+00030670: 7465 287b 276d 6f73 3127 3a20 7061 7474  te({'mos1': patt
+00030680: 5f73 6561 7263 685b 276d 6f73 275d 2c20  _search['mos'], 
+00030690: 276d 6f73 3227 3a20 7061 7474 5f73 6561  'mos2': patt_sea
+000306a0: 7263 685b 276d 6f73 275d 7d29 0a0a 2020  rch['mos']})..  
+000306b0: 2020 2020 2020 736f 6d65 5f6c 6373 203d        some_lcs =
+000306c0: 2073 656c 662e 5f67 6574 5f6c 635f 7072   self._get_lc_pr
+000306d0: 6f64 286f 7574 6572 5f72 6164 6975 732c  od(outer_radius,
+000306e0: 206f 6273 5f69 642c 2069 6e73 742c 2069   obs_id, inst, i
+000306f0: 6e6e 6572 5f72 6164 6975 732c 206c 6f5f  nner_radius, lo_
+00030700: 656e 2c20 6869 5f65 6e2c 2074 696d 655f  en, hi_en, time_
+00030710: 6269 6e5f 7369 7a65 290a 2020 2020 2020  bin_size).      
+00030720: 2020 6d61 7463 6865 645f 7072 6f64 7320    matched_prods 
+00030730: 3d20 5b5d 0a20 2020 2020 2020 2066 6f72  = [].        for
+00030740: 206c 6320 696e 2073 6f6d 655f 6c63 733a   lc in some_lcs:
+00030750: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00030760: 6973 696e 7374 616e 6365 2870 6174 745f  isinstance(patt_
+00030770: 7365 6172 6368 2c20 7374 7229 3a0a 2020  search, str):.  
+00030780: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00030790: 6c5f 7061 7474 5f73 6561 7263 6820 3d20  l_patt_search = 
+000307a0: 7061 7474 5f73 6561 7263 680a 2020 2020  patt_search.    
+000307b0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+000307c0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+000307d0: 6c5f 7061 7474 5f73 6561 7263 6820 3d20  l_patt_search = 
+000307e0: 7061 7474 5f73 6561 7263 685b 6c63 2e69  patt_search[lc.i
+000307f0: 6e73 7472 756d 656e 745d 0a0a 2020 2020  nstrument]..    
+00030800: 2020 2020 2020 2020 6966 2072 656c 5f70          if rel_p
+00030810: 6174 745f 7365 6172 6368 2069 6e20 6c63  att_search in lc
+00030820: 2e73 746f 7261 6765 5f6b 6579 3a0a 2020  .storage_key:.  
+00030830: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
+00030840: 7463 6865 645f 7072 6f64 732e 6170 7065  tched_prods.appe
+00030850: 6e64 286c 6329 0a0a 2020 2020 2020 2020  nd(lc)..        
+00030860: 6966 206c 656e 286d 6174 6368 6564 5f70  if len(matched_p
+00030870: 726f 6473 2920 3d3d 2031 3a0a 2020 2020  rods) == 1:.    
+00030880: 2020 2020 2020 2020 6d61 7463 6865 645f          matched_
+00030890: 7072 6f64 7320 3d20 6d61 7463 6865 645f  prods = matched_
+000308a0: 7072 6f64 735b 305d 0a20 2020 2020 2020  prods[0].       
+000308b0: 2065 6c69 6620 6c65 6e28 6d61 7463 6865   elif len(matche
+000308c0: 645f 7072 6f64 7329 203d 3d20 303a 0a20  d_prods) == 0:. 
+000308d0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+000308e0: 204e 6f50 726f 6475 6374 4176 6169 6c61   NoProductAvaila
+000308f0: 626c 6545 7272 6f72 2822 4361 6e6e 6f74  bleError("Cannot
+00030900: 2066 696e 6420 616e 7920 6c69 6768 7463   find any lightc
+00030910: 7572 7665 7320 6d61 7463 6869 6e67 2079  urves matching y
+00030920: 6f75 7220 696e 7075 742e 2229 0a0a 2020  our input.")..  
+00030930: 2020 2020 2020 7265 7475 726e 206d 6174        return mat
+00030940: 6368 6564 5f70 726f 6473 0a0a 2020 2020  ched_prods..    
+00030950: 6465 6620 6765 745f 636f 6d62 696e 6564  def get_combined
+00030960: 5f6c 6967 6874 6375 7276 6573 2873 656c  _lightcurves(sel
+00030970: 662c 206f 7574 6572 5f72 6164 6975 733a  f, outer_radius:
+00030980: 2055 6e69 6f6e 5b73 7472 2c20 5175 616e   Union[str, Quan
+00030990: 7469 7479 5d20 3d20 4e6f 6e65 2c0a 2020  tity] = None,.  
+000309a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000309b0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000309c0: 6e6e 6572 5f72 6164 6975 733a 2055 6e69  nner_radius: Uni
+000309d0: 6f6e 5b73 7472 2c20 5175 616e 7469 7479  on[str, Quantity
+000309e0: 5d20 3d20 4e6f 6e65 2c20 6c6f 5f65 6e3a  ] = None, lo_en:
+000309f0: 2051 7561 6e74 6974 7920 3d20 4e6f 6e65   Quantity = None
+00030a00: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00030a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030a20: 2020 2068 695f 656e 3a20 5175 616e 7469     hi_en: Quanti
+00030a30: 7479 203d 204e 6f6e 652c 2074 696d 655f  ty = None, time_
+00030a40: 6269 6e5f 7369 7a65 3a20 5175 616e 7469  bin_size: Quanti
+00030a50: 7479 203d 204e 6f6e 652c 0a20 2020 2020  ty = None,.     
+00030a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030a70: 2020 2020 2020 2020 2020 2020 7061 7474              patt
+00030a80: 6572 6e3a 2055 6e69 6f6e 5b64 6963 742c  ern: Union[dict,
+00030a90: 2073 7472 5d20 3d20 2264 6566 6175 6c74   str] = "default
+00030aa0: 2229 205c 0a20 2020 2020 2020 2020 2020  ") \.           
+00030ab0: 202d 3e20 556e 696f 6e5b 4167 6772 6567   -> Union[Aggreg
+00030ac0: 6174 654c 6967 6874 4375 7276 652c 204c  ateLightCurve, L
+00030ad0: 6973 745b 4167 6772 6567 6174 654c 6967  ist[AggregateLig
+00030ae0: 6874 4375 7276 655d 5d3a 0a20 2020 2020  htCurve]]:.     
+00030af0: 2020 2022 2222 0a20 2020 2020 2020 2041     """.        A
+00030b00: 206d 6574 686f 6420 746f 2072 6574 7269   method to retri
+00030b10: 6576 6520 5847 4120 4167 6772 6567 6174  eve XGA Aggregat
+00030b20: 654c 6967 6874 4375 7276 6520 6f62 6a65  eLightCurve obje
+00030b30: 6374 7320 2869 2e65 2e20 6c69 6768 7463  cts (i.e. lightc
+00030b40: 7572 7665 7320 666f 7220 7468 6973 206f  urves for this o
+00030b50: 626a 6563 7420 7468 6174 2077 6572 6520  bject that were 
+00030b60: 6765 6e65 7261 7465 6420 6174 0a20 2020  generated at.   
+00030b70: 2020 2020 2074 6865 2073 616d 6520 7469       the same ti
+00030b80: 6d65 2061 6e64 2068 6176 6520 6265 656e  me and have been
+00030b90: 2070 6163 6b61 6765 6420 746f 6765 7468   packaged togeth
+00030ba0: 6572 292e 0a0a 2020 2020 2020 2020 3a70  er)...        :p
+00030bb0: 6172 616d 2073 7472 2f51 7561 6e74 6974  aram str/Quantit
+00030bc0: 7920 6f75 7465 725f 7261 6469 7573 3a20  y outer_radius: 
+00030bd0: 5468 6520 6e61 6d65 206f 7220 7661 6c75  The name or valu
+00030be0: 6520 6f66 2074 6865 206f 7574 6572 2072  e of the outer r
+00030bf0: 6164 6975 7320 7468 6174 2077 6173 2075  adius that was u
+00030c00: 7365 6420 666f 7220 7468 6520 6765 6e65  sed for the gene
+00030c10: 7261 7469 6f6e 206f 660a 2020 2020 2020  ration of.      
+00030c20: 2020 2020 2020 7468 6520 6167 6772 6567        the aggreg
+00030c30: 6174 6520 6c69 6768 7463 7572 7665 2028  ate lightcurve (
+00030c40: 666f 7220 696e 7374 616e 6365 2027 706f  for instance 'po
+00030c50: 696e 7427 2077 6f75 6c64 2062 6520 6163  int' would be ac
+00030c60: 6365 7074 6162 6c65 2066 6f72 2061 2050  ceptable for a P
+00030c70: 6f69 6e74 536f 7572 6365 2c20 6f72 0a20  ointSource, or. 
+00030c80: 2020 2020 2020 2020 2020 2051 7561 6e74             Quant
+00030c90: 6974 7928 3130 302c 2027 6b70 6327 2929  ity(100, 'kpc'))
+00030ca0: 2e20 4465 6661 756c 7420 6973 204e 6f6e  . Default is Non
+00030cb0: 652c 206d 6561 6e69 6e67 2061 6c6c 2061  e, meaning all a
+00030cc0: 6767 7265 6761 7465 206c 6967 6874 6375  ggregate lightcu
+00030cd0: 7276 6573 2077 696c 6c20 6265 2072 6574  rves will be ret
+00030ce0: 7269 6576 6564 2e0a 2020 2020 2020 2020  rieved..        
+00030cf0: 3a70 6172 616d 2073 7472 2f51 7561 6e74  :param str/Quant
+00030d00: 6974 7920 696e 6e65 725f 7261 6469 7573  ity inner_radius
+00030d10: 3a20 5468 6520 6e61 6d65 206f 7220 7661  : The name or va
+00030d20: 6c75 6520 6f66 2074 6865 2069 6e6e 6572  lue of the inner
+00030d30: 2072 6164 6975 7320 7468 6174 2077 6173   radius that was
+00030d40: 2075 7365 6420 666f 7220 7468 6520 6765   used for the ge
+00030d50: 6e65 7261 7469 6f6e 206f 660a 2020 2020  neration of.    
+00030d60: 2020 2020 2020 2020 7468 6520 6167 6772          the aggr
+00030d70: 6567 6174 6520 6c69 6768 7463 7572 7665  egate lightcurve
+00030d80: 2028 666f 7220 696e 7374 616e 6365 2027   (for instance '
+00030d90: 706f 696e 7427 2077 6f75 6c64 2062 6520  point' would be 
+00030da0: 6163 6365 7074 6162 6c65 2066 6f72 2061  acceptable for a
+00030db0: 2050 6f69 6e74 536f 7572 6365 2c20 6f72   PointSource, or
+00030dc0: 0a20 2020 2020 2020 2020 2020 2051 7561  .            Qua
+00030dd0: 6e74 6974 7928 302c 2027 6b70 6327 2929  ntity(0, 'kpc'))
+00030de0: 2e20 4465 6661 756c 7420 6973 204e 6f6e  . Default is Non
+00030df0: 652c 206d 6561 6e69 6e67 2061 6c6c 2061  e, meaning all a
+00030e00: 6767 7265 6761 7465 206c 6967 6874 6375  ggregate lightcu
+00030e10: 7276 6573 2077 696c 6c20 6265 2072 6574  rves will be ret
+00030e20: 7269 6576 6564 2e0a 2020 2020 2020 2020  rieved..        
+00030e30: 3a70 6172 616d 2051 7561 6e74 6974 7920  :param Quantity 
+00030e40: 6c6f 5f65 6e3a 2054 6865 206c 6f77 6572  lo_en: The lower
+00030e50: 2065 6e65 7267 7920 6c69 6d69 7420 6f66   energy limit of
+00030e60: 2074 6865 2061 6767 7265 6761 7465 206c   the aggregate l
+00030e70: 6967 6874 6375 7276 6573 2079 6f75 2077  ightcurves you w
+00030e80: 6973 6820 746f 2072 6574 7269 6576 652c  ish to retrieve,
+00030e90: 2074 6865 2064 6566 6175 6c74 0a20 2020   the default.   
+00030ea0: 2020 2020 2020 2020 2069 7320 4e6f 6e65           is None
+00030eb0: 2028 7768 6963 6820 7769 6c6c 2072 6574   (which will ret
+00030ec0: 7269 6576 6520 616c 6c20 6167 6772 6567  rieve all aggreg
+00030ed0: 6174 6520 6c69 6768 7463 7572 7665 7320  ate lightcurves 
+00030ee0: 7265 6761 7264 6c65 7373 206f 6620 656e  regardless of en
+00030ef0: 6572 6779 206c 696d 6974 292e 0a20 2020  ergy limit)..   
+00030f00: 2020 2020 203a 7061 7261 6d20 5175 616e       :param Quan
+00030f10: 7469 7479 2068 695f 656e 3a20 5468 6520  tity hi_en: The 
+00030f20: 7570 7065 7220 656e 6572 6779 206c 696d  upper energy lim
+00030f30: 6974 206f 6620 7468 6520 6167 6772 6567  it of the aggreg
+00030f40: 6174 6520 6c69 6768 7463 7572 7665 7320  ate lightcurves 
+00030f50: 796f 7520 7769 7368 2074 6f20 7265 7472  you wish to retr
+00030f60: 6965 7665 2c20 7468 6520 6465 6661 756c  ieve, the defaul
+00030f70: 740a 2020 2020 2020 2020 2020 2020 6973  t.            is
+00030f80: 204e 6f6e 6520 2877 6869 6368 2077 696c   None (which wil
+00030f90: 6c20 7265 7472 6965 7665 2061 6c6c 2061  l retrieve all a
+00030fa0: 6767 7265 6761 7465 206c 6967 6874 6375  ggregate lightcu
+00030fb0: 7276 6573 2072 6567 6172 646c 6573 7320  rves regardless 
+00030fc0: 6f66 2065 6e65 7267 7920 6c69 6d69 7429  of energy limit)
+00030fd0: 2e0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
+00030fe0: 2051 7561 6e74 6974 7920 7469 6d65 5f62   Quantity time_b
+00030ff0: 696e 5f73 697a 653a 2054 6865 2074 696d  in_size: The tim
+00031000: 6520 6269 6e20 7369 7a65 2075 7365 6420  e bin size used 
+00031010: 746f 2067 656e 6572 6174 6520 7468 6520  to generate the 
+00031020: 6465 7369 7265 6420 6167 6772 6567 6174  desired aggregat
+00031030: 6520 6c69 6768 7463 7572 7665 2e20 5468  e lightcurve. Th
+00031040: 650a 2020 2020 2020 2020 2020 2020 6465  e.            de
+00031050: 6661 756c 7420 7661 6c75 6520 6973 204e  fault value is N
+00031060: 6f6e 652c 2069 6e20 7768 6963 6820 6361  one, in which ca
+00031070: 7365 2061 6c6c 2061 6767 7265 6761 7465  se all aggregate
+00031080: 206c 6967 6874 6375 7276 6573 206d 6174   lightcurves mat
+00031090: 6368 696e 6720 6f74 6865 7220 6372 6974  ching other crit
+000310a0: 6572 6961 2077 696c 6c20 6265 2072 6574  eria will be ret
+000310b0: 7269 6576 6564 2e0a 2020 2020 2020 2020  rieved..        
+000310c0: 3a70 6172 616d 2064 6963 7420 7061 7474  :param dict patt
+000310d0: 6572 6e3a 2045 7665 6e74 2073 656c 6563  ern: Event selec
+000310e0: 7469 6f6e 2070 6174 7465 726e 7320 7573  tion patterns us
+000310f0: 6564 2074 6f20 6372 6561 7465 2061 6767  ed to create agg
+00031100: 7265 6761 7465 206c 6967 6874 6375 7276  regate lightcurv
+00031110: 6573 206f 6620 696e 7465 7265 7374 2e20  es of interest. 
+00031120: 5468 6520 6465 6661 756c 740a 2020 2020  The default.    
+00031130: 2020 2020 2020 2020 6973 2027 6465 6661          is 'defa
+00031140: 756c 7427 2077 6869 6368 2075 7365 7320  ult' which uses 
+00031150: 7468 6520 6465 6661 756c 7420 7661 6c75  the default valu
+00031160: 6573 2066 6f72 2067 656e 6572 6174 696e  es for generatin
+00031170: 6720 6c69 6768 7463 7572 7665 7320 666f  g lightcurves fo
+00031180: 7220 6469 6666 6572 656e 7420 696e 7374  r different inst
+00031190: 7275 6d65 6e74 732c 206f 7220 796f 750a  ruments, or you.
+000311a0: 2020 2020 2020 2020 2020 2020 6361 6e20              can 
+000311b0: 7061 7373 2061 2064 6963 7469 6f6e 6172  pass a dictionar
+000311c0: 7920 7769 7468 2070 6174 7465 726e 7320  y with patterns 
+000311d0: 696e 3b20 652e 672e 207b 2770 6e27 3a20  in; e.g. {'pn': 
+000311e0: 273c 3d34 272c 2027 6d6f 7327 3a20 273c  '<=4', 'mos': '<
+000311f0: 3d31 3227 7d2e 2059 6f75 2063 616e 2061  =12'}. You can a
+00031200: 6c73 6f20 7061 7373 204e 6f6e 652c 2077  lso pass None, w
+00031210: 6869 6368 0a20 2020 2020 2020 2020 2020  hich.           
+00031220: 206d 6561 6e73 2061 6c6c 2061 6767 7265   means all aggre
+00031230: 6761 7465 2020 6c69 6768 7420 6375 7276  gate  light curv
+00031240: 6573 206d 6174 6368 696e 6720 6f74 6865  es matching othe
+00031250: 7220 7365 6172 6368 2074 6572 6d73 2077  r search terms w
+00031260: 696c 6c20 6265 2072 6574 7572 6e65 642e  ill be returned.
+00031270: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
+00031280: 3a20 416e 2058 4741 2041 6767 7265 6761  : An XGA Aggrega
+00031290: 7465 4c69 6768 7443 7572 7665 206f 626a  teLightCurve obj
+000312a0: 6563 7420 2869 6620 7468 6572 6520 6973  ect (if there is
+000312b0: 2061 6e20 6578 6163 7420 6d61 7463 6829   an exact match)
+000312c0: 2c20 6f72 2061 206c 6973 7420 6f66 2058  , or a list of X
+000312d0: 4741 2041 6767 7265 6761 7465 4c69 6768  GA AggregateLigh
+000312e0: 7443 7572 7665 0a20 2020 2020 2020 2020  tCurve.         
+000312f0: 2020 206f 626a 6563 7473 2028 6966 2074     objects (if t
+00031300: 6865 7265 2077 6572 6520 6d75 6c74 6970  here were multip
+00031310: 6c65 206d 6174 6368 696e 6720 7072 6f64  le matching prod
+00031320: 7563 7473 292e 0a20 2020 2020 2020 203a  ucts)..        :
+00031330: 7274 7970 653a 2055 6e69 6f6e 5b41 6767  rtype: Union[Agg
+00031340: 7265 6761 7465 4c69 6768 7443 7572 7665  regateLightCurve
+00031350: 2c20 4c69 7374 5b41 6767 7265 6761 7465  , List[Aggregate
+00031360: 4c69 6768 7443 7572 7665 5d5d 0a20 2020  LightCurve]].   
+00031370: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00031380: 2066 726f 6d20 7867 612e 7361 7320 696d   from xga.sas im
+00031390: 706f 7274 2063 6865 636b 5f70 6174 7465  port check_patte
+000313a0: 726e 0a0a 2020 2020 2020 2020 2320 544f  rn..        # TO
+000313b0: 444f 2054 6869 7320 6973 2058 4d4d 2073  DO This is XMM s
+000313c0: 7065 6369 6669 6320 6265 6361 7573 6520  pecific because 
+000313d0: 6f66 2074 6865 2070 6174 7465 726e 7320  of the patterns 
+000313e0: 6375 7272 656e 746c 790a 2020 2020 2020  currently.      
+000313f0: 2020 2320 5468 6973 2069 7320 7768 6572    # This is wher
+00031400: 6520 7765 2073 6574 2075 7020 7468 6520  e we set up the 
+00031410: 7365 6172 6368 2073 7472 696e 6720 666f  search string fo
+00031420: 7220 7468 6520 7061 7474 6572 6e73 2073  r the patterns s
+00031430: 7065 6369 6669 6564 2062 7920 7468 6520  pecified by the 
+00031440: 7573 6572 2e0a 2020 2020 2020 2020 6966  user..        if
+00031450: 2070 6174 7465 726e 2069 7320 4e6f 6e65   pattern is None
+00031460: 3a0a 2020 2020 2020 2020 2020 2020 7061  :.            pa
+00031470: 7474 5f73 6561 7263 6820 3d20 2270 6174  tt_search = "pat
+00031480: 7465 726e 220a 2020 2020 2020 2020 656c  tern".        el
+00031490: 6966 2069 7369 6e73 7461 6e63 6528 7061  if isinstance(pa
+000314a0: 7474 6572 6e2c 2073 7472 293a 0a20 2020  ttern, str):.   
+000314b0: 2020 2020 2020 2020 2070 6174 7465 726e           pattern
+000314c0: 203d 207b 2770 6e27 3a20 273c 3d34 272c   = {'pn': '<=4',
+000314d0: 2027 6d6f 7327 3a20 273c 3d31 3227 7d0a   'mos': '<=12'}.
+000314e0: 2020 2020 2020 2020 2020 2020 7061 7474              patt
+000314f0: 5f73 6561 7263 6820 3d20 7b69 6e73 743a  _search = {inst:
+00031500: 2022 5f7b 697d 7061 7474 6572 6e22 2e66   "_{i}pattern".f
+00031510: 6f72 6d61 7428 693d 696e 7374 2920 2b20  ormat(i=inst) + 
+00031520: 6368 6563 6b5f 7061 7474 6572 6e28 7061  check_pattern(pa
+00031530: 7474 295b 315d 0a20 2020 2020 2020 2020  tt)[1].         
+00031540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031550: 2020 666f 7220 696e 7374 2c20 7061 7474    for inst, patt
+00031560: 2069 6e20 7061 7474 6572 6e2e 6974 656d   in pattern.item
+00031570: 7328 297d 0a20 2020 2020 2020 2065 6c69  s()}.        eli
+00031580: 6620 6973 696e 7374 616e 6365 2870 6174  f isinstance(pat
+00031590: 7465 726e 2c20 6469 6374 293a 0a20 2020  tern, dict):.   
+000315a0: 2020 2020 2020 2020 2069 6620 276d 6f73           if 'mos
+000315b0: 3127 2069 6e20 6c69 7374 2870 6174 7465  1' in list(patte
+000315c0: 726e 2e6b 6579 7328 2929 206f 7220 276d  rn.keys()) or 'm
+000315d0: 6f73 3227 2069 6e20 6c69 7374 2870 6174  os2' in list(pat
+000315e0: 7465 726e 2e6b 6579 7328 2929 3a0a 2020  tern.keys()):.  
+000315f0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+00031600: 6973 6520 5661 6c75 6545 7272 6f72 2822  ise ValueError("
+00031610: 5370 6563 6966 6963 204d 4f53 2069 6e73  Specific MOS ins
+00031620: 7472 756d 656e 7473 2064 6f20 6e6f 7420  truments do not 
+00031630: 6e65 6564 2074 6f20 6265 2073 7065 6369  need to be speci
+00031640: 6669 6564 2066 6f72 2027 7061 7474 6572  fied for 'patter
+00031650: 6e27 3b20 692e 652e 2074 6865 7265 2022  n'; i.e. there "
+00031660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00031670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031680: 2020 2273 686f 756c 6420 6265 206f 6e65    "should be one
+00031690: 2065 6e74 7279 2066 6f72 2027 6d6f 7327   entry for 'mos'
+000316a0: 2e22 290a 2020 2020 2020 2020 2020 2020  .").            
+000316b0: 7061 7474 6572 6e20 3d20 7b69 6e73 743a  pattern = {inst:
+000316c0: 2070 6174 742e 7265 706c 6163 6528 2720   patt.replace(' 
+000316d0: 272c 2027 2729 2066 6f72 2069 6e73 742c  ', '') for inst,
+000316e0: 2070 6174 7420 696e 2070 6174 7465 726e   patt in pattern
+000316f0: 2e69 7465 6d73 2829 7d0a 2020 2020 2020  .items()}.      
+00031700: 2020 2020 2020 7061 7474 5f73 6561 7263        patt_searc
+00031710: 6820 3d20 7b69 6e73 743a 2022 5f7b 697d  h = {inst: "_{i}
+00031720: 7061 7474 6572 6e22 2e66 6f72 6d61 7428  pattern".format(
+00031730: 693d 696e 7374 2920 2b20 6368 6563 6b5f  i=inst) + check_
+00031740: 7061 7474 6572 6e28 7061 7474 295b 315d  pattern(patt)[1]
+00031750: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00031760: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00031770: 696e 7374 2c20 7061 7474 2069 6e20 7061  inst, patt in pa
+00031780: 7474 6572 6e2e 6974 656d 7328 297d 0a20  ttern.items()}. 
+00031790: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+000317a0: 2020 2020 2020 2020 2072 6169 7365 2054           raise T
+000317b0: 7970 6545 7272 6f72 2822 5468 6520 2770  ypeError("The 'p
+000317c0: 6174 7465 726e 2720 6172 6775 6d65 6e74  attern' argument
+000317d0: 206d 7573 7420 6265 2065 6974 6865 7220   must be either 
+000317e0: 2764 6566 6175 6c74 272c 206f 7220 6120  'default', or a 
+000317f0: 6469 6374 696f 6e61 7279 2077 6865 7265  dictionary where
+00031800: 2074 6865 206b 6579 7320 6172 6520 220a   the keys are ".
+00031810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031820: 2020 2020 2020 2020 2020 2020 2269 6e73              "ins
+00031830: 7472 756d 656e 7420 6e61 6d65 7320 616e  trument names an
+00031840: 6420 7661 6c75 6573 2061 7265 2073 7472  d values are str
+00031850: 696e 6720 7061 7474 6572 6e73 2e22 290a  ing patterns.").
+00031860: 0a20 2020 2020 2020 2023 2055 7365 2074  .        # Use t
+00031870: 6865 2069 6e74 6572 6e61 6c20 6675 6e63  he internal func
+00031880: 7469 6f6e 2074 6f20 6669 6e64 2074 6865  tion to find the
+00031890: 2063 6f6d 6269 6e65 6420 6c69 6768 7420   combined light 
+000318a0: 6375 7276 6573 2c20 7468 656e 2061 7070  curves, then app
+000318b0: 6c79 2070 6174 7465 726e 2063 6865 636b  ly pattern check
+000318c0: 7320 6166 7465 720a 2020 2020 2020 2020  s after.        
+000318d0: 736f 6d65 5f6c 6373 203d 2073 656c 662e  some_lcs = self.
+000318e0: 5f67 6574 5f6c 635f 7072 6f64 286f 7574  _get_lc_prod(out
+000318f0: 6572 5f72 6164 6975 732c 2027 636f 6d62  er_radius, 'comb
+00031900: 696e 6564 272c 204e 6f6e 652c 2069 6e6e  ined', None, inn
+00031910: 6572 5f72 6164 6975 732c 206c 6f5f 656e  er_radius, lo_en
+00031920: 2c20 6869 5f65 6e2c 2074 696d 655f 6269  , hi_en, time_bi
+00031930: 6e5f 7369 7a65 290a 2020 2020 2020 2020  n_size).        
+00031940: 6d61 7463 6865 645f 7072 6f64 7320 3d20  matched_prods = 
+00031950: 5b5d 0a20 2020 2020 2020 2066 6f72 206c  [].        for l
+00031960: 6320 696e 2073 6f6d 655f 6c63 733a 0a20  c in some_lcs:. 
+00031970: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+00031980: 696e 7374 616e 6365 2870 6174 745f 7365  instance(patt_se
+00031990: 6172 6368 2c20 7374 7229 3a0a 2020 2020  arch, str):.    
+000319a0: 2020 2020 2020 2020 2020 2020 7265 6c5f              rel_
+000319b0: 7061 7474 5f73 6561 7263 6820 3d20 5b70  patt_search = [p
+000319c0: 6174 745f 7365 6172 6368 5d0a 2020 2020  att_search].    
+000319d0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+000319e0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+000319f0: 6c5f 7061 7474 5f73 6561 7263 6820 3d20  l_patt_search = 
+00031a00: 5b70 6174 7420 666f 7220 696e 7374 2c20  [patt for inst, 
+00031a10: 7061 7474 2069 6e20 7061 7474 5f73 6561  patt in patt_sea
+00031a20: 7263 682e 6974 656d 7328 295d 0a0a 2020  rch.items()]..  
+00031a30: 2020 2020 2020 2020 2020 6966 2061 6c6c            if all
+00031a40: 285b 7270 7320 696e 206c 632e 7374 6f72  ([rps in lc.stor
+00031a50: 6167 655f 6b65 7920 666f 7220 7270 7320  age_key for rps 
+00031a60: 696e 2072 656c 5f70 6174 745f 7365 6172  in rel_patt_sear
+00031a70: 6368 5d29 3a0a 2020 2020 2020 2020 2020  ch]):.          
+00031a80: 2020 2020 2020 6d61 7463 6865 645f 7072        matched_pr
+00031a90: 6f64 732e 6170 7065 6e64 286c 6329 0a0a  ods.append(lc)..
+00031aa0: 2020 2020 2020 2020 6966 206c 656e 286d          if len(m
+00031ab0: 6174 6368 6564 5f70 726f 6473 2920 3d3d  atched_prods) ==
+00031ac0: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
+00031ad0: 6d61 7463 6865 645f 7072 6f64 7320 3d20  matched_prods = 
+00031ae0: 6d61 7463 6865 645f 7072 6f64 735b 305d  matched_prods[0]
+00031af0: 0a20 2020 2020 2020 2065 6c69 6620 6c65  .        elif le
+00031b00: 6e28 6d61 7463 6865 645f 7072 6f64 7329  n(matched_prods)
+00031b10: 203d 3d20 303a 0a20 2020 2020 2020 2020   == 0:.         
+00031b20: 2020 2072 6169 7365 204e 6f50 726f 6475     raise NoProdu
+00031b30: 6374 4176 6169 6c61 626c 6545 7272 6f72  ctAvailableError
+00031b40: 2822 4361 6e6e 6f74 2066 696e 6420 616e  ("Cannot find an
+00031b50: 7920 6c69 6768 7463 7572 7665 7320 6d61  y lightcurves ma
+00031b60: 7463 6869 6e67 2079 6f75 7220 696e 7075  tching your inpu
+00031b70: 742e 2229 0a0a 2020 2020 2020 2020 7265  t.")..        re
+00031b80: 7475 726e 206d 6174 6368 6564 5f70 726f  turn matched_pro
+00031b90: 6473 0a0a 2020 2020 2320 5468 6520 636f  ds..    # The co
+00031ba0: 6d62 696e 6564 2070 686f 746f 6d65 7472  mbined photometr
+00031bb0: 6963 2070 726f 6475 6374 7320 646f 6e27  ic products don'
+00031bc0: 7420 7265 616c 6c79 204e 4545 4420 7468  t really NEED th
+00031bd0: 6569 7220 6f77 6e20 6765 7420 6d65 7468  eir own get meth
+00031be0: 6f64 732c 2062 7574 2049 2066 6967 7572  ods, but I figur
+00031bf0: 6564 2049 2077 6f75 6c64 206a 7573 7420  ed I would just 
+00031c00: 666f 720a 2020 2020 2320 2063 6c61 7269  for.    #  clari
+00031c10: 7479 2773 2073 616b 650a 2020 2020 6465  ty's sake.    de
+00031c20: 6620 6765 745f 636f 6d62 696e 6564 5f69  f get_combined_i
+00031c30: 6d61 6765 7328 7365 6c66 2c20 6c6f 5f65  mages(self, lo_e
+00031c40: 6e3a 2051 7561 6e74 6974 7920 3d20 4e6f  n: Quantity = No
+00031c50: 6e65 2c20 6869 5f65 6e3a 2051 7561 6e74  ne, hi_en: Quant
+00031c60: 6974 7920 3d20 4e6f 6e65 2c20 7073 665f  ity = None, psf_
+00031c70: 636f 7272 3a20 626f 6f6c 203d 2046 616c  corr: bool = Fal
+00031c80: 7365 2c0a 2020 2020 2020 2020 2020 2020  se,.            
+00031c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031ca0: 7073 665f 6d6f 6465 6c3a 2073 7472 203d  psf_model: str =
+00031cb0: 2022 454c 4c42 4554 4122 2c20 7073 665f   "ELLBETA", psf_
+00031cc0: 6269 6e73 3a20 696e 7420 3d20 342c 2070  bins: int = 4, p
+00031cd0: 7366 5f61 6c67 6f3a 2073 7472 203d 2022  sf_algo: str = "
+00031ce0: 726c 222c 0a20 2020 2020 2020 2020 2020  rl",.           
+00031cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031d00: 2070 7366 5f69 7465 723a 2069 6e74 203d   psf_iter: int =
+00031d10: 2031 3529 202d 3e20 556e 696f 6e5b 496d   15) -> Union[Im
+00031d20: 6167 652c 204c 6973 745b 496d 6167 655d  age, List[Image]
+00031d30: 5d3a 0a20 2020 2020 2020 2022 2222 0a20  ]:.        """. 
+00031d40: 2020 2020 2020 2041 206d 6574 686f 6420         A method 
+00031d50: 746f 2072 6574 7269 6576 6520 636f 6d62  to retrieve comb
+00031d60: 696e 6564 2058 4741 2049 6d61 6765 206f  ined XGA Image o
+00031d70: 626a 6563 7473 2c20 6173 2069 6e20 7468  bjects, as in th
+00031d80: 6f73 6520 696d 6167 6573 2074 6861 7420  ose images that 
+00031d90: 6861 7665 2062 6565 6e20 6372 6561 7465  have been create
+00031da0: 6420 6279 0a20 2020 2020 2020 206d 6572  d by.        mer
+00031db0: 6769 6e67 2061 6c6c 2061 7661 696c 6162  ging all availab
+00031dc0: 6c65 2064 6174 6120 666f 7220 7468 6973  le data for this
+00031dd0: 2073 6f75 7263 652e 2054 6869 7320 7375   source. This su
+00031de0: 7070 6f72 7473 2074 6865 2072 6574 7269  pports the retri
+00031df0: 6576 616c 206f 6620 626f 7468 2050 5346  eval of both PSF
+00031e00: 2063 6f72 7265 6374 6564 2061 6e64 206e   corrected and n
+00031e10: 6f6e 2d50 5346 0a20 2020 2020 2020 2063  on-PSF.        c
+00031e20: 6f72 7265 6374 6564 2069 6d61 6765 732c  orrected images,
+00031e30: 2061 7320 7765 6c6c 2061 7320 7365 7474   as well as sett
+00031e40: 696e 6720 7468 6520 656e 6572 6779 206c  ing the energy l
+00031e50: 696d 6974 7320 6f66 2074 6865 2073 7065  imits of the spe
+00031e60: 6369 6669 6320 696d 6167 6520 796f 7520  cific image you 
+00031e70: 776f 756c 6420 6c69 6b65 2e20 410a 2020  would like. A.  
+00031e80: 2020 2020 2020 4e6f 5072 6f64 7563 7441        NoProductA
+00031e90: 7661 696c 6162 6c65 4572 726f 7220 6572  vailableError er
+00031ea0: 726f 7220 7769 6c6c 2062 6520 7261 6973  ror will be rais
+00031eb0: 6564 2069 6620 6e6f 206d 6174 6368 6573  ed if no matches
+00031ec0: 2061 7265 2066 6f75 6e64 2e0a 0a20 2020   are found...   
+00031ed0: 2020 2020 203a 7061 7261 6d20 5175 616e       :param Quan
+00031ee0: 7469 7479 206c 6f5f 656e 3a20 5468 6520  tity lo_en: The 
+00031ef0: 6c6f 7765 7220 656e 6572 6779 206c 696d  lower energy lim
+00031f00: 6974 206f 6620 7468 6520 696d 6167 6520  it of the image 
+00031f10: 796f 7520 7769 7368 2074 6f20 7265 7472  you wish to retr
+00031f20: 6965 7665 2c20 7468 6520 6465 6661 756c  ieve, the defaul
+00031f30: 740a 2020 2020 2020 2020 2020 2020 6973  t.            is
+00031f40: 204e 6f6e 6520 2877 6869 6368 2077 696c   None (which wil
+00031f50: 6c20 7265 7472 6965 7665 2061 6c6c 2069  l retrieve all i
+00031f60: 6d61 6765 7320 7265 6761 7264 6c65 7373  mages regardless
+00031f70: 206f 6620 656e 6572 6779 206c 696d 6974   of energy limit
+00031f80: 292e 0a20 2020 2020 2020 203a 7061 7261  )..        :para
+00031f90: 6d20 5175 616e 7469 7479 2068 695f 656e  m Quantity hi_en
+00031fa0: 3a20 5468 6520 7570 7065 7220 656e 6572  : The upper ener
+00031fb0: 6779 206c 696d 6974 206f 6620 7468 6520  gy limit of the 
+00031fc0: 696d 6167 6520 796f 7520 7769 7368 2074  image you wish t
+00031fd0: 6f20 7265 7472 6965 7665 2c20 7468 6520  o retrieve, the 
+00031fe0: 6465 6661 756c 740a 2020 2020 2020 2020  default.        
+00031ff0: 2020 2020 6973 204e 6f6e 6520 2877 6869      is None (whi
+00032000: 6368 2077 696c 6c20 7265 7472 6965 7665  ch will retrieve
+00032010: 2061 6c6c 2069 6d61 6765 7320 7265 6761   all images rega
+00032020: 7264 6c65 7373 206f 6620 656e 6572 6779  rdless of energy
+00032030: 206c 696d 6974 292e 0a20 2020 2020 2020   limit)..       
+00032040: 203a 7061 7261 6d20 626f 6f6c 2070 7366   :param bool psf
+00032050: 5f63 6f72 723a 2053 6574 7320 7768 6574  _corr: Sets whet
+00032060: 6865 7220 796f 7520 7769 7368 2074 6f20  her you wish to 
+00032070: 7265 7472 6965 7665 2061 2050 5346 2063  retrieve a PSF c
+00032080: 6f72 7265 6374 6564 2069 6d61 6765 206f  orrected image o
+00032090: 7220 6e6f 742e 0a20 2020 2020 2020 203a  r not..        :
+000320a0: 7061 7261 6d20 7374 7220 7073 665f 6d6f  param str psf_mo
+000320b0: 6465 6c3a 2049 6620 7468 6520 696d 6167  del: If the imag
+000320c0: 6520 796f 7520 7761 6e74 2069 7320 5053  e you want is PS
+000320d0: 4620 636f 7272 6563 7465 642c 2074 6869  F corrected, thi
+000320e0: 7320 6973 2074 6865 2050 5346 206d 6f64  s is the PSF mod
+000320f0: 656c 2075 7365 642e 0a20 2020 2020 2020  el used..       
+00032100: 203a 7061 7261 6d20 696e 7420 7073 665f   :param int psf_
+00032110: 6269 6e73 3a20 4966 2074 6865 2069 6d61  bins: If the ima
+00032120: 6765 2079 6f75 2077 616e 7420 6973 2050  ge you want is P
+00032130: 5346 2063 6f72 7265 6374 6564 2c20 7468  SF corrected, th
+00032140: 6973 2069 7320 7468 6520 6e75 6d62 6572  is is the number
+00032150: 206f 6620 5053 4673 2070 6572 0a20 2020   of PSFs per.   
+00032160: 2020 2020 2020 2020 2073 6964 6520 696e           side in
+00032170: 2074 6865 2050 5346 2067 7269 642e 0a20   the PSF grid.. 
+00032180: 2020 2020 2020 203a 7061 7261 6d20 7374         :param st
+00032190: 7220 7073 665f 616c 676f 3a20 4966 2074  r psf_algo: If t
+000321a0: 6865 2069 6d61 6765 2079 6f75 2077 616e  he image you wan
+000321b0: 7420 6973 2050 5346 2063 6f72 7265 6374  t is PSF correct
+000321c0: 6564 2c20 7468 6973 2069 7320 7468 6520  ed, this is the 
+000321d0: 616c 676f 7269 7468 6d20 7573 6564 2e0a  algorithm used..
+000321e0: 2020 2020 2020 2020 3a70 6172 616d 2069          :param i
+000321f0: 6e74 2070 7366 5f69 7465 723a 2049 6620  nt psf_iter: If 
+00032200: 7468 6520 696d 6167 6520 796f 7520 7761  the image you wa
+00032210: 6e74 2069 7320 5053 4620 636f 7272 6563  nt is PSF correc
+00032220: 7465 642c 2074 6869 7320 6973 2074 6865  ted, this is the
+00032230: 206e 756d 6265 7220 6f66 2069 7465 7261   number of itera
+00032240: 7469 6f6e 732e 0a20 2020 2020 2020 203a  tions..        :
+00032250: 7265 7475 726e 3a20 416e 2058 4741 2049  return: An XGA I
+00032260: 6d61 6765 206f 626a 6563 7420 2869 6620  mage object (if 
+00032270: 7468 6572 6520 6973 2061 6e20 6578 6163  there is an exac
+00032280: 7420 6d61 7463 6829 2c20 6f72 2061 206c  t match), or a l
+00032290: 6973 7420 6f66 2058 4741 2049 6d61 6765  ist of XGA Image
+000322a0: 206f 626a 6563 7473 2028 6966 2074 6865   objects (if the
+000322b0: 7265 0a20 2020 2020 2020 2020 2020 2077  re.            w
+000322c0: 6572 6520 6d75 6c74 6970 6c65 206d 6174  ere multiple mat
+000322d0: 6368 696e 6720 7072 6f64 7563 7473 292e  ching products).
+000322e0: 0a20 2020 2020 2020 203a 7274 7970 653a  .        :rtype:
+000322f0: 2055 6e69 6f6e 5b49 6d61 6765 2c20 4c69   Union[Image, Li
+00032300: 7374 5b49 6d61 6765 5d5d 0a20 2020 2020  st[Image]].     
+00032310: 2020 2022 2222 0a0a 2020 2020 2020 2020     """..        
+00032320: 2320 4368 6563 6b73 2074 6f20 6d61 6b65  # Checks to make
+00032330: 2073 7572 6520 7468 6174 2061 6e20 616c   sure that an al
+00032340: 6c6f 7765 6420 636f 6d62 696e 6174 696f  lowed combinatio
+00032350: 6e20 6f66 206c 6f5f 656e 2061 6e64 2068  n of lo_en and h
+00032360: 695f 656e 2068 6173 2062 6565 6e20 7061  i_en has been pa
+00032370: 7373 6564 2e0a 2020 2020 2020 2020 6966  ssed..        if
+00032380: 2061 6c6c 285b 6c6f 5f65 6e20 6973 204e   all([lo_en is N
+00032390: 6f6e 652c 2068 695f 656e 2069 7320 4e6f  one, hi_en is No
+000323a0: 6e65 5d29 3a0a 2020 2020 2020 2020 2020  ne]):.          
+000323b0: 2020 2320 5365 7473 2061 2066 6c61 6720    # Sets a flag 
+000323c0: 746f 2074 656c 6c20 7468 6520 7265 7374  to tell the rest
+000323d0: 206f 6620 7468 6520 6d65 7468 6f64 2077   of the method w
+000323e0: 6865 7468 6572 2077 6520 6861 7665 2065  hether we have e
+000323f0: 6e65 7267 7920 6c69 6d73 206f 7220 6e6f  nergy lims or no
+00032400: 740a 2020 2020 2020 2020 2020 2020 7769  t.            wi
+00032410: 7468 5f6c 696d 7320 3d20 4661 6c73 650a  th_lims = False.
+00032420: 2020 2020 2020 2020 2020 2020 656e 6572              ener
+00032430: 6779 5f6b 6579 203d 204e 6f6e 650a 2020  gy_key = None.  
+00032440: 2020 2020 2020 656c 6966 2061 6c6c 285b        elif all([
+00032450: 6c6f 5f65 6e20 6973 206e 6f74 204e 6f6e  lo_en is not Non
+00032460: 652c 2068 695f 656e 2069 7320 6e6f 7420  e, hi_en is not 
+00032470: 4e6f 6e65 5d29 3a0a 2020 2020 2020 2020  None]):.        
+00032480: 2020 2020 7769 7468 5f6c 696d 7320 3d20      with_lims = 
+00032490: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
+000324a0: 2023 2057 6520 6861 7665 2065 6e65 7267   # We have energ
+000324b0: 7920 6c69 6d69 7473 2068 6572 6520 736f  y limits here so
+000324c0: 2077 6520 6173 7365 6d62 6c65 2074 6865   we assemble the
+000324d0: 206b 6579 2074 6861 7420 6465 7363 7269   key that descri
+000324e0: 6265 7320 7468 6520 656e 6572 6779 2072  bes the energy r
+000324f0: 616e 6765 0a20 2020 2020 2020 2020 2020  ange.           
+00032500: 2065 6e65 7267 795f 6b65 7920 3d20 2262   energy_key = "b
+00032510: 6f75 6e64 5f7b 6c7d 2d7b 687d 222e 666f  ound_{l}-{h}".fo
+00032520: 726d 6174 286c 3d6c 6f5f 656e 2e74 6f28  rmat(l=lo_en.to(
+00032530: 276b 6556 2729 2e76 616c 7565 2c20 683d  'keV').value, h=
+00032540: 6869 5f65 6e2e 746f 2827 6b65 5627 292e  hi_en.to('keV').
+00032550: 7661 6c75 6529 0a20 2020 2020 2020 2065  value).        e
+00032560: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00032570: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+00032580: 7228 226c 6f5f 656e 2061 6e64 2068 695f  r("lo_en and hi_
+00032590: 656e 206d 7573 7420 6265 2065 6974 6865  en must be eithe
+000325a0: 7220 424f 5448 204e 6f6e 6520 6f72 2042  r BOTH None or B
+000325b0: 4f54 4820 616e 2041 7374 726f 7079 2071  OTH an Astropy q
+000325c0: 7561 6e74 6974 792e 2229 0a0a 2020 2020  uantity.")..    
+000325d0: 2020 2020 2320 4966 2077 6520 6172 6520      # If we are 
+000325e0: 6c6f 6f6b 696e 6720 666f 7220 6120 5053  looking for a PS
+000325f0: 4620 636f 7272 6563 7465 6420 696d 6167  F corrected imag
+00032600: 6520 7468 656e 2077 6520 6173 7365 6d62  e then we assemb
+00032610: 6c65 2074 6865 2065 7874 7261 206b 6579  le the extra key
+00032620: 2077 6974 6820 5053 4620 6465 7461 696c   with PSF detail
+00032630: 730a 2020 2020 2020 2020 6966 2070 7366  s.        if psf
+00032640: 5f63 6f72 723a 0a20 2020 2020 2020 2020  _corr:.         
+00032650: 2020 2065 7874 7261 5f6b 6579 203d 2022     extra_key = "
+00032660: 5f22 202b 2070 7366 5f6d 6f64 656c 202b  _" + psf_model +
+00032670: 2022 5f22 202b 2073 7472 2870 7366 5f62   "_" + str(psf_b
+00032680: 696e 7329 202b 2022 5f22 202b 2070 7366  ins) + "_" + psf
+00032690: 5f61 6c67 6f20 2b20 7374 7228 7073 665f  _algo + str(psf_
+000326a0: 6974 6572 290a 0a20 2020 2020 2020 2069  iter)..        i
+000326b0: 6620 6e6f 7420 7073 665f 636f 7272 2061  f not psf_corr a
+000326c0: 6e64 2077 6974 685f 6c69 6d73 3a0a 2020  nd with_lims:.  
+000326d0: 2020 2020 2020 2020 2020 2320 5369 6d70            # Simp
+000326e0: 6c65 7374 2063 6173 652c 206a 7573 7420  lest case, just 
+000326f0: 6361 6c6c 696e 6720 6765 745f 7072 6f64  calling get_prod
+00032700: 7563 7473 2061 6e64 2070 6173 7369 6e67  ucts and passing
+00032710: 2069 6e20 6f75 7220 696e 666f 726d 6174   in our informat
+00032720: 696f 6e0a 2020 2020 2020 2020 2020 2020  ion.            
+00032730: 6d61 7463 6865 645f 7072 6f64 7320 3d20  matched_prods = 
+00032740: 7365 6c66 2e67 6574 5f70 726f 6475 6374  self.get_product
+00032750: 7328 2763 6f6d 6269 6e65 645f 696d 6167  s('combined_imag
+00032760: 6527 2c20 6578 7472 615f 6b65 793d 656e  e', extra_key=en
+00032770: 6572 6779 5f6b 6579 290a 2020 2020 2020  ergy_key).      
+00032780: 2020 656c 6966 206e 6f74 2070 7366 5f63    elif not psf_c
+00032790: 6f72 7220 616e 6420 6e6f 7420 7769 7468  orr and not with
+000327a0: 5f6c 696d 733a 0a20 2020 2020 2020 2020  _lims:.         
+000327b0: 2020 2062 726f 6164 5f6d 6174 6368 6573     broad_matches
+000327c0: 203d 2073 656c 662e 6765 745f 7072 6f64   = self.get_prod
+000327d0: 7563 7473 2822 636f 6d62 696e 6564 5f69  ucts("combined_i
+000327e0: 6d61 6765 2229 0a20 2020 2020 2020 2020  mage").         
+000327f0: 2020 206d 6174 6368 6564 5f70 726f 6473     matched_prods
+00032800: 203d 205b 7020 666f 7220 7020 696e 2062   = [p for p in b
+00032810: 726f 6164 5f6d 6174 6368 6573 2069 6620  road_matches if 
+00032820: 6e6f 7420 702e 7073 665f 636f 7272 6563  not p.psf_correc
+00032830: 7465 645d 0a20 2020 2020 2020 2065 6c69  ted].        eli
+00032840: 6620 7073 665f 636f 7272 2061 6e64 2077  f psf_corr and w
+00032850: 6974 685f 6c69 6d73 3a0a 2020 2020 2020  ith_lims:.      
+00032860: 2020 2020 2020 2320 4865 7265 2077 6520        # Here we 
+00032870: 6e65 6564 2074 6f20 6164 6420 7468 6520  need to add the 
+00032880: 6578 7472 6120 6b65 7920 746f 2074 6865  extra key to the
+00032890: 2065 6e65 7267 7920 6b65 790a 2020 2020   energy key.    
+000328a0: 2020 2020 2020 2020 6d61 7463 6865 645f          matched_
+000328b0: 7072 6f64 7320 3d20 7365 6c66 2e67 6574  prods = self.get
+000328c0: 5f70 726f 6475 6374 7328 2763 6f6d 6269  _products('combi
+000328d0: 6e65 645f 696d 6167 6527 2c20 6578 7472  ned_image', extr
+000328e0: 615f 6b65 793d 656e 6572 6779 5f6b 6579  a_key=energy_key
+000328f0: 202b 2065 7874 7261 5f6b 6579 290a 2020   + extra_key).  
+00032900: 2020 2020 2020 656c 6966 2070 7366 5f63        elif psf_c
+00032910: 6f72 7220 616e 6420 6e6f 7420 7769 7468  orr and not with
+00032920: 5f6c 696d 733a 0a20 2020 2020 2020 2020  _lims:.         
+00032930: 2020 2023 2048 6572 6520 7765 2064 6f6e     # Here we don
+00032940: 2774 206b 6e6f 7720 7468 6520 656e 6572  't know the ener
+00032950: 6779 206b 6579 2c20 736f 2077 6520 6861  gy key, so we ha
+00032960: 7665 2074 6f20 6c6f 6f6b 2066 6f72 2070  ve to look for p
+00032970: 6172 7469 616c 206d 6174 6368 6573 2069  artial matches i
+00032980: 6e20 7468 6520 6765 745f 7072 6f64 7563  n the get_produc
+00032990: 7473 2072 6574 7572 6e0a 2020 2020 2020  ts return.      
+000329a0: 2020 2020 2020 6272 6f61 645f 6d61 7463        broad_matc
+000329b0: 6865 7320 3d20 7365 6c66 2e67 6574 5f70  hes = self.get_p
+000329c0: 726f 6475 6374 7328 2763 6f6d 6269 6e65  roducts('combine
+000329d0: 645f 696d 6167 6527 2c20 6578 7472 615f  d_image', extra_
+000329e0: 6b65 793d 4e6f 6e65 2c20 6a75 7374 5f6f  key=None, just_o
+000329f0: 626a 3d46 616c 7365 290a 2020 2020 2020  bj=False).      
+00032a00: 2020 2020 2020 6d61 7463 6865 645f 7072        matched_pr
+00032a10: 6f64 7320 3d20 5b70 5b2d 315d 2066 6f72  ods = [p[-1] for
+00032a20: 2070 2069 6e20 6272 6f61 645f 6d61 7463   p in broad_matc
+00032a30: 6865 7320 6966 2065 7874 7261 5f6b 6579  hes if extra_key
+00032a40: 2069 6e20 705b 2d32 5d5d 0a0a 2020 2020   in p[-2]]..    
+00032a50: 2020 2020 6966 206c 656e 286d 6174 6368      if len(match
+00032a60: 6564 5f70 726f 6473 2920 3d3d 2031 3a0a  ed_prods) == 1:.
+00032a70: 2020 2020 2020 2020 2020 2020 6d61 7463              matc
+00032a80: 6865 645f 7072 6f64 7320 3d20 6d61 7463  hed_prods = matc
+00032a90: 6865 645f 7072 6f64 735b 305d 0a20 2020  hed_prods[0].   
+00032aa0: 2020 2020 2065 6c69 6620 6c65 6e28 6d61       elif len(ma
+00032ab0: 7463 6865 645f 7072 6f64 7329 203d 3d20  tched_prods) == 
+00032ac0: 303a 0a20 2020 2020 2020 2020 2020 2072  0:.            r
+00032ad0: 6169 7365 204e 6f50 726f 6475 6374 4176  aise NoProductAv
+00032ae0: 6169 6c61 626c 6545 7272 6f72 2822 4361  ailableError("Ca
+00032af0: 6e6e 6f74 2066 696e 6420 616e 7920 636f  nnot find any co
+00032b00: 6d62 696e 6564 2069 6d61 6765 7320 6d61  mbined images ma
+00032b10: 7463 6869 6e67 2079 6f75 7220 696e 7075  tching your inpu
+00032b20: 742e 2229 0a0a 2020 2020 2020 2020 7265  t.")..        re
+00032b30: 7475 726e 206d 6174 6368 6564 5f70 726f  turn matched_pro
+00032b40: 6473 0a0a 2020 2020 6465 6620 6765 745f  ds..    def get_
+00032b50: 636f 6d62 696e 6564 5f65 7870 6d61 7073  combined_expmaps
+00032b60: 2873 656c 662c 206c 6f5f 656e 3a20 5175  (self, lo_en: Qu
+00032b70: 616e 7469 7479 203d 204e 6f6e 652c 2068  antity = None, h
+00032b80: 695f 656e 3a20 5175 616e 7469 7479 203d  i_en: Quantity =
+00032b90: 204e 6f6e 6529 202d 3e20 556e 696f 6e5b   None) -> Union[
+00032ba0: 4578 704d 6170 2c20 4c69 7374 5b45 7870  ExpMap, List[Exp
+00032bb0: 4d61 705d 5d3a 0a20 2020 2020 2020 2022  Map]]:.        "
+00032bc0: 2222 0a20 2020 2020 2020 2041 206d 6574  "".        A met
+00032bd0: 686f 6420 746f 2072 6574 7269 6576 6520  hod to retrieve 
+00032be0: 636f 6d62 696e 6564 2058 4741 2045 7870  combined XGA Exp
+00032bf0: 4d61 7020 6f62 6a65 6374 732c 2061 7320  Map objects, as 
+00032c00: 696e 2074 686f 7365 2065 7870 6f73 7572  in those exposur
+00032c10: 6520 6d61 7073 2074 6861 7420 6861 7665  e maps that have
+00032c20: 2062 6565 6e20 6372 6561 7465 6420 6279   been created by
+00032c30: 0a20 2020 2020 2020 206d 6572 6769 6e67  .        merging
+00032c40: 2061 6c6c 2061 7661 696c 6162 6c65 2064   all available d
+00032c50: 6174 6120 666f 7220 7468 6973 2073 6f75  ata for this sou
+00032c60: 7263 652e 2054 6869 7320 7375 7070 6f72  rce. This suppor
+00032c70: 7473 2073 6574 7469 6e67 2074 6865 2065  ts setting the e
+00032c80: 6e65 7267 7920 6c69 6d69 7473 206f 6620  nergy limits of 
+00032c90: 7468 6520 7370 6563 6966 6963 0a20 2020  the specific.   
+00032ca0: 2020 2020 2065 7870 6f73 7572 6520 6d61       exposure ma
+00032cb0: 7073 2079 6f75 2077 6f75 6c64 206c 696b  ps you would lik
+00032cc0: 652e 2041 204e 6f50 726f 6475 6374 4176  e. A NoProductAv
+00032cd0: 6169 6c61 626c 6545 7272 6f72 2065 7272  ailableError err
+00032ce0: 6f72 2077 696c 6c20 6265 2072 6169 7365  or will be raise
+00032cf0: 6420 6966 206e 6f20 6d61 7463 6865 7320  d if no matches 
+00032d00: 6172 6520 666f 756e 642e 0a0a 2020 2020  are found...    
+00032d10: 2020 2020 3a70 6172 616d 2051 7561 6e74      :param Quant
+00032d20: 6974 7920 6c6f 5f65 6e3a 2054 6865 206c  ity lo_en: The l
+00032d30: 6f77 6572 2065 6e65 7267 7920 6c69 6d69  ower energy limi
+00032d40: 7420 6f66 2074 6865 2065 7870 6f73 7572  t of the exposur
+00032d50: 6520 6d61 7073 2079 6f75 2077 6973 6820  e maps you wish 
+00032d60: 746f 2072 6574 7269 6576 652c 2074 6865  to retrieve, the
+00032d70: 2064 6566 6175 6c74 0a20 2020 2020 2020   default.       
+00032d80: 2020 2020 2069 7320 4e6f 6e65 2028 7768       is None (wh
+00032d90: 6963 6820 7769 6c6c 2072 6574 7269 6576  ich will retriev
+00032da0: 6520 616c 6c20 696d 6167 6573 2072 6567  e all images reg
+00032db0: 6172 646c 6573 7320 6f66 2065 6e65 7267  ardless of energ
+00032dc0: 7920 6c69 6d69 7429 2e0a 2020 2020 2020  y limit)..      
+00032dd0: 2020 3a70 6172 616d 2051 7561 6e74 6974    :param Quantit
+00032de0: 7920 6869 5f65 6e3a 2054 6865 2075 7070  y hi_en: The upp
+00032df0: 6572 2065 6e65 7267 7920 6c69 6d69 7420  er energy limit 
+00032e00: 6f66 2074 6865 2065 7870 6f73 7572 6520  of the exposure 
+00032e10: 6d61 7073 2079 6f75 2077 6973 6820 746f  maps you wish to
+00032e20: 2072 6574 7269 6576 652c 2074 6865 2064   retrieve, the d
+00032e30: 6566 6175 6c74 0a20 2020 2020 2020 2020  efault.         
+00032e40: 2020 2069 7320 4e6f 6e65 2028 7768 6963     is None (whic
+00032e50: 6820 7769 6c6c 2072 6574 7269 6576 6520  h will retrieve 
+00032e60: 616c 6c20 696d 6167 6573 2072 6567 6172  all images regar
+00032e70: 646c 6573 7320 6f66 2065 6e65 7267 7920  dless of energy 
+00032e80: 6c69 6d69 7429 2e0a 2020 2020 2020 2020  limit)..        
+00032e90: 3a72 6574 7572 6e3a 2041 6e20 5847 4120  :return: An XGA 
+00032ea0: 4578 704d 6170 206f 626a 6563 7420 2869  ExpMap object (i
+00032eb0: 6620 7468 6572 6520 6973 2061 6e20 6578  f there is an ex
+00032ec0: 6163 7420 6d61 7463 6829 2c20 6f72 2061  act match), or a
+00032ed0: 206c 6973 7420 6f66 2058 4741 2049 6d61   list of XGA Ima
+00032ee0: 6765 206f 626a 6563 7473 2028 6966 2074  ge objects (if t
+00032ef0: 6865 7265 0a20 2020 2020 2020 2020 2020  here.           
+00032f00: 2077 6572 6520 6d75 6c74 6970 6c65 206d   were multiple m
+00032f10: 6174 6368 696e 6720 7072 6f64 7563 7473  atching products
+00032f20: 292e 0a20 2020 2020 2020 203a 7274 7970  )..        :rtyp
+00032f30: 653a 2055 6e69 6f6e 5b45 7870 4d61 702c  e: Union[ExpMap,
+00032f40: 204c 6973 745b 4578 704d 6170 5d5d 0a20   List[ExpMap]]. 
+00032f50: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00032f60: 2020 2069 6620 616c 6c28 5b6c 6f5f 656e     if all([lo_en
+00032f70: 2069 7320 4e6f 6e65 2c20 6869 5f65 6e20   is None, hi_en 
+00032f80: 6973 204e 6f6e 655d 293a 0a20 2020 2020  is None]):.     
+00032f90: 2020 2020 2020 2065 6e65 7267 795f 6b65         energy_ke
+00032fa0: 7920 3d20 4e6f 6e65 0a20 2020 2020 2020  y = None.       
+00032fb0: 2065 6c69 6620 616c 6c28 5b6c 6f5f 656e   elif all([lo_en
+00032fc0: 2069 7320 6e6f 7420 4e6f 6e65 2c20 6869   is not None, hi
+00032fd0: 5f65 6e20 6973 206e 6f74 204e 6f6e 655d  _en is not None]
+00032fe0: 293a 0a20 2020 2020 2020 2020 2020 2065  ):.            e
+00032ff0: 6e65 7267 795f 6b65 7920 3d20 2262 6f75  nergy_key = "bou
+00033000: 6e64 5f7b 6c7d 2d7b 687d 222e 666f 726d  nd_{l}-{h}".form
+00033010: 6174 286c 3d6c 6f5f 656e 2e74 6f28 276b  at(l=lo_en.to('k
+00033020: 6556 2729 2e76 616c 7565 2c20 683d 6869  eV').value, h=hi
+00033030: 5f65 6e2e 746f 2827 6b65 5627 292e 7661  _en.to('keV').va
+00033040: 6c75 6529 0a20 2020 2020 2020 2065 6c73  lue).        els
+00033050: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+00033060: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+00033070: 226c 6f5f 656e 2061 6e64 2068 695f 656e  "lo_en and hi_en
+00033080: 206d 7573 7420 6265 2065 6974 6865 7220   must be either 
+00033090: 424f 5448 204e 6f6e 6520 6f72 2042 4f54  BOTH None or BOT
+000330a0: 4820 616e 2041 7374 726f 7079 2071 7561  H an Astropy qua
+000330b0: 6e74 6974 792e 2229 0a0a 2020 2020 2020  ntity.")..      
+000330c0: 2020 6d61 7463 6865 645f 7072 6f64 7320    matched_prods 
+000330d0: 3d20 7365 6c66 2e67 6574 5f70 726f 6475  = self.get_produ
+000330e0: 6374 7328 2763 6f6d 6269 6e65 645f 6578  cts('combined_ex
+000330f0: 706d 6170 272c 2065 7874 7261 5f6b 6579  pmap', extra_key
+00033100: 3d65 6e65 7267 795f 6b65 7929 0a20 2020  =energy_key).   
+00033110: 2020 2020 2069 6620 6c65 6e28 6d61 7463       if len(matc
+00033120: 6865 645f 7072 6f64 7329 203d 3d20 313a  hed_prods) == 1:
+00033130: 0a20 2020 2020 2020 2020 2020 206d 6174  .            mat
+00033140: 6368 6564 5f70 726f 6473 203d 206d 6174  ched_prods = mat
+00033150: 6368 6564 5f70 726f 6473 5b30 5d0a 2020  ched_prods[0].  
+00033160: 2020 2020 2020 656c 6966 206c 656e 286d        elif len(m
+00033170: 6174 6368 6564 5f70 726f 6473 2920 3d3d  atched_prods) ==
+00033180: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+00033190: 7261 6973 6520 4e6f 5072 6f64 7563 7441  raise NoProductA
+000331a0: 7661 696c 6162 6c65 4572 726f 7228 2243  vailableError("C
+000331b0: 616e 6e6f 7420 6669 6e64 2061 6e79 2063  annot find any c
+000331c0: 6f6d 6269 6e65 6420 6578 706f 7375 7265  ombined exposure
+000331d0: 206d 6170 7320 6d61 7463 6869 6e67 2079   maps matching y
+000331e0: 6f75 7220 696e 7075 742e 2229 0a0a 2020  our input.")..  
+000331f0: 2020 2020 2020 7265 7475 726e 206d 6174        return mat
+00033200: 6368 6564 5f70 726f 6473 0a0a 2020 2020  ched_prods..    
+00033210: 6465 6620 6765 745f 636f 6d62 696e 6564  def get_combined
+00033220: 5f72 6174 656d 6170 7328 7365 6c66 2c20  _ratemaps(self, 
+00033230: 6c6f 5f65 6e3a 2051 7561 6e74 6974 7920  lo_en: Quantity 
+00033240: 3d20 4e6f 6e65 2c20 6869 5f65 6e3a 2051  = None, hi_en: Q
+00033250: 7561 6e74 6974 7920 3d20 4e6f 6e65 2c20  uantity = None, 
+00033260: 2070 7366 5f63 6f72 723a 2062 6f6f 6c20   psf_corr: bool 
+00033270: 3d20 4661 6c73 652c 0a20 2020 2020 2020  = False,.       
+00033280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033290: 2020 2020 2020 2070 7366 5f6d 6f64 656c         psf_model
+000332a0: 3a20 7374 7220 3d20 2245 4c4c 4245 5441  : str = "ELLBETA
+000332b0: 222c 2070 7366 5f62 696e 733a 2069 6e74  ", psf_bins: int
+000332c0: 203d 2034 2c20 7073 665f 616c 676f 3a20   = 4, psf_algo: 
+000332d0: 7374 7220 3d20 2272 6c22 2c0a 2020 2020  str = "rl",.    
+000332e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000332f0: 2020 2020 2020 2020 2020 7073 665f 6974            psf_it
+00033300: 6572 3a20 696e 7420 3d20 3135 2920 2d3e  er: int = 15) ->
+00033310: 2055 6e69 6f6e 5b52 6174 654d 6170 2c20   Union[RateMap, 
+00033320: 4c69 7374 5b52 6174 654d 6170 5d5d 3a0a  List[RateMap]]:.
+00033330: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00033340: 2020 2020 4120 6d65 7468 6f64 2074 6f20      A method to 
+00033350: 7265 7472 6965 7665 2063 6f6d 6269 6e65  retrieve combine
+00033360: 6420 5847 4120 5261 7465 4d61 7020 6f62  d XGA RateMap ob
+00033370: 6a65 6374 732c 2061 7320 696e 2074 686f  jects, as in tho
+00033380: 7365 2072 6174 656d 6170 2074 6861 7420  se ratemap that 
+00033390: 6861 7665 2062 6565 6e20 6372 6561 7465  have been create
+000333a0: 6420 6279 0a20 2020 2020 2020 206d 6572  d by.        mer
+000333b0: 6769 6e67 2061 6c6c 2061 7661 696c 6162  ging all availab
+000333c0: 6c65 2064 6174 6120 666f 7220 7468 6973  le data for this
+000333d0: 2073 6f75 7263 652e 2054 6869 7320 7375   source. This su
+000333e0: 7070 6f72 7473 2074 6865 2072 6574 7269  pports the retri
+000333f0: 6576 616c 206f 6620 626f 7468 2050 5346  eval of both PSF
+00033400: 2063 6f72 7265 6374 6564 2061 6e64 206e   corrected and n
+00033410: 6f6e 2d50 5346 0a20 2020 2020 2020 2063  on-PSF.        c
+00033420: 6f72 7265 6374 6564 2072 6174 656d 6170  orrected ratemap
+00033430: 732c 2061 7320 7765 6c6c 2061 7320 7365  s, as well as se
+00033440: 7474 696e 6720 7468 6520 656e 6572 6779  tting the energy
+00033450: 206c 696d 6974 7320 6f66 2074 6865 2073   limits of the s
+00033460: 7065 6369 6669 6320 7261 7465 6d61 7020  pecific ratemap 
+00033470: 796f 7520 776f 756c 6420 6c69 6b65 2e20  you would like. 
+00033480: 410a 2020 2020 2020 2020 4e6f 5072 6f64  A.        NoProd
+00033490: 7563 7441 7661 696c 6162 6c65 4572 726f  uctAvailableErro
+000334a0: 7220 6572 726f 7220 7769 6c6c 2062 6520  r error will be 
+000334b0: 7261 6973 6564 2069 6620 6e6f 206d 6174  raised if no mat
+000334c0: 6368 6573 2061 7265 2066 6f75 6e64 2e0a  ches are found..
+000334d0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+000334e0: 5175 616e 7469 7479 206c 6f5f 656e 3a20  Quantity lo_en: 
+000334f0: 5468 6520 6c6f 7765 7220 656e 6572 6779  The lower energy
+00033500: 206c 696d 6974 206f 6620 7468 6520 7261   limit of the ra
+00033510: 7465 6d61 7073 2079 6f75 2077 6973 6820  temaps you wish 
+00033520: 746f 2072 6574 7269 6576 652c 2074 6865  to retrieve, the
+00033530: 2064 6566 6175 6c74 0a20 2020 2020 2020   default.       
+00033540: 2020 2020 2069 7320 4e6f 6e65 2028 7768       is None (wh
+00033550: 6963 6820 7769 6c6c 2072 6574 7269 6576  ich will retriev
+00033560: 6520 616c 6c20 7261 7465 6d61 7073 2072  e all ratemaps r
+00033570: 6567 6172 646c 6573 7320 6f66 2065 6e65  egardless of ene
+00033580: 7267 7920 6c69 6d69 7429 2e0a 2020 2020  rgy limit)..    
+00033590: 2020 2020 3a70 6172 616d 2051 7561 6e74      :param Quant
+000335a0: 6974 7920 6869 5f65 6e3a 2054 6865 2075  ity hi_en: The u
+000335b0: 7070 6572 2065 6e65 7267 7920 6c69 6d69  pper energy limi
+000335c0: 7420 6f66 2074 6865 2072 6174 656d 6170  t of the ratemap
+000335d0: 7320 796f 7520 7769 7368 2074 6f20 7265  s you wish to re
+000335e0: 7472 6965 7665 2c20 7468 6520 6465 6661  trieve, the defa
+000335f0: 756c 740a 2020 2020 2020 2020 2020 2020  ult.            
+00033600: 6973 204e 6f6e 6520 2877 6869 6368 2077  is None (which w
+00033610: 696c 6c20 7265 7472 6965 7665 2061 6c6c  ill retrieve all
+00033620: 2072 6174 656d 6170 7320 7265 6761 7264   ratemaps regard
+00033630: 6c65 7373 206f 6620 656e 6572 6779 206c  less of energy l
+00033640: 696d 6974 292e 0a20 2020 2020 2020 203a  imit)..        :
+00033650: 7061 7261 6d20 626f 6f6c 2070 7366 5f63  param bool psf_c
+00033660: 6f72 723a 2053 6574 7320 7768 6574 6865  orr: Sets whethe
+00033670: 7220 796f 7520 7769 7368 2074 6f20 7265  r you wish to re
+00033680: 7472 6965 7665 2061 2050 5346 2063 6f72  trieve a PSF cor
+00033690: 7265 6374 6564 2072 6174 656d 6170 206f  rected ratemap o
+000336a0: 7220 6e6f 742e 0a20 2020 2020 2020 203a  r not..        :
+000336b0: 7061 7261 6d20 7374 7220 7073 665f 6d6f  param str psf_mo
+000336c0: 6465 6c3a 2049 6620 7468 6520 7261 7465  del: If the rate
+000336d0: 6d61 7020 796f 7520 7761 6e74 2069 7320  map you want is 
+000336e0: 5053 4620 636f 7272 6563 7465 642c 2074  PSF corrected, t
+000336f0: 6869 7320 6973 2074 6865 2050 5346 206d  his is the PSF m
+00033700: 6f64 656c 2075 7365 642e 0a20 2020 2020  odel used..     
+00033710: 2020 203a 7061 7261 6d20 696e 7420 7073     :param int ps
+00033720: 665f 6269 6e73 3a20 4966 2074 6865 2072  f_bins: If the r
+00033730: 6174 656d 6170 2079 6f75 2077 616e 7420  atemap you want 
+00033740: 6973 2050 5346 2063 6f72 7265 6374 6564  is PSF corrected
+00033750: 2c20 7468 6973 2069 7320 7468 6520 6e75  , this is the nu
+00033760: 6d62 6572 206f 6620 5053 4673 2070 6572  mber of PSFs per
+00033770: 0a20 2020 2020 2020 2020 2020 2073 6964  .            sid
+00033780: 6520 696e 2074 6865 2050 5346 2067 7269  e in the PSF gri
+00033790: 642e 0a20 2020 2020 2020 203a 7061 7261  d..        :para
+000337a0: 6d20 7374 7220 7073 665f 616c 676f 3a20  m str psf_algo: 
+000337b0: 4966 2074 6865 2072 6174 656d 6170 2079  If the ratemap y
+000337c0: 6f75 2077 616e 7420 6973 2050 5346 2063  ou want is PSF c
+000337d0: 6f72 7265 6374 6564 2c20 7468 6973 2069  orrected, this i
+000337e0: 7320 7468 6520 616c 676f 7269 7468 6d20  s the algorithm 
+000337f0: 7573 6564 2e0a 2020 2020 2020 2020 3a70  used..        :p
+00033800: 6172 616d 2069 6e74 2070 7366 5f69 7465  aram int psf_ite
+00033810: 723a 2049 6620 7468 6520 7261 7465 6d61  r: If the ratema
+00033820: 7020 796f 7520 7761 6e74 2069 7320 5053  p you want is PS
+00033830: 4620 636f 7272 6563 7465 642c 2074 6869  F corrected, thi
+00033840: 7320 6973 2074 6865 206e 756d 6265 7220  s is the number 
+00033850: 6f66 2069 7465 7261 7469 6f6e 732e 0a20  of iterations.. 
+00033860: 2020 2020 2020 203a 7265 7475 726e 3a20         :return: 
+00033870: 416e 2058 4741 2052 6174 654d 6170 206f  An XGA RateMap o
+00033880: 626a 6563 7420 2869 6620 7468 6572 6520  bject (if there 
+00033890: 6973 2061 6e20 6578 6163 7420 6d61 7463  is an exact matc
+000338a0: 6829 2c20 6f72 2061 206c 6973 7420 6f66  h), or a list of
+000338b0: 2058 4741 2052 6174 654d 6170 206f 626a   XGA RateMap obj
+000338c0: 6563 7473 2028 6966 2074 6865 7265 0a20  ects (if there. 
+000338d0: 2020 2020 2020 2020 2020 2077 6572 6520             were 
+000338e0: 6d75 6c74 6970 6c65 206d 6174 6368 696e  multiple matchin
+000338f0: 6720 7072 6f64 7563 7473 292e 0a20 2020  g products)..   
+00033900: 2020 2020 203a 7274 7970 653a 2055 6e69       :rtype: Uni
+00033910: 6f6e 5b52 6174 654d 6170 2c20 4c69 7374  on[RateMap, List
+00033920: 5b52 6174 654d 6170 5d5d 0a20 2020 2020  [RateMap]].     
+00033930: 2020 2022 2222 0a20 2020 2020 2020 2023     """.        #
+00033940: 2054 6869 7320 6675 6e63 7469 6f6e 2069   This function i
+00033950: 7320 6573 7365 6e74 6961 6c6c 7920 6964  s essentially id
+00033960: 656e 7469 6361 6c20 746f 2067 6574 5f69  entical to get_i
+00033970: 6d61 6765 732c 2062 7574 2049 276d 2067  mages, but I'm g
+00033980: 6f69 6e67 2074 6f20 6265 206c 617a 7920  oing to be lazy 
+00033990: 616e 6420 6e6f 7420 7772 6974 650a 2020  and not write.  
+000339a0: 2020 2020 2020 2320 2061 2073 6570 6172        #  a separ
+000339b0: 6174 6520 696e 7465 726e 616c 2066 756e  ate internal fun
+000339c0: 6374 696f 6e20 746f 2064 6f20 626f 7468  ction to do both
+000339d0: 2e0a 0a20 2020 2020 2020 2023 2043 6865  ...        # Che
+000339e0: 636b 7320 746f 206d 616b 6520 7375 7265  cks to make sure
+000339f0: 2074 6861 7420 616e 2061 6c6c 6f77 6564   that an allowed
+00033a00: 2063 6f6d 6269 6e61 7469 6f6e 206f 6620   combination of 
+00033a10: 6c6f 5f65 6e20 616e 6420 6869 5f65 6e20  lo_en and hi_en 
+00033a20: 6861 7320 6265 656e 2070 6173 7365 642e  has been passed.
+00033a30: 0a20 2020 2020 2020 2069 6620 616c 6c28  .        if all(
+00033a40: 5b6c 6f5f 656e 2069 7320 4e6f 6e65 2c20  [lo_en is None, 
+00033a50: 6869 5f65 6e20 6973 204e 6f6e 655d 293a  hi_en is None]):
+00033a60: 0a20 2020 2020 2020 2020 2020 2023 2053  .            # S
+00033a70: 6574 7320 6120 666c 6167 2074 6f20 7465  ets a flag to te
+00033a80: 6c6c 2074 6865 2072 6573 7420 6f66 2074  ll the rest of t
+00033a90: 6865 206d 6574 686f 6420 7768 6574 6865  he method whethe
+00033aa0: 7220 7765 2068 6176 6520 656e 6572 6779  r we have energy
+00033ab0: 206c 696d 7320 6f72 206e 6f74 0a20 2020   lims or not.   
+00033ac0: 2020 2020 2020 2020 2077 6974 685f 6c69           with_li
+00033ad0: 6d73 203d 2046 616c 7365 0a20 2020 2020  ms = False.     
+00033ae0: 2020 2020 2020 2065 6e65 7267 795f 6b65         energy_ke
+00033af0: 7920 3d20 4e6f 6e65 0a20 2020 2020 2020  y = None.       
+00033b00: 2065 6c69 6620 616c 6c28 5b6c 6f5f 656e   elif all([lo_en
+00033b10: 2069 7320 6e6f 7420 4e6f 6e65 2c20 6869   is not None, hi
+00033b20: 5f65 6e20 6973 206e 6f74 204e 6f6e 655d  _en is not None]
+00033b30: 293a 0a20 2020 2020 2020 2020 2020 2077  ):.            w
+00033b40: 6974 685f 6c69 6d73 203d 2054 7275 650a  ith_lims = True.
+00033b50: 2020 2020 2020 2020 2020 2020 2320 5765              # We
+00033b60: 2068 6176 6520 656e 6572 6779 206c 696d   have energy lim
+00033b70: 6974 7320 6865 7265 2073 6f20 7765 2061  its here so we a
+00033b80: 7373 656d 626c 6520 7468 6520 6b65 7920  ssemble the key 
+00033b90: 7468 6174 2064 6573 6372 6962 6573 2074  that describes t
+00033ba0: 6865 2065 6e65 7267 7920 7261 6e67 650a  he energy range.
+00033bb0: 2020 2020 2020 2020 2020 2020 656e 6572              ener
+00033bc0: 6779 5f6b 6579 203d 2022 626f 756e 645f  gy_key = "bound_
+00033bd0: 7b6c 7d2d 7b68 7d22 2e66 6f72 6d61 7428  {l}-{h}".format(
+00033be0: 6c3d 6c6f 5f65 6e2e 746f 2827 6b65 5627  l=lo_en.to('keV'
+00033bf0: 292e 7661 6c75 652c 2068 3d68 695f 656e  ).value, h=hi_en
+00033c00: 2e74 6f28 276b 6556 2729 2e76 616c 7565  .to('keV').value
+00033c10: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+00033c20: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00033c30: 6520 5661 6c75 6545 7272 6f72 2822 6c6f  e ValueError("lo
+00033c40: 5f65 6e20 616e 6420 6869 5f65 6e20 6d75  _en and hi_en mu
+00033c50: 7374 2062 6520 6569 7468 6572 2042 4f54  st be either BOT
+00033c60: 4820 4e6f 6e65 206f 7220 424f 5448 2061  H None or BOTH a
+00033c70: 6e20 4173 7472 6f70 7920 7175 616e 7469  n Astropy quanti
+00033c80: 7479 2e22 290a 0a20 2020 2020 2020 2023  ty.")..        #
+00033c90: 2049 6620 7765 2061 7265 206c 6f6f 6b69   If we are looki
+00033ca0: 6e67 2066 6f72 2061 2050 5346 2063 6f72  ng for a PSF cor
+00033cb0: 7265 6374 6564 2072 6174 656d 6170 2074  rected ratemap t
+00033cc0: 6865 6e20 7765 2061 7373 656d 626c 6520  hen we assemble 
+00033cd0: 7468 6520 6578 7472 6120 6b65 7920 7769  the extra key wi
+00033ce0: 7468 2050 5346 2064 6574 6169 6c73 0a20  th PSF details. 
+00033cf0: 2020 2020 2020 2069 6620 7073 665f 636f         if psf_co
+00033d00: 7272 3a0a 2020 2020 2020 2020 2020 2020  rr:.            
+00033d10: 6578 7472 615f 6b65 7920 3d20 225f 2220  extra_key = "_" 
+00033d20: 2b20 7073 665f 6d6f 6465 6c20 2b20 225f  + psf_model + "_
+00033d30: 2220 2b20 7374 7228 7073 665f 6269 6e73  " + str(psf_bins
+00033d40: 2920 2b20 225f 2220 2b20 7073 665f 616c  ) + "_" + psf_al
+00033d50: 676f 202b 2073 7472 2870 7366 5f69 7465  go + str(psf_ite
+00033d60: 7229 0a0a 2020 2020 2020 2020 6966 206e  r)..        if n
+00033d70: 6f74 2070 7366 5f63 6f72 7220 616e 6420  ot psf_corr and 
+00033d80: 7769 7468 5f6c 696d 733a 0a20 2020 2020  with_lims:.     
+00033d90: 2020 2020 2020 2023 2053 696d 706c 6573         # Simples
+00033da0: 7420 6361 7365 2c20 6a75 7374 2063 616c  t case, just cal
+00033db0: 6c69 6e67 2067 6574 5f70 726f 6475 6374  ling get_product
+00033dc0: 7320 616e 6420 7061 7373 696e 6720 696e  s and passing in
+00033dd0: 206f 7572 2069 6e66 6f72 6d61 7469 6f6e   our information
+00033de0: 0a20 2020 2020 2020 2020 2020 206d 6174  .            mat
+00033df0: 6368 6564 5f70 726f 6473 203d 2073 656c  ched_prods = sel
+00033e00: 662e 6765 745f 7072 6f64 7563 7473 2827  f.get_products('
+00033e10: 636f 6d62 696e 6564 5f72 6174 656d 6170  combined_ratemap
+00033e20: 272c 2065 7874 7261 5f6b 6579 3d65 6e65  ', extra_key=ene
+00033e30: 7267 795f 6b65 7929 0a20 2020 2020 2020  rgy_key).       
+00033e40: 2065 6c69 6620 6e6f 7420 7073 665f 636f   elif not psf_co
+00033e50: 7272 2061 6e64 206e 6f74 2077 6974 685f  rr and not with_
+00033e60: 6c69 6d73 3a0a 2020 2020 2020 2020 2020  lims:.          
+00033e70: 2020 6272 6f61 645f 6d61 7463 6865 7320    broad_matches 
+00033e80: 3d20 7365 6c66 2e67 6574 5f70 726f 6475  = self.get_produ
+00033e90: 6374 7328 2263 6f6d 6269 6e65 645f 7261  cts("combined_ra
+00033ea0: 7465 6d61 7022 290a 2020 2020 2020 2020  temap").        
+00033eb0: 2020 2020 6d61 7463 6865 645f 7072 6f64      matched_prod
+00033ec0: 7320 3d20 5b70 2066 6f72 2070 2069 6e20  s = [p for p in 
+00033ed0: 6272 6f61 645f 6d61 7463 6865 7320 6966  broad_matches if
+00033ee0: 206e 6f74 2070 2e70 7366 5f63 6f72 7265   not p.psf_corre
+00033ef0: 6374 6564 5d0a 2020 2020 2020 2020 656c  cted].        el
+00033f00: 6966 2070 7366 5f63 6f72 7220 616e 6420  if psf_corr and 
+00033f10: 7769 7468 5f6c 696d 733a 0a20 2020 2020  with_lims:.     
+00033f20: 2020 2020 2020 2023 2048 6572 6520 7765         # Here we
+00033f30: 206e 6565 6420 746f 2061 6464 2074 6865   need to add the
+00033f40: 2065 7874 7261 206b 6579 2074 6f20 7468   extra key to th
+00033f50: 6520 656e 6572 6779 206b 6579 0a20 2020  e energy key.   
+00033f60: 2020 2020 2020 2020 206d 6174 6368 6564           matched
+00033f70: 5f70 726f 6473 203d 2073 656c 662e 6765  _prods = self.ge
+00033f80: 745f 7072 6f64 7563 7473 2827 636f 6d62  t_products('comb
+00033f90: 696e 6564 5f72 6174 656d 6170 272c 2065  ined_ratemap', e
+00033fa0: 7874 7261 5f6b 6579 3d65 6e65 7267 795f  xtra_key=energy_
+00033fb0: 6b65 7920 2b20 6578 7472 615f 6b65 7929  key + extra_key)
+00033fc0: 0a20 2020 2020 2020 2065 6c69 6620 7073  .        elif ps
+00033fd0: 665f 636f 7272 2061 6e64 206e 6f74 2077  f_corr and not w
+00033fe0: 6974 685f 6c69 6d73 3a0a 2020 2020 2020  ith_lims:.      
+00033ff0: 2020 2020 2020 2320 4865 7265 2077 6520        # Here we 
+00034000: 646f 6e27 7420 6b6e 6f77 2074 6865 2065  don't know the e
+00034010: 6e65 7267 7920 6b65 792c 2073 6f20 7765  nergy key, so we
+00034020: 2068 6176 6520 746f 206c 6f6f 6b20 666f   have to look fo
+00034030: 7220 7061 7274 6961 6c20 6d61 7463 6865  r partial matche
+00034040: 7320 696e 2074 6865 2067 6574 5f70 726f  s in the get_pro
+00034050: 6475 6374 7320 7265 7475 726e 0a20 2020  ducts return.   
+00034060: 2020 2020 2020 2020 2062 726f 6164 5f6d           broad_m
+00034070: 6174 6368 6573 203d 2073 656c 662e 6765  atches = self.ge
+00034080: 745f 7072 6f64 7563 7473 2827 636f 6d62  t_products('comb
+00034090: 696e 6564 5f72 6174 656d 6170 272c 2065  ined_ratemap', e
+000340a0: 7874 7261 5f6b 6579 3d4e 6f6e 652c 206a  xtra_key=None, j
+000340b0: 7573 745f 6f62 6a3d 4661 6c73 6529 0a20  ust_obj=False). 
+000340c0: 2020 2020 2020 2020 2020 206d 6174 6368             match
+000340d0: 6564 5f70 726f 6473 203d 205b 705b 2d31  ed_prods = [p[-1
+000340e0: 5d20 666f 7220 7020 696e 2062 726f 6164  ] for p in broad
+000340f0: 5f6d 6174 6368 6573 2069 6620 6578 7472  _matches if extr
+00034100: 615f 6b65 7920 696e 2070 5b2d 325d 5d0a  a_key in p[-2]].
+00034110: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
+00034120: 6d61 7463 6865 645f 7072 6f64 7329 203d  matched_prods) =
+00034130: 3d20 313a 0a20 2020 2020 2020 2020 2020  = 1:.           
+00034140: 206d 6174 6368 6564 5f70 726f 6473 203d   matched_prods =
+00034150: 206d 6174 6368 6564 5f70 726f 6473 5b30   matched_prods[0
+00034160: 5d0a 2020 2020 2020 2020 656c 6966 206c  ].        elif l
+00034170: 656e 286d 6174 6368 6564 5f70 726f 6473  en(matched_prods
+00034180: 2920 3d3d 2030 3a0a 2020 2020 2020 2020  ) == 0:.        
+00034190: 2020 2020 7261 6973 6520 4e6f 5072 6f64      raise NoProd
+000341a0: 7563 7441 7661 696c 6162 6c65 4572 726f  uctAvailableErro
+000341b0: 7228 2243 616e 6e6f 7420 6669 6e64 2061  r("Cannot find a
+000341c0: 6e79 2063 6f6d 6269 6e65 6420 7261 7465  ny combined rate
+000341d0: 6d61 7073 206d 6174 6368 696e 6720 796f  maps matching yo
+000341e0: 7572 2069 6e70 7574 2e22 290a 0a20 2020  ur input.")..   
+000341f0: 2020 2020 2072 6574 7572 6e20 6d61 7463       return matc
+00034200: 6865 645f 7072 6f64 730a 0a20 2020 2064  hed_prods..    d
+00034210: 6566 205f 6765 745f 7072 6f66 5f70 726f  ef _get_prof_pro
+00034220: 6428 7365 6c66 2c20 7365 6172 6368 5f6b  d(self, search_k
+00034230: 6579 3a20 7374 722c 206f 6273 5f69 643a  ey: str, obs_id:
+00034240: 2073 7472 203d 204e 6f6e 652c 2069 6e73   str = None, ins
+00034250: 743a 2073 7472 203d 204e 6f6e 652c 2063  t: str = None, c
+00034260: 656e 7472 616c 5f63 6f6f 7264 3a20 5175  entral_coord: Qu
+00034270: 616e 7469 7479 203d 204e 6f6e 652c 0a20  antity = None,. 
+00034280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034290: 2020 2020 2020 7261 6469 693a 2051 7561        radii: Qua
+000342a0: 6e74 6974 7920 3d20 4e6f 6e65 2c20 6c6f  ntity = None, lo
+000342b0: 5f65 6e3a 2051 7561 6e74 6974 7920 3d20  _en: Quantity = 
+000342c0: 4e6f 6e65 2c20 6869 5f65 6e3a 2051 7561  None, hi_en: Qua
+000342d0: 6e74 6974 7920 3d20 4e6f 6e65 2920 5c0a  ntity = None) \.
+000342e0: 2020 2020 2020 2020 2020 2020 2d3e 2055              -> U
+000342f0: 6e69 6f6e 5b42 6173 6550 726f 6669 6c65  nion[BaseProfile
+00034300: 3144 2c20 4c69 7374 5b42 6173 6550 726f  1D, List[BasePro
+00034310: 6669 6c65 3144 5d5d 3a0a 2020 2020 2020  file1D]]:.      
+00034320: 2020 2222 220a 2020 2020 2020 2020 5468    """.        Th
+00034330: 6520 696e 7465 726e 616c 206d 6574 686f  e internal metho
+00034340: 6420 7768 6963 6820 6973 2074 6865 2067  d which is the g
+00034350: 7574 7320 6f66 2067 6574 5f70 726f 6669  uts of get_profi
+00034360: 6c65 7320 616e 6420 6765 745f 636f 6d62  les and get_comb
+00034370: 696e 6564 5f70 726f 6669 6c65 732e 2049  ined_profiles. I
+00034380: 7420 7061 7273 6573 2074 6865 2069 6e70  t parses the inp
+00034390: 7574 2061 6e64 0a20 2020 2020 2020 2073  ut and.        s
+000343a0: 6561 7263 6865 7320 666f 7220 6675 6c6c  earches for full
+000343b0: 2061 6e64 2070 6172 7469 616c 206d 6174   and partial mat
+000343c0: 6368 6573 2069 6e20 7468 6973 2073 6f75  ches in this sou
+000343d0: 7263 6527 7320 7072 6f64 7563 7420 7374  rce's product st
+000343e0: 6f72 6167 6520 7374 7275 6374 7572 652e  orage structure.
+000343f0: 0a0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
+00034400: 2073 7472 2073 6561 7263 685f 6b65 793a   str search_key:
+00034410: 2054 6865 2065 7861 6374 2073 6561 7263   The exact searc
+00034420: 6820 6b65 7920 7768 6963 6820 6465 6669  h key which defi
+00034430: 6e65 6420 7072 6f66 696c 6520 7479 7065  ned profile type
+00034440: 2c20 616e 6420 7768 6574 6865 7220 6974  , and whether it
+00034450: 2069 7320 636f 6d62 696e 6564 206f 7220   is combined or 
+00034460: 6e6f 742e 0a20 2020 2020 2020 203a 7061  not..        :pa
+00034470: 7261 6d20 7374 7220 6f62 735f 6964 3a20  ram str obs_id: 
+00034480: 4f70 7469 6f6e 616c 6c79 2c20 6120 7370  Optionally, a sp
+00034490: 6563 6966 6963 206f 6273 5f69 6420 746f  ecific obs_id to
+000344a0: 2073 6561 7263 6820 666f 7220 6361 6e20   search for can 
+000344b0: 6265 2073 7570 706c 6965 642e 2054 6865  be supplied. The
+000344c0: 2064 6566 6175 6c74 2069 7320 4e6f 6e65   default is None
+000344d0: 2c0a 2020 2020 2020 2020 2020 2020 7768  ,.            wh
+000344e0: 6963 6820 6d65 616e 7320 616c 6c20 7072  ich means all pr
+000344f0: 6f66 696c 6573 206d 6174 6368 696e 6720  ofiles matching 
+00034500: 7468 6520 6f74 6865 7220 6372 6974 6572  the other criter
+00034510: 6961 2077 696c 6c20 6265 2072 6574 7572  ia will be retur
+00034520: 6e65 642e 0a20 2020 2020 2020 203a 7061  ned..        :pa
+00034530: 7261 6d20 7374 7220 696e 7374 3a20 4f70  ram str inst: Op
+00034540: 7469 6f6e 616c 6c79 2c20 6120 7370 6563  tionally, a spec
+00034550: 6966 6963 2069 6e73 7472 756d 656e 7420  ific instrument 
+00034560: 746f 2073 6561 7263 6820 666f 7220 6361  to search for ca
+00034570: 6e20 6265 2073 7570 706c 6965 642e 2054  n be supplied. T
+00034580: 6865 2064 6566 6175 6c74 2069 7320 4e6f  he default is No
+00034590: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+000345a0: 7768 6963 6820 6d65 616e 7320 616c 6c20  which means all 
+000345b0: 7072 6f66 696c 6573 206d 6174 6368 696e  profiles matchin
+000345c0: 6720 7468 6520 6f74 6865 7220 6372 6974  g the other crit
+000345d0: 6572 6961 2077 696c 6c20 6265 2072 6574  eria will be ret
+000345e0: 7572 6e65 642e 0a20 2020 2020 2020 203a  urned..        :
+000345f0: 7061 7261 6d20 5175 616e 7469 7479 2063  param Quantity c
+00034600: 656e 7472 616c 5f63 6f6f 7264 3a20 5468  entral_coord: Th
+00034610: 6520 6365 6e74 7261 6c20 636f 6f72 6469  e central coordi
+00034620: 6e61 7465 206f 6620 7468 6520 7072 6f66  nate of the prof
+00034630: 696c 6520 796f 7520 7769 7368 2074 6f20  ile you wish to 
+00034640: 7265 7472 6965 7665 2c20 7468 6520 6465  retrieve, the de
+00034650: 6661 756c 740a 2020 2020 2020 2020 2020  fault.          
+00034660: 2020 6973 204e 6f6e 6520 7768 6963 6820    is None which 
+00034670: 6d65 616e 7320 7468 6520 6d65 7468 6f64  means the method
+00034680: 2077 696c 6c20 7573 6520 7468 6520 6465   will use the de
+00034690: 6661 756c 7420 636f 6f72 6469 6e61 7465  fault coordinate
+000346a0: 206f 6620 7468 6973 2073 6f75 7263 652e   of this source.
+000346b0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+000346c0: 5175 616e 7469 7479 2072 6164 6969 3a20  Quantity radii: 
+000346d0: 5468 6520 6365 6e74 7261 6c20 7261 6469  The central radi
+000346e0: 6920 6f66 2074 6865 2070 726f 6669 6c65  i of the profile
+000346f0: 2070 6f69 6e74 732c 2069 7420 6973 206e   points, it is n
+00034700: 6f74 206c 696b 656c 7920 7468 6174 2074  ot likely that t
+00034710: 6869 7320 6f70 7469 6f6e 2077 696c 6c20  his option will 
+00034720: 6265 0a20 2020 2020 2020 2020 2020 2075  be.            u
+00034730: 7365 6420 6f66 7465 6e20 6173 2079 6f75  sed often as you
+00034740: 206c 696b 656c 7920 776f 6e27 7420 6b6e   likely won't kn
+00034750: 6f77 2074 6865 2072 6164 6961 6c20 7661  ow the radial va
+00034760: 6c75 6573 2061 2070 7269 6f72 692e 0a20  lues a priori.. 
+00034770: 2020 2020 2020 203a 7061 7261 6d20 5175         :param Qu
+00034780: 616e 7469 7479 206c 6f5f 656e 3a20 5468  antity lo_en: Th
+00034790: 6520 6c6f 7765 7220 656e 6572 6779 2062  e lower energy b
+000347a0: 6f75 6e64 206f 6620 7468 6520 7072 6f66  ound of the prof
+000347b0: 696c 6520 796f 7520 7769 7368 2074 6f20  ile you wish to 
+000347c0: 7265 7472 6965 7665 2028 6966 2061 7070  retrieve (if app
+000347d0: 6c69 6361 626c 6529 2c20 6465 6661 756c  licable), defaul
+000347e0: 740a 2020 2020 2020 2020 2020 2020 6973  t.            is
+000347f0: 204e 6f6e 652c 2061 6e64 2069 6620 7468   None, and if th
+00034800: 6973 2061 7267 756d 656e 7420 6973 2070  is argument is p
+00034810: 6173 7365 6420 6869 5f65 6e20 6d75 7374  assed hi_en must
+00034820: 2062 6520 746f 6f2e 0a20 2020 2020 2020   be too..       
+00034830: 203a 7061 7261 6d20 5175 616e 7469 7479   :param Quantity
+00034840: 2068 695f 656e 3a20 5468 6520 6869 6768   hi_en: The high
+00034850: 6572 2065 6e65 7267 7920 626f 756e 6420  er energy bound 
+00034860: 6f66 2074 6865 2070 726f 6669 6c65 2079  of the profile y
+00034870: 6f75 2077 6973 6820 746f 2072 6574 7269  ou wish to retri
+00034880: 6576 6520 2869 6620 6170 706c 6963 6162  eve (if applicab
+00034890: 6c65 292c 2064 6566 6175 6c74 0a20 2020  le), default.   
+000348a0: 2020 2020 2020 2020 2069 7320 4e6f 6e65           is None
+000348b0: 2c20 616e 6420 6966 2074 6869 7320 6172  , and if this ar
+000348c0: 6775 6d65 6e74 2069 7320 7061 7373 6564  gument is passed
+000348d0: 206c 6f5f 656e 206d 7573 7420 6265 2074   lo_en must be t
+000348e0: 6f6f 2e0a 2020 2020 2020 2020 3a72 6574  oo..        :ret
+000348f0: 7572 6e3a 2041 6e20 5847 4120 7072 6f66  urn: An XGA prof
+00034900: 696c 6520 6f62 6a65 6374 2028 6966 2074  ile object (if t
+00034910: 6865 7265 2069 7320 616e 2065 7861 6374  here is an exact
+00034920: 206d 6174 6368 292c 206f 7220 6120 6c69   match), or a li
+00034930: 7374 206f 6620 5847 4120 7072 6f66 696c  st of XGA profil
+00034940: 6520 6f62 6a65 6374 7320 2869 6620 7468  e objects (if th
+00034950: 6572 650a 2020 2020 2020 2020 2020 2020  ere.            
+00034960: 7765 7265 206d 756c 7469 706c 6520 6d61  were multiple ma
+00034970: 7463 6869 6e67 2070 726f 6475 6374 7329  tching products)
+00034980: 2e0a 2020 2020 2020 2020 3a72 7479 7065  ..        :rtype
+00034990: 3a20 556e 696f 6e5b 4261 7365 5072 6f66  : Union[BaseProf
+000349a0: 696c 6531 442c 204c 6973 745b 4261 7365  ile1D, List[Base
+000349b0: 5072 6f66 696c 6531 445d 5d0a 2020 2020  Profile1D]].    
+000349c0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+000349d0: 6966 2061 6c6c 285b 6c6f 5f65 6e20 6973  if all([lo_en is
+000349e0: 204e 6f6e 652c 2068 695f 656e 2069 7320   None, hi_en is 
+000349f0: 4e6f 6e65 5d29 3a0a 2020 2020 2020 2020  None]):.        
+00034a00: 2020 2020 656e 6572 6779 5f6b 6579 203d      energy_key =
+00034a10: 2022 5f22 0a20 2020 2020 2020 2065 6c69   "_".        eli
+00034a20: 6620 616c 6c28 5b6c 6f5f 656e 2069 7320  f all([lo_en is 
+00034a30: 6e6f 7420 4e6f 6e65 2c20 6869 5f65 6e20  not None, hi_en 
+00034a40: 6973 206e 6f74 204e 6f6e 655d 293a 0a20  is not None]):. 
+00034a50: 2020 2020 2020 2020 2020 2065 6e65 7267             energ
+00034a60: 795f 6b65 7920 3d20 2262 6f75 6e64 5f7b  y_key = "bound_{
+00034a70: 6c7d 2d7b 687d 5f22 2e66 6f72 6d61 7428  l}-{h}_".format(
+00034a80: 6c3d 6c6f 5f65 6e2e 746f 2827 6b65 5627  l=lo_en.to('keV'
+00034a90: 292e 7661 6c75 652c 2068 3d68 695f 656e  ).value, h=hi_en
+00034aa0: 2e74 6f28 276b 6556 2729 2e76 616c 7565  .to('keV').value
+00034ab0: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+00034ac0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00034ad0: 6520 5661 6c75 6545 7272 6f72 2822 6c6f  e ValueError("lo
+00034ae0: 5f65 6e20 616e 6420 6869 5f65 6e20 6d75  _en and hi_en mu
+00034af0: 7374 2062 6520 6569 7468 6572 2042 4f54  st be either BOT
+00034b00: 4820 4e6f 6e65 206f 7220 424f 5448 2061  H None or BOTH a
+00034b10: 6e20 4173 7472 6f70 7920 7175 616e 7469  n Astropy quanti
+00034b20: 7479 2e22 290a 0a20 2020 2020 2020 2069  ty.")..        i
+00034b30: 6620 6365 6e74 7261 6c5f 636f 6f72 6420  f central_coord 
+00034b40: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+00034b50: 2020 2020 2063 656e 7472 616c 5f63 6f6f       central_coo
+00034b60: 7264 203d 2073 656c 662e 6465 6661 756c  rd = self.defaul
+00034b70: 745f 636f 6f72 640a 2020 2020 2020 2020  t_coord.        
+00034b80: 6365 6e5f 6368 756e 6b20 3d20 2272 617b  cen_chunk = "ra{
+00034b90: 727d 5f64 6563 7b64 7d5f 222e 666f 726d  r}_dec{d}_".form
+00034ba0: 6174 2872 3d63 656e 7472 616c 5f63 6f6f  at(r=central_coo
+00034bb0: 7264 5b30 5d2e 7661 6c75 652c 2064 3d63  rd[0].value, d=c
+00034bc0: 656e 7472 616c 5f63 6f6f 7264 5b31 5d2e  entral_coord[1].
+00034bd0: 7661 6c75 6529 0a0a 2020 2020 2020 2020  value)..        
+00034be0: 6966 2072 6164 6969 2069 7320 6e6f 7420  if radii is not 
+00034bf0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00034c00: 2020 7261 6469 6920 3d20 7365 6c66 2e63    radii = self.c
+00034c10: 6f6e 7665 7274 5f72 6164 6975 7328 7261  onvert_radius(ra
+00034c20: 6469 692c 2027 6465 6727 290a 2020 2020  dii, 'deg').    
+00034c30: 2020 2020 2020 2020 7261 645f 6368 756e          rad_chun
+00034c40: 6b20 3d20 2272 2220 2b20 225f 222e 6a6f  k = "r" + "_".jo
+00034c50: 696e 2872 6164 6969 2e76 616c 7565 2e61  in(radii.value.a
+00034c60: 7374 7970 6528 7374 7229 290a 2020 2020  stype(str)).    
+00034c70: 2020 2020 2020 2020 7261 645f 696e 666f          rad_info
+00034c80: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
+00034c90: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00034ca0: 2020 7261 645f 696e 666f 203d 2046 616c    rad_info = Fal
+00034cb0: 7365 0a0a 2020 2020 2020 2020 6272 6f61  se..        broa
+00034cc0: 645f 7072 6f64 7320 3d20 7365 6c66 2e67  d_prods = self.g
+00034cd0: 6574 5f70 726f 6475 6374 7328 7365 6172  et_products(sear
+00034ce0: 6368 5f6b 6579 2c20 6f62 735f 6964 2c20  ch_key, obs_id, 
+00034cf0: 696e 7374 2c20 6a75 7374 5f6f 626a 3d46  inst, just_obj=F
+00034d00: 616c 7365 290a 2020 2020 2020 2020 6d61  alse).        ma
+00034d10: 7463 6865 645f 7072 6f64 7320 3d20 5b5d  tched_prods = []
+00034d20: 0a20 2020 2020 2020 2066 6f72 2070 2069  .        for p i
+00034d30: 6e20 6272 6f61 645f 7072 6f64 733a 0a20  n broad_prods:. 
+00034d40: 2020 2020 2020 2020 2020 2072 6164 5f73             rad_s
+00034d50: 7472 203d 2070 5b2d 325d 2e73 706c 6974  tr = p[-2].split
+00034d60: 2822 5f73 7422 295b 305d 2e73 706c 6974  ("_st")[0].split
+00034d70: 2863 656e 5f63 6875 6e6b 295b 2d31 5d0a  (cen_chunk)[-1].
+00034d80: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00034d90: 6365 6e5f 6368 756e 6b20 696e 2070 5b2d  cen_chunk in p[-
+00034da0: 325d 2061 6e64 2065 6e65 7267 795f 6b65  2] and energy_ke
+00034db0: 7920 696e 2070 5b2d 325d 2061 6e64 2072  y in p[-2] and r
+00034dc0: 6164 5f69 6e66 6f20 616e 6420 7261 645f  ad_info and rad_
+00034dd0: 7374 7220 3d3d 2072 6164 5f63 6875 6e6b  str == rad_chunk
+00034de0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00034df0: 2020 6d61 7463 6865 645f 7072 6f64 732e    matched_prods.
+00034e00: 6170 7065 6e64 2870 5b2d 315d 290a 2020  append(p[-1]).  
+00034e10: 2020 2020 2020 2020 2020 656c 6966 2063            elif c
+00034e20: 656e 5f63 6875 6e6b 2069 6e20 705b 2d32  en_chunk in p[-2
+00034e30: 5d20 616e 6420 656e 6572 6779 5f6b 6579  ] and energy_key
+00034e40: 2069 6e20 705b 2d32 5d20 616e 6420 6e6f   in p[-2] and no
+00034e50: 7420 7261 645f 696e 666f 3a0a 2020 2020  t rad_info:.    
+00034e60: 2020 2020 2020 2020 2020 2020 6d61 7463              matc
+00034e70: 6865 645f 7072 6f64 732e 6170 7065 6e64  hed_prods.append
+00034e80: 2870 5b2d 315d 290a 0a20 2020 2020 2020  (p[-1])..       
+00034e90: 2072 6574 7572 6e20 6d61 7463 6865 645f   return matched_
+00034ea0: 7072 6f64 730a 0a20 2020 2064 6566 2067  prods..    def g
+00034eb0: 6574 5f70 726f 6669 6c65 7328 7365 6c66  et_profiles(self
+00034ec0: 2c20 7072 6f66 696c 655f 7479 7065 3a20  , profile_type: 
+00034ed0: 7374 722c 206f 6273 5f69 643a 2073 7472  str, obs_id: str
+00034ee0: 203d 204e 6f6e 652c 2069 6e73 743a 2073   = None, inst: s
+00034ef0: 7472 203d 204e 6f6e 652c 2063 656e 7472  tr = None, centr
+00034f00: 616c 5f63 6f6f 7264 3a20 5175 616e 7469  al_coord: Quanti
+00034f10: 7479 203d 204e 6f6e 652c 0a20 2020 2020  ty = None,.     
+00034f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034f30: 7261 6469 693a 2051 7561 6e74 6974 7920  radii: Quantity 
+00034f40: 3d20 4e6f 6e65 2c20 6c6f 5f65 6e3a 2051  = None, lo_en: Q
+00034f50: 7561 6e74 6974 7920 3d20 4e6f 6e65 2c20  uantity = None, 
+00034f60: 6869 5f65 6e3a 2051 7561 6e74 6974 7920  hi_en: Quantity 
+00034f70: 3d20 4e6f 6e65 2920 5c0a 2020 2020 2020  = None) \.      
+00034f80: 2020 2020 2020 2d3e 2055 6e69 6f6e 5b42        -> Union[B
+00034f90: 6173 6550 726f 6669 6c65 3144 2c20 4c69  aseProfile1D, Li
+00034fa0: 7374 5b42 6173 6550 726f 6669 6c65 3144  st[BaseProfile1D
+00034fb0: 5d5d 3a0a 2020 2020 2020 2020 2222 220a  ]]:.        """.
+00034fc0: 2020 2020 2020 2020 5468 6973 2069 7320          This is 
+00034fd0: 7468 6520 6765 6e65 7269 6320 6765 7420  the generic get 
+00034fe0: 6d65 7468 6f64 2066 6f72 2058 4741 2070  method for XGA p
+00034ff0: 726f 6669 6c65 206f 626a 6563 7473 2073  rofile objects s
+00035000: 746f 7265 6420 696e 2074 6869 7320 736f  tored in this so
+00035010: 7572 6365 2e20 596f 7520 7374 696c 6c20  urce. You still 
+00035020: 6d75 7374 2072 656d 656d 6265 720a 2020  must remember.  
+00035030: 2020 2020 2020 7468 6520 7072 6f66 696c        the profil
+00035040: 6520 7479 7065 2076 616c 7565 2074 6f20  e type value to 
+00035050: 7573 6520 6974 2c20 6275 7420 6f6e 6365  use it, but once
+00035060: 2065 6e74 6572 6564 2069 7420 7769 6c6c   entered it will
+00035070: 2072 6574 7572 6e20 6120 6c69 7374 206f   return a list o
+00035080: 6620 616c 6c20 6d61 7463 6869 6e67 2070  f all matching p
+00035090: 726f 6669 6c65 7320 286f 7220 610a 2020  rofiles (or a.  
+000350a0: 2020 2020 2020 7369 6e67 6c65 206f 626a        single obj
+000350b0: 6563 7420 6966 206f 6e6c 7920 6f6e 6520  ect if only one 
+000350c0: 6d61 7463 6820 6973 2066 6f75 6e64 292e  match is found).
+000350d0: 0a0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
+000350e0: 2073 7472 2070 726f 6669 6c65 5f74 7970   str profile_typ
+000350f0: 653a 2054 6865 2073 7472 696e 6720 7072  e: The string pr
+00035100: 6f66 696c 6520 7479 7065 206f 6620 7468  ofile type of th
+00035110: 6520 7072 6f66 696c 6528 7329 2079 6f75  e profile(s) you
+00035120: 2077 6973 6820 746f 2072 6574 7269 6576   wish to retriev
+00035130: 652e 0a20 2020 2020 2020 203a 7061 7261  e..        :para
+00035140: 6d20 7374 7220 6f62 735f 6964 3a20 4f70  m str obs_id: Op
+00035150: 7469 6f6e 616c 6c79 2c20 6120 7370 6563  tionally, a spec
+00035160: 6966 6963 206f 6273 5f69 6420 746f 2073  ific obs_id to s
+00035170: 6561 7263 6820 666f 7220 6361 6e20 6265  earch for can be
+00035180: 2073 7570 706c 6965 642e 2054 6865 2064   supplied. The d
+00035190: 6566 6175 6c74 2069 7320 4e6f 6e65 2c0a  efault is None,.
+000351a0: 2020 2020 2020 2020 2020 2020 7768 6963              whic
+000351b0: 6820 6d65 616e 7320 616c 6c20 7072 6f66  h means all prof
+000351c0: 696c 6573 206d 6174 6368 696e 6720 7468  iles matching th
+000351d0: 6520 6f74 6865 7220 6372 6974 6572 6961  e other criteria
+000351e0: 2077 696c 6c20 6265 2072 6574 7572 6e65   will be returne
+000351f0: 642e 0a20 2020 2020 2020 203a 7061 7261  d..        :para
+00035200: 6d20 7374 7220 696e 7374 3a20 4f70 7469  m str inst: Opti
+00035210: 6f6e 616c 6c79 2c20 6120 7370 6563 6966  onally, a specif
+00035220: 6963 2069 6e73 7472 756d 656e 7420 746f  ic instrument to
+00035230: 2073 6561 7263 6820 666f 7220 6361 6e20   search for can 
+00035240: 6265 2073 7570 706c 6965 642e 2054 6865  be supplied. The
+00035250: 2064 6566 6175 6c74 2069 7320 4e6f 6e65   default is None
+00035260: 2c0a 2020 2020 2020 2020 2020 2020 7768  ,.            wh
+00035270: 6963 6820 6d65 616e 7320 616c 6c20 7072  ich means all pr
+00035280: 6f66 696c 6573 206d 6174 6368 696e 6720  ofiles matching 
+00035290: 7468 6520 6f74 6865 7220 6372 6974 6572  the other criter
+000352a0: 6961 2077 696c 6c20 6265 2072 6574 7572  ia will be retur
+000352b0: 6e65 642e 0a20 2020 2020 2020 203a 7061  ned..        :pa
+000352c0: 7261 6d20 5175 616e 7469 7479 2063 656e  ram Quantity cen
+000352d0: 7472 616c 5f63 6f6f 7264 3a20 5468 6520  tral_coord: The 
+000352e0: 6365 6e74 7261 6c20 636f 6f72 6469 6e61  central coordina
+000352f0: 7465 206f 6620 7468 6520 7072 6f66 696c  te of the profil
+00035300: 6520 796f 7520 7769 7368 2074 6f20 7265  e you wish to re
+00035310: 7472 6965 7665 2c20 7468 6520 6465 6661  trieve, the defa
+00035320: 756c 740a 2020 2020 2020 2020 2020 2020  ult.            
+00035330: 6973 204e 6f6e 6520 7768 6963 6820 6d65  is None which me
+00035340: 616e 7320 7468 6520 6d65 7468 6f64 2077  ans the method w
+00035350: 696c 6c20 7573 6520 7468 6520 6465 6661  ill use the defa
+00035360: 756c 7420 636f 6f72 6469 6e61 7465 206f  ult coordinate o
+00035370: 6620 7468 6973 2073 6f75 7263 652e 0a20  f this source.. 
+00035380: 2020 2020 2020 203a 7061 7261 6d20 5175         :param Qu
+00035390: 616e 7469 7479 2072 6164 6969 3a20 5468  antity radii: Th
+000353a0: 6520 6365 6e74 7261 6c20 7261 6469 6920  e central radii 
+000353b0: 6f66 2074 6865 2070 726f 6669 6c65 2070  of the profile p
+000353c0: 6f69 6e74 732c 2069 7420 6973 206e 6f74  oints, it is not
+000353d0: 206c 696b 656c 7920 7468 6174 2074 6869   likely that thi
+000353e0: 7320 6f70 7469 6f6e 2077 696c 6c20 6265  s option will be
+000353f0: 0a20 2020 2020 2020 2020 2020 2075 7365  .            use
+00035400: 6420 6f66 7465 6e20 6173 2079 6f75 206c  d often as you l
+00035410: 696b 656c 7920 776f 6e27 7420 6b6e 6f77  ikely won't know
+00035420: 2074 6865 2072 6164 6961 6c20 7661 6c75   the radial valu
+00035430: 6573 2061 2070 7269 6f72 692e 0a20 2020  es a priori..   
+00035440: 2020 2020 203a 7061 7261 6d20 5175 616e       :param Quan
+00035450: 7469 7479 206c 6f5f 656e 3a20 5468 6520  tity lo_en: The 
+00035460: 6c6f 7765 7220 656e 6572 6779 2062 6f75  lower energy bou
+00035470: 6e64 206f 6620 7468 6520 7072 6f66 696c  nd of the profil
+00035480: 6520 796f 7520 7769 7368 2074 6f20 7265  e you wish to re
+00035490: 7472 6965 7665 2028 6966 2061 7070 6c69  trieve (if appli
+000354a0: 6361 626c 6529 2c20 6465 6661 756c 740a  cable), default.
+000354b0: 2020 2020 2020 2020 2020 2020 6973 204e              is N
+000354c0: 6f6e 652c 2061 6e64 2069 6620 7468 6973  one, and if this
+000354d0: 2061 7267 756d 656e 7420 6973 2070 6173   argument is pas
+000354e0: 7365 6420 6869 5f65 6e20 6d75 7374 2062  sed hi_en must b
+000354f0: 6520 746f 6f2e 0a20 2020 2020 2020 203a  e too..        :
+00035500: 7061 7261 6d20 5175 616e 7469 7479 2068  param Quantity h
+00035510: 695f 656e 3a20 5468 6520 6869 6768 6572  i_en: The higher
+00035520: 2065 6e65 7267 7920 626f 756e 6420 6f66   energy bound of
+00035530: 2074 6865 2070 726f 6669 6c65 2079 6f75   the profile you
+00035540: 2077 6973 6820 746f 2072 6574 7269 6576   wish to retriev
+00035550: 6520 2869 6620 6170 706c 6963 6162 6c65  e (if applicable
+00035560: 292c 2064 6566 6175 6c74 0a20 2020 2020  ), default.     
+00035570: 2020 2020 2020 2069 7320 4e6f 6e65 2c20         is None, 
+00035580: 616e 6420 6966 2074 6869 7320 6172 6775  and if this argu
+00035590: 6d65 6e74 2069 7320 7061 7373 6564 206c  ment is passed l
+000355a0: 6f5f 656e 206d 7573 7420 6265 2074 6f6f  o_en must be too
+000355b0: 2e0a 2020 2020 2020 2020 3a72 6574 7572  ..        :retur
+000355c0: 6e3a 2041 6e20 5847 4120 7072 6f66 696c  n: An XGA profil
+000355d0: 6520 6f62 6a65 6374 2028 6966 2074 6865  e object (if the
+000355e0: 7265 2069 7320 616e 2065 7861 6374 206d  re is an exact m
+000355f0: 6174 6368 292c 206f 7220 6120 6c69 7374  atch), or a list
+00035600: 206f 6620 5847 4120 7072 6f66 696c 6520   of XGA profile 
+00035610: 6f62 6a65 6374 7320 2869 6620 7468 6572  objects (if ther
+00035620: 650a 2020 2020 2020 2020 2020 2020 7765  e.            we
+00035630: 7265 206d 756c 7469 706c 6520 6d61 7463  re multiple matc
+00035640: 6869 6e67 2070 726f 6475 6374 7329 2e0a  hing products)..
+00035650: 2020 2020 2020 2020 3a72 7479 7065 3a20          :rtype: 
+00035660: 556e 696f 6e5b 4261 7365 5072 6f66 696c  Union[BaseProfil
+00035670: 6531 442c 204c 6973 745b 4261 7365 5072  e1D, List[BasePr
+00035680: 6f66 696c 6531 445d 5d0a 2020 2020 2020  ofile1D]].      
+00035690: 2020 2222 220a 2020 2020 2020 2020 6966    """.        if
+000356a0: 2022 7072 6f66 696c 6522 2069 6e20 7072   "profile" in pr
+000356b0: 6f66 696c 655f 7479 7065 3a0a 2020 2020  ofile_type:.    
+000356c0: 2020 2020 2020 2020 7761 726e 2822 5468          warn("Th
+000356d0: 6520 7072 6f66 696c 655f 7479 7065 2079  e profile_type y
+000356e0: 6f75 2070 6173 7365 6420 636f 6e74 6169  ou passed contai
+000356f0: 6e73 2074 6865 2077 6f72 6420 2770 726f  ns the word 'pro
+00035700: 6669 6c65 272c 2077 6869 6368 2069 7320  file', which is 
+00035710: 6170 7065 6e64 6564 206f 6e74 6f20 220a  appended onto ".
+00035720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035730: 2020 2020 2020 2020 2020 2261 2070 726f            "a pro
+00035740: 6669 6c65 2074 7970 6520 6279 2058 4741  file type by XGA
+00035750: 2c20 796f 7520 6e65 6564 2074 6f20 7472  , you need to tr
+00035760: 7920 7468 6973 2061 6761 696e 2077 6974  y this again wit
+00035770: 686f 7574 2070 726f 6669 6c65 206f 6e20  hout profile on 
+00035780: 7468 6520 656e 642c 2075 6e6c 6573 7322  the end, unless"
+00035790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000357a0: 2020 2020 2020 2020 2020 2022 2079 6f75             " you
+000357b0: 2067 6176 6520 6120 6765 6e65 7269 6320   gave a generic 
+000357c0: 7072 6f66 696c 6520 6120 7479 7065 2077  profile a type w
+000357d0: 6974 6820 2770 726f 6669 6c65 2720 696e  ith 'profile' in
+000357e0: 2e22 2c20 7374 6163 6b6c 6576 656c 3d32  .", stacklevel=2
+000357f0: 290a 0a20 2020 2020 2020 2073 6561 7263  )..        searc
+00035800: 685f 6b65 7920 3d20 7072 6f66 696c 655f  h_key = profile_
+00035810: 7479 7065 202b 2022 5f70 726f 6669 6c65  type + "_profile
+00035820: 220a 2020 2020 2020 2020 6966 2061 6c6c  ".        if all
+00035830: 285b 6f62 735f 6964 2069 7320 4e6f 6e65  ([obs_id is None
+00035840: 2c20 696e 7374 2069 7320 4e6f 6e65 5d29  , inst is None])
+00035850: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00035860: 6172 6368 5f6b 6579 203d 2022 636f 6d62  arch_key = "comb
+00035870: 696e 6564 5f22 202b 2073 6561 7263 685f  ined_" + search_
+00035880: 6b65 790a 0a20 2020 2020 2020 2073 6561  key..        sea
+00035890: 7263 685f 6b65 7920 3d20 7072 6f66 696c  rch_key = profil
+000358a0: 655f 7479 7065 202b 2022 5f70 726f 6669  e_type + "_profi
+000358b0: 6c65 220a 2020 2020 2020 2020 6966 2073  le".        if s
+000358c0: 6561 7263 685f 6b65 7920 6e6f 7420 696e  earch_key not in
+000358d0: 2041 4c4c 4f57 4544 5f50 524f 4455 4354   ALLOWED_PRODUCT
+000358e0: 533a 0a20 2020 2020 2020 2020 2020 2077  S:.            w
+000358f0: 6172 6e28 227b 7d20 7365 656d 7320 746f  arn("{} seems to
+00035900: 2062 6520 6120 6375 7374 6f6d 2070 726f   be a custom pro
+00035910: 6669 6c65 2c20 6e6f 7420 616e 2058 4741  file, not an XGA
+00035920: 2064 6566 6175 6c74 2074 7970 652e 2049   default type. I
+00035930: 6620 7468 6973 2069 7320 6e6f 7420 220a  f this is not ".
+00035940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035950: 2020 2020 2020 2020 2020 2274 7275 6520            "true 
+00035960: 7468 656e 2079 6f75 2068 6176 6520 7061  then you have pa
+00035970: 7373 6564 2061 6e20 696e 7661 6c69 6420  ssed an invalid 
+00035980: 7072 6f66 696c 6520 7479 7065 2e22 2e66  profile type.".f
+00035990: 6f72 6d61 7428 7365 6172 6368 5f6b 6579  ormat(search_key
+000359a0: 292c 2073 7461 636b 6c65 7665 6c3d 3229  ), stacklevel=2)
+000359b0: 0a0a 2020 2020 2020 2020 6d61 7463 6865  ..        matche
+000359c0: 645f 7072 6f64 7320 3d20 7365 6c66 2e5f  d_prods = self._
+000359d0: 6765 745f 7072 6f66 5f70 726f 6428 7365  get_prof_prod(se
+000359e0: 6172 6368 5f6b 6579 2c20 6f62 735f 6964  arch_key, obs_id
+000359f0: 2c20 696e 7374 2c20 6365 6e74 7261 6c5f  , inst, central_
+00035a00: 636f 6f72 642c 2072 6164 6969 2c20 6c6f  coord, radii, lo
+00035a10: 5f65 6e2c 2068 695f 656e 290a 2020 2020  _en, hi_en).    
+00035a20: 2020 2020 6966 206c 656e 286d 6174 6368      if len(match
+00035a30: 6564 5f70 726f 6473 2920 3d3d 2031 3a0a  ed_prods) == 1:.
+00035a40: 2020 2020 2020 2020 2020 2020 6d61 7463              matc
+00035a50: 6865 645f 7072 6f64 7320 3d20 6d61 7463  hed_prods = matc
+00035a60: 6865 645f 7072 6f64 735b 305d 0a20 2020  hed_prods[0].   
+00035a70: 2020 2020 2065 6c69 6620 6c65 6e28 6d61       elif len(ma
+00035a80: 7463 6865 645f 7072 6f64 7329 203d 3d20  tched_prods) == 
+00035a90: 303a 0a20 2020 2020 2020 2020 2020 2072  0:.            r
+00035aa0: 6169 7365 204e 6f50 726f 6475 6374 4176  aise NoProductAv
+00035ab0: 6169 6c61 626c 6545 7272 6f72 2822 4361  ailableError("Ca
+00035ac0: 6e6e 6f74 2066 696e 6420 616e 7920 7b70  nnot find any {p
+00035ad0: 7d20 7072 6f66 696c 6573 206d 6174 6368  } profiles match
+00035ae0: 696e 6720 796f 7572 2069 6e70 7574 2e22  ing your input."
+00035af0: 2e66 6f72 6d61 7428 703d 7072 6f66 696c  .format(p=profil
+00035b00: 655f 7479 7065 2929 0a0a 2020 2020 2020  e_type))..      
+00035b10: 2020 7265 7475 726e 206d 6174 6368 6564    return matched
+00035b20: 5f70 726f 6473 0a0a 2020 2020 6465 6620  _prods..    def 
+00035b30: 6765 745f 636f 6d62 696e 6564 5f70 726f  get_combined_pro
+00035b40: 6669 6c65 7328 7365 6c66 2c20 7072 6f66  files(self, prof
+00035b50: 696c 655f 7479 7065 3a20 7374 722c 2063  ile_type: str, c
+00035b60: 656e 7472 616c 5f63 6f6f 7264 3a20 5175  entral_coord: Qu
+00035b70: 616e 7469 7479 203d 204e 6f6e 652c 2072  antity = None, r
+00035b80: 6164 6969 3a20 5175 616e 7469 7479 203d  adii: Quantity =
+00035b90: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
+00035ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035bb0: 2020 2020 206c 6f5f 656e 3a20 5175 616e       lo_en: Quan
+00035bc0: 7469 7479 203d 204e 6f6e 652c 2068 695f  tity = None, hi_
+00035bd0: 656e 3a20 5175 616e 7469 7479 203d 204e  en: Quantity = N
+00035be0: 6f6e 6529 205c 0a20 2020 2020 2020 2020  one) \.         
+00035bf0: 2020 202d 3e20 556e 696f 6e5b 4261 7365     -> Union[Base
+00035c00: 5072 6f66 696c 6531 442c 204c 6973 745b  Profile1D, List[
+00035c10: 4261 7365 5072 6f66 696c 6531 445d 5d3a  BaseProfile1D]]:
+00035c20: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00035c30: 2020 2020 2054 6865 2067 656e 6572 6963       The generic
+00035c40: 2067 6574 206d 6574 686f 6420 666f 7220   get method for 
+00035c50: 5847 4120 7072 6f66 696c 6573 206d 6164  XGA profiles mad
+00035c60: 6520 7573 696e 6720 616c 6c20 6176 6169  e using all avai
+00035c70: 6c61 626c 6520 6461 7461 2077 6869 6368  lable data which
+00035c80: 2061 7265 2073 746f 7265 6420 696e 2074   are stored in t
+00035c90: 6869 7320 736f 7572 6365 2e0a 2020 2020  his source..    
+00035ca0: 2020 2020 596f 7520 7374 696c 6c20 6d75      You still mu
+00035cb0: 7374 2072 656d 656d 6265 7220 7468 6520  st remember the 
+00035cc0: 7072 6f66 696c 6520 7479 7065 2076 616c  profile type val
+00035cd0: 7565 2074 6f20 7573 6520 6974 2c20 6275  ue to use it, bu
+00035ce0: 7420 6f6e 6365 2065 6e74 6572 6564 2069  t once entered i
+00035cf0: 7420 7769 6c6c 2072 6574 7572 6e20 6120  t will return a 
+00035d00: 6c69 7374 0a20 2020 2020 2020 206f 6620  list.        of 
+00035d10: 616c 6c20 6d61 7463 6869 6e67 2070 726f  all matching pro
+00035d20: 6669 6c65 7320 286f 7220 6120 7369 6e67  files (or a sing
+00035d30: 6c65 206f 626a 6563 7420 6966 206f 6e6c  le object if onl
+00035d40: 7920 6f6e 6520 6d61 7463 6820 6973 2066  y one match is f
+00035d50: 6f75 6e64 292e 0a0a 2020 2020 2020 2020  ound)...        
+00035d60: 3a70 6172 616d 2073 7472 2070 726f 6669  :param str profi
+00035d70: 6c65 5f74 7970 653a 2054 6865 2073 7472  le_type: The str
+00035d80: 696e 6720 7072 6f66 696c 6520 7479 7065  ing profile type
+00035d90: 206f 6620 7468 6520 7072 6f66 696c 6528   of the profile(
+00035da0: 7329 2079 6f75 2077 6973 6820 746f 2072  s) you wish to r
+00035db0: 6574 7269 6576 652e 0a20 2020 2020 2020  etrieve..       
+00035dc0: 203a 7061 7261 6d20 5175 616e 7469 7479   :param Quantity
+00035dd0: 2063 656e 7472 616c 5f63 6f6f 7264 3a20   central_coord: 
+00035de0: 5468 6520 6365 6e74 7261 6c20 636f 6f72  The central coor
+00035df0: 6469 6e61 7465 206f 6620 7468 6520 7072  dinate of the pr
+00035e00: 6f66 696c 6520 796f 7520 7769 7368 2074  ofile you wish t
+00035e10: 6f20 7265 7472 6965 7665 2c20 7468 6520  o retrieve, the 
+00035e20: 6465 6661 756c 740a 2020 2020 2020 2020  default.        
+00035e30: 2020 2020 6973 204e 6f6e 6520 7768 6963      is None whic
+00035e40: 6820 6d65 616e 7320 7468 6520 6d65 7468  h means the meth
+00035e50: 6f64 2077 696c 6c20 7573 6520 7468 6520  od will use the 
+00035e60: 6465 6661 756c 7420 636f 6f72 6469 6e61  default coordina
+00035e70: 7465 206f 6620 7468 6973 2073 6f75 7263  te of this sourc
+00035e80: 652e 0a20 2020 2020 2020 203a 7061 7261  e..        :para
+00035e90: 6d20 5175 616e 7469 7479 2072 6164 6969  m Quantity radii
+00035ea0: 3a20 5468 6520 6365 6e74 7261 6c20 7261  : The central ra
+00035eb0: 6469 6920 6f66 2074 6865 2070 726f 6669  dii of the profi
+00035ec0: 6c65 2070 6f69 6e74 732c 2069 7420 6973  le points, it is
+00035ed0: 206e 6f74 206c 696b 656c 7920 7468 6174   not likely that
+00035ee0: 2074 6869 7320 6f70 7469 6f6e 2077 696c   this option wil
+00035ef0: 6c20 6265 0a20 2020 2020 2020 2020 2020  l be.           
+00035f00: 2075 7365 6420 6f66 7465 6e20 6173 2079   used often as y
+00035f10: 6f75 206c 696b 656c 7920 776f 6e27 7420  ou likely won't 
+00035f20: 6b6e 6f77 2074 6865 2072 6164 6961 6c20  know the radial 
+00035f30: 7661 6c75 6573 2061 2070 7269 6f72 692e  values a priori.
+00035f40: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+00035f50: 5175 616e 7469 7479 206c 6f5f 656e 3a20  Quantity lo_en: 
+00035f60: 5468 6520 6c6f 7765 7220 656e 6572 6779  The lower energy
+00035f70: 2062 6f75 6e64 206f 6620 7468 6520 7072   bound of the pr
+00035f80: 6f66 696c 6520 796f 7520 7769 7368 2074  ofile you wish t
+00035f90: 6f20 7265 7472 6965 7665 2028 6966 2061  o retrieve (if a
+00035fa0: 7070 6c69 6361 626c 6529 2c20 6465 6661  pplicable), defa
+00035fb0: 756c 740a 2020 2020 2020 2020 2020 2020  ult.            
+00035fc0: 6973 204e 6f6e 652c 2061 6e64 2069 6620  is None, and if 
+00035fd0: 7468 6973 2061 7267 756d 656e 7420 6973  this argument is
+00035fe0: 2070 6173 7365 6420 6869 5f65 6e20 6d75   passed hi_en mu
+00035ff0: 7374 2062 6520 746f 6f2e 0a20 2020 2020  st be too..     
+00036000: 2020 203a 7061 7261 6d20 5175 616e 7469     :param Quanti
+00036010: 7479 2068 695f 656e 3a20 5468 6520 6869  ty hi_en: The hi
+00036020: 6768 6572 2065 6e65 7267 7920 626f 756e  gher energy boun
+00036030: 6420 6f66 2074 6865 2070 726f 6669 6c65  d of the profile
+00036040: 2079 6f75 2077 6973 6820 746f 2072 6574   you wish to ret
+00036050: 7269 6576 6520 2869 6620 6170 706c 6963  rieve (if applic
+00036060: 6162 6c65 292c 2064 6566 6175 6c74 0a20  able), default. 
+00036070: 2020 2020 2020 2020 2020 2069 7320 4e6f             is No
+00036080: 6e65 2c20 616e 6420 6966 2074 6869 7320  ne, and if this 
+00036090: 6172 6775 6d65 6e74 2069 7320 7061 7373  argument is pass
+000360a0: 6564 206c 6f5f 656e 206d 7573 7420 6265  ed lo_en must be
+000360b0: 2074 6f6f 2e0a 2020 2020 2020 2020 3a72   too..        :r
+000360c0: 6574 7572 6e3a 2041 6e20 5847 4120 7072  eturn: An XGA pr
+000360d0: 6f66 696c 6520 6f62 6a65 6374 2028 6966  ofile object (if
+000360e0: 2074 6865 7265 2069 7320 616e 2065 7861   there is an exa
+000360f0: 6374 206d 6174 6368 292c 206f 7220 6120  ct match), or a 
+00036100: 6c69 7374 206f 6620 5847 4120 7072 6f66  list of XGA prof
+00036110: 696c 6520 6f62 6a65 6374 7320 2869 6620  ile objects (if 
+00036120: 7468 6572 650a 2020 2020 2020 2020 2020  there.          
+00036130: 2020 7765 7265 206d 756c 7469 706c 6520    were multiple 
+00036140: 6d61 7463 6869 6e67 2070 726f 6475 6374  matching product
+00036150: 7329 2e0a 2020 2020 2020 2020 3a72 7479  s)..        :rty
+00036160: 7065 3a20 556e 696f 6e5b 4261 7365 5072  pe: Union[BasePr
+00036170: 6f66 696c 6531 442c 204c 6973 745b 4261  ofile1D, List[Ba
+00036180: 7365 5072 6f66 696c 6531 445d 5d0a 2020  seProfile1D]].  
+00036190: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+000361a0: 2020 6966 2022 7072 6f66 696c 6522 2069    if "profile" i
+000361b0: 6e20 7072 6f66 696c 655f 7479 7065 3a0a  n profile_type:.
+000361c0: 2020 2020 2020 2020 2020 2020 7761 726e              warn
+000361d0: 2822 5468 6520 7072 6f66 696c 655f 7479  ("The profile_ty
+000361e0: 7065 2079 6f75 2070 6173 7365 6420 636f  pe you passed co
+000361f0: 6e74 6169 6e73 2074 6865 2077 6f72 6420  ntains the word 
+00036200: 2770 726f 6669 6c65 272c 2077 6869 6368  'profile', which
+00036210: 2069 7320 6170 7065 6e64 6564 206f 6e74   is appended ont
+00036220: 6f20 220a 2020 2020 2020 2020 2020 2020  o ".            
+00036230: 2020 2020 2020 2020 2020 2020 2020 2261                "a
+00036240: 2070 726f 6669 6c65 2074 7970 6520 6279   profile type by
+00036250: 2058 4741 2c20 796f 7520 6e65 6564 2074   XGA, you need t
+00036260: 6f20 7472 7920 7468 6973 2061 6761 696e  o try this again
+00036270: 2077 6974 686f 7574 2070 726f 6669 6c65   without profile
+00036280: 206f 6e20 7468 6520 656e 642c 2075 6e6c   on the end, unl
+00036290: 6573 7322 0a20 2020 2020 2020 2020 2020  ess".           
+000362a0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+000362b0: 2079 6f75 2067 6176 6520 6120 6765 6e65   you gave a gene
+000362c0: 7269 6320 7072 6f66 696c 6520 6120 7479  ric profile a ty
+000362d0: 7065 2077 6974 6820 2770 726f 6669 6c65  pe with 'profile
+000362e0: 2720 696e 2e22 2c20 7374 6163 6b6c 6576  ' in.", stacklev
+000362f0: 656c 3d32 290a 0a20 2020 2020 2020 2073  el=2)..        s
+00036300: 6561 7263 685f 6b65 7920 3d20 2263 6f6d  earch_key = "com
+00036310: 6269 6e65 645f 2220 2b20 7072 6f66 696c  bined_" + profil
+00036320: 655f 7479 7065 202b 2022 5f70 726f 6669  e_type + "_profi
+00036330: 6c65 220a 0a20 2020 2020 2020 2069 6620  le"..        if 
+00036340: 7365 6172 6368 5f6b 6579 206e 6f74 2069  search_key not i
+00036350: 6e20 414c 4c4f 5745 445f 5052 4f44 5543  n ALLOWED_PRODUC
+00036360: 5453 3a0a 2020 2020 2020 2020 2020 2020  TS:.            
+00036370: 7761 726e 2822 5468 6174 2070 726f 6669  warn("That profi
+00036380: 6c65 2074 7970 6520 7365 656d 7320 746f  le type seems to
+00036390: 2062 6520 6120 6375 7374 6f6d 2070 726f   be a custom pro
+000363a0: 6669 6c65 2c20 6e6f 7420 616e 2058 4741  file, not an XGA
+000363b0: 2064 6566 6175 6c74 2074 7970 652e 2049   default type. I
+000363c0: 6620 7468 6973 2069 7320 6e6f 7420 220a  f this is not ".
+000363d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000363e0: 2020 2020 2020 2020 2020 2274 7275 6520            "true 
+000363f0: 7468 656e 2079 6f75 2068 6176 6520 7061  then you have pa
+00036400: 7373 6564 2061 6e20 696e 7661 6c69 6420  ssed an invalid 
+00036410: 7072 6f66 696c 6520 7479 7065 2e22 2c20  profile type.", 
+00036420: 7374 6163 6b6c 6576 656c 3d32 290a 0a20  stacklevel=2).. 
+00036430: 2020 2020 2020 206d 6174 6368 6564 5f70         matched_p
+00036440: 726f 6473 203d 2073 656c 662e 5f67 6574  rods = self._get
+00036450: 5f70 726f 665f 7072 6f64 2873 6561 7263  _prof_prod(searc
+00036460: 685f 6b65 792c 204e 6f6e 652c 204e 6f6e  h_key, None, Non
+00036470: 652c 2063 656e 7472 616c 5f63 6f6f 7264  e, central_coord
+00036480: 2c20 7261 6469 692c 206c 6f5f 656e 2c20  , radii, lo_en, 
+00036490: 6869 5f65 6e29 0a20 2020 2020 2020 2069  hi_en).        i
+000364a0: 6620 6c65 6e28 6d61 7463 6865 645f 7072  f len(matched_pr
+000364b0: 6f64 7329 203d 3d20 313a 0a20 2020 2020  ods) == 1:.     
+000364c0: 2020 2020 2020 206d 6174 6368 6564 5f70         matched_p
+000364d0: 726f 6473 203d 206d 6174 6368 6564 5f70  rods = matched_p
+000364e0: 726f 6473 5b30 5d0a 2020 2020 2020 2020  rods[0].        
+000364f0: 656c 6966 206c 656e 286d 6174 6368 6564  elif len(matched
+00036500: 5f70 726f 6473 2920 3d3d 2030 3a0a 2020  _prods) == 0:.  
+00036510: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00036520: 4e6f 5072 6f64 7563 7441 7661 696c 6162  NoProductAvailab
+00036530: 6c65 4572 726f 7228 2243 616e 6e6f 7420  leError("Cannot 
+00036540: 6669 6e64 2061 6e79 2063 6f6d 6269 6e65  find any combine
+00036550: 6420 7b70 7d20 7072 6f66 696c 6573 206d  d {p} profiles m
+00036560: 6174 6368 696e 6720 796f 7572 2022 0a20  atching your ". 
+00036570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036590: 2020 2020 2020 2020 2022 696e 7075 742e           "input.
+000365a0: 222e 666f 726d 6174 2870 3d70 726f 6669  ".format(p=profi
+000365b0: 6c65 5f74 7970 6529 290a 0a20 2020 2020  le_type))..     
+000365c0: 2020 2072 6574 7572 6e20 6d61 7463 6865     return matche
+000365d0: 645f 7072 6f64 730a 0a20 2020 2040 7072  d_prods..    @pr
+000365e0: 6f70 6572 7479 0a20 2020 2064 6566 2066  operty.    def f
+000365f0: 6974 7465 645f 6d6f 6465 6c73 2873 656c  itted_models(sel
+00036600: 6629 202d 3e20 4c69 7374 5b73 7472 5d3a  f) -> List[str]:
+00036610: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00036620: 2020 2020 2054 6869 7320 7072 6f70 6572       This proper
+00036630: 7479 2063 7963 6c65 7320 7468 726f 7567  ty cycles throug
+00036640: 6820 616c 6c20 7468 6520 6176 6169 6c61  h all the availa
+00036650: 626c 6520 6669 7420 7265 7375 6c74 732c  ble fit results,
+00036660: 2061 6e64 2066 696e 6473 2074 6865 2075   and finds the u
+00036670: 6e69 7175 6520 6e61 6d65 7320 6f66 2058  nique names of X
+00036680: 5350 4543 206d 6f64 656c 730a 2020 2020  SPEC models.    
+00036690: 2020 2020 7468 6174 2068 6176 6520 6265      that have be
+000366a0: 656e 2066 6974 7465 6420 746f 2074 6869  en fitted to thi
+000366b0: 7320 736f 7572 6365 2e0a 0a20 2020 2020  s source...     
+000366c0: 2020 203a 7265 7475 726e 3a20 4120 6c69     :return: A li
+000366d0: 7374 206f 6620 6d6f 6465 6c20 6e61 6d65  st of model name
+000366e0: 732e 0a20 2020 2020 2020 203a 7274 7970  s..        :rtyp
+000366f0: 653a 204c 6973 745b 7374 725d 0a20 2020  e: List[str].   
+00036700: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00036710: 206d 6f64 656c 7320 3d20 5b5d 0a20 2020   models = [].   
+00036720: 2020 2020 2066 6f72 2073 5f6b 6579 2069       for s_key i
+00036730: 6e20 7365 6c66 2e5f 6669 745f 7265 7375  n self._fit_resu
+00036740: 6c74 733a 0a20 2020 2020 2020 2020 2020  lts:.           
+00036750: 206d 6f64 656c 7320 2b3d 206c 6973 7428   models += list(
+00036760: 7365 6c66 2e5f 6669 745f 7265 7375 6c74  self._fit_result
+00036770: 735b 735f 6b65 795d 2e6b 6579 7328 2929  s[s_key].keys())
+00036780: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+00036790: 206d 6f64 656c 730a 0a20 2020 2064 6566   models..    def
+000367a0: 2073 6e72 5f72 616e 6b69 6e67 2873 656c   snr_ranking(sel
+000367b0: 662c 206f 7574 6572 5f72 6164 6975 733a  f, outer_radius:
+000367c0: 2055 6e69 6f6e 5b51 7561 6e74 6974 792c   Union[Quantity,
+000367d0: 2073 7472 5d2c 206c 6f5f 656e 3a20 5175   str], lo_en: Qu
+000367e0: 616e 7469 7479 203d 204e 6f6e 652c 2068  antity = None, h
+000367f0: 695f 656e 3a20 5175 616e 7469 7479 203d  i_en: Quantity =
+00036800: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
+00036810: 2020 2020 2020 2020 2020 2061 6c6c 6f77             allow
+00036820: 5f6e 6567 6174 6976 653a 2062 6f6f 6c20  _negative: bool 
+00036830: 3d20 4661 6c73 6529 202d 3e20 5475 706c  = False) -> Tupl
+00036840: 655b 6e70 2e6e 6461 7272 6179 2c20 6e70  e[np.ndarray, np
+00036850: 2e6e 6461 7272 6179 5d3a 0a20 2020 2020  .ndarray]:.     
+00036860: 2020 2022 2222 0a20 2020 2020 2020 2054     """.        T
+00036870: 6869 7320 6d65 7468 6f64 2067 656e 6572  his method gener
+00036880: 6174 6573 2061 206c 6973 7420 6f66 204f  ates a list of O
+00036890: 6273 4944 2d49 6e73 7472 756d 656e 7420  bsID-Instrument 
+000368a0: 7061 6972 732c 206f 7264 6572 6564 2062  pairs, ordered b
+000368b0: 7920 7468 6520 7369 676e 616c 2074 6f20  y the signal to 
+000368c0: 6e6f 6973 6520 6d65 6173 7572 6564 2066  noise measured f
+000368d0: 6f72 2074 6865 0a20 2020 2020 2020 2067  or the.        g
+000368e0: 6976 656e 2072 6567 696f 6e2c 2077 6974  iven region, wit
+000368f0: 6820 656c 656d 656e 7420 7a65 726f 2062  h element zero b
+00036900: 6569 6e67 2074 6865 206c 6f77 6573 7420  eing the lowest 
+00036910: 534e 522c 2061 6e64 2065 6c65 6d65 6e74  SNR, and element
+00036920: 204e 2062 6569 6e67 2074 6865 2068 6967   N being the hig
+00036930: 6865 7374 2e0a 0a20 2020 2020 2020 203a  hest...        :
+00036940: 7061 7261 6d20 5175 616e 7469 7479 2f73  param Quantity/s
+00036950: 7472 206f 7574 6572 5f72 6164 6975 733a  tr outer_radius:
+00036960: 2054 6865 2072 6164 6975 7320 7468 6174   The radius that
+00036970: 2053 4e52 2073 686f 756c 6420 6265 2063   SNR should be c
+00036980: 616c 6375 6c61 7465 6420 7769 7468 696e  alculated within
+00036990: 2c20 7468 6973 2063 616e 2065 6974 6865  , this can eithe
+000369a0: 7220 6265 2061 0a20 2020 2020 2020 2020  r be a.         
+000369b0: 2020 206e 616d 6564 2072 6164 6975 7320     named radius 
+000369c0: 7375 6368 2061 7320 7235 3030 2c20 6f72  such as r500, or
+000369d0: 2061 6e20 6173 7472 6f70 7920 5175 616e   an astropy Quan
+000369e0: 7469 7479 2e0a 2020 2020 2020 2020 3a70  tity..        :p
+000369f0: 6172 616d 2051 7561 6e74 6974 7920 6c6f  aram Quantity lo
+00036a00: 5f65 6e3a 2054 6865 206c 6f77 6572 2065  _en: The lower e
+00036a10: 6e65 7267 7920 626f 756e 6420 6f66 2074  nergy bound of t
+00036a20: 6865 2072 6174 656d 6170 2074 6f20 7573  he ratemap to us
+00036a30: 6520 746f 2063 616c 6375 6c61 7465 2074  e to calculate t
+00036a40: 6865 2053 4e52 2e20 4465 6661 756c 7420  he SNR. Default 
+00036a50: 6973 204e 6f6e 652c 0a20 2020 2020 2020  is None,.       
+00036a60: 2020 2020 2069 6e20 7768 6963 6820 6361       in which ca
+00036a70: 7365 2074 6865 206c 6f77 6572 2065 6e65  se the lower ene
+00036a80: 7267 7920 626f 756e 6420 666f 7220 7065  rgy bound for pe
+00036a90: 616b 2066 696e 6469 6e67 2077 696c 6c20  ak finding will 
+00036aa0: 6265 2075 7365 6420 2864 6566 6175 6c74  be used (default
+00036ab0: 2069 7320 302e 356b 6556 292e 0a20 2020   is 0.5keV)..   
+00036ac0: 2020 2020 203a 7061 7261 6d20 5175 616e       :param Quan
+00036ad0: 7469 7479 2068 695f 656e 3a20 5468 6520  tity hi_en: The 
+00036ae0: 7570 7065 7220 656e 6572 6779 2062 6f75  upper energy bou
+00036af0: 6e64 206f 6620 7468 6520 7261 7465 6d61  nd of the ratema
+00036b00: 7020 746f 2075 7365 2074 6f20 6361 6c63  p to use to calc
+00036b10: 756c 6174 6520 7468 6520 534e 522e 2044  ulate the SNR. D
+00036b20: 6566 6175 6c74 2069 7320 4e6f 6e65 2c0a  efault is None,.
+00036b30: 2020 2020 2020 2020 2020 2020 696e 2077              in w
+00036b40: 6869 6368 2063 6173 6520 7468 6520 7570  hich case the up
+00036b50: 7065 7220 656e 6572 6779 2062 6f75 6e64  per energy bound
+00036b60: 2066 6f72 2070 6561 6b20 6669 6e64 696e   for peak findin
+00036b70: 6720 7769 6c6c 2062 6520 7573 6564 2028  g will be used (
+00036b80: 6465 6661 756c 7420 6973 2032 2e30 6b65  default is 2.0ke
+00036b90: 5629 2e0a 2020 2020 2020 2020 3a70 6172  V)..        :par
+00036ba0: 616d 2062 6f6f 6c20 616c 6c6f 775f 6e65  am bool allow_ne
+00036bb0: 6761 7469 7665 3a20 5368 6f75 6c64 2070  gative: Should p
+00036bc0: 6978 656c 7320 696e 2074 6865 2062 6163  ixels in the bac
+00036bd0: 6b67 726f 756e 6420 7375 6274 7261 6374  kground subtract
+00036be0: 6564 2063 6f75 6e74 206d 6170 2062 6520  ed count map be 
+00036bf0: 616c 6c6f 7765 6420 746f 2067 6f20 6265  allowed to go be
+00036c00: 6c6f 770a 2020 2020 2020 2020 2020 2020  low.            
+00036c10: 7a65 726f 2c20 7768 6963 6820 7265 7375  zero, which resu
+00036c20: 6c74 7320 696e 2061 206c 6f77 6572 2073  lts in a lower s
+00036c30: 6967 6e61 6c20 746f 206e 6f69 7365 2028  ignal to noise (
+00036c40: 616e 6420 6361 6e20 7265 7375 6c74 2069  and can result i
+00036c50: 6e20 6120 6e65 6761 7469 7665 2073 6967  n a negative sig
+00036c60: 6e61 6c20 746f 206e 6f69 7365 292e 0a20  nal to noise).. 
+00036c70: 2020 2020 2020 203a 7265 7475 726e 3a20         :return: 
+00036c80: 5477 6f20 6172 7261 7973 2c20 7468 6520  Two arrays, the 
+00036c90: 6669 7273 7420 616e 204e 2062 7920 3220  first an N by 2 
+00036ca0: 6172 7261 792c 2077 6974 6820 7468 6520  array, with the 
+00036cb0: 4f62 7349 442c 2049 6e73 7472 756d 656e  ObsID, Instrumen
+00036cc0: 7420 636f 6d62 696e 6174 696f 6e73 2069  t combinations i
+00036cd0: 6e20 6f72 6465 720a 2020 2020 2020 2020  n order.        
+00036ce0: 2020 2020 6f66 2061 7363 656e 6469 6e67      of ascending
+00036cf0: 2073 6967 6e61 6c20 746f 206e 6f69 7365   signal to noise
+00036d00: 2c20 7468 656e 2061 6e20 6172 7261 7920  , then an array 
+00036d10: 636f 6e74 6169 6e69 6e67 2074 6865 206f  containing the o
+00036d20: 7264 6572 2053 4e52 2072 6174 696f 732e  rder SNR ratios.
+00036d30: 0a20 2020 2020 2020 203a 7274 7970 653a  .        :rtype:
+00036d40: 2054 7570 6c65 5b6e 702e 6e64 6172 7261   Tuple[np.ndarra
+00036d50: 792c 206e 702e 6e64 6172 7261 795d 0a20  y, np.ndarray]. 
+00036d60: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00036d70: 2020 2023 2053 6574 2075 7020 736f 6d65     # Set up some
+00036d80: 206c 6973 7473 2066 6f72 2074 6865 204f   lists for the O
+00036d90: 6273 4944 2d49 6e73 7472 756d 656e 7420  bsID-Instrument 
+00036da0: 636f 6d62 6f73 2061 6e64 2074 6865 6972  combos and their
+00036db0: 2053 4e52 7320 7265 7370 6563 7469 7665   SNRs respective
+00036dc0: 6c79 0a20 2020 2020 2020 206f 6273 5f69  ly.        obs_i
+00036dd0: 6e73 7420 3d20 5b5d 0a20 2020 2020 2020  nst = [].       
+00036de0: 2073 6e72 7320 3d20 5b5d 0a20 2020 2020   snrs = [].     
+00036df0: 2020 2023 2057 6520 6c6f 6f70 2074 6872     # We loop thr
+00036e00: 6f75 6768 2074 6865 204f 6273 4944 7320  ough the ObsIDs 
+00036e10: 6173 736f 6369 6174 6564 2077 6974 6820  associated with 
+00036e20: 7468 6973 2073 6f75 7263 6520 616e 6420  this source and 
+00036e30: 7468 6520 696e 7374 7275 6d65 6e74 7320  the instruments 
+00036e40: 6173 736f 6369 6174 6564 2077 6974 6820  associated with 
+00036e50: 7468 6f73 6520 4f62 7349 4473 0a20 2020  those ObsIDs.   
+00036e60: 2020 2020 2066 6f72 206f 6273 5f69 6420       for obs_id 
+00036e70: 696e 2073 656c 662e 696e 7374 7275 6d65  in self.instrume
+00036e80: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
+00036e90: 2066 6f72 2069 6e73 7420 696e 2073 656c   for inst in sel
+00036ea0: 662e 696e 7374 7275 6d65 6e74 735b 6f62  f.instruments[ob
+00036eb0: 735f 6964 5d3a 0a20 2020 2020 2020 2020  s_id]:.         
+00036ec0: 2020 2020 2020 2023 2055 7365 206f 7572         # Use our
+00036ed0: 2068 616e 6479 2067 6574 5f73 6e72 206d   handy get_snr m
+00036ee0: 6574 686f 6420 746f 2063 616c 6375 6c61  ethod to calcula
+00036ef0: 7465 2074 6865 2053 4e52 7320 7765 2077  te the SNRs we w
+00036f00: 616e 742c 2074 6865 6e20 6164 6420 7468  ant, then add th
+00036f10: 6174 2061 6e64 2074 6865 0a20 2020 2020  at and the.     
+00036f20: 2020 2020 2020 2020 2020 2023 2020 4f62             #  Ob
+00036f30: 7349 442d 696e 7374 2063 6f6d 626f 2069  sID-inst combo i
+00036f40: 6e74 6f20 7468 6569 7220 7265 7370 6563  nto their respec
+00036f50: 7469 7665 206c 6973 7473 0a20 2020 2020  tive lists.     
+00036f60: 2020 2020 2020 2020 2020 2073 6e72 732e             snrs.
+00036f70: 6170 7065 6e64 2873 656c 662e 6765 745f  append(self.get_
+00036f80: 736e 7228 6f75 7465 725f 7261 6469 7573  snr(outer_radius
+00036f90: 2c20 7365 6c66 2e64 6566 6175 6c74 5f63  , self.default_c
+00036fa0: 6f6f 7264 2c20 6c6f 5f65 6e2c 2068 695f  oord, lo_en, hi_
+00036fb0: 656e 2c20 6f62 735f 6964 2c20 696e 7374  en, obs_id, inst
+00036fc0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00036fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036fe0: 2020 2020 2020 2020 2020 2061 6c6c 6f77             allow
+00036ff0: 5f6e 6567 6174 6976 6529 290a 2020 2020  _negative)).    
+00037000: 2020 2020 2020 2020 2020 2020 6f62 735f              obs_
+00037010: 696e 7374 2e61 7070 656e 6428 5b6f 6273  inst.append([obs
+00037020: 5f69 642c 2069 6e73 745d 290a 0a20 2020  _id, inst])..   
+00037030: 2020 2020 2023 204d 616b 6520 6f75 7220       # Make our 
+00037040: 7374 6f72 6167 6520 6c69 7374 7320 696e  storage lists in
+00037050: 746f 2061 7272 6179 732c 2065 6173 6965  to arrays, easie
+00037060: 7220 746f 2077 6f72 6b20 7769 7468 2074  r to work with t
+00037070: 6861 7420 7761 790a 2020 2020 2020 2020  hat way.        
+00037080: 6f62 735f 696e 7374 203d 206e 702e 6172  obs_inst = np.ar
+00037090: 7261 7928 6f62 735f 696e 7374 290a 2020  ray(obs_inst).  
+000370a0: 2020 2020 2020 736e 7273 203d 206e 702e        snrs = np.
+000370b0: 6172 7261 7928 736e 7273 290a 0a20 2020  array(snrs)..   
+000370c0: 2020 2020 2023 2057 6520 7761 6e74 2074       # We want t
+000370d0: 6f20 6f72 6465 7220 7468 6520 6f75 7470  o order the outp
+000370e0: 7574 2062 7920 534e 522c 2077 6974 6820  ut by SNR, with 
+000370f0: 7468 6520 6c6f 7765 7374 2062 6569 6e67  the lowest being
+00037100: 2066 6972 7374 2061 6e64 2074 6865 2068   first and the h
+00037110: 6967 6865 7374 2062 6569 6e67 206c 6173  ighest being las
+00037120: 742c 2073 6f20 7765 0a20 2020 2020 2020  t, so we.       
+00037130: 2023 2020 7573 6520 6120 6e75 6d70 7920   #  use a numpy 
+00037140: 6675 6e63 7469 6f6e 2074 6f20 6f75 7470  function to outp
+00037150: 7574 2074 6865 2069 6e64 6578 206f 7264  ut the index ord
+00037160: 6572 206e 6565 6465 6420 746f 2072 652d  er needed to re-
+00037170: 6f72 6465 7220 6f75 7220 7477 6f20 6172  order our two ar
+00037180: 7261 7973 0a20 2020 2020 2020 2072 656f  rays.        reo
+00037190: 7264 6572 5f73 6e72 7320 3d20 6e70 2e61  rder_snrs = np.a
+000371a0: 7267 736f 7274 2873 6e72 7329 0a20 2020  rgsort(snrs).   
+000371b0: 2020 2020 2023 2054 6865 6e20 7765 2075       # Then we u
+000371c0: 7365 2074 6861 7420 746f 2072 652d 6f72  se that to re-or
+000371d0: 6465 7220 7468 656d 0a20 2020 2020 2020  der them.       
+000371e0: 2073 6e72 7320 3d20 736e 7273 5b72 656f   snrs = snrs[reo
+000371f0: 7264 6572 5f73 6e72 735d 0a20 2020 2020  rder_snrs].     
+00037200: 2020 206f 6273 5f69 6e73 7420 3d20 6f62     obs_inst = ob
+00037210: 735f 696e 7374 5b72 656f 7264 6572 5f73  s_inst[reorder_s
+00037220: 6e72 735d 0a0a 2020 2020 2020 2020 2320  nrs]..        # 
+00037230: 416e 6420 7265 7475 726e 206f 7572 206f  And return our o
+00037240: 7264 6572 6564 2064 6963 7469 6f6e 6172  rdered dictionar
+00037250: 6965 730a 2020 2020 2020 2020 7265 7475  ies.        retu
+00037260: 726e 206f 6273 5f69 6e73 742c 2073 6e72  rn obs_inst, snr
+00037270: 730a 0a20 2020 2064 6566 2063 6f75 6e74  s..    def count
+00037280: 5f72 616e 6b69 6e67 2873 656c 662c 206f  _ranking(self, o
+00037290: 7574 6572 5f72 6164 6975 733a 2055 6e69  uter_radius: Uni
+000372a0: 6f6e 5b51 7561 6e74 6974 792c 2073 7472  on[Quantity, str
+000372b0: 5d2c 206c 6f5f 656e 3a20 5175 616e 7469  ], lo_en: Quanti
+000372c0: 7479 203d 204e 6f6e 652c 0a20 2020 2020  ty = None,.     
+000372d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000372e0: 2068 695f 656e 3a20 5175 616e 7469 7479   hi_en: Quantity
+000372f0: 203d 204e 6f6e 6529 202d 3e20 5475 706c   = None) -> Tupl
+00037300: 655b 6e70 2e6e 6461 7272 6179 2c20 5175  e[np.ndarray, Qu
+00037310: 616e 7469 7479 5d3a 0a20 2020 2020 2020  antity]:.       
+00037320: 2022 2222 0a20 2020 2020 2020 2054 6869   """.        Thi
+00037330: 7320 6d65 7468 6f64 2067 656e 6572 6174  s method generat
+00037340: 6573 2061 206c 6973 7420 6f66 204f 6273  es a list of Obs
+00037350: 4944 2d49 6e73 7472 756d 656e 7420 7061  ID-Instrument pa
+00037360: 6972 732c 206f 7264 6572 6564 2062 7920  irs, ordered by 
+00037370: 7468 6520 636f 756e 7473 206d 6561 7375  the counts measu
+00037380: 7265 6420 666f 7220 7468 650a 2020 2020  red for the.    
+00037390: 2020 2020 6769 7665 6e20 7265 6769 6f6e      given region
+000373a0: 2c20 7769 7468 2065 6c65 6d65 6e74 207a  , with element z
+000373b0: 6572 6f20 6265 696e 6720 7468 6520 6c6f  ero being the lo
+000373c0: 7765 7374 2063 6f75 6e74 732c 2061 6e64  west counts, and
+000373d0: 2065 6c65 6d65 6e74 204e 2062 6569 6e67   element N being
+000373e0: 2074 6865 2068 6967 6865 7374 2e0a 0a20   the highest... 
+000373f0: 2020 2020 2020 203a 7061 7261 6d20 5175         :param Qu
+00037400: 616e 7469 7479 2f73 7472 206f 7574 6572  antity/str outer
+00037410: 5f72 6164 6975 733a 2054 6865 2072 6164  _radius: The rad
+00037420: 6975 7320 7468 6174 2063 6f75 6e74 7320  ius that counts 
+00037430: 7368 6f75 6c64 2062 6520 6361 6c63 756c  should be calcul
+00037440: 6174 6564 2077 6974 6869 6e2c 2074 6869  ated within, thi
+00037450: 7320 6361 6e20 6569 7468 6572 2062 6520  s can either be 
+00037460: 610a 2020 2020 2020 2020 2020 2020 6e61  a.            na
+00037470: 6d65 6420 7261 6469 7573 2073 7563 6820  med radius such 
+00037480: 6173 2072 3530 302c 206f 7220 616e 2061  as r500, or an a
+00037490: 7374 726f 7079 2051 7561 6e74 6974 792e  stropy Quantity.
+000374a0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+000374b0: 5175 616e 7469 7479 206c 6f5f 656e 3a20  Quantity lo_en: 
+000374c0: 5468 6520 6c6f 7765 7220 656e 6572 6779  The lower energy
+000374d0: 2062 6f75 6e64 206f 6620 7468 6520 7261   bound of the ra
+000374e0: 7465 6d61 7020 746f 2075 7365 2074 6f20  temap to use to 
+000374f0: 6361 6c63 756c 6174 6520 7468 6520 636f  calculate the co
+00037500: 756e 7473 2e20 4465 6661 756c 7420 6973  unts. Default is
+00037510: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
+00037520: 2020 2069 6e20 7768 6963 6820 6361 7365     in which case
+00037530: 2074 6865 206c 6f77 6572 2065 6e65 7267   the lower energ
+00037540: 7920 626f 756e 6420 666f 7220 7065 616b  y bound for peak
+00037550: 2066 696e 6469 6e67 2077 696c 6c20 6265   finding will be
+00037560: 2075 7365 6420 2864 6566 6175 6c74 2069   used (default i
+00037570: 7320 302e 356b 6556 292e 0a20 2020 2020  s 0.5keV)..     
+00037580: 2020 203a 7061 7261 6d20 5175 616e 7469     :param Quanti
+00037590: 7479 2068 695f 656e 3a20 5468 6520 7570  ty hi_en: The up
+000375a0: 7065 7220 656e 6572 6779 2062 6f75 6e64  per energy bound
+000375b0: 206f 6620 7468 6520 7261 7465 6d61 7020   of the ratemap 
+000375c0: 746f 2075 7365 2074 6f20 6361 6c63 756c  to use to calcul
+000375d0: 6174 6520 7468 6520 636f 756e 7473 2e20  ate the counts. 
+000375e0: 4465 6661 756c 7420 6973 204e 6f6e 652c  Default is None,
+000375f0: 0a20 2020 2020 2020 2020 2020 2069 6e20  .            in 
+00037600: 7768 6963 6820 6361 7365 2074 6865 2075  which case the u
+00037610: 7070 6572 2065 6e65 7267 7920 626f 756e  pper energy boun
+00037620: 6420 666f 7220 7065 616b 2066 696e 6469  d for peak findi
+00037630: 6e67 2077 696c 6c20 6265 2075 7365 6420  ng will be used 
+00037640: 2864 6566 6175 6c74 2069 7320 322e 306b  (default is 2.0k
+00037650: 6556 292e 0a20 2020 2020 2020 203a 7265  eV)..        :re
+00037660: 7475 726e 3a20 5477 6f20 6172 7261 7973  turn: Two arrays
+00037670: 2c20 7468 6520 6669 7273 7420 616e 204e  , the first an N
+00037680: 2062 7920 3220 6172 7261 792c 2077 6974   by 2 array, wit
+00037690: 6820 7468 6520 4f62 7349 442c 2049 6e73  h the ObsID, Ins
+000376a0: 7472 756d 656e 7420 636f 6d62 696e 6174  trument combinat
+000376b0: 696f 6e73 2069 6e20 6f72 6465 720a 2020  ions in order.  
+000376c0: 2020 2020 2020 2020 2020 6f66 2061 7363            of asc
+000376d0: 656e 6469 6e67 2063 6f75 6e74 732c 2074  ending counts, t
+000376e0: 6865 6e20 616e 2061 7272 6179 2063 6f6e  hen an array con
+000376f0: 7461 696e 696e 6720 7468 6520 6f72 6465  taining the orde
+00037700: 7220 636f 756e 7473 2072 6174 696f 732e  r counts ratios.
+00037710: 0a20 2020 2020 2020 203a 7274 7970 653a  .        :rtype:
+00037720: 2054 7570 6c65 5b6e 702e 6e64 6172 7261   Tuple[np.ndarra
+00037730: 792c 2051 7561 6e74 6974 795d 0a20 2020  y, Quantity].   
+00037740: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00037750: 2023 2053 6574 2075 7020 736f 6d65 206c   # Set up some l
+00037760: 6973 7473 2066 6f72 2074 6865 204f 6273  ists for the Obs
+00037770: 4944 2d49 6e73 7472 756d 656e 7420 636f  ID-Instrument co
+00037780: 6d62 6f73 2061 6e64 2074 6865 6972 2063  mbos and their c
+00037790: 6e74 7320 7265 7370 6563 7469 7665 6c79  nts respectively
+000377a0: 0a20 2020 2020 2020 206f 6273 5f69 6e73  .        obs_ins
+000377b0: 7420 3d20 5b5d 0a20 2020 2020 2020 2063  t = [].        c
+000377c0: 6e74 7320 3d20 5b5d 0a20 2020 2020 2020  nts = [].       
+000377d0: 2023 2057 6520 6c6f 6f70 2074 6872 6f75   # We loop throu
+000377e0: 6768 2074 6865 204f 6273 4944 7320 6173  gh the ObsIDs as
+000377f0: 736f 6369 6174 6564 2077 6974 6820 7468  sociated with th
+00037800: 6973 2073 6f75 7263 6520 616e 6420 7468  is source and th
+00037810: 6520 696e 7374 7275 6d65 6e74 7320 6173  e instruments as
+00037820: 736f 6369 6174 6564 2077 6974 6820 7468  sociated with th
+00037830: 6f73 6520 4f62 7349 4473 0a20 2020 2020  ose ObsIDs.     
+00037840: 2020 2066 6f72 206f 6273 5f69 6420 696e     for obs_id in
+00037850: 2073 656c 662e 696e 7374 7275 6d65 6e74   self.instrument
+00037860: 733a 0a20 2020 2020 2020 2020 2020 2066  s:.            f
+00037870: 6f72 2069 6e73 7420 696e 2073 656c 662e  or inst in self.
+00037880: 696e 7374 7275 6d65 6e74 735b 6f62 735f  instruments[obs_
+00037890: 6964 5d3a 0a20 2020 2020 2020 2020 2020  id]:.           
+000378a0: 2020 2020 2063 6e74 732e 6170 7065 6e64       cnts.append
+000378b0: 2873 656c 662e 6765 745f 636f 756e 7473  (self.get_counts
+000378c0: 286f 7574 6572 5f72 6164 6975 732c 2073  (outer_radius, s
+000378d0: 656c 662e 6465 6661 756c 745f 636f 6f72  elf.default_coor
+000378e0: 642c 206c 6f5f 656e 2c20 6869 5f65 6e2c  d, lo_en, hi_en,
+000378f0: 206f 6273 5f69 642c 2069 6e73 7429 290a   obs_id, inst)).
+00037900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037910: 6f62 735f 696e 7374 2e61 7070 656e 6428  obs_inst.append(
+00037920: 5b6f 6273 5f69 642c 2069 6e73 745d 290a  [obs_id, inst]).
+00037930: 0a20 2020 2020 2020 2023 204d 616b 6520  .        # Make 
+00037940: 6f75 7220 7374 6f72 6167 6520 6c69 7374  our storage list
+00037950: 7320 696e 746f 2061 7272 6179 732c 2065  s into arrays, e
+00037960: 6173 6965 7220 746f 2077 6f72 6b20 7769  asier to work wi
+00037970: 7468 2074 6861 7420 7761 790a 2020 2020  th that way.    
+00037980: 2020 2020 6f62 735f 696e 7374 203d 206e      obs_inst = n
+00037990: 702e 6172 7261 7928 6f62 735f 696e 7374  p.array(obs_inst
+000379a0: 290a 2020 2020 2020 2020 636e 7473 203d  ).        cnts =
+000379b0: 2051 7561 6e74 6974 7928 636e 7473 290a   Quantity(cnts).
+000379c0: 0a20 2020 2020 2020 2023 2057 6520 7761  .        # We wa
+000379d0: 6e74 2074 6f20 6f72 6465 7220 7468 6520  nt to order the 
+000379e0: 6f75 7470 7574 2062 7920 636f 756e 7473  output by counts
+000379f0: 2c20 7769 7468 2074 6865 206c 6f77 6573  , with the lowes
+00037a00: 7420 6265 696e 6720 6669 7273 7420 616e  t being first an
+00037a10: 6420 7468 6520 6869 6768 6573 7420 6265  d the highest be
+00037a20: 696e 6720 6c61 7374 2c20 736f 2077 650a  ing last, so we.
+00037a30: 2020 2020 2020 2020 2320 2075 7365 2061          #  use a
+00037a40: 206e 756d 7079 2066 756e 6374 696f 6e20   numpy function 
+00037a50: 746f 206f 7574 7075 7420 7468 6520 696e  to output the in
+00037a60: 6465 7820 6f72 6465 7220 6e65 6564 6564  dex order needed
+00037a70: 2074 6f20 7265 2d6f 7264 6572 206f 7572   to re-order our
+00037a80: 2074 776f 2061 7272 6179 730a 2020 2020   two arrays.    
+00037a90: 2020 2020 7265 6f72 6465 725f 636e 7473      reorder_cnts
+00037aa0: 203d 206e 702e 6172 6773 6f72 7428 636e   = np.argsort(cn
+00037ab0: 7473 290a 2020 2020 2020 2020 2320 5468  ts).        # Th
+00037ac0: 656e 2077 6520 7573 6520 7468 6174 2074  en we use that t
+00037ad0: 6f20 7265 2d6f 7264 6572 2074 6865 6d0a  o re-order them.
+00037ae0: 2020 2020 2020 2020 636e 7473 203d 2063          cnts = c
+00037af0: 6e74 735b 7265 6f72 6465 725f 636e 7473  nts[reorder_cnts
+00037b00: 5d0a 2020 2020 2020 2020 6f62 735f 696e  ].        obs_in
+00037b10: 7374 203d 206f 6273 5f69 6e73 745b 7265  st = obs_inst[re
+00037b20: 6f72 6465 725f 636e 7473 5d0a 0a20 2020  order_cnts]..   
+00037b30: 2020 2020 2023 2041 6e64 2072 6574 7572       # And retur
+00037b40: 6e20 6f75 7220 6f72 6465 7265 6420 6469  n our ordered di
+00037b50: 6374 696f 6e61 7269 6573 270a 2020 2020  ctionaries'.    
+00037b60: 2020 2020 7265 7475 726e 206f 6273 5f69      return obs_i
+00037b70: 6e73 742c 2063 6e74 730a 0a20 2020 2064  nst, cnts..    d
+00037b80: 6566 206f 6666 7365 7428 7365 6c66 2c20  ef offset(self, 
+00037b90: 6f66 665f 756e 6974 3a20 556e 696f 6e5b  off_unit: Union[
+00037ba0: 556e 6974 2c20 7374 725d 203d 2022 6172  Unit, str] = "ar
+00037bb0: 636d 696e 2229 202d 3e20 5175 616e 7469  cmin") -> Quanti
+00037bc0: 7479 3a0a 2020 2020 2020 2020 2222 220a  ty:.        """.
+00037bd0: 2020 2020 2020 2020 5468 6973 206d 6574          This met
+00037be0: 686f 6420 6361 6c63 756c 6174 6573 2074  hod calculates t
+00037bf0: 6865 2073 6570 6172 6174 696f 6e20 6265  he separation be
+00037c00: 7477 6565 6e20 7468 6520 7573 6572 2073  tween the user s
+00037c10: 7570 706c 6965 6420 7261 5f64 6563 2063  upplied ra_dec c
+00037c20: 6f6f 7264 696e 6174 6573 2c20 616e 6420  oordinates, and 
+00037c30: 7468 6520 7065 616b 0a20 2020 2020 2020  the peak.       
+00037c40: 2063 6f6f 7264 696e 6174 6573 2069 6e20   coordinates in 
+00037c50: 7468 6520 7265 7175 6573 7465 6420 6f66  the requested of
+00037c60: 665f 756e 6974 2e20 4966 2074 6865 7265  f_unit. If there
+00037c70: 2069 7320 6e6f 2070 6561 6b20 6174 7472   is no peak attr
+00037c80: 6962 7574 6520 616e 6420 6572 726f 7220  ibute and error 
+00037c90: 7769 6c6c 2062 6520 7468 726f 776e 2c20  will be thrown, 
+00037ca0: 616e 6420 6966 206e 6f0a 2020 2020 2020  and if no.      
+00037cb0: 2020 7065 616b 2068 6173 2062 6565 6e20    peak has been 
+00037cc0: 6361 6c63 756c 6174 6564 2074 6865 6e20  calculated then 
+00037cd0: 7468 6520 7265 7375 6c74 2077 696c 6c20  the result will 
+00037ce0: 6265 2030 2e0a 0a20 2020 2020 2020 203a  be 0...        :
+00037cf0: 7061 7261 6d20 556e 6974 2f73 7472 206f  param Unit/str o
+00037d00: 6666 5f75 6e69 743a 2054 6865 2075 6e69  ff_unit: The uni
+00037d10: 7420 7468 6174 2074 6865 206f 6666 7365  t that the offse
+00037d20: 7420 7368 6f75 6c64 2062 6520 696e 2e0a  t should be in..
+00037d30: 2020 2020 2020 2020 3a72 6574 7572 6e3a          :return:
+00037d40: 2054 6865 206f 6666 7365 7420 6265 7477   The offset betw
+00037d50: 6565 6e20 7261 5f64 6563 2061 6e64 2070  een ra_dec and p
+00037d60: 6561 6b2c 2069 6e20 7468 6520 7265 7175  eak, in the requ
+00037d70: 6573 7465 6420 756e 6974 2e0a 2020 2020  ested unit..    
+00037d80: 2020 2020 3a72 7479 7065 3a20 5175 616e      :rtype: Quan
+00037d90: 7469 7479 0a20 2020 2020 2020 2022 2222  tity.        """
+00037da0: 0a20 2020 2020 2020 2023 2043 6865 636b  .        # Check
+00037db0: 2074 6861 7420 7468 6520 736f 7572 6365   that the source
+00037dc0: 2068 6173 2061 2070 6561 6b20 6174 7472   has a peak attr
+00037dd0: 6962 7574 6520 746f 2066 6574 6368 2c20  ibute to fetch, 
+00037de0: 6f74 6865 7277 6973 6520 7468 726f 7720  otherwise throw 
+00037df0: 6572 726f 720a 2020 2020 2020 2020 6966  error.        if
+00037e00: 206e 6f74 2068 6173 6174 7472 2873 656c   not hasattr(sel
+00037e10: 662c 2027 7065 616b 2729 3a0a 2020 2020  f, 'peak'):.    
+00037e20: 2020 2020 2020 2020 7261 6973 6520 4174          raise At
+00037e30: 7472 6962 7574 6545 7272 6f72 2822 5468  tributeError("Th
+00037e40: 6973 2073 6f75 7263 6520 646f 6573 206e  is source does n
+00037e50: 6f74 2068 6176 6520 6120 7065 616b 2061  ot have a peak a
+00037e60: 7474 7269 6275 7465 2c20 616e 6420 736f  ttribute, and so
+00037e70: 2061 6e20 6f66 6673 6574 2063 616e 6e6f   an offset canno
+00037e80: 7420 6265 2063 616c 6375 6c61 7465 642e  t be calculated.
+00037e90: 2229 0a0a 2020 2020 2020 2020 2320 4361  ")..        # Ca
+00037ea0: 6c63 756c 6174 6520 7468 6520 6575 636c  lculate the eucl
+00037eb0: 6964 6561 6e20 6469 7374 616e 6365 2062  idean distance b
+00037ec0: 6574 7765 656e 2072 615f 6465 6320 616e  etween ra_dec an
+00037ed0: 6420 7065 616b 0a20 2020 2020 2020 2073  d peak.        s
+00037ee0: 6570 203d 206e 702e 7371 7274 2861 6273  ep = np.sqrt(abs
+00037ef0: 2873 656c 662e 7261 5f64 6563 5b30 5d20  (self.ra_dec[0] 
+00037f00: 2d20 7365 6c66 2e70 6561 6b5b 305d 2920  - self.peak[0]) 
+00037f10: 2a2a 2032 202b 2061 6273 2873 656c 662e  ** 2 + abs(self.
+00037f20: 7261 5f64 6563 5b31 5d20 2d20 7365 6c66  ra_dec[1] - self
+00037f30: 2e70 6561 6b5b 315d 2920 2a2a 2032 290a  .peak[1]) ** 2).
+00037f40: 2020 2020 2020 2020 2320 436f 6e76 6572          # Conver
+00037f50: 7420 7468 6520 7365 7061 7261 7469 6f6e  t the separation
+00037f60: 2074 6f20 7468 6520 7265 7175 6573 7465   to the requeste
+00037f70: 6420 756e 6974 202d 2074 6869 7320 7769  d unit - this wi
+00037f80: 6c6c 2074 6872 6f77 2061 6e20 6572 726f  ll throw an erro
+00037f90: 7220 6966 2074 6865 2075 6e69 7420 6973  r if the unit is
+00037fa0: 2073 7475 7069 640a 2020 2020 2020 2020   stupid.        
+00037fb0: 636f 6e76 5f73 6570 203d 2073 656c 662e  conv_sep = self.
+00037fc0: 636f 6e76 6572 745f 7261 6469 7573 2873  convert_radius(s
+00037fd0: 6570 2c20 6f66 665f 756e 6974 290a 0a20  ep, off_unit).. 
+00037fe0: 2020 2020 2020 2023 2052 6574 7572 6e20         # Return 
+00037ff0: 7468 6520 636f 6e76 6572 7465 6420 7365  the converted se
+00038000: 7061 7261 7469 6f6e 0a20 2020 2020 2020  paration.       
+00038010: 2072 6574 7572 6e20 636f 6e76 5f73 6570   return conv_sep
+00038020: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
+00038030: 2020 2020 6465 6620 7065 616b 5f6c 6f5f      def peak_lo_
+00038040: 656e 2873 656c 6629 202d 3e20 5175 616e  en(self) -> Quan
+00038050: 7469 7479 3a0a 2020 2020 2020 2020 2222  tity:.        ""
+00038060: 220a 2020 2020 2020 2020 5468 6973 2070  ".        This p
+00038070: 726f 7065 7274 7920 7265 7475 726e 7320  roperty returns 
+00038080: 7468 6520 6c6f 7765 7220 656e 6572 6779  the lower energy
+00038090: 2062 6f75 6e64 206f 6620 7468 6520 696d   bound of the im
+000380a0: 6167 6520 7573 6564 2066 6f72 2070 6561  age used for pea
+000380b0: 6b20 6669 6e64 696e 672e 0a0a 2020 2020  k finding...    
+000380c0: 2020 2020 3a72 6574 7572 6e3a 2041 2071      :return: A q
+000380d0: 7561 6e74 6974 7920 636f 6e74 6169 6e69  uantity containi
+000380e0: 6e67 2074 6865 206c 6f77 6572 2065 6e65  ng the lower ene
+000380f0: 7267 7920 6c69 6d69 7420 7573 6564 2066  rgy limit used f
+00038100: 6f72 2070 6561 6b20 6669 6e64 696e 672e  or peak finding.
+00038110: 0a20 2020 2020 2020 203a 7274 7970 653a  .        :rtype:
+00038120: 2051 7561 6e74 6974 790a 2020 2020 2020   Quantity.      
+00038130: 2020 2222 220a 2020 2020 2020 2020 7265    """.        re
+00038140: 7475 726e 2073 656c 662e 5f70 6561 6b5f  turn self._peak_
+00038150: 6c6f 5f65 6e0a 0a20 2020 2040 7072 6f70  lo_en..    @prop
+00038160: 6572 7479 0a20 2020 2064 6566 2070 6561  erty.    def pea
+00038170: 6b5f 6869 5f65 6e28 7365 6c66 2920 2d3e  k_hi_en(self) ->
+00038180: 2051 7561 6e74 6974 793a 0a20 2020 2020   Quantity:.     
+00038190: 2020 2022 2222 0a20 2020 2020 2020 2054     """.        T
+000381a0: 6869 7320 7072 6f70 6572 7479 2072 6574  his property ret
+000381b0: 7572 6e73 2074 6865 2075 7070 6572 2065  urns the upper e
+000381c0: 6e65 7267 7920 626f 756e 6420 6f66 2074  nergy bound of t
+000381d0: 6865 2069 6d61 6765 2075 7365 6420 666f  he image used fo
+000381e0: 7220 7065 616b 2066 696e 6469 6e67 2e0a  r peak finding..
+000381f0: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
+00038200: 3a20 4120 7175 616e 7469 7479 2063 6f6e  : A quantity con
+00038210: 7461 696e 696e 6720 7468 6520 7570 7065  taining the uppe
+00038220: 7220 656e 6572 6779 206c 696d 6974 2075  r energy limit u
+00038230: 7365 6420 666f 7220 7065 616b 2066 696e  sed for peak fin
+00038240: 6469 6e67 2e0a 2020 2020 2020 2020 3a72  ding..        :r
+00038250: 7479 7065 3a20 5175 616e 7469 7479 0a20  type: Quantity. 
+00038260: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00038270: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
+00038280: 7065 616b 5f68 695f 656e 0a0a 2020 2020  peak_hi_en..    
+00038290: 4070 726f 7065 7274 790a 2020 2020 6465  @property.    de
+000382a0: 6620 7573 655f 7065 616b 2873 656c 6629  f use_peak(self)
+000382b0: 202d 3e20 626f 6f6c 3a0a 2020 2020 2020   -> bool:.      
+000382c0: 2020 2222 220a 2020 2020 2020 2020 5468    """.        Th
+000382d0: 6973 2070 726f 7065 7274 7920 7368 6f77  is property show
+000382e0: 7320 7768 6574 6865 7220 6120 7061 7274  s whether a part
+000382f0: 6963 756c 6172 2058 4741 2073 6f75 7263  icular XGA sourc
+00038300: 6520 6f62 6a65 6374 2068 6173 2062 6565  e object has bee
+00038310: 6e20 7365 7475 7020 746f 2075 7365 2070  n setup to use p
+00038320: 6561 6b20 636f 6f72 6469 6e61 7465 730a  eak coordinates.
+00038330: 2020 2020 2020 2020 6f72 206e 6f74 2e20          or not. 
+00038340: 5468 6520 7072 6f70 6572 7479 2069 7320  The property is 
+00038350: 6569 7468 6572 2054 7275 652c 2046 616c  either True, Fal
+00038360: 7365 2c20 6f72 204e 6f6e 6520 2869 6620  se, or None (if 
+00038370: 6974 7320 6120 4261 7365 536f 7572 6365  its a BaseSource
+00038380: 292e 0a0a 2020 2020 2020 2020 3a72 6574  )...        :ret
+00038390: 7572 6e3a 2049 6620 7468 6520 736f 7572  urn: If the sour
+000383a0: 6365 2069 7320 7365 7420 746f 2075 7365  ce is set to use
+000383b0: 2070 6561 6b73 2c20 5472 7565 2c20 6f74   peaks, True, ot
+000383c0: 6865 7277 6973 6520 4661 6c73 652e 0a20  herwise False.. 
+000383d0: 2020 2020 2020 203a 7274 7970 653a 2062         :rtype: b
+000383e0: 6f6f 6c0a 2020 2020 2020 2020 2222 220a  ool.        """.
+000383f0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00038400: 656c 662e 5f75 7365 5f70 6561 6b0a 0a20  elf._use_peak.. 
+00038410: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
+00038420: 2064 6566 2073 7570 7072 6573 7365 645f   def suppressed_
+00038430: 7761 726e 696e 6773 2873 656c 6629 202d  warnings(self) -
+00038440: 3e20 4c69 7374 5b73 7472 5d3a 0a20 2020  > List[str]:.   
+00038450: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00038460: 2041 2070 726f 7065 7274 7920 6765 7474   A property gett
+00038470: 6572 2028 7769 7468 206e 6f20 7365 7474  er (with no sett
+00038480: 6572 2920 666f 7220 7468 6520 7761 726e  er) for the warn
+00038490: 696e 6773 2074 6861 7420 6861 7665 2062  ings that have b
+000384a0: 6565 6e20 7375 7070 7265 7373 6564 2066  een suppressed f
+000384b0: 726f 6d20 6469 7370 6c61 7920 746f 2074  rom display to t
+000384c0: 6865 2075 7365 7220 6173 0a20 2020 2020  he user as.     
+000384d0: 2020 2074 6865 2073 6f75 7263 6520 7761     the source wa
+000384e0: 7320 6465 636c 6172 6564 2061 7320 6120  s declared as a 
+000384f0: 6d65 6d62 6572 206f 6620 6120 7361 6d70  member of a samp
+00038500: 6c65 2e0a 0a20 2020 2020 2020 203a 7265  le...        :re
+00038510: 7475 726e 3a20 5468 6520 6c69 7374 206f  turn: The list o
+00038520: 6620 7375 7070 7265 7373 6564 2077 6172  f suppressed war
+00038530: 6e69 6e67 7320 666f 7220 7468 6973 2073  nings for this s
+00038540: 6f75 7263 652e 0a20 2020 2020 2020 203a  ource..        :
+00038550: 7274 7970 653a 204c 6973 745b 7374 725d  rtype: List[str]
+00038560: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00038570: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
+00038580: 2e5f 7361 6d70 5f6d 656d 6265 723a 0a20  ._samp_member:. 
+00038590: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+000385a0: 204e 6f74 5361 6d70 6c65 4d65 6d62 6572   NotSampleMember
+000385b0: 4572 726f 7228 2254 6865 2073 6f75 7263  Error("The sourc
+000385c0: 6520 666f 7220 7b6e 7d20 6973 206e 6f74  e for {n} is not
+000385d0: 2061 206d 656d 6265 7220 6f66 2061 2073   a member of a s
+000385e0: 616d 706c 652c 2061 6e64 2061 7320 7375  ample, and as su
+000385f0: 6368 2077 6172 6e69 6e67 7320 6861 7665  ch warnings have
+00038600: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+00038610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038620: 2020 2020 2020 2020 2020 226e 6f74 2062            "not b
+00038630: 6565 6e20 7375 7070 7265 7373 6564 2e22  een suppressed."
+00038640: 2e66 6f72 6d61 7428 6e3d 7365 6c66 2e6e  .format(n=self.n
+00038650: 616d 6529 290a 2020 2020 2020 2020 656c  ame)).        el
+00038660: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00038670: 7265 7475 726e 2073 656c 662e 5f73 7570  return self._sup
+00038680: 705f 7761 726e 0a0a 2020 2020 6465 6620  p_warn..    def 
+00038690: 696e 666f 2873 656c 6629 3a0a 2020 2020  info(self):.    
+000386a0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+000386b0: 5665 7279 2073 696d 706c 6520 6675 6e63  Very simple func
+000386c0: 7469 6f6e 2074 6861 7420 6a75 7374 2070  tion that just p
+000386d0: 7269 6e74 7320 6120 7375 6d6d 6172 7920  rints a summary 
+000386e0: 6f66 2069 6d70 6f72 7461 6e74 2069 6e66  of important inf
+000386f0: 6f72 6d61 7469 6f6e 2072 656c 6174 6564  ormation related
+00038700: 2074 6f20 7468 6520 736f 7572 6365 206f   to the source o
+00038710: 626a 6563 742e 2e0a 2020 2020 2020 2020  bject...        
+00038720: 2222 220a 2020 2020 2020 2020 7072 696e  """.        prin
+00038730: 7428 225c 6e2d 2d2d 2d2d 2d2d 2d2d 2d2d  t("\n-----------
+00038740: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00038750: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00038760: 2d2d 2d2d 2d2d 2d2d 2d2d 2229 0a20 2020  ----------").   
+00038770: 2020 2020 2070 7269 6e74 2822 536f 7572       print("Sour
+00038780: 6365 204e 616d 6520 2d20 7b7d 222e 666f  ce Name - {}".fo
+00038790: 726d 6174 2873 656c 662e 5f6e 616d 6529  rmat(self._name)
+000387a0: 290a 2020 2020 2020 2020 7072 696e 7428  ).        print(
+000387b0: 2255 7365 7220 436f 6f72 6469 6e61 7465  "User Coordinate
+000387c0: 7320 2d20 287b 307d 2c20 7b31 7d29 2064  s - ({0}, {1}) d
+000387d0: 6567 7265 6573 222e 666f 726d 6174 282a  egrees".format(*
+000387e0: 7365 6c66 2e5f 7261 5f64 6563 2929 0a20  self._ra_dec)). 
+000387f0: 2020 2020 2020 2069 6620 7365 6c66 2e5f         if self._
+00038800: 7573 655f 7065 616b 2069 7320 6e6f 7420  use_peak is not 
+00038810: 4e6f 6e65 2061 6e64 2073 656c 662e 5f75  None and self._u
+00038820: 7365 5f70 6561 6b3a 0a20 2020 2020 2020  se_peak:.       
+00038830: 2020 2020 2070 7269 6e74 2822 582d 7261       print("X-ra
+00038840: 7920 5065 616b 202d 2028 7b30 7d2c 207b  y Peak - ({0}, {
+00038850: 317d 2920 6465 6772 6565 7322 2e66 6f72  1}) degrees".for
+00038860: 6d61 7428 2a73 656c 662e 5f70 6561 6b73  mat(*self._peaks
+00038870: 5b22 636f 6d62 696e 6564 225d 2e76 616c  ["combined"].val
+00038880: 7565 2929 0a20 2020 2020 2020 2070 7269  ue)).        pri
+00038890: 6e74 2822 6e48 202d 207b 7d22 2e66 6f72  nt("nH - {}".for
+000388a0: 6d61 7428 7365 6c66 2e6e 4829 290a 2020  mat(self.nH)).  
+000388b0: 2020 2020 2020 6966 2073 656c 662e 5f72        if self._r
+000388c0: 6564 7368 6966 7420 6973 206e 6f74 204e  edshift is not N
+000388d0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+000388e0: 2070 7269 6e74 2822 5265 6473 6869 6674   print("Redshift
+000388f0: 202d 207b 7d22 2e66 6f72 6d61 7428 726f   - {}".format(ro
+00038900: 756e 6428 7365 6c66 2e5f 7265 6473 6869  und(self._redshi
+00038910: 6674 2c20 3329 2929 0a20 2020 2020 2020  ft, 3))).       
+00038920: 2070 7269 6e74 2822 584d 4d20 4f62 7349   print("XMM ObsI
+00038930: 4473 202d 207b 7d22 2e66 6f72 6d61 7428  Ds - {}".format(
+00038940: 7365 6c66 2e5f 5f6c 656e 5f5f 2829 2929  self.__len__()))
+00038950: 0a20 2020 2020 2020 2070 7269 6e74 2822  .        print("
+00038960: 504e 204f 6273 6572 7661 7469 6f6e 7320  PN Observations 
+00038970: 2d20 7b7d 222e 666f 726d 6174 2873 656c  - {}".format(sel
+00038980: 662e 6e75 6d5f 706e 5f6f 6273 2929 0a20  f.num_pn_obs)). 
+00038990: 2020 2020 2020 2070 7269 6e74 2822 4d4f         print("MO
+000389a0: 5331 204f 6273 6572 7661 7469 6f6e 7320  S1 Observations 
+000389b0: 2d20 7b7d 222e 666f 726d 6174 2873 656c  - {}".format(sel
+000389c0: 662e 6e75 6d5f 6d6f 7331 5f6f 6273 2929  f.num_mos1_obs))
+000389d0: 0a20 2020 2020 2020 2070 7269 6e74 2822  .        print("
+000389e0: 4d4f 5332 204f 6273 6572 7661 7469 6f6e  MOS2 Observation
+000389f0: 7320 2d20 7b7d 222e 666f 726d 6174 2873  s - {}".format(s
+00038a00: 656c 662e 6e75 6d5f 6d6f 7332 5f6f 6273  elf.num_mos2_obs
+00038a10: 2929 0a20 2020 2020 2020 2070 7269 6e74  )).        print
+00038a20: 2822 4f6e 2d41 7869 7320 2d20 7b7d 222e  ("On-Axis - {}".
+00038a30: 666f 726d 6174 286c 656e 2873 656c 662e  format(len(self.
+00038a40: 5f6f 6e61 7869 7329 2929 0a20 2020 2020  _onaxis))).     
+00038a50: 2020 2070 7269 6e74 2822 5769 7468 2072     print("With r
+00038a60: 6567 696f 6e73 202d 207b 7d22 2e66 6f72  egions - {}".for
+00038a70: 6d61 7428 6c65 6e28 7365 6c66 2e5f 696e  mat(len(self._in
+00038a80: 6974 6961 6c5f 7265 6769 6f6e 7329 2929  itial_regions)))
+00038a90: 0a20 2020 2020 2020 2070 7269 6e74 2822  .        print("
+00038aa0: 546f 7461 6c20 7265 6769 6f6e 7320 2d20  Total regions - 
+00038ab0: 7b7d 222e 666f 726d 6174 2873 756d 285b  {}".format(sum([
+00038ac0: 6c65 6e28 7365 6c66 2e5f 696e 6974 6961  len(self._initia
+00038ad0: 6c5f 7265 6769 6f6e 735b 6f5d 2920 666f  l_regions[o]) fo
+00038ae0: 7220 6f20 696e 2073 656c 662e 5f69 6e69  r o in self._ini
+00038af0: 7469 616c 5f72 6567 696f 6e73 5d29 2929  tial_regions])))
+00038b00: 0a20 2020 2020 2020 2070 7269 6e74 2822  .        print("
+00038b10: 4f62 7320 7769 7468 2031 2064 6574 6563  Obs with 1 detec
+00038b20: 7469 6f6e 202d 207b 7d22 2e66 6f72 6d61  tion - {}".forma
+00038b30: 7428 7375 6d28 5b31 2066 6f72 206f 2069  t(sum([1 for o i
+00038b40: 6e20 7365 6c66 2e5f 696e 6974 6961 6c5f  n self._initial_
+00038b50: 7265 6769 6f6e 5f6d 6174 6368 6573 2069  region_matches i
+00038b60: 660a 2020 2020 2020 2020 2020 2020 2020  f.              
+00038b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038b90: 2020 2020 2020 7365 6c66 2e5f 696e 6974        self._init
+00038ba0: 6961 6c5f 7265 6769 6f6e 5f6d 6174 6368  ial_region_match
+00038bb0: 6573 5b6f 5d2e 7375 6d28 2920 3d3d 2031  es[o].sum() == 1
+00038bc0: 5d29 2929 0a20 2020 2020 2020 2070 7269  ]))).        pri
+00038bd0: 6e74 2822 4f62 7320 7769 7468 203e 3120  nt("Obs with >1 
+00038be0: 6d61 7463 6865 7320 2d20 7b7d 222e 666f  matches - {}".fo
+00038bf0: 726d 6174 2873 756d 285b 3120 666f 7220  rmat(sum([1 for 
+00038c00: 6f20 696e 2073 656c 662e 5f69 6e69 7469  o in self._initi
+00038c10: 616c 5f72 6567 696f 6e5f 6d61 7463 6865  al_region_matche
+00038c20: 7320 6966 0a20 2020 2020 2020 2020 2020  s if.           
+00038c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038c50: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00038c60: 696e 6974 6961 6c5f 7265 6769 6f6e 5f6d  initial_region_m
+00038c70: 6174 6368 6573 5b6f 5d2e 7375 6d28 2920  atches[o].sum() 
+00038c80: 3e20 315d 2929 290a 2020 2020 2020 2020  > 1]))).        
+00038c90: 2320 4966 2061 2063 6f6d 6269 6e65 6420  # If a combined 
+00038ca0: 6578 706f 7375 7265 206d 6170 2065 7869  exposure map exi
+00038cb0: 7374 732c 2077 6527 6c6c 2075 7365 2069  sts, we'll use i
+00038cc0: 7420 746f 2067 6976 6520 7468 6520 7573  t to give the us
+00038cd0: 6572 2061 6e20 6964 6561 206f 6620 7468  er an idea of th
+00038ce0: 6520 746f 7461 6c20 6578 706f 7375 7265  e total exposure
+00038cf0: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
+00038d00: 2020 2020 2020 2020 2020 6578 203d 2073            ex = s
+00038d10: 656c 662e 6765 745f 636f 6d62 696e 6564  elf.get_combined
+00038d20: 5f65 7870 6d61 7073 2829 0a20 2020 2020  _expmaps().     
+00038d30: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+00038d40: 616e 6365 2865 782c 206c 6973 7429 3a0a  ance(ex, list):.
+00038d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038d60: 6578 203d 2065 785b 305d 0a20 2020 2020  ex = ex[0].     
+00038d70: 2020 2020 2020 2070 7269 6e74 2822 546f         print("To
+00038d80: 7461 6c20 6578 706f 7375 7265 202d 207b  tal exposure - {
+00038d90: 7d22 2e66 6f72 6d61 7428 6578 2e67 6574  }".format(ex.get
+00038da0: 5f65 7870 2873 656c 662e 7261 5f64 6563  _exp(self.ra_dec
+00038db0: 292e 746f 2827 6b73 2729 2e72 6f75 6e64  ).to('ks').round
+00038dc0: 2832 2929 290a 2020 2020 2020 2020 6578  (2))).        ex
+00038dd0: 6365 7074 204e 6f50 726f 6475 6374 4176  cept NoProductAv
+00038de0: 6169 6c61 626c 6545 7272 6f72 3a0a 2020  ailableError:.  
+00038df0: 2020 2020 2020 2020 2020 7061 7373 0a20            pass. 
+00038e00: 2020 2020 2020 2070 7269 6e74 2822 496d         print("Im
+00038e10: 6167 6573 2061 7373 6f63 6961 7465 6420  ages associated 
+00038e20: 2d20 7b7d 222e 666f 726d 6174 286c 656e  - {}".format(len
+00038e30: 2873 656c 662e 6765 745f 7072 6f64 7563  (self.get_produc
+00038e40: 7473 2822 696d 6167 6522 2929 2929 0a20  ts("image")))). 
+00038e50: 2020 2020 2020 2070 7269 6e74 2822 4578         print("Ex
+00038e60: 706f 7375 7265 206d 6170 7320 6173 736f  posure maps asso
+00038e70: 6369 6174 6564 202d 207b 7d22 2e66 6f72  ciated - {}".for
+00038e80: 6d61 7428 6c65 6e28 7365 6c66 2e67 6574  mat(len(self.get
+00038e90: 5f70 726f 6475 6374 7328 2265 7870 6d61  _products("expma
+00038ea0: 7022 2929 2929 0a20 2020 2020 2020 2070  p")))).        p
+00038eb0: 7269 6e74 2822 436f 6d62 696e 6564 2052  rint("Combined R
+00038ec0: 6174 656d 6170 7320 6173 736f 6369 6174  atemaps associat
+00038ed0: 6564 202d 207b 7d22 2e66 6f72 6d61 7428  ed - {}".format(
+00038ee0: 6c65 6e28 7365 6c66 2e67 6574 5f70 726f  len(self.get_pro
+00038ef0: 6475 6374 7328 2263 6f6d 6269 6e65 645f  ducts("combined_
+00038f00: 7261 7465 6d61 7022 2929 2929 0a20 2020  ratemap")))).   
+00038f10: 2020 2020 2070 7269 6e74 2822 5370 6563       print("Spec
+00038f20: 7472 6120 6173 736f 6369 6174 6564 202d  tra associated -
+00038f30: 207b 7d22 2e66 6f72 6d61 7428 6c65 6e28   {}".format(len(
+00038f40: 7365 6c66 2e67 6574 5f70 726f 6475 6374  self.get_product
+00038f50: 7328 2273 7065 6374 7275 6d22 2929 2929  s("spectrum"))))
+00038f60: 0a0a 2020 2020 2020 2020 6966 206c 656e  ..        if len
+00038f70: 2873 656c 662e 5f66 6974 5f72 6573 756c  (self._fit_resul
+00038f80: 7473 2920 213d 2030 3a0a 2020 2020 2020  ts) != 0:.      
+00038f90: 2020 2020 2020 7072 696e 7428 2246 6974        print("Fit
+00038fa0: 7465 6420 4d6f 6465 6c73 202d 207b 7d22  ted Models - {}"
+00038fb0: 2e66 6f72 6d61 7428 2220 7c20 222e 6a6f  .format(" | ".jo
+00038fc0: 696e 2873 656c 662e 6669 7474 6564 5f6d  in(self.fitted_m
+00038fd0: 6f64 656c 7329 2929 0a0a 2020 2020 2020  odels)))..      
+00038fe0: 2020 6966 2073 656c 662e 5f72 6567 696f    if self._regio
+00038ff0: 6e73 2069 7320 6e6f 7420 4e6f 6e65 2061  ns is not None a
+00039000: 6e64 2022 6375 7374 6f6d 2220 696e 2073  nd "custom" in s
+00039010: 656c 662e 5f72 6164 6969 3a0a 2020 2020  elf._radii:.    
+00039020: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00039030: 5f72 6564 7368 6966 7420 6973 206e 6f74  _redshift is not
+00039040: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00039050: 2020 2020 2020 2072 6567 696f 6e5f 7261         region_ra
+00039060: 6469 7573 203d 2061 6e67 5f74 6f5f 7261  dius = ang_to_ra
+00039070: 6428 7365 6c66 2e5f 6375 7374 6f6d 5f72  d(self._custom_r
+00039080: 6567 696f 6e5f 7261 6469 7573 2c20 7365  egion_radius, se
+00039090: 6c66 2e5f 7265 6473 6869 6674 2c20 636f  lf._redshift, co
+000390a0: 736d 6f3d 7365 6c66 2e5f 636f 736d 6f29  smo=self._cosmo)
+000390b0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+000390c0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+000390d0: 2020 2072 6567 696f 6e5f 7261 6469 7573     region_radius
+000390e0: 203d 2073 656c 662e 5f63 7573 746f 6d5f   = self._custom_
+000390f0: 7265 6769 6f6e 5f72 6164 6975 732e 746f  region_radius.to
+00039100: 2822 6465 6722 290a 2020 2020 2020 2020  ("deg").        
+00039110: 2020 2020 7072 696e 7428 2243 7573 746f      print("Custo
+00039120: 6d20 5265 6769 6f6e 2052 6164 6975 7320  m Region Radius 
+00039130: 2d20 7b7d 222e 666f 726d 6174 2872 6567  - {}".format(reg
+00039140: 696f 6e5f 7261 6469 7573 2e72 6f75 6e64  ion_radius.round
+00039150: 2832 2929 290a 2020 2020 2020 2020 2020  (2))).          
+00039160: 2020 6966 206c 656e 2873 656c 662e 6765    if len(self.ge
+00039170: 745f 7072 6f64 7563 7473 2827 636f 6d62  t_products('comb
+00039180: 696e 6564 5f69 6d61 6765 2729 2920 213d  ined_image')) !=
+00039190: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+000391a0: 2020 2020 7072 696e 7428 2243 7573 746f      print("Custo
+000391b0: 6d20 5265 6769 6f6e 2053 4e52 202d 207b  m Region SNR - {
+000391c0: 7d22 2e66 6f72 6d61 7428 7365 6c66 2e67  }".format(self.g
+000391d0: 6574 5f73 6e72 2822 6375 7374 6f6d 222c  et_snr("custom",
+000391e0: 2073 656c 662e 5f64 6566 6175 6c74 5f63   self._default_c
+000391f0: 6f6f 7264 292e 726f 756e 6428 3229 2929  oord).round(2)))
+00039200: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+00039210: 662e 5f72 3230 3020 6973 206e 6f74 204e  f._r200 is not N
+00039220: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00039230: 2070 7269 6e74 2822 5232 3030 202d 207b   print("R200 - {
+00039240: 7d22 2e66 6f72 6d61 7428 7365 6c66 2e5f  }".format(self._
+00039250: 7232 3030 2e72 6f75 6e64 2832 2929 290a  r200.round(2))).
+00039260: 2020 2020 2020 2020 2020 2020 6966 206c              if l
+00039270: 656e 2873 656c 662e 6765 745f 7072 6f64  en(self.get_prod
+00039280: 7563 7473 2827 636f 6d62 696e 6564 5f69  ucts('combined_i
+00039290: 6d61 6765 2729 2920 213d 2030 3a0a 2020  mage')) != 0:.  
+000392a0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+000392b0: 696e 7428 2252 3230 3020 534e 5220 2d20  int("R200 SNR - 
+000392c0: 7b7d 222e 666f 726d 6174 2873 656c 662e  {}".format(self.
+000392d0: 6765 745f 736e 7228 2272 3230 3022 2c20  get_snr("r200", 
+000392e0: 7365 6c66 2e5f 6465 6661 756c 745f 636f  self._default_co
+000392f0: 6f72 6429 2e72 6f75 6e64 2832 2929 290a  ord).round(2))).
+00039300: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00039310: 5f72 3530 3020 6973 206e 6f74 204e 6f6e  _r500 is not Non
+00039320: 653a 0a20 2020 2020 2020 2020 2020 2070  e:.            p
+00039330: 7269 6e74 2822 5235 3030 202d 207b 7d22  rint("R500 - {}"
+00039340: 2e66 6f72 6d61 7428 7365 6c66 2e5f 7235  .format(self._r5
+00039350: 3030 2e72 6f75 6e64 2832 2929 290a 2020  00.round(2))).  
+00039360: 2020 2020 2020 2020 2020 6966 206c 656e            if len
+00039370: 2873 656c 662e 6765 745f 7072 6f64 7563  (self.get_produc
+00039380: 7473 2827 636f 6d62 696e 6564 5f69 6d61  ts('combined_ima
+00039390: 6765 2729 2920 213d 2030 3a0a 2020 2020  ge')) != 0:.    
+000393a0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+000393b0: 7428 2252 3530 3020 534e 5220 2d20 7b7d  t("R500 SNR - {}
+000393c0: 222e 666f 726d 6174 2873 656c 662e 6765  ".format(self.ge
+000393d0: 745f 736e 7228 2272 3530 3022 2c20 7365  t_snr("r500", se
+000393e0: 6c66 2e5f 6465 6661 756c 745f 636f 6f72  lf._default_coor
+000393f0: 6429 2e72 6f75 6e64 2832 2929 290a 2020  d).round(2))).  
+00039400: 2020 2020 2020 6966 2073 656c 662e 5f72        if self._r
+00039410: 3235 3030 2069 7320 6e6f 7420 4e6f 6e65  2500 is not None
+00039420: 3a0a 2020 2020 2020 2020 2020 2020 7072  :.            pr
+00039430: 696e 7428 2252 3235 3030 202d 207b 7d22  int("R2500 - {}"
+00039440: 2e66 6f72 6d61 7428 7365 6c66 2e5f 7232  .format(self._r2
+00039450: 3530 302e 726f 756e 6428 3229 2929 0a20  500.round(2))). 
+00039460: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
+00039470: 6e28 7365 6c66 2e67 6574 5f70 726f 6475  n(self.get_produ
+00039480: 6374 7328 2763 6f6d 6269 6e65 645f 696d  cts('combined_im
+00039490: 6167 6527 2929 2021 3d20 303a 0a20 2020  age')) != 0:.   
+000394a0: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+000394b0: 6e74 2822 5232 3530 3020 534e 5220 2d20  nt("R2500 SNR - 
+000394c0: 7b7d 222e 666f 726d 6174 2873 656c 662e  {}".format(self.
+000394d0: 6765 745f 736e 7228 2272 3235 3030 222c  get_snr("r2500",
+000394e0: 2073 656c 662e 5f64 6566 6175 6c74 5f63   self._default_c
+000394f0: 6f6f 7264 292e 726f 756e 6428 3229 2929  oord).round(2)))
+00039500: 0a0a 2020 2020 2020 2020 2320 5468 6572  ..        # Ther
+00039510: 6527 7320 7072 6f62 6162 6c79 2061 206e  e's probably a n
+00039520: 6561 7465 7220 7761 7920 6f66 2064 6f69  eater way of doi
+00039530: 6e67 2074 6865 206f 6273 6572 7661 626c  ng the observabl
+00039540: 6573 202d 206d 6179 6265 2061 2066 6f72  es - maybe a for
+00039550: 6d61 7474 696e 6720 6675 6e63 7469 6f6e  matting function
+00039560: 3f0a 2020 2020 2020 2020 6966 2073 656c  ?.        if sel
+00039570: 662e 5f72 6963 686e 6573 7320 6973 206e  f._richness is n
+00039580: 6f74 204e 6f6e 6520 616e 6420 7365 6c66  ot None and self
+00039590: 2e5f 7269 6368 6e65 7373 5f65 7272 2069  ._richness_err i
+000395a0: 7320 6e6f 7420 4e6f 6e65 205c 0a20 2020  s not None \.   
+000395b0: 2020 2020 2020 2020 2020 2020 2061 6e64               and
+000395c0: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
+000395d0: 7365 6c66 2e5f 7269 6368 6e65 7373 5f65  self._richness_e
+000395e0: 7272 2c20 286c 6973 742c 2074 7570 6c65  rr, (list, tuple
+000395f0: 2c20 6e64 6172 7261 7929 293a 0a20 2020  , ndarray)):.   
+00039600: 2020 2020 2020 2020 2070 7269 6e74 2822           print("
+00039610: 5269 6368 6e65 7373 202d 207b 307d c2b1  Richness - {0}..
+00039620: 7b31 7d22 2e66 6f72 6d61 7428 7365 6c66  {1}".format(self
+00039630: 2e5f 7269 6368 6e65 7373 2e72 6f75 6e64  ._richness.round
+00039640: 2832 292c 2073 656c 662e 5f72 6963 686e  (2), self._richn
+00039650: 6573 735f 6572 722e 726f 756e 6428 3229  ess_err.round(2)
+00039660: 2929 0a20 2020 2020 2020 2065 6c69 6620  )).        elif 
+00039670: 7365 6c66 2e5f 7269 6368 6e65 7373 2069  self._richness i
+00039680: 7320 6e6f 7420 4e6f 6e65 2061 6e64 2073  s not None and s
+00039690: 656c 662e 5f72 6963 686e 6573 735f 6572  elf._richness_er
+000396a0: 7220 6973 206e 6f74 204e 6f6e 6520 5c0a  r is not None \.
+000396b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000396c0: 616e 6420 6973 696e 7374 616e 6365 2873  and isinstance(s
+000396d0: 656c 662e 5f72 6963 686e 6573 735f 6572  elf._richness_er
+000396e0: 722c 2028 6c69 7374 2c20 7475 706c 652c  r, (list, tuple,
+000396f0: 206e 6461 7272 6179 2929 3a0a 2020 2020   ndarray)):.    
+00039700: 2020 2020 2020 2020 7072 696e 7428 2252          print("R
+00039710: 6963 686e 6573 7320 2d20 7b30 7d20 2d7b  ichness - {0} -{
+00039720: 317d 2b7b 327d 222e 666f 726d 6174 2873  1}+{2}".format(s
+00039730: 656c 662e 5f72 6963 686e 6573 732e 726f  elf._richness.ro
+00039740: 756e 6428 3229 2c20 7365 6c66 2e5f 7269  und(2), self._ri
+00039750: 6368 6e65 7373 5f65 7272 5b30 5d2e 726f  chness_err[0].ro
+00039760: 756e 6428 3229 2c0a 2020 2020 2020 2020  und(2),.        
+00039770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039790: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000397a0: 5f72 6963 686e 6573 735f 6572 725b 315d  _richness_err[1]
+000397b0: 2e72 6f75 6e64 2832 2929 290a 2020 2020  .round(2))).    
+000397c0: 2020 2020 656c 6966 2073 656c 662e 5f72      elif self._r
+000397d0: 6963 686e 6573 7320 6973 206e 6f74 204e  ichness is not N
+000397e0: 6f6e 6520 616e 6420 7365 6c66 2e5f 7269  one and self._ri
+000397f0: 6368 6e65 7373 5f65 7272 2069 7320 4e6f  chness_err is No
+00039800: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00039810: 7072 696e 7428 2252 6963 686e 6573 7320  print("Richness 
+00039820: 2d20 7b30 7d22 2e66 6f72 6d61 7428 7365  - {0}".format(se
+00039830: 6c66 2e5f 7269 6368 6e65 7373 2e72 6f75  lf._richness.rou
+00039840: 6e64 2832 2929 290a 0a20 2020 2020 2020  nd(2)))..       
+00039850: 2069 6620 7365 6c66 2e5f 776c 5f6d 6173   if self._wl_mas
+00039860: 7320 6973 206e 6f74 204e 6f6e 6520 616e  s is not None an
+00039870: 6420 7365 6c66 2e5f 776c 5f6d 6173 735f  d self._wl_mass_
+00039880: 6572 7220 6973 206e 6f74 204e 6f6e 6520  err is not None 
+00039890: 5c0a 2020 2020 2020 2020 2020 2020 2020  \.              
+000398a0: 2020 616e 6420 6e6f 7420 6973 696e 7374    and not isinst
+000398b0: 616e 6365 2873 656c 662e 5f77 6c5f 6d61  ance(self._wl_ma
+000398c0: 7373 5f65 7272 2c20 286c 6973 742c 2074  ss_err, (list, t
+000398d0: 7570 6c65 2c20 6e64 6172 7261 7929 293a  uple, ndarray)):
+000398e0: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
+000398f0: 6e74 2822 5765 616b 204c 656e 7369 6e67  nt("Weak Lensing
+00039900: 204d 6173 7320 2d20 7b30 7dc2 b17b 317d   Mass - {0}..{1}
+00039910: 222e 666f 726d 6174 2873 656c 662e 5f77  ".format(self._w
+00039920: 6c5f 6d61 7373 2c20 7365 6c66 2e5f 7269  l_mass, self._ri
+00039930: 6368 6e65 7373 5f65 7272 2929 0a20 2020  chness_err)).   
+00039940: 2020 2020 2065 6c69 6620 7365 6c66 2e5f       elif self._
+00039950: 776c 5f6d 6173 7320 6973 206e 6f74 204e  wl_mass is not N
+00039960: 6f6e 6520 616e 6420 7365 6c66 2e5f 776c  one and self._wl
+00039970: 5f6d 6173 735f 6572 7220 6973 206e 6f74  _mass_err is not
+00039980: 204e 6f6e 6520 5c0a 2020 2020 2020 2020   None \.        
+00039990: 2020 2020 2020 2020 616e 6420 6973 696e          and isin
+000399a0: 7374 616e 6365 2873 656c 662e 5f77 6c5f  stance(self._wl_
+000399b0: 6d61 7373 5f65 7272 2c20 286c 6973 742c  mass_err, (list,
+000399c0: 2074 7570 6c65 2c20 6e64 6172 7261 7929   tuple, ndarray)
+000399d0: 293a 0a20 2020 2020 2020 2020 2020 2070  ):.            p
+000399e0: 7269 6e74 2822 5765 616b 204c 656e 7369  rint("Weak Lensi
+000399f0: 6e67 204d 6173 7320 2d20 7b30 7d20 2d7b  ng Mass - {0} -{
+00039a00: 317d 2b7b 327d 222e 666f 726d 6174 2873  1}+{2}".format(s
+00039a10: 656c 662e 5f77 6c5f 6d61 7373 2c20 7365  elf._wl_mass, se
+00039a20: 6c66 2e5f 776c 5f6d 6173 735f 6572 725b  lf._wl_mass_err[
+00039a30: 305d 2c0a 2020 2020 2020 2020 2020 2020  0],.            
+00039a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039a70: 7365 6c66 2e5f 776c 5f6d 6173 735f 6572  self._wl_mass_er
+00039a80: 725b 315d 2929 0a20 2020 2020 2020 2065  r[1])).        e
+00039a90: 6c69 6620 7365 6c66 2e5f 776c 5f6d 6173  lif self._wl_mas
+00039aa0: 7320 6973 206e 6f74 204e 6f6e 6520 616e  s is not None an
+00039ab0: 6420 7365 6c66 2e5f 776c 5f6d 6173 735f  d self._wl_mass_
+00039ac0: 6572 7220 6973 204e 6f6e 653a 0a20 2020  err is None:.   
+00039ad0: 2020 2020 2020 2020 2070 7269 6e74 2822           print("
+00039ae0: 5765 616b 204c 656e 7369 6e67 204d 6173  Weak Lensing Mas
+00039af0: 7320 2d20 7b30 7d22 2e66 6f72 6d61 7428  s - {0}".format(
+00039b00: 7365 6c66 2e5f 776c 5f6d 6173 7329 290a  self._wl_mass)).
+00039b10: 0a20 2020 2020 2020 2069 6620 2767 6574  .        if 'get
+00039b20: 5f74 656d 7065 7261 7475 7265 2720 696e  _temperature' in
+00039b30: 2064 6972 2873 656c 6629 3a0a 2020 2020   dir(self):.    
+00039b40: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00039b50: 2020 2020 2020 2020 2020 2020 2074 7820               tx 
+00039b60: 3d20 7365 6c66 2e67 6574 5f74 656d 7065  = self.get_tempe
+00039b70: 7261 7475 7265 2827 7235 3030 272c 2027  rature('r500', '
+00039b80: 636f 6e73 7461 6e74 2a74 6261 6273 2a61  constant*tbabs*a
+00039b90: 7065 6327 292e 7661 6c75 652e 726f 756e  pec').value.roun
+00039ba0: 6428 3229 0a20 2020 2020 2020 2020 2020  d(2).           
+00039bb0: 2020 2020 2023 204a 7573 7420 6176 6572       # Just aver
+00039bc0: 6167 6520 7468 6520 756e 6365 7274 6169  age the uncertai
+00039bd0: 6e74 7920 666f 7220 7468 6973 0a20 2020  nty for this.   
+00039be0: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+00039bf0: 6e74 2822 5235 3030 2054 7820 2d20 7b30  nt("R500 Tx - {0
+00039c00: 7dc2 b17b 317d 5b6b 6556 5d22 2e66 6f72  }..{1}[keV]".for
+00039c10: 6d61 7428 7478 5b30 5d2c 2074 785b 313a  mat(tx[0], tx[1:
+00039c20: 5d2e 6d65 616e 2829 2e72 6f75 6e64 2832  ].mean().round(2
+00039c30: 2929 290a 2020 2020 2020 2020 2020 2020  ))).            
+00039c40: 6578 6365 7074 2028 4d6f 6465 6c4e 6f74  except (ModelNot
+00039c50: 4173 736f 6369 6174 6564 4572 726f 722c  AssociatedError,
+00039c60: 204e 6f50 726f 6475 6374 4176 6169 6c61   NoProductAvaila
+00039c70: 626c 6545 7272 6f72 293a 0a20 2020 2020  bleError):.     
+00039c80: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
+00039c90: 0a20 2020 2020 2020 2020 2020 2074 7279  .            try
+00039ca0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00039cb0: 2020 6c78 203d 2073 656c 662e 6765 745f    lx = self.get_
+00039cc0: 6c75 6d69 6e6f 7369 7469 6573 2827 7235  luminosities('r5
+00039cd0: 3030 272c 2027 636f 6e73 7461 6e74 2a74  00', 'constant*t
+00039ce0: 6261 6273 2a61 7065 6327 2c20 6c6f 5f65  babs*apec', lo_e
+00039cf0: 6e3d 5175 616e 7469 7479 2830 2e35 2c20  n=Quantity(0.5, 
+00039d00: 276b 6556 2729 2c0a 2020 2020 2020 2020  'keV'),.        
+00039d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039d30: 2020 2068 695f 656e 3d51 7561 6e74 6974     hi_en=Quantit
+00039d40: 7928 322e 302c 2027 6b65 5627 2929 2e74  y(2.0, 'keV')).t
+00039d50: 6f28 2731 305e 3434 2065 7267 2f73 2729  o('10^44 erg/s')
+00039d60: 2e76 616c 7565 2e72 6f75 6e64 2832 290a  .value.round(2).
+00039d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039d80: 7072 696e 7428 2252 3530 3020 302e 352d  print("R500 0.5-
+00039d90: 322e 306b 6556 204c 7820 2d20 7b30 7dc2  2.0keV Lx - {0}.
+00039da0: b17b 317d 5b65 2b34 3420 6572 672f 735d  .{1}[e+44 erg/s]
+00039db0: 222e 666f 726d 6174 286c 785b 305d 2c20  ".format(lx[0], 
+00039dc0: 6c78 5b31 3a5d 2e6d 6561 6e28 292e 726f  lx[1:].mean().ro
+00039dd0: 756e 6428 3229 2929 0a0a 2020 2020 2020  und(2)))..      
+00039de0: 2020 2020 2020 6578 6365 7074 2028 4d6f        except (Mo
+00039df0: 6465 6c4e 6f74 4173 736f 6369 6174 6564  delNotAssociated
+00039e00: 4572 726f 722c 204e 6f50 726f 6475 6374  Error, NoProduct
+00039e10: 4176 6169 6c61 626c 6545 7272 6f72 293a  AvailableError):
+00039e20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00039e30: 2070 6173 730a 2020 2020 2020 2020 7072   pass.        pr
+00039e40: 696e 7428 222d 2d2d 2d2d 2d2d 2d2d 2d2d  int("-----------
+00039e50: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00039e60: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00039e70: 2d2d 2d2d 2d2d 2d2d 2d2d 5c6e 2229 0a0a  ----------\n")..
+00039e80: 2020 2020 6465 6620 5f5f 6c65 6e5f 5f28      def __len__(
+00039e90: 7365 6c66 2920 2d3e 2069 6e74 3a0a 2020  self) -> int:.  
+00039ea0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00039eb0: 2020 4d65 7468 6f64 2074 6f20 7265 7475    Method to retu
+00039ec0: 726e 2074 6865 206c 656e 6774 6820 6f66  rn the length of
+00039ed0: 2074 6865 2070 726f 6475 6374 7320 6469   the products di
+00039ee0: 6374 696f 6e61 7279 2028 7768 6963 6820  ctionary (which 
+00039ef0: 6d65 616e 7320 7468 6520 6e75 6d62 6572  means the number
+00039f00: 206f 660a 2020 2020 2020 2020 696e 6469   of.        indi
+00039f10: 7669 6475 616c 204f 6273 4944 7320 6173  vidual ObsIDs as
+00039f20: 736f 6369 6174 6564 2077 6974 6820 7468  sociated with th
+00039f30: 6973 2073 6f75 7263 6529 2c20 7768 656e  is source), when
+00039f40: 206c 656e 2829 2069 7320 6361 6c6c 6564   len() is called
+00039f50: 206f 6e20 616e 2069 6e73 7461 6e63 6520   on an instance 
+00039f60: 6f66 2074 6869 7320 636c 6173 732e 0a0a  of this class...
+00039f70: 2020 2020 2020 2020 3a72 6574 7572 6e3a          :return:
+00039f80: 2054 6865 2069 6e74 6567 6572 206c 656e   The integer len
+00039f90: 6774 6820 6f66 2074 6865 2074 6f70 206c  gth of the top l
+00039fa0: 6576 656c 206f 6620 7468 6520 5f70 726f  evel of the _pro
+00039fb0: 6475 6374 7320 6e65 7374 6564 2064 6963  ducts nested dic
+00039fc0: 7469 6f6e 6172 792e 0a20 2020 2020 2020  tionary..       
+00039fd0: 203a 7274 7970 653a 2069 6e74 0a20 2020   :rtype: int.   
+00039fe0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00039ff0: 2072 6574 7572 6e20 6c65 6e28 7365 6c66   return len(self
+0003a000: 2e6f 6273 5f69 6473 290a 0a0a 2320 5761  .obs_ids)...# Wa
+0003a010: 7320 676f 696e 6720 746f 2077 7269 7465  s going to write
+0003a020: 2074 6869 7320 6173 2061 2073 7562 636c   this as a subcl
+0003a030: 6173 7320 6f66 2042 6173 6553 6f75 7263  ass of BaseSourc
+0003a040: 652c 2061 7320 6974 2077 696c 6c20 6265  e, as it will be
+0003a050: 6861 7665 206c 6172 6765 6c79 2074 6865  have largely the
+0003a060: 2073 616d 652c 2062 7574 2049 2064 6f6e   same, but I don
+0003a070: 2774 0a23 2020 7761 6e74 2069 7420 6465  't.#  want it de
+0003a080: 636c 6172 696e 6720 5847 4120 7072 6f64  claring XGA prod
+0003a090: 7563 7473 2066 6f72 2074 656e 7320 6f66  ucts for tens of
+0003a0a0: 2074 686f 7573 616e 6473 206f 6620 696d   thousands of im
+0003a0b0: 6167 6573 2065 7463 2e0a 2320 4173 2073  ages etc..# As s
+0003a0c0: 7563 6820 7769 6c6c 2072 6570 6c69 6361  uch will replica
+0003a0d0: 7465 2074 6865 2062 6173 6520 6675 6e63  te the base func
+0003a0e0: 7469 6f6e 616c 6974 7920 6f66 2042 6173  tionality of Bas
+0003a0f0: 6553 6f75 7263 6520 7468 6174 2077 696c  eSource that wil
+0003a100: 6c20 616c 6c6f 7720 6576 7365 6c65 6374  l allow evselect
+0003a110: 5f69 6d61 6765 2c20 6578 706d 6170 2c20  _image, expmap, 
+0003a120: 6369 6662 7569 6c64 0a23 2053 4153 2077  cifbuild.# SAS w
+0003a130: 7261 7070 6572 7320 746f 2077 6f72 6b2e  rappers to work.
+0003a140: 0a23 2054 6869 7320 646f 6573 2068 6176  .# This does hav
+0003a150: 6520 6120 6c6f 7420 6f66 2073 7472 6169  e a lot of strai
+0003a160: 6768 7420 636f 7069 6564 2063 6f64 6520  ght copied code 
+0003a170: 6672 6f6d 2042 6173 6553 6f75 7263 652c  from BaseSource,
+0003a180: 2062 7574 2049 2064 6f6e 2774 206d 696e   but I don't min
+0003a190: 6420 696e 2074 6869 7320 696e 7374 616e  d in this instan
+0003a1a0: 6365 0a63 6c61 7373 204e 756c 6c53 6f75  ce.class NullSou
+0003a1b0: 7263 653a 0a20 2020 2022 2222 0a20 2020  rce:.    """.   
+0003a1c0: 2041 2075 7365 6675 6c2c 2062 7574 2076   A useful, but v
+0003a1d0: 6572 7920 6c69 6d69 7465 642c 2073 6f75  ery limited, sou
+0003a1e0: 7263 6520 636c 6173 732e 2042 7920 6465  rce class. By de
+0003a1f0: 6661 756c 7420 7468 6973 2073 6f75 7263  fault this sourc
+0003a200: 6520 636c 6173 7320 7769 6c6c 2069 6e63  e class will inc
+0003a210: 6c75 6465 2061 6c6c 204f 6273 4944 7320  lude all ObsIDs 
+0003a220: 7072 6573 656e 7420 696e 2074 6865 0a20  present in the. 
+0003a230: 2020 2058 4741 2063 656e 7375 732c 2061     XGA census, a
+0003a240: 6e64 2061 7320 7375 6368 2063 616e 2062  nd as such can b
+0003a250: 6520 7573 6564 2066 6f72 2062 756c 6b20  e used for bulk 
+0003a260: 6765 6e65 7261 7469 6f6e 206f 6620 5341  generation of SA
+0003a270: 5320 7072 6f64 7563 7473 2e20 4974 2063  S products. It c
+0003a280: 616e 2061 6c73 6f20 6265 206d 6164 6520  an also be made 
+0003a290: 746f 206f 6e6c 7920 696e 636c 7564 650a  to only include.
+0003a2a0: 2020 2020 6365 7274 6169 6e20 4f62 7349      certain ObsI
+0003a2b0: 4473 2e0a 0a0a 2020 2020 3a70 6172 616d  Ds....    :param
+0003a2c0: 204c 6973 7420 6f62 733a 2041 6e20 6f70   List obs: An op
+0003a2d0: 7469 6f6e 616c 206c 6973 7420 6f66 204f  tional list of O
+0003a2e0: 6273 4944 7320 746f 2069 6e63 6c75 6465  bsIDs to include
+0003a2f0: 2069 6e20 7468 6520 4e75 6c6c 536f 7572   in the NullSour
+0003a300: 6365 2c20 6f74 6865 7277 6973 6520 616c  ce, otherwise al
+0003a310: 6c20 6176 6169 6c61 626c 6520 4f62 7349  l available ObsI
+0003a320: 4473 0a20 2020 2020 2020 2077 696c 6c20  Ds.        will 
+0003a330: 6265 2069 6e63 6c75 6465 642e 0a20 2020  be included..   
+0003a340: 2022 2222 0a20 2020 2064 6566 205f 5f69   """.    def __i
+0003a350: 6e69 745f 5f28 7365 6c66 2c20 6f62 733a  nit__(self, obs:
+0003a360: 204c 6973 745b 7374 725d 203d 204e 6f6e   List[str] = Non
+0003a370: 6529 3a0a 2020 2020 2020 2020 2222 220a  e):.        """.
+0003a380: 2020 2020 2020 2020 5468 6520 6d65 7468          The meth
+0003a390: 6f64 2075 7365 6420 746f 2069 6e69 7469  od used to initi
+0003a3a0: 6174 6520 7468 6520 4e75 6c6c 536f 7572  ate the NullSour
+0003a3b0: 6365 2063 6c61 7373 2e0a 2020 2020 2020  ce class..      
+0003a3c0: 2020 2222 220a 2020 2020 2020 2020 2320    """.        # 
+0003a3d0: 546f 2066 696e 6420 616c 6c20 6365 6e73  To find all cens
+0003a3e0: 7573 2065 6e74 7269 6573 2077 6974 6820  us entries with 
+0003a3f0: 6e6f 6e2d 6e61 2063 6f6f 7264 696e 6174  non-na coordinat
+0003a400: 6573 0a20 2020 2020 2020 2063 6c65 616e  es.        clean
+0003a410: 6564 5f63 656e 7375 7320 3d20 4345 4e53  ed_census = CENS
+0003a420: 5553 2e64 726f 706e 6128 290a 2020 2020  US.dropna().    
+0003a430: 2020 2020 7365 6c66 2e5f 7261 5f64 6563      self._ra_dec
+0003a440: 203d 206e 702e 6172 7261 7928 5b4e 6f6e   = np.array([Non
+0003a450: 652c 204e 6f6e 655d 290a 2020 2020 2020  e, None]).      
+0003a460: 2020 2320 5468 6520 7573 6572 2063 616e    # The user can
+0003a470: 2073 7065 6369 6679 204f 6273 4944 7320   specify ObsIDs 
+0003a480: 746f 2061 7373 6f63 6961 7465 2077 6974  to associate wit
+0003a490: 6820 7468 6520 4e75 6c6c 536f 7572 6365  h the NullSource
+0003a4a0: 2c20 6f72 2061 7373 6f63 6961 7465 2061  , or associate a
+0003a4b0: 6c6c 0a20 2020 2020 2020 2023 2020 6f66  ll.        #  of
+0003a4c0: 2074 6865 6d20 6279 206c 6561 7669 6e67   them by leaving
+0003a4d0: 2069 7420 6173 204e 6f6e 650a 2020 2020   it as None.    
+0003a4e0: 2020 2020 6966 206f 6273 2069 7320 4e6f      if obs is No
+0003a4f0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0003a500: 7365 6c66 2e5f 6e61 6d65 203d 2022 416c  self._name = "Al
+0003a510: 6c4f 6273 6572 7661 7469 6f6e 7322 0a20  lObservations". 
+0003a520: 2020 2020 2020 2020 2020 206f 6273 203d             obs =
+0003a530: 2063 6c65 616e 6564 5f63 656e 7375 735b   cleaned_census[
+0003a540: 224f 6273 4944 225d 2e76 616c 7565 730a  "ObsID"].values.
+0003a550: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0003a560: 2020 2020 2020 2020 2020 2320 4920 6b6e            # I kn
+0003a570: 6f77 2074 6869 7320 6973 2061 6e20 7567  ow this is an ug
+0003a580: 6c79 206e 6573 7465 6420 6966 2073 7461  ly nested if sta
+0003a590: 7465 6d65 6e74 732c 2062 7574 2049 206f  tements, but I o
+0003a5a0: 6e6c 7920 7761 6e74 6564 2074 6f20 7275  nly wanted to ru
+0003a5b0: 6e20 6f62 735f 6368 6563 6b20 6f6e 6365  n obs_check once
+0003a5c0: 0a20 2020 2020 2020 2020 2020 206f 6273  .            obs
+0003a5d0: 203d 206e 702e 6172 7261 7928 6f62 7329   = np.array(obs)
+0003a5e0: 0a20 2020 2020 2020 2020 2020 206f 6273  .            obs
+0003a5f0: 5f63 6865 636b 203d 205b 6f20 696e 2063  _check = [o in c
+0003a600: 6c65 616e 6564 5f63 656e 7375 735b 224f  leaned_census["O
+0003a610: 6273 4944 225d 2e76 616c 7565 7320 666f  bsID"].values fo
+0003a620: 7220 6f20 696e 206f 6273 5d0a 2020 2020  r o in obs].    
+0003a630: 2020 2020 2020 2020 2320 4966 2061 6c6c          # If all
+0003a640: 2075 7365 7220 656e 7465 7265 6420 4f62   user entered Ob
+0003a650: 7349 4473 2061 7265 2069 6e20 7468 6520  sIDs are in the 
+0003a660: 6365 6e73 7573 2c20 7468 656e 2061 6c6c  census, then all
+0003a670: 2069 7320 6669 6e65 0a20 2020 2020 2020   is fine.       
+0003a680: 2020 2020 2069 6620 616c 6c28 6f62 735f       if all(obs_
+0003a690: 6368 6563 6b29 3a0a 2020 2020 2020 2020  check):.        
+0003a6a0: 2020 2020 2020 2020 7365 6c66 2e5f 6e61          self._na
+0003a6b0: 6d65 203d 2022 7b7d 4f62 7365 7276 6174  me = "{}Observat
+0003a6c0: 696f 6e73 222e 666f 726d 6174 286c 656e  ions".format(len
+0003a6d0: 286f 6273 2929 0a20 2020 2020 2020 2020  (obs)).         
+0003a6e0: 2020 2023 2049 6620 7468 6579 2061 7265     # If they are
+0003a6f0: 6e27 7420 616c 6c20 696e 2074 6865 2063  n't all in the c
+0003a700: 656e 7375 7320 7468 656e 2074 6861 7420  ensus then that 
+0003a710: 6973 2064 6563 6964 6564 6c79 206e 6f74  is decidedly not
+0003a720: 2066 696e 650a 2020 2020 2020 2020 2020   fine.          
+0003a730: 2020 656c 6966 206e 6f74 2061 6c6c 286f    elif not all(o
+0003a740: 6273 5f63 6865 636b 293a 0a20 2020 2020  bs_check):.     
+0003a750: 2020 2020 2020 2020 2020 206e 6f74 5f76             not_v
+0003a760: 616c 6964 203d 206e 702e 6172 7261 7928  alid = np.array(
+0003a770: 6f62 7329 5b7e 6e70 2e61 7272 6179 286f  obs)[~np.array(o
+0003a780: 6273 5f63 6865 636b 295d 0a20 2020 2020  bs_check)].     
+0003a790: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+0003a7a0: 2056 616c 7565 4572 726f 7228 2254 6865   ValueError("The
+0003a7b0: 2066 6f6c 6c6f 7769 6e67 2061 7265 206e   following are n
+0003a7c0: 6f74 2070 7265 7365 6e74 2069 6e20 7468  ot present in th
+0003a7d0: 6520 5847 4120 6365 6e73 7573 2c20 220a  e XGA census, ".
+0003a7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a800: 2022 7b7d 222e 666f 726d 6174 2822 2c20   "{}".format(", 
+0003a810: 222e 6a6f 696e 286e 6f74 5f76 616c 6964  ".join(not_valid
+0003a820: 2929 290a 0a20 2020 2020 2020 2023 2046  )))..        # F
+0003a830: 696e 6420 6f75 7420 7768 6963 680a 2020  ind out which.  
+0003a840: 2020 2020 2020 696e 7374 7275 6d65 6e74        instrument
+0003a850: 7320 3d20 7b6f 3a20 5b5d 2066 6f72 206f  s = {o: [] for o
+0003a860: 2069 6e20 6f62 737d 0a20 2020 2020 2020   in obs}.       
+0003a870: 2066 6f72 206f 2069 6e20 6f62 733a 0a20   for o in obs:. 
+0003a880: 2020 2020 2020 2020 2020 2069 6620 636c             if cl
+0003a890: 6561 6e65 645f 6365 6e73 7573 5b63 6c65  eaned_census[cle
+0003a8a0: 616e 6564 5f63 656e 7375 735b 224f 6273  aned_census["Obs
+0003a8b0: 4944 225d 203d 3d20 6f5d 5b22 5553 455f  ID"] == o]["USE_
+0003a8c0: 504e 225d 2e76 616c 7565 735b 305d 3a0a  PN"].values[0]:.
+0003a8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a8e0: 696e 7374 7275 6d65 6e74 735b 6f5d 2e61  instruments[o].a
+0003a8f0: 7070 656e 6428 2270 6e22 290a 2020 2020  ppend("pn").    
+0003a900: 2020 2020 2020 2020 6966 2063 6c65 616e          if clean
+0003a910: 6564 5f63 656e 7375 735b 636c 6561 6e65  ed_census[cleane
+0003a920: 645f 6365 6e73 7573 5b22 4f62 7349 4422  d_census["ObsID"
+0003a930: 5d20 3d3d 206f 5d5b 2255 5345 5f4d 4f53  ] == o]["USE_MOS
+0003a940: 3122 5d2e 7661 6c75 6573 5b30 5d3a 0a20  1"].values[0]:. 
+0003a950: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0003a960: 6e73 7472 756d 656e 7473 5b6f 5d2e 6170  nstruments[o].ap
+0003a970: 7065 6e64 2822 6d6f 7331 2229 0a20 2020  pend("mos1").   
+0003a980: 2020 2020 2020 2020 2069 6620 636c 6561           if clea
+0003a990: 6e65 645f 6365 6e73 7573 5b63 6c65 616e  ned_census[clean
+0003a9a0: 6564 5f63 656e 7375 735b 224f 6273 4944  ed_census["ObsID
+0003a9b0: 225d 203d 3d20 6f5d 5b22 5553 455f 4d4f  "] == o]["USE_MO
+0003a9c0: 5332 225d 2e76 616c 7565 735b 305d 3a0a  S2"].values[0]:.
+0003a9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a9e0: 696e 7374 7275 6d65 6e74 735b 6f5d 2e61  instruments[o].a
+0003a9f0: 7070 656e 6428 226d 6f73 3222 290a 0a20  ppend("mos2").. 
+0003aa00: 2020 2020 2020 2023 2054 6869 7320 6368         # This ch
+0003aa10: 6563 6b73 2074 6861 7420 7468 6520 6f62  ecks that the ob
+0003aa20: 7365 7276 6174 696f 6e73 2068 6176 6520  servations have 
+0003aa30: 6174 206c 6561 7374 206f 6e65 2075 7361  at least one usa
+0003aa40: 626c 6520 696e 7374 7275 6d65 6e74 0a20  ble instrument. 
+0003aa50: 2020 2020 2020 2073 656c 662e 5f6f 6273         self._obs
+0003aa60: 203d 205b 6f20 666f 7220 6f20 696e 206f   = [o for o in o
+0003aa70: 6273 2069 6620 6c65 6e28 696e 7374 7275  bs if len(instru
+0003aa80: 6d65 6e74 735b 6f5d 2920 3e20 305d 0a20  ments[o]) > 0]. 
+0003aa90: 2020 2020 2020 2073 656c 662e 5f69 6e73         self._ins
+0003aaa0: 7472 756d 656e 7473 203d 207b 6f3a 2069  truments = {o: i
+0003aab0: 6e73 7472 756d 656e 7473 5b6f 5d20 666f  nstruments[o] fo
+0003aac0: 7220 6f20 696e 2073 656c 662e 5f6f 6273  r o in self._obs
+0003aad0: 2069 6620 6c65 6e28 696e 7374 7275 6d65   if len(instrume
+0003aae0: 6e74 735b 6f5d 2920 3e20 307d 0a0a 2020  nts[o]) > 0}..  
+0003aaf0: 2020 2020 2020 2320 4865 7265 2077 6520        # Here we 
+0003ab00: 6368 6563 6b20 746f 206d 616b 6520 7375  check to make su
+0003ab10: 7265 2074 6861 7420 7468 6572 6520 6973  re that there is
+0003ab20: 2061 7420 6c65 6173 7420 6f6e 6520 7661   at least one va
+0003ab30: 6c69 6420 4f62 7349 4420 7265 6d61 696e  lid ObsID remain
+0003ab40: 696e 670a 2020 2020 2020 2020 6966 206c  ing.        if l
+0003ab50: 656e 2873 656c 662e 5f6f 6273 2920 3d3d  en(self._obs) ==
+0003ab60: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+0003ab70: 7261 6973 6520 4e6f 5661 6c69 644f 6273  raise NoValidObs
+0003ab80: 6572 7661 7469 6f6e 7345 7272 6f72 2822  ervationsError("
+0003ab90: 4166 7465 7220 6368 6563 6b73 2075 7369  After checks usi
+0003aba0: 6e67 2074 6865 2058 4741 2063 656e 7375  ng the XGA censu
+0003abb0: 732c 2061 6c6c 204f 6273 4944 7320 6173  s, all ObsIDs as
+0003abc0: 736f 6369 6174 6564 2077 6974 6820 7468  sociated with th
+0003abd0: 6973 2022 0a20 2020 2020 2020 2020 2020  is ".           
+0003abe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003abf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ac00: 224e 756c 6c53 6f75 7263 6520 6172 6520  "NullSource are 
+0003ac10: 636f 6e73 6964 6572 6564 2075 6e75 7361  considered unusa
+0003ac20: 626c 652e 2229 0a0a 2020 2020 2020 2020  ble.")..        
+0003ac30: 2320 5468 6520 5341 5320 6765 6e65 7261  # The SAS genera
+0003ac40: 7469 6f6e 2072 6f75 7469 6e65 206d 6967  tion routine mig
+0003ac50: 6874 206e 6565 6420 7468 6973 2069 6e66  ht need this inf
+0003ac60: 6f72 6d61 7469 6f6e 0a20 2020 2020 2020  ormation.       
+0003ac70: 2073 656c 662e 5f61 7474 5f66 696c 6573   self._att_files
+0003ac80: 203d 207b 6f3a 2078 6761 5f63 6f6e 665b   = {o: xga_conf[
+0003ac90: 2258 4d4d 5f46 494c 4553 225d 5b22 6174  "XMM_FILES"]["at
+0003aca0: 7469 7475 6465 5f66 696c 6522 5d2e 666f  titude_file"].fo
+0003acb0: 726d 6174 286f 6273 5f69 643d 6f29 2066  rmat(obs_id=o) f
+0003acc0: 6f72 206f 2069 6e20 7365 6c66 2e5f 6f62  or o in self._ob
+0003acd0: 737d 0a0a 2020 2020 2020 2020 2320 4e65  s}..        # Ne
+0003ace0: 6564 2074 6865 2065 7665 6e74 206c 6973  ed the event lis
+0003acf0: 7420 6f62 6a65 6374 7320 6465 636c 6172  t objects declar
+0003ad00: 6564 2075 6e66 6f72 7475 6e61 7465 6c79  ed unfortunately
+0003ad10: 0a20 2020 2020 2020 2073 656c 662e 5f70  .        self._p
+0003ad20: 726f 6475 6374 7320 3d20 7b6f 3a20 7b7d  roducts = {o: {}
+0003ad30: 2066 6f72 206f 2069 6e20 7365 6c66 2e5f   for o in self._
+0003ad40: 6f62 737d 0a20 2020 2020 2020 2066 6f72  obs}.        for
+0003ad50: 206f 2069 6e20 7365 6c66 2e5f 6f62 733a   o in self._obs:
+0003ad60: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+0003ad70: 2069 6e73 7420 696e 2073 656c 662e 5f69   inst in self._i
+0003ad80: 6e73 7472 756d 656e 7473 5b6f 5d3a 0a20  nstruments[o]:. 
+0003ad90: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0003ada0: 7674 5f6b 6579 203d 2022 636c 6561 6e5f  vt_key = "clean_
+0003adb0: 7b7d 5f65 7674 7322 2e66 6f72 6d61 7428  {}_evts".format(
+0003adc0: 696e 7374 290a 2020 2020 2020 2020 2020  inst).          
+0003add0: 2020 2020 2020 6576 745f 6669 6c65 203d        evt_file =
+0003ade0: 2078 6761 5f63 6f6e 665b 2258 4d4d 5f46   xga_conf["XMM_F
+0003adf0: 494c 4553 225d 5b65 7674 5f6b 6579 5d2e  ILES"][evt_key].
+0003ae00: 666f 726d 6174 286f 6273 5f69 643d 6f29  format(obs_id=o)
+0003ae10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003ae20: 2073 656c 662e 5f70 726f 6475 6374 735b   self._products[
+0003ae30: 6f5d 5b69 6e73 745d 203d 207b 2265 7665  o][inst] = {"eve
+0003ae40: 6e74 7322 3a20 4576 656e 744c 6973 7428  nts": EventList(
+0003ae50: 6576 745f 6669 6c65 2c20 6f62 735f 6964  evt_file, obs_id
+0003ae60: 3d6f 2c20 696e 7374 7275 6d65 6e74 3d69  =o, instrument=i
+0003ae70: 6e73 742c 2073 7464 6f75 745f 7374 723d  nst, stdout_str=
+0003ae80: 2222 2c0a 2020 2020 2020 2020 2020 2020  "",.            
+0003ae90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003aea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003aeb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003aec0: 2020 2073 7464 6572 725f 7374 723d 2222     stderr_str=""
+0003aed0: 2c20 6765 6e5f 636d 643d 2222 297d 0a0a  , gen_cmd="")}..
+0003aee0: 2020 2020 2020 2020 2320 5468 6973 2069          # This i
+0003aef0: 7320 6120 7175 6575 6520 666f 7220 7072  s a queue for pr
+0003af00: 6f64 7563 7473 2074 6f20 6265 2067 656e  oducts to be gen
+0003af10: 6572 6174 6564 2066 6f72 2074 6869 7320  erated for this 
+0003af20: 736f 7572 6365 2c20 7769 6c6c 2062 6520  source, will be 
+0003af30: 6120 6e75 6d70 7920 6172 7261 7920 696e  a numpy array in
+0003af40: 2070 7261 6374 6973 652e 0a20 2020 2020   practise..     
+0003af50: 2020 2023 2049 7465 6d73 2069 6e20 7468     # Items in th
+0003af60: 6520 7361 6d65 2072 6f77 2077 696c 6c20  e same row will 
+0003af70: 616c 6c20 6265 2067 656e 6572 6174 6564  all be generated
+0003af80: 2069 6e20 7061 7261 6c6c 656c 2c20 7768   in parallel, wh
+0003af90: 6572 6561 7320 6974 656d 7320 696e 2074  ereas items in t
+0003afa0: 6865 2073 616d 6520 636f 6c75 6d6e 2077  he same column w
+0003afb0: 696c 6c0a 2020 2020 2020 2020 2320 6265  ill.        # be
+0003afc0: 2063 6f6d 6269 6e65 6420 696e 746f 2061   combined into a
+0003afd0: 2063 6f6d 6d61 6e64 2073 7461 636b 2061   command stack a
+0003afe0: 6e64 2072 756e 2069 6e20 6f72 6465 722e  nd run in order.
+0003aff0: 0a20 2020 2020 2020 2073 656c 662e 7175  .        self.qu
+0003b000: 6575 6520 3d20 4e6f 6e65 0a20 2020 2020  eue = None.     
+0003b010: 2020 2023 2041 6e6f 7468 6572 2061 7474     # Another att
+0003b020: 7269 6275 7465 2064 6573 7469 6e65 6420  ribute destined 
+0003b030: 746f 2062 6520 616e 2061 7272 6179 2c20  to be an array, 
+0003b040: 7769 6c6c 2063 6f6e 7461 696e 2074 6865  will contain the
+0003b050: 206f 7574 7075 7420 7479 7065 206f 6620   output type of 
+0003b060: 6561 6368 2063 6f6d 6d61 6e64 2073 7562  each command sub
+0003b070: 6d69 7474 6564 2074 6f0a 2020 2020 2020  mitted to.      
+0003b080: 2020 2320 7468 6520 7175 6575 6520 6172    # the queue ar
+0003b090: 7261 792e 0a20 2020 2020 2020 2073 656c  ray..        sel
+0003b0a0: 662e 7175 6575 655f 7479 7065 203d 204e  f.queue_type = N
+0003b0b0: 6f6e 650a 2020 2020 2020 2020 2320 5468  one.        # Th
+0003b0c0: 6973 2063 6f6e 7461 696e 7320 616e 2061  is contains an a
+0003b0d0: 7272 6179 206f 6620 7468 6520 7061 7468  rray of the path
+0003b0e0: 7320 6f66 2074 6865 2066 696e 616c 206f  s of the final o
+0003b0f0: 7574 7075 7420 6f66 2065 6163 6820 636f  utput of each co
+0003b100: 6d6d 616e 6420 696e 2074 6865 2071 7565  mmand in the que
+0003b110: 7565 0a20 2020 2020 2020 2073 656c 662e  ue.        self.
+0003b120: 7175 6575 655f 7061 7468 203d 204e 6f6e  queue_path = Non
+0003b130: 650a 2020 2020 2020 2020 2320 5468 6973  e.        # This
+0003b140: 2063 6f6e 7461 696e 7320 616e 2061 7272   contains an arr
+0003b150: 6179 206f 6620 7468 6520 6578 7472 6120  ay of the extra 
+0003b160: 696e 666f 726d 6174 696f 6e20 6e65 6564  information need
+0003b170: 6564 2074 6f20 696e 7374 616e 7469 6174  ed to instantiat
+0003b180: 6520 636c 6173 730a 2020 2020 2020 2020  e class.        
+0003b190: 2320 6166 7465 7220 7468 6520 5341 5320  # after the SAS 
+0003b1a0: 636f 6d6d 616e 6420 6861 7320 7275 6e0a  command has run.
+0003b1b0: 2020 2020 2020 2020 7365 6c66 2e71 7565          self.que
+0003b1c0: 7565 5f65 7874 7261 5f69 6e66 6f20 3d20  ue_extra_info = 
+0003b1d0: 4e6f 6e65 0a0a 2020 2020 6465 6620 6765  None..    def ge
+0003b1e0: 745f 6174 745f 6669 6c65 2873 656c 662c  t_att_file(self,
+0003b1f0: 206f 6273 5f69 643a 2073 7472 2920 2d3e   obs_id: str) ->
+0003b200: 2073 7472 3a0a 2020 2020 2020 2020 2222   str:.        ""
+0003b210: 220a 2020 2020 2020 2020 4665 7463 6865  ".        Fetche
+0003b220: 7320 7468 6520 7061 7468 2074 6f20 7468  s the path to th
+0003b230: 6520 6174 7469 7475 6465 2066 696c 6520  e attitude file 
+0003b240: 666f 7220 616e 2058 4d4d 206f 6273 6572  for an XMM obser
+0003b250: 7661 7469 6f6e 2e0a 0a20 2020 2020 2020  vation...       
+0003b260: 203a 7061 7261 6d20 6f62 735f 6964 3a20   :param obs_id: 
+0003b270: 5468 6520 4f62 7349 4420 746f 2066 6574  The ObsID to fet
+0003b280: 6368 2074 6865 2061 7474 6974 7564 6520  ch the attitude 
+0003b290: 6669 6c65 2066 6f72 2e0a 2020 2020 2020  file for..      
+0003b2a0: 2020 3a72 6574 7572 6e3a 2054 6865 2070    :return: The p
+0003b2b0: 6174 6820 746f 2074 6865 2061 7474 6974  ath to the attit
+0003b2c0: 7564 6520 6669 6c65 2e0a 2020 2020 2020  ude file..      
+0003b2d0: 2020 3a72 7479 7065 3a20 7374 720a 2020    :rtype: str.  
+0003b2e0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0003b2f0: 2020 6966 206f 6273 5f69 6420 6e6f 7420    if obs_id not 
+0003b300: 696e 2073 656c 662e 5f70 726f 6475 6374  in self._product
+0003b310: 733a 0a20 2020 2020 2020 2020 2020 2072  s:.            r
+0003b320: 6169 7365 204e 6f74 4173 736f 6369 6174  aise NotAssociat
+0003b330: 6564 4572 726f 7228 227b 6f7d 2069 7320  edError("{o} is 
+0003b340: 6e6f 7420 6173 736f 6369 6174 6564 2077  not associated w
+0003b350: 6974 6820 7b73 7d22 2e66 6f72 6d61 7428  ith {s}".format(
+0003b360: 6f3d 6f62 735f 6964 2c20 733d 7365 6c66  o=obs_id, s=self
+0003b370: 2e6e 616d 6529 290a 2020 2020 2020 2020  .name)).        
+0003b380: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0003b390: 2020 7265 7475 726e 2073 656c 662e 5f61    return self._a
+0003b3a0: 7474 5f66 696c 6573 5b6f 6273 5f69 645d  tt_files[obs_id]
+0003b3b0: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
+0003b3c0: 2020 2020 6465 6620 6f62 735f 6964 7328      def obs_ids(
+0003b3d0: 7365 6c66 2920 2d3e 204c 6973 745b 7374  self) -> List[st
+0003b3e0: 725d 3a0a 2020 2020 2020 2020 2222 220a  r]:.        """.
+0003b3f0: 2020 2020 2020 2020 5072 6f70 6572 7479          Property
+0003b400: 2067 6574 7465 7220 666f 7220 4f62 7349   getter for ObsI
+0003b410: 4473 2061 7373 6f63 6961 7465 6420 7769  Ds associated wi
+0003b420: 7468 2074 6869 7320 736f 7572 6365 2074  th this source t
+0003b430: 6861 7420 6172 6520 636f 6e66 6972 6d65  hat are confirme
+0003b440: 6420 746f 2068 6176 6520 6576 656e 7473  d to have events
+0003b450: 2066 696c 6573 2e0a 0a20 2020 2020 2020   files...       
+0003b460: 203a 7265 7475 726e 3a20 4120 6c69 7374   :return: A list
+0003b470: 206f 6620 7468 6520 6173 736f 6369 6174   of the associat
+0003b480: 6564 2058 4d4d 204f 6273 4944 732e 0a20  ed XMM ObsIDs.. 
+0003b490: 2020 2020 2020 203a 7274 7970 653a 204c         :rtype: L
+0003b4a0: 6973 745b 7374 725d 0a20 2020 2020 2020  ist[str].       
+0003b4b0: 2022 2222 0a20 2020 2020 2020 2072 6574   """.        ret
+0003b4c0: 7572 6e20 7365 6c66 2e5f 6f62 730a 0a20  urn self._obs.. 
+0003b4d0: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
+0003b4e0: 2064 6566 2069 6e73 7472 756d 656e 7473   def instruments
+0003b4f0: 2873 656c 6629 202d 3e20 4469 6374 3a0a  (self) -> Dict:.
+0003b500: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0003b510: 2020 2020 4120 7072 6f70 6572 7479 206f      A property o
+0003b520: 6620 6120 736f 7572 6365 2074 6861 7420  f a source that 
+0003b530: 6465 7461 696c 7320 7768 6963 6820 696e  details which in
+0003b540: 7374 7275 6d65 6e74 7320 6861 7665 2076  struments have v
+0003b550: 616c 6964 2064 6174 6120 666f 7220 7768  alid data for wh
+0003b560: 6963 6820 6f62 7365 7276 6174 696f 6e73  ich observations
+0003b570: 2e0a 0a20 2020 2020 2020 203a 7265 7475  ...        :retu
+0003b580: 726e 3a20 4120 6469 6374 696f 6e61 7279  rn: A dictionary
+0003b590: 206f 6620 4f62 7349 4473 2061 6e64 2074   of ObsIDs and t
+0003b5a0: 6865 6972 2061 7373 6f63 6961 7465 6420  heir associated 
+0003b5b0: 7661 6c69 6420 696e 7374 7275 6d65 6e74  valid instrument
+0003b5c0: 732e 0a20 2020 2020 2020 203a 7274 7970  s..        :rtyp
+0003b5d0: 653a 2044 6963 740a 2020 2020 2020 2020  e: Dict.        
+0003b5e0: 2222 220a 2020 2020 2020 2020 7265 7475  """.        retu
+0003b5f0: 726e 2073 656c 662e 5f69 6e73 7472 756d  rn self._instrum
+0003b600: 656e 7473 0a0a 2020 2020 6465 6620 7570  ents..    def up
+0003b610: 6461 7465 5f71 7565 7565 2873 656c 662c  date_queue(self,
+0003b620: 2063 6d64 5f61 7272 3a20 6e70 2e6e 6461   cmd_arr: np.nda
+0003b630: 7272 6179 2c20 705f 7479 7065 5f61 7272  rray, p_type_arr
+0003b640: 3a20 6e70 2e6e 6461 7272 6179 2c20 705f  : np.ndarray, p_
+0003b650: 7061 7468 5f61 7272 3a20 6e70 2e6e 6461  path_arr: np.nda
+0003b660: 7272 6179 2c0a 2020 2020 2020 2020 2020  rray,.          
+0003b670: 2020 2020 2020 2020 2020 2065 7874 7261             extra
+0003b680: 5f69 6e66 6f3a 206e 702e 6e64 6172 7261  _info: np.ndarra
+0003b690: 792c 2073 7461 636b 3a20 626f 6f6c 203d  y, stack: bool =
+0003b6a0: 2046 616c 7365 293a 0a20 2020 2020 2020   False):.       
+0003b6b0: 2022 2222 0a20 2020 2020 2020 2053 6d61   """.        Sma
+0003b6c0: 6c6c 2066 756e 6374 696f 6e20 746f 2075  ll function to u
+0003b6d0: 7064 6174 6520 7468 6520 6e75 6d70 7920  pdate the numpy 
+0003b6e0: 6172 7261 7920 7468 6174 206d 616b 6573  array that makes
+0003b6f0: 2075 7020 7468 6520 7175 6575 6520 6f66   up the queue of
+0003b700: 2070 726f 6475 6374 7320 746f 2062 6520   products to be 
+0003b710: 6765 6e65 7261 7465 642e 0a0a 2020 2020  generated...    
+0003b720: 2020 2020 3a70 6172 616d 206e 702e 6e64      :param np.nd
+0003b730: 6172 7261 7920 636d 645f 6172 723a 2041  array cmd_arr: A
+0003b740: 7272 6179 2063 6f6e 7461 696e 696e 6720  rray containing 
+0003b750: 5341 5320 636f 6d6d 616e 6473 2e0a 2020  SAS commands..  
+0003b760: 2020 2020 2020 3a70 6172 616d 206e 702e        :param np.
+0003b770: 6e64 6172 7261 7920 705f 7479 7065 5f61  ndarray p_type_a
+0003b780: 7272 3a20 4172 7261 7920 6f66 2070 726f  rr: Array of pro
+0003b790: 6475 6374 2074 7970 6520 6964 656e 7469  duct type identi
+0003b7a0: 6669 6572 7320 666f 7220 7468 6520 7072  fiers for the pr
+0003b7b0: 6f64 7563 7473 2067 656e 6572 6174 6564  oducts generated
+0003b7c0: 0a20 2020 2020 2020 2020 2020 2062 7920  .            by 
+0003b7d0: 7468 6520 636d 6420 6172 7261 792e 2065  the cmd array. e
+0003b7e0: 2e67 2e20 696d 6167 6520 6f72 2065 7870  .g. image or exp
+0003b7f0: 6d61 702e 0a20 2020 2020 2020 203a 7061  map..        :pa
+0003b800: 7261 6d20 6e70 2e6e 6461 7272 6179 2070  ram np.ndarray p
+0003b810: 5f70 6174 685f 6172 723a 2041 7272 6179  _path_arr: Array
+0003b820: 206f 6620 6669 6e61 6c20 7072 6f64 7563   of final produc
+0003b830: 7420 7061 7468 7320 6966 2063 6d64 2069  t paths if cmd i
+0003b840: 7320 7375 6363 6573 7366 756c 0a20 2020  s successful.   
+0003b850: 2020 2020 203a 7061 7261 6d20 6e70 2e6e       :param np.n
+0003b860: 6461 7272 6179 2065 7874 7261 5f69 6e66  darray extra_inf
+0003b870: 6f3a 2041 7272 6179 206f 6620 6578 7472  o: Array of extr
+0003b880: 6120 696e 666f 726d 6174 696f 6e20 6469  a information di
+0003b890: 6374 696f 6e61 7269 6573 0a20 2020 2020  ctionaries.     
+0003b8a0: 2020 203a 7061 7261 6d20 7374 6163 6b3a     :param stack:
+0003b8b0: 2053 686f 756c 6420 7468 6573 6520 636f   Should these co
+0003b8c0: 6d6d 616e 6473 2062 6520 6578 6563 7574  mmands be execut
+0003b8d0: 6564 2061 6674 6572 2061 2070 7265 6365  ed after a prece
+0003b8e0: 6469 6e67 206c 696e 6520 6f66 2063 6f6d  ding line of com
+0003b8f0: 6d61 6e64 732c 0a20 2020 2020 2020 2020  mands,.         
+0003b900: 2020 206f 7220 6174 2074 6865 2073 616d     or at the sam
+0003b910: 6520 7469 6d65 2e0a 2020 2020 2020 2020  e time..        
+0003b920: 3a72 6574 7572 6e3a 0a20 2020 2020 2020  :return:.       
+0003b930: 2022 2222 0a20 2020 2020 2020 2069 6620   """.        if 
+0003b940: 7365 6c66 2e71 7565 7565 2069 7320 4e6f  self.queue is No
+0003b950: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0003b960: 2320 4920 636f 756c 6420 6861 7665 2064  # I could have d
+0003b970: 6f6e 6520 616c 6c20 6f66 2074 6865 7365  one all of these
+0003b980: 2069 6e20 6f6e 6520 6172 7261 7920 7769   in one array wi
+0003b990: 7468 2033 2064 696d 656e 7369 6f6e 732c  th 3 dimensions,
+0003b9a0: 2062 7574 2066 656c 7420 7468 6973 2077   but felt this w
+0003b9b0: 6173 2065 6173 6965 7220 746f 2072 6561  as easier to rea
+0003b9c0: 640a 2020 2020 2020 2020 2020 2020 2320  d.            # 
+0003b9d0: 616e 6420 7769 7468 206e 6f20 7265 616c  and with no real
+0003b9e0: 2070 6572 666f 726d 616e 6365 2070 656e   performance pen
+0003b9f0: 616c 7479 0a20 2020 2020 2020 2020 2020  alty.           
+0003ba00: 2073 656c 662e 7175 6575 6520 3d20 636d   self.queue = cm
+0003ba10: 645f 6172 720a 2020 2020 2020 2020 2020  d_arr.          
+0003ba20: 2020 7365 6c66 2e71 7565 7565 5f74 7970    self.queue_typ
+0003ba30: 6520 3d20 705f 7479 7065 5f61 7272 0a20  e = p_type_arr. 
+0003ba40: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0003ba50: 7175 6575 655f 7061 7468 203d 2070 5f70  queue_path = p_p
+0003ba60: 6174 685f 6172 720a 2020 2020 2020 2020  ath_arr.        
+0003ba70: 2020 2020 7365 6c66 2e71 7565 7565 5f65      self.queue_e
+0003ba80: 7874 7261 5f69 6e66 6f20 3d20 6578 7472  xtra_info = extr
+0003ba90: 615f 696e 666f 0a20 2020 2020 2020 2065  a_info.        e
+0003baa0: 6c69 6620 7374 6163 6b3a 0a20 2020 2020  lif stack:.     
 0003bab0: 2020 2020 2020 2073 656c 662e 7175 6575         self.queu
-0003bac0: 655f 7479 7065 203d 206e 702e 6170 7065  e_type = np.appe
-0003bad0: 6e64 2873 656c 662e 7175 6575 655f 7479  nd(self.queue_ty
-0003bae0: 7065 2c20 705f 7479 7065 5f61 7272 2c20  pe, p_type_arr, 
-0003baf0: 6178 6973 3d30 290a 2020 2020 2020 2020  axis=0).        
-0003bb00: 2020 2020 7365 6c66 2e71 7565 7565 5f70      self.queue_p
-0003bb10: 6174 6820 3d20 6e70 2e61 7070 656e 6428  ath = np.append(
-0003bb20: 7365 6c66 2e71 7565 7565 5f70 6174 682c  self.queue_path,
-0003bb30: 2070 5f70 6174 685f 6172 722c 2061 7869   p_path_arr, axi
-0003bb40: 733d 3029 0a20 2020 2020 2020 2020 2020  s=0).           
-0003bb50: 2073 656c 662e 7175 6575 655f 6578 7472   self.queue_extr
-0003bb60: 615f 696e 666f 203d 206e 702e 6170 7065  a_info = np.appe
-0003bb70: 6e64 2873 656c 662e 7175 6575 655f 6578  nd(self.queue_ex
-0003bb80: 7472 615f 696e 666f 2c20 6578 7472 615f  tra_info, extra_
-0003bb90: 696e 666f 2c20 6178 6973 3d30 290a 0a20  info, axis=0).. 
-0003bba0: 2020 2064 6566 2067 6574 5f71 7565 7565     def get_queue
-0003bbb0: 2873 656c 6629 202d 3e20 5475 706c 655b  (self) -> Tuple[
-0003bbc0: 4c69 7374 5b73 7472 5d2c 204c 6973 745b  List[str], List[
-0003bbd0: 7374 725d 2c20 4c69 7374 5b4c 6973 745b  str], List[List[
-0003bbe0: 7374 725d 5d2c 204c 6973 745b 6469 6374  str]], List[dict
-0003bbf0: 5d5d 3a0a 2020 2020 2020 2020 2222 220a  ]]:.        """.
-0003bc00: 2020 2020 2020 2020 4361 6c6c 696e 6720          Calling 
-0003bc10: 7468 6973 2069 6e64 6963 6174 6573 2074  this indicates t
-0003bc20: 6861 7420 7468 6520 7175 6575 6520 6973  hat the queue is
-0003bc30: 2061 626f 7574 2074 6f20 6265 2070 726f   about to be pro
-0003bc40: 6365 7373 6564 2c20 736f 2074 6869 7320  cessed, so this 
-0003bc50: 6675 6e63 7469 6f6e 2063 6f6d 6269 6e65  function combine
-0003bc60: 7320 5341 530a 2020 2020 2020 2020 636f  s SAS.        co
-0003bc70: 6d6d 616e 6473 2061 6c6f 6e67 2063 6f6c  mmands along col
-0003bc80: 756d 6e73 2028 636f 6d6d 616e 6420 7374  umns (command st
-0003bc90: 6163 6b73 292c 2061 6e64 2072 6574 7572  acks), and retur
-0003bca0: 6e73 204e 2053 4153 2063 6f6d 6d61 6e64  ns N SAS command
-0003bcb0: 7320 746f 2062 6520 7275 6e20 636f 6e63  s to be run conc
-0003bcc0: 7572 7265 6e74 6c79 2c0a 2020 2020 2020  urrently,.      
-0003bcd0: 2020 7768 6572 6520 4e20 6973 2074 6865    where N is the
-0003bce0: 206e 756d 6265 7220 6f66 2063 6f6c 756d   number of colum
-0003bcf0: 6e73 2e0a 0a20 2020 2020 2020 203a 7265  ns...        :re
-0003bd00: 7475 726e 3a20 4c69 7374 206f 6620 7374  turn: List of st
-0003bd10: 7269 6e67 732c 2077 6865 7265 2074 6865  rings, where the
-0003bd20: 2073 7472 696e 6773 2061 7265 2062 6173   strings are bas
-0003bd30: 6820 636f 6d6d 616e 6473 2074 6f20 7275  h commands to ru
-0003bd40: 6e20 5341 5320 7072 6f63 6564 7572 6573  n SAS procedures
-0003bd50: 2c20 616e 6f74 6865 720a 2020 2020 2020  , another.      
-0003bd60: 2020 2020 2020 6c69 7374 206f 6620 7374        list of st
-0003bd70: 7269 6e67 732c 2077 6865 7265 2074 6865  rings, where the
-0003bd80: 2073 7472 696e 6773 2061 7265 2065 7870   strings are exp
-0003bd90: 6563 7465 6420 6f75 7470 7574 2074 7970  ected output typ
-0003bda0: 6573 2066 6f72 2074 6865 2063 6f6d 6d61  es for the comma
-0003bdb0: 6e64 732c 2061 206c 6973 7420 6f66 0a20  nds, a list of. 
-0003bdc0: 2020 2020 2020 2020 2020 206c 6973 7473             lists
-0003bdd0: 206f 6620 7374 7269 6e67 732c 2077 6865   of strings, whe
-0003bde0: 7265 2074 6865 2073 7472 696e 6773 2061  re the strings a
-0003bdf0: 7265 2065 7870 6563 7465 6420 6f75 7470  re expected outp
-0003be00: 7574 2070 6174 6873 2066 6f72 2070 726f  ut paths for pro
-0003be10: 6475 6374 7320 6f66 2074 6865 2053 4153  ducts of the SAS
-0003be20: 2063 6f6d 6d61 6e64 732e 0a20 2020 2020   commands..     
-0003be30: 2020 203a 7274 7970 653a 2054 7570 6c65     :rtype: Tuple
-0003be40: 5b4c 6973 745b 7374 725d 2c20 4c69 7374  [List[str], List
-0003be50: 5b73 7472 5d2c 204c 6973 745b 4c69 7374  [str], List[List
-0003be60: 5b73 7472 5d5d 5d0a 2020 2020 2020 2020  [str]]].        
-0003be70: 2222 220a 2020 2020 2020 2020 6966 2073  """.        if s
-0003be80: 656c 662e 7175 6575 6520 6973 204e 6f6e  elf.queue is Non
-0003be90: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
-0003bea0: 2054 6869 7320 7265 7475 726e 7320 656d   This returns em
-0003beb0: 7074 7920 6c69 7374 7320 6966 2074 6865  pty lists if the
-0003bec0: 2071 7565 7565 2069 7320 756e 6465 6669   queue is undefi
-0003bed0: 6e65 640a 2020 2020 2020 2020 2020 2020  ned.            
-0003bee0: 7072 6f63 6573 7365 645f 636d 6473 203d  processed_cmds =
-0003bef0: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
-0003bf00: 7479 7065 7320 3d20 5b5d 0a20 2020 2020  types = [].     
-0003bf10: 2020 2020 2020 2070 6174 6873 203d 205b         paths = [
-0003bf20: 5d0a 2020 2020 2020 2020 2020 2020 6578  ].            ex
-0003bf30: 7472 6173 203d 205b 5d0a 2020 2020 2020  tras = [].      
-0003bf40: 2020 656c 6966 206c 656e 2873 656c 662e    elif len(self.
-0003bf50: 7175 6575 652e 7368 6170 6529 203d 3d20  queue.shape) == 
-0003bf60: 3120 6f72 2073 656c 662e 7175 6575 652e  1 or self.queue.
-0003bf70: 7368 6170 655b 315d 203c 3d20 313a 0a20  shape[1] <= 1:. 
-0003bf80: 2020 2020 2020 2020 2020 2070 726f 6365             proce
-0003bf90: 7373 6564 5f63 6d64 7320 3d20 6c69 7374  ssed_cmds = list
-0003bfa0: 2873 656c 662e 7175 6575 6529 0a20 2020  (self.queue).   
-0003bfb0: 2020 2020 2020 2020 2074 7970 6573 203d           types =
-0003bfc0: 206c 6973 7428 7365 6c66 2e71 7565 7565   list(self.queue
-0003bfd0: 5f74 7970 6529 0a20 2020 2020 2020 2020  _type).         
-0003bfe0: 2020 2070 6174 6873 203d 205b 5b73 7472     paths = [[str
-0003bff0: 2870 6174 6829 5d20 666f 7220 7061 7468  (path)] for path
-0003c000: 2069 6e20 7365 6c66 2e71 7565 7565 5f70   in self.queue_p
-0003c010: 6174 685d 0a20 2020 2020 2020 2020 2020  ath].           
-0003c020: 2065 7874 7261 7320 3d20 6c69 7374 2873   extras = list(s
-0003c030: 656c 662e 7175 6575 655f 6578 7472 615f  elf.queue_extra_
-0003c040: 696e 666f 290a 2020 2020 2020 2020 656c  info).        el
-0003c050: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0003c060: 7072 6f63 6573 7365 645f 636d 6473 203d  processed_cmds =
-0003c070: 205b 223b 222e 6a6f 696e 2863 6f6c 2920   [";".join(col) 
-0003c080: 666f 7220 636f 6c20 696e 2073 656c 662e  for col in self.
-0003c090: 7175 6575 652e 545d 0a20 2020 2020 2020  queue.T].       
-0003c0a0: 2020 2020 2074 7970 6573 203d 206c 6973       types = lis
-0003c0b0: 7428 7365 6c66 2e71 7565 7565 5f74 7970  t(self.queue_typ
-0003c0c0: 655b 2d31 2c20 3a5d 290a 2020 2020 2020  e[-1, :]).      
-0003c0d0: 2020 2020 2020 7061 7468 7320 3d20 5b6c        paths = [l
-0003c0e0: 6973 7428 636f 6c2e 6173 7479 7065 2873  ist(col.astype(s
-0003c0f0: 7472 2929 2066 6f72 2063 6f6c 2069 6e20  tr)) for col in 
-0003c100: 7365 6c66 2e71 7565 7565 5f70 6174 682e  self.queue_path.
-0003c110: 545d 0a20 2020 2020 2020 2020 2020 2065  T].            e
-0003c120: 7874 7261 7320 3d20 5b5d 0a20 2020 2020  xtras = [].     
-0003c130: 2020 2020 2020 2066 6f72 2063 6f6c 2069         for col i
-0003c140: 6e20 7365 6c66 2e71 7565 7565 5f70 6174  n self.queue_pat
-0003c150: 682e 543a 0a20 2020 2020 2020 2020 2020  h.T:.           
-0003c160: 2020 2020 2023 2054 6869 7320 6e65 7374       # This nest
-0003c170: 6564 2064 6963 7469 6f6e 6172 7920 636f  ed dictionary co
-0003c180: 6d70 7265 6865 6e73 696f 6e20 636f 6d62  mprehension comb
-0003c190: 696e 6573 2061 2063 6f6c 756d 6e20 6f66  ines a column of
-0003c1a0: 2065 7874 7261 2069 6e66 6f72 6d61 7469   extra informati
-0003c1b0: 6f6e 0a20 2020 2020 2020 2020 2020 2020  on.             
-0003c1c0: 2020 2023 2064 6963 7469 6f6e 6172 6965     # dictionarie
-0003c1d0: 7320 696e 746f 206f 6e65 2c20 666f 7220  s into one, for 
-0003c1e0: 6561 7365 206f 6620 6163 6365 7373 2e0a  ease of access..
-0003c1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003c200: 636f 6d62 5f65 7874 7261 203d 207b 6b3a  comb_extra = {k:
-0003c210: 2076 2066 6f72 2065 7874 5f64 6963 7420   v for ext_dict 
-0003c220: 696e 2063 6f6c 2066 6f72 206b 2c20 7620  in col for k, v 
-0003c230: 696e 2065 7874 5f64 6963 742e 6974 656d  in ext_dict.item
-0003c240: 7328 297d 0a20 2020 2020 2020 2020 2020  s()}.           
-0003c250: 2020 2020 2065 7874 7261 732e 6170 7065       extras.appe
-0003c260: 6e64 2863 6f6d 625f 6578 7472 6129 0a0a  nd(comb_extra)..
-0003c270: 2020 2020 2020 2020 2320 5468 6973 2069          # This i
-0003c280: 7320 6f6e 6c79 206c 696b 656c 7920 746f  s only likely to
-0003c290: 2062 6520 6361 6c6c 6564 2077 6865 6e20   be called when 
-0003c2a0: 7072 6f63 6573 7369 6e67 2069 7320 6265  processing is be
-0003c2b0: 6769 6e6e 696e 672c 2073 6f20 7468 6973  ginning, so this
-0003c2c0: 2077 696c 6c20 7769 7065 2074 6865 2071   will wipe the q
-0003c2d0: 7565 7565 2e0a 2020 2020 2020 2020 7365  ueue..        se
-0003c2e0: 6c66 2e71 7565 7565 203d 204e 6f6e 650a  lf.queue = None.
-0003c2f0: 2020 2020 2020 2020 7365 6c66 2e71 7565          self.que
-0003c300: 7565 5f74 7970 6520 3d20 4e6f 6e65 0a20  ue_type = None. 
-0003c310: 2020 2020 2020 2073 656c 662e 7175 6575         self.queu
-0003c320: 655f 7061 7468 203d 204e 6f6e 650a 2020  e_path = None.  
-0003c330: 2020 2020 2020 7365 6c66 2e71 7565 7565        self.queue
-0003c340: 5f65 7874 7261 5f69 6e66 6f20 3d20 4e6f  _extra_info = No
-0003c350: 6e65 0a20 2020 2020 2020 2023 2054 6865  ne.        # The
-0003c360: 2072 6574 7572 6e65 6420 7061 7468 7320   returned paths 
-0003c370: 6172 6520 6c69 7374 7320 6f66 2073 7472  are lists of str
-0003c380: 696e 6773 2062 6563 6175 7365 2077 6520  ings because we 
-0003c390: 7761 6e74 2074 6f20 696e 636c 7564 6520  want to include 
-0003c3a0: 6576 6572 7920 6669 6c65 2069 6e20 6120  every file in a 
-0003c3b0: 7374 6163 6b20 746f 2062 6520 6162 6c65  stack to be able
-0003c3c0: 0a20 2020 2020 2020 2023 2074 6f20 6368  .        # to ch
-0003c3d0: 6563 6b20 7468 6174 2065 7869 7374 730a  eck that exists.
-0003c3e0: 2020 2020 2020 2020 7265 7475 726e 2070          return p
-0003c3f0: 726f 6365 7373 6564 5f63 6d64 732c 2074  rocessed_cmds, t
-0003c400: 7970 6573 2c20 7061 7468 732c 2065 7874  ypes, paths, ext
-0003c410: 7261 730a 0a20 2020 2064 6566 2075 7064  ras..    def upd
-0003c420: 6174 655f 7072 6f64 7563 7473 2873 656c  ate_products(sel
-0003c430: 662c 2070 726f 645f 6f62 6a3a 2042 6173  f, prod_obj: Bas
-0003c440: 6550 726f 6475 6374 293a 0a20 2020 2020  eProduct):.     
-0003c450: 2020 2022 2222 0a20 2020 2020 2020 2054     """.        T
-0003c460: 6869 7320 6d65 7468 6f64 2077 696c 6c20  his method will 
-0003c470: 4f4e 4c59 2073 746f 7265 2069 6d61 6765  ONLY store image
-0003c480: 7320 616e 6420 6578 706f 7375 7265 206d  s and exposure m
-0003c490: 6170 732e 2049 6465 616c 6c79 2049 2077  aps. Ideally I w
-0003c4a0: 6f75 6c64 6e27 7420 7374 6f72 6520 7468  ouldn't store th
-0003c4b0: 656d 2061 7320 7072 6f64 7563 7420 6f62  em as product ob
-0003c4c0: 6a65 6374 730a 2020 2020 2020 2020 6174  jects.        at
-0003c4d0: 2061 6c6c 2c20 6275 7420 756e 666f 7274   all, but unfort
-0003c4e0: 756e 6174 656c 7920 6578 706f 7375 7265  unately exposure
-0003c4f0: 206d 6170 7320 7265 7175 6972 6520 616e   maps require an
-0003c500: 2069 6d61 6765 2074 6f20 6265 2067 656e   image to be gen
-0003c510: 6572 6174 6564 2e20 556e 6c69 6b65 2061  erated. Unlike a
-0003c520: 6c6c 206f 7468 6572 2073 6f75 7263 6520  ll other source 
-0003c530: 636c 6173 7365 732c 0a20 2020 2020 2020  classes,.       
-0003c540: 2072 6174 656d 6170 7320 7769 6c6c 206e   ratemaps will n
-0003c550: 6f74 2062 6520 6765 6e65 7261 7465 6420  ot be generated 
-0003c560: 7768 656e 206d 6174 6368 696e 6720 696d  when matching im
-0003c570: 6167 6573 2061 6e64 2065 7870 6f73 7572  ages and exposur
-0003c580: 6520 6d61 7073 2061 7265 2061 6464 6564  e maps are added
-0003c590: 2e0a 0a20 2020 2020 2020 203a 7061 7261  ...        :para
-0003c5a0: 6d20 4261 7365 5072 6f64 7563 7420 7072  m BaseProduct pr
-0003c5b0: 6f64 5f6f 626a 3a20 5468 6520 6e65 7720  od_obj: The new 
-0003c5c0: 7072 6f64 7563 7420 6f62 6a65 6374 2074  product object t
-0003c5d0: 6f20 6265 2061 6464 6564 2074 6f20 7468  o be added to th
-0003c5e0: 6520 736f 7572 6365 206f 626a 6563 742e  e source object.
-0003c5f0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0003c600: 2020 2020 2069 6620 6e6f 7420 6973 696e       if not isin
-0003c610: 7374 616e 6365 2870 726f 645f 6f62 6a2c  stance(prod_obj,
-0003c620: 2028 4261 7365 5072 6f64 7563 742c 2042   (BaseProduct, B
-0003c630: 6173 6541 6767 7265 6761 7465 5072 6f64  aseAggregateProd
-0003c640: 7563 7429 2920 616e 6420 7072 6f64 5f6f  uct)) and prod_o
-0003c650: 626a 2069 7320 6e6f 7420 4e6f 6e65 3a0a  bj is not None:.
-0003c660: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0003c670: 6520 5479 7065 4572 726f 7228 224f 6e6c  e TypeError("Onl
-0003c680: 7920 7072 6f64 7563 7420 6f62 6a65 6374  y product object
-0003c690: 7320 6361 6e20 6265 2061 7373 6967 6e65  s can be assigne
-0003c6a0: 6420 746f 2073 6f75 7263 6573 2e22 290a  d to sources.").
-0003c6b0: 2020 2020 2020 2020 656c 6966 2070 726f          elif pro
-0003c6c0: 645f 6f62 6a2e 7479 7065 2021 3d20 2769  d_obj.type != 'i
-0003c6d0: 6d61 6765 2720 616e 6420 7072 6f64 5f6f  mage' and prod_o
-0003c6e0: 626a 2e74 7970 6520 213d 2027 6578 706d  bj.type != 'expm
-0003c6f0: 6170 273a 0a20 2020 2020 2020 2020 2020  ap':.           
-0003c700: 2072 6169 7365 2054 7970 6545 7272 6f72   raise TypeError
-0003c710: 2822 4f6e 6c79 2069 6d61 6765 7320 616e  ("Only images an
-0003c720: 6420 6578 706f 7375 7265 206d 6170 7320  d exposure maps 
-0003c730: 6361 6e20 6265 2073 746f 7265 6420 696e  can be stored in
-0003c740: 2061 204e 756c 6c53 6f75 7263 652c 207b   a NullSource, {
-0003c750: 7d20 6f62 6a65 6374 7320 220a 2020 2020  } objects ".    
-0003c760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003c770: 2020 2020 2020 2020 2263 616e 6e6f 7422          "cannot"
-0003c780: 2e66 6f72 6d61 7428 7072 6f64 5f6f 626a  .format(prod_obj
-0003c790: 2e74 7970 6529 290a 0a20 2020 2020 2020  .type))..       
-0003c7a0: 2069 6620 7072 6f64 5f6f 626a 2069 7320   if prod_obj is 
-0003c7b0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-0003c7c0: 2020 2020 2020 656e 5f62 6e64 7320 3d20        en_bnds = 
-0003c7d0: 7072 6f64 5f6f 626a 2e65 6e65 7267 795f  prod_obj.energy_
-0003c7e0: 626f 756e 6473 0a20 2020 2020 2020 2020  bounds.         
-0003c7f0: 2020 2065 7874 7261 5f6b 6579 203d 2022     extra_key = "
-0003c800: 626f 756e 645f 7b6c 7d2d 7b75 7d22 2e66  bound_{l}-{u}".f
-0003c810: 6f72 6d61 7428 6c3d 666c 6f61 7428 656e  ormat(l=float(en
-0003c820: 5f62 6e64 735b 305d 2e76 616c 7565 292c  _bnds[0].value),
-0003c830: 2075 3d66 6c6f 6174 2865 6e5f 626e 6473   u=float(en_bnds
-0003c840: 5b31 5d2e 7661 6c75 6529 290a 2020 2020  [1].value)).    
-0003c850: 2020 2020 2020 2020 2320 4173 2074 6865          # As the
-0003c860: 2065 7874 7261 5f6b 6579 2076 6172 6961   extra_key varia
-0003c870: 626c 6520 6361 6e20 6265 2061 6c74 6572  ble can be alter
-0003c880: 6564 2069 6620 7468 6520 496d 6167 6520  ed if the Image 
-0003c890: 6973 2050 5346 2063 6f72 7265 6374 6564  is PSF corrected
-0003c8a0: 2c20 4927 6c6c 2061 6c73 6f20 6d61 6b65  , I'll also make
-0003c8b0: 0a20 2020 2020 2020 2020 2020 2023 2020  .            #  
-0003c8c0: 7468 6973 2076 6172 6961 626c 6520 7769  this variable wi
-0003c8d0: 7468 206a 7573 7420 7468 6520 656e 6572  th just the ener
-0003c8e0: 6779 206b 6579 0a20 2020 2020 2020 2020  gy key.         
-0003c8f0: 2020 2065 6e5f 6b65 7920 3d20 2262 6f75     en_key = "bou
-0003c900: 6e64 5f7b 6c7d 2d7b 757d 222e 666f 726d  nd_{l}-{u}".form
-0003c910: 6174 286c 3d66 6c6f 6174 2865 6e5f 626e  at(l=float(en_bn
-0003c920: 6473 5b30 5d2e 7661 6c75 6529 2c20 753d  ds[0].value), u=
-0003c930: 666c 6f61 7428 656e 5f62 6e64 735b 315d  float(en_bnds[1]
-0003c940: 2e76 616c 7565 2929 0a0a 2020 2020 2020  .value))..      
-0003c950: 2020 2020 2020 2320 5365 636f 6e64 6172        # Secondar
-0003c960: 7920 6368 6563 6b69 6e67 2073 7465 7020  y checking step 
-0003c970: 6e6f 7720 4927 7665 2061 6464 6564 2050  now I've added P
-0003c980: 5346 2063 6f72 7265 6374 696f 6e0a 2020  SF correction.  
-0003c990: 2020 2020 2020 2020 2020 6966 2074 7970            if typ
-0003c9a0: 6528 7072 6f64 5f6f 626a 2920 3d3d 2049  e(prod_obj) == I
-0003c9b0: 6d61 6765 2061 6e64 2070 726f 645f 6f62  mage and prod_ob
-0003c9c0: 6a2e 7073 665f 636f 7272 6563 7465 643a  j.psf_corrected:
-0003c9d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003c9e0: 2065 7874 7261 5f6b 6579 202b 3d20 225f   extra_key += "_
-0003c9f0: 2220 2b20 7072 6f64 5f6f 626a 2e70 7366  " + prod_obj.psf
-0003ca00: 5f6d 6f64 656c 202b 2022 5f22 202b 2073  _model + "_" + s
-0003ca10: 7472 2870 726f 645f 6f62 6a2e 7073 665f  tr(prod_obj.psf_
-0003ca20: 6269 6e73 2920 2b20 225f 2220 2b20 7072  bins) + "_" + pr
-0003ca30: 6f64 5f6f 626a 2e70 7366 5f61 6c67 6f72  od_obj.psf_algor
-0003ca40: 6974 686d 202b 205c 0a20 2020 2020 2020  ithm + \.       
-0003ca50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ca60: 2020 2020 2020 7374 7228 7072 6f64 5f6f        str(prod_o
-0003ca70: 626a 2e70 7366 5f69 7465 7261 7469 6f6e  bj.psf_iteration
-0003ca80: 7329 0a0a 2020 2020 2020 2020 2020 2020  s)..            
-0003ca90: 2320 416c 6c20 696e 666f 726d 6174 696f  # All informatio
-0003caa0: 6e20 6162 6f75 7420 7768 6572 6520 746f  n about where to
-0003cab0: 2070 6c61 6365 2069 7420 696e 206f 7572   place it in our
-0003cac0: 2073 746f 7261 6765 2068 6965 7261 7263   storage hierarc
-0003cad0: 6879 2063 616e 2062 6520 7075 6c6c 6564  hy can be pulled
-0003cae0: 2066 726f 6d20 7468 6520 7072 6f64 7563   from the produc
-0003caf0: 740a 2020 2020 2020 2020 2020 2020 2320  t.            # 
-0003cb00: 6f62 6a65 6374 2069 7473 656c 660a 2020  object itself.  
-0003cb10: 2020 2020 2020 2020 2020 6f62 735f 6964            obs_id
-0003cb20: 203d 2070 726f 645f 6f62 6a2e 6f62 735f   = prod_obj.obs_
-0003cb30: 6964 0a20 2020 2020 2020 2020 2020 2069  id.            i
-0003cb40: 6e73 7420 3d20 7072 6f64 5f6f 626a 2e69  nst = prod_obj.i
-0003cb50: 6e73 7472 756d 656e 740a 2020 2020 2020  nstrument.      
-0003cb60: 2020 2020 2020 705f 7479 7065 203d 2070        p_type = p
-0003cb70: 726f 645f 6f62 6a2e 7479 7065 0a0a 2020  rod_obj.type..  
-0003cb80: 2020 2020 2020 2020 2020 2320 446f 7562            # Doub
-0003cb90: 6c65 2063 6865 636b 2074 6861 7420 736f  le check that so
-0003cba0: 6d65 7468 696e 6720 6973 2074 7279 696e  mething is tryin
-0003cbb0: 6720 746f 2061 6464 2070 726f 6475 6374  g to add product
-0003cbc0: 7320 6672 6f6d 2061 6e6f 7468 6572 2073  s from another s
-0003cbd0: 6f75 7263 6520 746f 2074 6865 2063 7572  ource to the cur
-0003cbe0: 7265 6e74 206f 6e65 2e0a 2020 2020 2020  rent one..      
-0003cbf0: 2020 2020 2020 6966 206f 6273 5f69 6420        if obs_id 
-0003cc00: 213d 2022 636f 6d62 696e 6564 2220 616e  != "combined" an
-0003cc10: 6420 6f62 735f 6964 206e 6f74 2069 6e20  d obs_id not in 
-0003cc20: 7365 6c66 2e5f 7072 6f64 7563 7473 3a0a  self._products:.
-0003cc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003cc40: 7261 6973 6520 4e6f 7441 7373 6f63 6961  raise NotAssocia
-0003cc50: 7465 6445 7272 6f72 2822 7b6f 7d20 6973  tedError("{o} is
-0003cc60: 206e 6f74 2061 7373 6f63 6961 7465 6420   not associated 
-0003cc70: 7769 7468 2074 6869 7320 6e75 6c6c 2073  with this null s
-0003cc80: 6f75 7263 652e 222e 666f 726d 6174 286f  ource.".format(o
-0003cc90: 3d6f 6273 5f69 6429 290a 2020 2020 2020  =obs_id)).      
-0003cca0: 2020 2020 2020 656c 6966 2069 6e73 7420        elif inst 
-0003ccb0: 213d 2022 636f 6d62 696e 6564 2220 616e  != "combined" an
-0003ccc0: 6420 696e 7374 206e 6f74 2069 6e20 7365  d inst not in se
-0003ccd0: 6c66 2e5f 7072 6f64 7563 7473 5b6f 6273  lf._products[obs
-0003cce0: 5f69 645d 3a0a 2020 2020 2020 2020 2020  _id]:.          
-0003ccf0: 2020 2020 2020 7261 6973 6520 4e6f 7441        raise NotA
-0003cd00: 7373 6f63 6961 7465 6445 7272 6f72 280a  ssociatedError(.
-0003cd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003cd20: 2020 2020 227b 697d 2069 7320 6e6f 7420      "{i} is not 
-0003cd30: 6173 736f 6369 6174 6564 2077 6974 6820  associated with 
-0003cd40: 584d 4d20 6f62 7365 7276 6174 696f 6e20  XMM observation 
-0003cd50: 7b6f 7d22 2e66 6f72 6d61 7428 693d 696e  {o}".format(i=in
-0003cd60: 7374 2c20 6f3d 6f62 735f 6964 2929 0a0a  st, o=obs_id))..
-0003cd70: 2020 2020 2020 2020 2020 2020 6966 2065              if e
-0003cd80: 7874 7261 5f6b 6579 206e 6f74 2069 6e20  xtra_key not in 
-0003cd90: 7365 6c66 2e5f 7072 6f64 7563 7473 5b6f  self._products[o
-0003cda0: 6273 5f69 645d 5b69 6e73 745d 3a0a 2020  bs_id][inst]:.  
-0003cdb0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-0003cdc0: 6c66 2e5f 7072 6f64 7563 7473 5b6f 6273  lf._products[obs
-0003cdd0: 5f69 645d 5b69 6e73 745d 5b65 7874 7261  _id][inst][extra
-0003cde0: 5f6b 6579 5d20 3d20 7b7d 0a20 2020 2020  _key] = {}.     
-0003cdf0: 2020 2020 2020 2073 656c 662e 5f70 726f         self._pro
-0003ce00: 6475 6374 735b 6f62 735f 6964 5d5b 696e  ducts[obs_id][in
-0003ce10: 7374 5d5b 6578 7472 615f 6b65 795d 5b70  st][extra_key][p
-0003ce20: 5f74 7970 655d 203d 2070 726f 645f 6f62  _type] = prod_ob
-0003ce30: 6a0a 0a20 2020 2064 6566 2067 6574 5f70  j..    def get_p
-0003ce40: 726f 6475 6374 7328 7365 6c66 2c20 705f  roducts(self, p_
-0003ce50: 7479 7065 3a20 7374 722c 206f 6273 5f69  type: str, obs_i
-0003ce60: 643a 2073 7472 203d 204e 6f6e 652c 2069  d: str = None, i
-0003ce70: 6e73 743a 2073 7472 203d 204e 6f6e 652c  nst: str = None,
-0003ce80: 2065 7874 7261 5f6b 6579 3a20 7374 7220   extra_key: str 
-0003ce90: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-0003cea0: 2020 2020 2020 2020 2020 2020 206a 7573               jus
-0003ceb0: 745f 6f62 6a3a 2062 6f6f 6c20 3d20 5472  t_obj: bool = Tr
-0003cec0: 7565 2920 2d3e 204c 6973 745b 4261 7365  ue) -> List[Base
-0003ced0: 5072 6f64 7563 745d 3a0a 2020 2020 2020  Product]:.      
-0003cee0: 2020 2222 220a 2020 2020 2020 2020 5468    """.        Th
-0003cef0: 6973 2069 7320 7468 6520 6765 7474 6572  is is the getter
-0003cf00: 2066 6f72 2074 6865 2070 726f 6475 6374   for the product
-0003cf10: 7320 6461 7461 2073 7472 7563 7475 7265  s data structure
-0003cf20: 206f 6620 536f 7572 6365 206f 626a 6563   of Source objec
-0003cf30: 7473 2e20 5061 7373 696e 6720 6120 2770  ts. Passing a 'p
-0003cf40: 726f 6475 6374 2074 7970 6527 0a20 2020  roduct type'.   
-0003cf50: 2020 2020 2073 7563 6820 6173 2027 6576       such as 'ev
-0003cf60: 656e 7473 2720 6f72 2027 696d 6167 6573  ents' or 'images
-0003cf70: 2720 7769 6c6c 2072 6574 7572 6e20 6576  ' will return ev
-0003cf80: 6572 7920 6d61 7463 6869 6e67 2065 6e74  ery matching ent
-0003cf90: 7279 2069 6e20 7468 6520 7072 6f64 7563  ry in the produc
-0003cfa0: 7473 2064 6174 6120 7374 7275 6374 7572  ts data structur
-0003cfb0: 652e 0a0a 2020 2020 2020 2020 3a70 6172  e...        :par
-0003cfc0: 616d 2073 7472 2070 5f74 7970 653a 2050  am str p_type: P
-0003cfd0: 726f 6475 6374 2074 7970 6520 6964 656e  roduct type iden
-0003cfe0: 7469 6669 6572 2e20 652e 672e 2069 6d61  tifier. e.g. ima
-0003cff0: 6765 206f 7220 6578 706d 6170 2e0a 2020  ge or expmap..  
-0003d000: 2020 2020 2020 3a70 6172 616d 2073 7472        :param str
-0003d010: 206f 6273 5f69 643a 204f 7074 696f 6e61   obs_id: Optiona
-0003d020: 6c6c 792c 2061 2073 7065 6369 6669 6320  lly, a specific 
-0003d030: 6f62 735f 6964 2074 6f20 7365 6172 6368  obs_id to search
-0003d040: 2063 616e 2062 6520 7375 7070 6c69 6564   can be supplied
-0003d050: 2e0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
-0003d060: 2073 7472 2069 6e73 743a 204f 7074 696f   str inst: Optio
-0003d070: 6e61 6c6c 792c 2061 2073 7065 6369 6669  nally, a specifi
-0003d080: 6320 696e 7374 7275 6d65 6e74 2074 6f20  c instrument to 
-0003d090: 7365 6172 6368 2063 616e 2062 6520 7375  search can be su
-0003d0a0: 7070 6c69 6564 2e0a 2020 2020 2020 2020  pplied..        
-0003d0b0: 3a70 6172 616d 2073 7472 2065 7874 7261  :param str extra
-0003d0c0: 5f6b 6579 3a20 4f70 7469 6f6e 616c 6c79  _key: Optionally
-0003d0d0: 2c20 616e 2065 7874 7261 206b 6579 2028  , an extra key (
-0003d0e0: 6c69 6b65 2061 6e20 656e 6572 6779 2062  like an energy b
-0003d0f0: 6f75 6e64 2920 6361 6e20 6265 2073 7570  ound) can be sup
-0003d100: 706c 6965 642e 0a20 2020 2020 2020 203a  plied..        :
-0003d110: 7061 7261 6d20 626f 6f6c 206a 7573 745f  param bool just_
-0003d120: 6f62 6a3a 2041 2062 6f6f 6c65 616e 2066  obj: A boolean f
-0003d130: 6c61 6720 7468 6174 2063 6f6e 7472 6f6c  lag that control
-0003d140: 7320 7768 6574 6865 7220 7468 6973 206d  s whether this m
-0003d150: 6574 686f 6420 7265 7475 726e 7320 6a75  ethod returns ju
-0003d160: 7374 2074 6865 2070 726f 6475 6374 206f  st the product o
-0003d170: 626a 6563 7473 2c0a 2020 2020 2020 2020  bjects,.        
-0003d180: 2020 2020 6f72 2074 6865 206f 7468 6572      or the other
-0003d190: 2069 6e66 6f72 6d61 7469 6f6e 2074 6861   information tha
-0003d1a0: 7420 676f 6573 2077 6974 6820 6974 206c  t goes with it l
-0003d1b0: 696b 6520 4f62 7349 4420 616e 6420 696e  ike ObsID and in
-0003d1c0: 7374 7275 6d65 6e74 2e0a 2020 2020 2020  strument..      
-0003d1d0: 2020 3a72 6574 7572 6e3a 204c 6973 7420    :return: List 
-0003d1e0: 6f66 206d 6174 6368 696e 6720 7072 6f64  of matching prod
-0003d1f0: 7563 7473 2e0a 2020 2020 2020 2020 3a72  ucts..        :r
-0003d200: 7479 7065 3a20 4c69 7374 5b42 6173 6550  type: List[BaseP
-0003d210: 726f 6475 6374 5d0a 2020 2020 2020 2020  roduct].        
-0003d220: 2222 220a 0a20 2020 2020 2020 2064 6566  """..        def
-0003d230: 2075 6e70 6163 6b5f 6c69 7374 2874 6f5f   unpack_list(to_
-0003d240: 756e 7061 636b 3a20 6c69 7374 293a 0a20  unpack: list):. 
-0003d250: 2020 2020 2020 2020 2020 2022 2222 0a20             """. 
-0003d260: 2020 2020 2020 2020 2020 2041 2072 6563             A rec
-0003d270: 7572 7369 7665 2066 756e 6374 696f 6e20  ursive function 
-0003d280: 746f 2067 6f20 7468 726f 7567 6820 6576  to go through ev
-0003d290: 6572 7920 6c61 7965 7220 6f66 2061 206e  ery layer of a n
-0003d2a0: 6573 7465 6420 6c69 7374 2061 6e64 2066  ested list and f
-0003d2b0: 6c61 7474 656e 2069 7420 616c 6c20 6f75  latten it all ou
-0003d2c0: 742e 2049 740a 2020 2020 2020 2020 2020  t. It.          
-0003d2d0: 2020 646f 6573 6e27 7420 7265 7475 726e    doesn't return
-0003d2e0: 2061 6e79 7468 696e 6720 6265 6361 7573   anything becaus
-0003d2f0: 6520 746f 206d 616b 6520 6c69 6665 2065  e to make life e
-0003d300: 6173 6965 7220 7468 6520 2772 6573 756c  asier the 'resul
-0003d310: 7473 2720 6172 6520 6170 7065 6e64 6564  ts' are appended
-0003d320: 2074 6f20 6120 7661 7269 6162 6c65 0a20   to a variable. 
-0003d330: 2020 2020 2020 2020 2020 2069 6e20 7468             in th
-0003d340: 6520 6e61 6d65 7370 6163 6520 6162 6f76  e namespace abov
-0003d350: 6520 7468 6973 206f 6e65 2e0a 0a20 2020  e this one...   
-0003d360: 2020 2020 2020 2020 203a 7061 7261 6d20           :param 
-0003d370: 6c69 7374 2074 6f5f 756e 7061 636b 3a20  list to_unpack: 
-0003d380: 5468 6520 6c69 7374 2074 6861 7420 6e65  The list that ne
-0003d390: 6564 7320 756e 7061 636b 696e 672e 0a20  eds unpacking.. 
-0003d3a0: 2020 2020 2020 2020 2020 2022 2222 0a20             """. 
-0003d3b0: 2020 2020 2020 2020 2020 2023 204d 7573             # Mus
-0003d3c0: 7420 6974 6572 6174 6520 7468 726f 7567  t iterate throug
-0003d3d0: 6820 7468 6520 6769 7665 6e20 6c69 7374  h the given list
-0003d3e0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-0003d3f0: 2065 6e74 7279 2069 6e20 746f 5f75 6e70   entry in to_unp
-0003d400: 6163 6b3a 0a20 2020 2020 2020 2020 2020  ack:.           
-0003d410: 2020 2020 2023 2049 6620 7468 6520 6375       # If the cu
-0003d420: 7272 656e 7420 656c 656d 656e 7420 6973  rrent element is
-0003d430: 206e 6f74 2061 206c 6973 7420 7468 656e   not a list then
-0003d440: 2061 6c6c 2069 7320 6368 696c 6c2c 2074   all is chill, t
-0003d450: 6869 7320 656c 656d 656e 7420 6973 2072  his element is r
-0003d460: 6561 6479 2066 6f72 2061 7070 656e 6469  eady for appendi
-0003d470: 6e67 0a20 2020 2020 2020 2020 2020 2020  ng.             
-0003d480: 2020 2023 2074 6f20 7468 6520 6669 6e61     # to the fina
-0003d490: 6c20 6c69 7374 0a20 2020 2020 2020 2020  l list.         
-0003d4a0: 2020 2020 2020 2069 6620 6e6f 7420 6973         if not is
-0003d4b0: 696e 7374 616e 6365 2865 6e74 7279 2c20  instance(entry, 
-0003d4c0: 6c69 7374 293a 0a20 2020 2020 2020 2020  list):.         
-0003d4d0: 2020 2020 2020 2020 2020 206f 7574 2e61             out.a
-0003d4e0: 7070 656e 6428 656e 7472 7929 0a20 2020  ppend(entry).   
-0003d4f0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-0003d500: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0003d510: 2020 2020 2020 2023 2049 6620 7468 6520         # If the 
-0003d520: 6375 7272 656e 7420 656c 656d 656e 7420  current element 
-0003d530: 4953 2061 206c 6973 742c 2074 6865 6e20  IS a list, then 
-0003d540: 6f62 7669 6f75 736c 7920 7765 2073 7469  obviously we sti
-0003d550: 6c6c 2068 6176 6520 6d6f 7265 2075 6e70  ll have more unp
-0003d560: 6163 6b69 6e67 2074 6f20 646f 2c0a 2020  acking to do,.  
-0003d570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d580: 2020 2320 736f 2077 6520 6361 6c6c 2074    # so we call t
-0003d590: 6869 7320 6675 6e63 7469 6f6e 2072 6563  his function rec
-0003d5a0: 7572 7369 7665 6c79 2e0a 2020 2020 2020  ursively..      
-0003d5b0: 2020 2020 2020 2020 2020 2020 2020 756e                un
-0003d5c0: 7061 636b 5f6c 6973 7428 656e 7472 7929  pack_list(entry)
-0003d5d0: 0a0a 2020 2020 2020 2020 6966 206f 6273  ..        if obs
-0003d5e0: 5f69 6420 6e6f 7420 696e 2073 656c 662e  _id not in self.
-0003d5f0: 5f70 726f 6475 6374 7320 616e 6420 6f62  _products and ob
-0003d600: 735f 6964 2069 7320 6e6f 7420 4e6f 6e65  s_id is not None
-0003d610: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-0003d620: 6973 6520 4e6f 7441 7373 6f63 6961 7465  ise NotAssociate
-0003d630: 6445 7272 6f72 2822 7b6f 7d20 6973 206e  dError("{o} is n
-0003d640: 6f74 2061 7373 6f63 6961 7465 6420 7769  ot associated wi
-0003d650: 7468 207b 737d 2e22 2e66 6f72 6d61 7428  th {s}.".format(
-0003d660: 6f3d 6f62 735f 6964 2c20 733d 7365 6c66  o=obs_id, s=self
-0003d670: 2e6e 616d 6529 290a 2020 2020 2020 2020  .name)).        
-0003d680: 656c 6966 2069 6e73 7420 6e6f 7420 696e  elif inst not in
-0003d690: 2058 4d4d 5f49 4e53 5420 616e 6420 696e   XMM_INST and in
-0003d6a0: 7374 2069 7320 6e6f 7420 4e6f 6e65 3a0a  st is not None:.
-0003d6b0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0003d6c0: 6520 5661 6c75 6545 7272 6f72 2822 7b7d  e ValueError("{}
-0003d6d0: 2069 7320 6e6f 7420 616e 2061 6c6c 6f77   is not an allow
-0003d6e0: 6564 2069 6e73 7472 756d 656e 7422 2e66  ed instrument".f
-0003d6f0: 6f72 6d61 7428 696e 7374 2929 0a0a 2020  ormat(inst))..  
-0003d700: 2020 2020 2020 6d61 7463 6865 7320 3d20        matches = 
-0003d710: 5b5d 0a20 2020 2020 2020 2023 2049 7465  [].        # Ite
-0003d720: 7261 7465 7320 7468 726f 7567 6820 7468  rates through th
-0003d730: 6520 6469 6374 2073 6561 7263 6820 7265  e dict search re
-0003d740: 7475 726e 2c20 6275 7420 6561 6368 206d  turn, but each m
-0003d750: 6174 6368 2069 7320 6c69 6b65 6c79 2074  atch is likely t
-0003d760: 6f20 6265 2061 2076 6572 7920 6e65 7374  o be a very nest
-0003d770: 6564 206c 6973 742c 0a20 2020 2020 2020  ed list,.       
-0003d780: 2023 2077 6974 6820 7468 6520 6465 6772   # with the degr
-0003d790: 6565 206f 6620 6e65 7374 696e 6720 6465  ee of nesting de
-0003d7a0: 7065 6e64 616e 7420 6f6e 2070 726f 6475  pendant on produ
-0003d7b0: 6374 2074 7970 6520 2861 7320 6576 656e  ct type (as even
-0003d7c0: 7420 6c69 7374 7320 6c69 7665 2061 206c  t lists live a l
-0003d7d0: 6576 656c 2075 7020 6672 6f6d 0a20 2020  evel up from.   
-0003d7e0: 2020 2020 2023 2069 6d61 6765 7320 666f       # images fo
-0003d7f0: 7220 696e 7374 616e 6365 0a20 2020 2020  r instance.     
-0003d800: 2020 2066 6f72 206d 6174 6368 2069 6e20     for match in 
-0003d810: 6469 6374 5f73 6561 7263 6828 705f 7479  dict_search(p_ty
-0003d820: 7065 2c20 7365 6c66 2e5f 7072 6f64 7563  pe, self._produc
-0003d830: 7473 293a 0a20 2020 2020 2020 2020 2020  ts):.           
-0003d840: 206f 7574 203d 205b 5d0a 2020 2020 2020   out = [].      
-0003d850: 2020 2020 2020 756e 7061 636b 5f6c 6973        unpack_lis
-0003d860: 7428 6d61 7463 6829 0a20 2020 2020 2020  t(match).       
-0003d870: 2020 2020 2023 204f 6e6c 7920 6170 7065       # Only appe
-0003d880: 6e64 7320 6966 2074 6869 7320 7061 7274  nds if this part
-0003d890: 6963 756c 6172 206d 6174 6368 2069 7320  icular match is 
-0003d8a0: 666f 7220 7468 6520 6f62 735f 6964 2061  for the obs_id a
-0003d8b0: 6e64 2069 6e73 7472 756d 656e 7420 7061  nd instrument pa
-0003d8c0: 7373 6564 2074 6f20 7468 6973 206d 6574  ssed to this met
-0003d8d0: 686f 640a 2020 2020 2020 2020 2020 2020  hod.            
-0003d8e0: 2320 5468 6f75 6768 2061 6c6c 206d 6174  # Though all mat
-0003d8f0: 6368 6573 2077 696c 6c20 6265 2072 6574  ches will be ret
-0003d900: 7572 6e65 6420 6966 206e 6f20 6f62 735f  urned if no obs_
-0003d910: 6964 2f69 6e73 7420 6973 2070 6173 7365  id/inst is passe
-0003d920: 640a 2020 2020 2020 2020 2020 2020 6966  d.            if
-0003d930: 2028 6f62 735f 6964 203d 3d20 6f75 745b   (obs_id == out[
-0003d940: 305d 206f 7220 6f62 735f 6964 2069 7320  0] or obs_id is 
-0003d950: 4e6f 6e65 2920 616e 6420 2869 6e73 7420  None) and (inst 
-0003d960: 3d3d 206f 7574 5b31 5d20 6f72 2069 6e73  == out[1] or ins
-0003d970: 7420 6973 204e 6f6e 6529 205c 0a20 2020  t is None) \.   
-0003d980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d990: 2061 6e64 2028 6578 7472 615f 6b65 7920   and (extra_key 
-0003d9a0: 696e 206f 7574 206f 7220 6578 7472 615f  in out or extra_
-0003d9b0: 6b65 7920 6973 204e 6f6e 6529 2061 6e64  key is None) and
-0003d9c0: 206e 6f74 206a 7573 745f 6f62 6a3a 0a20   not just_obj:. 
-0003d9d0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0003d9e0: 6174 6368 6573 2e61 7070 656e 6428 6f75  atches.append(ou
-0003d9f0: 7429 0a20 2020 2020 2020 2020 2020 2065  t).            e
-0003da00: 6c69 6620 286f 6273 5f69 6420 3d3d 206f  lif (obs_id == o
-0003da10: 7574 5b30 5d20 6f72 206f 6273 5f69 6420  ut[0] or obs_id 
-0003da20: 6973 204e 6f6e 6529 2061 6e64 2028 696e  is None) and (in
-0003da30: 7374 203d 3d20 6f75 745b 315d 206f 7220  st == out[1] or 
-0003da40: 696e 7374 2069 7320 4e6f 6e65 2920 5c0a  inst is None) \.
-0003da50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003da60: 2020 2020 616e 6420 2865 7874 7261 5f6b      and (extra_k
-0003da70: 6579 2069 6e20 6f75 7420 6f72 2065 7874  ey in out or ext
-0003da80: 7261 5f6b 6579 2069 7320 4e6f 6e65 2920  ra_key is None) 
-0003da90: 616e 6420 6a75 7374 5f6f 626a 3a0a 2020  and just_obj:.  
-0003daa0: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
-0003dab0: 7463 6865 732e 6170 7065 6e64 286f 7574  tches.append(out
-0003dac0: 5b2d 315d 290a 2020 2020 2020 2020 7265  [-1]).        re
-0003dad0: 7475 726e 206d 6174 6368 6573 0a0a 2020  turn matches..  
-0003dae0: 2020 2320 5468 6973 2069 7320 7573 6564    # This is used
-0003daf0: 2074 6f20 6e61 6d65 2066 696c 6573 2061   to name files a
-0003db00: 6e64 2064 6972 6563 746f 7269 6573 2073  nd directories s
-0003db10: 6f20 7468 6973 2069 7320 6e6f 7420 616c  o this is not al
-0003db20: 6c6f 7765 6420 746f 2063 6861 6e67 652e  lowed to change.
-0003db30: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
-0003db40: 2020 2064 6566 206e 616d 6528 7365 6c66     def name(self
-0003db50: 2920 2d3e 2073 7472 3a0a 2020 2020 2020  ) -> str:.      
-0003db60: 2020 2222 220a 2020 2020 2020 2020 5468    """.        Th
-0003db70: 6520 6e61 6d65 206f 6620 7468 6520 736f  e name of the so
-0003db80: 7572 6365 2c20 6569 7468 6572 2067 6976  urce, either giv
-0003db90: 656e 2061 7420 696e 6974 6961 6c69 7361  en at initialisa
-0003dba0: 7469 6f6e 206f 7220 6765 6e65 7261 7465  tion or generate
-0003dbb0: 6420 6672 6f6d 2074 6865 2075 7365 722d  d from the user-
-0003dbc0: 7375 7070 6c69 6564 2063 6f6f 7264 696e  supplied coordin
-0003dbd0: 6174 6573 2e0a 0a20 2020 2020 2020 203a  ates...        :
-0003dbe0: 7265 7475 726e 3a20 5468 6520 6e61 6d65  return: The name
-0003dbf0: 206f 6620 7468 6520 736f 7572 6365 2e0a   of the source..
-0003dc00: 2020 2020 2020 2020 3a72 7479 7065 3a20          :rtype: 
-0003dc10: 7374 720a 2020 2020 2020 2020 2222 220a  str.        """.
-0003dc20: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-0003dc30: 656c 662e 5f6e 616d 650a 0a20 2020 2040  elf._name..    @
-0003dc40: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
-0003dc50: 206e 756d 5f70 6e5f 6f62 7328 7365 6c66   num_pn_obs(self
-0003dc60: 2920 2d3e 2069 6e74 3a0a 2020 2020 2020  ) -> int:.      
-0003dc70: 2020 2222 220a 2020 2020 2020 2020 4765    """.        Ge
-0003dc80: 7474 6572 206d 6574 686f 6420 7468 6174  tter method that
-0003dc90: 2067 6976 6573 2074 6865 206e 756d 6265   gives the numbe
-0003dca0: 7220 6f66 2050 4e20 6f62 7365 7276 6174  r of PN observat
-0003dcb0: 696f 6e73 2e0a 0a20 2020 2020 2020 203a  ions...        :
-0003dcc0: 7265 7475 726e 3a20 496e 7465 6765 7220  return: Integer 
-0003dcd0: 6e75 6d62 6572 206f 6620 504e 206f 6273  number of PN obs
-0003dce0: 6572 7661 7469 6f6e 7320 6173 736f 6369  ervations associ
-0003dcf0: 6174 6564 2077 6974 6820 7468 6973 2073  ated with this s
-0003dd00: 6f75 7263 650a 2020 2020 2020 2020 3a72  ource.        :r
-0003dd10: 7479 7065 3a20 696e 740a 2020 2020 2020  type: int.      
-0003dd20: 2020 2222 220a 2020 2020 2020 2020 7265    """.        re
-0003dd30: 7475 726e 206c 656e 285b 6f20 666f 7220  turn len([o for 
-0003dd40: 6f20 696e 2073 656c 662e 6f62 735f 6964  o in self.obs_id
-0003dd50: 7320 6966 2027 706e 2720 696e 2073 656c  s if 'pn' in sel
-0003dd60: 662e 5f70 726f 6475 6374 735b 6f5d 5d29  f._products[o]])
-0003dd70: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
-0003dd80: 2020 2020 6465 6620 6e75 6d5f 6d6f 7331      def num_mos1
-0003dd90: 5f6f 6273 2873 656c 6629 202d 3e20 696e  _obs(self) -> in
-0003dda0: 743a 0a20 2020 2020 2020 2022 2222 0a20  t:.        """. 
-0003ddb0: 2020 2020 2020 2047 6574 7465 7220 6d65         Getter me
-0003ddc0: 7468 6f64 2074 6861 7420 6769 7665 7320  thod that gives 
-0003ddd0: 7468 6520 6e75 6d62 6572 206f 6620 4d4f  the number of MO
-0003dde0: 5331 206f 6273 6572 7661 7469 6f6e 732e  S1 observations.
-0003ddf0: 0a0a 2020 2020 2020 2020 3a72 6574 7572  ..        :retur
-0003de00: 6e3a 2049 6e74 6567 6572 206e 756d 6265  n: Integer numbe
-0003de10: 7220 6f66 204d 4f53 3120 6f62 7365 7276  r of MOS1 observ
-0003de20: 6174 696f 6e73 2061 7373 6f63 6961 7465  ations associate
-0003de30: 6420 7769 7468 2074 6869 7320 736f 7572  d with this sour
-0003de40: 6365 0a20 2020 2020 2020 203a 7274 7970  ce.        :rtyp
-0003de50: 653a 2069 6e74 0a20 2020 2020 2020 2022  e: int.        "
-0003de60: 2222 0a20 2020 2020 2020 2072 6574 7572  "".        retur
-0003de70: 6e20 6c65 6e28 5b6f 2066 6f72 206f 2069  n len([o for o i
-0003de80: 6e20 7365 6c66 2e6f 6273 5f69 6473 2069  n self.obs_ids i
-0003de90: 6620 276d 6f73 3127 2069 6e20 7365 6c66  f 'mos1' in self
-0003dea0: 2e5f 7072 6f64 7563 7473 5b6f 5d5d 290a  ._products[o]]).
-0003deb0: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
-0003dec0: 2020 2064 6566 206e 756d 5f6d 6f73 325f     def num_mos2_
-0003ded0: 6f62 7328 7365 6c66 2920 2d3e 2069 6e74  obs(self) -> int
-0003dee0: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-0003def0: 2020 2020 2020 4765 7474 6572 206d 6574        Getter met
-0003df00: 686f 6420 7468 6174 2067 6976 6573 2074  hod that gives t
-0003df10: 6865 206e 756d 6265 7220 6f66 204d 4f53  he number of MOS
-0003df20: 3220 6f62 7365 7276 6174 696f 6e73 2e0a  2 observations..
-0003df30: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
-0003df40: 3a20 496e 7465 6765 7220 6e75 6d62 6572  : Integer number
-0003df50: 206f 6620 4d4f 5332 206f 6273 6572 7661   of MOS2 observa
-0003df60: 7469 6f6e 7320 6173 736f 6369 6174 6564  tions associated
-0003df70: 2077 6974 6820 7468 6973 2073 6f75 7263   with this sourc
-0003df80: 650a 2020 2020 2020 2020 3a72 7479 7065  e.        :rtype
-0003df90: 3a20 696e 740a 2020 2020 2020 2020 2222  : int.        ""
-0003dfa0: 220a 2020 2020 2020 2020 7265 7475 726e  ".        return
-0003dfb0: 206c 656e 285b 6f20 666f 7220 6f20 696e   len([o for o in
-0003dfc0: 2073 656c 662e 6f62 735f 6964 7320 6966   self.obs_ids if
-0003dfd0: 2027 6d6f 7332 2720 696e 2073 656c 662e   'mos2' in self.
-0003dfe0: 5f70 726f 6475 6374 735b 6f5d 5d29 0a0a  _products[o]])..
-0003dff0: 2020 2020 6465 6620 696e 666f 2873 656c      def info(sel
-0003e000: 6629 3a0a 2020 2020 2020 2020 2222 220a  f):.        """.
-0003e010: 2020 2020 2020 2020 4a75 7374 2070 7269          Just pri
-0003e020: 6e74 7320 6120 636f 7570 6c65 206f 6620  nts a couple of 
-0003e030: 7069 6563 6573 206f 6620 696e 666f 726d  pieces of inform
-0003e040: 6174 696f 6e20 6162 6f75 7420 7468 6520  ation about the 
-0003e050: 4e75 6c6c 536f 7572 6365 0a20 2020 2020  NullSource.     
-0003e060: 2020 2022 2222 0a20 2020 2020 2020 2070     """.        p
-0003e070: 7269 6e74 2822 5c6e 2d2d 2d2d 2d2d 2d2d  rint("\n--------
-0003e080: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0003e090: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0003e0a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d22 290a  -------------").
-0003e0b0: 2020 2020 2020 2020 7072 696e 7428 2253          print("S
-0003e0c0: 6f75 7263 6520 4e61 6d65 202d 207b 7d22  ource Name - {}"
-0003e0d0: 2e66 6f72 6d61 7428 7365 6c66 2e5f 6e61  .format(self._na
-0003e0e0: 6d65 2929 0a20 2020 2020 2020 2070 7269  me)).        pri
-0003e0f0: 6e74 2822 584d 4d20 4f62 7349 4473 202d  nt("XMM ObsIDs -
-0003e100: 207b 7d22 2e66 6f72 6d61 7428 7365 6c66   {}".format(self
-0003e110: 2e5f 5f6c 656e 5f5f 2829 2929 0a20 2020  .__len__())).   
-0003e120: 2020 2020 2070 7269 6e74 2822 504e 204f       print("PN O
-0003e130: 6273 6572 7661 7469 6f6e 7320 2d20 7b7d  bservations - {}
-0003e140: 222e 666f 726d 6174 2873 656c 662e 6e75  ".format(self.nu
-0003e150: 6d5f 706e 5f6f 6273 2929 0a20 2020 2020  m_pn_obs)).     
-0003e160: 2020 2070 7269 6e74 2822 4d4f 5331 204f     print("MOS1 O
-0003e170: 6273 6572 7661 7469 6f6e 7320 2d20 7b7d  bservations - {}
-0003e180: 222e 666f 726d 6174 2873 656c 662e 6e75  ".format(self.nu
-0003e190: 6d5f 6d6f 7331 5f6f 6273 2929 0a20 2020  m_mos1_obs)).   
-0003e1a0: 2020 2020 2070 7269 6e74 2822 4d4f 5332       print("MOS2
-0003e1b0: 204f 6273 6572 7661 7469 6f6e 7320 2d20   Observations - 
-0003e1c0: 7b7d 222e 666f 726d 6174 2873 656c 662e  {}".format(self.
-0003e1d0: 6e75 6d5f 6d6f 7332 5f6f 6273 2929 0a20  num_mos2_obs)). 
-0003e1e0: 2020 2020 2020 2070 7269 6e74 2822 2d2d         print("--
+0003bac0: 6520 3d20 6e70 2e76 7374 6163 6b28 2873  e = np.vstack((s
+0003bad0: 656c 662e 7175 6575 652c 2063 6d64 5f61  elf.queue, cmd_a
+0003bae0: 7272 2929 0a20 2020 2020 2020 2020 2020  rr)).           
+0003baf0: 2073 656c 662e 7175 6575 655f 7479 7065   self.queue_type
+0003bb00: 203d 206e 702e 7673 7461 636b 2828 7365   = np.vstack((se
+0003bb10: 6c66 2e71 7565 7565 5f74 7970 652c 2070  lf.queue_type, p
+0003bb20: 5f74 7970 655f 6172 7229 290a 2020 2020  _type_arr)).    
+0003bb30: 2020 2020 2020 2020 7365 6c66 2e71 7565          self.que
+0003bb40: 7565 5f70 6174 6820 3d20 6e70 2e76 7374  ue_path = np.vst
+0003bb50: 6163 6b28 2873 656c 662e 7175 6575 655f  ack((self.queue_
+0003bb60: 7061 7468 2c20 705f 7061 7468 5f61 7272  path, p_path_arr
+0003bb70: 2929 0a20 2020 2020 2020 2020 2020 2073  )).            s
+0003bb80: 656c 662e 7175 6575 655f 6578 7472 615f  elf.queue_extra_
+0003bb90: 696e 666f 203d 206e 702e 7673 7461 636b  info = np.vstack
+0003bba0: 2828 7365 6c66 2e71 7565 7565 5f65 7874  ((self.queue_ext
+0003bbb0: 7261 5f69 6e66 6f2c 2065 7874 7261 5f69  ra_info, extra_i
+0003bbc0: 6e66 6f29 290a 2020 2020 2020 2020 656c  nfo)).        el
+0003bbd0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0003bbe0: 7365 6c66 2e71 7565 7565 203d 206e 702e  self.queue = np.
+0003bbf0: 6170 7065 6e64 2873 656c 662e 7175 6575  append(self.queu
+0003bc00: 652c 2063 6d64 5f61 7272 2c20 6178 6973  e, cmd_arr, axis
+0003bc10: 3d30 290a 2020 2020 2020 2020 2020 2020  =0).            
+0003bc20: 7365 6c66 2e71 7565 7565 5f74 7970 6520  self.queue_type 
+0003bc30: 3d20 6e70 2e61 7070 656e 6428 7365 6c66  = np.append(self
+0003bc40: 2e71 7565 7565 5f74 7970 652c 2070 5f74  .queue_type, p_t
+0003bc50: 7970 655f 6172 722c 2061 7869 733d 3029  ype_arr, axis=0)
+0003bc60: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0003bc70: 662e 7175 6575 655f 7061 7468 203d 206e  f.queue_path = n
+0003bc80: 702e 6170 7065 6e64 2873 656c 662e 7175  p.append(self.qu
+0003bc90: 6575 655f 7061 7468 2c20 705f 7061 7468  eue_path, p_path
+0003bca0: 5f61 7272 2c20 6178 6973 3d30 290a 2020  _arr, axis=0).  
+0003bcb0: 2020 2020 2020 2020 2020 7365 6c66 2e71            self.q
+0003bcc0: 7565 7565 5f65 7874 7261 5f69 6e66 6f20  ueue_extra_info 
+0003bcd0: 3d20 6e70 2e61 7070 656e 6428 7365 6c66  = np.append(self
+0003bce0: 2e71 7565 7565 5f65 7874 7261 5f69 6e66  .queue_extra_inf
+0003bcf0: 6f2c 2065 7874 7261 5f69 6e66 6f2c 2061  o, extra_info, a
+0003bd00: 7869 733d 3029 0a0a 2020 2020 6465 6620  xis=0)..    def 
+0003bd10: 6765 745f 7175 6575 6528 7365 6c66 2920  get_queue(self) 
+0003bd20: 2d3e 2054 7570 6c65 5b4c 6973 745b 7374  -> Tuple[List[st
+0003bd30: 725d 2c20 4c69 7374 5b73 7472 5d2c 204c  r], List[str], L
+0003bd40: 6973 745b 4c69 7374 5b73 7472 5d5d 2c20  ist[List[str]], 
+0003bd50: 4c69 7374 5b64 6963 745d 5d3a 0a20 2020  List[dict]]:.   
+0003bd60: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0003bd70: 2043 616c 6c69 6e67 2074 6869 7320 696e   Calling this in
+0003bd80: 6469 6361 7465 7320 7468 6174 2074 6865  dicates that the
+0003bd90: 2071 7565 7565 2069 7320 6162 6f75 7420   queue is about 
+0003bda0: 746f 2062 6520 7072 6f63 6573 7365 642c  to be processed,
+0003bdb0: 2073 6f20 7468 6973 2066 756e 6374 696f   so this functio
+0003bdc0: 6e20 636f 6d62 696e 6573 2053 4153 0a20  n combines SAS. 
+0003bdd0: 2020 2020 2020 2063 6f6d 6d61 6e64 7320         commands 
+0003bde0: 616c 6f6e 6720 636f 6c75 6d6e 7320 2863  along columns (c
+0003bdf0: 6f6d 6d61 6e64 2073 7461 636b 7329 2c20  ommand stacks), 
+0003be00: 616e 6420 7265 7475 726e 7320 4e20 5341  and returns N SA
+0003be10: 5320 636f 6d6d 616e 6473 2074 6f20 6265  S commands to be
+0003be20: 2072 756e 2063 6f6e 6375 7272 656e 746c   run concurrentl
+0003be30: 792c 0a20 2020 2020 2020 2077 6865 7265  y,.        where
+0003be40: 204e 2069 7320 7468 6520 6e75 6d62 6572   N is the number
+0003be50: 206f 6620 636f 6c75 6d6e 732e 0a0a 2020   of columns...  
+0003be60: 2020 2020 2020 3a72 6574 7572 6e3a 204c        :return: L
+0003be70: 6973 7420 6f66 2073 7472 696e 6773 2c20  ist of strings, 
+0003be80: 7768 6572 6520 7468 6520 7374 7269 6e67  where the string
+0003be90: 7320 6172 6520 6261 7368 2063 6f6d 6d61  s are bash comma
+0003bea0: 6e64 7320 746f 2072 756e 2053 4153 2070  nds to run SAS p
+0003beb0: 726f 6365 6475 7265 732c 2061 6e6f 7468  rocedures, anoth
+0003bec0: 6572 0a20 2020 2020 2020 2020 2020 206c  er.            l
+0003bed0: 6973 7420 6f66 2073 7472 696e 6773 2c20  ist of strings, 
+0003bee0: 7768 6572 6520 7468 6520 7374 7269 6e67  where the string
+0003bef0: 7320 6172 6520 6578 7065 6374 6564 206f  s are expected o
+0003bf00: 7574 7075 7420 7479 7065 7320 666f 7220  utput types for 
+0003bf10: 7468 6520 636f 6d6d 616e 6473 2c20 6120  the commands, a 
+0003bf20: 6c69 7374 206f 660a 2020 2020 2020 2020  list of.        
+0003bf30: 2020 2020 6c69 7374 7320 6f66 2073 7472      lists of str
+0003bf40: 696e 6773 2c20 7768 6572 6520 7468 6520  ings, where the 
+0003bf50: 7374 7269 6e67 7320 6172 6520 6578 7065  strings are expe
+0003bf60: 6374 6564 206f 7574 7075 7420 7061 7468  cted output path
+0003bf70: 7320 666f 7220 7072 6f64 7563 7473 206f  s for products o
+0003bf80: 6620 7468 6520 5341 5320 636f 6d6d 616e  f the SAS comman
+0003bf90: 6473 2e0a 2020 2020 2020 2020 3a72 7479  ds..        :rty
+0003bfa0: 7065 3a20 5475 706c 655b 4c69 7374 5b73  pe: Tuple[List[s
+0003bfb0: 7472 5d2c 204c 6973 745b 7374 725d 2c20  tr], List[str], 
+0003bfc0: 4c69 7374 5b4c 6973 745b 7374 725d 5d5d  List[List[str]]]
+0003bfd0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0003bfe0: 2020 2020 2069 6620 7365 6c66 2e71 7565       if self.que
+0003bff0: 7565 2069 7320 4e6f 6e65 3a0a 2020 2020  ue is None:.    
+0003c000: 2020 2020 2020 2020 2320 5468 6973 2072          # This r
+0003c010: 6574 7572 6e73 2065 6d70 7479 206c 6973  eturns empty lis
+0003c020: 7473 2069 6620 7468 6520 7175 6575 6520  ts if the queue 
+0003c030: 6973 2075 6e64 6566 696e 6564 0a20 2020  is undefined.   
+0003c040: 2020 2020 2020 2020 2070 726f 6365 7373           process
+0003c050: 6564 5f63 6d64 7320 3d20 5b5d 0a20 2020  ed_cmds = [].   
+0003c060: 2020 2020 2020 2020 2074 7970 6573 203d           types =
+0003c070: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
+0003c080: 7061 7468 7320 3d20 5b5d 0a20 2020 2020  paths = [].     
+0003c090: 2020 2020 2020 2065 7874 7261 7320 3d20         extras = 
+0003c0a0: 5b5d 0a20 2020 2020 2020 2065 6c69 6620  [].        elif 
+0003c0b0: 6c65 6e28 7365 6c66 2e71 7565 7565 2e73  len(self.queue.s
+0003c0c0: 6861 7065 2920 3d3d 2031 206f 7220 7365  hape) == 1 or se
+0003c0d0: 6c66 2e71 7565 7565 2e73 6861 7065 5b31  lf.queue.shape[1
+0003c0e0: 5d20 3c3d 2031 3a0a 2020 2020 2020 2020  ] <= 1:.        
+0003c0f0: 2020 2020 7072 6f63 6573 7365 645f 636d      processed_cm
+0003c100: 6473 203d 206c 6973 7428 7365 6c66 2e71  ds = list(self.q
+0003c110: 7565 7565 290a 2020 2020 2020 2020 2020  ueue).          
+0003c120: 2020 7479 7065 7320 3d20 6c69 7374 2873    types = list(s
+0003c130: 656c 662e 7175 6575 655f 7479 7065 290a  elf.queue_type).
+0003c140: 2020 2020 2020 2020 2020 2020 7061 7468              path
+0003c150: 7320 3d20 5b5b 7374 7228 7061 7468 295d  s = [[str(path)]
+0003c160: 2066 6f72 2070 6174 6820 696e 2073 656c   for path in sel
+0003c170: 662e 7175 6575 655f 7061 7468 5d0a 2020  f.queue_path].  
+0003c180: 2020 2020 2020 2020 2020 6578 7472 6173            extras
+0003c190: 203d 206c 6973 7428 7365 6c66 2e71 7565   = list(self.que
+0003c1a0: 7565 5f65 7874 7261 5f69 6e66 6f29 0a20  ue_extra_info). 
+0003c1b0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0003c1c0: 2020 2020 2020 2020 2070 726f 6365 7373           process
+0003c1d0: 6564 5f63 6d64 7320 3d20 5b22 3b22 2e6a  ed_cmds = [";".j
+0003c1e0: 6f69 6e28 636f 6c29 2066 6f72 2063 6f6c  oin(col) for col
+0003c1f0: 2069 6e20 7365 6c66 2e71 7565 7565 2e54   in self.queue.T
+0003c200: 5d0a 2020 2020 2020 2020 2020 2020 7479  ].            ty
+0003c210: 7065 7320 3d20 6c69 7374 2873 656c 662e  pes = list(self.
+0003c220: 7175 6575 655f 7479 7065 5b2d 312c 203a  queue_type[-1, :
+0003c230: 5d29 0a20 2020 2020 2020 2020 2020 2070  ]).            p
+0003c240: 6174 6873 203d 205b 6c69 7374 2863 6f6c  aths = [list(col
+0003c250: 2e61 7374 7970 6528 7374 7229 2920 666f  .astype(str)) fo
+0003c260: 7220 636f 6c20 696e 2073 656c 662e 7175  r col in self.qu
+0003c270: 6575 655f 7061 7468 2e54 5d0a 2020 2020  eue_path.T].    
+0003c280: 2020 2020 2020 2020 6578 7472 6173 203d          extras =
+0003c290: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
+0003c2a0: 666f 7220 636f 6c20 696e 2073 656c 662e  for col in self.
+0003c2b0: 7175 6575 655f 7061 7468 2e54 3a0a 2020  queue_path.T:.  
+0003c2c0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0003c2d0: 5468 6973 206e 6573 7465 6420 6469 6374  This nested dict
+0003c2e0: 696f 6e61 7279 2063 6f6d 7072 6568 656e  ionary comprehen
+0003c2f0: 7369 6f6e 2063 6f6d 6269 6e65 7320 6120  sion combines a 
+0003c300: 636f 6c75 6d6e 206f 6620 6578 7472 6120  column of extra 
+0003c310: 696e 666f 726d 6174 696f 6e0a 2020 2020  information.    
+0003c320: 2020 2020 2020 2020 2020 2020 2320 6469              # di
+0003c330: 6374 696f 6e61 7269 6573 2069 6e74 6f20  ctionaries into 
+0003c340: 6f6e 652c 2066 6f72 2065 6173 6520 6f66  one, for ease of
+0003c350: 2061 6363 6573 732e 0a20 2020 2020 2020   access..       
+0003c360: 2020 2020 2020 2020 2063 6f6d 625f 6578           comb_ex
+0003c370: 7472 6120 3d20 7b6b 3a20 7620 666f 7220  tra = {k: v for 
+0003c380: 6578 745f 6469 6374 2069 6e20 636f 6c20  ext_dict in col 
+0003c390: 666f 7220 6b2c 2076 2069 6e20 6578 745f  for k, v in ext_
+0003c3a0: 6469 6374 2e69 7465 6d73 2829 7d0a 2020  dict.items()}.  
+0003c3b0: 2020 2020 2020 2020 2020 2020 2020 6578                ex
+0003c3c0: 7472 6173 2e61 7070 656e 6428 636f 6d62  tras.append(comb
+0003c3d0: 5f65 7874 7261 290a 0a20 2020 2020 2020  _extra)..       
+0003c3e0: 2023 2054 6869 7320 6973 206f 6e6c 7920   # This is only 
+0003c3f0: 6c69 6b65 6c79 2074 6f20 6265 2063 616c  likely to be cal
+0003c400: 6c65 6420 7768 656e 2070 726f 6365 7373  led when process
+0003c410: 696e 6720 6973 2062 6567 696e 6e69 6e67  ing is beginning
+0003c420: 2c20 736f 2074 6869 7320 7769 6c6c 2077  , so this will w
+0003c430: 6970 6520 7468 6520 7175 6575 652e 0a20  ipe the queue.. 
+0003c440: 2020 2020 2020 2073 656c 662e 7175 6575         self.queu
+0003c450: 6520 3d20 4e6f 6e65 0a20 2020 2020 2020  e = None.       
+0003c460: 2073 656c 662e 7175 6575 655f 7479 7065   self.queue_type
+0003c470: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
+0003c480: 7365 6c66 2e71 7565 7565 5f70 6174 6820  self.queue_path 
+0003c490: 3d20 4e6f 6e65 0a20 2020 2020 2020 2073  = None.        s
+0003c4a0: 656c 662e 7175 6575 655f 6578 7472 615f  elf.queue_extra_
+0003c4b0: 696e 666f 203d 204e 6f6e 650a 2020 2020  info = None.    
+0003c4c0: 2020 2020 2320 5468 6520 7265 7475 726e      # The return
+0003c4d0: 6564 2070 6174 6873 2061 7265 206c 6973  ed paths are lis
+0003c4e0: 7473 206f 6620 7374 7269 6e67 7320 6265  ts of strings be
+0003c4f0: 6361 7573 6520 7765 2077 616e 7420 746f  cause we want to
+0003c500: 2069 6e63 6c75 6465 2065 7665 7279 2066   include every f
+0003c510: 696c 6520 696e 2061 2073 7461 636b 2074  ile in a stack t
+0003c520: 6f20 6265 2061 626c 650a 2020 2020 2020  o be able.      
+0003c530: 2020 2320 746f 2063 6865 636b 2074 6861    # to check tha
+0003c540: 7420 6578 6973 7473 0a20 2020 2020 2020  t exists.       
+0003c550: 2072 6574 7572 6e20 7072 6f63 6573 7365   return processe
+0003c560: 645f 636d 6473 2c20 7479 7065 732c 2070  d_cmds, types, p
+0003c570: 6174 6873 2c20 6578 7472 6173 0a0a 2020  aths, extras..  
+0003c580: 2020 6465 6620 7570 6461 7465 5f70 726f    def update_pro
+0003c590: 6475 6374 7328 7365 6c66 2c20 7072 6f64  ducts(self, prod
+0003c5a0: 5f6f 626a 3a20 4261 7365 5072 6f64 7563  _obj: BaseProduc
+0003c5b0: 7429 3a0a 2020 2020 2020 2020 2222 220a  t):.        """.
+0003c5c0: 2020 2020 2020 2020 5468 6973 206d 6574          This met
+0003c5d0: 686f 6420 7769 6c6c 204f 4e4c 5920 7374  hod will ONLY st
+0003c5e0: 6f72 6520 696d 6167 6573 2061 6e64 2065  ore images and e
+0003c5f0: 7870 6f73 7572 6520 6d61 7073 2e20 4964  xposure maps. Id
+0003c600: 6561 6c6c 7920 4920 776f 756c 646e 2774  eally I wouldn't
+0003c610: 2073 746f 7265 2074 6865 6d20 6173 2070   store them as p
+0003c620: 726f 6475 6374 206f 626a 6563 7473 0a20  roduct objects. 
+0003c630: 2020 2020 2020 2061 7420 616c 6c2c 2062         at all, b
+0003c640: 7574 2075 6e66 6f72 7475 6e61 7465 6c79  ut unfortunately
+0003c650: 2065 7870 6f73 7572 6520 6d61 7073 2072   exposure maps r
+0003c660: 6571 7569 7265 2061 6e20 696d 6167 6520  equire an image 
+0003c670: 746f 2062 6520 6765 6e65 7261 7465 642e  to be generated.
+0003c680: 2055 6e6c 696b 6520 616c 6c20 6f74 6865   Unlike all othe
+0003c690: 7220 736f 7572 6365 2063 6c61 7373 6573  r source classes
+0003c6a0: 2c0a 2020 2020 2020 2020 7261 7465 6d61  ,.        ratema
+0003c6b0: 7073 2077 696c 6c20 6e6f 7420 6265 2067  ps will not be g
+0003c6c0: 656e 6572 6174 6564 2077 6865 6e20 6d61  enerated when ma
+0003c6d0: 7463 6869 6e67 2069 6d61 6765 7320 616e  tching images an
+0003c6e0: 6420 6578 706f 7375 7265 206d 6170 7320  d exposure maps 
+0003c6f0: 6172 6520 6164 6465 642e 0a0a 2020 2020  are added...    
+0003c700: 2020 2020 3a70 6172 616d 2042 6173 6550      :param BaseP
+0003c710: 726f 6475 6374 2070 726f 645f 6f62 6a3a  roduct prod_obj:
+0003c720: 2054 6865 206e 6577 2070 726f 6475 6374   The new product
+0003c730: 206f 626a 6563 7420 746f 2062 6520 6164   object to be ad
+0003c740: 6465 6420 746f 2074 6865 2073 6f75 7263  ded to the sourc
+0003c750: 6520 6f62 6a65 6374 2e0a 2020 2020 2020  e object..      
+0003c760: 2020 2222 220a 2020 2020 2020 2020 6966    """.        if
+0003c770: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
+0003c780: 7072 6f64 5f6f 626a 2c20 2842 6173 6550  prod_obj, (BaseP
+0003c790: 726f 6475 6374 2c20 4261 7365 4167 6772  roduct, BaseAggr
+0003c7a0: 6567 6174 6550 726f 6475 6374 2929 2061  egateProduct)) a
+0003c7b0: 6e64 2070 726f 645f 6f62 6a20 6973 206e  nd prod_obj is n
+0003c7c0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+0003c7d0: 2020 2020 2072 6169 7365 2054 7970 6545       raise TypeE
+0003c7e0: 7272 6f72 2822 4f6e 6c79 2070 726f 6475  rror("Only produ
+0003c7f0: 6374 206f 626a 6563 7473 2063 616e 2062  ct objects can b
+0003c800: 6520 6173 7369 676e 6564 2074 6f20 736f  e assigned to so
+0003c810: 7572 6365 732e 2229 0a20 2020 2020 2020  urces.").       
+0003c820: 2065 6c69 6620 7072 6f64 5f6f 626a 2e74   elif prod_obj.t
+0003c830: 7970 6520 213d 2027 696d 6167 6527 2061  ype != 'image' a
+0003c840: 6e64 2070 726f 645f 6f62 6a2e 7479 7065  nd prod_obj.type
+0003c850: 2021 3d20 2765 7870 6d61 7027 3a0a 2020   != 'expmap':.  
+0003c860: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0003c870: 5479 7065 4572 726f 7228 224f 6e6c 7920  TypeError("Only 
+0003c880: 696d 6167 6573 2061 6e64 2065 7870 6f73  images and expos
+0003c890: 7572 6520 6d61 7073 2063 616e 2062 6520  ure maps can be 
+0003c8a0: 7374 6f72 6564 2069 6e20 6120 4e75 6c6c  stored in a Null
+0003c8b0: 536f 7572 6365 2c20 7b7d 206f 626a 6563  Source, {} objec
+0003c8c0: 7473 2022 0a20 2020 2020 2020 2020 2020  ts ".           
+0003c8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003c8e0: 2022 6361 6e6e 6f74 222e 666f 726d 6174   "cannot".format
+0003c8f0: 2870 726f 645f 6f62 6a2e 7479 7065 2929  (prod_obj.type))
+0003c900: 0a0a 2020 2020 2020 2020 6966 2070 726f  ..        if pro
+0003c910: 645f 6f62 6a20 6973 206e 6f74 204e 6f6e  d_obj is not Non
+0003c920: 653a 0a20 2020 2020 2020 2020 2020 2065  e:.            e
+0003c930: 6e5f 626e 6473 203d 2070 726f 645f 6f62  n_bnds = prod_ob
+0003c940: 6a2e 656e 6572 6779 5f62 6f75 6e64 730a  j.energy_bounds.
+0003c950: 2020 2020 2020 2020 2020 2020 6578 7472              extr
+0003c960: 615f 6b65 7920 3d20 2262 6f75 6e64 5f7b  a_key = "bound_{
+0003c970: 6c7d 2d7b 757d 222e 666f 726d 6174 286c  l}-{u}".format(l
+0003c980: 3d66 6c6f 6174 2865 6e5f 626e 6473 5b30  =float(en_bnds[0
+0003c990: 5d2e 7661 6c75 6529 2c20 753d 666c 6f61  ].value), u=floa
+0003c9a0: 7428 656e 5f62 6e64 735b 315d 2e76 616c  t(en_bnds[1].val
+0003c9b0: 7565 2929 0a20 2020 2020 2020 2020 2020  ue)).           
+0003c9c0: 2023 2041 7320 7468 6520 6578 7472 615f   # As the extra_
+0003c9d0: 6b65 7920 7661 7269 6162 6c65 2063 616e  key variable can
+0003c9e0: 2062 6520 616c 7465 7265 6420 6966 2074   be altered if t
+0003c9f0: 6865 2049 6d61 6765 2069 7320 5053 4620  he Image is PSF 
+0003ca00: 636f 7272 6563 7465 642c 2049 276c 6c20  corrected, I'll 
+0003ca10: 616c 736f 206d 616b 650a 2020 2020 2020  also make.      
+0003ca20: 2020 2020 2020 2320 2074 6869 7320 7661        #  this va
+0003ca30: 7269 6162 6c65 2077 6974 6820 6a75 7374  riable with just
+0003ca40: 2074 6865 2065 6e65 7267 7920 6b65 790a   the energy key.
+0003ca50: 2020 2020 2020 2020 2020 2020 656e 5f6b              en_k
+0003ca60: 6579 203d 2022 626f 756e 645f 7b6c 7d2d  ey = "bound_{l}-
+0003ca70: 7b75 7d22 2e66 6f72 6d61 7428 6c3d 666c  {u}".format(l=fl
+0003ca80: 6f61 7428 656e 5f62 6e64 735b 305d 2e76  oat(en_bnds[0].v
+0003ca90: 616c 7565 292c 2075 3d66 6c6f 6174 2865  alue), u=float(e
+0003caa0: 6e5f 626e 6473 5b31 5d2e 7661 6c75 6529  n_bnds[1].value)
+0003cab0: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
+0003cac0: 2053 6563 6f6e 6461 7279 2063 6865 636b   Secondary check
+0003cad0: 696e 6720 7374 6570 206e 6f77 2049 2776  ing step now I'v
+0003cae0: 6520 6164 6465 6420 5053 4620 636f 7272  e added PSF corr
+0003caf0: 6563 7469 6f6e 0a20 2020 2020 2020 2020  ection.         
+0003cb00: 2020 2069 6620 7479 7065 2870 726f 645f     if type(prod_
+0003cb10: 6f62 6a29 203d 3d20 496d 6167 6520 616e  obj) == Image an
+0003cb20: 6420 7072 6f64 5f6f 626a 2e70 7366 5f63  d prod_obj.psf_c
+0003cb30: 6f72 7265 6374 6564 3a0a 2020 2020 2020  orrected:.      
+0003cb40: 2020 2020 2020 2020 2020 6578 7472 615f            extra_
+0003cb50: 6b65 7920 2b3d 2022 5f22 202b 2070 726f  key += "_" + pro
+0003cb60: 645f 6f62 6a2e 7073 665f 6d6f 6465 6c20  d_obj.psf_model 
+0003cb70: 2b20 225f 2220 2b20 7374 7228 7072 6f64  + "_" + str(prod
+0003cb80: 5f6f 626a 2e70 7366 5f62 696e 7329 202b  _obj.psf_bins) +
+0003cb90: 2022 5f22 202b 2070 726f 645f 6f62 6a2e   "_" + prod_obj.
+0003cba0: 7073 665f 616c 676f 7269 7468 6d20 2b20  psf_algorithm + 
+0003cbb0: 5c0a 2020 2020 2020 2020 2020 2020 2020  \.              
+0003cbc0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0003cbd0: 7472 2870 726f 645f 6f62 6a2e 7073 665f  tr(prod_obj.psf_
+0003cbe0: 6974 6572 6174 696f 6e73 290a 0a20 2020  iterations)..   
+0003cbf0: 2020 2020 2020 2020 2023 2041 6c6c 2069           # All i
+0003cc00: 6e66 6f72 6d61 7469 6f6e 2061 626f 7574  nformation about
+0003cc10: 2077 6865 7265 2074 6f20 706c 6163 6520   where to place 
+0003cc20: 6974 2069 6e20 6f75 7220 7374 6f72 6167  it in our storag
+0003cc30: 6520 6869 6572 6172 6368 7920 6361 6e20  e hierarchy can 
+0003cc40: 6265 2070 756c 6c65 6420 6672 6f6d 2074  be pulled from t
+0003cc50: 6865 2070 726f 6475 6374 0a20 2020 2020  he product.     
+0003cc60: 2020 2020 2020 2023 206f 626a 6563 7420         # object 
+0003cc70: 6974 7365 6c66 0a20 2020 2020 2020 2020  itself.         
+0003cc80: 2020 206f 6273 5f69 6420 3d20 7072 6f64     obs_id = prod
+0003cc90: 5f6f 626a 2e6f 6273 5f69 640a 2020 2020  _obj.obs_id.    
+0003cca0: 2020 2020 2020 2020 696e 7374 203d 2070          inst = p
+0003ccb0: 726f 645f 6f62 6a2e 696e 7374 7275 6d65  rod_obj.instrume
+0003ccc0: 6e74 0a20 2020 2020 2020 2020 2020 2070  nt.            p
+0003ccd0: 5f74 7970 6520 3d20 7072 6f64 5f6f 626a  _type = prod_obj
+0003cce0: 2e74 7970 650a 0a20 2020 2020 2020 2020  .type..         
+0003ccf0: 2020 2023 2044 6f75 626c 6520 6368 6563     # Double chec
+0003cd00: 6b20 7468 6174 2073 6f6d 6574 6869 6e67  k that something
+0003cd10: 2069 7320 7472 7969 6e67 2074 6f20 6164   is trying to ad
+0003cd20: 6420 7072 6f64 7563 7473 2066 726f 6d20  d products from 
+0003cd30: 616e 6f74 6865 7220 736f 7572 6365 2074  another source t
+0003cd40: 6f20 7468 6520 6375 7272 656e 7420 6f6e  o the current on
+0003cd50: 652e 0a20 2020 2020 2020 2020 2020 2069  e..            i
+0003cd60: 6620 6f62 735f 6964 2021 3d20 2263 6f6d  f obs_id != "com
+0003cd70: 6269 6e65 6422 2061 6e64 206f 6273 5f69  bined" and obs_i
+0003cd80: 6420 6e6f 7420 696e 2073 656c 662e 5f70  d not in self._p
+0003cd90: 726f 6475 6374 733a 0a20 2020 2020 2020  roducts:.       
+0003cda0: 2020 2020 2020 2020 2072 6169 7365 204e           raise N
+0003cdb0: 6f74 4173 736f 6369 6174 6564 4572 726f  otAssociatedErro
+0003cdc0: 7228 227b 6f7d 2069 7320 6e6f 7420 6173  r("{o} is not as
+0003cdd0: 736f 6369 6174 6564 2077 6974 6820 7468  sociated with th
+0003cde0: 6973 206e 756c 6c20 736f 7572 6365 2e22  is null source."
+0003cdf0: 2e66 6f72 6d61 7428 6f3d 6f62 735f 6964  .format(o=obs_id
+0003ce00: 2929 0a20 2020 2020 2020 2020 2020 2065  )).            e
+0003ce10: 6c69 6620 696e 7374 2021 3d20 2263 6f6d  lif inst != "com
+0003ce20: 6269 6e65 6422 2061 6e64 2069 6e73 7420  bined" and inst 
+0003ce30: 6e6f 7420 696e 2073 656c 662e 5f70 726f  not in self._pro
+0003ce40: 6475 6374 735b 6f62 735f 6964 5d3a 0a20  ducts[obs_id]:. 
+0003ce50: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0003ce60: 6169 7365 204e 6f74 4173 736f 6369 6174  aise NotAssociat
+0003ce70: 6564 4572 726f 7228 0a20 2020 2020 2020  edError(.       
+0003ce80: 2020 2020 2020 2020 2020 2020 2022 7b69               "{i
+0003ce90: 7d20 6973 206e 6f74 2061 7373 6f63 6961  } is not associa
+0003cea0: 7465 6420 7769 7468 2058 4d4d 206f 6273  ted with XMM obs
+0003ceb0: 6572 7661 7469 6f6e 207b 6f7d 222e 666f  ervation {o}".fo
+0003cec0: 726d 6174 2869 3d69 6e73 742c 206f 3d6f  rmat(i=inst, o=o
+0003ced0: 6273 5f69 6429 290a 0a20 2020 2020 2020  bs_id))..       
+0003cee0: 2020 2020 2069 6620 6578 7472 615f 6b65       if extra_ke
+0003cef0: 7920 6e6f 7420 696e 2073 656c 662e 5f70  y not in self._p
+0003cf00: 726f 6475 6374 735b 6f62 735f 6964 5d5b  roducts[obs_id][
+0003cf10: 696e 7374 5d3a 0a20 2020 2020 2020 2020  inst]:.         
+0003cf20: 2020 2020 2020 2073 656c 662e 5f70 726f         self._pro
+0003cf30: 6475 6374 735b 6f62 735f 6964 5d5b 696e  ducts[obs_id][in
+0003cf40: 7374 5d5b 6578 7472 615f 6b65 795d 203d  st][extra_key] =
+0003cf50: 207b 7d0a 2020 2020 2020 2020 2020 2020   {}.            
+0003cf60: 7365 6c66 2e5f 7072 6f64 7563 7473 5b6f  self._products[o
+0003cf70: 6273 5f69 645d 5b69 6e73 745d 5b65 7874  bs_id][inst][ext
+0003cf80: 7261 5f6b 6579 5d5b 705f 7479 7065 5d20  ra_key][p_type] 
+0003cf90: 3d20 7072 6f64 5f6f 626a 0a0a 2020 2020  = prod_obj..    
+0003cfa0: 6465 6620 6765 745f 7072 6f64 7563 7473  def get_products
+0003cfb0: 2873 656c 662c 2070 5f74 7970 653a 2073  (self, p_type: s
+0003cfc0: 7472 2c20 6f62 735f 6964 3a20 7374 7220  tr, obs_id: str 
+0003cfd0: 3d20 4e6f 6e65 2c20 696e 7374 3a20 7374  = None, inst: st
+0003cfe0: 7220 3d20 4e6f 6e65 2c20 6578 7472 615f  r = None, extra_
+0003cff0: 6b65 793a 2073 7472 203d 204e 6f6e 652c  key: str = None,
+0003d000: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003d010: 2020 2020 2020 6a75 7374 5f6f 626a 3a20        just_obj: 
+0003d020: 626f 6f6c 203d 2054 7275 6529 202d 3e20  bool = True) -> 
+0003d030: 4c69 7374 5b42 6173 6550 726f 6475 6374  List[BaseProduct
+0003d040: 5d3a 0a20 2020 2020 2020 2022 2222 0a20  ]:.        """. 
+0003d050: 2020 2020 2020 2054 6869 7320 6973 2074         This is t
+0003d060: 6865 2067 6574 7465 7220 666f 7220 7468  he getter for th
+0003d070: 6520 7072 6f64 7563 7473 2064 6174 6120  e products data 
+0003d080: 7374 7275 6374 7572 6520 6f66 2053 6f75  structure of Sou
+0003d090: 7263 6520 6f62 6a65 6374 732e 2050 6173  rce objects. Pas
+0003d0a0: 7369 6e67 2061 2027 7072 6f64 7563 7420  sing a 'product 
+0003d0b0: 7479 7065 270a 2020 2020 2020 2020 7375  type'.        su
+0003d0c0: 6368 2061 7320 2765 7665 6e74 7327 206f  ch as 'events' o
+0003d0d0: 7220 2769 6d61 6765 7327 2077 696c 6c20  r 'images' will 
+0003d0e0: 7265 7475 726e 2065 7665 7279 206d 6174  return every mat
+0003d0f0: 6368 696e 6720 656e 7472 7920 696e 2074  ching entry in t
+0003d100: 6865 2070 726f 6475 6374 7320 6461 7461  he products data
+0003d110: 2073 7472 7563 7475 7265 2e0a 0a20 2020   structure...   
+0003d120: 2020 2020 203a 7061 7261 6d20 7374 7220       :param str 
+0003d130: 705f 7479 7065 3a20 5072 6f64 7563 7420  p_type: Product 
+0003d140: 7479 7065 2069 6465 6e74 6966 6965 722e  type identifier.
+0003d150: 2065 2e67 2e20 696d 6167 6520 6f72 2065   e.g. image or e
+0003d160: 7870 6d61 702e 0a20 2020 2020 2020 203a  xpmap..        :
+0003d170: 7061 7261 6d20 7374 7220 6f62 735f 6964  param str obs_id
+0003d180: 3a20 4f70 7469 6f6e 616c 6c79 2c20 6120  : Optionally, a 
+0003d190: 7370 6563 6966 6963 206f 6273 5f69 6420  specific obs_id 
+0003d1a0: 746f 2073 6561 7263 6820 6361 6e20 6265  to search can be
+0003d1b0: 2073 7570 706c 6965 642e 0a20 2020 2020   supplied..     
+0003d1c0: 2020 203a 7061 7261 6d20 7374 7220 696e     :param str in
+0003d1d0: 7374 3a20 4f70 7469 6f6e 616c 6c79 2c20  st: Optionally, 
+0003d1e0: 6120 7370 6563 6966 6963 2069 6e73 7472  a specific instr
+0003d1f0: 756d 656e 7420 746f 2073 6561 7263 6820  ument to search 
+0003d200: 6361 6e20 6265 2073 7570 706c 6965 642e  can be supplied.
+0003d210: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+0003d220: 7374 7220 6578 7472 615f 6b65 793a 204f  str extra_key: O
+0003d230: 7074 696f 6e61 6c6c 792c 2061 6e20 6578  ptionally, an ex
+0003d240: 7472 6120 6b65 7920 286c 696b 6520 616e  tra key (like an
+0003d250: 2065 6e65 7267 7920 626f 756e 6429 2063   energy bound) c
+0003d260: 616e 2062 6520 7375 7070 6c69 6564 2e0a  an be supplied..
+0003d270: 2020 2020 2020 2020 3a70 6172 616d 2062          :param b
+0003d280: 6f6f 6c20 6a75 7374 5f6f 626a 3a20 4120  ool just_obj: A 
+0003d290: 626f 6f6c 6561 6e20 666c 6167 2074 6861  boolean flag tha
+0003d2a0: 7420 636f 6e74 726f 6c73 2077 6865 7468  t controls wheth
+0003d2b0: 6572 2074 6869 7320 6d65 7468 6f64 2072  er this method r
+0003d2c0: 6574 7572 6e73 206a 7573 7420 7468 6520  eturns just the 
+0003d2d0: 7072 6f64 7563 7420 6f62 6a65 6374 732c  product objects,
+0003d2e0: 0a20 2020 2020 2020 2020 2020 206f 7220  .            or 
+0003d2f0: 7468 6520 6f74 6865 7220 696e 666f 726d  the other inform
+0003d300: 6174 696f 6e20 7468 6174 2067 6f65 7320  ation that goes 
+0003d310: 7769 7468 2069 7420 6c69 6b65 204f 6273  with it like Obs
+0003d320: 4944 2061 6e64 2069 6e73 7472 756d 656e  ID and instrumen
+0003d330: 742e 0a20 2020 2020 2020 203a 7265 7475  t..        :retu
+0003d340: 726e 3a20 4c69 7374 206f 6620 6d61 7463  rn: List of matc
+0003d350: 6869 6e67 2070 726f 6475 6374 732e 0a20  hing products.. 
+0003d360: 2020 2020 2020 203a 7274 7970 653a 204c         :rtype: L
+0003d370: 6973 745b 4261 7365 5072 6f64 7563 745d  ist[BaseProduct]
+0003d380: 0a20 2020 2020 2020 2022 2222 0a0a 2020  .        """..  
+0003d390: 2020 2020 2020 6465 6620 756e 7061 636b        def unpack
+0003d3a0: 5f6c 6973 7428 746f 5f75 6e70 6163 6b3a  _list(to_unpack:
+0003d3b0: 206c 6973 7429 3a0a 2020 2020 2020 2020   list):.        
+0003d3c0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0003d3d0: 2020 2020 4120 7265 6375 7273 6976 6520      A recursive 
+0003d3e0: 6675 6e63 7469 6f6e 2074 6f20 676f 2074  function to go t
+0003d3f0: 6872 6f75 6768 2065 7665 7279 206c 6179  hrough every lay
+0003d400: 6572 206f 6620 6120 6e65 7374 6564 206c  er of a nested l
+0003d410: 6973 7420 616e 6420 666c 6174 7465 6e20  ist and flatten 
+0003d420: 6974 2061 6c6c 206f 7574 2e20 4974 0a20  it all out. It. 
+0003d430: 2020 2020 2020 2020 2020 2064 6f65 736e             doesn
+0003d440: 2774 2072 6574 7572 6e20 616e 7974 6869  't return anythi
+0003d450: 6e67 2062 6563 6175 7365 2074 6f20 6d61  ng because to ma
+0003d460: 6b65 206c 6966 6520 6561 7369 6572 2074  ke life easier t
+0003d470: 6865 2027 7265 7375 6c74 7327 2061 7265  he 'results' are
+0003d480: 2061 7070 656e 6465 6420 746f 2061 2076   appended to a v
+0003d490: 6172 6961 626c 650a 2020 2020 2020 2020  ariable.        
+0003d4a0: 2020 2020 696e 2074 6865 206e 616d 6573      in the names
+0003d4b0: 7061 6365 2061 626f 7665 2074 6869 7320  pace above this 
+0003d4c0: 6f6e 652e 0a0a 2020 2020 2020 2020 2020  one...          
+0003d4d0: 2020 3a70 6172 616d 206c 6973 7420 746f    :param list to
+0003d4e0: 5f75 6e70 6163 6b3a 2054 6865 206c 6973  _unpack: The lis
+0003d4f0: 7420 7468 6174 206e 6565 6473 2075 6e70  t that needs unp
+0003d500: 6163 6b69 6e67 2e0a 2020 2020 2020 2020  acking..        
+0003d510: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0003d520: 2020 2020 2320 4d75 7374 2069 7465 7261      # Must itera
+0003d530: 7465 2074 6872 6f75 6768 2074 6865 2067  te through the g
+0003d540: 6976 656e 206c 6973 740a 2020 2020 2020  iven list.      
+0003d550: 2020 2020 2020 666f 7220 656e 7472 7920        for entry 
+0003d560: 696e 2074 6f5f 756e 7061 636b 3a0a 2020  in to_unpack:.  
+0003d570: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0003d580: 4966 2074 6865 2063 7572 7265 6e74 2065  If the current e
+0003d590: 6c65 6d65 6e74 2069 7320 6e6f 7420 6120  lement is not a 
+0003d5a0: 6c69 7374 2074 6865 6e20 616c 6c20 6973  list then all is
+0003d5b0: 2063 6869 6c6c 2c20 7468 6973 2065 6c65   chill, this ele
+0003d5c0: 6d65 6e74 2069 7320 7265 6164 7920 666f  ment is ready fo
+0003d5d0: 7220 6170 7065 6e64 696e 670a 2020 2020  r appending.    
+0003d5e0: 2020 2020 2020 2020 2020 2020 2320 746f              # to
+0003d5f0: 2074 6865 2066 696e 616c 206c 6973 740a   the final list.
+0003d600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d610: 6966 206e 6f74 2069 7369 6e73 7461 6e63  if not isinstanc
+0003d620: 6528 656e 7472 792c 206c 6973 7429 3a0a  e(entry, list):.
+0003d630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d640: 2020 2020 6f75 742e 6170 7065 6e64 2865      out.append(e
+0003d650: 6e74 7279 290a 2020 2020 2020 2020 2020  ntry).          
+0003d660: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0003d670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d680: 2320 4966 2074 6865 2063 7572 7265 6e74  # If the current
+0003d690: 2065 6c65 6d65 6e74 2049 5320 6120 6c69   element IS a li
+0003d6a0: 7374 2c20 7468 656e 206f 6276 696f 7573  st, then obvious
+0003d6b0: 6c79 2077 6520 7374 696c 6c20 6861 7665  ly we still have
+0003d6c0: 206d 6f72 6520 756e 7061 636b 696e 6720   more unpacking 
+0003d6d0: 746f 2064 6f2c 0a20 2020 2020 2020 2020  to do,.         
+0003d6e0: 2020 2020 2020 2020 2020 2023 2073 6f20             # so 
+0003d6f0: 7765 2063 616c 6c20 7468 6973 2066 756e  we call this fun
+0003d700: 6374 696f 6e20 7265 6375 7273 6976 656c  ction recursivel
+0003d710: 792e 0a20 2020 2020 2020 2020 2020 2020  y..             
+0003d720: 2020 2020 2020 2075 6e70 6163 6b5f 6c69         unpack_li
+0003d730: 7374 2865 6e74 7279 290a 0a20 2020 2020  st(entry)..     
+0003d740: 2020 2069 6620 6f62 735f 6964 206e 6f74     if obs_id not
+0003d750: 2069 6e20 7365 6c66 2e5f 7072 6f64 7563   in self._produc
+0003d760: 7473 2061 6e64 206f 6273 5f69 6420 6973  ts and obs_id is
+0003d770: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+0003d780: 2020 2020 2020 2072 6169 7365 204e 6f74         raise Not
+0003d790: 4173 736f 6369 6174 6564 4572 726f 7228  AssociatedError(
+0003d7a0: 227b 6f7d 2069 7320 6e6f 7420 6173 736f  "{o} is not asso
+0003d7b0: 6369 6174 6564 2077 6974 6820 7b73 7d2e  ciated with {s}.
+0003d7c0: 222e 666f 726d 6174 286f 3d6f 6273 5f69  ".format(o=obs_i
+0003d7d0: 642c 2073 3d73 656c 662e 6e61 6d65 2929  d, s=self.name))
+0003d7e0: 0a20 2020 2020 2020 2065 6c69 6620 696e  .        elif in
+0003d7f0: 7374 206e 6f74 2069 6e20 584d 4d5f 494e  st not in XMM_IN
+0003d800: 5354 2061 6e64 2069 6e73 7420 6973 206e  ST and inst is n
+0003d810: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+0003d820: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+0003d830: 4572 726f 7228 227b 7d20 6973 206e 6f74  Error("{} is not
+0003d840: 2061 6e20 616c 6c6f 7765 6420 696e 7374   an allowed inst
+0003d850: 7275 6d65 6e74 222e 666f 726d 6174 2869  rument".format(i
+0003d860: 6e73 7429 290a 0a20 2020 2020 2020 206d  nst))..        m
+0003d870: 6174 6368 6573 203d 205b 5d0a 2020 2020  atches = [].    
+0003d880: 2020 2020 2320 4974 6572 6174 6573 2074      # Iterates t
+0003d890: 6872 6f75 6768 2074 6865 2064 6963 7420  hrough the dict 
+0003d8a0: 7365 6172 6368 2072 6574 7572 6e2c 2062  search return, b
+0003d8b0: 7574 2065 6163 6820 6d61 7463 6820 6973  ut each match is
+0003d8c0: 206c 696b 656c 7920 746f 2062 6520 6120   likely to be a 
+0003d8d0: 7665 7279 206e 6573 7465 6420 6c69 7374  very nested list
+0003d8e0: 2c0a 2020 2020 2020 2020 2320 7769 7468  ,.        # with
+0003d8f0: 2074 6865 2064 6567 7265 6520 6f66 206e   the degree of n
+0003d900: 6573 7469 6e67 2064 6570 656e 6461 6e74  esting dependant
+0003d910: 206f 6e20 7072 6f64 7563 7420 7479 7065   on product type
+0003d920: 2028 6173 2065 7665 6e74 206c 6973 7473   (as event lists
+0003d930: 206c 6976 6520 6120 6c65 7665 6c20 7570   live a level up
+0003d940: 2066 726f 6d0a 2020 2020 2020 2020 2320   from.        # 
+0003d950: 696d 6167 6573 2066 6f72 2069 6e73 7461  images for insta
+0003d960: 6e63 650a 2020 2020 2020 2020 666f 7220  nce.        for 
+0003d970: 6d61 7463 6820 696e 2064 6963 745f 7365  match in dict_se
+0003d980: 6172 6368 2870 5f74 7970 652c 2073 656c  arch(p_type, sel
+0003d990: 662e 5f70 726f 6475 6374 7329 3a0a 2020  f._products):.  
+0003d9a0: 2020 2020 2020 2020 2020 6f75 7420 3d20            out = 
+0003d9b0: 5b5d 0a20 2020 2020 2020 2020 2020 2075  [].            u
+0003d9c0: 6e70 6163 6b5f 6c69 7374 286d 6174 6368  npack_list(match
+0003d9d0: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
+0003d9e0: 4f6e 6c79 2061 7070 656e 6473 2069 6620  Only appends if 
+0003d9f0: 7468 6973 2070 6172 7469 6375 6c61 7220  this particular 
+0003da00: 6d61 7463 6820 6973 2066 6f72 2074 6865  match is for the
+0003da10: 206f 6273 5f69 6420 616e 6420 696e 7374   obs_id and inst
+0003da20: 7275 6d65 6e74 2070 6173 7365 6420 746f  rument passed to
+0003da30: 2074 6869 7320 6d65 7468 6f64 0a20 2020   this method.   
+0003da40: 2020 2020 2020 2020 2023 2054 686f 7567           # Thoug
+0003da50: 6820 616c 6c20 6d61 7463 6865 7320 7769  h all matches wi
+0003da60: 6c6c 2062 6520 7265 7475 726e 6564 2069  ll be returned i
+0003da70: 6620 6e6f 206f 6273 5f69 642f 696e 7374  f no obs_id/inst
+0003da80: 2069 7320 7061 7373 6564 0a20 2020 2020   is passed.     
+0003da90: 2020 2020 2020 2069 6620 286f 6273 5f69         if (obs_i
+0003daa0: 6420 3d3d 206f 7574 5b30 5d20 6f72 206f  d == out[0] or o
+0003dab0: 6273 5f69 6420 6973 204e 6f6e 6529 2061  bs_id is None) a
+0003dac0: 6e64 2028 696e 7374 203d 3d20 6f75 745b  nd (inst == out[
+0003dad0: 315d 206f 7220 696e 7374 2069 7320 4e6f  1] or inst is No
+0003dae0: 6e65 2920 5c0a 2020 2020 2020 2020 2020  ne) \.          
+0003daf0: 2020 2020 2020 2020 2020 616e 6420 2865            and (e
+0003db00: 7874 7261 5f6b 6579 2069 6e20 6f75 7420  xtra_key in out 
+0003db10: 6f72 2065 7874 7261 5f6b 6579 2069 7320  or extra_key is 
+0003db20: 4e6f 6e65 2920 616e 6420 6e6f 7420 6a75  None) and not ju
+0003db30: 7374 5f6f 626a 3a0a 2020 2020 2020 2020  st_obj:.        
+0003db40: 2020 2020 2020 2020 6d61 7463 6865 732e          matches.
+0003db50: 6170 7065 6e64 286f 7574 290a 2020 2020  append(out).    
+0003db60: 2020 2020 2020 2020 656c 6966 2028 6f62          elif (ob
+0003db70: 735f 6964 203d 3d20 6f75 745b 305d 206f  s_id == out[0] o
+0003db80: 7220 6f62 735f 6964 2069 7320 4e6f 6e65  r obs_id is None
+0003db90: 2920 616e 6420 2869 6e73 7420 3d3d 206f  ) and (inst == o
+0003dba0: 7574 5b31 5d20 6f72 2069 6e73 7420 6973  ut[1] or inst is
+0003dbb0: 204e 6f6e 6529 205c 0a20 2020 2020 2020   None) \.       
+0003dbc0: 2020 2020 2020 2020 2020 2020 2061 6e64               and
+0003dbd0: 2028 6578 7472 615f 6b65 7920 696e 206f   (extra_key in o
+0003dbe0: 7574 206f 7220 6578 7472 615f 6b65 7920  ut or extra_key 
+0003dbf0: 6973 204e 6f6e 6529 2061 6e64 206a 7573  is None) and jus
+0003dc00: 745f 6f62 6a3a 0a20 2020 2020 2020 2020  t_obj:.         
+0003dc10: 2020 2020 2020 206d 6174 6368 6573 2e61         matches.a
+0003dc20: 7070 656e 6428 6f75 745b 2d31 5d29 0a20  ppend(out[-1]). 
+0003dc30: 2020 2020 2020 2072 6574 7572 6e20 6d61         return ma
+0003dc40: 7463 6865 730a 0a20 2020 2023 2054 6869  tches..    # Thi
+0003dc50: 7320 6973 2075 7365 6420 746f 206e 616d  s is used to nam
+0003dc60: 6520 6669 6c65 7320 616e 6420 6469 7265  e files and dire
+0003dc70: 6374 6f72 6965 7320 736f 2074 6869 7320  ctories so this 
+0003dc80: 6973 206e 6f74 2061 6c6c 6f77 6564 2074  is not allowed t
+0003dc90: 6f20 6368 616e 6765 2e0a 2020 2020 4070  o change..    @p
+0003dca0: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
+0003dcb0: 6e61 6d65 2873 656c 6629 202d 3e20 7374  name(self) -> st
+0003dcc0: 723a 0a20 2020 2020 2020 2022 2222 0a20  r:.        """. 
+0003dcd0: 2020 2020 2020 2054 6865 206e 616d 6520         The name 
+0003dce0: 6f66 2074 6865 2073 6f75 7263 652c 2065  of the source, e
+0003dcf0: 6974 6865 7220 6769 7665 6e20 6174 2069  ither given at i
+0003dd00: 6e69 7469 616c 6973 6174 696f 6e20 6f72  nitialisation or
+0003dd10: 2067 656e 6572 6174 6564 2066 726f 6d20   generated from 
+0003dd20: 7468 6520 7573 6572 2d73 7570 706c 6965  the user-supplie
+0003dd30: 6420 636f 6f72 6469 6e61 7465 732e 0a0a  d coordinates...
+0003dd40: 2020 2020 2020 2020 3a72 6574 7572 6e3a          :return:
+0003dd50: 2054 6865 206e 616d 6520 6f66 2074 6865   The name of the
+0003dd60: 2073 6f75 7263 652e 0a20 2020 2020 2020   source..       
+0003dd70: 203a 7274 7970 653a 2073 7472 0a20 2020   :rtype: str.   
+0003dd80: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0003dd90: 2072 6574 7572 6e20 7365 6c66 2e5f 6e61   return self._na
+0003dda0: 6d65 0a0a 2020 2020 4070 726f 7065 7274  me..    @propert
+0003ddb0: 790a 2020 2020 6465 6620 6e75 6d5f 706e  y.    def num_pn
+0003ddc0: 5f6f 6273 2873 656c 6629 202d 3e20 696e  _obs(self) -> in
+0003ddd0: 743a 0a20 2020 2020 2020 2022 2222 0a20  t:.        """. 
+0003dde0: 2020 2020 2020 2047 6574 7465 7220 6d65         Getter me
+0003ddf0: 7468 6f64 2074 6861 7420 6769 7665 7320  thod that gives 
+0003de00: 7468 6520 6e75 6d62 6572 206f 6620 504e  the number of PN
+0003de10: 206f 6273 6572 7661 7469 6f6e 732e 0a0a   observations...
+0003de20: 2020 2020 2020 2020 3a72 6574 7572 6e3a          :return:
+0003de30: 2049 6e74 6567 6572 206e 756d 6265 7220   Integer number 
+0003de40: 6f66 2050 4e20 6f62 7365 7276 6174 696f  of PN observatio
+0003de50: 6e73 2061 7373 6f63 6961 7465 6420 7769  ns associated wi
+0003de60: 7468 2074 6869 7320 736f 7572 6365 0a20  th this source. 
+0003de70: 2020 2020 2020 203a 7274 7970 653a 2069         :rtype: i
+0003de80: 6e74 0a20 2020 2020 2020 2022 2222 0a20  nt.        """. 
+0003de90: 2020 2020 2020 2072 6574 7572 6e20 6c65         return le
+0003dea0: 6e28 5b6f 2066 6f72 206f 2069 6e20 7365  n([o for o in se
+0003deb0: 6c66 2e6f 6273 5f69 6473 2069 6620 2770  lf.obs_ids if 'p
+0003dec0: 6e27 2069 6e20 7365 6c66 2e5f 7072 6f64  n' in self._prod
+0003ded0: 7563 7473 5b6f 5d5d 290a 0a20 2020 2040  ucts[o]])..    @
+0003dee0: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
+0003def0: 206e 756d 5f6d 6f73 315f 6f62 7328 7365   num_mos1_obs(se
+0003df00: 6c66 2920 2d3e 2069 6e74 3a0a 2020 2020  lf) -> int:.    
+0003df10: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0003df20: 4765 7474 6572 206d 6574 686f 6420 7468  Getter method th
+0003df30: 6174 2067 6976 6573 2074 6865 206e 756d  at gives the num
+0003df40: 6265 7220 6f66 204d 4f53 3120 6f62 7365  ber of MOS1 obse
+0003df50: 7276 6174 696f 6e73 2e0a 0a20 2020 2020  rvations...     
+0003df60: 2020 203a 7265 7475 726e 3a20 496e 7465     :return: Inte
+0003df70: 6765 7220 6e75 6d62 6572 206f 6620 4d4f  ger number of MO
+0003df80: 5331 206f 6273 6572 7661 7469 6f6e 7320  S1 observations 
+0003df90: 6173 736f 6369 6174 6564 2077 6974 6820  associated with 
+0003dfa0: 7468 6973 2073 6f75 7263 650a 2020 2020  this source.    
+0003dfb0: 2020 2020 3a72 7479 7065 3a20 696e 740a      :rtype: int.
+0003dfc0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0003dfd0: 2020 2020 7265 7475 726e 206c 656e 285b      return len([
+0003dfe0: 6f20 666f 7220 6f20 696e 2073 656c 662e  o for o in self.
+0003dff0: 6f62 735f 6964 7320 6966 2027 6d6f 7331  obs_ids if 'mos1
+0003e000: 2720 696e 2073 656c 662e 5f70 726f 6475  ' in self._produ
+0003e010: 6374 735b 6f5d 5d29 0a0a 2020 2020 4070  cts[o]])..    @p
+0003e020: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
+0003e030: 6e75 6d5f 6d6f 7332 5f6f 6273 2873 656c  num_mos2_obs(sel
+0003e040: 6629 202d 3e20 696e 743a 0a20 2020 2020  f) -> int:.     
+0003e050: 2020 2022 2222 0a20 2020 2020 2020 2047     """.        G
+0003e060: 6574 7465 7220 6d65 7468 6f64 2074 6861  etter method tha
+0003e070: 7420 6769 7665 7320 7468 6520 6e75 6d62  t gives the numb
+0003e080: 6572 206f 6620 4d4f 5332 206f 6273 6572  er of MOS2 obser
+0003e090: 7661 7469 6f6e 732e 0a0a 2020 2020 2020  vations...      
+0003e0a0: 2020 3a72 6574 7572 6e3a 2049 6e74 6567    :return: Integ
+0003e0b0: 6572 206e 756d 6265 7220 6f66 204d 4f53  er number of MOS
+0003e0c0: 3220 6f62 7365 7276 6174 696f 6e73 2061  2 observations a
+0003e0d0: 7373 6f63 6961 7465 6420 7769 7468 2074  ssociated with t
+0003e0e0: 6869 7320 736f 7572 6365 0a20 2020 2020  his source.     
+0003e0f0: 2020 203a 7274 7970 653a 2069 6e74 0a20     :rtype: int. 
+0003e100: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0003e110: 2020 2072 6574 7572 6e20 6c65 6e28 5b6f     return len([o
+0003e120: 2066 6f72 206f 2069 6e20 7365 6c66 2e6f   for o in self.o
+0003e130: 6273 5f69 6473 2069 6620 276d 6f73 3227  bs_ids if 'mos2'
+0003e140: 2069 6e20 7365 6c66 2e5f 7072 6f64 7563   in self._produc
+0003e150: 7473 5b6f 5d5d 290a 0a20 2020 2064 6566  ts[o]])..    def
+0003e160: 2069 6e66 6f28 7365 6c66 293a 0a20 2020   info(self):.   
+0003e170: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0003e180: 204a 7573 7420 7072 696e 7473 2061 2063   Just prints a c
+0003e190: 6f75 706c 6520 6f66 2070 6965 6365 7320  ouple of pieces 
+0003e1a0: 6f66 2069 6e66 6f72 6d61 7469 6f6e 2061  of information a
+0003e1b0: 626f 7574 2074 6865 204e 756c 6c53 6f75  bout the NullSou
+0003e1c0: 7263 650a 2020 2020 2020 2020 2222 220a  rce.        """.
+0003e1d0: 2020 2020 2020 2020 7072 696e 7428 225c          print("\
+0003e1e0: 6e2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  n---------------
 0003e1f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
 0003e200: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0003e210: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0003e220: 2d2d 2d5c 6e22 290a 0a20 2020 2064 6566  ---\n")..    def
-0003e230: 205f 5f6c 656e 5f5f 2873 656c 6629 202d   __len__(self) -
-0003e240: 3e20 696e 743a 0a20 2020 2020 2020 2022  > int:.        "
-0003e250: 2222 0a20 2020 2020 2020 204d 6574 686f  "".        Metho
-0003e260: 6420 746f 2072 6574 7572 6e20 7468 6520  d to return the 
-0003e270: 6c65 6e67 7468 206f 6620 7468 6520 7072  length of the pr
-0003e280: 6f64 7563 7473 2064 6963 7469 6f6e 6172  oducts dictionar
-0003e290: 7920 2877 6869 6368 206d 6561 6e73 2074  y (which means t
-0003e2a0: 6865 206e 756d 6265 7220 6f66 0a20 2020  he number of.   
-0003e2b0: 2020 2020 2069 6e64 6976 6964 7561 6c20       individual 
-0003e2c0: 4f62 7349 4473 2061 7373 6f63 6961 7465  ObsIDs associate
-0003e2d0: 6420 7769 7468 2074 6869 7320 736f 7572  d with this sour
-0003e2e0: 6365 292c 2077 6865 6e20 6c65 6e28 2920  ce), when len() 
-0003e2f0: 6973 2063 616c 6c65 6420 6f6e 2061 6e20  is called on an 
-0003e300: 696e 7374 616e 6365 206f 6620 7468 6973  instance of this
-0003e310: 2063 6c61 7373 2e0a 0a20 2020 2020 2020   class...       
-0003e320: 203a 7265 7475 726e 3a20 5468 6520 696e   :return: The in
-0003e330: 7465 6765 7220 6c65 6e67 7468 206f 6620  teger length of 
-0003e340: 7468 6520 746f 7020 6c65 7665 6c20 6f66  the top level of
-0003e350: 2074 6865 205f 7072 6f64 7563 7473 206e   the _products n
-0003e360: 6573 7465 6420 6469 6374 696f 6e61 7279  ested dictionary
-0003e370: 2e0a 2020 2020 2020 2020 3a72 7479 7065  ..        :rtype
-0003e380: 3a20 696e 740a 2020 2020 2020 2020 2222  : int.        ""
-0003e390: 220a 2020 2020 2020 2020 7265 7475 726e  ".        return
-0003e3a0: 206c 656e 2873 656c 662e 6f62 735f 6964   len(self.obs_id
-0003e3b0: 7329 0a                                  s).
+0003e210: 2d2d 2d2d 2d2d 2229 0a20 2020 2020 2020  ------").       
+0003e220: 2070 7269 6e74 2822 536f 7572 6365 204e   print("Source N
+0003e230: 616d 6520 2d20 7b7d 222e 666f 726d 6174  ame - {}".format
+0003e240: 2873 656c 662e 5f6e 616d 6529 290a 2020  (self._name)).  
+0003e250: 2020 2020 2020 7072 696e 7428 2258 4d4d        print("XMM
+0003e260: 204f 6273 4944 7320 2d20 7b7d 222e 666f   ObsIDs - {}".fo
+0003e270: 726d 6174 2873 656c 662e 5f5f 6c65 6e5f  rmat(self.__len_
+0003e280: 5f28 2929 290a 2020 2020 2020 2020 7072  _())).        pr
+0003e290: 696e 7428 2250 4e20 4f62 7365 7276 6174  int("PN Observat
+0003e2a0: 696f 6e73 202d 207b 7d22 2e66 6f72 6d61  ions - {}".forma
+0003e2b0: 7428 7365 6c66 2e6e 756d 5f70 6e5f 6f62  t(self.num_pn_ob
+0003e2c0: 7329 290a 2020 2020 2020 2020 7072 696e  s)).        prin
+0003e2d0: 7428 224d 4f53 3120 4f62 7365 7276 6174  t("MOS1 Observat
+0003e2e0: 696f 6e73 202d 207b 7d22 2e66 6f72 6d61  ions - {}".forma
+0003e2f0: 7428 7365 6c66 2e6e 756d 5f6d 6f73 315f  t(self.num_mos1_
+0003e300: 6f62 7329 290a 2020 2020 2020 2020 7072  obs)).        pr
+0003e310: 696e 7428 224d 4f53 3220 4f62 7365 7276  int("MOS2 Observ
+0003e320: 6174 696f 6e73 202d 207b 7d22 2e66 6f72  ations - {}".for
+0003e330: 6d61 7428 7365 6c66 2e6e 756d 5f6d 6f73  mat(self.num_mos
+0003e340: 325f 6f62 7329 290a 2020 2020 2020 2020  2_obs)).        
+0003e350: 7072 696e 7428 222d 2d2d 2d2d 2d2d 2d2d  print("---------
+0003e360: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0003e370: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0003e380: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 5c6e 2229  ------------\n")
+0003e390: 0a0a 2020 2020 6465 6620 5f5f 6c65 6e5f  ..    def __len_
+0003e3a0: 5f28 7365 6c66 2920 2d3e 2069 6e74 3a0a  _(self) -> int:.
+0003e3b0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0003e3c0: 2020 2020 4d65 7468 6f64 2074 6f20 7265      Method to re
+0003e3d0: 7475 726e 2074 6865 206c 656e 6774 6820  turn the length 
+0003e3e0: 6f66 2074 6865 2070 726f 6475 6374 7320  of the products 
+0003e3f0: 6469 6374 696f 6e61 7279 2028 7768 6963  dictionary (whic
+0003e400: 6820 6d65 616e 7320 7468 6520 6e75 6d62  h means the numb
+0003e410: 6572 206f 660a 2020 2020 2020 2020 696e  er of.        in
+0003e420: 6469 7669 6475 616c 204f 6273 4944 7320  dividual ObsIDs 
+0003e430: 6173 736f 6369 6174 6564 2077 6974 6820  associated with 
+0003e440: 7468 6973 2073 6f75 7263 6529 2c20 7768  this source), wh
+0003e450: 656e 206c 656e 2829 2069 7320 6361 6c6c  en len() is call
+0003e460: 6564 206f 6e20 616e 2069 6e73 7461 6e63  ed on an instanc
+0003e470: 6520 6f66 2074 6869 7320 636c 6173 732e  e of this class.
+0003e480: 0a0a 2020 2020 2020 2020 3a72 6574 7572  ..        :retur
+0003e490: 6e3a 2054 6865 2069 6e74 6567 6572 206c  n: The integer l
+0003e4a0: 656e 6774 6820 6f66 2074 6865 2074 6f70  ength of the top
+0003e4b0: 206c 6576 656c 206f 6620 7468 6520 5f70   level of the _p
+0003e4c0: 726f 6475 6374 7320 6e65 7374 6564 2064  roducts nested d
+0003e4d0: 6963 7469 6f6e 6172 792e 0a20 2020 2020  ictionary..     
+0003e4e0: 2020 203a 7274 7970 653a 2069 6e74 0a20     :rtype: int. 
+0003e4f0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0003e500: 2020 2072 6574 7572 6e20 6c65 6e28 7365     return len(se
+0003e510: 6c66 2e6f 6273 5f69 6473 290a            lf.obs_ids).
```

### Comparing `xga-0.4.4/xga/sources/extended.py` & `xga-0.4.5/xga/sources/extended.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/sources/general.py` & `xga-0.4.5/xga/sources/general.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/sources/point.py` & `xga-0.4.5/xga/sources/point.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/sourcetools/_common.py` & `xga-0.4.5/xga/sourcetools/_common.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/sourcetools/density.py` & `xga-0.4.5/xga/sourcetools/density.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/sourcetools/deproj.py` & `xga-0.4.5/xga/sourcetools/deproj.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/sourcetools/entropy.py` & `xga-0.4.5/xga/sourcetools/entropy.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/sourcetools/mass.py` & `xga-0.4.5/xga/sourcetools/mass.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/sourcetools/match.py` & `xga-0.4.5/xga/sourcetools/match.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/sourcetools/misc.py` & `xga-0.4.5/xga/sourcetools/misc.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/sourcetools/stack.py` & `xga-0.4.5/xga/sourcetools/stack.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/sourcetools/temperature.py` & `xga-0.4.5/xga/sourcetools/temperature.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/tools/clusters/LT.py` & `xga-0.4.5/xga/tools/clusters/LT.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/utils.py` & `xga-0.4.5/xga/utils.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/xspec/fakeit.py` & `xga-0.4.5/xga/xspec/fakeit.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/xspec/fit/_common.py` & `xga-0.4.5/xga/xspec/fit/_common.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/xspec/fit/general.py` & `xga-0.4.5/xga/xspec/fit/general.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/xspec/fit/profile.py` & `xga-0.4.5/xga/xspec/fit/profile.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/xspec/run.py` & `xga-0.4.5/xga/xspec/run.py`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/xspec_scripts/cr_conv_calc.xcm` & `xga-0.4.5/xga/xspec_scripts/cr_conv_calc.xcm`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/xspec_scripts/crossarf_xspec_fit.xcm` & `xga-0.4.5/xga/xspec_scripts/crossarf_xspec_fit.xcm`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/xspec_scripts/general_xspec_fit.xcm` & `xga-0.4.5/xga/xspec_scripts/general_xspec_fit.xcm`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/xspec_scripts/get_pars.tcl` & `xga-0.4.5/xga/xspec_scripts/get_pars.tcl`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga/xspec_scripts/xga_extract.tcl` & `xga-0.4.5/xga/xspec_scripts/xga_extract.tcl`

 * *Files identical despite different names*

### Comparing `xga-0.4.4/xga.egg-info/PKG-INFO` & `xga-0.4.5/xga.egg-info/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: xga
-Version: 0.4.4
+Version: 0.4.5
 Summary: Python package to easily generate and analyse XMM data products
 Home-page: http://github.com/DavidT3/XGA
 Author: David Turner
 Author-email: david.turner@sussex.ac.uk
 License: UNKNOWN
 Description: <p align="center">
             <img src="https://raw.githubusercontent.com/DavidT3/XGA/master/xga/files/long_xga_logo.png" width="500">
```

### Comparing `xga-0.4.4/xga.egg-info/SOURCES.txt` & `xga-0.4.5/xga.egg-info/SOURCES.txt`

 * *Files identical despite different names*

